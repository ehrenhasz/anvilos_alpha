{
  "module_name": "buildpkg.sh.in",
  "hash_id": "af82d975654b12ded1ca86d896cb103f7cd77afbae7a9d4b720c63c452584c10",
  "original_prompt": "Ingested from openssh-9.6p1/buildpkg.sh.in",
  "human_readable_source": "#!/bin/sh\n#\n# Fake Root Solaris/SVR4/SVR5 Build System - Prototype\n#\n# The following code has been provide under Public Domain License.  I really\n# don't care what you use it for.  Just as long as you don't complain to me\n# nor my employer if you break it. - Ben Lindstrom (mouring@eviladmin.org)\n#\numask 022\n#\n# Options for building the package\n# You can create a openssh-config.local with your customized options\n#\nREMOVE_FAKE_ROOT_WHEN_DONE=yes\n#\n# uncommenting TEST_DIR and using\n# configure --prefix=/var/tmp --with-privsep-path=/var/tmp/empty\n# and\n# PKGNAME=tOpenSSH should allow testing a package without interfering\n# with a real OpenSSH package on a system. This is not needed on systems\n# that support the -R option to pkgadd.\n#TEST_DIR=/var/tmp\t# leave commented out for production build\nPKGNAME=OpenSSH\n# revisions within the same version (REV=a)\n#REV=\nSYSVINIT_NAME=opensshd\nAWK=${AWK:=\"nawk\"}\nMAKE=${MAKE:=\"make\"}\nSSHDUID=67\t# Default privsep uid\nSSHDGID=67\t# Default privsep gid\n# uncomment these next three as needed\n#PERMIT_ROOT_LOGIN=no\n#X11_FORWARDING=yes\n#USR_LOCAL_IS_SYMLINK=yes\n# System V init run levels\nSYSVINITSTART=S98\nSYSVINITSTOPT=K30\n# We will source these if they exist\nPOST_MAKE_INSTALL_FIXES=./pkg-post-make-install-fixes.sh\nPOST_PROTOTYPE_EDITS=./pkg-post-prototype-edit.sh\n# We'll be one level deeper looking for these\nPKG_PREINSTALL_LOCAL=../pkg-preinstall.local\nPKG_POSTINSTALL_LOCAL=../pkg-postinstall.local\nPKG_PREREMOVE_LOCAL=../pkg-preremove.local\nPKG_POSTREMOVE_LOCAL=../pkg-postremove.local\nPKG_REQUEST_LOCAL=../pkg-request.local\n# end of sourced files\n#\nOPENSSHD=opensshd.init\nOPENSSH_MANIFEST=openssh.xml\nOPENSSH_FMRI=svc:/site/${SYSVINIT_NAME}:default\nSMF_METHOD_DIR=/lib/svc/method/site\nSMF_MANIFEST_DIR=/var/svc/manifest/site\n\nPATH_GROUPADD_PROG=@PATH_GROUPADD_PROG@\nPATH_USERADD_PROG=@PATH_USERADD_PROG@\nPATH_PASSWD_PROG=@PATH_PASSWD_PROG@\n#\n# list of system directories we do NOT want to change owner/group/perms\n# when installing our package\nSYSTEM_DIR=\"/etc\t\\\n/etc/init.d\t\t\\\n/etc/rcS.d\t\t\\\n/etc/rc0.d\t\t\\\n/etc/rc1.d\t\t\\\n/etc/rc2.d\t\t\\\n/etc/opt\t\t\\\n/lib\t\t\t\\\n/lib/svc\t\t\\\n/lib/svc/method\t\t\\\n/lib/svc/method/site\t\\\n/opt\t\t\t\\\n/opt/bin\t\t\\\n/usr\t\t\t\\\n/usr/bin\t\t\\\n/usr/lib\t\t\\\n/usr/sbin\t\t\\\n/usr/share\t\t\\\n/usr/share/man\t\t\\\n/usr/share/man/man1\t\\\n/usr/share/man/man8\t\\\n/usr/local\t\t\\\n/usr/local/bin\t\t\\\n/usr/local/etc\t\t\\\n/usr/local/libexec\t\\\n/usr/local/man\t\t\\\n/usr/local/man/man1\t\\\n/usr/local/man/man8\t\\\n/usr/local/sbin\t\t\\\n/usr/local/share\t\\\n/var\t\t\t\\\n/var/opt\t\t\\\n/var/run\t\t\\\n/var/svc\t\t\\\n/var/svc/manifest\t\\\n/var/svc/manifest/site  \\\n/var/tmp\t\t\\\n/tmp\"\n\n# We may need to build as root so we make sure PATH is set up\n# only set the path if it's not set already\n[ -d /opt/bin ]  &&  {\n\techo $PATH | grep \":/opt/bin\"  > /dev/null 2>&1\n\t[ $? -ne 0 ] && PATH=$PATH:/opt/bin\n}\n[ -d /usr/local/bin ]  &&  {\n\techo $PATH | grep \":/usr/local/bin\"  > /dev/null 2>&1\n\t[ $? -ne 0 ] && PATH=$PATH:/usr/local/bin\n}\n[ -d /usr/ccs/bin ]  &&  {\n\techo $PATH | grep \":/usr/ccs/bin\"  > /dev/null 2>&1\n\t[ $? -ne 0 ] && PATH=$PATH:/usr/ccs/bin\n}\nexport PATH\n#\n\n[ -f Makefile ]  ||  {\n\techo \"Please run this script from your build directory\"\n\texit 1\n}\n\n# we will look for openssh-config.local to override the above options\n[ -s ./openssh-config.local ]  &&  . ./openssh-config.local\n\nSTART=`pwd`\nFAKE_ROOT=$START/pkg\n\n## Fill in some details, like prefix and sysconfdir\nfor confvar in prefix exec_prefix bindir sbindir libexecdir datadir mandir sysconfdir piddir srcdir\ndo\n\teval $confvar=`grep \"^$confvar=\" Makefile | cut -d = -f 2`\ndone\n\n## Are we using Solaris' SMF?\nDO_SMF=0\nif egrep \"^#define USE_SOLARIS_PROCESS_CONTRACTS\" config.h > /dev/null 2>&1\nthen\n\tDO_SMF=1\nfi\n\n## Collect value of privsep user\nfor confvar in SSH_PRIVSEP_USER\ndo\n\teval $confvar=`awk '/#define[ \\t]'$confvar'/{print $3}' config.h`\ndone\n\n## Set privsep defaults if not defined\nif [ -z \"$SSH_PRIVSEP_USER\" ]\nthen\n\tSSH_PRIVSEP_USER=sshd\nfi\n\n## Extract common info requires for the 'info' part of the package.\nVERSION=`./ssh -V 2>&1 | sed -e 's/,.*//'`\n\nARCH=`uname -m`\nDEF_MSG=\"\\n\"\nOS_VER=`uname -v`\nSCRIPT_SHELL=/sbin/sh\nUNAME_R=`uname -r`\nUNAME_S=`uname -s`\ncase ${UNAME_S} in\n\tSunOS)\tUNAME_S=Solaris\n\t\tOS_VER=${UNAME_R}\n\t\tARCH=`uname -p`\n\t\tRCS_D=yes\n\t\tDEF_MSG=\"(default: n)\"\n\t\t;;\n\tSCO_SV)\tcase ${UNAME_R} in\n\t\t\t3.2)\tUNAME_S=OpenServer5\n\t\tOS_VER=`uname -X | grep Release | sed -e 's/^Rel.*3.2v//'`\n\t\t\t\t;;\n\t\t\t5)\tUNAME_S=OpenServer6\n\t\t\t\t;;\n\t\tesac\n\t\tSCRIPT_SHELL=/bin/sh\n\t\tRC1_D=no\n\t\tDEF_MSG=\"(default: n)\"\n\t\t;;\nesac\n\ncase `basename $0` in\n\tbuildpkg.sh)\n## Start by faking root install\necho \"Faking root install...\"\n[ -d $FAKE_ROOT ]  &&  rm -fr $FAKE_ROOT\nmkdir $FAKE_ROOT\n${MAKE} install-nokeys DESTDIR=$FAKE_ROOT\nif [ $? -gt 0 ]\nthen\n\techo \"Fake root install failed, stopping.\"\n\texit 1\nfi\n\n## Setup our run level stuff while we are at it.\nif [ $DO_SMF -eq 1 ]\nthen\n\t# For Solaris' SMF, /lib/svc/method/site is the preferred place\n\t# for start/stop scripts that aren't supplied with the OS, and\n\t# similarly /var/svc/manifest/site for manifests.\n\tmkdir -p $FAKE_ROOT${TEST_DIR}${SMF_METHOD_DIR}\n\tmkdir -p $FAKE_ROOT${TEST_DIR}${SMF_MANIFEST_DIR}\n\n\tcp ${OPENSSHD} $FAKE_ROOT${TEST_DIR}${SMF_METHOD_DIR}/${SYSVINIT_NAME}\n\tchmod 744 $FAKE_ROOT${TEST_DIR}${SMF_METHOD_DIR}/${SYSVINIT_NAME}\n\n\tcat ${OPENSSH_MANIFEST} | \\\n\t    sed -e \"s|__SYSVINIT_NAME__|${SYSVINIT_NAME}|\" \\\n\t    -e \"s|__SMF_METHOD_DIR__|${SMF_METHOD_DIR}|\" \\\n\t    > $FAKE_ROOT${TEST_DIR}${SMF_MANIFEST_DIR}/${SYSVINIT_NAME}.xml\n\tchmod 644 $FAKE_ROOT${TEST_DIR}${SMF_MANIFEST_DIR}/${SYSVINIT_NAME}.xml\nelse\n\tmkdir -p $FAKE_ROOT${TEST_DIR}/etc/init.d\n\n\tcp ${OPENSSHD} $FAKE_ROOT${TEST_DIR}/etc/init.d/${SYSVINIT_NAME}\n\tchmod 744 $FAKE_ROOT${TEST_DIR}/etc/init.d/${SYSVINIT_NAME}\nfi\n\n[ \"${PERMIT_ROOT_LOGIN}\" = no ]  &&  \\\n\tperl -p -i -e \"s/#PermitRootLogin yes/PermitRootLogin no/\" \\\n\t\t$FAKE_ROOT${sysconfdir}/sshd_config\n[ \"${X11_FORWARDING}\" = yes ]  &&  \\\n\tperl -p -i -e \"s/#X11Forwarding no/X11Forwarding yes/\" \\\n\t\t$FAKE_ROOT${sysconfdir}/sshd_config\n# fix PrintMotd\nperl -p -i -e \"s/#PrintMotd yes/PrintMotd no/\" \\\n\t$FAKE_ROOT${sysconfdir}/sshd_config\n\n# We don't want to overwrite config files on multiple installs\nmv $FAKE_ROOT${sysconfdir}/ssh_config $FAKE_ROOT${sysconfdir}/ssh_config.default\nmv $FAKE_ROOT${sysconfdir}/sshd_config $FAKE_ROOT${sysconfdir}/sshd_config.default\n\n# local tweeks here\n[ -s \"${POST_MAKE_INSTALL_FIXES}\" ]  &&  . ${POST_MAKE_INSTALL_FIXES}\n\ncd $FAKE_ROOT\n\n## Ok, this is outright wrong, but it will work.  I'm tired of pkgmk\n## whining.\nfor i in *; do\n  PROTO_ARGS=\"$PROTO_ARGS $i=/$i\";\ndone\n\n## Build info file\necho \"Building pkginfo file...\"\ncat > pkginfo << _EOF\nPKG=$PKGNAME\nNAME=\"OpenSSH Portable for ${UNAME_S}\"\nDESC=\"Secure Shell remote access utility; replaces telnet and rlogin/rsh.\"\nVENDOR=\"OpenSSH Portable Team - https://www.openssh.com/portable.html\"\nARCH=$ARCH\nVERSION=$VERSION$REV\nCATEGORY=\"Security,application\"\nBASEDIR=/\nCLASSES=\"none\"\nPSTAMP=\"${UNAME_S} ${OS_VER} ${ARCH} `date '+%d%b%Y %H:%M'`\"\n_EOF\n\n## Build empty depend file that may get updated by $POST_PROTOTYPE_EDITS\necho \"Building depend file...\"\ntouch depend\n\n## Build space file\necho \"Building space file...\"\nif [ $DO_SMF -eq 1 ]\nthen\n\t# XXX Is this necessary?  If not, remove space line from mk-proto.awk.\n\ttouch space\nelse\n\tcat > space << _EOF\n# extra space required by start/stop links added by installf\n# in postinstall\n$TEST_DIR/etc/rc0.d/${SYSVINITSTOPT}${SYSVINIT_NAME} 0 1\n$TEST_DIR/etc/rc2.d/${SYSVINITSTART}${SYSVINIT_NAME} 0 1\n_EOF\n\t[ \"$RC1_D\" = no ]  ||  \\\n\techo \"$TEST_DIR/etc/rc1.d/${SYSVINITSTOPT}${SYSVINIT_NAME} 0 1\" >> space\n\t[ \"$RCS_D\" = yes ]  &&  \\\n\techo \"$TEST_DIR/etc/rcS.d/${SYSVINITSTOPT}${SYSVINIT_NAME} 0 1\" >> space\nfi\n\n## Build preinstall file\necho \"Building preinstall file...\"\ncat > preinstall << _EOF\n#! ${SCRIPT_SHELL}\n#\n_EOF\n\n# local preinstall changes here\n[ -s \"${PKG_PREINSTALL_LOCAL}\" ]  &&  . ${PKG_PREINSTALL_LOCAL}\n\ncat >> preinstall << _EOF\n#\nif [ \"\\${PRE_INS_STOP}\" = \"yes\" ]\nthen\n\tif [ $DO_SMF -eq 1 ]\n\tthen\n\t\tsvcadm disable $OPENSSH_FMRI\n\telse\n\t\t${TEST_DIR}/etc/init.d/${SYSVINIT_NAME} stop\n\tfi\nfi\n\nexit 0\n_EOF\n\n## Build postinstall file\necho \"Building postinstall file...\"\ncat > postinstall << _EOF\n#! ${SCRIPT_SHELL}\n#\n[ -f \\${PKG_INSTALL_ROOT}${sysconfdir}/ssh_config ]  ||  \\\\\n\tcp -p \\${PKG_INSTALL_ROOT}${sysconfdir}/ssh_config.default \\\\\n\t\t\\${PKG_INSTALL_ROOT}${sysconfdir}/ssh_config\n[ -f \\${PKG_INSTALL_ROOT}${sysconfdir}/sshd_config ]  ||  \\\\\n\tcp -p \\${PKG_INSTALL_ROOT}${sysconfdir}/sshd_config.default \\\\\n\t\t\\${PKG_INSTALL_ROOT}${sysconfdir}/sshd_config\n\n# make rc?.d dirs only if we are doing a test install\n[ -n \"${TEST_DIR}\" ]  &&  [ $DO_SMF -ne 1 ] && {\n\t[ \"$RCS_D\" = yes ]  &&  mkdir -p ${TEST_DIR}/etc/rcS.d\n\tmkdir -p ${TEST_DIR}/etc/rc0.d\n\t[ \"$RC1_D\" = no ]  ||  mkdir -p ${TEST_DIR}/etc/rc1.d\n\tmkdir -p ${TEST_DIR}/etc/rc2.d\n}\n\nif [ $DO_SMF -eq 1 ]\nthen\n\t# Delete the existing service, if it exists, then import the\n\t# new one.\n\tif svcs $OPENSSH_FMRI > /dev/null 2>&1\n\tthen\n\t\tsvccfg delete -f $OPENSSH_FMRI\n\tfi\n\t# NOTE, The manifest disables sshd by default.\n\tsvccfg import ${TEST_DIR}${SMF_MANIFEST_DIR}/${SYSVINIT_NAME}.xml\nelse\n\tif [ \"\\${USE_SYM_LINKS}\" = yes ]\n\tthen\n\t\t[ \"$RCS_D\" = yes ]  &&  \\\\\n\tinstallf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR/etc/rcS.d/${SYSVINITSTOPT}${SYSVINIT_NAME}=../init.d/${SYSVINIT_NAME} s\n\t\tinstallf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR/etc/rc0.d/${SYSVINITSTOPT}${SYSVINIT_NAME}=../init.d/${SYSVINIT_NAME} s\n\t\t[ \"$RC1_D\" = no ]  ||  \\\\\n\t\tinstallf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR/etc/rc1.d/${SYSVINITSTOPT}${SYSVINIT_NAME}=../init.d/${SYSVINIT_NAME} s\n\t\tinstallf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR/etc/rc2.d/${SYSVINITSTART}${SYSVINIT_NAME}=../init.d/${SYSVINIT_NAME} s\n\telse\n\t\t[ \"$RCS_D\" = yes ]  &&  \\\\\n\tinstallf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR/etc/rcS.d/${SYSVINITSTOPT}${SYSVINIT_NAME}=\\${PKG_INSTALL_ROOT}$TEST_DIR/etc/init.d/${SYSVINIT_NAME} l\n\t\tinstallf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR/etc/rc0.d/${SYSVINITSTOPT}${SYSVINIT_NAME}=\\${PKG_INSTALL_ROOT}$TEST_DIR/etc/init.d/${SYSVINIT_NAME} l\n\t\t[ \"$RC1_D\" = no ]  ||  \\\\\n\t\tinstallf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR/etc/rc1.d/${SYSVINITSTOPT}${SYSVINIT_NAME}=\\${PKG_INSTALL_ROOT}$TEST_DIR/etc/init.d/${SYSVINIT_NAME} l\n\t\tinstallf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR/etc/rc2.d/${SYSVINITSTART}${SYSVINIT_NAME}=\\${PKG_INSTALL_ROOT}$TEST_DIR/etc/init.d/${SYSVINIT_NAME} l\n\tfi\nfi\n\n# If piddir doesn't exist we add it. (Ie. --with-pid-dir=/var/opt/ssh)\n[ -d $piddir ]  ||  installf ${PKGNAME} \\${PKG_INSTALL_ROOT}$TEST_DIR$piddir d 0755 root sys\n\n_EOF\n\n# local postinstall changes here\n[ -s \"${PKG_POSTINSTALL_LOCAL}\" ]  &&  . ${PKG_POSTINSTALL_LOCAL}\n\ncat >> postinstall << _EOF\ninstallf -f ${PKGNAME}\n\n# Use chroot to handle PKG_INSTALL_ROOT\nif [ ! -z \"\\${PKG_INSTALL_ROOT}\" ]\nthen\n\tchroot=\"chroot \\${PKG_INSTALL_ROOT}\"\nfi\n# If this is a test build, we will skip the groupadd/useradd/passwd commands\nif [ ! -z \"${TEST_DIR}\" ]\nthen\n\tchroot=echo\nfi\n\n\techo \"PrivilegeSeparation user always required.\"\n\tif cut -f1 -d: \\${PKG_INSTALL_ROOT}/etc/passwd | egrep '^'$SSH_PRIVSEP_USER'\\$' >/dev/null\n\tthen\n\t\techo \"PrivSep user $SSH_PRIVSEP_USER already exists.\"\n\t\tSSH_PRIVSEP_GROUP=\\`grep \"^$SSH_PRIVSEP_USER:\" \\${PKG_INSTALL_ROOT}/etc/passwd | awk -F: '{print \\$4}'\\`\n\t\tSSH_PRIVSEP_GROUP=\\`grep \":\\$SSH_PRIVSEP_GROUP:\" \\${PKG_INSTALL_ROOT}/etc/group | awk -F: '{print \\$1}'\\`\n\telse\n\t\tDO_PASSWD=yes\n\tfi\n\t[ -z \"\\$SSH_PRIVSEP_GROUP\" ]  &&  SSH_PRIVSEP_GROUP=$SSH_PRIVSEP_USER\n\n\t# group required?\n\tif cut -f1 -d: \\${PKG_INSTALL_ROOT}/etc/group | egrep '^'\\$SSH_PRIVSEP_GROUP'\\$' >/dev/null\n\tthen\n\t\techo \"PrivSep group \\$SSH_PRIVSEP_GROUP already exists.\"\n\telse\n\t\tDO_GROUP=yes\n\tfi\n\n\t# create group if required\n\t[ \"\\$DO_GROUP\" = yes ]  &&  {\n\t\t# Use gid of 67 if possible\n\t\tif cut -f3 -d: \\${PKG_INSTALL_ROOT}/etc/group | egrep '^'$SSHDGID'\\$' >/dev/null\n\t\tthen\n\t\t\t:\n\t\telse\n\t\t\tsshdgid=\"-g $SSHDGID\"\n\t\tfi\n\t\techo \"Creating PrivSep group \\$SSH_PRIVSEP_GROUP.\"\n\t\t\\$chroot ${PATH_GROUPADD_PROG} \\$sshdgid \\$SSH_PRIVSEP_GROUP\n\t}\n\n\t# Create user if required\n\t[ \"\\$DO_PASSWD\" = yes ]  &&  {\n\t\t# Use uid of 67 if possible\n\t\tif cut -f3 -d: \\${PKG_INSTALL_ROOT}/etc/passwd | egrep '^'$SSHDUID'\\$' >/dev/null\n\t\tthen\n\t\t\t:\n\t\telse\n\t\t\tsshduid=\"-u $SSHDUID\"\n\t\tfi\n\t\techo \"Creating PrivSep user $SSH_PRIVSEP_USER.\"\n\t\t\\$chroot ${PATH_USERADD_PROG} -c 'SSHD PrivSep User' -s /bin/false -g $SSH_PRIVSEP_USER \\$sshduid $SSH_PRIVSEP_USER\n\t\t\\$chroot ${PATH_PASSWD_PROG} -l $SSH_PRIVSEP_USER\n\t}\n\nif [ \"\\${POST_INS_START}\" = \"yes\" ]\nthen\n\tif [ $DO_SMF -eq 1 ]\n\tthen\n\t\tsvcadm enable $OPENSSH_FMRI\n\telse\n\t\t${TEST_DIR}/etc/init.d/${SYSVINIT_NAME} start\n\tfi\nfi\nexit 0\n_EOF\n\n## Build preremove file\necho \"Building preremove file...\"\ncat > preremove << _EOF\n#! ${SCRIPT_SHELL}\n#\nif [ $DO_SMF -eq 1 ]\nthen\n\tsvcadm disable $OPENSSH_FMRI\nelse\n\t${TEST_DIR}/etc/init.d/${SYSVINIT_NAME} stop\nfi\n_EOF\n\n# local preremove changes here\n[ -s \"${PKG_PREREMOVE_LOCAL}\" ]  &&  . ${PKG_PREREMOVE_LOCAL}\n\ncat >> preremove << _EOF\nexit 0\n_EOF\n\n## Build postremove file\necho \"Building postremove file...\"\ncat > postremove << _EOF\n#! ${SCRIPT_SHELL}\n#\nif [ $DO_SMF -eq 1 ]\nthen\n\tif svcs $OPENSSH_FMRI > /dev/null 2>&1\n\tthen\n\t\tsvccfg delete -f $OPENSSH_FMRI\n\tfi\nfi\n_EOF\n\n# local postremove changes here\n[ -s \"${PKG_POSTREMOVE_LOCAL}\" ]  &&  . ${PKG_POSTREMOVE_LOCAL}\n\ncat >> postremove << _EOF\nexit 0\n_EOF\n\n## Build request file\necho \"Building request file...\"\ncat > request << _EOF\ntrap 'exit 3' 15\n\n_EOF\n\n[ -x /usr/bin/ckyorn ]  ||  cat >> request << _EOF\n\nckyorn() {\n# for some strange reason OpenServer5 has no ckyorn\n# We build a striped down version here\n\nDEFAULT=n\nPROMPT=\"Yes or No [yes,no,?,quit]\"\nHELP_PROMPT=\"        Enter y or yes if your answer is yes; n or no if your answer is no.\"\nUSAGE=\"usage: ckyorn [options]\nwhere options may include:\n        -d default\n        -h help\n        -p prompt\n\"\n\nif [ \\$# != 0 ]\nthen\n\twhile getopts d:p:h: c\n\tdo\n\t\tcase \\$c in\n\t\t\th)\tHELP_PROMPT=\"\\$OPTARG\" ;;\n\t\t\td)\tDEFAULT=\\$OPTARG ;;\n\t\t\tp)\tPROMPT=\\$OPTARG ;;\n\t\t\t\\\\?)\techo \"\\$USAGE\" 1>&2\n\t\t\t\texit 1 ;;\n\t\tesac\n\tdone\n\tshift \\`expr \\$OPTIND - 1\\`\nfi\n\nwhile true\ndo\n\techo \"\\${PROMPT}\\\\c \" 1>&2\n\tread key\n\t[ -z \"\\$key\" ]  &&  key=\\$DEFAULT\n\tcase \\$key in\n\t\t[n,N]|[n,N][o,O]|[y,Y]|[y,Y][e,E][s,S])\techo \"\\${key}\\\\c\"\n\t\t\texit 0 ;;\n\t\t\\\\?)\techo \\$HELP_PROMPT 1>&2 ;;\n\t\tq|quit)\techo \"q\\\\c\" 1>&2\n\t\t\texit 3 ;;\n\tesac\ndone\n\n}\n\n_EOF\n\nif [ $DO_SMF -eq 1 ]\nthen\n\t# This could get hairy, as the running sshd may not be under SMF.\n\t# We'll assume an earlier version of OpenSSH started via SMF.\n\tcat >> request << _EOF\nPRE_INS_STOP=no\nPOST_INS_START=no\n# determine if should restart the daemon\nif [ -s ${piddir}/sshd.pid  ] && \\\\\n    /usr/bin/svcs -H $OPENSSH_FMRI 2>&1 | egrep \"^online\" > /dev/null 2>&1\nthen\n\tans=\\`ckyorn -d n \\\\\n-p \"Should the running sshd daemon be restarted? ${DEF_MSG}\"\\` || exit \\$?\n\tcase \\$ans in\n\t\t[y,Y]*)\tPRE_INS_STOP=yes\n\t\t\tPOST_INS_START=yes\n\t\t\t;;\n\tesac\n\nelse\n\n# determine if we should start sshd\n\tans=\\`ckyorn -d n \\\\\n-p \"Start the sshd daemon after installing this package? ${DEF_MSG}\"\\` || exit \\$?\n\tcase \\$ans in\n\t\t[y,Y]*)\tPOST_INS_START=yes ;;\n\tesac\nfi\n\n# make parameters available to installation service,\n# and so to any other packaging scripts\ncat >\\$1 <<!\nPRE_INS_STOP='\\$PRE_INS_STOP'\nPOST_INS_START='\\$POST_INS_START'\n!\n\n_EOF\nelse\n\tcat >> request << _EOF\nUSE_SYM_LINKS=no\nPRE_INS_STOP=no\nPOST_INS_START=no\n# Use symbolic links?\nans=\\`ckyorn -d n \\\\\n-p \"Do you want symbolic links for the start/stop scripts? ${DEF_MSG}\"\\` || exit \\$?\ncase \\$ans in\n\t[y,Y]*)\tUSE_SYM_LINKS=yes ;;\nesac\n\n# determine if should restart the daemon\nif [ -s ${piddir}/sshd.pid  -a  -f ${TEST_DIR}/etc/init.d/${SYSVINIT_NAME} ]\nthen\n\tans=\\`ckyorn -d n \\\\\n-p \"Should the running sshd daemon be restarted? ${DEF_MSG}\"\\` || exit \\$?\n\tcase \\$ans in\n\t\t[y,Y]*)\tPRE_INS_STOP=yes\n\t\t\tPOST_INS_START=yes\n\t\t\t;;\n\tesac\n\nelse\n\n# determine if we should start sshd\n\tans=\\`ckyorn -d n \\\\\n-p \"Start the sshd daemon after installing this package? ${DEF_MSG}\"\\` || exit \\$?\n\tcase \\$ans in\n\t\t[y,Y]*)\tPOST_INS_START=yes ;;\n\tesac\nfi\n\n# make parameters available to installation service,\n# and so to any other packaging scripts\ncat >\\$1 <<!\nUSE_SYM_LINKS='\\$USE_SYM_LINKS'\nPRE_INS_STOP='\\$PRE_INS_STOP'\nPOST_INS_START='\\$POST_INS_START'\n!\n\n_EOF\nfi\n\n# local request changes here\n[ -s \"${PKG_REQUEST_LOCAL}\" ]  &&  . ${PKG_REQUEST_LOCAL}\n\ncat >> request << _EOF\nexit 0\n\n_EOF\n\n## Next Build our prototype\necho \"Building prototype file...\"\ncat >mk-proto.awk << _EOF\n\t    BEGIN { print \"i pkginfo\"; print \"i depend\"; \\\\\n\t\t    print \"i preinstall\"; print \"i postinstall\"; \\\\\n \t\t    print \"i preremove\"; print \"i postremove\"; \\\\\n\t\t    print \"i request\"; print \"i space\"; \\\\\n\t\t    split(\"$SYSTEM_DIR\",sys_files); }\n\t    {\n\t     for (dir in sys_files) { if ( \\$3 != sys_files[dir] )\n\t\t     { if ( \\$1 == \"s\" )\n\t\t\t{ \\$5=\"\"; \\$6=\"\"; }\n\t\t     else\n\t\t\t{ \\$5=\"root\"; \\$6=\"sys\"; }\n\t\t     }\n\t\telse\n\t\t     { \\$4=\"?\"; \\$5=\"?\"; \\$6=\"?\"; break;}\n\t    } }\n\t    { print; }\n_EOF\n\nfind . | egrep -v \"prototype|pkginfo|mk-proto.awk\" | sort | \\\n\tpkgproto $PROTO_ARGS | ${AWK} -f mk-proto.awk > prototype\n\n# /usr/local is a symlink on some systems\n[ \"${USR_LOCAL_IS_SYMLINK}\" = yes ]  &&  {\n\tgrep -v \"^d none /usr/local ? ? ?$\" prototype > prototype.new\n\tmv prototype.new prototype\n}\n\n## Step back a directory and now build the package.\ncd ..\n# local prototype tweeks here\n[ -s \"${POST_PROTOTYPE_EDITS}\" ]  &&  . ${POST_PROTOTYPE_EDITS}\n\necho \"Building package..\"\npkgmk -d ${FAKE_ROOT} -f $FAKE_ROOT/prototype -o\necho | pkgtrans -os ${FAKE_ROOT} ${START}/$PKGNAME-$VERSION$REV-$UNAME_S-$ARCH.pkg\n\t;;\n\n\tjustpkg.sh)\nrm -fr ${FAKE_ROOT}/${PKGNAME}\ngrep -v \"^PSTAMP=\" $FAKE_ROOT/pkginfo > $$tmp\nmv $$tmp $FAKE_ROOT/pkginfo\ncat >> $FAKE_ROOT/pkginfo << _EOF\nPSTAMP=\"${UNAME_S} ${OS_VER} ${ARCH} `date '+%d%b%Y %H:%M'`\"\n_EOF\npkgmk -d ${FAKE_ROOT} -f $FAKE_ROOT/prototype -o\necho | pkgtrans -os ${FAKE_ROOT} ${START}/$PKGNAME-$VERSION$REV-$UNAME_S-$ARCH.pkg\n\t;;\n\nesac\n\n[ \"${REMOVE_FAKE_ROOT_WHEN_DONE}\" = yes ]  &&  rm -rf $FAKE_ROOT\nexit 0\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}