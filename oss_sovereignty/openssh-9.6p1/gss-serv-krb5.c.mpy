{
  "module_name": "gss-serv-krb5.c",
  "hash_id": "f09745429a984e87661b6ac44a11f208b9eb8b0c1ffdb97e7b4bee1e4fe7daf8",
  "original_prompt": "Ingested from openssh-9.6p1/gss-serv-krb5.c",
  "human_readable_source": " \n\n \n\n#include \"includes.h\"\n\n#ifdef GSSAPI\n#ifdef KRB5\n\n#include <sys/types.h>\n\n#include <stdarg.h>\n#include <string.h>\n\n#include \"xmalloc.h\"\n#include \"sshkey.h\"\n#include \"hostfile.h\"\n#include \"auth.h\"\n#include \"log.h\"\n#include \"misc.h\"\n#include \"servconf.h\"\n\n#include \"ssh-gss.h\"\n\nextern ServerOptions options;\n\n#ifdef HEIMDAL\n# include <krb5.h>\n#endif\n#ifdef HAVE_GSSAPI_KRB5_H\n# include <gssapi_krb5.h>\n#elif HAVE_GSSAPI_GSSAPI_KRB5_H\n# include <gssapi/gssapi_krb5.h>\n#endif\n\nstatic krb5_context krb_context = NULL;\n\n \n\nstatic int\nssh_gssapi_krb5_init(void)\n{\n\tkrb5_error_code problem;\n\n\tif (krb_context != NULL)\n\t\treturn 1;\n\n\tproblem = krb5_init_context(&krb_context);\n\tif (problem) {\n\t\tlogit(\"Cannot initialize krb5 context\");\n\t\treturn 0;\n\t}\n\n\treturn 1;\n}\n\n \n\nstatic int\nssh_gssapi_krb5_userok(ssh_gssapi_client *client, char *name)\n{\n\tkrb5_principal princ;\n\tint retval;\n\tconst char *errmsg;\n\n\tif (ssh_gssapi_krb5_init() == 0)\n\t\treturn 0;\n\n\tif ((retval = krb5_parse_name(krb_context, client->exportedname.value,\n\t    &princ))) {\n\t\terrmsg = krb5_get_error_message(krb_context, retval);\n\t\tlogit(\"krb5_parse_name(): %.100s\", errmsg);\n\t\tkrb5_free_error_message(krb_context, errmsg);\n\t\treturn 0;\n\t}\n\tif (krb5_kuserok(krb_context, princ, name)) {\n\t\tretval = 1;\n\t\tlogit(\"Authorized to %s, krb5 principal %s (krb5_kuserok)\",\n\t\t    name, (char *)client->displayname.value);\n\t} else\n\t\tretval = 0;\n\n\tkrb5_free_principal(krb_context, princ);\n\treturn retval;\n}\n\n\n \n\nstatic void\nssh_gssapi_krb5_storecreds(ssh_gssapi_client *client)\n{\n\tkrb5_ccache ccache;\n\tkrb5_error_code problem;\n\tkrb5_principal princ;\n\tOM_uint32 maj_status, min_status;\n\tint len;\n\tconst char *errmsg;\n\n\tif (client->creds == NULL) {\n\t\tdebug(\"No credentials stored\");\n\t\treturn;\n\t}\n\n\tif (ssh_gssapi_krb5_init() == 0)\n\t\treturn;\n\n#ifdef HEIMDAL\n# ifdef HAVE_KRB5_CC_NEW_UNIQUE\n\tif ((problem = krb5_cc_new_unique(krb_context, krb5_fcc_ops.prefix,\n\t    NULL, &ccache)) != 0) {\n\t\terrmsg = krb5_get_error_message(krb_context, problem);\n\t\tlogit(\"krb5_cc_new_unique(): %.100s\", errmsg);\n# else\n\tif ((problem = krb5_cc_gen_new(krb_context, &krb5_fcc_ops, &ccache))) {\n\t    logit(\"krb5_cc_gen_new(): %.100s\",\n\t\tkrb5_get_err_text(krb_context, problem));\n# endif\n\t\tkrb5_free_error_message(krb_context, errmsg);\n\t\treturn;\n\t}\n#else\n\tif ((problem = ssh_krb5_cc_gen(krb_context, &ccache))) {\n\t\terrmsg = krb5_get_error_message(krb_context, problem);\n\t\tlogit(\"ssh_krb5_cc_gen(): %.100s\", errmsg);\n\t\tkrb5_free_error_message(krb_context, errmsg);\n\t\treturn;\n\t}\n#endif\t \n\n\tif ((problem = krb5_parse_name(krb_context,\n\t    client->exportedname.value, &princ))) {\n\t\terrmsg = krb5_get_error_message(krb_context, problem);\n\t\tlogit(\"krb5_parse_name(): %.100s\", errmsg);\n\t\tkrb5_free_error_message(krb_context, errmsg);\n\t\treturn;\n\t}\n\n\tif ((problem = krb5_cc_initialize(krb_context, ccache, princ))) {\n\t\terrmsg = krb5_get_error_message(krb_context, problem);\n\t\tlogit(\"krb5_cc_initialize(): %.100s\", errmsg);\n\t\tkrb5_free_error_message(krb_context, errmsg);\n\t\tkrb5_free_principal(krb_context, princ);\n\t\tkrb5_cc_destroy(krb_context, ccache);\n\t\treturn;\n\t}\n\n\tkrb5_free_principal(krb_context, princ);\n\n\tif ((maj_status = gss_krb5_copy_ccache(&min_status,\n\t    client->creds, ccache))) {\n\t\tlogit(\"gss_krb5_copy_ccache() failed\");\n\t\tkrb5_cc_destroy(krb_context, ccache);\n\t\treturn;\n\t}\n\n\tclient->store.filename = xstrdup(krb5_cc_get_name(krb_context, ccache));\n\tclient->store.envvar = \"KRB5CCNAME\";\n\tlen = strlen(client->store.filename) + 6;\n\tclient->store.envval = xmalloc(len);\n\tsnprintf(client->store.envval, len, \"FILE:%s\", client->store.filename);\n\n#ifdef USE_PAM\n\tif (options.use_pam)\n\t\tdo_pam_putenv(client->store.envvar, client->store.envval);\n#endif\n\n\tkrb5_cc_close(krb_context, ccache);\n\n\treturn;\n}\n\nssh_gssapi_mech gssapi_kerberos_mech = {\n\t\"toWM5Slw5Ew8Mqkay+al2g==\",\n\t\"Kerberos\",\n\t{9, \"\\x2A\\x86\\x48\\x86\\xF7\\x12\\x01\\x02\\x02\"},\n\tNULL,\n\t&ssh_gssapi_krb5_userok,\n\tNULL,\n\t&ssh_gssapi_krb5_storecreds\n};\n\n#endif  \n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}