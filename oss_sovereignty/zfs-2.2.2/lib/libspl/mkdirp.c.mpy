{
  "module_name": "mkdirp.c",
  "hash_id": "edc6305f0d79861bc68d51e24f3e5c04cab9d68c1b8b7882c4b193ba29f613c6",
  "original_prompt": "Ingested from zfs-2.2.2/lib/libspl/mkdirp.c",
  "human_readable_source": " \n\n \n\n \n \n\n \n\n#include <sys/types.h>\n#include <libgen.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <errno.h>\n#include <string.h>\n#include <sys/stat.h>\n\nstatic char *simplify(const char *str);\n\nint\nmkdirp(const char *d, mode_t mode)\n{\n\tchar  *endptr, *ptr, *slash, *str;\n\n\tstr = simplify(d);\n\n\t \n\n\tif (str == NULL)\n\t\treturn (-1);\n\n\t\t \n\n\tif (mkdir(str, mode) == 0) {\n\t\tfree(str);\n\t\treturn (0);\n\t}\n\tif (errno != ENOENT) {\n\t\tfree(str);\n\t\treturn (-1);\n\t}\n\tendptr = strrchr(str, '\\0');\n\tslash = strrchr(str, '/');\n\n\t\t \n\n\twhile (slash != NULL) {\n\n\t\tptr = slash;\n\t\t*ptr = '\\0';\n\n\t\t\t \n\n\t\tif (access(str, F_OK) == 0)\n\t\t\tbreak;\n\n\t\t\t \n\n\t\telse {\n\t\t\tslash = strrchr(str, '/');\n\n\t\t\t\t \n\n\t\t\tif (slash == NULL || slash == str) {\n\t\t\t\tif (mkdir(str, mode) != 0 && errno != EEXIST) {\n\t\t\t\t\tfree(str);\n\t\t\t\t\treturn (-1);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\n\twhile ((ptr = strchr(str, '\\0')) != endptr) {\n\t\t*ptr = '/';\n\t\tif (mkdir(str, mode) != 0 && errno != EEXIST) {\n\t\t\t \n\t\t\tfree(str);\n\t\t\treturn (-1);\n\t\t}\n\t}\n\tfree(str);\n\treturn (0);\n}\n\n \n\nstatic char *\nsimplify(const char *str)\n{\n\tint i;\n\tsize_t mbPathlen;\t \n\tsize_t wcPathlen;\t \n\twchar_t *wptr;\t\t \n\twchar_t *wcPath;\t \n\tchar *mbPath;\t\t \n\n\t \n\n\tif (!str) {\n\t\terrno = ENOENT;\n\t\treturn (NULL);\n\t}\n\n\t \n\n\tif ((mbPath = strdup(str)) == NULL) {\n\t\treturn (NULL);\n\t}\n\n\t \n\n\tmbPathlen = strlen(mbPath);\n\n\tif ((wcPath = calloc(mbPathlen+1, sizeof (wchar_t))) == NULL) {\n\t\tfree(mbPath);\n\t\treturn (NULL);\n\t}\n\n\tif ((wcPathlen = mbstowcs(wcPath, mbPath, mbPathlen)) == (size_t)-1) {\n\t\tfree(mbPath);\n\t\tfree(wcPath);\n\t\treturn (NULL);\n\t}\n\n\t \n\n\tfor (wptr = wcPath, i = 0; i < wcPathlen; i++) {\n\t\t*wptr++ = wcPath[i];\n\n\t\tif (wcPath[i] == '/') {\n\t\t\ti++;\n\n\t\t\twhile (wcPath[i] == '/') {\n\t\t\t\ti++;\n\t\t\t}\n\n\t\t\ti--;\n\t\t}\n\t}\n\n\t*wptr = '\\0';\n\n\t \n\n\tif (wcstombs(mbPath, wcPath, mbPathlen) == (size_t)-1) {\n\t\tfree(mbPath);\n\t\tfree(wcPath);\n\t\treturn (NULL);\n\t}\n\n\tfree(wcPath);\n\treturn (mbPath);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}