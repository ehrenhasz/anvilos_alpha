{
  "module_name": "getmntany.c",
  "hash_id": "d8ad74e2cfdf368ba264cabeb84904cc6f9e121852e4c1010b7f4a4a7dde3ef7",
  "original_prompt": "Ingested from zfs-2.2.2/lib/libspl/os/linux/getmntany.c",
  "human_readable_source": " \n \n\n \n \n\n#include <stdio.h>\n#include <string.h>\n#include <mntent.h>\n#include <sys/errno.h>\n#include <sys/mnttab.h>\n\n#include <sys/types.h>\n#include <sys/sysmacros.h>\n#include <sys/stat.h>\n#include <unistd.h>\n\n#define\tBUFSIZE\t(MNT_LINE_MAX + 2)\n\nstatic __thread char buf[BUFSIZE];\n\n#define\tDIFF(xx)\t( \\\n\t    (mrefp->xx != NULL) && \\\n\t    (mgetp->xx == NULL || strcmp(mrefp->xx, mgetp->xx) != 0))\n\nint\ngetmntany(FILE *fp, struct mnttab *mgetp, struct mnttab *mrefp)\n{\n\tint ret;\n\n\twhile (\n\t    ((ret = _sol_getmntent(fp, mgetp)) == 0) && (\n\t    DIFF(mnt_special) || DIFF(mnt_mountp) ||\n\t    DIFF(mnt_fstype) || DIFF(mnt_mntopts))) { }\n\n\treturn (ret);\n}\n\nint\n_sol_getmntent(FILE *fp, struct mnttab *mgetp)\n{\n\tstruct mntent mntbuf;\n\tstruct mntent *ret;\n\n\tret = getmntent_r(fp, &mntbuf, buf, BUFSIZE);\n\n\tif (ret != NULL) {\n\t\tmgetp->mnt_special = mntbuf.mnt_fsname;\n\t\tmgetp->mnt_mountp = mntbuf.mnt_dir;\n\t\tmgetp->mnt_fstype = mntbuf.mnt_type;\n\t\tmgetp->mnt_mntopts = mntbuf.mnt_opts;\n\t\treturn (0);\n\t}\n\n\tif (feof(fp))\n\t\treturn (-1);\n\n\treturn (MNT_TOOLONG);\n}\n\nstatic int\ngetextmntent_impl(FILE *fp, struct extmnttab *mp)\n{\n\tint ret;\n\tstruct stat64 st;\n\n\tret = _sol_getmntent(fp, (struct mnttab *)mp);\n\tif (ret == 0) {\n\t\tif (stat64(mp->mnt_mountp, &st) != 0) {\n\t\t\tmp->mnt_major = 0;\n\t\t\tmp->mnt_minor = 0;\n\t\t\treturn (ret);\n\t\t}\n\t\tmp->mnt_major = major(st.st_dev);\n\t\tmp->mnt_minor = minor(st.st_dev);\n\t}\n\n\treturn (ret);\n}\n\nint\ngetextmntent(const char *path, struct extmnttab *entry, struct stat64 *statbuf)\n{\n\tstruct stat64 st;\n\tFILE *fp;\n\tint match;\n\n\tif (strlen(path) >= MAXPATHLEN) {\n\t\t(void) fprintf(stderr, \"invalid object; pathname too long\\n\");\n\t\treturn (-1);\n\t}\n\n\t \n\tif (stat64(path, statbuf) != 0) {\n\t\t(void) fprintf(stderr, \"cannot open '%s': %s\\n\",\n\t\t    path, strerror(errno));\n\t\treturn (-1);\n\t}\n\n\n\tif ((fp = fopen(MNTTAB, \"re\")) == NULL) {\n\t\t(void) fprintf(stderr, \"cannot open %s\\n\", MNTTAB);\n\t\treturn (-1);\n\t}\n\n\t \n\n\tmatch = 0;\n\twhile (getextmntent_impl(fp, entry) == 0) {\n\t\tif (makedev(entry->mnt_major, entry->mnt_minor) ==\n\t\t    statbuf->st_dev) {\n\t\t\tmatch = 1;\n\t\t\tbreak;\n\t\t}\n\t}\n\t(void) fclose(fp);\n\n\tif (!match) {\n\t\t(void) fprintf(stderr, \"cannot find mountpoint for '%s'\\n\",\n\t\t    path);\n\t\treturn (-1);\n\t}\n\n\tif (stat64(entry->mnt_mountp, &st) != 0) {\n\t\tentry->mnt_major = 0;\n\t\tentry->mnt_minor = 0;\n\t\treturn (-1);\n\t}\n\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}