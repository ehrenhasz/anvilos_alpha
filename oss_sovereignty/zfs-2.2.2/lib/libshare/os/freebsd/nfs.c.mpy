{
  "module_name": "nfs.c",
  "hash_id": "d3e2412bd29bf73e487b557f508a05a2f146ef2c722ca37ed25ab3901ef27fd3",
  "original_prompt": "Ingested from zfs-2.2.2/lib/libshare/os/freebsd/nfs.c",
  "human_readable_source": " \n\n#include <sys/cdefs.h>\n__FBSDID(\"$FreeBSD$\");\n\n#include <sys/param.h>\n#include <sys/vfs.h>\n\n#include <assert.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <libutil.h>\n#include <signal.h>\n#include <stdio.h>\n#include <string.h>\n#include <unistd.h>\n#include <libintl.h>\n\n#include <libshare.h>\n#include \"libshare_impl.h\"\n#include \"nfs.h\"\n\n#define\t_PATH_MOUNTDPID\t\"/var/run/mountd.pid\"\n#define\tOPTSSIZE\t1024\n#define\tMAXLINESIZE\t(PATH_MAX + OPTSSIZE)\n#define\tZFS_EXPORTS_FILE\t\"/etc/zfs/exports\"\n#define\tZFS_EXPORTS_LOCK\tZFS_EXPORTS_FILE\".lock\"\n\n \nstatic int\ntranslate_opts(const char *shareopts, FILE *out)\n{\n\tstatic const char *const known_opts[] = { \"ro\", \"maproot\", \"mapall\",\n\t    \"mask\", \"network\", \"sec\", \"alldirs\", \"public\", \"webnfs\", \"index\",\n\t    \"quiet\" };\n\tchar oldopts[OPTSSIZE], newopts[OPTSSIZE];\n\tchar *o, *s = NULL;\n\tunsigned int i;\n\tsize_t len;\n\n\tstrlcpy(oldopts, shareopts, sizeof (oldopts));\n\tnewopts[0] = '\\0';\n\ts = oldopts;\n\twhile ((o = strsep(&s, \"-, \")) != NULL) {\n\t\tif (o[0] == '\\0')\n\t\t\tcontinue;\n\t\tfor (i = 0; i < ARRAY_SIZE(known_opts); ++i) {\n\t\t\tlen = strlen(known_opts[i]);\n\t\t\tif (strncmp(known_opts[i], o, len) == 0 &&\n\t\t\t    (o[len] == '\\0' || o[len] == '=')) {\n\t\t\t\tstrlcat(newopts, \"-\", sizeof (newopts));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tstrlcat(newopts, o, sizeof (newopts));\n\t\tstrlcat(newopts, \" \", sizeof (newopts));\n\t}\n\treturn (fputs(newopts, out));\n}\n\nstatic int\nnfs_enable_share_impl(sa_share_impl_t impl_share, FILE *tmpfile)\n{\n\tconst char *shareopts = impl_share->sa_shareopts;\n\tif (strcmp(shareopts, \"on\") == 0)\n\t\tshareopts = \"\";\n\n\tboolean_t need_free;\n\tchar *mp;\n\tint rc  = nfs_escape_mountpoint(impl_share->sa_mountpoint, &mp,\n\t    &need_free);\n\tif (rc != SA_OK)\n\t\treturn (rc);\n\n\tif (fputs(mp, tmpfile) == EOF ||\n\t    fputc('\\t', tmpfile) == EOF ||\n\t    translate_opts(shareopts, tmpfile) == EOF ||\n\t    fputc('\\n', tmpfile) == EOF) {\n\t\tfprintf(stderr, \"failed to write to temporary file\\n\");\n\t\trc = SA_SYSTEM_ERR;\n\t}\n\n\tif (need_free)\n\t\tfree(mp);\n\treturn (rc);\n}\n\nstatic int\nnfs_enable_share(sa_share_impl_t impl_share)\n{\n\treturn (nfs_toggle_share(\n\t    ZFS_EXPORTS_LOCK, ZFS_EXPORTS_FILE, NULL, impl_share,\n\t    nfs_enable_share_impl));\n}\n\nstatic int\nnfs_disable_share_impl(sa_share_impl_t impl_share, FILE *tmpfile)\n{\n\t(void) impl_share, (void) tmpfile;\n\treturn (SA_OK);\n}\n\nstatic int\nnfs_disable_share(sa_share_impl_t impl_share)\n{\n\treturn (nfs_toggle_share(\n\t    ZFS_EXPORTS_LOCK, ZFS_EXPORTS_FILE, NULL, impl_share,\n\t    nfs_disable_share_impl));\n}\n\nstatic boolean_t\nnfs_is_shared(sa_share_impl_t impl_share)\n{\n\treturn (nfs_is_shared_impl(ZFS_EXPORTS_FILE, impl_share));\n}\n\nstatic int\nnfs_validate_shareopts(const char *shareopts)\n{\n\tif (strlen(shareopts) == 0)\n\t\treturn (SA_SYNTAX_ERR);\n\treturn (SA_OK);\n}\n\n \nstatic int\nnfs_commit_shares(void)\n{\n\tstruct pidfh *pfh;\n\tpid_t mountdpid;\n\nstart:\n\tpfh = pidfile_open(_PATH_MOUNTDPID, 0600, &mountdpid);\n\tif (pfh != NULL) {\n\t\t \n\t\tpidfile_remove(pfh);\n\t\treturn (SA_OK);\n\t}\n\tif (errno != EEXIST) {\n\t\t \n\t\treturn (SA_SYSTEM_ERR);\n\t}\n\tif (mountdpid == -1) {\n\t\t \n\t\tusleep(500);\n\t\tgoto start;\n\t}\n\t \n\tkill(mountdpid, SIGHUP);\n\treturn (SA_OK);\n}\n\nstatic void\nnfs_truncate_shares(void)\n{\n\tnfs_reset_shares(ZFS_EXPORTS_LOCK, ZFS_EXPORTS_FILE);\n}\n\nconst sa_fstype_t libshare_nfs_type = {\n\t.enable_share = nfs_enable_share,\n\t.disable_share = nfs_disable_share,\n\t.is_shared = nfs_is_shared,\n\n\t.validate_shareopts = nfs_validate_shareopts,\n\t.commit_shares = nfs_commit_shares,\n\t.truncate_shares = nfs_truncate_shares,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}