{
  "module_name": "libzfs_config.c",
  "hash_id": "6ea8d8d1e12cfc31e0b2f712e56e28c8bc6c8a593b5c0461199788e21d0e60e6",
  "original_prompt": "Ingested from zfs-2.2.2/lib/libzfs/libzfs_config.c",
  "human_readable_source": " \n\n \n\n \n\n \n\n#include <errno.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <stddef.h>\n#include <string.h>\n#include <unistd.h>\n#include <libintl.h>\n#include <libuutil.h>\n\n#include \"libzfs_impl.h\"\n\ntypedef struct config_node {\n\tchar\t\t*cn_name;\n\tnvlist_t\t*cn_config;\n\tuu_avl_node_t\tcn_avl;\n} config_node_t;\n\nstatic int\nconfig_node_compare(const void *a, const void *b, void *unused)\n{\n\t(void) unused;\n\tconst config_node_t *ca = (config_node_t *)a;\n\tconst config_node_t *cb = (config_node_t *)b;\n\n\tint ret = strcmp(ca->cn_name, cb->cn_name);\n\n\tif (ret < 0)\n\t\treturn (-1);\n\telse if (ret > 0)\n\t\treturn (1);\n\telse\n\t\treturn (0);\n}\n\nvoid\nnamespace_clear(libzfs_handle_t *hdl)\n{\n\tif (hdl->libzfs_ns_avl) {\n\t\tconfig_node_t *cn;\n\t\tvoid *cookie = NULL;\n\n\t\twhile ((cn = uu_avl_teardown(hdl->libzfs_ns_avl,\n\t\t    &cookie)) != NULL) {\n\t\t\tnvlist_free(cn->cn_config);\n\t\t\tfree(cn->cn_name);\n\t\t\tfree(cn);\n\t\t}\n\n\t\tuu_avl_destroy(hdl->libzfs_ns_avl);\n\t\thdl->libzfs_ns_avl = NULL;\n\t}\n\n\tif (hdl->libzfs_ns_avlpool) {\n\t\tuu_avl_pool_destroy(hdl->libzfs_ns_avlpool);\n\t\thdl->libzfs_ns_avlpool = NULL;\n\t}\n}\n\n \nstatic int\nnamespace_reload(libzfs_handle_t *hdl)\n{\n\tnvlist_t *config;\n\tconfig_node_t *cn;\n\tnvpair_t *elem;\n\tzfs_cmd_t zc = {\"\\0\"};\n\tvoid *cookie;\n\n\tif (hdl->libzfs_ns_gen == 0) {\n\t\t \n\t\tif ((hdl->libzfs_ns_avlpool = uu_avl_pool_create(\"config_pool\",\n\t\t    sizeof (config_node_t),\n\t\t    offsetof(config_node_t, cn_avl),\n\t\t    config_node_compare, UU_DEFAULT)) == NULL)\n\t\t\treturn (no_memory(hdl));\n\n\t\tif ((hdl->libzfs_ns_avl = uu_avl_create(hdl->libzfs_ns_avlpool,\n\t\t    NULL, UU_DEFAULT)) == NULL)\n\t\t\treturn (no_memory(hdl));\n\t}\n\n\tzcmd_alloc_dst_nvlist(hdl, &zc, 0);\n\n\tfor (;;) {\n\t\tzc.zc_cookie = hdl->libzfs_ns_gen;\n\t\tif (zfs_ioctl(hdl, ZFS_IOC_POOL_CONFIGS, &zc) != 0) {\n\t\t\tswitch (errno) {\n\t\t\tcase EEXIST:\n\t\t\t\t \n\t\t\t\tzcmd_free_nvlists(&zc);\n\t\t\t\treturn (0);\n\n\t\t\tcase ENOMEM:\n\t\t\t\tzcmd_expand_dst_nvlist(hdl, &zc);\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tzcmd_free_nvlists(&zc);\n\t\t\t\treturn (zfs_standard_error(hdl, errno,\n\t\t\t\t    dgettext(TEXT_DOMAIN, \"failed to read \"\n\t\t\t\t    \"pool configuration\")));\n\t\t\t}\n\t\t} else {\n\t\t\thdl->libzfs_ns_gen = zc.zc_cookie;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (zcmd_read_dst_nvlist(hdl, &zc, &config) != 0) {\n\t\tzcmd_free_nvlists(&zc);\n\t\treturn (-1);\n\t}\n\n\tzcmd_free_nvlists(&zc);\n\n\t \n\tcookie = NULL;\n\twhile ((cn = uu_avl_teardown(hdl->libzfs_ns_avl, &cookie)) != NULL) {\n\t\tnvlist_free(cn->cn_config);\n\t\tfree(cn->cn_name);\n\t\tfree(cn);\n\t}\n\n\telem = NULL;\n\twhile ((elem = nvlist_next_nvpair(config, elem)) != NULL) {\n\t\tnvlist_t *child;\n\t\tuu_avl_index_t where;\n\n\t\tcn = zfs_alloc(hdl, sizeof (config_node_t));\n\t\tcn->cn_name = zfs_strdup(hdl, nvpair_name(elem));\n\t\tchild = fnvpair_value_nvlist(elem);\n\t\tif (nvlist_dup(child, &cn->cn_config, 0) != 0) {\n\t\t\tfree(cn->cn_name);\n\t\t\tfree(cn);\n\t\t\tnvlist_free(config);\n\t\t\treturn (no_memory(hdl));\n\t\t}\n\t\tverify(uu_avl_find(hdl->libzfs_ns_avl, cn, NULL, &where)\n\t\t    == NULL);\n\n\t\tuu_avl_insert(hdl->libzfs_ns_avl, cn, where);\n\t}\n\n\tnvlist_free(config);\n\treturn (0);\n}\n\n \nnvlist_t *\nzpool_get_config(zpool_handle_t *zhp, nvlist_t **oldconfig)\n{\n\tif (oldconfig)\n\t\t*oldconfig = zhp->zpool_old_config;\n\treturn (zhp->zpool_config);\n}\n\n \nnvlist_t *\nzpool_get_features(zpool_handle_t *zhp)\n{\n\tnvlist_t *config, *features;\n\n\tconfig = zpool_get_config(zhp, NULL);\n\n\tif (config == NULL || !nvlist_exists(config,\n\t    ZPOOL_CONFIG_FEATURE_STATS)) {\n\t\tint error;\n\t\tboolean_t missing = B_FALSE;\n\n\t\terror = zpool_refresh_stats(zhp, &missing);\n\n\t\tif (error != 0 || missing)\n\t\t\treturn (NULL);\n\n\t\tconfig = zpool_get_config(zhp, NULL);\n\t}\n\n\tif (nvlist_lookup_nvlist(config, ZPOOL_CONFIG_FEATURE_STATS,\n\t    &features) != 0)\n\t\treturn (NULL);\n\n\treturn (features);\n}\n\n \nint\nzpool_refresh_stats(zpool_handle_t *zhp, boolean_t *missing)\n{\n\tzfs_cmd_t zc = {\"\\0\"};\n\tint error;\n\tnvlist_t *config;\n\tlibzfs_handle_t *hdl = zhp->zpool_hdl;\n\n\t*missing = B_FALSE;\n\t(void) strcpy(zc.zc_name, zhp->zpool_name);\n\n\tif (zhp->zpool_config_size == 0)\n\t\tzhp->zpool_config_size = 1 << 16;\n\n\tzcmd_alloc_dst_nvlist(hdl, &zc, zhp->zpool_config_size);\n\n\tfor (;;) {\n\t\tif (zfs_ioctl(zhp->zpool_hdl, ZFS_IOC_POOL_STATS,\n\t\t    &zc) == 0) {\n\t\t\t \n\t\t\terror = zc.zc_cookie;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (errno == ENOMEM)\n\t\t\tzcmd_expand_dst_nvlist(hdl, &zc);\n\t\telse {\n\t\t\tzcmd_free_nvlists(&zc);\n\t\t\tif (errno == ENOENT || errno == EINVAL)\n\t\t\t\t*missing = B_TRUE;\n\t\t\tzhp->zpool_state = POOL_STATE_UNAVAIL;\n\t\t\treturn (0);\n\t\t}\n\t}\n\n\tif (zcmd_read_dst_nvlist(hdl, &zc, &config) != 0) {\n\t\tzcmd_free_nvlists(&zc);\n\t\treturn (-1);\n\t}\n\n\tzcmd_free_nvlists(&zc);\n\n\tzhp->zpool_config_size = zc.zc_nvlist_dst_size;\n\n\tif (zhp->zpool_config != NULL) {\n\t\tnvlist_free(zhp->zpool_old_config);\n\n\t\tzhp->zpool_old_config = zhp->zpool_config;\n\t}\n\n\tzhp->zpool_config = config;\n\tif (error)\n\t\tzhp->zpool_state = POOL_STATE_UNAVAIL;\n\telse\n\t\tzhp->zpool_state = POOL_STATE_ACTIVE;\n\n\treturn (0);\n}\n\n \nboolean_t\nzpool_skip_pool(const char *poolname)\n{\n\tstatic boolean_t initialized = B_FALSE;\n\tstatic const char *exclude = NULL;\n\tstatic const char *restricted = NULL;\n\n\tconst char *cur, *end;\n\tint len;\n\tint namelen = strlen(poolname);\n\n\tif (!initialized) {\n\t\tinitialized = B_TRUE;\n\t\texclude = getenv(\"__ZFS_POOL_EXCLUDE\");\n\t\trestricted = getenv(\"__ZFS_POOL_RESTRICT\");\n\t}\n\n\tif (exclude != NULL) {\n\t\tcur = exclude;\n\t\tdo {\n\t\t\tend = strchr(cur, ' ');\n\t\t\tlen = (NULL == end) ? strlen(cur) : (end - cur);\n\t\t\tif (len == namelen && 0 == strncmp(cur, poolname, len))\n\t\t\t\treturn (B_TRUE);\n\t\t\tcur += (len + 1);\n\t\t} while (NULL != end);\n\t}\n\n\tif (NULL == restricted)\n\t\treturn (B_FALSE);\n\n\tcur = restricted;\n\tdo {\n\t\tend = strchr(cur, ' ');\n\t\tlen = (NULL == end) ? strlen(cur) : (end - cur);\n\n\t\tif (len == namelen && 0 == strncmp(cur, poolname, len)) {\n\t\t\treturn (B_FALSE);\n\t\t}\n\n\t\tcur += (len + 1);\n\t} while (NULL != end);\n\n\treturn (B_TRUE);\n}\n\n \nint\nzpool_iter(libzfs_handle_t *hdl, zpool_iter_f func, void *data)\n{\n\tconfig_node_t *cn;\n\tzpool_handle_t *zhp;\n\tint ret;\n\n\t \n\tif (!hdl->libzfs_pool_iter && namespace_reload(hdl) != 0)\n\t\treturn (-1);\n\n\thdl->libzfs_pool_iter++;\n\tfor (cn = uu_avl_first(hdl->libzfs_ns_avl); cn != NULL;\n\t    cn = uu_avl_next(hdl->libzfs_ns_avl, cn)) {\n\n\t\tif (zpool_skip_pool(cn->cn_name))\n\t\t\tcontinue;\n\n\t\tif (zpool_open_silent(hdl, cn->cn_name, &zhp) != 0) {\n\t\t\thdl->libzfs_pool_iter--;\n\t\t\treturn (-1);\n\t\t}\n\n\t\tif (zhp == NULL)\n\t\t\tcontinue;\n\n\t\tif ((ret = func(zhp, data)) != 0) {\n\t\t\thdl->libzfs_pool_iter--;\n\t\t\treturn (ret);\n\t\t}\n\t}\n\thdl->libzfs_pool_iter--;\n\n\treturn (0);\n}\n\n \nint\nzfs_iter_root(libzfs_handle_t *hdl, zfs_iter_f func, void *data)\n{\n\tconfig_node_t *cn;\n\tzfs_handle_t *zhp;\n\tint ret;\n\n\tif (namespace_reload(hdl) != 0)\n\t\treturn (-1);\n\n\tfor (cn = uu_avl_first(hdl->libzfs_ns_avl); cn != NULL;\n\t    cn = uu_avl_next(hdl->libzfs_ns_avl, cn)) {\n\n\t\tif (zpool_skip_pool(cn->cn_name))\n\t\t\tcontinue;\n\n\t\tif ((zhp = make_dataset_handle(hdl, cn->cn_name)) == NULL)\n\t\t\tcontinue;\n\n\t\tif ((ret = func(zhp, data)) != 0)\n\t\t\treturn (ret);\n\t}\n\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}