{
  "module_name": "libzfs_pool_os.c",
  "hash_id": "275dddf435f8247b09f26ace8d5f5a9440e6cf829c8017c35fa51b1d061365f6",
  "original_prompt": "Ingested from zfs-2.2.2/lib/libzfs/os/linux/libzfs_pool_os.c",
  "human_readable_source": " \n\n \n\n#include <errno.h>\n#include <libintl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <libgen.h>\n#include <zone.h>\n#include <sys/stat.h>\n#include <sys/efi_partition.h>\n#include <sys/systeminfo.h>\n#include <sys/zfs_ioctl.h>\n#include <sys/vdev_disk.h>\n#include <dlfcn.h>\n#include <libzutil.h>\n\n#include \"zfs_namecheck.h\"\n#include \"zfs_prop.h\"\n#include \"../../libzfs_impl.h\"\n#include \"zfs_comutil.h\"\n#include \"zfeature_common.h\"\n\n \nint\nzpool_relabel_disk(libzfs_handle_t *hdl, const char *path, const char *msg)\n{\n\tint fd, error;\n\n\tif ((fd = open(path, O_RDWR|O_DIRECT|O_CLOEXEC)) < 0) {\n\t\tzfs_error_aux(hdl, dgettext(TEXT_DOMAIN, \"cannot \"\n\t\t    \"relabel '%s': unable to open device: %d\"), path, errno);\n\t\treturn (zfs_error(hdl, EZFS_OPENFAILED, msg));\n\t}\n\n\t \n\terror = efi_use_whole_disk(fd);\n\n\t \n\t(void) fsync(fd);\n\t(void) ioctl(fd, BLKFLSBUF);\n\n\t(void) close(fd);\n\tif (error && error != VT_ENOSPC) {\n\t\tzfs_error_aux(hdl, dgettext(TEXT_DOMAIN, \"cannot \"\n\t\t    \"relabel '%s': unable to read disk capacity\"), path);\n\t\treturn (zfs_error(hdl, EZFS_NOCAP, msg));\n\t}\n\treturn (0);\n}\n\n \nstatic int\nread_efi_label(nvlist_t *config, diskaddr_t *sb)\n{\n\tconst char *path;\n\tint fd;\n\tchar diskname[MAXPATHLEN];\n\tint err = -1;\n\n\tif (nvlist_lookup_string(config, ZPOOL_CONFIG_PATH, &path) != 0)\n\t\treturn (err);\n\n\t(void) snprintf(diskname, sizeof (diskname), \"%s%s\", DISK_ROOT,\n\t    strrchr(path, '/'));\n\tif ((fd = open(diskname, O_RDONLY|O_DIRECT|O_CLOEXEC)) >= 0) {\n\t\tstruct dk_gpt *vtoc;\n\n\t\tif ((err = efi_alloc_and_read(fd, &vtoc)) >= 0) {\n\t\t\tif (sb != NULL)\n\t\t\t\t*sb = vtoc->efi_parts[0].p_start;\n\t\t\tefi_free(vtoc);\n\t\t}\n\t\t(void) close(fd);\n\t}\n\treturn (err);\n}\n\n \nstatic diskaddr_t\nfind_start_block(nvlist_t *config)\n{\n\tnvlist_t **child;\n\tuint_t c, children;\n\tdiskaddr_t sb = MAXOFFSET_T;\n\tuint64_t wholedisk;\n\n\tif (nvlist_lookup_nvlist_array(config,\n\t    ZPOOL_CONFIG_CHILDREN, &child, &children) != 0) {\n\t\tif (nvlist_lookup_uint64(config,\n\t\t    ZPOOL_CONFIG_WHOLE_DISK,\n\t\t    &wholedisk) != 0 || !wholedisk) {\n\t\t\treturn (MAXOFFSET_T);\n\t\t}\n\t\tif (read_efi_label(config, &sb) < 0)\n\t\t\tsb = MAXOFFSET_T;\n\t\treturn (sb);\n\t}\n\n\tfor (c = 0; c < children; c++) {\n\t\tsb = find_start_block(child[c]);\n\t\tif (sb != MAXOFFSET_T) {\n\t\t\treturn (sb);\n\t\t}\n\t}\n\treturn (MAXOFFSET_T);\n}\n\nstatic int\nzpool_label_disk_check(char *path)\n{\n\tstruct dk_gpt *vtoc;\n\tint fd, err;\n\n\tif ((fd = open(path, O_RDONLY|O_DIRECT|O_CLOEXEC)) < 0)\n\t\treturn (errno);\n\n\tif ((err = efi_alloc_and_read(fd, &vtoc)) != 0) {\n\t\t(void) close(fd);\n\t\treturn (err);\n\t}\n\n\tif (vtoc->efi_flags & EFI_GPT_PRIMARY_CORRUPT) {\n\t\tefi_free(vtoc);\n\t\t(void) close(fd);\n\t\treturn (EIDRM);\n\t}\n\n\tefi_free(vtoc);\n\t(void) close(fd);\n\treturn (0);\n}\n\n \nstatic void\nzpool_label_name(char *label_name, int label_size)\n{\n\tuint64_t id = 0;\n\tint fd;\n\n\tfd = open(\"/dev/urandom\", O_RDONLY|O_CLOEXEC);\n\tif (fd >= 0) {\n\t\tif (read(fd, &id, sizeof (id)) != sizeof (id))\n\t\t\tid = 0;\n\n\t\tclose(fd);\n\t}\n\n\tif (id == 0)\n\t\tid = (((uint64_t)rand()) << 32) | (uint64_t)rand();\n\n\tsnprintf(label_name, label_size, \"zfs-%016llx\", (u_longlong_t)id);\n}\n\n \nint\nzpool_label_disk(libzfs_handle_t *hdl, zpool_handle_t *zhp, const char *name)\n{\n\tchar path[MAXPATHLEN];\n\tstruct dk_gpt *vtoc;\n\tint rval, fd;\n\tsize_t resv = EFI_MIN_RESV_SIZE;\n\tuint64_t slice_size;\n\tdiskaddr_t start_block;\n\tchar errbuf[ERRBUFLEN];\n\n\t \n\t(void) snprintf(errbuf, sizeof (errbuf),\n\t    dgettext(TEXT_DOMAIN, \"cannot label '%s'\"), name);\n\n\tif (zhp) {\n\t\tnvlist_t *nvroot = fnvlist_lookup_nvlist(zhp->zpool_config,\n\t\t    ZPOOL_CONFIG_VDEV_TREE);\n\n\t\tif (zhp->zpool_start_block == 0)\n\t\t\tstart_block = find_start_block(nvroot);\n\t\telse\n\t\t\tstart_block = zhp->zpool_start_block;\n\t\tzhp->zpool_start_block = start_block;\n\t} else {\n\t\t \n\t\tstart_block = NEW_START_BLOCK;\n\t}\n\n\t(void) snprintf(path, sizeof (path), \"%s/%s\", DISK_ROOT, name);\n\n\tif ((fd = open(path, O_RDWR|O_DIRECT|O_EXCL|O_CLOEXEC)) < 0) {\n\t\t \n\t\tzfs_error_aux(hdl, dgettext(TEXT_DOMAIN, \"cannot \"\n\t\t    \"label '%s': unable to open device: %d\"), path, errno);\n\t\treturn (zfs_error(hdl, EZFS_OPENFAILED, errbuf));\n\t}\n\n\tif (efi_alloc_and_init(fd, EFI_NUMPAR, &vtoc) != 0) {\n\t\t \n\t\tif (errno == ENOMEM)\n\t\t\t(void) no_memory(hdl);\n\n\t\t(void) close(fd);\n\t\tzfs_error_aux(hdl, dgettext(TEXT_DOMAIN, \"cannot \"\n\t\t    \"label '%s': unable to read disk capacity\"), path);\n\n\t\treturn (zfs_error(hdl, EZFS_NOCAP, errbuf));\n\t}\n\n\tslice_size = vtoc->efi_last_u_lba + 1;\n\tslice_size -= EFI_MIN_RESV_SIZE;\n\tif (start_block == MAXOFFSET_T)\n\t\tstart_block = NEW_START_BLOCK;\n\tslice_size -= start_block;\n\tslice_size = P2ALIGN(slice_size, PARTITION_END_ALIGNMENT);\n\n\tvtoc->efi_parts[0].p_start = start_block;\n\tvtoc->efi_parts[0].p_size = slice_size;\n\n\t \n\tvtoc->efi_parts[0].p_tag = V_USR;\n\tzpool_label_name(vtoc->efi_parts[0].p_name, EFI_PART_NAME_LEN);\n\n\tvtoc->efi_parts[8].p_start = slice_size + start_block;\n\tvtoc->efi_parts[8].p_size = resv;\n\tvtoc->efi_parts[8].p_tag = V_RESERVED;\n\n\trval = efi_write(fd, vtoc);\n\n\t \n\t(void) fsync(fd);\n\t(void) ioctl(fd, BLKFLSBUF);\n\n\tif (rval == 0)\n\t\trval = efi_rescan(fd);\n\n\t \n\tif (rval != 0) {\n\t\t(void) close(fd);\n\t\tefi_free(vtoc);\n\n\t\tzfs_error_aux(hdl, dgettext(TEXT_DOMAIN, \"try using \"\n\t\t    \"parted(8) and then provide a specific slice: %d\"), rval);\n\t\treturn (zfs_error(hdl, EZFS_LABELFAILED, errbuf));\n\t}\n\n\t(void) close(fd);\n\tefi_free(vtoc);\n\n\t(void) snprintf(path, sizeof (path), \"%s/%s\", DISK_ROOT, name);\n\t(void) zfs_append_partition(path, MAXPATHLEN);\n\n\t \n\trval = zpool_label_disk_wait(path, DISK_LABEL_WAIT);\n\tif (rval) {\n\t\tzfs_error_aux(hdl, dgettext(TEXT_DOMAIN, \"failed to \"\n\t\t    \"detect device partitions on '%s': %d\"), path, rval);\n\t\treturn (zfs_error(hdl, EZFS_LABELFAILED, errbuf));\n\t}\n\n\t \n\t(void) snprintf(path, sizeof (path), \"%s/%s\", DISK_ROOT, name);\n\trval = zpool_label_disk_check(path);\n\tif (rval) {\n\t\tzfs_error_aux(hdl, dgettext(TEXT_DOMAIN, \"freshly written \"\n\t\t    \"EFI label on '%s' is damaged.  Ensure\\nthis device \"\n\t\t    \"is not in use, and is functioning properly: %d\"),\n\t\t    path, rval);\n\t\treturn (zfs_error(hdl, EZFS_LABELFAILED, errbuf));\n\t}\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}