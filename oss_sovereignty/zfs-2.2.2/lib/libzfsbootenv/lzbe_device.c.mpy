{
  "module_name": "lzbe_device.c",
  "hash_id": "bc38fe71223e789e80ba4e1bd41f38130700f3e173fdc793c8bc87004b737281",
  "original_prompt": "Ingested from zfs-2.2.2/lib/libzfsbootenv/lzbe_device.c",
  "human_readable_source": " \n \n\n#include <sys/types.h>\n#include <string.h>\n#include <libzfs.h>\n#include <libzfsbootenv.h>\n#include <sys/zfs_bootenv.h>\n#include <sys/vdev_impl.h>\n\n \nint\nlzbe_set_boot_device(const char *pool, lzbe_flags_t flag, const char *device)\n{\n\tlibzfs_handle_t *hdl;\n\tzpool_handle_t *zphdl;\n\tnvlist_t *nv;\n\tchar *descriptor;\n\tuint64_t version;\n\tint rv = -1;\n\n\tif (pool == NULL || *pool == '\\0')\n\t\treturn (rv);\n\n\tif ((hdl = libzfs_init()) == NULL)\n\t\treturn (rv);\n\n\tzphdl = zpool_open(hdl, pool);\n\tif (zphdl == NULL) {\n\t\tlibzfs_fini(hdl);\n\t\treturn (rv);\n\t}\n\n\tswitch (flag) {\n\tcase lzbe_add:\n\t\trv = zpool_get_bootenv(zphdl, &nv);\n\t\tif (rv == 0) {\n\t\t\t \n\t\t\trv = nvlist_lookup_uint64(nv, BOOTENV_VERSION,\n\t\t\t    &version);\n\t\t\tif (rv == 0 && version == VB_NVLIST)\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\tfnvlist_free(nv);\n\t\t}\n\t\tzfs_fallthrough;\n\tcase lzbe_replace:\n\t\tnv = fnvlist_alloc();\n\t\tbreak;\n\tdefault:\n\t\treturn (rv);\n\t}\n\n\t \n\tfnvlist_add_uint64(nv, BOOTENV_VERSION, VB_NVLIST);\n\n\trv = 0;\n\t \n\tif ((device == NULL || *device == '\\0')) {\n\t\tif (nvlist_exists(nv, OS_BOOTONCE))\n\t\t\tfnvlist_remove(nv, OS_BOOTONCE);\n\t} else {\n\t\t \n\t\tif (strncmp(device, \"zfs:\", 4) == 0) {\n\t\t\tfnvlist_add_string(nv, OS_BOOTONCE, device);\n\t\t} else {\n\t\t\tif (asprintf(&descriptor, \"zfs:%s:\", device) > 0) {\n\t\t\t\tfnvlist_add_string(nv, OS_BOOTONCE, descriptor);\n\t\t\t\tfree(descriptor);\n\t\t\t} else\n\t\t\t\trv = ENOMEM;\n\t\t}\n\t}\n\tif (rv == 0)\n\t\trv = zpool_set_bootenv(zphdl, nv);\n\tif (rv != 0)\n\t\tfprintf(stderr, \"%s\\n\", libzfs_error_description(hdl));\n\n\tfnvlist_free(nv);\n\tzpool_close(zphdl);\n\tlibzfs_fini(hdl);\n\treturn (rv);\n}\n\n \nint\nlzbe_get_boot_device(const char *pool, char **device)\n{\n\tlibzfs_handle_t *hdl;\n\tzpool_handle_t *zphdl;\n\tnvlist_t *nv;\n\tconst char *val;\n\tint rv = -1;\n\n\tif (pool == NULL || *pool == '\\0' || device == NULL)\n\t\treturn (rv);\n\n\tif ((hdl = libzfs_init()) == NULL)\n\t\treturn (rv);\n\n\tzphdl = zpool_open(hdl, pool);\n\tif (zphdl == NULL) {\n\t\tlibzfs_fini(hdl);\n\t\treturn (rv);\n\t}\n\n\trv = zpool_get_bootenv(zphdl, &nv);\n\tif (rv == 0) {\n\t\trv = nvlist_lookup_string(nv, OS_BOOTONCE, &val);\n\t\tif (rv == 0) {\n\t\t\t \n\t\t\tif (strncmp(val, \"zfs:\", 4) == 0) {\n\t\t\t\tchar *tmp = strdup(val + 4);\n\t\t\t\tif (tmp != NULL) {\n\t\t\t\t\tsize_t len = strlen(tmp);\n\n\t\t\t\t\tif (tmp[len - 1] == ':')\n\t\t\t\t\t\ttmp[len - 1] = '\\0';\n\t\t\t\t\t*device = tmp;\n\t\t\t\t} else {\n\t\t\t\t\trv = ENOMEM;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\trv = EINVAL;\n\t\t\t}\n\t\t}\n\t\tnvlist_free(nv);\n\t}\n\n\tzpool_close(zphdl);\n\tlibzfs_fini(hdl);\n\treturn (rv);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}