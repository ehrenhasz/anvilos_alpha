{
  "module_name": "libnvpair_json.c",
  "hash_id": "2371ab2304af3d4c3bf8ef2b9622acdc8ddb856a605f37dad6aefe596e09266a",
  "original_prompt": "Ingested from zfs-2.2.2/lib/libnvpair/libnvpair_json.c",
  "human_readable_source": " \n \n\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <wchar.h>\n#include <sys/debug.h>\n\n#include \"libnvpair.h\"\n\n#define\tFPRINTF(fp, ...)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tif (fprintf(fp, __VA_ARGS__) < 0)\t\\\n\t\t\treturn (-1);\t\t\t\\\n\t} while (0)\n\n \nstatic int\nnvlist_print_json_string(FILE *fp, const char *input)\n{\n\tmbstate_t mbr = {0};\n\twchar_t c;\n\tsize_t sz;\n\n\tFPRINTF(fp, \"\\\"\");\n\twhile ((sz = mbrtowc(&c, input, MB_CUR_MAX, &mbr)) > 0) {\n\t\tif (sz == (size_t)-1 || sz == (size_t)-2) {\n\t\t\t \n\t\t\treturn (-1);\n\t\t}\n\t\tswitch (c) {\n\t\tcase '\"':\n\t\t\tFPRINTF(fp, \"\\\\\\\"\");\n\t\t\tbreak;\n\t\tcase '\\n':\n\t\t\tFPRINTF(fp, \"\\\\n\");\n\t\t\tbreak;\n\t\tcase '\\r':\n\t\t\tFPRINTF(fp, \"\\\\r\");\n\t\t\tbreak;\n\t\tcase '\\\\':\n\t\t\tFPRINTF(fp, \"\\\\\\\\\");\n\t\t\tbreak;\n\t\tcase '\\f':\n\t\t\tFPRINTF(fp, \"\\\\f\");\n\t\t\tbreak;\n\t\tcase '\\t':\n\t\t\tFPRINTF(fp, \"\\\\t\");\n\t\t\tbreak;\n\t\tcase '\\b':\n\t\t\tFPRINTF(fp, \"\\\\b\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tif ((c >= 0x00 && c <= 0x1f) ||\n\t\t\t    (c > 0x7f && c <= 0xffff)) {\n\t\t\t\t \n\t\t\t\tFPRINTF(fp, \"\\\\u%04x\", (int)(0xffff & c));\n\t\t\t} else if (c >= 0x20 && c <= 0x7f) {\n\t\t\t\t \n\t\t\t\tFPRINTF(fp, \"%c\", (int)(0xff & c));\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tinput += sz;\n\t}\n\n\tFPRINTF(fp, \"\\\"\");\n\treturn (0);\n}\n\n \nint\nnvlist_print_json(FILE *fp, nvlist_t *nvl)\n{\n\tnvpair_t *curr;\n\tboolean_t first = B_TRUE;\n\n\tFPRINTF(fp, \"{\");\n\n\tfor (curr = nvlist_next_nvpair(nvl, NULL); curr;\n\t    curr = nvlist_next_nvpair(nvl, curr)) {\n\t\tdata_type_t type = nvpair_type(curr);\n\n\t\tif (!first)\n\t\t\tFPRINTF(fp, \",\");\n\t\telse\n\t\t\tfirst = B_FALSE;\n\n\t\tif (nvlist_print_json_string(fp, nvpair_name(curr)) == -1)\n\t\t\treturn (-1);\n\t\tFPRINTF(fp, \":\");\n\n\t\tswitch (type) {\n\t\tcase DATA_TYPE_STRING: {\n\t\t\tconst char *string = fnvpair_value_string(curr);\n\t\t\tif (nvlist_print_json_string(fp, string) == -1)\n\t\t\t\treturn (-1);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_BOOLEAN: {\n\t\t\tFPRINTF(fp, \"true\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_BOOLEAN_VALUE: {\n\t\t\tFPRINTF(fp, \"%s\", fnvpair_value_boolean_value(curr) ==\n\t\t\t    B_TRUE ? \"true\" : \"false\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_BYTE: {\n\t\t\tFPRINTF(fp, \"%hhu\", fnvpair_value_byte(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_INT8: {\n\t\t\tFPRINTF(fp, \"%hhd\", fnvpair_value_int8(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UINT8: {\n\t\t\tFPRINTF(fp, \"%hhu\", fnvpair_value_uint8(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_INT16: {\n\t\t\tFPRINTF(fp, \"%hd\", fnvpair_value_int16(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UINT16: {\n\t\t\tFPRINTF(fp, \"%hu\", fnvpair_value_uint16(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_INT32: {\n\t\t\tFPRINTF(fp, \"%d\", fnvpair_value_int32(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UINT32: {\n\t\t\tFPRINTF(fp, \"%u\", fnvpair_value_uint32(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_INT64: {\n\t\t\tFPRINTF(fp, \"%lld\",\n\t\t\t    (long long)fnvpair_value_int64(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UINT64: {\n\t\t\tFPRINTF(fp, \"%llu\",\n\t\t\t    (unsigned long long)fnvpair_value_uint64(curr));\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_HRTIME: {\n\t\t\thrtime_t val;\n\t\t\tVERIFY0(nvpair_value_hrtime(curr, &val));\n\t\t\tFPRINTF(fp, \"%llu\", (unsigned long long)val);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_DOUBLE: {\n\t\t\tdouble val;\n\t\t\tVERIFY0(nvpair_value_double(curr, &val));\n\t\t\tFPRINTF(fp, \"%f\", val);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_NVLIST: {\n\t\t\tif (nvlist_print_json(fp,\n\t\t\t    fnvpair_value_nvlist(curr)) == -1)\n\t\t\t\treturn (-1);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_STRING_ARRAY: {\n\t\t\tconst char **val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_string_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tif (nvlist_print_json_string(fp, val[i]) == -1)\n\t\t\t\t\treturn (-1);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_NVLIST_ARRAY: {\n\t\t\tnvlist_t **val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_nvlist_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tif (nvlist_print_json(fp, val[i]) == -1)\n\t\t\t\t\treturn (-1);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_BOOLEAN_ARRAY: {\n\t\t\tboolean_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_boolean_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, val[i] == B_TRUE ?\n\t\t\t\t    \"true\" : \"false\");\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_BYTE_ARRAY: {\n\t\t\tuchar_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_byte_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%hhu\", val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UINT8_ARRAY: {\n\t\t\tuint8_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_uint8_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%hhu\", val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_INT8_ARRAY: {\n\t\t\tint8_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_int8_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%hhd\", val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UINT16_ARRAY: {\n\t\t\tuint16_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_uint16_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%hu\", val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_INT16_ARRAY: {\n\t\t\tint16_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_int16_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%hd\", val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UINT32_ARRAY: {\n\t\t\tuint32_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_uint32_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%u\", val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_INT32_ARRAY: {\n\t\t\tint32_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_int32_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%d\", val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UINT64_ARRAY: {\n\t\t\tuint64_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_uint64_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%llu\",\n\t\t\t\t    (unsigned long long)val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_INT64_ARRAY: {\n\t\t\tint64_t *val;\n\t\t\tuint_t valsz, i;\n\t\t\tVERIFY0(nvpair_value_int64_array(curr, &val, &valsz));\n\t\t\tFPRINTF(fp, \"[\");\n\t\t\tfor (i = 0; i < valsz; i++) {\n\t\t\t\tif (i > 0)\n\t\t\t\t\tFPRINTF(fp, \",\");\n\t\t\t\tFPRINTF(fp, \"%lld\", (long long)val[i]);\n\t\t\t}\n\t\t\tFPRINTF(fp, \"]\");\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DATA_TYPE_UNKNOWN:\n\t\tcase DATA_TYPE_DONTCARE:\n\t\t\treturn (-1);\n\t\t}\n\n\t}\n\n\tFPRINTF(fp, \"}\");\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}