{
  "module_name": "libzfs_core_ioctl.c",
  "hash_id": "51edb82f97507fc14d9a94f2a589aa910ae1851e383beb15d86449f4918389a2",
  "original_prompt": "Ingested from zfs-2.2.2/lib/libzfs_core/os/freebsd/libzfs_core_ioctl.c",
  "human_readable_source": " \n#include <sys/types.h>\n#include <sys/param.h>\n#include <sys/sysctl.h>\n#include <sys/zfs_ioctl.h>\n#include <os/freebsd/zfs/sys/zfs_ioctl_compat.h>\n#include <err.h>\n#include <libzfs_core.h>\n\nint zfs_ioctl_version = ZFS_IOCVER_UNDEF;\n\n \nstatic int\nget_zfs_ioctl_version(void)\n{\n\tsize_t ver_size;\n\tint ver = ZFS_IOCVER_NONE;\n\n\tver_size = sizeof (ver);\n\t(void) sysctlbyname(\"vfs.zfs.version.ioctl\", &ver, &ver_size, NULL, 0);\n\n\treturn (ver);\n}\n\nstatic int\nzcmd_ioctl_compat(int fd, int request, zfs_cmd_t *zc, const int cflag)\n{\n\tint ret;\n#ifdef ZFS_LEGACY_SUPPORT\n\tint newrequest;\n\tvoid *zc_c = NULL;\n#endif\n\tunsigned long ncmd;\n\tzfs_iocparm_t zp;\n\n\tswitch (cflag) {\n\tcase ZFS_CMD_COMPAT_NONE:\n\t\tncmd = _IOWR('Z', request, zfs_iocparm_t);\n\t\tzp.zfs_cmd = (uint64_t)(uintptr_t)zc;\n\t\tzp.zfs_cmd_size = sizeof (zfs_cmd_t);\n\t\tzp.zfs_ioctl_version = ZFS_IOCVER_OZFS;\n\t\tbreak;\n#ifdef ZFS_LEGACY_SUPPORT\n\tcase ZFS_CMD_COMPAT_LEGACY:\n\t\tnewrequest = zfs_ioctl_ozfs_to_legacy(request);\n\t\tncmd = _IOWR('Z', newrequest, zfs_iocparm_t);\n\t\tzc_c = malloc(sizeof (zfs_cmd_legacy_t));\n\t\tzfs_cmd_ozfs_to_legacy(zc, zc_c);\n\t\tzp.zfs_cmd = (uint64_t)(uintptr_t)zc_c;\n\t\tzp.zfs_cmd_size = sizeof (zfs_cmd_legacy_t);\n\t\tzp.zfs_ioctl_version = ZFS_IOCVER_LEGACY;\n\t\tbreak;\n#endif\n\tdefault:\n\t\tabort();\n\t\treturn (EINVAL);\n\t}\n\n\tret = ioctl(fd, ncmd, &zp);\n\tif (ret) {\n#ifdef ZFS_LEGACY_SUPPORT\n\t\tif (zc_c)\n\t\t\tfree(zc_c);\n#endif\n\t\treturn (ret);\n\t}\n#ifdef ZFS_LEGACY_SUPPORT\n\tif (zc_c) {\n\t\tzfs_cmd_legacy_to_ozfs(zc_c, zc);\n\t\tfree(zc_c);\n\t}\n#endif\n\treturn (ret);\n}\n\n \nint\nlzc_ioctl_fd(int fd, unsigned long request, zfs_cmd_t *zc)\n{\n\tsize_t oldsize;\n\tint ret, cflag = ZFS_CMD_COMPAT_NONE;\n\n\tif (zfs_ioctl_version == ZFS_IOCVER_UNDEF)\n\t\tzfs_ioctl_version = get_zfs_ioctl_version();\n\n\tswitch (zfs_ioctl_version) {\n#ifdef ZFS_LEGACY_SUPPORT\n\t\tcase ZFS_IOCVER_LEGACY:\n\t\t\tcflag = ZFS_CMD_COMPAT_LEGACY;\n\t\t\tbreak;\n#endif\n\t\tcase ZFS_IOCVER_OZFS:\n\t\t\tcflag = ZFS_CMD_COMPAT_NONE;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\terrx(1, \"unrecognized zfs ioctl version %d\",\n\t\t\t    zfs_ioctl_version);\n\t}\n\n\toldsize = zc->zc_nvlist_dst_size;\n\tret = zcmd_ioctl_compat(fd, request, zc, cflag);\n\n\tif (ret == 0 && oldsize < zc->zc_nvlist_dst_size) {\n\t\tret = -1;\n\t\terrno = ENOMEM;\n\t}\n\n\treturn (ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}