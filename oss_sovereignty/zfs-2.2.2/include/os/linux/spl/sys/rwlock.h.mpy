{
  "module_name": "rwlock.h",
  "hash_id": "e0459324cfc046522a2938d3125de659712b346fc0787ef695f757c1cbee61e3",
  "original_prompt": "Ingested from zfs-2.2.2/include/os/linux/spl/sys/rwlock.h",
  "human_readable_source": " \n\n#ifndef _SPL_RWLOCK_H\n#define\t_SPL_RWLOCK_H\n\n#include <sys/types.h>\n#include <linux/rwsem.h>\n#include <linux/sched.h>\n\ntypedef enum {\n\tRW_DRIVER\t= 2,\n\tRW_DEFAULT\t= 4,\n\tRW_NOLOCKDEP\t= 5\n} krw_type_t;\n\ntypedef enum {\n\tRW_NONE\t\t= 0,\n\tRW_WRITER\t= 1,\n\tRW_READER\t= 2\n} krw_t;\n\ntypedef struct {\n\tstruct rw_semaphore rw_rwlock;\n\tkthread_t *rw_owner;\n#ifdef CONFIG_LOCKDEP\n\tkrw_type_t\trw_type;\n#endif  \n} krwlock_t;\n\n#define\tSEM(rwp)\t(&(rwp)->rw_rwlock)\n\nstatic inline void\nspl_rw_set_owner(krwlock_t *rwp)\n{\n\trwp->rw_owner = current;\n}\n\nstatic inline void\nspl_rw_clear_owner(krwlock_t *rwp)\n{\n\trwp->rw_owner = NULL;\n}\n\nstatic inline kthread_t *\nrw_owner(krwlock_t *rwp)\n{\n\treturn (rwp->rw_owner);\n}\n\n#ifdef CONFIG_LOCKDEP\nstatic inline void\nspl_rw_set_type(krwlock_t *rwp, krw_type_t type)\n{\n\trwp->rw_type = type;\n}\nstatic inline void\nspl_rw_lockdep_off_maybe(krwlock_t *rwp)\t\t\\\n{\t\t\t\t\t\t\t\\\n\tif (rwp && rwp->rw_type == RW_NOLOCKDEP)\t\\\n\t\tlockdep_off();\t\t\t\t\\\n}\nstatic inline void\nspl_rw_lockdep_on_maybe(krwlock_t *rwp)\t\t\t\\\n{\t\t\t\t\t\t\t\\\n\tif (rwp && rwp->rw_type == RW_NOLOCKDEP)\t\\\n\t\tlockdep_on();\t\t\t\t\\\n}\n#else   \n#define\tspl_rw_set_type(rwp, type)\n#define\tspl_rw_lockdep_off_maybe(rwp)\n#define\tspl_rw_lockdep_on_maybe(rwp)\n#endif  \n\nstatic inline int\nRW_LOCK_HELD(krwlock_t *rwp)\n{\n\treturn (rwsem_is_locked(SEM(rwp)));\n}\n\nstatic inline int\nRW_WRITE_HELD(krwlock_t *rwp)\n{\n\treturn (rw_owner(rwp) == current);\n}\n\nstatic inline int\nRW_READ_HELD(krwlock_t *rwp)\n{\n\treturn (RW_LOCK_HELD(rwp) && rw_owner(rwp) == NULL);\n}\n\n \n#define\trw_init(rwp, name, type, arg)  \t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tstatic struct lock_class_key __key;\t\t\t\t\\\n\tASSERT(type == RW_DEFAULT || type == RW_NOLOCKDEP);\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t__init_rwsem(SEM(rwp), #rwp, &__key);\t\t\t\t\\\n\tspl_rw_clear_owner(rwp);\t\t\t\t\t\\\n\tspl_rw_set_type(rwp, type);\t\t\t\t\t\\\n})\n\n \n#define\trw_destroy(rwp)\t\t((void) 0)\n\n \n#define\trw_tryupgrade(rwp)\tRW_WRITE_HELD(rwp)\n\n#define\trw_tryenter(rwp, rw)  \t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tint _rc_ = 0;\t\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tspl_rw_lockdep_off_maybe(rwp);\t\t\t\t\t\\\n\tswitch (rw) {\t\t\t\t\t\t\t\\\n\tcase RW_READER:\t\t\t\t\t\t\t\\\n\t\t_rc_ = down_read_trylock(SEM(rwp));\t\t\t\\\n\t\tbreak;\t\t\t\t\t\t\t\\\n\tcase RW_WRITER:\t\t\t\t\t\t\t\\\n\t\tif ((_rc_ = down_write_trylock(SEM(rwp))))\t\t\\\n\t\t\tspl_rw_set_owner(rwp);\t\t\t\t\\\n\t\tbreak;\t\t\t\t\t\t\t\\\n\tdefault:\t\t\t\t\t\t\t\\\n\t\tVERIFY(0);\t\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n\tspl_rw_lockdep_on_maybe(rwp);\t\t\t\t\t\\\n\t_rc_;\t\t\t\t\t\t\t\t\\\n})\n\n#define\trw_enter(rwp, rw)  \t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tspl_rw_lockdep_off_maybe(rwp);\t\t\t\t\t\\\n\tswitch (rw) {\t\t\t\t\t\t\t\\\n\tcase RW_READER:\t\t\t\t\t\t\t\\\n\t\tdown_read(SEM(rwp));\t\t\t\t\t\\\n\t\tbreak;\t\t\t\t\t\t\t\\\n\tcase RW_WRITER:\t\t\t\t\t\t\t\\\n\t\tdown_write(SEM(rwp));\t\t\t\t\t\\\n\t\tspl_rw_set_owner(rwp);\t\t\t\t\t\\\n\t\tbreak;\t\t\t\t\t\t\t\\\n\tdefault:\t\t\t\t\t\t\t\\\n\t\tVERIFY(0);\t\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n\tspl_rw_lockdep_on_maybe(rwp);\t\t\t\t\t\\\n})\n\n#define\trw_exit(rwp)  \t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tspl_rw_lockdep_off_maybe(rwp);\t\t\t\t\t\\\n\tif (RW_WRITE_HELD(rwp)) {\t\t\t\t\t\\\n\t\tspl_rw_clear_owner(rwp);\t\t\t\t\\\n\t\tup_write(SEM(rwp));\t\t\t\t\t\\\n\t} else {\t\t\t\t\t\t\t\\\n\t\tASSERT(RW_READ_HELD(rwp));\t\t\t\t\\\n\t\tup_read(SEM(rwp));\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n\tspl_rw_lockdep_on_maybe(rwp);\t\t\t\t\t\\\n})\n\n#define\trw_downgrade(rwp)  \t\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tspl_rw_lockdep_off_maybe(rwp);\t\t\t\t\t\\\n\tspl_rw_clear_owner(rwp);\t\t\t\t\t\\\n\tdowngrade_write(SEM(rwp));\t\t\t\t\t\\\n\tspl_rw_lockdep_on_maybe(rwp);\t\t\t\t\t\\\n})\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}