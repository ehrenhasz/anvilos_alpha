{
  "module_name": "dsl_dataset.h",
  "hash_id": "76b5b07818e1444dc8ec5ec071ec4e838c15e7982311436ecb198e9293516b4c",
  "original_prompt": "Ingested from zfs-2.2.2/include/sys/dsl_dataset.h",
  "human_readable_source": " \n \n\n#ifndef\t_SYS_DSL_DATASET_H\n#define\t_SYS_DSL_DATASET_H\n\n#include <sys/dmu.h>\n#include <sys/spa.h>\n#include <sys/txg.h>\n#include <sys/zio.h>\n#include <sys/bplist.h>\n#include <sys/dsl_synctask.h>\n#include <sys/zfs_context.h>\n#include <sys/dsl_deadlist.h>\n#include <sys/zfs_refcount.h>\n#include <sys/rrwlock.h>\n#include <sys/dsl_crypt.h>\n#include <zfeature_common.h>\n\n#ifdef\t__cplusplus\nextern \"C\" {\n#endif\n\nstruct dsl_dataset;\nstruct dsl_dir;\nstruct dsl_pool;\nstruct dsl_crypto_params;\nstruct dsl_key_mapping;\nstruct zfs_bookmark_phys;\n\n#define\tDS_FLAG_INCONSISTENT\t(1ULL<<0)\n#define\tDS_IS_INCONSISTENT(ds)\t\\\n\t(dsl_dataset_phys(ds)->ds_flags & DS_FLAG_INCONSISTENT)\n\n \n#define\tDS_FLAG_NOPROMOTE\t(1ULL<<1)\n\n \n#define\tDS_FLAG_UNIQUE_ACCURATE\t(1ULL<<2)\n\n \n#define\tDS_FLAG_DEFER_DESTROY\t(1ULL<<3)\n#define\tDS_IS_DEFER_DESTROY(ds)\t\\\n\t(dsl_dataset_phys(ds)->ds_flags & DS_FLAG_DEFER_DESTROY)\n\n \n\n \n#define\tDS_FIELD_BOOKMARK_NAMES \"com.delphix:bookmarks\"\n\n \n#define\tDS_FIELD_LARGE_DNODE \"org.zfsonlinux:large_dnode\"\n\n \n#define\tDS_FIELD_RESUME_FROMGUID \"com.delphix:resume_fromguid\"\n#define\tDS_FIELD_RESUME_TONAME \"com.delphix:resume_toname\"\n#define\tDS_FIELD_RESUME_TOGUID \"com.delphix:resume_toguid\"\n#define\tDS_FIELD_RESUME_OBJECT \"com.delphix:resume_object\"\n#define\tDS_FIELD_RESUME_OFFSET \"com.delphix:resume_offset\"\n#define\tDS_FIELD_RESUME_BYTES \"com.delphix:resume_bytes\"\n#define\tDS_FIELD_RESUME_LARGEBLOCK \"com.delphix:resume_largeblockok\"\n#define\tDS_FIELD_RESUME_EMBEDOK \"com.delphix:resume_embedok\"\n#define\tDS_FIELD_RESUME_COMPRESSOK \"com.delphix:resume_compressok\"\n#define\tDS_FIELD_RESUME_RAWOK \"com.datto:resume_rawok\"\n\n \n#define\tDS_FIELD_REMAP_DEADLIST\t\"com.delphix:remap_deadlist\"\n\n \n#define\tDS_FIELD_RESUME_REDACT_BOOKMARK_SNAPS \\\n\t\"com.delphix:resume_redact_book_snaps\"\n\n \n#define\tDS_FIELD_IVSET_GUID\t\"com.datto:ivset_guid\"\n\n \n#define\tDS_FLAG_CI_DATASET\t(1ULL<<16)\n\n#define\tDS_CREATE_FLAG_NODIRTY\t(1ULL<<24)\n\ntypedef struct dsl_dataset_phys {\n\tuint64_t ds_dir_obj;\t\t \n\tuint64_t ds_prev_snap_obj;\t \n\tuint64_t ds_prev_snap_txg;\n\tuint64_t ds_next_snap_obj;\t \n\tuint64_t ds_snapnames_zapobj;\t \n\tuint64_t ds_num_children;\t \n\tuint64_t ds_creation_time;\t \n\tuint64_t ds_creation_txg;\n\tuint64_t ds_deadlist_obj;\t \n\t \n\tuint64_t ds_referenced_bytes;\n\tuint64_t ds_compressed_bytes;\n\tuint64_t ds_uncompressed_bytes;\n\tuint64_t ds_unique_bytes;\t \n\t \n\tuint64_t ds_fsid_guid;\n\tuint64_t ds_guid;\n\tuint64_t ds_flags;\t\t \n\tblkptr_t ds_bp;\n\tuint64_t ds_next_clones_obj;\t \n\tuint64_t ds_props_obj;\t\t \n\tuint64_t ds_userrefs_obj;\t \n\tuint64_t ds_pad[5];  \n} dsl_dataset_phys_t;\n\ntypedef struct dsl_dataset {\n\tdmu_buf_user_t ds_dbu;\n\trrwlock_t ds_bp_rwlock;  \n\n\t \n\tstruct dsl_dir *ds_dir;\n\tdmu_buf_t *ds_dbuf;\n\tuint64_t ds_object;\n\tuint64_t ds_fsid_guid;\n\tboolean_t ds_is_snapshot;\n\tstruct dsl_key_mapping *ds_key_mapping;\n\n\t \n\tstruct dsl_dataset *ds_prev;\n\tuint64_t ds_bookmarks_obj;   \n\tavl_tree_t ds_bookmarks;  \n\n\t \n\tdsl_deadlist_t ds_deadlist;\n\tbplist_t ds_pending_deadlist;\n\n\t \n\tdsl_deadlist_t ds_remap_deadlist;\n\t \n\tkmutex_t ds_remap_deadlist_lock;\n\n\t \n\ttxg_node_t ds_dirty_link;\n\tlist_node_t ds_synced_link;\n\n\t \n\tkmutex_t ds_lock;\n\tobjset_t *ds_objset;\n\tuint64_t ds_userrefs;\n\tconst void *ds_owner;\n\n\t \n\tzfs_refcount_t ds_longholds;\n\n\t \n\tuint64_t ds_trysnap_txg;\n\n\t \n\tkmutex_t ds_opening_lock;\n\n\tuint64_t ds_reserved;\t \n\tuint64_t ds_quota;\t \n\n\tkmutex_t ds_sendstream_lock;\n\tlist_t ds_sendstreams;\n\n\t \n\tuint64_t ds_resume_object[TXG_SIZE];\n\tuint64_t ds_resume_offset[TXG_SIZE];\n\tuint64_t ds_resume_bytes[TXG_SIZE];\n\n\t \n\tlist_t ds_prop_cbs;\n\n\t \n\tvoid *ds_feature[SPA_FEATURES];\n\n\t \n\tvoid *ds_feature_activation[SPA_FEATURES];\n\n\t \n\tchar ds_snapname[ZFS_MAX_DATASET_NAME_LEN];\n} dsl_dataset_t;\n\nstatic inline dsl_dataset_phys_t *\ndsl_dataset_phys(dsl_dataset_t *ds)\n{\n\treturn ((dsl_dataset_phys_t *)ds->ds_dbuf->db_data);\n}\n\ntypedef struct dsl_dataset_promote_arg {\n\tconst char *ddpa_clonename;\n\tdsl_dataset_t *ddpa_clone;\n\tlist_t shared_snaps, origin_snaps, clone_snaps;\n\tdsl_dataset_t *origin_origin;  \n\tuint64_t used, comp, uncomp, unique, cloneusedsnap, originusedsnap;\n\tnvlist_t *err_ds;\n\tcred_t *cr;\n\tproc_t *proc;\n} dsl_dataset_promote_arg_t;\n\ntypedef struct dsl_dataset_rollback_arg {\n\tconst char *ddra_fsname;\n\tconst char *ddra_tosnap;\n\tvoid *ddra_owner;\n\tnvlist_t *ddra_result;\n} dsl_dataset_rollback_arg_t;\n\ntypedef struct dsl_dataset_snapshot_arg {\n\tnvlist_t *ddsa_snaps;\n\tnvlist_t *ddsa_props;\n\tnvlist_t *ddsa_errors;\n\tcred_t *ddsa_cr;\n\tproc_t *ddsa_proc;\n} dsl_dataset_snapshot_arg_t;\n\ntypedef struct dsl_dataset_rename_snapshot_arg {\n\tconst char *ddrsa_fsname;\n\tconst char *ddrsa_oldsnapname;\n\tconst char *ddrsa_newsnapname;\n\tboolean_t ddrsa_recursive;\n\tdmu_tx_t *ddrsa_tx;\n} dsl_dataset_rename_snapshot_arg_t;\n\n \n#define\tMAX_TAG_PREFIX_LEN\t17\n\n#define\tdsl_dataset_is_snapshot(ds) \\\n\t(dsl_dataset_phys(ds)->ds_num_children != 0)\n\n#define\tDS_UNIQUE_IS_ACCURATE(ds)\t\\\n\t((dsl_dataset_phys(ds)->ds_flags & DS_FLAG_UNIQUE_ACCURATE) != 0)\n\n \ntypedef enum ds_hold_flags {\n\tDS_HOLD_FLAG_NONE\t= 0 << 0,\n\tDS_HOLD_FLAG_DECRYPT\t= 1 << 0  \n} ds_hold_flags_t;\n\nint dsl_dataset_hold(struct dsl_pool *dp, const char *name, const void *tag,\n    dsl_dataset_t **dsp);\nint dsl_dataset_hold_flags(struct dsl_pool *dp, const char *name,\n    ds_hold_flags_t flags, const void *tag, dsl_dataset_t **dsp);\nboolean_t dsl_dataset_try_add_ref(struct dsl_pool *dp, dsl_dataset_t *ds,\n    const void *tag);\nint dsl_dataset_create_key_mapping(dsl_dataset_t *ds);\nint dsl_dataset_hold_obj_flags(struct dsl_pool *dp, uint64_t dsobj,\n    ds_hold_flags_t flags, const void *tag, dsl_dataset_t **);\nvoid dsl_dataset_remove_key_mapping(dsl_dataset_t *ds);\nint dsl_dataset_hold_obj(struct dsl_pool *dp, uint64_t dsobj,\n    const void *tag, dsl_dataset_t **);\nvoid dsl_dataset_rele_flags(dsl_dataset_t *ds, ds_hold_flags_t flags,\n    const void *tag);\nvoid dsl_dataset_rele(dsl_dataset_t *ds, const void *tag);\nint dsl_dataset_own(struct dsl_pool *dp, const char *name,\n    ds_hold_flags_t flags, const void *tag, dsl_dataset_t **dsp);\nint dsl_dataset_own_force(struct dsl_pool *dp, const char *name,\n    ds_hold_flags_t flags, const void *tag, dsl_dataset_t **dsp);\nint dsl_dataset_own_obj(struct dsl_pool *dp, uint64_t dsobj,\n    ds_hold_flags_t flags, const void *tag, dsl_dataset_t **dsp);\nint dsl_dataset_own_obj_force(struct dsl_pool *dp, uint64_t dsobj,\n    ds_hold_flags_t flags, const void *tag, dsl_dataset_t **dsp);\nvoid dsl_dataset_disown(dsl_dataset_t *ds, ds_hold_flags_t flags,\n    const void *tag);\nvoid dsl_dataset_name(dsl_dataset_t *ds, char *name);\nboolean_t dsl_dataset_tryown(dsl_dataset_t *ds, const void *tag,\n    boolean_t override);\nint dsl_dataset_namelen(dsl_dataset_t *ds);\nboolean_t dsl_dataset_has_owner(dsl_dataset_t *ds);\nuint64_t dsl_dataset_create_sync(dsl_dir_t *pds, const char *lastname,\n    dsl_dataset_t *origin, uint64_t flags, cred_t *,\n    struct dsl_crypto_params *, dmu_tx_t *);\nuint64_t dsl_dataset_create_sync_dd(dsl_dir_t *dd, dsl_dataset_t *origin,\n    struct dsl_crypto_params *dcp, uint64_t flags, dmu_tx_t *tx);\nvoid dsl_dataset_snapshot_sync(void *arg, dmu_tx_t *tx);\nint dsl_dataset_snapshot_check(void *arg, dmu_tx_t *tx);\nint dsl_dataset_snapshot(nvlist_t *snaps, nvlist_t *props, nvlist_t *errors);\nvoid dsl_dataset_promote_sync(void *arg, dmu_tx_t *tx);\nint dsl_dataset_promote_check(void *arg, dmu_tx_t *tx);\nint dsl_dataset_promote(const char *name, char *conflsnap);\nint dsl_dataset_rename_snapshot(const char *fsname,\n    const char *oldsnapname, const char *newsnapname, boolean_t recursive);\nint dsl_dataset_snapshot_tmp(const char *fsname, const char *snapname,\n    minor_t cleanup_minor, const char *htag);\n\nblkptr_t *dsl_dataset_get_blkptr(dsl_dataset_t *ds);\n\nspa_t *dsl_dataset_get_spa(dsl_dataset_t *ds);\n\nboolean_t dsl_dataset_modified_since_snap(dsl_dataset_t *ds,\n    dsl_dataset_t *snap);\n\nvoid dsl_dataset_sync(dsl_dataset_t *ds, zio_t *zio, dmu_tx_t *tx);\nvoid dsl_dataset_sync_done(dsl_dataset_t *ds, dmu_tx_t *tx);\n\nvoid dsl_dataset_block_born(dsl_dataset_t *ds, const blkptr_t *bp,\n    dmu_tx_t *tx);\nint dsl_dataset_block_kill(dsl_dataset_t *ds, const blkptr_t *bp,\n    dmu_tx_t *tx, boolean_t async);\nvoid dsl_dataset_block_remapped(dsl_dataset_t *ds, uint64_t vdev,\n    uint64_t offset, uint64_t size, uint64_t birth, dmu_tx_t *tx);\nint dsl_dataset_snap_lookup(dsl_dataset_t *ds, const char *name,\n    uint64_t *value);\n\nvoid dsl_dataset_dirty(dsl_dataset_t *ds, dmu_tx_t *tx);\n\nint get_clones_stat_impl(dsl_dataset_t *ds, nvlist_t *val);\nchar *get_receive_resume_token(dsl_dataset_t *ds);\nuint64_t dsl_get_refratio(dsl_dataset_t *ds);\nuint64_t dsl_get_logicalreferenced(dsl_dataset_t *ds);\nuint64_t dsl_get_compressratio(dsl_dataset_t *ds);\nuint64_t dsl_get_used(dsl_dataset_t *ds);\nuint64_t dsl_get_creation(dsl_dataset_t *ds);\nuint64_t dsl_get_creationtxg(dsl_dataset_t *ds);\nuint64_t dsl_get_refquota(dsl_dataset_t *ds);\nuint64_t dsl_get_refreservation(dsl_dataset_t *ds);\nuint64_t dsl_get_guid(dsl_dataset_t *ds);\nuint64_t dsl_get_unique(dsl_dataset_t *ds);\nuint64_t dsl_get_objsetid(dsl_dataset_t *ds);\nuint64_t dsl_get_userrefs(dsl_dataset_t *ds);\nuint64_t dsl_get_defer_destroy(dsl_dataset_t *ds);\nuint64_t dsl_get_referenced(dsl_dataset_t *ds);\nuint64_t dsl_get_numclones(dsl_dataset_t *ds);\nuint64_t dsl_get_inconsistent(dsl_dataset_t *ds);\nuint64_t dsl_get_redacted(dsl_dataset_t *ds);\nuint64_t dsl_get_available(dsl_dataset_t *ds);\nint dsl_get_written(dsl_dataset_t *ds, uint64_t *written);\nint dsl_get_prev_snap(dsl_dataset_t *ds, char *snap);\nvoid dsl_get_redact_snaps(dsl_dataset_t *ds, nvlist_t *propval);\nint dsl_get_mountpoint(dsl_dataset_t *ds, const char *dsname, char *value,\n    char *source);\n\nvoid get_clones_stat(dsl_dataset_t *ds, nvlist_t *nv);\nvoid dsl_dataset_stats(dsl_dataset_t *os, nvlist_t *nv);\n\nvoid dsl_dataset_fast_stat(dsl_dataset_t *ds, dmu_objset_stats_t *stat);\nvoid dsl_dataset_space(dsl_dataset_t *ds,\n    uint64_t *refdbytesp, uint64_t *availbytesp,\n    uint64_t *usedobjsp, uint64_t *availobjsp);\nuint64_t dsl_dataset_fsid_guid(dsl_dataset_t *ds);\nint dsl_dataset_space_written(dsl_dataset_t *oldsnap, dsl_dataset_t *newds,\n    uint64_t *usedp, uint64_t *compp, uint64_t *uncompp);\nint dsl_dataset_space_written_bookmark(struct zfs_bookmark_phys *bmp,\n    dsl_dataset_t *newds, uint64_t *usedp, uint64_t *compp, uint64_t *uncompp);\nint dsl_dataset_space_wouldfree(dsl_dataset_t *firstsnap, dsl_dataset_t *last,\n    uint64_t *usedp, uint64_t *compp, uint64_t *uncompp);\n\nint dsl_dsobj_to_dsname(char *pname, uint64_t obj, char *buf);\n\nint dsl_dataset_check_quota(dsl_dataset_t *ds, boolean_t check_quota,\n    uint64_t asize, uint64_t inflight, uint64_t *used,\n    uint64_t *ref_rsrv);\nint dsl_dataset_set_refquota(const char *dsname, zprop_source_t source,\n    uint64_t quota);\nint dsl_dataset_set_refreservation(const char *dsname, zprop_source_t source,\n    uint64_t reservation);\nint dsl_dataset_set_compression(const char *dsname, zprop_source_t source,\n    uint64_t compression);\n\nboolean_t dsl_dataset_is_before(dsl_dataset_t *later, dsl_dataset_t *earlier,\n    uint64_t earlier_txg);\nvoid dsl_dataset_long_hold(dsl_dataset_t *ds, const void *tag);\nvoid dsl_dataset_long_rele(dsl_dataset_t *ds, const void *tag);\nboolean_t dsl_dataset_long_held(dsl_dataset_t *ds);\n\nint dsl_dataset_clone_swap_check_impl(dsl_dataset_t *clone,\n    dsl_dataset_t *origin_head, boolean_t force, void *owner, dmu_tx_t *tx);\nvoid dsl_dataset_clone_swap_sync_impl(dsl_dataset_t *clone,\n    dsl_dataset_t *origin_head, dmu_tx_t *tx);\nint dsl_dataset_snapshot_check_impl(dsl_dataset_t *ds, const char *snapname,\n    dmu_tx_t *tx, boolean_t recv, uint64_t cnt, cred_t *cr, proc_t *proc);\nvoid dsl_dataset_snapshot_sync_impl(dsl_dataset_t *ds, const char *snapname,\n    dmu_tx_t *tx);\n\nvoid dsl_dataset_remove_from_next_clones(dsl_dataset_t *ds, uint64_t obj,\n    dmu_tx_t *tx);\nvoid dsl_dataset_recalc_head_uniq(dsl_dataset_t *ds);\nint dsl_dataset_get_snapname(dsl_dataset_t *ds);\nint dsl_dataset_snap_lookup(dsl_dataset_t *ds, const char *name,\n    uint64_t *value);\nint dsl_dataset_snap_remove(dsl_dataset_t *ds, const char *name, dmu_tx_t *tx,\n    boolean_t adj_cnt);\nvoid dsl_dataset_set_refreservation_sync_impl(dsl_dataset_t *ds,\n    zprop_source_t source, uint64_t value, dmu_tx_t *tx);\nvoid dsl_dataset_zapify(dsl_dataset_t *ds, dmu_tx_t *tx);\nboolean_t dsl_dataset_is_zapified(dsl_dataset_t *ds);\nboolean_t dsl_dataset_has_resume_receive_state(dsl_dataset_t *ds);\n\nint dsl_dataset_rollback_check(void *arg, dmu_tx_t *tx);\nvoid dsl_dataset_rollback_sync(void *arg, dmu_tx_t *tx);\nint dsl_dataset_rollback(const char *fsname, const char *tosnap, void *owner,\n    nvlist_t *result);\n\nint dsl_dataset_rename_snapshot_check(void *arg, dmu_tx_t *tx);\nvoid dsl_dataset_rename_snapshot_sync(void *arg, dmu_tx_t *tx);\n\nuint64_t dsl_dataset_get_remap_deadlist_object(dsl_dataset_t *ds);\nvoid dsl_dataset_create_remap_deadlist(dsl_dataset_t *ds, dmu_tx_t *tx);\nboolean_t dsl_dataset_remap_deadlist_exists(dsl_dataset_t *ds);\nvoid dsl_dataset_destroy_remap_deadlist(dsl_dataset_t *ds, dmu_tx_t *tx);\n\nvoid dsl_dataset_activate_feature(uint64_t dsobj, spa_feature_t f, void *arg,\n    dmu_tx_t *tx);\nvoid dsl_dataset_deactivate_feature(dsl_dataset_t *ds, spa_feature_t f,\n    dmu_tx_t *tx);\nboolean_t dsl_dataset_feature_is_active(dsl_dataset_t *ds, spa_feature_t f);\nboolean_t dsl_dataset_get_uint64_array_feature(dsl_dataset_t *ds,\n    spa_feature_t f, uint64_t *outlength, uint64_t **outp);\n\nvoid dsl_dataset_activate_redaction(dsl_dataset_t *ds, uint64_t *redact_snaps,\n    uint64_t num_redact_snaps, dmu_tx_t *tx);\n\nint dsl_dataset_oldest_snapshot(spa_t *spa, uint64_t head_ds, uint64_t min_txg,\n    uint64_t *oldest_dsobj);\n\n#ifdef ZFS_DEBUG\n#define\tdprintf_ds(ds, fmt, ...) do { \\\n\tif (zfs_flags & ZFS_DEBUG_DPRINTF) { \\\n\tchar *__ds_name = kmem_alloc(ZFS_MAX_DATASET_NAME_LEN, KM_SLEEP); \\\n\tdsl_dataset_name(ds, __ds_name); \\\n\tdprintf(\"ds=%s \" fmt, __ds_name, __VA_ARGS__); \\\n\tkmem_free(__ds_name, ZFS_MAX_DATASET_NAME_LEN); \\\n\t} \\\n} while (0)\n#else\n#define\tdprintf_ds(dd, fmt, ...)\n#endif\n\n#ifdef\t__cplusplus\n}\n#endif\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}