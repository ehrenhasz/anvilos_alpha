{
  "module_name": "blake3_impl.c",
  "hash_id": "6502ef3e74a7b5f1f0d8d80d4af2961d059763a0986202463efab7ffcb2ead50",
  "original_prompt": "Ingested from zfs-2.2.2/module/icp/algs/blake3/blake3_impl.c",
  "human_readable_source": " \n\n \n\n#include <sys/simd.h>\n#include <sys/zfs_context.h>\n#include <sys/zfs_impl.h>\n#include <sys/blake3.h>\n\n#include \"blake3_impl.h\"\n\n#if defined(__aarch64__) || \\\n\t(defined(__x86_64) && defined(HAVE_SSE2)) || \\\n\t(defined(__PPC64__) && defined(__LITTLE_ENDIAN__))\n\nextern void ASMABI zfs_blake3_compress_in_place_sse2(uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags);\n\nextern void ASMABI zfs_blake3_compress_xof_sse2(const uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags, uint8_t out[64]);\n\nextern void ASMABI zfs_blake3_hash_many_sse2(const uint8_t * const *inputs,\n    size_t num_inputs, size_t blocks, const uint32_t key[8],\n    uint64_t counter, boolean_t increment_counter, uint8_t flags,\n    uint8_t flags_start, uint8_t flags_end, uint8_t *out);\n\nstatic void blake3_compress_in_place_sse2(uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags) {\n\tkfpu_begin();\n\tzfs_blake3_compress_in_place_sse2(cv, block, block_len, counter,\n\t    flags);\n\tkfpu_end();\n}\n\nstatic void blake3_compress_xof_sse2(const uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags, uint8_t out[64]) {\n\tkfpu_begin();\n\tzfs_blake3_compress_xof_sse2(cv, block, block_len, counter, flags,\n\t    out);\n\tkfpu_end();\n}\n\nstatic void blake3_hash_many_sse2(const uint8_t * const *inputs,\n    size_t num_inputs, size_t blocks, const uint32_t key[8],\n    uint64_t counter, boolean_t increment_counter, uint8_t flags,\n    uint8_t flags_start, uint8_t flags_end, uint8_t *out) {\n\tkfpu_begin();\n\tzfs_blake3_hash_many_sse2(inputs, num_inputs, blocks, key, counter,\n\t    increment_counter, flags, flags_start, flags_end, out);\n\tkfpu_end();\n}\n\nstatic boolean_t blake3_is_sse2_supported(void)\n{\n#if defined(__x86_64)\n\treturn (kfpu_allowed() && zfs_sse2_available());\n#elif defined(__PPC64__)\n\treturn (kfpu_allowed() && zfs_vsx_available());\n#else\n\treturn (kfpu_allowed());\n#endif\n}\n\nconst blake3_ops_t blake3_sse2_impl = {\n\t.compress_in_place = blake3_compress_in_place_sse2,\n\t.compress_xof = blake3_compress_xof_sse2,\n\t.hash_many = blake3_hash_many_sse2,\n\t.is_supported = blake3_is_sse2_supported,\n\t.degree = 4,\n\t.name = \"sse2\"\n};\n#endif\n\n#if defined(__aarch64__) || \\\n\t(defined(__x86_64) && defined(HAVE_SSE2)) || \\\n\t(defined(__PPC64__) && defined(__LITTLE_ENDIAN__))\n\nextern void ASMABI zfs_blake3_compress_in_place_sse41(uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags);\n\nextern void ASMABI zfs_blake3_compress_xof_sse41(const uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags, uint8_t out[64]);\n\nextern void ASMABI zfs_blake3_hash_many_sse41(const uint8_t * const *inputs,\n    size_t num_inputs, size_t blocks, const uint32_t key[8],\n    uint64_t counter, boolean_t increment_counter, uint8_t flags,\n    uint8_t flags_start, uint8_t flags_end, uint8_t *out);\n\nstatic void blake3_compress_in_place_sse41(uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags) {\n\tkfpu_begin();\n\tzfs_blake3_compress_in_place_sse41(cv, block, block_len, counter,\n\t    flags);\n\tkfpu_end();\n}\n\nstatic void blake3_compress_xof_sse41(const uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags, uint8_t out[64]) {\n\tkfpu_begin();\n\tzfs_blake3_compress_xof_sse41(cv, block, block_len, counter, flags,\n\t    out);\n\tkfpu_end();\n}\n\nstatic void blake3_hash_many_sse41(const uint8_t * const *inputs,\n    size_t num_inputs, size_t blocks, const uint32_t key[8],\n    uint64_t counter, boolean_t increment_counter, uint8_t flags,\n    uint8_t flags_start, uint8_t flags_end, uint8_t *out) {\n\tkfpu_begin();\n\tzfs_blake3_hash_many_sse41(inputs, num_inputs, blocks, key, counter,\n\t    increment_counter, flags, flags_start, flags_end, out);\n\tkfpu_end();\n}\n\nstatic boolean_t blake3_is_sse41_supported(void)\n{\n#if defined(__x86_64)\n\treturn (kfpu_allowed() && zfs_sse4_1_available());\n#elif defined(__PPC64__)\n\treturn (kfpu_allowed() && zfs_vsx_available());\n#else\n\treturn (kfpu_allowed());\n#endif\n}\n\nconst blake3_ops_t blake3_sse41_impl = {\n\t.compress_in_place = blake3_compress_in_place_sse41,\n\t.compress_xof = blake3_compress_xof_sse41,\n\t.hash_many = blake3_hash_many_sse41,\n\t.is_supported = blake3_is_sse41_supported,\n\t.degree = 4,\n\t.name = \"sse41\"\n};\n#endif\n\n#if defined(__x86_64) && defined(HAVE_SSE4_1) && defined(HAVE_AVX2)\nextern void ASMABI zfs_blake3_hash_many_avx2(const uint8_t * const *inputs,\n    size_t num_inputs, size_t blocks, const uint32_t key[8],\n    uint64_t counter, boolean_t increment_counter, uint8_t flags,\n    uint8_t flags_start, uint8_t flags_end, uint8_t *out);\n\nstatic void blake3_hash_many_avx2(const uint8_t * const *inputs,\n    size_t num_inputs, size_t blocks, const uint32_t key[8],\n    uint64_t counter, boolean_t increment_counter, uint8_t flags,\n    uint8_t flags_start, uint8_t flags_end, uint8_t *out) {\n\tkfpu_begin();\n\tzfs_blake3_hash_many_avx2(inputs, num_inputs, blocks, key, counter,\n\t    increment_counter, flags, flags_start, flags_end, out);\n\tkfpu_end();\n}\n\nstatic boolean_t blake3_is_avx2_supported(void)\n{\n\treturn (kfpu_allowed() && zfs_sse4_1_available() &&\n\t    zfs_avx2_available());\n}\n\nconst blake3_ops_t\nblake3_avx2_impl = {\n\t.compress_in_place = blake3_compress_in_place_sse41,\n\t.compress_xof = blake3_compress_xof_sse41,\n\t.hash_many = blake3_hash_many_avx2,\n\t.is_supported = blake3_is_avx2_supported,\n\t.degree = 8,\n\t.name = \"avx2\"\n};\n#endif\n\n#if defined(__x86_64) && defined(HAVE_AVX512F) && defined(HAVE_AVX512VL)\nextern void ASMABI zfs_blake3_compress_in_place_avx512(uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags);\n\nextern void ASMABI zfs_blake3_compress_xof_avx512(const uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags, uint8_t out[64]);\n\nextern void ASMABI zfs_blake3_hash_many_avx512(const uint8_t * const *inputs,\n    size_t num_inputs, size_t blocks, const uint32_t key[8],\n    uint64_t counter, boolean_t increment_counter, uint8_t flags,\n    uint8_t flags_start, uint8_t flags_end, uint8_t *out);\n\nstatic void blake3_compress_in_place_avx512(uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags) {\n\tkfpu_begin();\n\tzfs_blake3_compress_in_place_avx512(cv, block, block_len, counter,\n\t    flags);\n\tkfpu_end();\n}\n\nstatic void blake3_compress_xof_avx512(const uint32_t cv[8],\n    const uint8_t block[BLAKE3_BLOCK_LEN], uint8_t block_len,\n    uint64_t counter, uint8_t flags, uint8_t out[64]) {\n\tkfpu_begin();\n\tzfs_blake3_compress_xof_avx512(cv, block, block_len, counter, flags,\n\t    out);\n\tkfpu_end();\n}\n\nstatic void blake3_hash_many_avx512(const uint8_t * const *inputs,\n    size_t num_inputs, size_t blocks, const uint32_t key[8],\n    uint64_t counter, boolean_t increment_counter, uint8_t flags,\n    uint8_t flags_start, uint8_t flags_end, uint8_t *out) {\n\tkfpu_begin();\n\tzfs_blake3_hash_many_avx512(inputs, num_inputs, blocks, key, counter,\n\t    increment_counter, flags, flags_start, flags_end, out);\n\tkfpu_end();\n}\n\nstatic boolean_t blake3_is_avx512_supported(void)\n{\n\treturn (kfpu_allowed() && zfs_avx512f_available() &&\n\t    zfs_avx512vl_available());\n}\n\nconst blake3_ops_t blake3_avx512_impl = {\n\t.compress_in_place = blake3_compress_in_place_avx512,\n\t.compress_xof = blake3_compress_xof_avx512,\n\t.hash_many = blake3_hash_many_avx512,\n\t.is_supported = blake3_is_avx512_supported,\n\t.degree = 16,\n\t.name = \"avx512\"\n};\n#endif\n\nextern const blake3_ops_t blake3_generic_impl;\n\nstatic const blake3_ops_t *const blake3_impls[] = {\n\t&blake3_generic_impl,\n#if defined(__aarch64__) || \\\n\t(defined(__x86_64) && defined(HAVE_SSE2)) || \\\n\t(defined(__PPC64__) && defined(__LITTLE_ENDIAN__))\n\t&blake3_sse2_impl,\n#endif\n#if defined(__aarch64__) || \\\n\t(defined(__x86_64) && defined(HAVE_SSE4_1)) || \\\n\t(defined(__PPC64__) && defined(__LITTLE_ENDIAN__))\n\t&blake3_sse41_impl,\n#endif\n#if defined(__x86_64) && defined(HAVE_SSE4_1) && defined(HAVE_AVX2)\n\t&blake3_avx2_impl,\n#endif\n#if defined(__x86_64) && defined(HAVE_AVX512F) && defined(HAVE_AVX512VL)\n\t&blake3_avx512_impl,\n#endif\n};\n\n \n#define\tIMPL_NAME\t\t\"blake3\"\n#define\tIMPL_OPS_T\t\tblake3_ops_t\n#define\tIMPL_ARRAY\t\tblake3_impls\n#define\tIMPL_GET_OPS\t\tblake3_get_ops\n#define\tZFS_IMPL_OPS\t\tzfs_blake3_ops\n#include <generic_impl.c>\n\n#ifdef _KERNEL\nvoid **blake3_per_cpu_ctx;\n\nvoid\nblake3_per_cpu_ctx_init(void)\n{\n\t \n\tblake3_per_cpu_ctx = kmem_alloc(max_ncpus * sizeof (void *), KM_SLEEP);\n\tfor (int i = 0; i < max_ncpus; i++) {\n\t\tblake3_per_cpu_ctx[i] = kmem_alloc(sizeof (BLAKE3_CTX),\n\t\t    KM_SLEEP);\n\t}\n}\n\nvoid\nblake3_per_cpu_ctx_fini(void)\n{\n\tfor (int i = 0; i < max_ncpus; i++) {\n\t\tmemset(blake3_per_cpu_ctx[i], 0, sizeof (BLAKE3_CTX));\n\t\tkmem_free(blake3_per_cpu_ctx[i], sizeof (BLAKE3_CTX));\n\t}\n\tmemset(blake3_per_cpu_ctx, 0, max_ncpus * sizeof (void *));\n\tkmem_free(blake3_per_cpu_ctx, max_ncpus * sizeof (void *));\n}\n\n#define\tIMPL_FMT(impl, i)\t(((impl) == (i)) ? \"[%s] \" : \"%s \")\n\n#if defined(__linux__)\n\nstatic int\nblake3_param_get(char *buffer, zfs_kernel_param_t *unused)\n{\n\tconst uint32_t impl = IMPL_READ(generic_impl_chosen);\n\tchar *fmt;\n\tint cnt = 0;\n\n\t \n\tfmt = IMPL_FMT(impl, IMPL_CYCLE);\n\tcnt += kmem_scnprintf(buffer + cnt, PAGE_SIZE - cnt, fmt, \"cycle\");\n\n\t \n\tfmt = IMPL_FMT(impl, IMPL_FASTEST);\n\tcnt += kmem_scnprintf(buffer + cnt, PAGE_SIZE - cnt, fmt, \"fastest\");\n\n\t \n\tgeneric_impl_init();\n\tfor (uint32_t i = 0; i < generic_supp_impls_cnt; ++i) {\n\t\tfmt = IMPL_FMT(impl, i);\n\t\tcnt += kmem_scnprintf(buffer + cnt, PAGE_SIZE - cnt, fmt,\n\t\t    blake3_impls[i]->name);\n\t}\n\n\treturn (cnt);\n}\n\nstatic int\nblake3_param_set(const char *val, zfs_kernel_param_t *unused)\n{\n\t(void) unused;\n\treturn (generic_impl_setname(val));\n}\n\n#elif defined(__FreeBSD__)\n\n#include <sys/sbuf.h>\n\nstatic int\nblake3_param(ZFS_MODULE_PARAM_ARGS)\n{\n\tint err;\n\n\tgeneric_impl_init();\n\tif (req->newptr == NULL) {\n\t\tconst uint32_t impl = IMPL_READ(generic_impl_chosen);\n\t\tconst int init_buflen = 64;\n\t\tconst char *fmt;\n\t\tstruct sbuf *s;\n\n\t\ts = sbuf_new_for_sysctl(NULL, NULL, init_buflen, req);\n\n\t\t \n\t\tfmt = IMPL_FMT(impl, IMPL_CYCLE);\n\t\t(void) sbuf_printf(s, fmt, \"cycle\");\n\n\t\t \n\t\tfmt = IMPL_FMT(impl, IMPL_FASTEST);\n\t\t(void) sbuf_printf(s, fmt, \"fastest\");\n\n\t\t \n\t\tfor (uint32_t i = 0; i < generic_supp_impls_cnt; ++i) {\n\t\t\tfmt = IMPL_FMT(impl, i);\n\t\t\t(void) sbuf_printf(s, fmt, generic_supp_impls[i]->name);\n\t\t}\n\n\t\terr = sbuf_finish(s);\n\t\tsbuf_delete(s);\n\n\t\treturn (err);\n\t}\n\n\tchar buf[16];\n\n\terr = sysctl_handle_string(oidp, buf, sizeof (buf), req);\n\tif (err) {\n\t\treturn (err);\n\t}\n\n\treturn (-generic_impl_setname(buf));\n}\n#endif\n\n#undef IMPL_FMT\n\nZFS_MODULE_VIRTUAL_PARAM_CALL(zfs, zfs_, blake3_impl,\n    blake3_param_set, blake3_param_get, ZMOD_RW, \\\n\t\"Select BLAKE3 implementation.\");\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}