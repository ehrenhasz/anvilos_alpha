{
  "module_name": "kcf_sched.c",
  "hash_id": "fc1d5ee52d442c61661d2fddc56962988c88011efa878d1dfa9bb3e3cdbb9f23",
  "original_prompt": "Ingested from zfs-2.2.2/module/icp/core/kcf_sched.c",
  "human_readable_source": " \n \n\n \n\n#include <sys/zfs_context.h>\n#include <sys/crypto/common.h>\n#include <sys/crypto/impl.h>\n#include <sys/crypto/sched_impl.h>\n#include <sys/crypto/api.h>\n\n \nstatic kmem_cache_t *kcf_context_cache;\n\n \ncrypto_ctx_t *\nkcf_new_ctx(kcf_provider_desc_t *pd)\n{\n\tcrypto_ctx_t *ctx;\n\tkcf_context_t *kcf_ctx;\n\n\tkcf_ctx = kmem_cache_alloc(kcf_context_cache, KM_SLEEP);\n\tif (kcf_ctx == NULL)\n\t\treturn (NULL);\n\n\t \n\tkcf_ctx->kc_refcnt = 1;\n\tKCF_PROV_REFHOLD(pd);\n\tkcf_ctx->kc_prov_desc = pd;\n\tkcf_ctx->kc_sw_prov_desc = NULL;\n\n\tctx = &kcf_ctx->kc_glbl_ctx;\n\tctx->cc_provider_private = NULL;\n\tctx->cc_framework_private = (void *)kcf_ctx;\n\n\treturn (ctx);\n}\n\n \nvoid\nkcf_free_context(kcf_context_t *kcf_ctx)\n{\n\tkcf_provider_desc_t *pd = kcf_ctx->kc_prov_desc;\n\tcrypto_ctx_t *gctx = &kcf_ctx->kc_glbl_ctx;\n\n\tif (gctx->cc_provider_private != NULL) {\n\t\tmutex_enter(&pd->pd_lock);\n\t\tif (!KCF_IS_PROV_REMOVED(pd)) {\n\t\t\t \n\t\t\tKCF_PROV_IREFHOLD(pd);\n\t\t\tmutex_exit(&pd->pd_lock);\n\t\t\t(void) KCF_PROV_FREE_CONTEXT(pd, gctx);\n\t\t\tKCF_PROV_IREFRELE(pd);\n\t\t} else {\n\t\t\tmutex_exit(&pd->pd_lock);\n\t\t}\n\t}\n\n\t \n\tKCF_PROV_REFRELE(kcf_ctx->kc_prov_desc);\n\n\tkmem_cache_free(kcf_context_cache, kcf_ctx);\n}\n\n \nstatic int\nkcf_context_cache_constructor(void *buf, void *cdrarg, int kmflags)\n{\n\t(void) cdrarg, (void) kmflags;\n\tkcf_context_t *kctx = (kcf_context_t *)buf;\n\n\tkctx->kc_refcnt = 0;\n\n\treturn (0);\n}\n\nstatic void\nkcf_context_cache_destructor(void *buf, void *cdrarg)\n{\n\t(void) cdrarg;\n\tkcf_context_t *kctx = (kcf_context_t *)buf;\n\n\tASSERT(kctx->kc_refcnt == 0);\n}\n\nvoid\nkcf_sched_destroy(void)\n{\n\tif (kcf_context_cache)\n\t\tkmem_cache_destroy(kcf_context_cache);\n}\n\n \nvoid\nkcf_sched_init(void)\n{\n\t \n\tkcf_context_cache = kmem_cache_create(\"kcf_context_cache\",\n\t    sizeof (struct kcf_context), 64, kcf_context_cache_constructor,\n\t    kcf_context_cache_destructor, NULL, NULL, NULL, 0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}