{
  "module_name": "spl_atomic.c",
  "hash_id": "3c60e4e74ffacaf2273791a5d5e129b1684ffa777ae34c97fb54f7d3d8b718db",
  "original_prompt": "Ingested from zfs-2.2.2/module/os/freebsd/spl/spl_atomic.c",
  "human_readable_source": " \n\n#include <sys/cdefs.h>\n__FBSDID(\"$FreeBSD$\");\n\n#include <sys/param.h>\n#include <sys/lock.h>\n#include <sys/mutex.h>\n#include <sys/atomic.h>\n\n#if !defined(__LP64__) && !defined(__mips_n32) && \\\n\t!defined(ARM_HAVE_ATOMIC64) && !defined(I386_HAVE_ATOMIC64) && \\\n\t!defined(HAS_EMULATED_ATOMIC64)\n\n#ifdef _KERNEL\n#include <sys/kernel.h>\n\nstruct mtx atomic_mtx;\nMTX_SYSINIT(atomic, &atomic_mtx, \"atomic\", MTX_DEF);\n#else\n#include <pthread.h>\n\n#define\tmtx_lock(lock)\t\tpthread_mutex_lock(lock)\n#define\tmtx_unlock(lock)\tpthread_mutex_unlock(lock)\n\nstatic pthread_mutex_t atomic_mtx;\n\nstatic __attribute__((constructor)) void\natomic_init(void)\n{\n\tpthread_mutex_init(&atomic_mtx, NULL);\n}\n#endif\n\nvoid\natomic_add_64(volatile uint64_t *target, int64_t delta)\n{\n\n\tmtx_lock(&atomic_mtx);\n\t*target += delta;\n\tmtx_unlock(&atomic_mtx);\n}\n\nvoid\natomic_dec_64(volatile uint64_t *target)\n{\n\n\tmtx_lock(&atomic_mtx);\n\t*target -= 1;\n\tmtx_unlock(&atomic_mtx);\n}\n\nuint64_t\natomic_swap_64(volatile uint64_t *a, uint64_t value)\n{\n\tuint64_t ret;\n\n\tmtx_lock(&atomic_mtx);\n\tret = *a;\n\t*a = value;\n\tmtx_unlock(&atomic_mtx);\n\treturn (ret);\n}\n\nuint64_t\natomic_load_64(volatile uint64_t *a)\n{\n\tuint64_t ret;\n\n\tmtx_lock(&atomic_mtx);\n\tret = *a;\n\tmtx_unlock(&atomic_mtx);\n\treturn (ret);\n}\n\nuint64_t\natomic_add_64_nv(volatile uint64_t *target, int64_t delta)\n{\n\tuint64_t newval;\n\n\tmtx_lock(&atomic_mtx);\n\tnewval = (*target += delta);\n\tmtx_unlock(&atomic_mtx);\n\treturn (newval);\n}\n\nuint64_t\natomic_cas_64(volatile uint64_t *target, uint64_t cmp, uint64_t newval)\n{\n\tuint64_t oldval;\n\n\tmtx_lock(&atomic_mtx);\n\toldval = *target;\n\tif (oldval == cmp)\n\t\t*target = newval;\n\tmtx_unlock(&atomic_mtx);\n\treturn (oldval);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}