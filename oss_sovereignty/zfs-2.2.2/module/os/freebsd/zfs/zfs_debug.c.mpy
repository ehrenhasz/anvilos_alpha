{
  "module_name": "zfs_debug.c",
  "hash_id": "98178f2ed266a1a9b69a9986e348a591b03e1b5c9fd64d847a0eef127761e22f",
  "original_prompt": "Ingested from zfs-2.2.2/module/os/freebsd/zfs/zfs_debug.c",
  "human_readable_source": " \n \n\n#include <sys/zfs_context.h>\n#include <sys/kstat.h>\n\ntypedef struct zfs_dbgmsg {\n\tlist_node_t zdm_node;\n\ttime_t zdm_timestamp;\n\tuint_t zdm_size;\n\tchar zdm_msg[];\n} zfs_dbgmsg_t;\n\nstatic list_t zfs_dbgmsgs;\nstatic uint_t zfs_dbgmsg_size = 0;\nstatic kmutex_t zfs_dbgmsgs_lock;\nuint_t zfs_dbgmsg_maxsize = 4<<20;  \nstatic kstat_t *zfs_dbgmsg_kstat;\n\n \nint zfs_dbgmsg_enable = B_TRUE;\n\nstatic int\nzfs_dbgmsg_headers(char *buf, size_t size)\n{\n\t(void) snprintf(buf, size, \"%-12s %-8s\\n\", \"timestamp\", \"message\");\n\n\treturn (0);\n}\n\nstatic int\nzfs_dbgmsg_data(char *buf, size_t size, void *data)\n{\n\tzfs_dbgmsg_t *zdm = (zfs_dbgmsg_t *)data;\n\n\t(void) snprintf(buf, size, \"%-12llu %-s\\n\",\n\t    (u_longlong_t)zdm->zdm_timestamp, zdm->zdm_msg);\n\n\treturn (0);\n}\n\nstatic void *\nzfs_dbgmsg_addr(kstat_t *ksp, loff_t n)\n{\n\tzfs_dbgmsg_t *zdm = (zfs_dbgmsg_t *)ksp->ks_private;\n\n\tASSERT(MUTEX_HELD(&zfs_dbgmsgs_lock));\n\n\tif (n == 0)\n\t\tksp->ks_private = list_head(&zfs_dbgmsgs);\n\telse if (zdm)\n\t\tksp->ks_private = list_next(&zfs_dbgmsgs, zdm);\n\n\treturn (ksp->ks_private);\n}\n\nstatic void\nzfs_dbgmsg_purge(uint_t max_size)\n{\n\tzfs_dbgmsg_t *zdm;\n\tuint_t size;\n\n\tASSERT(MUTEX_HELD(&zfs_dbgmsgs_lock));\n\n\twhile (zfs_dbgmsg_size > max_size) {\n\t\tzdm = list_remove_head(&zfs_dbgmsgs);\n\t\tif (zdm == NULL)\n\t\t\treturn;\n\n\t\tsize = zdm->zdm_size;\n\t\tkmem_free(zdm, size);\n\t\tzfs_dbgmsg_size -= size;\n\t}\n}\n\nstatic int\nzfs_dbgmsg_update(kstat_t *ksp, int rw)\n{\n\tif (rw == KSTAT_WRITE)\n\t\tzfs_dbgmsg_purge(0);\n\n\treturn (0);\n}\n\nvoid\nzfs_dbgmsg_init(void)\n{\n\tlist_create(&zfs_dbgmsgs, sizeof (zfs_dbgmsg_t),\n\t    offsetof(zfs_dbgmsg_t, zdm_node));\n\tmutex_init(&zfs_dbgmsgs_lock, NULL, MUTEX_DEFAULT, NULL);\n\n\tzfs_dbgmsg_kstat = kstat_create(\"zfs\", 0, \"dbgmsg\", \"misc\",\n\t    KSTAT_TYPE_RAW, 0, KSTAT_FLAG_VIRTUAL);\n\tif (zfs_dbgmsg_kstat) {\n\t\tzfs_dbgmsg_kstat->ks_lock = &zfs_dbgmsgs_lock;\n\t\tzfs_dbgmsg_kstat->ks_ndata = UINT32_MAX;\n\t\tzfs_dbgmsg_kstat->ks_private = NULL;\n\t\tzfs_dbgmsg_kstat->ks_update = zfs_dbgmsg_update;\n\t\tkstat_set_raw_ops(zfs_dbgmsg_kstat, zfs_dbgmsg_headers,\n\t\t    zfs_dbgmsg_data, zfs_dbgmsg_addr);\n\t\tkstat_install(zfs_dbgmsg_kstat);\n\t}\n}\n\nvoid\nzfs_dbgmsg_fini(void)\n{\n\tif (zfs_dbgmsg_kstat)\n\t\tkstat_delete(zfs_dbgmsg_kstat);\n\t \n#ifdef _KERNEL\n\tmutex_enter(&zfs_dbgmsgs_lock);\n\tzfs_dbgmsg_purge(0);\n\tmutex_exit(&zfs_dbgmsgs_lock);\n\tmutex_destroy(&zfs_dbgmsgs_lock);\n#endif\n}\n\nvoid\n__zfs_dbgmsg(char *buf)\n{\n\tzfs_dbgmsg_t *zdm;\n\tuint_t size;\n\n\tDTRACE_PROBE1(zfs__dbgmsg, char *, buf);\n\n\tsize = sizeof (zfs_dbgmsg_t) + strlen(buf) + 1;\n\tzdm = kmem_zalloc(size, KM_SLEEP);\n\tzdm->zdm_size = size;\n\tzdm->zdm_timestamp = gethrestime_sec();\n\tstrcpy(zdm->zdm_msg, buf);\n\n\tmutex_enter(&zfs_dbgmsgs_lock);\n\tlist_insert_tail(&zfs_dbgmsgs, zdm);\n\tzfs_dbgmsg_size += size;\n\tzfs_dbgmsg_purge(zfs_dbgmsg_maxsize);\n\tmutex_exit(&zfs_dbgmsgs_lock);\n}\n\nvoid\n__set_error(const char *file, const char *func, int line, int err)\n{\n\t \n\tif (zfs_flags & ZFS_DEBUG_SET_ERROR)\n\t\t__dprintf(B_FALSE, file, func, line, \"error %lu\", (ulong_t)err);\n}\n\n#ifdef _KERNEL\nvoid\n__dprintf(boolean_t dprint, const char *file, const char *func,\n    int line, const char *fmt, ...)\n{\n\tconst char *newfile;\n\tva_list adx;\n\tsize_t size;\n\tchar *buf;\n\tchar *nl;\n\tint i;\n\n\tsize = 1024;\n\tbuf = kmem_alloc(size, KM_SLEEP);\n\n\t \n\tnewfile = strrchr(file, '/');\n\tif (newfile != NULL) {\n\t\tnewfile = newfile + 1;  \n\t} else {\n\t\tnewfile = file;\n\t}\n\n\ti = snprintf(buf, size, \"%s:%d:%s(): \", newfile, line, func);\n\n\tif (i < size) {\n\t\tva_start(adx, fmt);\n\t\t(void) vsnprintf(buf + i, size - i, fmt, adx);\n\t\tva_end(adx);\n\t}\n\n\t \n\tnl = strrchr(buf, '\\n');\n\tif (nl != NULL)\n\t\t*nl = '\\0';\n\n\t__zfs_dbgmsg(buf);\n\n\tkmem_free(buf, size);\n}\n\n#else\n\nvoid\nzfs_dbgmsg_print(const char *tag)\n{\n\tzfs_dbgmsg_t *zdm;\n\n\t(void) printf(\"ZFS_DBGMSG(%s):\\n\", tag);\n\tmutex_enter(&zfs_dbgmsgs_lock);\n\tfor (zdm = list_head(&zfs_dbgmsgs); zdm;\n\t    zdm = list_next(&zfs_dbgmsgs, zdm))\n\t\t(void) printf(\"%s\\n\", zdm->zdm_msg);\n\tmutex_exit(&zfs_dbgmsgs_lock);\n}\n#endif  \n\nZFS_MODULE_PARAM(zfs, zfs_, dbgmsg_enable, INT, ZMOD_RW,\n\t\"Enable ZFS debug message log\");\n\nZFS_MODULE_PARAM(zfs, zfs_, dbgmsg_maxsize, UINT, ZMOD_RW,\n\t\"Maximum ZFS debug log size\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}