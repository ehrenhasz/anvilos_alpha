{
  "module_name": "hkdf.c",
  "hash_id": "0d58844a7431dd2c5e37d9752f2ff7ba43c26b2b07c1c410e8bb789a252b52e9",
  "original_prompt": "Ingested from zfs-2.2.2/module/os/freebsd/zfs/hkdf.c",
  "human_readable_source": " \n\n \n\n#include <sys/dmu.h>\n#include <sys/hkdf.h>\n#include <sys/freebsd_crypto.h>\n#include <sys/hkdf.h>\n\nstatic int\nhkdf_sha512_extract(uint8_t *salt, uint_t salt_len, uint8_t *key_material,\n    uint_t km_len, uint8_t *out_buf)\n{\n\tcrypto_key_t key;\n\n\t \n\tkey.ck_length = CRYPTO_BYTES2BITS(salt_len);\n\tkey.ck_data = salt;\n\n\tcrypto_mac(&key, key_material, km_len, out_buf, SHA512_DIGEST_LENGTH);\n\n\treturn (0);\n}\n\nstatic int\nhkdf_sha512_expand(uint8_t *extract_key, uint8_t *info, uint_t info_len,\n    uint8_t *out_buf, uint_t out_len)\n{\n\tstruct hmac_ctx ctx;\n\tcrypto_key_t key;\n\tuint_t i, T_len = 0, pos = 0;\n\tuint8_t c;\n\tuint_t N = (out_len + SHA512_DIGEST_LENGTH) / SHA512_DIGEST_LENGTH;\n\tuint8_t T[SHA512_DIGEST_LENGTH];\n\n\tif (N > 255)\n\t\treturn (SET_ERROR(EINVAL));\n\n\t \n\tkey.ck_length = CRYPTO_BYTES2BITS(SHA512_DIGEST_LENGTH);\n\tkey.ck_data = extract_key;\n\n\tfor (i = 1; i <= N; i++) {\n\t\tc = i;\n\n\t\tcrypto_mac_init(&ctx, &key);\n\t\tcrypto_mac_update(&ctx, T, T_len);\n\t\tcrypto_mac_update(&ctx, info, info_len);\n\t\tcrypto_mac_update(&ctx, &c, 1);\n\t\tcrypto_mac_final(&ctx, T, SHA512_DIGEST_LENGTH);\n\t\tmemcpy(out_buf + pos, T,\n\t\t    (i != N) ? SHA512_DIGEST_LENGTH : (out_len - pos));\n\t\tpos += SHA512_DIGEST_LENGTH;\n\t}\n\n\treturn (0);\n}\n\n \nint\nhkdf_sha512(uint8_t *key_material, uint_t km_len, uint8_t *salt,\n    uint_t salt_len, uint8_t *info, uint_t info_len, uint8_t *output_key,\n    uint_t out_len)\n{\n\tint ret;\n\tuint8_t extract_key[SHA512_DIGEST_LENGTH];\n\n\tret = hkdf_sha512_extract(salt, salt_len, key_material, km_len,\n\t    extract_key);\n\tif (ret != 0)\n\t\treturn (ret);\n\n\tret = hkdf_sha512_expand(extract_key, info, info_len, output_key,\n\t    out_len);\n\tif (ret != 0)\n\t\treturn (ret);\n\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}