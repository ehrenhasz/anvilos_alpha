{
  "module_name": "spl-zlib.c",
  "hash_id": "973a5895e362821d8d342cf70d45ad12c72978ba918321d80bbfa8a03a314926",
  "original_prompt": "Ingested from zfs-2.2.2/module/os/linux/spl/spl-zlib.c",
  "human_readable_source": " \n\n\n#include <linux/percpu_compat.h>\n#include <sys/kmem.h>\n#include <sys/kmem_cache.h>\n#include <sys/zmod.h>\n\nstatic spl_kmem_cache_t *zlib_workspace_cache;\n\n \nstatic void *\nzlib_workspace_alloc(int flags)\n{\n\treturn (kmem_cache_alloc(zlib_workspace_cache, flags & ~(__GFP_FS)));\n}\n\nstatic void\nzlib_workspace_free(void *workspace)\n{\n\tkmem_cache_free(zlib_workspace_cache, workspace);\n}\n\n \nint\nz_compress_level(void *dest, size_t *destLen, const void *source,\n    size_t sourceLen, int level)\n{\n\tz_stream stream;\n\tint err;\n\n\tstream.next_in = (Byte *)source;\n\tstream.avail_in = (uInt)sourceLen;\n\tstream.next_out = dest;\n\tstream.avail_out = (uInt)*destLen;\n\n\tif ((size_t)stream.avail_out != *destLen)\n\t\treturn (Z_BUF_ERROR);\n\n\tstream.workspace = zlib_workspace_alloc(KM_SLEEP);\n\tif (!stream.workspace)\n\t\treturn (Z_MEM_ERROR);\n\n\terr = zlib_deflateInit(&stream, level);\n\tif (err != Z_OK) {\n\t\tzlib_workspace_free(stream.workspace);\n\t\treturn (err);\n\t}\n\n\terr = zlib_deflate(&stream, Z_FINISH);\n\tif (err != Z_STREAM_END) {\n\t\tzlib_deflateEnd(&stream);\n\t\tzlib_workspace_free(stream.workspace);\n\t\treturn (err == Z_OK ? Z_BUF_ERROR : err);\n\t}\n\t*destLen = stream.total_out;\n\n\terr = zlib_deflateEnd(&stream);\n\tzlib_workspace_free(stream.workspace);\n\n\treturn (err);\n}\nEXPORT_SYMBOL(z_compress_level);\n\n \nint\nz_uncompress(void *dest, size_t *destLen, const void *source, size_t sourceLen)\n{\n\tz_stream stream;\n\tint err;\n\n\tstream.next_in = (Byte *)source;\n\tstream.avail_in = (uInt)sourceLen;\n\tstream.next_out = dest;\n\tstream.avail_out = (uInt)*destLen;\n\n\tif ((size_t)stream.avail_out != *destLen)\n\t\treturn (Z_BUF_ERROR);\n\n\tstream.workspace = zlib_workspace_alloc(KM_SLEEP);\n\tif (!stream.workspace)\n\t\treturn (Z_MEM_ERROR);\n\n\terr = zlib_inflateInit(&stream);\n\tif (err != Z_OK) {\n\t\tzlib_workspace_free(stream.workspace);\n\t\treturn (err);\n\t}\n\n\terr = zlib_inflate(&stream, Z_FINISH);\n\tif (err != Z_STREAM_END) {\n\t\tzlib_inflateEnd(&stream);\n\t\tzlib_workspace_free(stream.workspace);\n\n\t\tif (err == Z_NEED_DICT ||\n\t\t    (err == Z_BUF_ERROR && stream.avail_in == 0))\n\t\t\treturn (Z_DATA_ERROR);\n\n\t\treturn (err);\n\t}\n\t*destLen = stream.total_out;\n\n\terr = zlib_inflateEnd(&stream);\n\tzlib_workspace_free(stream.workspace);\n\n\treturn (err);\n}\nEXPORT_SYMBOL(z_uncompress);\n\nint\nspl_zlib_init(void)\n{\n\tint size;\n\n\tsize = MAX(zlib_deflate_workspacesize(MAX_WBITS, MAX_MEM_LEVEL),\n\t    zlib_inflate_workspacesize());\n\n\tzlib_workspace_cache = kmem_cache_create(\n\t    \"spl_zlib_workspace_cache\",\n\t    size, 0, NULL, NULL, NULL, NULL, NULL,\n\t    KMC_KVMEM);\n\tif (!zlib_workspace_cache)\n\t\treturn (-ENOMEM);\n\n\treturn (0);\n}\n\nvoid\nspl_zlib_fini(void)\n{\n\tkmem_cache_destroy(zlib_workspace_cache);\n\tzlib_workspace_cache = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}