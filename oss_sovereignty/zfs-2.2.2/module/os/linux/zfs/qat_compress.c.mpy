{
  "module_name": "qat_compress.c",
  "hash_id": "d325cc9cad821f0823e628953ad68407deaf00ebcfec5002e4ef7b5fc6bba58e",
  "original_prompt": "Ingested from zfs-2.2.2/module/os/linux/zfs/qat_compress.c",
  "human_readable_source": " \n\n#if defined(_KERNEL) && defined(HAVE_QAT)\n#include <linux/slab.h>\n#include <linux/vmalloc.h>\n#include <linux/pagemap.h>\n#include <linux/completion.h>\n#include <sys/zfs_context.h>\n#include <sys/byteorder.h>\n#include <sys/zio.h>\n#include <sys/qat.h>\n\n \n#define\tQAT_DC_MAX_INSTANCES\t48\n\n \n#define\tZLIB_HEAD_SZ\t\t2\n#define\tZLIB_FOOT_SZ\t\t4\n\nstatic CpaInstanceHandle dc_inst_handles[QAT_DC_MAX_INSTANCES];\nstatic CpaDcSessionHandle session_handles[QAT_DC_MAX_INSTANCES];\nstatic CpaBufferList **buffer_array[QAT_DC_MAX_INSTANCES];\nstatic Cpa16U num_inst = 0;\nstatic Cpa32U inst_num = 0;\nstatic boolean_t qat_dc_init_done = B_FALSE;\nint zfs_qat_compress_disable = 0;\n\nboolean_t\nqat_dc_use_accel(size_t s_len)\n{\n\treturn (!zfs_qat_compress_disable &&\n\t    qat_dc_init_done &&\n\t    s_len >= QAT_MIN_BUF_SIZE &&\n\t    s_len <= QAT_MAX_BUF_SIZE);\n}\n\nstatic void\nqat_dc_callback(void *p_callback, CpaStatus status)\n{\n\tif (p_callback != NULL)\n\t\tcomplete((struct completion *)p_callback);\n}\n\nstatic void\nqat_dc_clean(void)\n{\n\tCpa16U buff_num = 0;\n\tCpa16U num_inter_buff_lists = 0;\n\n\tfor (Cpa16U i = 0; i < num_inst; i++) {\n\t\tcpaDcStopInstance(dc_inst_handles[i]);\n\t\tQAT_PHYS_CONTIG_FREE(session_handles[i]);\n\t\t \n\t\tif (buffer_array[i] != NULL) {\n\t\t\tcpaDcGetNumIntermediateBuffers(\n\t\t\t    dc_inst_handles[i], &num_inter_buff_lists);\n\t\t\tfor (buff_num = 0; buff_num < num_inter_buff_lists;\n\t\t\t    buff_num++) {\n\t\t\t\tCpaBufferList *buffer_inter =\n\t\t\t\t    buffer_array[i][buff_num];\n\t\t\t\tif (buffer_inter->pBuffers) {\n\t\t\t\t\tQAT_PHYS_CONTIG_FREE(\n\t\t\t\t\t    buffer_inter->pBuffers->pData);\n\t\t\t\t\tQAT_PHYS_CONTIG_FREE(\n\t\t\t\t\t    buffer_inter->pBuffers);\n\t\t\t\t}\n\t\t\t\tQAT_PHYS_CONTIG_FREE(\n\t\t\t\t    buffer_inter->pPrivateMetaData);\n\t\t\t\tQAT_PHYS_CONTIG_FREE(buffer_inter);\n\t\t\t}\n\t\t}\n\t}\n\n\tnum_inst = 0;\n\tqat_dc_init_done = B_FALSE;\n}\n\nint\nqat_dc_init(void)\n{\n\tCpaStatus status = CPA_STATUS_SUCCESS;\n\tCpa32U sess_size = 0;\n\tCpa32U ctx_size = 0;\n\tCpa16U num_inter_buff_lists = 0;\n\tCpa16U buff_num = 0;\n\tCpa32U buff_meta_size = 0;\n\tCpaDcSessionSetupData sd = {0};\n\n\tif (qat_dc_init_done)\n\t\treturn (0);\n\n\tstatus = cpaDcGetNumInstances(&num_inst);\n\tif (status != CPA_STATUS_SUCCESS)\n\t\treturn (-1);\n\n\t \n\tif (num_inst == 0)\n\t\treturn (0);\n\n\tif (num_inst > QAT_DC_MAX_INSTANCES)\n\t\tnum_inst = QAT_DC_MAX_INSTANCES;\n\n\tstatus = cpaDcGetInstances(num_inst, &dc_inst_handles[0]);\n\tif (status != CPA_STATUS_SUCCESS)\n\t\treturn (-1);\n\n\tfor (Cpa16U i = 0; i < num_inst; i++) {\n\t\tcpaDcSetAddressTranslation(dc_inst_handles[i],\n\t\t    (void*)virt_to_phys);\n\n\t\tstatus = cpaDcBufferListGetMetaSize(dc_inst_handles[i],\n\t\t    1, &buff_meta_size);\n\n\t\tif (status == CPA_STATUS_SUCCESS)\n\t\t\tstatus = cpaDcGetNumIntermediateBuffers(\n\t\t\t    dc_inst_handles[i], &num_inter_buff_lists);\n\n\t\tif (status == CPA_STATUS_SUCCESS && num_inter_buff_lists != 0)\n\t\t\tstatus = QAT_PHYS_CONTIG_ALLOC(&buffer_array[i],\n\t\t\t    num_inter_buff_lists *\n\t\t\t    sizeof (CpaBufferList *));\n\n\t\tfor (buff_num = 0; buff_num < num_inter_buff_lists;\n\t\t    buff_num++) {\n\t\t\tif (status == CPA_STATUS_SUCCESS)\n\t\t\t\tstatus = QAT_PHYS_CONTIG_ALLOC(\n\t\t\t\t    &buffer_array[i][buff_num],\n\t\t\t\t    sizeof (CpaBufferList));\n\n\t\t\tif (status == CPA_STATUS_SUCCESS)\n\t\t\t\tstatus = QAT_PHYS_CONTIG_ALLOC(\n\t\t\t\t    &buffer_array[i][buff_num]->\n\t\t\t\t    pPrivateMetaData,\n\t\t\t\t    buff_meta_size);\n\n\t\t\tif (status == CPA_STATUS_SUCCESS)\n\t\t\t\tstatus = QAT_PHYS_CONTIG_ALLOC(\n\t\t\t\t    &buffer_array[i][buff_num]->pBuffers,\n\t\t\t\t    sizeof (CpaFlatBuffer));\n\n\t\t\tif (status == CPA_STATUS_SUCCESS) {\n\t\t\t\t \n\t\t\t\tstatus = QAT_PHYS_CONTIG_ALLOC(\n\t\t\t\t    &buffer_array[i][buff_num]->pBuffers->\n\t\t\t\t    pData, 2 * QAT_MAX_BUF_SIZE);\n\t\t\t\tif (status != CPA_STATUS_SUCCESS)\n\t\t\t\t\tgoto fail;\n\n\t\t\t\tbuffer_array[i][buff_num]->numBuffers = 1;\n\t\t\t\tbuffer_array[i][buff_num]->pBuffers->\n\t\t\t\t    dataLenInBytes = 2 * QAT_MAX_BUF_SIZE;\n\t\t\t}\n\t\t}\n\n\t\tstatus = cpaDcStartInstance(dc_inst_handles[i],\n\t\t    num_inter_buff_lists, buffer_array[i]);\n\t\tif (status != CPA_STATUS_SUCCESS)\n\t\t\tgoto fail;\n\n\t\tsd.compLevel = CPA_DC_L1;\n\t\tsd.compType = CPA_DC_DEFLATE;\n\t\tsd.huffType = CPA_DC_HT_FULL_DYNAMIC;\n\t\tsd.sessDirection = CPA_DC_DIR_COMBINED;\n\t\tsd.sessState = CPA_DC_STATELESS;\n#if (CPA_DC_API_VERSION_NUM_MAJOR == 1 && CPA_DC_API_VERSION_NUM_MINOR < 6)\n\t\tsd.deflateWindowSize = 7;\n#endif\n\t\tsd.checksum = CPA_DC_ADLER32;\n\t\tstatus = cpaDcGetSessionSize(dc_inst_handles[i],\n\t\t    &sd, &sess_size, &ctx_size);\n\t\tif (status != CPA_STATUS_SUCCESS)\n\t\t\tgoto fail;\n\n\t\tQAT_PHYS_CONTIG_ALLOC(&session_handles[i], sess_size);\n\t\tif (session_handles[i] == NULL)\n\t\t\tgoto fail;\n\n\t\tstatus = cpaDcInitSession(dc_inst_handles[i],\n\t\t    session_handles[i],\n\t\t    &sd, NULL, qat_dc_callback);\n\t\tif (status != CPA_STATUS_SUCCESS)\n\t\t\tgoto fail;\n\t}\n\n\tqat_dc_init_done = B_TRUE;\n\treturn (0);\nfail:\n\tqat_dc_clean();\n\treturn (-1);\n}\n\nvoid\nqat_dc_fini(void)\n{\n\tif (!qat_dc_init_done)\n\t\treturn;\n\n\tqat_dc_clean();\n}\n\n \nstatic int\nqat_compress_impl(qat_compress_dir_t dir, char *src, int src_len,\n    char *dst, int dst_len, char *add, int add_len, size_t *c_len)\n{\n\tCpaInstanceHandle dc_inst_handle;\n\tCpaDcSessionHandle session_handle;\n\tCpaBufferList *buf_list_src = NULL;\n\tCpaBufferList *buf_list_dst = NULL;\n\tCpaFlatBuffer *flat_buf_src = NULL;\n\tCpaFlatBuffer *flat_buf_dst = NULL;\n\tCpa8U *buffer_meta_src = NULL;\n\tCpa8U *buffer_meta_dst = NULL;\n\tCpa32U buffer_meta_size = 0;\n\tCpaDcRqResults dc_results = {.checksum = 1};\n\tCpaStatus status = CPA_STATUS_FAIL;\n\tCpa32U hdr_sz = 0;\n\tCpa32U compressed_sz;\n\tCpa32U num_src_buf = (src_len >> PAGE_SHIFT) + 2;\n\tCpa32U num_dst_buf = (dst_len >> PAGE_SHIFT) + 2;\n\tCpa32U num_add_buf = (add_len >> PAGE_SHIFT) + 2;\n\tCpa32U bytes_left;\n\tCpa32U dst_pages = 0;\n\tCpa32U adler32 = 0;\n\tchar *data;\n\tstruct page *page;\n\tstruct page **in_pages = NULL;\n\tstruct page **out_pages = NULL;\n\tstruct page **add_pages = NULL;\n\tCpa32U page_off = 0;\n\tstruct completion complete;\n\tCpa32U page_num = 0;\n\tCpa16U i;\n\n\t \n\tCpa32U src_buffer_list_mem_size = sizeof (CpaBufferList) +\n\t    (num_src_buf * sizeof (CpaFlatBuffer));\n\tCpa32U dst_buffer_list_mem_size = sizeof (CpaBufferList) +\n\t    ((num_dst_buf + num_add_buf) * sizeof (CpaFlatBuffer));\n\n\tstatus = QAT_PHYS_CONTIG_ALLOC(&in_pages,\n\t    num_src_buf * sizeof (struct page *));\n\tif (status != CPA_STATUS_SUCCESS)\n\t\tgoto fail;\n\n\tstatus = QAT_PHYS_CONTIG_ALLOC(&out_pages,\n\t    num_dst_buf * sizeof (struct page *));\n\tif (status != CPA_STATUS_SUCCESS)\n\t\tgoto fail;\n\n\tstatus = QAT_PHYS_CONTIG_ALLOC(&add_pages,\n\t    num_add_buf * sizeof (struct page *));\n\tif (status != CPA_STATUS_SUCCESS)\n\t\tgoto fail;\n\n\ti = (Cpa32U)atomic_inc_32_nv(&inst_num) % num_inst;\n\tdc_inst_handle = dc_inst_handles[i];\n\tsession_handle = session_handles[i];\n\n\tcpaDcBufferListGetMetaSize(dc_inst_handle, num_src_buf,\n\t    &buffer_meta_size);\n\tstatus = QAT_PHYS_CONTIG_ALLOC(&buffer_meta_src, buffer_meta_size);\n\tif (status != CPA_STATUS_SUCCESS)\n\t\tgoto fail;\n\n\tcpaDcBufferListGetMetaSize(dc_inst_handle, num_dst_buf + num_add_buf,\n\t    &buffer_meta_size);\n\tstatus = QAT_PHYS_CONTIG_ALLOC(&buffer_meta_dst, buffer_meta_size);\n\tif (status != CPA_STATUS_SUCCESS)\n\t\tgoto fail;\n\n\t \n\tstatus = QAT_PHYS_CONTIG_ALLOC(&buf_list_src, src_buffer_list_mem_size);\n\tif (status != CPA_STATUS_SUCCESS)\n\t\tgoto fail;\n\n\tflat_buf_src = (CpaFlatBuffer *)(buf_list_src + 1);\n\n\tbuf_list_src->pBuffers = flat_buf_src;  \n\n\t \n\tstatus = QAT_PHYS_CONTIG_ALLOC(&buf_list_dst, dst_buffer_list_mem_size);\n\tif (status != CPA_STATUS_SUCCESS)\n\t\tgoto fail;\n\n\tflat_buf_dst = (CpaFlatBuffer *)(buf_list_dst + 1);\n\n\tbuf_list_dst->pBuffers = flat_buf_dst;  \n\n\tbuf_list_src->numBuffers = 0;\n\tbuf_list_src->pPrivateMetaData = buffer_meta_src;\n\tbytes_left = src_len;\n\tdata = src;\n\tpage_num = 0;\n\twhile (bytes_left > 0) {\n\t\tpage_off = ((long)data & ~PAGE_MASK);\n\t\tpage = qat_mem_to_page(data);\n\t\tin_pages[page_num] = page;\n\t\tflat_buf_src->pData = kmap(page) + page_off;\n\t\tflat_buf_src->dataLenInBytes =\n\t\t    min((long)PAGE_SIZE - page_off, (long)bytes_left);\n\n\t\tbytes_left -= flat_buf_src->dataLenInBytes;\n\t\tdata += flat_buf_src->dataLenInBytes;\n\t\tflat_buf_src++;\n\t\tbuf_list_src->numBuffers++;\n\t\tpage_num++;\n\t}\n\n\tbuf_list_dst->numBuffers = 0;\n\tbuf_list_dst->pPrivateMetaData = buffer_meta_dst;\n\tbytes_left = dst_len;\n\tdata = dst;\n\tpage_num = 0;\n\twhile (bytes_left > 0) {\n\t\tpage_off = ((long)data & ~PAGE_MASK);\n\t\tpage = qat_mem_to_page(data);\n\t\tflat_buf_dst->pData = kmap(page) + page_off;\n\t\tout_pages[page_num] = page;\n\t\tflat_buf_dst->dataLenInBytes =\n\t\t    min((long)PAGE_SIZE - page_off, (long)bytes_left);\n\n\t\tbytes_left -= flat_buf_dst->dataLenInBytes;\n\t\tdata += flat_buf_dst->dataLenInBytes;\n\t\tflat_buf_dst++;\n\t\tbuf_list_dst->numBuffers++;\n\t\tpage_num++;\n\t\tdst_pages++;\n\t}\n\n\t \n\tbytes_left = add_len;\n\tdata = add;\n\tpage_num = 0;\n\twhile (bytes_left > 0) {\n\t\tpage_off = ((long)data & ~PAGE_MASK);\n\t\tpage = qat_mem_to_page(data);\n\t\tflat_buf_dst->pData = kmap(page) + page_off;\n\t\tadd_pages[page_num] = page;\n\t\tflat_buf_dst->dataLenInBytes =\n\t\t    min((long)PAGE_SIZE - page_off, (long)bytes_left);\n\n\t\tbytes_left -= flat_buf_dst->dataLenInBytes;\n\t\tdata += flat_buf_dst->dataLenInBytes;\n\t\tflat_buf_dst++;\n\t\tbuf_list_dst->numBuffers++;\n\t\tpage_num++;\n\t}\n\n\tinit_completion(&complete);\n\n\tif (dir == QAT_COMPRESS) {\n\t\tQAT_STAT_BUMP(comp_requests);\n\t\tQAT_STAT_INCR(comp_total_in_bytes, src_len);\n\n\t\tcpaDcGenerateHeader(session_handle,\n\t\t    buf_list_dst->pBuffers, &hdr_sz);\n\t\tbuf_list_dst->pBuffers->pData += hdr_sz;\n\t\tbuf_list_dst->pBuffers->dataLenInBytes -= hdr_sz;\n\t\tstatus = cpaDcCompressData(\n\t\t    dc_inst_handle, session_handle,\n\t\t    buf_list_src, buf_list_dst,\n\t\t    &dc_results, CPA_DC_FLUSH_FINAL,\n\t\t    &complete);\n\t\tif (status != CPA_STATUS_SUCCESS) {\n\t\t\tgoto fail;\n\t\t}\n\n\t\t \n\t\twait_for_completion(&complete);\n\n\t\tif (dc_results.status != CPA_STATUS_SUCCESS) {\n\t\t\tstatus = CPA_STATUS_FAIL;\n\t\t\tgoto fail;\n\t\t}\n\n\t\tcompressed_sz = dc_results.produced;\n\t\tif (compressed_sz + hdr_sz + ZLIB_FOOT_SZ > dst_len) {\n\t\t\tstatus = CPA_STATUS_INCOMPRESSIBLE;\n\t\t\tgoto fail;\n\t\t}\n\n\t\t \n\t\t*(Cpa32U*)(dst + hdr_sz + compressed_sz) =\n\t\t    BSWAP_32(dc_results.checksum);\n\n\t\t*c_len = hdr_sz + compressed_sz + ZLIB_FOOT_SZ;\n\t\tQAT_STAT_INCR(comp_total_out_bytes, *c_len);\n\t} else {\n\t\tASSERT3U(dir, ==, QAT_DECOMPRESS);\n\t\tQAT_STAT_BUMP(decomp_requests);\n\t\tQAT_STAT_INCR(decomp_total_in_bytes, src_len);\n\n\t\tbuf_list_src->pBuffers->pData += ZLIB_HEAD_SZ;\n\t\tbuf_list_src->pBuffers->dataLenInBytes -= ZLIB_HEAD_SZ;\n\t\tstatus = cpaDcDecompressData(dc_inst_handle, session_handle,\n\t\t    buf_list_src, buf_list_dst, &dc_results, CPA_DC_FLUSH_FINAL,\n\t\t    &complete);\n\n\t\tif (CPA_STATUS_SUCCESS != status) {\n\t\t\tstatus = CPA_STATUS_FAIL;\n\t\t\tgoto fail;\n\t\t}\n\n\t\t \n\t\twait_for_completion(&complete);\n\n\t\tif (dc_results.status != CPA_STATUS_SUCCESS) {\n\t\t\tstatus = CPA_STATUS_FAIL;\n\t\t\tgoto fail;\n\t\t}\n\n\t\t \n\t\tadler32 = *(Cpa32U *)(src + dc_results.consumed + ZLIB_HEAD_SZ);\n\t\tif (adler32 != BSWAP_32(dc_results.checksum)) {\n\t\t\tstatus = CPA_STATUS_FAIL;\n\t\t\tgoto fail;\n\t\t}\n\t\t*c_len = dc_results.produced;\n\t\tQAT_STAT_INCR(decomp_total_out_bytes, *c_len);\n\t}\n\nfail:\n\tif (status != CPA_STATUS_SUCCESS && status != CPA_STATUS_INCOMPRESSIBLE)\n\t\tQAT_STAT_BUMP(dc_fails);\n\n\tif (in_pages) {\n\t\tfor (page_num = 0;\n\t\t    page_num < buf_list_src->numBuffers;\n\t\t    page_num++) {\n\t\t\tkunmap(in_pages[page_num]);\n\t\t}\n\t\tQAT_PHYS_CONTIG_FREE(in_pages);\n\t}\n\n\tif (out_pages) {\n\t\tfor (page_num = 0; page_num < dst_pages; page_num++) {\n\t\t\tkunmap(out_pages[page_num]);\n\t\t}\n\t\tQAT_PHYS_CONTIG_FREE(out_pages);\n\t}\n\n\tif (add_pages) {\n\t\tfor (page_num = 0;\n\t\t    page_num < buf_list_dst->numBuffers - dst_pages;\n\t\t    page_num++) {\n\t\t\tkunmap(add_pages[page_num]);\n\t\t}\n\t\tQAT_PHYS_CONTIG_FREE(add_pages);\n\t}\n\n\tQAT_PHYS_CONTIG_FREE(buffer_meta_src);\n\tQAT_PHYS_CONTIG_FREE(buffer_meta_dst);\n\tQAT_PHYS_CONTIG_FREE(buf_list_src);\n\tQAT_PHYS_CONTIG_FREE(buf_list_dst);\n\n\treturn (status);\n}\n\n \nint\nqat_compress(qat_compress_dir_t dir, char *src, int src_len,\n    char *dst, int dst_len, size_t *c_len)\n{\n\tint ret;\n\tsize_t add_len = 0;\n\tvoid *add = NULL;\n\n\tif (dir == QAT_COMPRESS) {\n\t\tadd_len = dst_len;\n\t\tadd = zio_data_buf_alloc(add_len);\n\t}\n\n\tret = qat_compress_impl(dir, src, src_len, dst,\n\t    dst_len, add, add_len, c_len);\n\n\tif (dir == QAT_COMPRESS)\n\t\tzio_data_buf_free(add, add_len);\n\n\treturn (ret);\n}\n\nstatic int\nparam_set_qat_compress(const char *val, zfs_kernel_param_t *kp)\n{\n\tint ret;\n\tint *pvalue = kp->arg;\n\tret = param_set_int(val, kp);\n\tif (ret)\n\t\treturn (ret);\n\t \n\tif (*pvalue == 0 && !qat_dc_init_done) {\n\t\tret = qat_dc_init();\n\t\tif (ret != 0) {\n\t\t\tzfs_qat_compress_disable = 1;\n\t\t\treturn (ret);\n\t\t}\n\t}\n\treturn (ret);\n}\n\nmodule_param_call(zfs_qat_compress_disable, param_set_qat_compress,\n    param_get_int, &zfs_qat_compress_disable, 0644);\nMODULE_PARM_DESC(zfs_qat_compress_disable, \"Enable/Disable QAT compression\");\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}