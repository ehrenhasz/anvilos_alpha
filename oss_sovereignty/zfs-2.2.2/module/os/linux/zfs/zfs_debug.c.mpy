{
  "module_name": "zfs_debug.c",
  "hash_id": "8e013e6e6ac12ab4451575031fb28f7e97b1787ad74c473b98a0133212508475",
  "original_prompt": "Ingested from zfs-2.2.2/module/os/linux/zfs/zfs_debug.c",
  "human_readable_source": " \n \n\n#include <sys/zfs_context.h>\n#include <sys/trace_zfs.h>\n\ntypedef struct zfs_dbgmsg {\n\tprocfs_list_node_t\tzdm_node;\n\tuint64_t\t\tzdm_timestamp;\n\tuint_t\t\t\tzdm_size;\n\tchar\t\t\tzdm_msg[];  \n} zfs_dbgmsg_t;\n\nstatic procfs_list_t zfs_dbgmsgs;\nstatic uint_t zfs_dbgmsg_size = 0;\nstatic uint_t zfs_dbgmsg_maxsize = 4<<20;  \n\n \nint zfs_dbgmsg_enable = B_TRUE;\n\nstatic int\nzfs_dbgmsg_show_header(struct seq_file *f)\n{\n\tseq_printf(f, \"%-12s %-8s\\n\", \"timestamp\", \"message\");\n\treturn (0);\n}\n\nstatic int\nzfs_dbgmsg_show(struct seq_file *f, void *p)\n{\n\tzfs_dbgmsg_t *zdm = (zfs_dbgmsg_t *)p;\n\tseq_printf(f, \"%-12llu %-s\\n\",\n\t    (u_longlong_t)zdm->zdm_timestamp, zdm->zdm_msg);\n\treturn (0);\n}\n\nstatic void\nzfs_dbgmsg_purge(uint_t max_size)\n{\n\twhile (zfs_dbgmsg_size > max_size) {\n\t\tzfs_dbgmsg_t *zdm = list_remove_head(&zfs_dbgmsgs.pl_list);\n\t\tif (zdm == NULL)\n\t\t\treturn;\n\n\t\tuint_t size = zdm->zdm_size;\n\t\tkmem_free(zdm, size);\n\t\tzfs_dbgmsg_size -= size;\n\t}\n}\n\nstatic int\nzfs_dbgmsg_clear(procfs_list_t *procfs_list)\n{\n\t(void) procfs_list;\n\tmutex_enter(&zfs_dbgmsgs.pl_lock);\n\tzfs_dbgmsg_purge(0);\n\tmutex_exit(&zfs_dbgmsgs.pl_lock);\n\treturn (0);\n}\n\nvoid\nzfs_dbgmsg_init(void)\n{\n\tprocfs_list_install(\"zfs\",\n\t    NULL,\n\t    \"dbgmsg\",\n\t    0600,\n\t    &zfs_dbgmsgs,\n\t    zfs_dbgmsg_show,\n\t    zfs_dbgmsg_show_header,\n\t    zfs_dbgmsg_clear,\n\t    offsetof(zfs_dbgmsg_t, zdm_node));\n}\n\nvoid\nzfs_dbgmsg_fini(void)\n{\n\tprocfs_list_uninstall(&zfs_dbgmsgs);\n\tzfs_dbgmsg_purge(0);\n\n\t \n#ifdef _KERNEL\n\tprocfs_list_destroy(&zfs_dbgmsgs);\n#endif\n}\n\nvoid\n__set_error(const char *file, const char *func, int line, int err)\n{\n\t \n\tif (zfs_flags & ZFS_DEBUG_SET_ERROR)\n\t\t__dprintf(B_FALSE, file, func, line, \"error %lu\",\n\t\t    (ulong_t)err);\n}\n\nvoid\n__zfs_dbgmsg(char *buf)\n{\n\tuint_t size = sizeof (zfs_dbgmsg_t) + strlen(buf) + 1;\n\tzfs_dbgmsg_t *zdm = kmem_zalloc(size, KM_SLEEP);\n\tzdm->zdm_size = size;\n\tzdm->zdm_timestamp = gethrestime_sec();\n\tstrcpy(zdm->zdm_msg, buf);\n\n\tmutex_enter(&zfs_dbgmsgs.pl_lock);\n\tprocfs_list_add(&zfs_dbgmsgs, zdm);\n\tzfs_dbgmsg_size += size;\n\tzfs_dbgmsg_purge(zfs_dbgmsg_maxsize);\n\tmutex_exit(&zfs_dbgmsgs.pl_lock);\n}\n\n#ifdef _KERNEL\n\nvoid\n__dprintf(boolean_t dprint, const char *file, const char *func,\n    int line, const char *fmt, ...)\n{\n\tconst char *newfile;\n\tva_list adx;\n\tsize_t size;\n\tchar *buf;\n\tchar *nl;\n\tint i;\n\tchar *prefix = (dprint) ? \"dprintf: \" : \"\";\n\n\tsize = 1024;\n\tbuf = kmem_alloc(size, KM_SLEEP);\n\n\t \n\tnewfile = strrchr(file, '/');\n\tif (newfile != NULL) {\n\t\tnewfile = newfile + 1;  \n\t} else {\n\t\tnewfile = file;\n\t}\n\n\ti = snprintf(buf, size, \"%s%s:%d:%s(): \", prefix, newfile, line, func);\n\n\tif (i < size) {\n\t\tva_start(adx, fmt);\n\t\t(void) vsnprintf(buf + i, size - i, fmt, adx);\n\t\tva_end(adx);\n\t}\n\n\t \n\tif (dprint && buf[0] != '\\0') {\n\t\tnl = &buf[strlen(buf) - 1];\n\t\tif (*nl == '\\n')\n\t\t\t*nl = '\\0';\n\t}\n\n\t \n\tDTRACE_PROBE1(zfs__dprintf, char *, buf);\n\n\t \n\t__zfs_dbgmsg(buf);\n\n\tkmem_free(buf, size);\n}\n\n#else\n\nvoid\nzfs_dbgmsg_print(const char *tag)\n{\n\tssize_t ret __attribute__((unused));\n\n\t \n\tret = write(STDOUT_FILENO, \"ZFS_DBGMSG(\", 11);\n\tret = write(STDOUT_FILENO, tag, strlen(tag));\n\tret = write(STDOUT_FILENO, \") START:\\n\", 9);\n\n\tmutex_enter(&zfs_dbgmsgs.pl_lock);\n\tfor (zfs_dbgmsg_t *zdm = list_head(&zfs_dbgmsgs.pl_list); zdm != NULL;\n\t    zdm = list_next(&zfs_dbgmsgs.pl_list, zdm)) {\n\t\tret = write(STDOUT_FILENO, zdm->zdm_msg,\n\t\t    strlen(zdm->zdm_msg));\n\t\tret = write(STDOUT_FILENO, \"\\n\", 1);\n\t}\n\n\tret = write(STDOUT_FILENO, \"ZFS_DBGMSG(\", 11);\n\tret = write(STDOUT_FILENO, tag, strlen(tag));\n\tret = write(STDOUT_FILENO, \") END\\n\", 6);\n\n\tmutex_exit(&zfs_dbgmsgs.pl_lock);\n}\n#endif  \n\n#ifdef _KERNEL\nmodule_param(zfs_dbgmsg_enable, int, 0644);\nMODULE_PARM_DESC(zfs_dbgmsg_enable, \"Enable ZFS debug message log\");\n\n \nmodule_param(zfs_dbgmsg_maxsize, uint, 0644);\n \nMODULE_PARM_DESC(zfs_dbgmsg_maxsize, \"Maximum ZFS debug log size\");\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}