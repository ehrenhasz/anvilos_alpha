{
  "module_name": "zfs_fletcher_avx512.c",
  "hash_id": "8380ba9c872f44062cd708391b9023473668846ede9aaed759528c84e590c66d",
  "original_prompt": "Ingested from zfs-2.2.2/module/zcommon/zfs_fletcher_avx512.c",
  "human_readable_source": " \n \n\n#if defined(__x86_64) && defined(HAVE_AVX512F)\n\n#include <sys/byteorder.h>\n#include <sys/frame.h>\n#include <sys/spa_checksum.h>\n#include <sys/string.h>\n#include <sys/simd.h>\n#include <zfs_fletcher.h>\n\n#ifdef __linux__\n#define\t__asm __asm__ __volatile__\n#endif\n\nstatic void\nfletcher_4_avx512f_init(fletcher_4_ctx_t *ctx)\n{\n\tmemset(ctx->avx512, 0, 4 * sizeof (zfs_fletcher_avx512_t));\n}\n\nstatic void\nfletcher_4_avx512f_fini(fletcher_4_ctx_t *ctx, zio_cksum_t *zcp)\n{\n\tstatic const uint64_t\n\tCcA[] = {   0,   0,   1,   3,   6,  10,  15,  21 },\n\tCcB[] = {  28,  36,  44,  52,  60,  68,  76,  84 },\n\tDcA[] = {   0,   0,   0,   1,   4,  10,  20,  35 },\n\tDcB[] = {  56,  84, 120, 164, 216, 276, 344, 420 },\n\tDcC[] = { 448, 512, 576, 640, 704, 768, 832, 896 };\n\n\tuint64_t A, B, C, D;\n\tuint64_t i;\n\n\tA = ctx->avx512[0].v[0];\n\tB = 8 * ctx->avx512[1].v[0];\n\tC = 64 * ctx->avx512[2].v[0] - CcB[0] * ctx->avx512[1].v[0];\n\tD = 512 * ctx->avx512[3].v[0] - DcC[0] * ctx->avx512[2].v[0] +\n\t    DcB[0] * ctx->avx512[1].v[0];\n\n\tfor (i = 1; i < 8; i++) {\n\t\tA += ctx->avx512[0].v[i];\n\t\tB += 8 * ctx->avx512[1].v[i] - i * ctx->avx512[0].v[i];\n\t\tC += 64 * ctx->avx512[2].v[i] - CcB[i] * ctx->avx512[1].v[i] +\n\t\t    CcA[i] * ctx->avx512[0].v[i];\n\t\tD += 512 * ctx->avx512[3].v[i] - DcC[i] * ctx->avx512[2].v[i] +\n\t\t    DcB[i] * ctx->avx512[1].v[i] - DcA[i] * ctx->avx512[0].v[i];\n\t}\n\n\tZIO_SET_CHECKSUM(zcp, A, B, C, D);\n}\n\n#define\tFLETCHER_4_AVX512_RESTORE_CTX(ctx)\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\t__asm(\"vmovdqu64 %0, %%zmm0\" :: \"m\" ((ctx)->avx512[0]));\t\\\n\t__asm(\"vmovdqu64 %0, %%zmm1\" :: \"m\" ((ctx)->avx512[1]));\t\\\n\t__asm(\"vmovdqu64 %0, %%zmm2\" :: \"m\" ((ctx)->avx512[2]));\t\\\n\t__asm(\"vmovdqu64 %0, %%zmm3\" :: \"m\" ((ctx)->avx512[3]));\t\\\n}\n\n#define\tFLETCHER_4_AVX512_SAVE_CTX(ctx)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\t__asm(\"vmovdqu64 %%zmm0, %0\" : \"=m\" ((ctx)->avx512[0]));\t\\\n\t__asm(\"vmovdqu64 %%zmm1, %0\" : \"=m\" ((ctx)->avx512[1]));\t\\\n\t__asm(\"vmovdqu64 %%zmm2, %0\" : \"=m\" ((ctx)->avx512[2]));\t\\\n\t__asm(\"vmovdqu64 %%zmm3, %0\" : \"=m\" ((ctx)->avx512[3]));\t\\\n}\n\nstatic void\nfletcher_4_avx512f_native(fletcher_4_ctx_t *ctx, const void *buf, uint64_t size)\n{\n\tconst uint32_t *ip = buf;\n\tconst uint32_t *ipend = (uint32_t *)((uint8_t *)ip + size);\n\n\tFLETCHER_4_AVX512_RESTORE_CTX(ctx);\n\n\tdo {\n\t\t__asm(\"vpmovzxdq %0, %%zmm4\"::\"m\" (*ip));\n\t\t__asm(\"vpaddq %zmm4, %zmm0, %zmm0\");\n\t\t__asm(\"vpaddq %zmm0, %zmm1, %zmm1\");\n\t\t__asm(\"vpaddq %zmm1, %zmm2, %zmm2\");\n\t\t__asm(\"vpaddq %zmm2, %zmm3, %zmm3\");\n\t} while ((ip += 8) < ipend);\n\n\tFLETCHER_4_AVX512_SAVE_CTX(ctx);\n}\nSTACK_FRAME_NON_STANDARD(fletcher_4_avx512f_native);\n\nstatic void\nfletcher_4_avx512f_byteswap(fletcher_4_ctx_t *ctx, const void *buf,\n    uint64_t size)\n{\n\tstatic const uint64_t byteswap_mask = 0xFFULL;\n\tconst uint32_t *ip = buf;\n\tconst uint32_t *ipend = (uint32_t *)((uint8_t *)ip + size);\n\n\tFLETCHER_4_AVX512_RESTORE_CTX(ctx);\n\n\t__asm(\"vpbroadcastq %0, %%zmm8\" :: \"r\" (byteswap_mask));\n\t__asm(\"vpsllq $8, %zmm8, %zmm9\");\n\t__asm(\"vpsllq $16, %zmm8, %zmm10\");\n\t__asm(\"vpsllq $24, %zmm8, %zmm11\");\n\n\tdo {\n\t\t__asm(\"vpmovzxdq %0, %%zmm5\"::\"m\" (*ip));\n\n\t\t__asm(\"vpsrlq $24, %zmm5, %zmm6\");\n\t\t__asm(\"vpandd %zmm8, %zmm6, %zmm6\");\n\t\t__asm(\"vpsrlq $8, %zmm5, %zmm7\");\n\t\t__asm(\"vpandd %zmm9, %zmm7, %zmm7\");\n\t\t__asm(\"vpord %zmm6, %zmm7, %zmm4\");\n\t\t__asm(\"vpsllq $8, %zmm5, %zmm6\");\n\t\t__asm(\"vpandd %zmm10, %zmm6, %zmm6\");\n\t\t__asm(\"vpord %zmm6, %zmm4, %zmm4\");\n\t\t__asm(\"vpsllq $24, %zmm5, %zmm5\");\n\t\t__asm(\"vpandd %zmm11, %zmm5, %zmm5\");\n\t\t__asm(\"vpord %zmm5, %zmm4, %zmm4\");\n\n\t\t__asm(\"vpaddq %zmm4, %zmm0, %zmm0\");\n\t\t__asm(\"vpaddq %zmm0, %zmm1, %zmm1\");\n\t\t__asm(\"vpaddq %zmm1, %zmm2, %zmm2\");\n\t\t__asm(\"vpaddq %zmm2, %zmm3, %zmm3\");\n\t} while ((ip += 8) < ipend);\n\n\tFLETCHER_4_AVX512_SAVE_CTX(ctx)\n}\nSTACK_FRAME_NON_STANDARD(fletcher_4_avx512f_byteswap);\n\nstatic boolean_t\nfletcher_4_avx512f_valid(void)\n{\n\treturn (kfpu_allowed() && zfs_avx512f_available());\n}\n\nconst fletcher_4_ops_t fletcher_4_avx512f_ops = {\n\t.init_native = fletcher_4_avx512f_init,\n\t.fini_native = fletcher_4_avx512f_fini,\n\t.compute_native = fletcher_4_avx512f_native,\n\t.init_byteswap = fletcher_4_avx512f_init,\n\t.fini_byteswap = fletcher_4_avx512f_fini,\n\t.compute_byteswap = fletcher_4_avx512f_byteswap,\n\t.valid = fletcher_4_avx512f_valid,\n\t.uses_fpu = B_TRUE,\n\t.name = \"avx512f\"\n};\n\n#if defined(HAVE_AVX512BW)\nstatic void\nfletcher_4_avx512bw_byteswap(fletcher_4_ctx_t *ctx, const void *buf,\n    uint64_t size)\n{\n\tstatic const zfs_fletcher_avx512_t mask = {\n\t\t.v = { 0xFFFFFFFF00010203, 0xFFFFFFFF08090A0B,\n\t\t0xFFFFFFFF00010203, 0xFFFFFFFF08090A0B,\n\t\t0xFFFFFFFF00010203, 0xFFFFFFFF08090A0B,\n\t\t0xFFFFFFFF00010203, 0xFFFFFFFF08090A0B }\n\t};\n\tconst uint32_t *ip = buf;\n\tconst uint32_t *ipend = (uint32_t *)((uint8_t *)ip + size);\n\n\tFLETCHER_4_AVX512_RESTORE_CTX(ctx);\n\n\t__asm(\"vmovdqu64 %0, %%zmm5\" :: \"m\" (mask));\n\n\tdo {\n\t\t__asm(\"vpmovzxdq %0, %%zmm4\"::\"m\" (*ip));\n\n\t\t__asm(\"vpshufb %zmm5, %zmm4, %zmm4\");\n\n\t\t__asm(\"vpaddq %zmm4, %zmm0, %zmm0\");\n\t\t__asm(\"vpaddq %zmm0, %zmm1, %zmm1\");\n\t\t__asm(\"vpaddq %zmm1, %zmm2, %zmm2\");\n\t\t__asm(\"vpaddq %zmm2, %zmm3, %zmm3\");\n\t} while ((ip += 8) < ipend);\n\n\tFLETCHER_4_AVX512_SAVE_CTX(ctx)\n}\nSTACK_FRAME_NON_STANDARD(fletcher_4_avx512bw_byteswap);\n\nstatic boolean_t\nfletcher_4_avx512bw_valid(void)\n{\n\treturn (fletcher_4_avx512f_valid() && zfs_avx512bw_available());\n}\n\nconst fletcher_4_ops_t fletcher_4_avx512bw_ops = {\n\t.init_native = fletcher_4_avx512f_init,\n\t.fini_native = fletcher_4_avx512f_fini,\n\t.compute_native = fletcher_4_avx512f_native,\n\t.init_byteswap = fletcher_4_avx512f_init,\n\t.fini_byteswap = fletcher_4_avx512f_fini,\n\t.compute_byteswap = fletcher_4_avx512bw_byteswap,\n\t.valid = fletcher_4_avx512bw_valid,\n\t.uses_fpu = B_TRUE,\n\t.name = \"avx512bw\"\n};\n#endif\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}