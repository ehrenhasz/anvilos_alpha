{
  "module_name": "zfs_deleg.c",
  "hash_id": "41bf64a30fb367bd1bbe981bfea53d02e875ae22417d0897d0f8e8303fcf5ee1",
  "original_prompt": "Ingested from zfs-2.2.2/module/zcommon/zfs_deleg.c",
  "human_readable_source": " \n \n\n#include <sys/zfs_context.h>\n\n#if defined(_KERNEL)\n#include <sys/sunddi.h>\n#include <sys/ctype.h>\n#else\n#include <stdio.h>\n#include <unistd.h>\n#include <libnvpair.h>\n#include <ctype.h>\n#endif\n#include <sys/string.h>\n#include <sys/dsl_deleg.h>\n#include \"zfs_prop.h\"\n#include \"zfs_deleg.h\"\n#include \"zfs_namecheck.h\"\n\nconst zfs_deleg_perm_tab_t zfs_deleg_perm_tab[] = {\n\t{ZFS_DELEG_PERM_ALLOW},\n\t{ZFS_DELEG_PERM_BOOKMARK},\n\t{ZFS_DELEG_PERM_CLONE},\n\t{ZFS_DELEG_PERM_CREATE},\n\t{ZFS_DELEG_PERM_DESTROY},\n\t{ZFS_DELEG_PERM_DIFF},\n\t{ZFS_DELEG_PERM_MOUNT},\n\t{ZFS_DELEG_PERM_PROMOTE},\n\t{ZFS_DELEG_PERM_RECEIVE},\n\t{ZFS_DELEG_PERM_RENAME},\n\t{ZFS_DELEG_PERM_ROLLBACK},\n\t{ZFS_DELEG_PERM_SNAPSHOT},\n\t{ZFS_DELEG_PERM_SHARE},\n\t{ZFS_DELEG_PERM_SEND},\n\t{ZFS_DELEG_PERM_USERPROP},\n\t{ZFS_DELEG_PERM_USERQUOTA},\n\t{ZFS_DELEG_PERM_GROUPQUOTA},\n\t{ZFS_DELEG_PERM_USERUSED},\n\t{ZFS_DELEG_PERM_GROUPUSED},\n\t{ZFS_DELEG_PERM_USEROBJQUOTA},\n\t{ZFS_DELEG_PERM_GROUPOBJQUOTA},\n\t{ZFS_DELEG_PERM_USEROBJUSED},\n\t{ZFS_DELEG_PERM_GROUPOBJUSED},\n\t{ZFS_DELEG_PERM_HOLD},\n\t{ZFS_DELEG_PERM_RELEASE},\n\t{ZFS_DELEG_PERM_LOAD_KEY},\n\t{ZFS_DELEG_PERM_CHANGE_KEY},\n\t{ZFS_DELEG_PERM_PROJECTUSED},\n\t{ZFS_DELEG_PERM_PROJECTQUOTA},\n\t{ZFS_DELEG_PERM_PROJECTOBJUSED},\n\t{ZFS_DELEG_PERM_PROJECTOBJQUOTA},\n\t{NULL}\n};\n\nstatic int\nzfs_valid_permission_name(const char *perm)\n{\n\tif (zfs_deleg_canonicalize_perm(perm))\n\t\treturn (0);\n\n\treturn (permset_namecheck(perm, NULL, NULL));\n}\n\nconst char *\nzfs_deleg_canonicalize_perm(const char *perm)\n{\n\tfor (int i = 0; zfs_deleg_perm_tab[i].z_perm != NULL; i++) {\n\t\tif (strcmp(perm, zfs_deleg_perm_tab[i].z_perm) == 0)\n\t\t\treturn (perm);\n\t}\n\n\tzfs_prop_t prop = zfs_name_to_prop(perm);\n\tif (prop != ZPROP_INVAL && zfs_prop_delegatable(prop))\n\t\treturn (zfs_prop_to_name(prop));\n\treturn (NULL);\n\n}\n\nstatic int\nzfs_validate_who(const char *who)\n{\n\tconst char *p;\n\n\tif (who[2] != ZFS_DELEG_FIELD_SEP_CHR)\n\t\treturn (-1);\n\n\tswitch (who[0]) {\n\tcase ZFS_DELEG_USER:\n\tcase ZFS_DELEG_GROUP:\n\tcase ZFS_DELEG_USER_SETS:\n\tcase ZFS_DELEG_GROUP_SETS:\n\t\tif (who[1] != ZFS_DELEG_LOCAL && who[1] != ZFS_DELEG_DESCENDENT)\n\t\t\treturn (-1);\n\t\tfor (p = &who[3]; *p; p++)\n\t\t\tif (!isdigit(*p))\n\t\t\t\treturn (-1);\n\t\tbreak;\n\n\tcase ZFS_DELEG_NAMED_SET:\n\tcase ZFS_DELEG_NAMED_SET_SETS:\n\t\tif (who[1] != ZFS_DELEG_NA)\n\t\t\treturn (-1);\n\t\treturn (permset_namecheck(&who[3], NULL, NULL));\n\n\tcase ZFS_DELEG_CREATE:\n\tcase ZFS_DELEG_CREATE_SETS:\n\t\tif (who[1] != ZFS_DELEG_NA)\n\t\t\treturn (-1);\n\t\tif (who[3] != '\\0')\n\t\t\treturn (-1);\n\t\tbreak;\n\n\tcase ZFS_DELEG_EVERYONE:\n\tcase ZFS_DELEG_EVERYONE_SETS:\n\t\tif (who[1] != ZFS_DELEG_LOCAL && who[1] != ZFS_DELEG_DESCENDENT)\n\t\t\treturn (-1);\n\t\tif (who[3] != '\\0')\n\t\t\treturn (-1);\n\t\tbreak;\n\n\tdefault:\n\t\treturn (-1);\n\t}\n\n\treturn (0);\n}\n\nint\nzfs_deleg_verify_nvlist(nvlist_t *nvp)\n{\n\tnvpair_t *who, *perm_name;\n\tnvlist_t *perms;\n\tint error;\n\n\tif (nvp == NULL)\n\t\treturn (-1);\n\n\twho = nvlist_next_nvpair(nvp, NULL);\n\tif (who == NULL)\n\t\treturn (-1);\n\n\tdo {\n\t\tif (zfs_validate_who(nvpair_name(who)))\n\t\t\treturn (-1);\n\n\t\terror = nvlist_lookup_nvlist(nvp, nvpair_name(who), &perms);\n\n\t\tif (error && error != ENOENT)\n\t\t\treturn (-1);\n\t\tif (error == ENOENT)\n\t\t\tcontinue;\n\n\t\tperm_name = nvlist_next_nvpair(perms, NULL);\n\t\tif (perm_name == NULL) {\n\t\t\treturn (-1);\n\t\t}\n\t\tdo {\n\t\t\terror = zfs_valid_permission_name(\n\t\t\t    nvpair_name(perm_name));\n\t\t\tif (error)\n\t\t\t\treturn (-1);\n\t\t} while ((perm_name = nvlist_next_nvpair(perms, perm_name))\n\t\t    != NULL);\n\t} while ((who = nvlist_next_nvpair(nvp, who)) != NULL);\n\treturn (0);\n}\n\n \nvoid\nzfs_deleg_whokey(char *attr, zfs_deleg_who_type_t type,\n    char inheritchr, void *data)\n{\n\tint len = ZFS_MAX_DELEG_NAME;\n\tuint64_t *id = data;\n\n\tswitch (type) {\n\tcase ZFS_DELEG_USER:\n\tcase ZFS_DELEG_GROUP:\n\tcase ZFS_DELEG_USER_SETS:\n\tcase ZFS_DELEG_GROUP_SETS:\n\t\t(void) snprintf(attr, len, \"%c%c%c%lld\", type, inheritchr,\n\t\t    ZFS_DELEG_FIELD_SEP_CHR, (longlong_t)*id);\n\t\tbreak;\n\tcase ZFS_DELEG_NAMED_SET_SETS:\n\tcase ZFS_DELEG_NAMED_SET:\n\t\t(void) snprintf(attr, len, \"%c-%c%s\", type,\n\t\t    ZFS_DELEG_FIELD_SEP_CHR, (char *)data);\n\t\tbreak;\n\tcase ZFS_DELEG_CREATE:\n\tcase ZFS_DELEG_CREATE_SETS:\n\t\t(void) snprintf(attr, len, \"%c-%c\", type,\n\t\t    ZFS_DELEG_FIELD_SEP_CHR);\n\t\tbreak;\n\tcase ZFS_DELEG_EVERYONE:\n\tcase ZFS_DELEG_EVERYONE_SETS:\n\t\t(void) snprintf(attr, len, \"%c%c%c\", type, inheritchr,\n\t\t    ZFS_DELEG_FIELD_SEP_CHR);\n\t\tbreak;\n\tdefault:\n\t\tASSERT(!\"bad zfs_deleg_who_type_t\");\n\t}\n}\n\n#if defined(_KERNEL)\nEXPORT_SYMBOL(zfs_deleg_verify_nvlist);\nEXPORT_SYMBOL(zfs_deleg_whokey);\nEXPORT_SYMBOL(zfs_deleg_canonicalize_perm);\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}