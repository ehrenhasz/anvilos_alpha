{
  "module_name": "blkptr.c",
  "hash_id": "c349f6b723259350dc7823b5f578b29d8b1400ba12e141e5c9e715b25d59c27c",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/blkptr.c",
  "human_readable_source": " \n\n \n\n#include <sys/blkptr.h>\n#include <sys/zfs_context.h>\n#include <sys/zio.h>\n#include <sys/zio_compress.h>\n\n \n\nvoid\nencode_embedded_bp_compressed(blkptr_t *bp, void *data,\n    enum zio_compress comp, int uncompressed_size, int compressed_size)\n{\n\tuint64_t *bp64 = (uint64_t *)bp;\n\tuint64_t w = 0;\n\tuint8_t *data8 = data;\n\n\tASSERT3U(compressed_size, <=, BPE_PAYLOAD_SIZE);\n\tASSERT(uncompressed_size == compressed_size ||\n\t    comp != ZIO_COMPRESS_OFF);\n\tASSERT3U(comp, >=, ZIO_COMPRESS_OFF);\n\tASSERT3U(comp, <, ZIO_COMPRESS_FUNCTIONS);\n\n\tmemset(bp, 0, sizeof (*bp));\n\tBP_SET_EMBEDDED(bp, B_TRUE);\n\tBP_SET_COMPRESS(bp, comp);\n\tBP_SET_BYTEORDER(bp, ZFS_HOST_BYTEORDER);\n\tBPE_SET_LSIZE(bp, uncompressed_size);\n\tBPE_SET_PSIZE(bp, compressed_size);\n\n\t \n\tfor (int i = 0; i < compressed_size; i++) {\n\t\tBF64_SET(w, (i % sizeof (w)) * NBBY, NBBY, data8[i]);\n\t\tif (i % sizeof (w) == sizeof (w) - 1) {\n\t\t\t \n\t\t\tASSERT3P(bp64, <, bp + 1);\n\t\t\t*bp64 = w;\n\t\t\tbp64++;\n\t\t\tif (!BPE_IS_PAYLOADWORD(bp, bp64))\n\t\t\t\tbp64++;\n\t\t\tw = 0;\n\t\t}\n\t}\n\t \n\tif (bp64 < (uint64_t *)(bp + 1))\n\t\t*bp64 = w;\n}\n\n \nvoid\ndecode_embedded_bp_compressed(const blkptr_t *bp, void *buf)\n{\n\tint psize;\n\tuint8_t *buf8 = buf;\n\tuint64_t w = 0;\n\tconst uint64_t *bp64 = (const uint64_t *)bp;\n\n\tASSERT(BP_IS_EMBEDDED(bp));\n\n\tpsize = BPE_GET_PSIZE(bp);\n\n\t \n\tfor (int i = 0; i < psize; i++) {\n\t\tif (i % sizeof (w) == 0) {\n\t\t\t \n\t\t\tASSERT3P(bp64, <, bp + 1);\n\t\t\tw = *bp64;\n\t\t\tbp64++;\n\t\t\tif (!BPE_IS_PAYLOADWORD(bp, bp64))\n\t\t\t\tbp64++;\n\t\t}\n\t\tbuf8[i] = BF64_GET(w, (i % sizeof (w)) * NBBY, NBBY);\n\t}\n}\n\n \nint\ndecode_embedded_bp(const blkptr_t *bp, void *buf, int buflen)\n{\n\tint lsize, psize;\n\n\tASSERT(BP_IS_EMBEDDED(bp));\n\n\tlsize = BPE_GET_LSIZE(bp);\n\tpsize = BPE_GET_PSIZE(bp);\n\n\tif (lsize > buflen)\n\t\treturn (SET_ERROR(ENOSPC));\n\tASSERT3U(lsize, ==, buflen);\n\n\tif (BP_GET_COMPRESS(bp) != ZIO_COMPRESS_OFF) {\n\t\tuint8_t dstbuf[BPE_PAYLOAD_SIZE];\n\t\tdecode_embedded_bp_compressed(bp, dstbuf);\n\t\tVERIFY0(zio_decompress_data_buf(BP_GET_COMPRESS(bp),\n\t\t    dstbuf, buf, psize, buflen, NULL));\n\t} else {\n\t\tASSERT3U(lsize, ==, psize);\n\t\tdecode_embedded_bp_compressed(bp, buf);\n\t}\n\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}