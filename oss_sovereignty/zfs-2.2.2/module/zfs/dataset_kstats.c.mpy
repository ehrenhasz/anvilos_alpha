{
  "module_name": "dataset_kstats.c",
  "hash_id": "efb1764ce31d0499178cf1c4d66dc835f02b2d1a72757c85cd7976b0b20a7cf6",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/dataset_kstats.c",
  "human_readable_source": " \n\n \n\n#include <sys/dataset_kstats.h>\n#include <sys/dmu_objset.h>\n#include <sys/dsl_dataset.h>\n#include <sys/spa.h>\n\nstatic dataset_kstat_values_t empty_dataset_kstats = {\n\t{ \"dataset_name\",\tKSTAT_DATA_STRING },\n\t{ \"writes\",\tKSTAT_DATA_UINT64 },\n\t{ \"nwritten\",\tKSTAT_DATA_UINT64 },\n\t{ \"reads\",\tKSTAT_DATA_UINT64 },\n\t{ \"nread\",\tKSTAT_DATA_UINT64 },\n\t{ \"nunlinks\",\tKSTAT_DATA_UINT64 },\n\t{ \"nunlinked\",\tKSTAT_DATA_UINT64 },\n\t{\n\t{ \"zil_commit_count\",\t\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_commit_writer_count\",\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_count\",\t\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_indirect_count\",\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_indirect_bytes\",\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_copied_count\",\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_copied_bytes\",\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_needcopy_count\",\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_needcopy_bytes\",\t\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_metaslab_normal_count\",\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_metaslab_normal_bytes\",\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_metaslab_normal_write\",\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_metaslab_normal_alloc\",\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_metaslab_slog_count\",\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_metaslab_slog_bytes\",\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_metaslab_slog_write\",\tKSTAT_DATA_UINT64 },\n\t{ \"zil_itx_metaslab_slog_alloc\",\tKSTAT_DATA_UINT64 }\n\t}\n};\n\nstatic int\ndataset_kstats_update(kstat_t *ksp, int rw)\n{\n\tdataset_kstats_t *dk = ksp->ks_private;\n\tdataset_kstat_values_t *dkv = ksp->ks_data;\n\tASSERT3P(dk->dk_kstats->ks_data, ==, dkv);\n\n\tif (rw == KSTAT_WRITE)\n\t\treturn (EACCES);\n\n\tdkv->dkv_writes.value.ui64 =\n\t    wmsum_value(&dk->dk_sums.dss_writes);\n\tdkv->dkv_nwritten.value.ui64 =\n\t    wmsum_value(&dk->dk_sums.dss_nwritten);\n\tdkv->dkv_reads.value.ui64 =\n\t    wmsum_value(&dk->dk_sums.dss_reads);\n\tdkv->dkv_nread.value.ui64 =\n\t    wmsum_value(&dk->dk_sums.dss_nread);\n\tdkv->dkv_nunlinks.value.ui64 =\n\t    wmsum_value(&dk->dk_sums.dss_nunlinks);\n\tdkv->dkv_nunlinked.value.ui64 =\n\t    wmsum_value(&dk->dk_sums.dss_nunlinked);\n\n\tzil_kstat_values_update(&dkv->dkv_zil_stats, &dk->dk_zil_sums);\n\n\treturn (0);\n}\n\nint\ndataset_kstats_create(dataset_kstats_t *dk, objset_t *objset)\n{\n\t \n\tif (dmu_objset_is_snapshot(objset))\n\t\treturn (0);\n\n\t \n\tchar kstat_module_name[KSTAT_STRLEN];\n\tint n = snprintf(kstat_module_name, sizeof (kstat_module_name),\n\t    \"zfs/%s\", spa_name(dmu_objset_spa(objset)));\n\tif (n < 0) {\n\t\tzfs_dbgmsg(\"failed to create dataset kstat for objset %lld: \"\n\t\t    \" snprintf() for kstat module name returned %d\",\n\t\t    (unsigned long long)dmu_objset_id(objset), n);\n\t\treturn (SET_ERROR(EINVAL));\n\t} else if (n >= KSTAT_STRLEN) {\n\t\tzfs_dbgmsg(\"failed to create dataset kstat for objset %lld: \"\n\t\t    \"kstat module name length (%d) exceeds limit (%d)\",\n\t\t    (unsigned long long)dmu_objset_id(objset),\n\t\t    n, KSTAT_STRLEN);\n\t\treturn (SET_ERROR(ENAMETOOLONG));\n\t}\n\n\tchar kstat_name[KSTAT_STRLEN];\n\tn = snprintf(kstat_name, sizeof (kstat_name), \"objset-0x%llx\",\n\t    (unsigned long long)dmu_objset_id(objset));\n\tif (n < 0) {\n\t\tzfs_dbgmsg(\"failed to create dataset kstat for objset %lld: \"\n\t\t    \" snprintf() for kstat name returned %d\",\n\t\t    (unsigned long long)dmu_objset_id(objset), n);\n\t\treturn (SET_ERROR(EINVAL));\n\t} else if (n >= KSTAT_STRLEN) {\n\t\tzfs_dbgmsg(\"failed to create dataset kstat for objset %lld: \"\n\t\t    \"kstat name length (%d) exceeds limit (%d)\",\n\t\t    (unsigned long long)dmu_objset_id(objset),\n\t\t    n, KSTAT_STRLEN);\n\t\treturn (SET_ERROR(ENAMETOOLONG));\n\t}\n\n\tkstat_t *kstat = kstat_create(kstat_module_name, 0, kstat_name,\n\t    \"dataset\", KSTAT_TYPE_NAMED,\n\t    sizeof (empty_dataset_kstats) / sizeof (kstat_named_t),\n\t    KSTAT_FLAG_VIRTUAL);\n\tif (kstat == NULL)\n\t\treturn (SET_ERROR(ENOMEM));\n\n\tdataset_kstat_values_t *dk_kstats =\n\t    kmem_alloc(sizeof (empty_dataset_kstats), KM_SLEEP);\n\tmemcpy(dk_kstats, &empty_dataset_kstats,\n\t    sizeof (empty_dataset_kstats));\n\n\tchar *ds_name = kmem_zalloc(ZFS_MAX_DATASET_NAME_LEN, KM_SLEEP);\n\tdsl_dataset_name(objset->os_dsl_dataset, ds_name);\n\tKSTAT_NAMED_STR_PTR(&dk_kstats->dkv_ds_name) = ds_name;\n\tKSTAT_NAMED_STR_BUFLEN(&dk_kstats->dkv_ds_name) =\n\t    ZFS_MAX_DATASET_NAME_LEN;\n\n\tkstat->ks_data = dk_kstats;\n\tkstat->ks_update = dataset_kstats_update;\n\tkstat->ks_private = dk;\n\tkstat->ks_data_size += ZFS_MAX_DATASET_NAME_LEN;\n\n\twmsum_init(&dk->dk_sums.dss_writes, 0);\n\twmsum_init(&dk->dk_sums.dss_nwritten, 0);\n\twmsum_init(&dk->dk_sums.dss_reads, 0);\n\twmsum_init(&dk->dk_sums.dss_nread, 0);\n\twmsum_init(&dk->dk_sums.dss_nunlinks, 0);\n\twmsum_init(&dk->dk_sums.dss_nunlinked, 0);\n\tzil_sums_init(&dk->dk_zil_sums);\n\n\tdk->dk_kstats = kstat;\n\tkstat_install(kstat);\n\treturn (0);\n}\n\nvoid\ndataset_kstats_destroy(dataset_kstats_t *dk)\n{\n\tif (dk->dk_kstats == NULL)\n\t\treturn;\n\n\tdataset_kstat_values_t *dkv = dk->dk_kstats->ks_data;\n\tkstat_delete(dk->dk_kstats);\n\tdk->dk_kstats = NULL;\n\tkmem_free(KSTAT_NAMED_STR_PTR(&dkv->dkv_ds_name),\n\t    KSTAT_NAMED_STR_BUFLEN(&dkv->dkv_ds_name));\n\tkmem_free(dkv, sizeof (empty_dataset_kstats));\n\n\twmsum_fini(&dk->dk_sums.dss_writes);\n\twmsum_fini(&dk->dk_sums.dss_nwritten);\n\twmsum_fini(&dk->dk_sums.dss_reads);\n\twmsum_fini(&dk->dk_sums.dss_nread);\n\twmsum_fini(&dk->dk_sums.dss_nunlinks);\n\twmsum_fini(&dk->dk_sums.dss_nunlinked);\n\tzil_sums_fini(&dk->dk_zil_sums);\n}\n\nvoid\ndataset_kstats_update_write_kstats(dataset_kstats_t *dk,\n    int64_t nwritten)\n{\n\tASSERT3S(nwritten, >=, 0);\n\n\tif (dk->dk_kstats == NULL)\n\t\treturn;\n\n\twmsum_add(&dk->dk_sums.dss_writes, 1);\n\twmsum_add(&dk->dk_sums.dss_nwritten, nwritten);\n}\n\nvoid\ndataset_kstats_update_read_kstats(dataset_kstats_t *dk,\n    int64_t nread)\n{\n\tASSERT3S(nread, >=, 0);\n\n\tif (dk->dk_kstats == NULL)\n\t\treturn;\n\n\twmsum_add(&dk->dk_sums.dss_reads, 1);\n\twmsum_add(&dk->dk_sums.dss_nread, nread);\n}\n\nvoid\ndataset_kstats_update_nunlinks_kstat(dataset_kstats_t *dk, int64_t delta)\n{\n\tif (dk->dk_kstats == NULL)\n\t\treturn;\n\n\twmsum_add(&dk->dk_sums.dss_nunlinks, delta);\n}\n\nvoid\ndataset_kstats_update_nunlinked_kstat(dataset_kstats_t *dk, int64_t delta)\n{\n\tif (dk->dk_kstats == NULL)\n\t\treturn;\n\n\twmsum_add(&dk->dk_sums.dss_nunlinked, delta);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}