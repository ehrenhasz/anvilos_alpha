{
  "module_name": "dbuf_stats.c",
  "hash_id": "32e93c27dbd5ecab11aca4c3cfda45335144abc3242cb28e8edf3f74ef14b388",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/dbuf_stats.c",
  "human_readable_source": " \n\n#include <sys/zfs_context.h>\n#include <sys/dbuf.h>\n#include <sys/dmu_objset.h>\n\n \nint zfs_dbuf_state_index = 0;\n\n \ntypedef struct dbuf_stats_t {\n\tkmutex_t\t\tlock;\n\tkstat_t\t\t\t*kstat;\n\tdbuf_hash_table_t\t*hash;\n\tint\t\t\tidx;\n} dbuf_stats_t;\n\nstatic dbuf_stats_t dbuf_stats_hash_table;\n\nstatic int\ndbuf_stats_hash_table_headers(char *buf, size_t size)\n{\n\t(void) snprintf(buf, size,\n\t    \"%-96s | %-119s | %s\\n\"\n\t    \"%-16s %-8s %-8s %-8s %-8s %-10s %-8s %-5s %-5s %-7s %3s | \"\n\t    \"%-5s %-5s %-9s %-6s %-8s %-12s \"\n\t    \"%-6s %-6s %-6s %-6s %-6s %-8s %-8s %-8s %-6s | \"\n\t    \"%-6s %-6s %-8s %-8s %-6s %-6s %-6s %-8s %-8s\\n\",\n\t    \"dbuf\", \"arcbuf\", \"dnode\", \"pool\", \"objset\", \"object\", \"level\",\n\t    \"blkid\", \"offset\", \"dbsize\", \"meta\", \"state\", \"dbholds\", \"dbc\",\n\t    \"list\", \"atype\", \"flags\", \"count\", \"asize\", \"access\",\n\t    \"mru\", \"gmru\", \"mfu\", \"gmfu\", \"l2\", \"l2_dattr\", \"l2_asize\",\n\t    \"l2_comp\", \"aholds\", \"dtype\", \"btype\", \"data_bs\", \"meta_bs\",\n\t    \"bsize\", \"lvls\", \"dholds\", \"blocks\", \"dsize\");\n\n\treturn (0);\n}\n\nstatic int\n__dbuf_stats_hash_table_data(char *buf, size_t size, dmu_buf_impl_t *db)\n{\n\tarc_buf_info_t abi = { 0 };\n\tdmu_object_info_t doi = { 0 };\n\tdnode_t *dn = DB_DNODE(db);\n\tsize_t nwritten;\n\n\tif (db->db_buf)\n\t\tarc_buf_info(db->db_buf, &abi, zfs_dbuf_state_index);\n\n\t__dmu_object_info_from_dnode(dn, &doi);\n\n\tnwritten = snprintf(buf, size,\n\t    \"%-16s %-8llu %-8lld %-8lld %-8lld %-10llu %-8llu %-5d %-5d \"\n\t    \"%-7lu %-3d | %-5d %-5d 0x%-7x %-6lu %-8llu %-12llu \"\n\t    \"%-6lu %-6lu %-6lu %-6lu %-6lu %-8llu %-8llu %-8d %-6lu | \"\n\t    \"%-6d %-6d %-8lu %-8lu %-6llu %-6lu %-6lu %-8llu %-8llu\\n\",\n\t     \n\t    spa_name(dn->dn_objset->os_spa),\n\t    (u_longlong_t)dmu_objset_id(db->db_objset),\n\t    (longlong_t)db->db.db_object,\n\t    (longlong_t)db->db_level,\n\t    (longlong_t)db->db_blkid,\n\t    (u_longlong_t)db->db.db_offset,\n\t    (u_longlong_t)db->db.db_size,\n\t    !!dbuf_is_metadata(db),\n\t    db->db_state,\n\t    (ulong_t)zfs_refcount_count(&db->db_holds),\n\t    multilist_link_active(&db->db_cache_link),\n\t     \n\t    abi.abi_state_type,\n\t    abi.abi_state_contents,\n\t    abi.abi_flags,\n\t    (ulong_t)abi.abi_bufcnt,\n\t    (u_longlong_t)abi.abi_size,\n\t    (u_longlong_t)abi.abi_access,\n\t    (ulong_t)abi.abi_mru_hits,\n\t    (ulong_t)abi.abi_mru_ghost_hits,\n\t    (ulong_t)abi.abi_mfu_hits,\n\t    (ulong_t)abi.abi_mfu_ghost_hits,\n\t    (ulong_t)abi.abi_l2arc_hits,\n\t    (u_longlong_t)abi.abi_l2arc_dattr,\n\t    (u_longlong_t)abi.abi_l2arc_asize,\n\t    abi.abi_l2arc_compress,\n\t    (ulong_t)abi.abi_holds,\n\t     \n\t    doi.doi_type,\n\t    doi.doi_bonus_type,\n\t    (ulong_t)doi.doi_data_block_size,\n\t    (ulong_t)doi.doi_metadata_block_size,\n\t    (u_longlong_t)doi.doi_bonus_size,\n\t    (ulong_t)doi.doi_indirection,\n\t    (ulong_t)zfs_refcount_count(&dn->dn_holds),\n\t    (u_longlong_t)doi.doi_fill_count,\n\t    (u_longlong_t)doi.doi_max_offset);\n\n\tif (nwritten >= size)\n\t\treturn (size);\n\n\treturn (nwritten + 1);\n}\n\nstatic int\ndbuf_stats_hash_table_data(char *buf, size_t size, void *data)\n{\n\tdbuf_stats_t *dsh = (dbuf_stats_t *)data;\n\tdbuf_hash_table_t *h = dsh->hash;\n\tdmu_buf_impl_t *db;\n\tint length, error = 0;\n\n\tASSERT3S(dsh->idx, >=, 0);\n\tASSERT3S(dsh->idx, <=, h->hash_table_mask);\n\tif (size)\n\t\tbuf[0] = 0;\n\n\tmutex_enter(DBUF_HASH_MUTEX(h, dsh->idx));\n\tfor (db = h->hash_table[dsh->idx]; db != NULL; db = db->db_hash_next) {\n\t\t \n\t\tif (size < 512) {\n\t\t\terror = SET_ERROR(ENOMEM);\n\t\t\tbreak;\n\t\t}\n\n\t\tmutex_enter(&db->db_mtx);\n\n\t\tif (db->db_state != DB_EVICTING) {\n\t\t\tlength = __dbuf_stats_hash_table_data(buf, size, db);\n\t\t\tbuf += length;\n\t\t\tsize -= length;\n\t\t}\n\n\t\tmutex_exit(&db->db_mtx);\n\t}\n\tmutex_exit(DBUF_HASH_MUTEX(h, dsh->idx));\n\n\treturn (error);\n}\n\nstatic void *\ndbuf_stats_hash_table_addr(kstat_t *ksp, loff_t n)\n{\n\tdbuf_stats_t *dsh = ksp->ks_private;\n\n\tASSERT(MUTEX_HELD(&dsh->lock));\n\n\tif (n <= dsh->hash->hash_table_mask) {\n\t\tdsh->idx = n;\n\t\treturn (dsh);\n\t}\n\n\treturn (NULL);\n}\n\nstatic void\ndbuf_stats_hash_table_init(dbuf_hash_table_t *hash)\n{\n\tdbuf_stats_t *dsh = &dbuf_stats_hash_table;\n\tkstat_t *ksp;\n\n\tmutex_init(&dsh->lock, NULL, MUTEX_DEFAULT, NULL);\n\tdsh->hash = hash;\n\n\tksp = kstat_create(\"zfs\", 0, \"dbufs\", \"misc\",\n\t    KSTAT_TYPE_RAW, 0, KSTAT_FLAG_VIRTUAL);\n\tdsh->kstat = ksp;\n\n\tif (ksp) {\n\t\tksp->ks_lock = &dsh->lock;\n\t\tksp->ks_ndata = UINT32_MAX;\n\t\tksp->ks_private = dsh;\n\t\tkstat_set_raw_ops(ksp, dbuf_stats_hash_table_headers,\n\t\t    dbuf_stats_hash_table_data, dbuf_stats_hash_table_addr);\n\t\tkstat_install(ksp);\n\t}\n}\n\nstatic void\ndbuf_stats_hash_table_destroy(void)\n{\n\tdbuf_stats_t *dsh = &dbuf_stats_hash_table;\n\tkstat_t *ksp;\n\n\tksp = dsh->kstat;\n\tif (ksp)\n\t\tkstat_delete(ksp);\n\n\tmutex_destroy(&dsh->lock);\n}\n\nvoid\ndbuf_stats_init(dbuf_hash_table_t *hash)\n{\n\tdbuf_stats_hash_table_init(hash);\n}\n\nvoid\ndbuf_stats_destroy(void)\n{\n\tdbuf_stats_hash_table_destroy();\n}\n\nZFS_MODULE_PARAM(zfs, zfs_, dbuf_state_index, INT, ZMOD_RW,\n\t\"Calculate arc header index\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}