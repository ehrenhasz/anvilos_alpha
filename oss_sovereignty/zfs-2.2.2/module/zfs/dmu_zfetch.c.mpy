{
  "module_name": "dmu_zfetch.c",
  "hash_id": "661b96135b3b7addc40296e69a4a853a709954961d4c032f2b0de78a57899f3d",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/dmu_zfetch.c",
  "human_readable_source": " \n \n\n \n\n#include <sys/zfs_context.h>\n#include <sys/arc_impl.h>\n#include <sys/dnode.h>\n#include <sys/dmu_objset.h>\n#include <sys/dmu_zfetch.h>\n#include <sys/dmu.h>\n#include <sys/dbuf.h>\n#include <sys/kstat.h>\n#include <sys/wmsum.h>\n\n \n\nstatic int zfs_prefetch_disable = B_FALSE;\n\n \nstatic unsigned int\tzfetch_max_streams = 8;\n \nstatic unsigned int\tzfetch_min_sec_reap = 1;\n \nstatic unsigned int\tzfetch_max_sec_reap = 2;\n#ifdef _ILP32\n \nstatic unsigned int\tzfetch_min_distance = 2 * 1024 * 1024;\n \nunsigned int\tzfetch_max_distance = 8 * 1024 * 1024;\n#else\n \nstatic unsigned int\tzfetch_min_distance = 4 * 1024 * 1024;\n \nunsigned int\tzfetch_max_distance = 64 * 1024 * 1024;\n#endif\n \nunsigned int\tzfetch_max_idistance = 64 * 1024 * 1024;\n\ntypedef struct zfetch_stats {\n\tkstat_named_t zfetchstat_hits;\n\tkstat_named_t zfetchstat_misses;\n\tkstat_named_t zfetchstat_max_streams;\n\tkstat_named_t zfetchstat_io_issued;\n\tkstat_named_t zfetchstat_io_active;\n} zfetch_stats_t;\n\nstatic zfetch_stats_t zfetch_stats = {\n\t{ \"hits\",\t\t\tKSTAT_DATA_UINT64 },\n\t{ \"misses\",\t\t\tKSTAT_DATA_UINT64 },\n\t{ \"max_streams\",\t\tKSTAT_DATA_UINT64 },\n\t{ \"io_issued\",\t\t\tKSTAT_DATA_UINT64 },\n\t{ \"io_active\",\t\t\tKSTAT_DATA_UINT64 },\n};\n\nstruct {\n\twmsum_t zfetchstat_hits;\n\twmsum_t zfetchstat_misses;\n\twmsum_t zfetchstat_max_streams;\n\twmsum_t zfetchstat_io_issued;\n\taggsum_t zfetchstat_io_active;\n} zfetch_sums;\n\n#define\tZFETCHSTAT_BUMP(stat)\t\t\t\t\t\\\n\twmsum_add(&zfetch_sums.stat, 1)\n#define\tZFETCHSTAT_ADD(stat, val)\t\t\t\t\\\n\twmsum_add(&zfetch_sums.stat, val)\n\n\nstatic kstat_t\t\t*zfetch_ksp;\n\nstatic int\nzfetch_kstats_update(kstat_t *ksp, int rw)\n{\n\tzfetch_stats_t *zs = ksp->ks_data;\n\n\tif (rw == KSTAT_WRITE)\n\t\treturn (EACCES);\n\tzs->zfetchstat_hits.value.ui64 =\n\t    wmsum_value(&zfetch_sums.zfetchstat_hits);\n\tzs->zfetchstat_misses.value.ui64 =\n\t    wmsum_value(&zfetch_sums.zfetchstat_misses);\n\tzs->zfetchstat_max_streams.value.ui64 =\n\t    wmsum_value(&zfetch_sums.zfetchstat_max_streams);\n\tzs->zfetchstat_io_issued.value.ui64 =\n\t    wmsum_value(&zfetch_sums.zfetchstat_io_issued);\n\tzs->zfetchstat_io_active.value.ui64 =\n\t    aggsum_value(&zfetch_sums.zfetchstat_io_active);\n\treturn (0);\n}\n\nvoid\nzfetch_init(void)\n{\n\twmsum_init(&zfetch_sums.zfetchstat_hits, 0);\n\twmsum_init(&zfetch_sums.zfetchstat_misses, 0);\n\twmsum_init(&zfetch_sums.zfetchstat_max_streams, 0);\n\twmsum_init(&zfetch_sums.zfetchstat_io_issued, 0);\n\taggsum_init(&zfetch_sums.zfetchstat_io_active, 0);\n\n\tzfetch_ksp = kstat_create(\"zfs\", 0, \"zfetchstats\", \"misc\",\n\t    KSTAT_TYPE_NAMED, sizeof (zfetch_stats) / sizeof (kstat_named_t),\n\t    KSTAT_FLAG_VIRTUAL);\n\n\tif (zfetch_ksp != NULL) {\n\t\tzfetch_ksp->ks_data = &zfetch_stats;\n\t\tzfetch_ksp->ks_update = zfetch_kstats_update;\n\t\tkstat_install(zfetch_ksp);\n\t}\n}\n\nvoid\nzfetch_fini(void)\n{\n\tif (zfetch_ksp != NULL) {\n\t\tkstat_delete(zfetch_ksp);\n\t\tzfetch_ksp = NULL;\n\t}\n\n\twmsum_fini(&zfetch_sums.zfetchstat_hits);\n\twmsum_fini(&zfetch_sums.zfetchstat_misses);\n\twmsum_fini(&zfetch_sums.zfetchstat_max_streams);\n\twmsum_fini(&zfetch_sums.zfetchstat_io_issued);\n\tASSERT0(aggsum_value(&zfetch_sums.zfetchstat_io_active));\n\taggsum_fini(&zfetch_sums.zfetchstat_io_active);\n}\n\n \nvoid\ndmu_zfetch_init(zfetch_t *zf, dnode_t *dno)\n{\n\tif (zf == NULL)\n\t\treturn;\n\tzf->zf_dnode = dno;\n\tzf->zf_numstreams = 0;\n\n\tlist_create(&zf->zf_stream, sizeof (zstream_t),\n\t    offsetof(zstream_t, zs_node));\n\n\tmutex_init(&zf->zf_lock, NULL, MUTEX_DEFAULT, NULL);\n}\n\nstatic void\ndmu_zfetch_stream_fini(zstream_t *zs)\n{\n\tASSERT(!list_link_active(&zs->zs_node));\n\tzfs_refcount_destroy(&zs->zs_callers);\n\tzfs_refcount_destroy(&zs->zs_refs);\n\tkmem_free(zs, sizeof (*zs));\n}\n\nstatic void\ndmu_zfetch_stream_remove(zfetch_t *zf, zstream_t *zs)\n{\n\tASSERT(MUTEX_HELD(&zf->zf_lock));\n\tlist_remove(&zf->zf_stream, zs);\n\tzf->zf_numstreams--;\n\tmembar_producer();\n\tif (zfs_refcount_remove(&zs->zs_refs, NULL) == 0)\n\t\tdmu_zfetch_stream_fini(zs);\n}\n\n \nvoid\ndmu_zfetch_fini(zfetch_t *zf)\n{\n\tzstream_t *zs;\n\n\tmutex_enter(&zf->zf_lock);\n\twhile ((zs = list_head(&zf->zf_stream)) != NULL)\n\t\tdmu_zfetch_stream_remove(zf, zs);\n\tmutex_exit(&zf->zf_lock);\n\tlist_destroy(&zf->zf_stream);\n\tmutex_destroy(&zf->zf_lock);\n\n\tzf->zf_dnode = NULL;\n}\n\n \nstatic void\ndmu_zfetch_stream_create(zfetch_t *zf, uint64_t blkid)\n{\n\tzstream_t *zs, *zs_next, *zs_old = NULL;\n\thrtime_t now = gethrtime(), t;\n\n\tASSERT(MUTEX_HELD(&zf->zf_lock));\n\n\t \n\tt = now - SEC2NSEC(zfetch_max_sec_reap);\n\tfor (zs = list_head(&zf->zf_stream); zs != NULL; zs = zs_next) {\n\t\tzs_next = list_next(&zf->zf_stream, zs);\n\t\t \n\t\tif (zfs_refcount_count(&zs->zs_refs) != 1)\n\t\t\tcontinue;\n\t\tif (zs->zs_atime > t)\n\t\t\tcontinue;\n\t\tif (zs_old)\n\t\t\tdmu_zfetch_stream_remove(zf, zs);\n\t\telse\n\t\t\tzs_old = zs;\n\t}\n\tif (zs_old) {\n\t\tzs = zs_old;\n\t\tgoto reuse;\n\t}\n\n\t \n\tuint32_t max_streams = MAX(1, MIN(zfetch_max_streams,\n\t    zf->zf_dnode->dn_maxblkid * zf->zf_dnode->dn_datablksz /\n\t    zfetch_max_distance));\n\tif (zf->zf_numstreams >= max_streams) {\n\t\tt = now - SEC2NSEC(zfetch_min_sec_reap);\n\t\tfor (zs = list_head(&zf->zf_stream); zs != NULL;\n\t\t    zs = list_next(&zf->zf_stream, zs)) {\n\t\t\tif (zfs_refcount_count(&zs->zs_refs) != 1)\n\t\t\t\tcontinue;\n\t\t\tif (zs->zs_atime > t)\n\t\t\t\tcontinue;\n\t\t\tif (zs_old == NULL || zs->zs_atime < zs_old->zs_atime)\n\t\t\t\tzs_old = zs;\n\t\t}\n\t\tif (zs_old) {\n\t\t\tzs = zs_old;\n\t\t\tgoto reuse;\n\t\t}\n\t\tZFETCHSTAT_BUMP(zfetchstat_max_streams);\n\t\treturn;\n\t}\n\n\tzs = kmem_zalloc(sizeof (*zs), KM_SLEEP);\n\tzs->zs_fetch = zf;\n\tzfs_refcount_create(&zs->zs_callers);\n\tzfs_refcount_create(&zs->zs_refs);\n\t \n\tzfs_refcount_add(&zs->zs_refs, NULL);\n\tzf->zf_numstreams++;\n\tlist_insert_head(&zf->zf_stream, zs);\n\nreuse:\n\tzs->zs_blkid = blkid;\n\tzs->zs_pf_dist = 0;\n\tzs->zs_pf_start = blkid;\n\tzs->zs_pf_end = blkid;\n\tzs->zs_ipf_dist = 0;\n\tzs->zs_ipf_start = blkid;\n\tzs->zs_ipf_end = blkid;\n\t \n\tzs->zs_atime = now - SEC2NSEC(zfetch_min_sec_reap);\n\tzs->zs_missed = B_FALSE;\n\tzs->zs_more = B_FALSE;\n}\n\nstatic void\ndmu_zfetch_done(void *arg, uint64_t level, uint64_t blkid, boolean_t io_issued)\n{\n\tzstream_t *zs = arg;\n\n\tif (io_issued && level == 0 && blkid < zs->zs_blkid)\n\t\tzs->zs_more = B_TRUE;\n\tif (zfs_refcount_remove(&zs->zs_refs, NULL) == 0)\n\t\tdmu_zfetch_stream_fini(zs);\n\taggsum_add(&zfetch_sums.zfetchstat_io_active, -1);\n}\n\n \nzstream_t *\ndmu_zfetch_prepare(zfetch_t *zf, uint64_t blkid, uint64_t nblks,\n    boolean_t fetch_data, boolean_t have_lock)\n{\n\tzstream_t *zs;\n\tspa_t *spa = zf->zf_dnode->dn_objset->os_spa;\n\n\tif (zfs_prefetch_disable)\n\t\treturn (NULL);\n\t \n\tif (!spa_indirect_vdevs_loaded(spa))\n\t\treturn (NULL);\n\n\t \n\tif (!have_lock && blkid == 0)\n\t\treturn (NULL);\n\n\tif (!have_lock)\n\t\trw_enter(&zf->zf_dnode->dn_struct_rwlock, RW_READER);\n\n\t \n\tuint64_t maxblkid = zf->zf_dnode->dn_maxblkid;\n\tif (maxblkid < 2) {\n\t\tif (!have_lock)\n\t\t\trw_exit(&zf->zf_dnode->dn_struct_rwlock);\n\t\treturn (NULL);\n\t}\n\tmutex_enter(&zf->zf_lock);\n\n\t \n\tfor (zs = list_head(&zf->zf_stream); zs != NULL;\n\t    zs = list_next(&zf->zf_stream, zs)) {\n\t\tif (blkid == zs->zs_blkid) {\n\t\t\tbreak;\n\t\t} else if (blkid + 1 == zs->zs_blkid) {\n\t\t\tblkid++;\n\t\t\tnblks--;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tuint64_t end_of_access_blkid = blkid + nblks;\n\tif (end_of_access_blkid >= maxblkid) {\n\t\tif (zs != NULL)\n\t\t\tdmu_zfetch_stream_remove(zf, zs);\n\t\tmutex_exit(&zf->zf_lock);\n\t\tif (!have_lock)\n\t\t\trw_exit(&zf->zf_dnode->dn_struct_rwlock);\n\t\treturn (NULL);\n\t}\n\n\t \n\tif (nblks == 0) {\n\t\tmutex_exit(&zf->zf_lock);\n\t\tif (!have_lock)\n\t\t\trw_exit(&zf->zf_dnode->dn_struct_rwlock);\n\t\treturn (NULL);\n\t}\n\n\tif (zs == NULL) {\n\t\t \n\t\tdmu_zfetch_stream_create(zf, end_of_access_blkid);\n\t\tmutex_exit(&zf->zf_lock);\n\t\tif (!have_lock)\n\t\t\trw_exit(&zf->zf_dnode->dn_struct_rwlock);\n\t\tZFETCHSTAT_BUMP(zfetchstat_misses);\n\t\treturn (NULL);\n\t}\n\n\t \n\tunsigned int dbs = zf->zf_dnode->dn_datablkshift;\n\tunsigned int nbytes = nblks << dbs;\n\tunsigned int pf_nblks;\n\tif (fetch_data) {\n\t\tif (unlikely(zs->zs_pf_dist < nbytes))\n\t\t\tzs->zs_pf_dist = nbytes;\n\t\telse if (zs->zs_pf_dist < zfetch_min_distance &&\n\t\t    (zs->zs_pf_dist < (1 << dbs) ||\n\t\t    aggsum_compare(&zfetch_sums.zfetchstat_io_active,\n\t\t    arc_c_max >> (4 + dbs)) < 0))\n\t\t\tzs->zs_pf_dist *= 2;\n\t\telse if (zs->zs_more)\n\t\t\tzs->zs_pf_dist += zs->zs_pf_dist / 8;\n\t\tzs->zs_more = B_FALSE;\n\t\tif (zs->zs_pf_dist > zfetch_max_distance)\n\t\t\tzs->zs_pf_dist = zfetch_max_distance;\n\t\tpf_nblks = zs->zs_pf_dist >> dbs;\n\t} else {\n\t\tpf_nblks = 0;\n\t}\n\tif (zs->zs_pf_start < end_of_access_blkid)\n\t\tzs->zs_pf_start = end_of_access_blkid;\n\tif (zs->zs_pf_end < end_of_access_blkid + pf_nblks)\n\t\tzs->zs_pf_end = end_of_access_blkid + pf_nblks;\n\n\t \n\tif (unlikely(zs->zs_ipf_dist < nbytes))\n\t\tzs->zs_ipf_dist = nbytes;\n\telse\n\t\tzs->zs_ipf_dist *= 2;\n\tif (zs->zs_ipf_dist > zfetch_max_idistance)\n\t\tzs->zs_ipf_dist = zfetch_max_idistance;\n\tpf_nblks = zs->zs_ipf_dist >> dbs;\n\tif (zs->zs_ipf_start < zs->zs_pf_end)\n\t\tzs->zs_ipf_start = zs->zs_pf_end;\n\tif (zs->zs_ipf_end < zs->zs_pf_end + pf_nblks)\n\t\tzs->zs_ipf_end = zs->zs_pf_end + pf_nblks;\n\n\tzs->zs_blkid = end_of_access_blkid;\n\t \n\tzs->zs_atime = gethrtime();\n\tzfs_refcount_add(&zs->zs_refs, NULL);\n\t \n\tzfs_refcount_add(&zs->zs_callers, NULL);\n\tmutex_exit(&zf->zf_lock);\n\n\tif (!have_lock)\n\t\trw_exit(&zf->zf_dnode->dn_struct_rwlock);\n\n\tZFETCHSTAT_BUMP(zfetchstat_hits);\n\treturn (zs);\n}\n\nvoid\ndmu_zfetch_run(zstream_t *zs, boolean_t missed, boolean_t have_lock)\n{\n\tzfetch_t *zf = zs->zs_fetch;\n\tint64_t pf_start, pf_end, ipf_start, ipf_end;\n\tint epbs, issued;\n\n\tif (missed)\n\t\tzs->zs_missed = missed;\n\n\t \n\tif (zfs_refcount_remove(&zs->zs_callers, NULL) != 0) {\n\t\t \n\t\tif (zfs_refcount_remove(&zs->zs_refs, NULL) == 0)\n\t\t\tdmu_zfetch_stream_fini(zs);\n\t\treturn;\n\t}\n\n\tmutex_enter(&zf->zf_lock);\n\tif (zs->zs_missed) {\n\t\tpf_start = zs->zs_pf_start;\n\t\tpf_end = zs->zs_pf_start = zs->zs_pf_end;\n\t} else {\n\t\tpf_start = pf_end = 0;\n\t}\n\tipf_start = zs->zs_ipf_start;\n\tipf_end = zs->zs_ipf_start = zs->zs_ipf_end;\n\tmutex_exit(&zf->zf_lock);\n\tASSERT3S(pf_start, <=, pf_end);\n\tASSERT3S(ipf_start, <=, ipf_end);\n\n\tepbs = zf->zf_dnode->dn_indblkshift - SPA_BLKPTRSHIFT;\n\tipf_start = P2ROUNDUP(ipf_start, 1 << epbs) >> epbs;\n\tipf_end = P2ROUNDUP(ipf_end, 1 << epbs) >> epbs;\n\tASSERT3S(ipf_start, <=, ipf_end);\n\tissued = pf_end - pf_start + ipf_end - ipf_start;\n\tif (issued > 1) {\n\t\t \n\t\tzfs_refcount_add_few(&zs->zs_refs, issued - 1, NULL);\n\t} else if (issued == 0) {\n\t\t \n\t\tif (zfs_refcount_remove(&zs->zs_refs, NULL) == 0)\n\t\t\tdmu_zfetch_stream_fini(zs);\n\t\treturn;\n\t}\n\taggsum_add(&zfetch_sums.zfetchstat_io_active, issued);\n\n\tif (!have_lock)\n\t\trw_enter(&zf->zf_dnode->dn_struct_rwlock, RW_READER);\n\n\tissued = 0;\n\tfor (int64_t blk = pf_start; blk < pf_end; blk++) {\n\t\tissued += dbuf_prefetch_impl(zf->zf_dnode, 0, blk,\n\t\t    ZIO_PRIORITY_ASYNC_READ, 0, dmu_zfetch_done, zs);\n\t}\n\tfor (int64_t iblk = ipf_start; iblk < ipf_end; iblk++) {\n\t\tissued += dbuf_prefetch_impl(zf->zf_dnode, 1, iblk,\n\t\t    ZIO_PRIORITY_ASYNC_READ, 0, dmu_zfetch_done, zs);\n\t}\n\n\tif (!have_lock)\n\t\trw_exit(&zf->zf_dnode->dn_struct_rwlock);\n\n\tif (issued)\n\t\tZFETCHSTAT_ADD(zfetchstat_io_issued, issued);\n}\n\nvoid\ndmu_zfetch(zfetch_t *zf, uint64_t blkid, uint64_t nblks, boolean_t fetch_data,\n    boolean_t missed, boolean_t have_lock)\n{\n\tzstream_t *zs;\n\n\tzs = dmu_zfetch_prepare(zf, blkid, nblks, fetch_data, have_lock);\n\tif (zs)\n\t\tdmu_zfetch_run(zs, missed, have_lock);\n}\n\nZFS_MODULE_PARAM(zfs_prefetch, zfs_prefetch_, disable, INT, ZMOD_RW,\n\t\"Disable all ZFS prefetching\");\n\nZFS_MODULE_PARAM(zfs_prefetch, zfetch_, max_streams, UINT, ZMOD_RW,\n\t\"Max number of streams per zfetch\");\n\nZFS_MODULE_PARAM(zfs_prefetch, zfetch_, min_sec_reap, UINT, ZMOD_RW,\n\t\"Min time before stream reclaim\");\n\nZFS_MODULE_PARAM(zfs_prefetch, zfetch_, max_sec_reap, UINT, ZMOD_RW,\n\t\"Max time before stream delete\");\n\nZFS_MODULE_PARAM(zfs_prefetch, zfetch_, min_distance, UINT, ZMOD_RW,\n\t\"Min bytes to prefetch per stream\");\n\nZFS_MODULE_PARAM(zfs_prefetch, zfetch_, max_distance, UINT, ZMOD_RW,\n\t\"Max bytes to prefetch per stream\");\n\nZFS_MODULE_PARAM(zfs_prefetch, zfetch_, max_idistance, UINT, ZMOD_RW,\n\t\"Max bytes to prefetch indirects for per stream\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}