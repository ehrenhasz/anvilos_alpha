{
  "module_name": "zfs_onexit.c",
  "hash_id": "0482945baca4251024a5f8cae48d118ad5cfeb56ec069ea9129bab395b6d61da",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/zfs_onexit.c",
  "human_readable_source": " \n \n\n#include <sys/types.h>\n#include <sys/param.h>\n#include <sys/errno.h>\n#include <sys/kmem.h>\n#include <sys/sunddi.h>\n#include <sys/zfs_ioctl.h>\n#include <sys/zfs_onexit.h>\n#include <sys/zvol.h>\n\n \n\nvoid\nzfs_onexit_init(zfs_onexit_t **zop)\n{\n\tzfs_onexit_t *zo;\n\n\tzo = *zop = kmem_zalloc(sizeof (zfs_onexit_t), KM_SLEEP);\n\tmutex_init(&zo->zo_lock, NULL, MUTEX_DEFAULT, NULL);\n\tlist_create(&zo->zo_actions, sizeof (zfs_onexit_action_node_t),\n\t    offsetof(zfs_onexit_action_node_t, za_link));\n}\n\nvoid\nzfs_onexit_destroy(zfs_onexit_t *zo)\n{\n\tzfs_onexit_action_node_t *ap;\n\n\tmutex_enter(&zo->zo_lock);\n\twhile ((ap = list_remove_head(&zo->zo_actions)) != NULL) {\n\t\tmutex_exit(&zo->zo_lock);\n\t\tap->za_func(ap->za_data);\n\t\tkmem_free(ap, sizeof (zfs_onexit_action_node_t));\n\t\tmutex_enter(&zo->zo_lock);\n\t}\n\tmutex_exit(&zo->zo_lock);\n\n\tlist_destroy(&zo->zo_actions);\n\tmutex_destroy(&zo->zo_lock);\n\tkmem_free(zo, sizeof (zfs_onexit_t));\n}\n\n \nzfs_file_t *\nzfs_onexit_fd_hold(int fd, minor_t *minorp)\n{\n\tzfs_onexit_t *zo = NULL;\n\n\tzfs_file_t *fp = zfs_file_get(fd);\n\tif (fp == NULL)\n\t\treturn (NULL);\n\n\tint error = zfsdev_getminor(fp, minorp);\n\tif (error) {\n\t\tzfs_onexit_fd_rele(fp);\n\t\treturn (NULL);\n\t}\n\n\tzo = zfsdev_get_state(*minorp, ZST_ONEXIT);\n\tif (zo == NULL) {\n\t\tzfs_onexit_fd_rele(fp);\n\t\treturn (NULL);\n\t}\n\treturn (fp);\n}\n\nvoid\nzfs_onexit_fd_rele(zfs_file_t *fp)\n{\n\tzfs_file_put(fp);\n}\n\nstatic int\nzfs_onexit_minor_to_state(minor_t minor, zfs_onexit_t **zo)\n{\n\t*zo = zfsdev_get_state(minor, ZST_ONEXIT);\n\tif (*zo == NULL)\n\t\treturn (SET_ERROR(EBADF));\n\n\treturn (0);\n}\n\n \nint\nzfs_onexit_add_cb(minor_t minor, void (*func)(void *), void *data,\n    uintptr_t *action_handle)\n{\n\tzfs_onexit_t *zo;\n\tzfs_onexit_action_node_t *ap;\n\tint error;\n\n\terror = zfs_onexit_minor_to_state(minor, &zo);\n\tif (error)\n\t\treturn (error);\n\n\tap = kmem_alloc(sizeof (zfs_onexit_action_node_t), KM_SLEEP);\n\tlist_link_init(&ap->za_link);\n\tap->za_func = func;\n\tap->za_data = data;\n\n\tmutex_enter(&zo->zo_lock);\n\tlist_insert_tail(&zo->zo_actions, ap);\n\tmutex_exit(&zo->zo_lock);\n\tif (action_handle)\n\t\t*action_handle = (uintptr_t)ap;\n\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}