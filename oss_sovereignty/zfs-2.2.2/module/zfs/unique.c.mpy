{
  "module_name": "unique.c",
  "hash_id": "ea0569a5a591821504e782b77dcdcbb01b5cdeeba4c408f0c504c8af760b72f6",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/unique.c",
  "human_readable_source": " \n \n\n\n\n#include <sys/zfs_context.h>\n#include <sys/avl.h>\n#include <sys/unique.h>\n\nstatic avl_tree_t unique_avl;\nstatic kmutex_t unique_mtx;\n\ntypedef struct unique {\n\tavl_node_t un_link;\n\tuint64_t un_value;\n} unique_t;\n\n#define\tUNIQUE_MASK ((1ULL << UNIQUE_BITS) - 1)\n\nstatic int\nunique_compare(const void *a, const void *b)\n{\n\tconst unique_t *una = (const unique_t *)a;\n\tconst unique_t *unb = (const unique_t *)b;\n\n\treturn (TREE_CMP(una->un_value, unb->un_value));\n}\n\nvoid\nunique_init(void)\n{\n\tavl_create(&unique_avl, unique_compare,\n\t    sizeof (unique_t), offsetof(unique_t, un_link));\n\tmutex_init(&unique_mtx, NULL, MUTEX_DEFAULT, NULL);\n}\n\nvoid\nunique_fini(void)\n{\n\tavl_destroy(&unique_avl);\n\tmutex_destroy(&unique_mtx);\n}\n\nuint64_t\nunique_create(void)\n{\n\tuint64_t value = unique_insert(0);\n\tunique_remove(value);\n\treturn (value);\n}\n\nuint64_t\nunique_insert(uint64_t value)\n{\n\tavl_index_t idx;\n\tunique_t *un = kmem_alloc(sizeof (unique_t), KM_SLEEP);\n\n\tun->un_value = value;\n\n\tmutex_enter(&unique_mtx);\n\twhile (un->un_value == 0 || un->un_value & ~UNIQUE_MASK ||\n\t    avl_find(&unique_avl, un, &idx)) {\n\t\tmutex_exit(&unique_mtx);\n\t\t(void) random_get_pseudo_bytes((void*)&un->un_value,\n\t\t    sizeof (un->un_value));\n\t\tun->un_value &= UNIQUE_MASK;\n\t\tmutex_enter(&unique_mtx);\n\t}\n\n\tavl_insert(&unique_avl, un, idx);\n\tmutex_exit(&unique_mtx);\n\n\treturn (un->un_value);\n}\n\nvoid\nunique_remove(uint64_t value)\n{\n\tunique_t un_tofind;\n\tunique_t *un;\n\n\tun_tofind.un_value = value;\n\tmutex_enter(&unique_mtx);\n\tun = avl_find(&unique_avl, &un_tofind, NULL);\n\tif (un != NULL) {\n\t\tavl_remove(&unique_avl, un);\n\t\tkmem_free(un, sizeof (unique_t));\n\t}\n\tmutex_exit(&unique_mtx);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}