{
  "module_name": "space_reftree.c",
  "hash_id": "073efaed57ced057e95316d401b987a5cd7198193eade176ece9305744bc18e6",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/space_reftree.c",
  "human_readable_source": " \n \n \n\n#include <sys/zfs_context.h>\n#include <sys/range_tree.h>\n#include <sys/space_reftree.h>\n\n \nstatic int\nspace_reftree_compare(const void *x1, const void *x2)\n{\n\tconst space_ref_t *sr1 = (const space_ref_t *)x1;\n\tconst space_ref_t *sr2 = (const space_ref_t *)x2;\n\n\tint cmp = TREE_CMP(sr1->sr_offset, sr2->sr_offset);\n\tif (likely(cmp))\n\t\treturn (cmp);\n\n\treturn (TREE_PCMP(sr1, sr2));\n}\n\nvoid\nspace_reftree_create(avl_tree_t *t)\n{\n\tavl_create(t, space_reftree_compare,\n\t    sizeof (space_ref_t), offsetof(space_ref_t, sr_node));\n}\n\nvoid\nspace_reftree_destroy(avl_tree_t *t)\n{\n\tspace_ref_t *sr;\n\tvoid *cookie = NULL;\n\n\twhile ((sr = avl_destroy_nodes(t, &cookie)) != NULL)\n\t\tkmem_free(sr, sizeof (*sr));\n\n\tavl_destroy(t);\n}\n\nstatic void\nspace_reftree_add_node(avl_tree_t *t, uint64_t offset, int64_t refcnt)\n{\n\tspace_ref_t *sr;\n\n\tsr = kmem_alloc(sizeof (*sr), KM_SLEEP);\n\tsr->sr_offset = offset;\n\tsr->sr_refcnt = refcnt;\n\n\tavl_add(t, sr);\n}\n\nvoid\nspace_reftree_add_seg(avl_tree_t *t, uint64_t start, uint64_t end,\n    int64_t refcnt)\n{\n\tspace_reftree_add_node(t, start, refcnt);\n\tspace_reftree_add_node(t, end, -refcnt);\n}\n\n \nvoid\nspace_reftree_add_map(avl_tree_t *t, range_tree_t *rt, int64_t refcnt)\n{\n\tzfs_btree_index_t where;\n\n\tfor (range_seg_t *rs = zfs_btree_first(&rt->rt_root, &where); rs; rs =\n\t    zfs_btree_next(&rt->rt_root, &where, &where)) {\n\t\tspace_reftree_add_seg(t, rs_get_start(rs, rt), rs_get_end(rs,\n\t\t    rt),  refcnt);\n\t}\n}\n\n \nvoid\nspace_reftree_generate_map(avl_tree_t *t, range_tree_t *rt, int64_t minref)\n{\n\tuint64_t start = -1ULL;\n\tint64_t refcnt = 0;\n\tspace_ref_t *sr;\n\n\trange_tree_vacate(rt, NULL, NULL);\n\n\tfor (sr = avl_first(t); sr != NULL; sr = AVL_NEXT(t, sr)) {\n\t\trefcnt += sr->sr_refcnt;\n\t\tif (refcnt >= minref) {\n\t\t\tif (start == -1ULL) {\n\t\t\t\tstart = sr->sr_offset;\n\t\t\t}\n\t\t} else {\n\t\t\tif (start != -1ULL) {\n\t\t\t\tuint64_t end = sr->sr_offset;\n\t\t\t\tASSERT(start <= end);\n\t\t\t\tif (end > start)\n\t\t\t\t\trange_tree_add(rt, start, end - start);\n\t\t\t\tstart = -1ULL;\n\t\t\t}\n\t\t}\n\t}\n\tASSERT(refcnt == 0);\n\tASSERT(start == -1ULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}