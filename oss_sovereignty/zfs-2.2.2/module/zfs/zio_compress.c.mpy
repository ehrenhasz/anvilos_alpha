{
  "module_name": "zio_compress.c",
  "hash_id": "e2bdd5ee9f8be4b4fe39bb3a230de27c93d0dac22df94715a4e9626065b60c3a",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/zio_compress.c",
  "human_readable_source": " \n\n \n \n\n \n\n#include <sys/zfs_context.h>\n#include <sys/spa.h>\n#include <sys/zfeature.h>\n#include <sys/zio.h>\n#include <sys/zio_compress.h>\n#include <sys/zstd/zstd.h>\n\n \nstatic unsigned long zio_decompress_fail_fraction = 0;\n\n \nzio_compress_info_t zio_compress_table[ZIO_COMPRESS_FUNCTIONS] = {\n\t{\"inherit\",\t0,\tNULL,\t\tNULL, NULL},\n\t{\"on\",\t\t0,\tNULL,\t\tNULL, NULL},\n\t{\"uncompressed\", 0,\tNULL,\t\tNULL, NULL},\n\t{\"lzjb\",\t0,\tlzjb_compress,\tlzjb_decompress, NULL},\n\t{\"empty\",\t0,\tNULL,\t\tNULL, NULL},\n\t{\"gzip-1\",\t1,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"gzip-2\",\t2,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"gzip-3\",\t3,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"gzip-4\",\t4,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"gzip-5\",\t5,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"gzip-6\",\t6,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"gzip-7\",\t7,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"gzip-8\",\t8,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"gzip-9\",\t9,\tgzip_compress,\tgzip_decompress, NULL},\n\t{\"zle\",\t\t64,\tzle_compress,\tzle_decompress, NULL},\n\t{\"lz4\",\t\t0,\tlz4_compress_zfs, lz4_decompress_zfs, NULL},\n\t{\"zstd\",\tZIO_ZSTD_LEVEL_DEFAULT,\tzfs_zstd_compress_wrap,\n\t    zfs_zstd_decompress, zfs_zstd_decompress_level},\n};\n\nuint8_t\nzio_complevel_select(spa_t *spa, enum zio_compress compress, uint8_t child,\n    uint8_t parent)\n{\n\t(void) spa;\n\tuint8_t result;\n\n\tif (!ZIO_COMPRESS_HASLEVEL(compress))\n\t\treturn (0);\n\n\tresult = child;\n\tif (result == ZIO_COMPLEVEL_INHERIT)\n\t\tresult = parent;\n\n\treturn (result);\n}\n\nenum zio_compress\nzio_compress_select(spa_t *spa, enum zio_compress child,\n    enum zio_compress parent)\n{\n\tenum zio_compress result;\n\n\tASSERT(child < ZIO_COMPRESS_FUNCTIONS);\n\tASSERT(parent < ZIO_COMPRESS_FUNCTIONS);\n\tASSERT(parent != ZIO_COMPRESS_INHERIT);\n\n\tresult = child;\n\tif (result == ZIO_COMPRESS_INHERIT)\n\t\tresult = parent;\n\n\tif (result == ZIO_COMPRESS_ON) {\n\t\tif (spa_feature_is_active(spa, SPA_FEATURE_LZ4_COMPRESS))\n\t\t\tresult = ZIO_COMPRESS_LZ4_ON_VALUE;\n\t\telse\n\t\t\tresult = ZIO_COMPRESS_LEGACY_ON_VALUE;\n\t}\n\n\treturn (result);\n}\n\nstatic int\nzio_compress_zeroed_cb(void *data, size_t len, void *private)\n{\n\t(void) private;\n\n\tuint64_t *end = (uint64_t *)((char *)data + len);\n\tfor (uint64_t *word = (uint64_t *)data; word < end; word++)\n\t\tif (*word != 0)\n\t\t\treturn (1);\n\n\treturn (0);\n}\n\nsize_t\nzio_compress_data(enum zio_compress c, abd_t *src, void **dst, size_t s_len,\n    uint8_t level)\n{\n\tsize_t c_len, d_len;\n\tuint8_t complevel;\n\tzio_compress_info_t *ci = &zio_compress_table[c];\n\n\tASSERT((uint_t)c < ZIO_COMPRESS_FUNCTIONS);\n\tASSERT((uint_t)c == ZIO_COMPRESS_EMPTY || ci->ci_compress != NULL);\n\n\t \n\tif (abd_iterate_func(src, 0, s_len, zio_compress_zeroed_cb, NULL) == 0)\n\t\treturn (0);\n\n\tif (c == ZIO_COMPRESS_EMPTY)\n\t\treturn (s_len);\n\n\t \n\td_len = s_len - (s_len >> 3);\n\n\tcomplevel = ci->ci_level;\n\n\tif (c == ZIO_COMPRESS_ZSTD) {\n\t\t \n\t\tif (level == ZIO_COMPLEVEL_INHERIT)\n\t\t\treturn (s_len);\n\n\t\tif (level == ZIO_COMPLEVEL_DEFAULT)\n\t\t\tcomplevel = ZIO_ZSTD_LEVEL_DEFAULT;\n\t\telse\n\t\t\tcomplevel = level;\n\n\t\tASSERT3U(complevel, !=, ZIO_COMPLEVEL_INHERIT);\n\t}\n\n\tif (*dst == NULL)\n\t\t*dst = zio_buf_alloc(s_len);\n\n\t \n\tvoid *tmp = abd_borrow_buf_copy(src, s_len);\n\tc_len = ci->ci_compress(tmp, *dst, s_len, d_len, complevel);\n\tabd_return_buf(src, tmp, s_len);\n\n\tif (c_len > d_len)\n\t\treturn (s_len);\n\n\tASSERT3U(c_len, <=, d_len);\n\treturn (c_len);\n}\n\nint\nzio_decompress_data_buf(enum zio_compress c, void *src, void *dst,\n    size_t s_len, size_t d_len, uint8_t *level)\n{\n\tzio_compress_info_t *ci = &zio_compress_table[c];\n\tif ((uint_t)c >= ZIO_COMPRESS_FUNCTIONS || ci->ci_decompress == NULL)\n\t\treturn (SET_ERROR(EINVAL));\n\n\tif (ci->ci_decompress_level != NULL && level != NULL)\n\t\treturn (ci->ci_decompress_level(src, dst, s_len, d_len, level));\n\n\treturn (ci->ci_decompress(src, dst, s_len, d_len, ci->ci_level));\n}\n\nint\nzio_decompress_data(enum zio_compress c, abd_t *src, void *dst,\n    size_t s_len, size_t d_len, uint8_t *level)\n{\n\tvoid *tmp = abd_borrow_buf_copy(src, s_len);\n\tint ret = zio_decompress_data_buf(c, tmp, dst, s_len, d_len, level);\n\tabd_return_buf(src, tmp, s_len);\n\n\t \n\tif (zio_decompress_fail_fraction != 0 &&\n\t    random_in_range(zio_decompress_fail_fraction) == 0)\n\t\tret = SET_ERROR(EINVAL);\n\n\treturn (ret);\n}\n\nint\nzio_compress_to_feature(enum zio_compress comp)\n{\n\tswitch (comp) {\n\tcase ZIO_COMPRESS_ZSTD:\n\t\treturn (SPA_FEATURE_ZSTD_COMPRESS);\n\tdefault:\n\t\tbreak;\n\t}\n\treturn (SPA_FEATURE_NONE);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}