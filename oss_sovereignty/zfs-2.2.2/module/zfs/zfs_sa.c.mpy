{
  "module_name": "zfs_sa.c",
  "hash_id": "1d3f8486f083729b00d2af3c98a893e4c4667e39d663e5c73bbe4144c80d5fcb",
  "original_prompt": "Ingested from zfs-2.2.2/module/zfs/zfs_sa.c",
  "human_readable_source": " \n \n\n#include <sys/zfs_context.h>\n#include <sys/vnode.h>\n#include <sys/sa.h>\n#include <sys/zfs_acl.h>\n#include <sys/zfs_sa.h>\n#include <sys/dmu_objset.h>\n#include <sys/sa_impl.h>\n#include <sys/zfeature.h>\n\n \n\nconst sa_attr_reg_t zfs_attr_table[ZPL_END+1] = {\n\t{\"ZPL_ATIME\", sizeof (uint64_t) * 2, SA_UINT64_ARRAY, 0},\n\t{\"ZPL_MTIME\", sizeof (uint64_t) * 2, SA_UINT64_ARRAY, 1},\n\t{\"ZPL_CTIME\", sizeof (uint64_t) * 2, SA_UINT64_ARRAY, 2},\n\t{\"ZPL_CRTIME\", sizeof (uint64_t) * 2, SA_UINT64_ARRAY, 3},\n\t{\"ZPL_GEN\", sizeof (uint64_t), SA_UINT64_ARRAY, 4},\n\t{\"ZPL_MODE\", sizeof (uint64_t), SA_UINT64_ARRAY, 5},\n\t{\"ZPL_SIZE\", sizeof (uint64_t), SA_UINT64_ARRAY, 6},\n\t{\"ZPL_PARENT\", sizeof (uint64_t), SA_UINT64_ARRAY, 7},\n\t{\"ZPL_LINKS\", sizeof (uint64_t), SA_UINT64_ARRAY, 8},\n\t{\"ZPL_XATTR\", sizeof (uint64_t), SA_UINT64_ARRAY, 9},\n\t{\"ZPL_RDEV\", sizeof (uint64_t), SA_UINT64_ARRAY, 10},\n\t{\"ZPL_FLAGS\", sizeof (uint64_t), SA_UINT64_ARRAY, 11},\n\t{\"ZPL_UID\", sizeof (uint64_t), SA_UINT64_ARRAY, 12},\n\t{\"ZPL_GID\", sizeof (uint64_t), SA_UINT64_ARRAY, 13},\n\t{\"ZPL_PAD\", sizeof (uint64_t) * 4, SA_UINT64_ARRAY, 14},\n\t{\"ZPL_ZNODE_ACL\", 88, SA_UINT8_ARRAY, 15},\n\t{\"ZPL_DACL_COUNT\", sizeof (uint64_t), SA_UINT64_ARRAY, 0},\n\t{\"ZPL_SYMLINK\", 0, SA_UINT8_ARRAY, 0},\n\t{\"ZPL_SCANSTAMP\", 32, SA_UINT8_ARRAY, 0},\n\t{\"ZPL_DACL_ACES\", 0, SA_ACL, 0},\n\t{\"ZPL_DXATTR\", 0, SA_UINT8_ARRAY, 0},\n\t{\"ZPL_PROJID\", sizeof (uint64_t), SA_UINT64_ARRAY, 0},\n\t{NULL, 0, 0, 0}\n};\n\n\n#ifdef _KERNEL\nstatic int zfs_zil_saxattr = 1;\n\nint\nzfs_sa_readlink(znode_t *zp, zfs_uio_t *uio)\n{\n\tdmu_buf_t *db = sa_get_db(zp->z_sa_hdl);\n\tsize_t bufsz;\n\tint error;\n\n\tbufsz = zp->z_size;\n\tif (bufsz + ZFS_OLD_ZNODE_PHYS_SIZE <= db->db_size) {\n\t\terror = zfs_uiomove((caddr_t)db->db_data +\n\t\t    ZFS_OLD_ZNODE_PHYS_SIZE,\n\t\t    MIN((size_t)bufsz, zfs_uio_resid(uio)), UIO_READ, uio);\n\t} else {\n\t\tdmu_buf_t *dbp;\n\t\tif ((error = dmu_buf_hold(ZTOZSB(zp)->z_os, zp->z_id,\n\t\t    0, FTAG, &dbp, DMU_READ_NO_PREFETCH)) == 0) {\n\t\t\terror = zfs_uiomove(dbp->db_data,\n\t\t\t    MIN((size_t)bufsz, zfs_uio_resid(uio)), UIO_READ,\n\t\t\t    uio);\n\t\t\tdmu_buf_rele(dbp, FTAG);\n\t\t}\n\t}\n\treturn (error);\n}\n\nvoid\nzfs_sa_symlink(znode_t *zp, char *link, int len, dmu_tx_t *tx)\n{\n\tdmu_buf_t *db = sa_get_db(zp->z_sa_hdl);\n\n\tif (ZFS_OLD_ZNODE_PHYS_SIZE + len <= dmu_bonus_max()) {\n\t\tVERIFY0(dmu_set_bonus(db, len + ZFS_OLD_ZNODE_PHYS_SIZE, tx));\n\t\tif (len) {\n\t\t\tmemcpy((caddr_t)db->db_data +\n\t\t\t    ZFS_OLD_ZNODE_PHYS_SIZE, link, len);\n\t\t}\n\t} else {\n\t\tdmu_buf_t *dbp;\n\n\t\tzfs_grow_blocksize(zp, len, tx);\n\t\tVERIFY0(dmu_buf_hold(ZTOZSB(zp)->z_os, zp->z_id, 0, FTAG, &dbp,\n\t\t    DMU_READ_NO_PREFETCH));\n\n\t\tdmu_buf_will_dirty(dbp, tx);\n\n\t\tASSERT3U(len, <=, dbp->db_size);\n\t\tmemcpy(dbp->db_data, link, len);\n\t\tdmu_buf_rele(dbp, FTAG);\n\t}\n}\n\nvoid\nzfs_sa_get_scanstamp(znode_t *zp, xvattr_t *xvap)\n{\n\tzfsvfs_t *zfsvfs = ZTOZSB(zp);\n\txoptattr_t *xoap;\n\n\tASSERT(MUTEX_HELD(&zp->z_lock));\n\tVERIFY((xoap = xva_getxoptattr(xvap)) != NULL);\n\tif (zp->z_is_sa) {\n\t\tif (sa_lookup(zp->z_sa_hdl, SA_ZPL_SCANSTAMP(zfsvfs),\n\t\t    &xoap->xoa_av_scanstamp,\n\t\t    sizeof (xoap->xoa_av_scanstamp)) != 0)\n\t\t\treturn;\n\t} else {\n\t\tdmu_object_info_t doi;\n\t\tdmu_buf_t *db = sa_get_db(zp->z_sa_hdl);\n\t\tint len;\n\n\t\tif (!(zp->z_pflags & ZFS_BONUS_SCANSTAMP))\n\t\t\treturn;\n\n\t\tsa_object_info(zp->z_sa_hdl, &doi);\n\t\tlen = sizeof (xoap->xoa_av_scanstamp) +\n\t\t    ZFS_OLD_ZNODE_PHYS_SIZE;\n\n\t\tif (len <= doi.doi_bonus_size) {\n\t\t\t(void) memcpy(xoap->xoa_av_scanstamp,\n\t\t\t    (caddr_t)db->db_data + ZFS_OLD_ZNODE_PHYS_SIZE,\n\t\t\t    sizeof (xoap->xoa_av_scanstamp));\n\t\t}\n\t}\n\tXVA_SET_RTN(xvap, XAT_AV_SCANSTAMP);\n}\n\nvoid\nzfs_sa_set_scanstamp(znode_t *zp, xvattr_t *xvap, dmu_tx_t *tx)\n{\n\tzfsvfs_t *zfsvfs = ZTOZSB(zp);\n\txoptattr_t *xoap;\n\n\tASSERT(MUTEX_HELD(&zp->z_lock));\n\tVERIFY((xoap = xva_getxoptattr(xvap)) != NULL);\n\tif (zp->z_is_sa)\n\t\tVERIFY(0 == sa_update(zp->z_sa_hdl, SA_ZPL_SCANSTAMP(zfsvfs),\n\t\t    &xoap->xoa_av_scanstamp,\n\t\t    sizeof (xoap->xoa_av_scanstamp), tx));\n\telse {\n\t\tdmu_object_info_t doi;\n\t\tdmu_buf_t *db = sa_get_db(zp->z_sa_hdl);\n\t\tint len;\n\n\t\tsa_object_info(zp->z_sa_hdl, &doi);\n\t\tlen = sizeof (xoap->xoa_av_scanstamp) +\n\t\t    ZFS_OLD_ZNODE_PHYS_SIZE;\n\t\tif (len > doi.doi_bonus_size)\n\t\t\tVERIFY(dmu_set_bonus(db, len, tx) == 0);\n\t\t(void) memcpy((caddr_t)db->db_data + ZFS_OLD_ZNODE_PHYS_SIZE,\n\t\t    xoap->xoa_av_scanstamp, sizeof (xoap->xoa_av_scanstamp));\n\n\t\tzp->z_pflags |= ZFS_BONUS_SCANSTAMP;\n\t\tVERIFY(0 == sa_update(zp->z_sa_hdl, SA_ZPL_FLAGS(zfsvfs),\n\t\t    &zp->z_pflags, sizeof (uint64_t), tx));\n\t}\n}\n\nint\nzfs_sa_get_xattr(znode_t *zp)\n{\n\tzfsvfs_t *zfsvfs = ZTOZSB(zp);\n\tchar *obj;\n\tint size;\n\tint error;\n\n\tASSERT(RW_LOCK_HELD(&zp->z_xattr_lock));\n\tASSERT(!zp->z_xattr_cached);\n\tASSERT(zp->z_is_sa);\n\n\terror = sa_size(zp->z_sa_hdl, SA_ZPL_DXATTR(zfsvfs), &size);\n\tif (error) {\n\t\tif (error == ENOENT)\n\t\t\treturn nvlist_alloc(&zp->z_xattr_cached,\n\t\t\t    NV_UNIQUE_NAME, KM_SLEEP);\n\t\telse\n\t\t\treturn (error);\n\t}\n\n\tobj = vmem_alloc(size, KM_SLEEP);\n\n\terror = sa_lookup(zp->z_sa_hdl, SA_ZPL_DXATTR(zfsvfs), obj, size);\n\tif (error == 0)\n\t\terror = nvlist_unpack(obj, size, &zp->z_xattr_cached, KM_SLEEP);\n\n\tvmem_free(obj, size);\n\n\treturn (error);\n}\n\nint\nzfs_sa_set_xattr(znode_t *zp, const char *name, const void *value, size_t vsize)\n{\n\tzfsvfs_t *zfsvfs = ZTOZSB(zp);\n\tzilog_t *zilog;\n\tdmu_tx_t *tx;\n\tchar *obj;\n\tsize_t size;\n\tint error, logsaxattr = 0;\n\n\tASSERT(RW_WRITE_HELD(&zp->z_xattr_lock));\n\tASSERT(zp->z_xattr_cached);\n\tASSERT(zp->z_is_sa);\n\n\terror = nvlist_size(zp->z_xattr_cached, &size, NV_ENCODE_XDR);\n\tif ((error == 0) && (size > SA_ATTR_MAX_LEN))\n\t\terror = SET_ERROR(EFBIG);\n\tif (error)\n\t\tgoto out;\n\n\tobj = vmem_alloc(size, KM_SLEEP);\n\n\terror = nvlist_pack(zp->z_xattr_cached, &obj, &size,\n\t    NV_ENCODE_XDR, KM_SLEEP);\n\tif (error)\n\t\tgoto out_free;\n\n\tzilog = zfsvfs->z_log;\n\n\t \n\tif (spa_feature_is_enabled(zfsvfs->z_os->os_spa,\n\t    SPA_FEATURE_ZILSAXATTR) && zfs_zil_saxattr)\n\t\tlogsaxattr = 1;\n\n\ttx = dmu_tx_create(zfsvfs->z_os);\n\tdmu_tx_hold_sa_create(tx, size);\n\tdmu_tx_hold_sa(tx, zp->z_sa_hdl, B_TRUE);\n\n\terror = dmu_tx_assign(tx, TXG_WAIT);\n\tif (error) {\n\t\tdmu_tx_abort(tx);\n\t} else {\n\t\tint count = 0;\n\t\tsa_bulk_attr_t bulk[2];\n\t\tuint64_t ctime[2];\n\n\t\tif (logsaxattr)\n\t\t\tzfs_log_setsaxattr(zilog, tx, TX_SETSAXATTR, zp, name,\n\t\t\t    value, vsize);\n\n\t\tzfs_tstamp_update_setup(zp, STATE_CHANGED, NULL, ctime);\n\t\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_DXATTR(zfsvfs),\n\t\t    NULL, obj, size);\n\t\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_CTIME(zfsvfs),\n\t\t    NULL, &ctime, 16);\n\t\tVERIFY0(sa_bulk_update(zp->z_sa_hdl, bulk, count, tx));\n\n\t\tdmu_tx_commit(tx);\n\t\tif (logsaxattr && zfsvfs->z_os->os_sync == ZFS_SYNC_ALWAYS)\n\t\t\tzil_commit(zilog, 0);\n\t}\nout_free:\n\tvmem_free(obj, size);\nout:\n\treturn (error);\n}\n\n \n\nvoid\nzfs_sa_upgrade(sa_handle_t *hdl, dmu_tx_t *tx)\n{\n\tdmu_buf_t *db = sa_get_db(hdl);\n\tznode_t *zp = sa_get_userdata(hdl);\n\tzfsvfs_t *zfsvfs = ZTOZSB(zp);\n\tint count = 0;\n\tsa_bulk_attr_t *bulk, *sa_attrs;\n\tzfs_acl_locator_cb_t locate = { 0 };\n\tuint64_t uid, gid, mode, rdev, xattr, parent, tmp_gen;\n\tuint64_t crtime[2], mtime[2], ctime[2], atime[2];\n\tuint64_t links;\n\tzfs_acl_phys_t znode_acl;\n\tchar scanstamp[AV_SCANSTAMP_SZ];\n\tboolean_t drop_lock = B_FALSE;\n\n\t \n\tif (zp->z_acl_cached == NULL || Z_ISLNK(ZTOTYPE(zp)))\n\t\treturn;\n\n\t \n\tif (MUTEX_NOT_HELD(&zp->z_lock)) {\n\t\tif (mutex_tryenter(&zp->z_lock) == 0)\n\t\t\treturn;\n\t\telse\n\t\t\tdrop_lock = B_TRUE;\n\t}\n\n\t \n\tbulk = kmem_alloc(sizeof (sa_bulk_attr_t) * ZPL_END, KM_SLEEP);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_ATIME(zfsvfs), NULL, &atime, 16);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_MTIME(zfsvfs), NULL, &mtime, 16);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_CTIME(zfsvfs), NULL, &ctime, 16);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_CRTIME(zfsvfs), NULL, &crtime, 16);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_MODE(zfsvfs), NULL, &mode, 8);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_PARENT(zfsvfs), NULL, &parent, 8);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_XATTR(zfsvfs), NULL, &xattr, 8);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_RDEV(zfsvfs), NULL, &rdev, 8);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_UID(zfsvfs), NULL, &uid, 8);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_GID(zfsvfs), NULL, &gid, 8);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_GEN(zfsvfs), NULL, &tmp_gen, 8);\n\tSA_ADD_BULK_ATTR(bulk, count, SA_ZPL_ZNODE_ACL(zfsvfs), NULL,\n\t    &znode_acl, 88);\n\n\tif (sa_bulk_lookup_locked(hdl, bulk, count) != 0)\n\t\tgoto done;\n\n\tif (dmu_objset_projectquota_enabled(hdl->sa_os) &&\n\t    !(zp->z_pflags & ZFS_PROJID)) {\n\t\tzp->z_pflags |= ZFS_PROJID;\n\t\tzp->z_projid = ZFS_DEFAULT_PROJID;\n\t}\n\n\t \n\tcount = 0;\n\tsa_attrs = kmem_zalloc(sizeof (sa_bulk_attr_t) * ZPL_END, KM_SLEEP);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_MODE(zfsvfs), NULL, &mode, 8);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_SIZE(zfsvfs), NULL,\n\t    &zp->z_size, 8);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_GEN(zfsvfs),\n\t    NULL, &tmp_gen, 8);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_UID(zfsvfs), NULL, &uid, 8);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_GID(zfsvfs), NULL, &gid, 8);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_PARENT(zfsvfs),\n\t    NULL, &parent, 8);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_FLAGS(zfsvfs), NULL,\n\t    &zp->z_pflags, 8);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_ATIME(zfsvfs), NULL,\n\t    &atime, 16);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_MTIME(zfsvfs), NULL,\n\t    &mtime, 16);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_CTIME(zfsvfs), NULL,\n\t    &ctime, 16);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_CRTIME(zfsvfs), NULL,\n\t    &crtime, 16);\n\tlinks = ZTONLNK(zp);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_LINKS(zfsvfs), NULL,\n\t    &links, 8);\n\tif (dmu_objset_projectquota_enabled(hdl->sa_os))\n\t\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_PROJID(zfsvfs), NULL,\n\t\t    &zp->z_projid, 8);\n\tif (Z_ISBLK(ZTOTYPE(zp)) || Z_ISCHR(ZTOTYPE(zp)))\n\t\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_RDEV(zfsvfs), NULL,\n\t\t    &rdev, 8);\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_DACL_COUNT(zfsvfs), NULL,\n\t    &zp->z_acl_cached->z_acl_count, 8);\n\n\tif (zp->z_acl_cached->z_version < ZFS_ACL_VERSION_FUID)\n\t\tzfs_acl_xform(zp, zp->z_acl_cached, CRED());\n\n\tlocate.cb_aclp = zp->z_acl_cached;\n\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_DACL_ACES(zfsvfs),\n\t    zfs_acl_data_locator, &locate, zp->z_acl_cached->z_acl_bytes);\n\n\tif (xattr)\n\t\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_XATTR(zfsvfs),\n\t\t    NULL, &xattr, 8);\n\n\t \n\n\tif (zp->z_pflags & ZFS_BONUS_SCANSTAMP) {\n\t\tmemcpy(scanstamp,\n\t\t    (caddr_t)db->db_data + ZFS_OLD_ZNODE_PHYS_SIZE,\n\t\t    AV_SCANSTAMP_SZ);\n\t\tSA_ADD_BULK_ATTR(sa_attrs, count, SA_ZPL_SCANSTAMP(zfsvfs),\n\t\t    NULL, scanstamp, AV_SCANSTAMP_SZ);\n\t\tzp->z_pflags &= ~ZFS_BONUS_SCANSTAMP;\n\t}\n\n\tVERIFY(dmu_set_bonustype(db, DMU_OT_SA, tx) == 0);\n\tVERIFY(sa_replace_all_by_template_locked(hdl, sa_attrs,\n\t    count, tx) == 0);\n\tif (znode_acl.z_acl_extern_obj)\n\t\tVERIFY(0 == dmu_object_free(zfsvfs->z_os,\n\t\t    znode_acl.z_acl_extern_obj, tx));\n\n\tzp->z_is_sa = B_TRUE;\n\tkmem_free(sa_attrs, sizeof (sa_bulk_attr_t) * ZPL_END);\ndone:\n\tkmem_free(bulk, sizeof (sa_bulk_attr_t) * ZPL_END);\n\tif (drop_lock)\n\t\tmutex_exit(&zp->z_lock);\n}\n\nvoid\nzfs_sa_upgrade_txholds(dmu_tx_t *tx, znode_t *zp)\n{\n\tif (!ZTOZSB(zp)->z_use_sa || zp->z_is_sa)\n\t\treturn;\n\n\n\tdmu_tx_hold_sa(tx, zp->z_sa_hdl, B_TRUE);\n\n\tif (zfs_external_acl(zp)) {\n\t\tdmu_tx_hold_free(tx, zfs_external_acl(zp), 0,\n\t\t    DMU_OBJECT_END);\n\t}\n}\n\nZFS_MODULE_PARAM(zfs, zfs_, zil_saxattr, INT, ZMOD_RW,\n\t\"Disable xattr=sa extended attribute logging in ZIL by settng 0.\");\n\nEXPORT_SYMBOL(zfs_attr_table);\nEXPORT_SYMBOL(zfs_sa_readlink);\nEXPORT_SYMBOL(zfs_sa_symlink);\nEXPORT_SYMBOL(zfs_sa_get_scanstamp);\nEXPORT_SYMBOL(zfs_sa_set_scanstamp);\nEXPORT_SYMBOL(zfs_sa_get_xattr);\nEXPORT_SYMBOL(zfs_sa_set_xattr);\nEXPORT_SYMBOL(zfs_sa_upgrade);\nEXPORT_SYMBOL(zfs_sa_upgrade_txholds);\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}