{
  "module_name": "ax_code_coverage.m4",
  "hash_id": "227df2a3aee4393fc52d96448eaf95434948731530f0196ba1b3b6d51143b200",
  "original_prompt": "Ingested from zfs-2.2.2/config/ax_code_coverage.m4",
  "human_readable_source": "# ===========================================================================\n#     https://www.gnu.org/software/autoconf-archive/ax_code_coverage.html\n# ===========================================================================\n#\n# SYNOPSIS\n#\n#   AX_CODE_COVERAGE()\n#\n# DESCRIPTION\n#\n#   Defines CODE_COVERAGE_CPPFLAGS, CODE_COVERAGE_CFLAGS,\n#   CODE_COVERAGE_CXXFLAGS and CODE_COVERAGE_LIBS which should be included\n#   in the CPPFLAGS, CFLAGS CXXFLAGS and LIBS/LIBADD variables of every\n#   build target (program or library) which should be built with code\n#   coverage support. Also defines CODE_COVERAGE_RULES which should be\n#   substituted in your Makefile; and $enable_code_coverage which can be\n#   used in subsequent configure output. CODE_COVERAGE_ENABLED is defined\n#   and substituted, and corresponds to the value of the\n#   --enable-code-coverage option, which defaults to being disabled.\n#\n#   Test also for gcov program and create GCOV variable that could be\n#   substituted.\n#\n#   Note that all optimization flags in CFLAGS must be disabled when code\n#   coverage is enabled.\n#\n#   Usage example:\n#\n#   configure.ac:\n#\n#     AX_CODE_COVERAGE\n#\n#   Makefile.am:\n#\n#     @CODE_COVERAGE_RULES@\n#     my_program_LIBS = ... $(CODE_COVERAGE_LIBS) ...\n#     my_program_CPPFLAGS = ... $(CODE_COVERAGE_CPPFLAGS) ...\n#     my_program_CFLAGS = ... $(CODE_COVERAGE_CFLAGS) ...\n#     my_program_CXXFLAGS = ... $(CODE_COVERAGE_CXXFLAGS) ...\n#\n#   This results in a \"check-code-coverage\" rule being added to any\n#   Makefile.am which includes \"@CODE_COVERAGE_RULES@\" (assuming the module\n#   has been configured with --enable-code-coverage). Running `make\n#   check-code-coverage` in that directory will run the module's test suite\n#   (`make check`) and build a code coverage report detailing the code which\n#   was touched, then print the URI for the report.\n#\n#   In earlier versions of this macro, CODE_COVERAGE_LDFLAGS was defined\n#   instead of CODE_COVERAGE_LIBS. They are both still defined, but use of\n#   CODE_COVERAGE_LIBS is preferred for clarity; CODE_COVERAGE_LDFLAGS is\n#   deprecated. They have the same value.\n#\n#   This code was derived from Makefile.decl in GLib, originally licensed\n#   under LGPLv2.1+.\n#\n# LICENSE\n#\n#   Copyright (c) 2012, 2016 Philip Withnall\n#   Copyright (c) 2012 Xan Lopez\n#   Copyright (c) 2012 Christian Persch\n#   Copyright (c) 2012 Paolo Borelli\n#   Copyright (c) 2012 Dan Winship\n#   Copyright (c) 2015 Bastien ROUCARIES\n#\n#   This library is free software; you can redistribute it and/or modify it\n#   under the terms of the GNU Lesser General Public License as published by\n#   the Free Software Foundation; either version 2.1 of the License, or (at\n#   your option) any later version.\n#\n#   This library is distributed in the hope that it will be useful, but\n#   WITHOUT ANY WARRANTY; without even the implied warranty of\n#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser\n#   General Public License for more details.\n#\n#   You should have received a copy of the GNU Lesser General Public License\n#   along with this program. If not, see <https://www.gnu.org/licenses/>.\n\n#serial 25\n\nAC_DEFUN([AX_CODE_COVERAGE],[\n\tdnl Check for --enable-code-coverage\n\tAC_REQUIRE([AC_PROG_SED])\n\n\t# allow to override gcov location\n\tAC_ARG_WITH([gcov],\n\t  [AS_HELP_STRING([--with-gcov[=GCOV]], [use given GCOV for coverage (GCOV=gcov).])],\n\t  [_AX_CODE_COVERAGE_GCOV_PROG_WITH=$with_gcov],\n\t  [_AX_CODE_COVERAGE_GCOV_PROG_WITH=gcov])\n\n\tAC_MSG_CHECKING([whether to build with code coverage support])\n\tAC_ARG_ENABLE([code-coverage],\n\t  AS_HELP_STRING([--enable-code-coverage],\n\t  [Whether to enable code coverage support]),,\n\t  enable_code_coverage=no)\n\n\tAM_CONDITIONAL([CODE_COVERAGE_ENABLED], [test x$enable_code_coverage = xyes])\n\tAC_SUBST([CODE_COVERAGE_ENABLED], [$enable_code_coverage])\n\tAC_MSG_RESULT($enable_code_coverage)\n\n\tAS_IF([ test \"$enable_code_coverage\" = \"yes\" ], [\n\t\t# check for gcov\n\t\tAC_CHECK_TOOL([GCOV],\n\t\t  [$_AX_CODE_COVERAGE_GCOV_PROG_WITH],\n\t\t  [:])\n\t\tAS_IF([test \"X$GCOV\" = \"X:\"],\n\t\t  [AC_MSG_ERROR([gcov is needed to do coverage])])\n\t\tAC_SUBST([GCOV])\n\n\t\tdnl Check if gcc is being used\n\t\tAS_IF([ test \"$GCC\" = \"no\" ], [\n\t\t\tAC_MSG_ERROR([not compiling with gcc, which is required for gcov code coverage])\n\t\t])\n\n\t\tAC_CHECK_PROG([LCOV], [lcov], [lcov])\n\t\tAC_CHECK_PROG([GENHTML], [genhtml], [genhtml])\n\n\t\tAS_IF([ test -z \"$LCOV\" ], [\n\t\t\tAC_MSG_ERROR([To enable code coverage reporting you must have lcov installed])\n\t\t])\n\n\t\tAS_IF([ test -z \"$GENHTML\" ], [\n\t\t\tAC_MSG_ERROR([Could not find genhtml from the lcov package])\n\t\t])\n\n\t\tdnl Build the code coverage flags\n\t\tdnl Define CODE_COVERAGE_LDFLAGS for backwards compatibility\n\t\tCODE_COVERAGE_CPPFLAGS=\"\"\n\t\tCODE_COVERAGE_CFLAGS=\"-O0 -g -fprofile-arcs -ftest-coverage\"\n\t\tCODE_COVERAGE_CXXFLAGS=\"-O0 -g -fprofile-arcs -ftest-coverage\"\n\t\tCODE_COVERAGE_LIBS=\"-lgcov\"\n\t\tCODE_COVERAGE_LDFLAGS=\"$CODE_COVERAGE_LIBS\"\n\n\t\tAC_SUBST([CODE_COVERAGE_CPPFLAGS])\n\t\tAC_SUBST([CODE_COVERAGE_CFLAGS])\n\t\tAC_SUBST([CODE_COVERAGE_CXXFLAGS])\n\t\tAC_SUBST([CODE_COVERAGE_LIBS])\n\t\tAC_SUBST([CODE_COVERAGE_LDFLAGS])\n\n\t\t[CODE_COVERAGE_RULES_CHECK='\n\t-$(A''M_V_at)$(MAKE) $(AM_MAKEFLAGS) -k check\n\t$(A''M_V_at)$(MAKE) $(AM_MAKEFLAGS) code-coverage-capture\n']\n\t\t[CODE_COVERAGE_RULES_CAPTURE='\n\t$(code_coverage_v_lcov_cap)$(LCOV) $(code_coverage_quiet) $(addprefix --directory ,$(CODE_COVERAGE_DIRECTORY)) --capture --output-file \"$(CODE_COVERAGE_OUTPUT_FILE).tmp\" --test-name \"$(call code_coverage_sanitize,$(PACKAGE_NAME)-$(PACKAGE_VERSION))\" --no-checksum --compat-libtool $(CODE_COVERAGE_LCOV_SHOPTS) $(CODE_COVERAGE_LCOV_OPTIONS)\n\t$(code_coverage_v_lcov_ign)$(LCOV) $(code_coverage_quiet) $(addprefix --directory ,$(CODE_COVERAGE_DIRECTORY)) --remove \"$(CODE_COVERAGE_OUTPUT_FILE).tmp\" $(CODE_COVERAGE_IGNORE_PATTERN) --output-file \"$(CODE_COVERAGE_OUTPUT_FILE)\" $(CODE_COVERAGE_LCOV_SHOPTS) $(CODE_COVERAGE_LCOV_RMOPTS)\n\t-@rm -f $(CODE_COVERAGE_OUTPUT_FILE).tmp\n\t$(code_coverage_v_genhtml)LANG=C $(GENHTML) $(code_coverage_quiet) $(addprefix --prefix ,$(CODE_COVERAGE_DIRECTORY)) --output-directory \"$(CODE_COVERAGE_OUTPUT_DIRECTORY)\" --title \"$(PACKAGE_NAME)-$(PACKAGE_VERSION) Code Coverage\" --legend --show-details \"$(CODE_COVERAGE_OUTPUT_FILE)\" $(CODE_COVERAGE_GENHTML_OPTIONS)\n\t@echo \"file://$(abs_builddir)/$(CODE_COVERAGE_OUTPUT_DIRECTORY)/index.html\"\n']\n\t\t[CODE_COVERAGE_RULES_CLEAN='\nclean: code-coverage-clean\ndistclean: code-coverage-clean\ncode-coverage-clean:\n\t-$(LCOV) --directory $(top_builddir) -z\n\t-rm -rf $(CODE_COVERAGE_OUTPUT_FILE) $(CODE_COVERAGE_OUTPUT_FILE).tmp $(CODE_COVERAGE_OUTPUT_DIRECTORY)\n\t-find . \\( -name \"*.gcda\" -o -name \"*.gcno\" -o -name \"*.gcov\" \\) -delete\n']\n\t], [\n\t\t[CODE_COVERAGE_RULES_CHECK='\n\t@echo \"Need to reconfigure with --enable-code-coverage\"\n']\n\t\tCODE_COVERAGE_RULES_CAPTURE=\"$CODE_COVERAGE_RULES_CHECK\"\n\t\tCODE_COVERAGE_RULES_CLEAN=''\n\t])\n\n[CODE_COVERAGE_RULES='\n# Code coverage\n#\n# Optional:\n#  - CODE_COVERAGE_DIRECTORY: Top-level directory for code coverage reporting.\n#    Multiple directories may be specified, separated by whitespace.\n#    (Default: $(top_builddir))\n#  - CODE_COVERAGE_OUTPUT_FILE: Filename and path for the .info file generated\n#    by lcov for code coverage. (Default:\n#    $(PACKAGE_NAME)-$(PACKAGE_VERSION)-coverage.info)\n#  - CODE_COVERAGE_OUTPUT_DIRECTORY: Directory for generated code coverage\n#    reports to be created. (Default:\n#    $(PACKAGE_NAME)-$(PACKAGE_VERSION)-coverage)\n#  - CODE_COVERAGE_BRANCH_COVERAGE: Set to 1 to enforce branch coverage,\n#    set to 0 to disable it and leave empty to stay with the default.\n#    (Default: empty)\n#  - CODE_COVERAGE_LCOV_SHOPTS_DEFAULT: Extra options shared between both lcov\n#    instances. (Default: based on $CODE_COVERAGE_BRANCH_COVERAGE)\n#  - CODE_COVERAGE_LCOV_SHOPTS: Extra options to shared between both lcov\n#    instances. (Default: $CODE_COVERAGE_LCOV_SHOPTS_DEFAULT)\n#  - CODE_COVERAGE_LCOV_OPTIONS_GCOVPATH: --gcov-tool pathtogcov\n#  - CODE_COVERAGE_LCOV_OPTIONS_DEFAULT: Extra options to pass to the\n#    collecting lcov instance. (Default: $CODE_COVERAGE_LCOV_OPTIONS_GCOVPATH)\n#  - CODE_COVERAGE_LCOV_OPTIONS: Extra options to pass to the collecting lcov\n#    instance. (Default: $CODE_COVERAGE_LCOV_OPTIONS_DEFAULT)\n#  - CODE_COVERAGE_LCOV_RMOPTS_DEFAULT: Extra options to pass to the filtering\n#    lcov instance. (Default: empty)\n#  - CODE_COVERAGE_LCOV_RMOPTS: Extra options to pass to the filtering lcov\n#    instance. (Default: $CODE_COVERAGE_LCOV_RMOPTS_DEFAULT)\n#  - CODE_COVERAGE_GENHTML_OPTIONS_DEFAULT: Extra options to pass to the\n#    genhtml instance. (Default: based on $CODE_COVERAGE_BRANCH_COVERAGE)\n#  - CODE_COVERAGE_GENHTML_OPTIONS: Extra options to pass to the genhtml\n#    instance. (Default: $CODE_COVERAGE_GENHTML_OPTIONS_DEFAULT)\n#  - CODE_COVERAGE_IGNORE_PATTERN: Extra glob pattern of files to ignore\n#\n# The generated report will be titled using the $(PACKAGE_NAME) and\n# $(PACKAGE_VERSION). In order to add the current git hash to the title,\n# use the git-version-gen script, available online.\n\n# Optional variables\nCODE_COVERAGE_DIRECTORY ?= $(top_builddir)\nCODE_COVERAGE_OUTPUT_FILE ?= $(PACKAGE_NAME)-$(PACKAGE_VERSION)-coverage.info\nCODE_COVERAGE_OUTPUT_DIRECTORY ?= $(PACKAGE_NAME)-$(PACKAGE_VERSION)-coverage\nCODE_COVERAGE_BRANCH_COVERAGE ?=\nCODE_COVERAGE_LCOV_SHOPTS_DEFAULT ?= $(if $(CODE_COVERAGE_BRANCH_COVERAGE),\\\n--rc lcov_branch_coverage=$(CODE_COVERAGE_BRANCH_COVERAGE))\nCODE_COVERAGE_LCOV_SHOPTS ?= $(CODE_COVERAGE_LCOV_SHOPTS_DEFAULT)\nCODE_COVERAGE_LCOV_OPTIONS_GCOVPATH ?= --gcov-tool \"$(GCOV)\"\nCODE_COVERAGE_LCOV_OPTIONS_DEFAULT ?= $(CODE_COVERAGE_LCOV_OPTIONS_GCOVPATH)\nCODE_COVERAGE_LCOV_OPTIONS ?= $(CODE_COVERAGE_LCOV_OPTIONS_DEFAULT)\nCODE_COVERAGE_LCOV_RMOPTS_DEFAULT ?=\nCODE_COVERAGE_LCOV_RMOPTS ?= $(CODE_COVERAGE_LCOV_RMOPTS_DEFAULT)\nCODE_COVERAGE_GENHTML_OPTIONS_DEFAULT ?=\\\n$(if $(CODE_COVERAGE_BRANCH_COVERAGE),\\\n--rc genhtml_branch_coverage=$(CODE_COVERAGE_BRANCH_COVERAGE))\nCODE_COVERAGE_GENHTML_OPTIONS ?= $(CODE_COVERAGE_GENHTML_OPTIONS_DEFAULT)\n\n# Add any folders you want to ignore here\n# Ignore tmp and tests themselves\nCODE_COVERAGE_IGNORE_PATTERN ?= \"/tmp/*\" \"*/tests/*\"\nCODE_COVERAGE_IGNORE_PATTERN += \"*/module/zstd/lib/*\"\nCODE_COVERAGE_IGNORE_PATTERN += \"*/module/zfs/lz4.c\"\n\nGITIGNOREFILES ?=\nGITIGNOREFILES += $(CODE_COVERAGE_OUTPUT_FILE) $(CODE_COVERAGE_OUTPUT_DIRECTORY)\n\ncode_coverage_v_lcov_cap = $(code_coverage_v_lcov_cap_$(V))\ncode_coverage_v_lcov_cap_ = $(code_coverage_v_lcov_cap_$(AM_DEFAULT_VERBOSITY))\ncode_coverage_v_lcov_cap_0 = @echo \"  LCOV   --capture\"\\\n $(CODE_COVERAGE_OUTPUT_FILE);\ncode_coverage_v_lcov_ign = $(code_coverage_v_lcov_ign_$(V))\ncode_coverage_v_lcov_ign_ = $(code_coverage_v_lcov_ign_$(AM_DEFAULT_VERBOSITY))\ncode_coverage_v_lcov_ign_0 = @echo \"  LCOV   --remove /tmp/*\"\\\n $(CODE_COVERAGE_IGNORE_PATTERN);\ncode_coverage_v_genhtml = $(code_coverage_v_genhtml_$(V))\ncode_coverage_v_genhtml_ = $(code_coverage_v_genhtml_$(AM_DEFAULT_VERBOSITY))\ncode_coverage_v_genhtml_0 = @echo \"  GEN   \" $(CODE_COVERAGE_OUTPUT_DIRECTORY);\ncode_coverage_quiet = $(code_coverage_quiet_$(V))\ncode_coverage_quiet_ = $(code_coverage_quiet_$(AM_DEFAULT_VERBOSITY))\ncode_coverage_quiet_0 = --quiet\n\n# sanitizes the test-name: replaces with underscores: dashes and dots\ncode_coverage_sanitize = $(subst -,_,$(subst .,_,$(1)))\n\n# Use recursive makes in order to ignore errors during check\ncheck-code-coverage:'\"$CODE_COVERAGE_RULES_CHECK\"'\n\n# Capture code coverage data\ncode-coverage-capture: code-coverage-capture-hook'\"$CODE_COVERAGE_RULES_CAPTURE\"'\n\n# Hook rule executed before code-coverage-capture, overridable by the user\ncode-coverage-capture-hook:\n\n'\"$CODE_COVERAGE_RULES_CLEAN\"'\n\nA''M_DISTCHECK_CONFIGURE_FLAGS ?=\nA''M_DISTCHECK_CONFIGURE_FLAGS += --disable-code-coverage\n\n.PHONY: check-code-coverage code-coverage-capture code-coverage-capture-hook code-coverage-clean\n']\n\n\tAC_SUBST([CODE_COVERAGE_RULES])\n\tm4_ifdef([_AM_SUBST_NOTMAKE], [_AM_SUBST_NOTMAKE([CODE_COVERAGE_RULES])])\n])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}