{
  "module_name": "kernel-generic_io_acct.m4",
  "hash_id": "1c03e0677cafe802040a028aca517c2690f545e76f4d98b7d0084d84ef258344",
  "original_prompt": "Ingested from zfs-2.2.2/config/kernel-generic_io_acct.m4",
  "human_readable_source": "dnl #\ndnl # Check for generic io accounting interface.\ndnl #\nAC_DEFUN([ZFS_AC_KERNEL_SRC_GENERIC_IO_ACCT], [\n\tZFS_LINUX_TEST_SRC([bdev_io_acct_63], [\n\t\t#include <linux/blkdev.h>\n\t], [\n\t\tstruct block_device *bdev = NULL;\n\t\tstruct bio *bio = NULL;\n\t\tunsigned long passed_time = 0;\n\t\tunsigned long start_time;\n\n\t\tstart_time = bdev_start_io_acct(bdev, bio_op(bio),\n\t\t    passed_time);\n\t\tbdev_end_io_acct(bdev, bio_op(bio), bio_sectors(bio), start_time);\n\t])\n\n\tZFS_LINUX_TEST_SRC([bdev_io_acct_old], [\n\t\t#include <linux/blkdev.h>\n\t], [\n\t\tstruct block_device *bdev = NULL;\n\t\tstruct bio *bio = NULL;\n\t\tunsigned long passed_time = 0;\n\t\tunsigned long start_time;\n\n\t\tstart_time = bdev_start_io_acct(bdev, bio_sectors(bio),\n\t\t    bio_op(bio), passed_time);\n\t\tbdev_end_io_acct(bdev, bio_op(bio), start_time);\n\t])\n\n\tZFS_LINUX_TEST_SRC([disk_io_acct], [\n\t\t#include <linux/blkdev.h>\n\t], [\n\t\tstruct gendisk *disk = NULL;\n\t\tstruct bio *bio = NULL;\n\t\tunsigned long start_time;\n\n\t\tstart_time = disk_start_io_acct(disk, bio_sectors(bio), bio_op(bio));\n\t\tdisk_end_io_acct(disk, bio_op(bio), start_time);\n\t])\n\n\tZFS_LINUX_TEST_SRC([bio_io_acct], [\n\t\t#include <linux/blkdev.h>\n\t], [\n\t\tstruct bio *bio = NULL;\n\t\tunsigned long start_time;\n\n\t\tstart_time = bio_start_io_acct(bio);\n\t\tbio_end_io_acct(bio, start_time);\n\t])\n\n\tZFS_LINUX_TEST_SRC([generic_acct_3args], [\n\t\t#include <linux/bio.h>\n\n\t\tvoid (*generic_start_io_acct_f)(int, unsigned long,\n\t\t    struct hd_struct *) = &generic_start_io_acct;\n\t\tvoid (*generic_end_io_acct_f)(int, struct hd_struct *,\n\t\t    unsigned long) = &generic_end_io_acct;\n\t], [\n\t\tgeneric_start_io_acct(0, 0, NULL);\n\t\tgeneric_end_io_acct(0, NULL, 0);\n\t])\n\n\tZFS_LINUX_TEST_SRC([generic_acct_4args], [\n\t\t#include <linux/bio.h>\n\n\t\tvoid (*generic_start_io_acct_f)(struct request_queue *, int,\n\t\t    unsigned long, struct hd_struct *) = &generic_start_io_acct;\n\t\tvoid (*generic_end_io_acct_f)(struct request_queue *, int,\n\t\t    struct hd_struct *, unsigned long) = &generic_end_io_acct;\n\t], [\n\t\tgeneric_start_io_acct(NULL, 0, 0, NULL);\n\t\tgeneric_end_io_acct(NULL, 0, NULL, 0);\n\t])\n])\n\nAC_DEFUN([ZFS_AC_KERNEL_GENERIC_IO_ACCT], [\n\tdnl #\n\tdnl # Linux 6.3, and then backports thereof, changed\n\tdnl # the signatures on bdev_start_io_acct/bdev_end_io_acct\n\tdnl #\n\tAC_MSG_CHECKING([whether 6.3+ bdev_*_io_acct() are available])\n\tZFS_LINUX_TEST_RESULT([bdev_io_acct_63], [\n\t\tAC_MSG_RESULT(yes)\n\t\tAC_DEFINE(HAVE_BDEV_IO_ACCT_63, 1, [bdev_*_io_acct() available])\n\t], [\n\t\tAC_MSG_RESULT(no)\n\n\t\tdnl #\n\t\tdnl # 5.19 API,\n\t\tdnl #\n\t\tdnl # disk_start_io_acct() and disk_end_io_acct() have been replaced by\n\t\tdnl # bdev_start_io_acct() and bdev_end_io_acct().\n\t\tdnl #\n\t\tAC_MSG_CHECKING([whether pre-6.3 bdev_*_io_acct() are available])\n\t\tZFS_LINUX_TEST_RESULT([bdev_io_acct_old], [\n\t\t\tAC_MSG_RESULT(yes)\n\t\t\tAC_DEFINE(HAVE_BDEV_IO_ACCT_OLD, 1, [bdev_*_io_acct() available])\n\t\t], [\n\t\t\tAC_MSG_RESULT(no)\n\t\t\tdnl #\n\t\t\tdnl # 5.12 API,\n\t\t\tdnl #\n\t\t\tdnl # bio_start_io_acct() and bio_end_io_acct() became GPL-exported\n\t\t\tdnl # so use disk_start_io_acct() and disk_end_io_acct() instead\n\t\t\tdnl #\n\t\t\tAC_MSG_CHECKING([whether generic disk_*_io_acct() are available])\n\t\t\tZFS_LINUX_TEST_RESULT([disk_io_acct], [\n\t\t\t\tAC_MSG_RESULT(yes)\n\t\t\t\tAC_DEFINE(HAVE_DISK_IO_ACCT, 1, [disk_*_io_acct() available])\n\t\t\t], [\n\t\t\t\tAC_MSG_RESULT(no)\n\n\t\t\t\tdnl #\n\t\t\t\tdnl # 5.7 API,\n\t\t\t\tdnl #\n\t\t\t\tdnl # Added bio_start_io_acct() and bio_end_io_acct() helpers.\n\t\t\t\tdnl #\n\t\t\t\tAC_MSG_CHECKING([whether generic bio_*_io_acct() are available])\n\t\t\t\tZFS_LINUX_TEST_RESULT([bio_io_acct], [\n\t\t\t\t\tAC_MSG_RESULT(yes)\n\t\t\t\t\tAC_DEFINE(HAVE_BIO_IO_ACCT, 1, [bio_*_io_acct() available])\n\t\t\t\t], [\n\t\t\t\t\tAC_MSG_RESULT(no)\n\n\t\t\t\t\tdnl #\n\t\t\t\t\tdnl # 4.14 API,\n\t\t\t\t\tdnl #\n\t\t\t\t\tdnl # generic_start_io_acct/generic_end_io_acct now require\n\t\t\t\t\tdnl # request_queue to be provided. No functional changes,\n\t\t\t\t\tdnl # but preparation for inflight accounting.\n\t\t\t\t\tdnl #\n\t\t\t\t\tAC_MSG_CHECKING([whether generic_*_io_acct wants 4 args])\n\t\t\t\t\tZFS_LINUX_TEST_RESULT_SYMBOL([generic_acct_4args],\n\t\t\t\t\t    [generic_start_io_acct], [block/bio.c], [\n\t\t\t\t\t\tAC_MSG_RESULT(yes)\n\t\t\t\t\t\tAC_DEFINE(HAVE_GENERIC_IO_ACCT_4ARG, 1,\n\t\t\t\t\t\t    [generic_*_io_acct() 4 arg available])\n\t\t\t\t\t], [\n\t\t\t\t\t\tAC_MSG_RESULT(no)\n\n\t\t\t\t\t\tdnl #\n\t\t\t\t\t\tdnl # 3.19 API addition\n\t\t\t\t\t\tdnl #\n\t\t\t\t\t\tdnl # torvalds/linux@394ffa50 allows us to increment\n\t\t\t\t\t\tdnl # iostat counters without generic_make_request().\n\t\t\t\t\t\tdnl #\n\t\t\t\t\t\tAC_MSG_CHECKING(\n\t\t\t\t\t\t    [whether generic_*_io_acct wants 3 args])\n\t\t\t\t\t\tZFS_LINUX_TEST_RESULT_SYMBOL([generic_acct_3args],\n\t\t\t\t\t\t    [generic_start_io_acct], [block/bio.c], [\n\t\t\t\t\t\t\tAC_MSG_RESULT(yes)\n\t\t\t\t\t\t\tAC_DEFINE(HAVE_GENERIC_IO_ACCT_3ARG, 1,\n\t\t\t\t\t\t\t    [generic_*_io_acct() 3 arg available])\n\t\t\t\t\t\t], [\n\t\t\t\t\t\t\tAC_MSG_RESULT(no)\n\t\t\t\t\t\t])\n\t\t\t\t\t])\n\t\t\t\t])\n\t\t\t])\n\t\t])\n\t])\n])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}