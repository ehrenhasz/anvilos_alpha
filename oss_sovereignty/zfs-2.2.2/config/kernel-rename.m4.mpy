{
  "module_name": "kernel-rename.m4",
  "hash_id": "8d99a8af3d32be3ea2992a6a6f7c44701d28aaf3766a1f146a4c7c7188311a4b",
  "original_prompt": "Ingested from zfs-2.2.2/config/kernel-rename.m4",
  "human_readable_source": "AC_DEFUN([ZFS_AC_KERNEL_SRC_RENAME], [\n\tdnl #\n\tdnl # 3.9 (to 4.9) API change,\n\tdnl #\n\tdnl # A new version of iops->rename() was added (rename2) that takes a flag\n\tdnl # argument (to support renameat2). However this separate function was\n\tdnl # merged back into iops->rename() in Linux 4.9.\n\tdnl #\n\tZFS_LINUX_TEST_SRC([inode_operations_rename2], [\n\t\t#include <linux/fs.h>\n\t\tint rename2_fn(struct inode *sip, struct dentry *sdp,\n\t\t\tstruct inode *tip, struct dentry *tdp,\n\t\t\tunsigned int flags) { return 0; }\n\n\t\tstatic const struct inode_operations\n\t\t    iops __attribute__ ((unused)) = {\n\t\t\t.rename2 = rename2_fn,\n\t\t};\n\t],[])\n\n\tdnl #\n\tdnl # 4.9 API change,\n\tdnl #\n\tdnl # iops->rename2() merged into iops->rename(), and iops->rename() now\n\tdnl # wants flags.\n\tdnl #\n\tZFS_LINUX_TEST_SRC([inode_operations_rename_flags], [\n\t\t#include <linux/fs.h>\n\t\tint rename_fn(struct inode *sip, struct dentry *sdp,\n\t\t\tstruct inode *tip, struct dentry *tdp,\n\t\t\tunsigned int flags) { return 0; }\n\n\t\tstatic const struct inode_operations\n\t\t    iops __attribute__ ((unused)) = {\n\t\t\t.rename = rename_fn,\n\t\t};\n\t],[])\n\n\tdnl #\n\tdnl # EL7 compatibility\n\tdnl #\n\tdnl # EL7 has backported renameat2 support, but it's done by defining a\n\tdnl # separate iops wrapper structure that takes the .renameat2 function.\n\tdnl #\n\tZFS_LINUX_TEST_SRC([dir_inode_operations_wrapper_rename2], [\n\t\t#include <linux/fs.h>\n\t\tint rename2_fn(struct inode *sip, struct dentry *sdp,\n\t\t\tstruct inode *tip, struct dentry *tdp,\n\t\t\tunsigned int flags) { return 0; }\n\n\t\tstatic const struct inode_operations_wrapper\n\t\t    iops __attribute__ ((unused)) = {\n\t\t\t.rename2 = rename2_fn,\n\t\t};\n\t],[])\n\n\tdnl #\n\tdnl # 5.12 API change,\n\tdnl #\n\tdnl # Linux 5.12 introduced passing struct user_namespace* as the first\n\tdnl # argument of the rename() and other inode_operations members.\n\tdnl #\n\tZFS_LINUX_TEST_SRC([inode_operations_rename_userns], [\n\t\t#include <linux/fs.h>\n\t\tint rename_fn(struct user_namespace *user_ns, struct inode *sip,\n\t\t\tstruct dentry *sdp, struct inode *tip, struct dentry *tdp,\n\t\t\tunsigned int flags) { return 0; }\n\n\t\tstatic const struct inode_operations\n\t\t    iops __attribute__ ((unused)) = {\n\t\t\t.rename = rename_fn,\n\t\t};\n\t],[])\n\n\tdnl #\n\tdnl # 6.3 API change - the first arg is now struct mnt_idmap*\n\tdnl #\n\tZFS_LINUX_TEST_SRC([inode_operations_rename_mnt_idmap], [\n\t\t#include <linux/fs.h>\n\t\tint rename_fn(struct mnt_idmap *idmap, struct inode *sip,\n\t\t\tstruct dentry *sdp, struct inode *tip, struct dentry *tdp,\n\t\t\tunsigned int flags) { return 0; }\n\n\t\tstatic const struct inode_operations\n\t\t    iops __attribute__ ((unused)) = {\n\t\t\t.rename = rename_fn,\n\t\t};\n\t],[])\n])\n\nAC_DEFUN([ZFS_AC_KERNEL_RENAME], [\n\tAC_MSG_CHECKING([whether iops->rename() takes struct mnt_idmap*])\n\tZFS_LINUX_TEST_RESULT([inode_operations_rename_mnt_idmap], [\n\t\tAC_MSG_RESULT(yes)\n\t\tAC_DEFINE(HAVE_IOPS_RENAME_IDMAP, 1,\n\t\t    [iops->rename() takes struct mnt_idmap*])\n\t],[\n\t\tAC_MSG_CHECKING([whether iops->rename() takes struct user_namespace*])\n\t\tZFS_LINUX_TEST_RESULT([inode_operations_rename_userns], [\n\t\t\tAC_MSG_RESULT(yes)\n\t\t\tAC_DEFINE(HAVE_IOPS_RENAME_USERNS, 1,\n\t\t\t    [iops->rename() takes struct user_namespace*])\n\t\t],[\n\t\t\tAC_MSG_RESULT(no)\n\n\t\t\tAC_MSG_CHECKING([whether iops->rename2() exists])\n\t\t\tZFS_LINUX_TEST_RESULT([inode_operations_rename2], [\n\t\t\t\tAC_MSG_RESULT(yes)\n\t\t\t\tAC_DEFINE(HAVE_RENAME2, 1, [iops->rename2() exists])\n\t\t\t],[\n\t\t\t\tAC_MSG_RESULT(no)\n\n\t\t\t\tAC_MSG_CHECKING([whether iops->rename() wants flags])\n\t\t\t\tZFS_LINUX_TEST_RESULT([inode_operations_rename_flags], [\n\t\t\t\t\tAC_MSG_RESULT(yes)\n\t\t\t\t\tAC_DEFINE(HAVE_RENAME_WANTS_FLAGS, 1,\n\t\t\t\t\t\t[iops->rename() wants flags])\n\t\t\t\t],[\n\t\t\t\t\tAC_MSG_RESULT(no)\n\n\t\t\t\t\tAC_MSG_CHECKING([whether struct inode_operations_wrapper takes .rename2()])\n\t\t\t\t\tZFS_LINUX_TEST_RESULT([dir_inode_operations_wrapper_rename2], [\n\t\t\t\t\t\tAC_MSG_RESULT(yes)\n\t\t\t\t\t\tAC_DEFINE(HAVE_RENAME2_OPERATIONS_WRAPPER, 1,\n\t\t\t\t\t\t\t[struct inode_operations_wrapper takes .rename2()])\n\t\t\t\t\t],[\n\t\t\t\t\t\tAC_MSG_RESULT(no)\n\t\t\t\t\t])\n\t\t\t\t])\n\t\t\t])\n\t\t])\n\t])\n])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}