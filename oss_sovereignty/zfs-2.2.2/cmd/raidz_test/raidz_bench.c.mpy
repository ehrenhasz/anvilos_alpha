{
  "module_name": "raidz_bench.c",
  "hash_id": "1c7c46e3a8b8e8fa29b053078ee4b64f66bfa3c5548106ea01eeb4361a007437",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/raidz_test/raidz_bench.c",
  "human_readable_source": " \n\n \n\n#include <sys/zfs_context.h>\n#include <sys/time.h>\n#include <sys/wait.h>\n#include <sys/zio.h>\n#include <sys/vdev_raidz.h>\n#include <sys/vdev_raidz_impl.h>\n#include <stdio.h>\n\n#include \"raidz_test.h\"\n\n#define\tGEN_BENCH_MEMORY\t(((uint64_t)1ULL)<<32)\n#define\tREC_BENCH_MEMORY\t(((uint64_t)1ULL)<<29)\n#define\tBENCH_ASHIFT\t\t12\n#define\tMIN_CS_SHIFT\t\tBENCH_ASHIFT\n#define\tMAX_CS_SHIFT\t\tSPA_MAXBLOCKSHIFT\n\nstatic zio_t zio_bench;\nstatic raidz_map_t *rm_bench;\nstatic size_t max_data_size = SPA_MAXBLOCKSIZE;\n\nstatic void\nbench_init_raidz_map(void)\n{\n\tzio_bench.io_offset = 0;\n\tzio_bench.io_size = max_data_size;\n\n\t \n\tzio_bench.io_abd = raidz_alloc(max_data_size);\n\n\tinit_zio_abd(&zio_bench);\n}\n\nstatic void\nbench_fini_raidz_maps(void)\n{\n\t \n\traidz_free(zio_bench.io_abd, max_data_size);\n\tmemset(&zio_bench, 0, sizeof (zio_t));\n}\n\nstatic inline void\nrun_gen_bench_impl(const char *impl)\n{\n\tint fn, ncols;\n\tuint64_t ds, iter_cnt, iter, disksize;\n\thrtime_t start;\n\tdouble elapsed, d_bw;\n\n\t \n\tfor (fn = 0; fn < RAIDZ_GEN_NUM; fn++) {\n\n\t\tfor (ds = MIN_CS_SHIFT; ds <= MAX_CS_SHIFT; ds++) {\n\t\t\t \n\t\t\tncols = rto_opts.rto_dcols + fn + 1;\n\t\t\tzio_bench.io_size = 1ULL << ds;\n\n\t\t\tif (rto_opts.rto_expand) {\n\t\t\t\trm_bench = vdev_raidz_map_alloc_expanded(\n\t\t\t\t    zio_bench.io_abd,\n\t\t\t\t    zio_bench.io_size, zio_bench.io_offset,\n\t\t\t\t    rto_opts.rto_ashift, ncols+1, ncols,\n\t\t\t\t    fn+1, rto_opts.rto_expand_offset);\n\t\t\t} else {\n\t\t\t\trm_bench = vdev_raidz_map_alloc(&zio_bench,\n\t\t\t\t    BENCH_ASHIFT, ncols, fn+1);\n\t\t\t}\n\n\t\t\t \n\t\t\titer_cnt = GEN_BENCH_MEMORY;\n\t\t\titer_cnt /= zio_bench.io_size;\n\n\t\t\tstart = gethrtime();\n\t\t\tfor (iter = 0; iter < iter_cnt; iter++)\n\t\t\t\tvdev_raidz_generate_parity(rm_bench);\n\t\t\telapsed = NSEC2SEC((double)(gethrtime() - start));\n\n\t\t\tdisksize = (1ULL << ds) / rto_opts.rto_dcols;\n\t\t\td_bw = (double)iter_cnt * (double)disksize;\n\t\t\td_bw /= (1024.0 * 1024.0 * elapsed);\n\n\t\t\tLOG(D_ALL, \"%10s, %8s, %zu, %10llu, %lf, %lf, %u\\n\",\n\t\t\t    impl,\n\t\t\t    raidz_gen_name[fn],\n\t\t\t    rto_opts.rto_dcols,\n\t\t\t    (1ULL<<ds),\n\t\t\t    d_bw,\n\t\t\t    d_bw * (double)(ncols),\n\t\t\t    (unsigned)iter_cnt);\n\n\t\t\tvdev_raidz_map_free(rm_bench);\n\t\t}\n\t}\n}\n\nstatic void\nrun_gen_bench(void)\n{\n\tchar **impl_name;\n\n\tLOG(D_INFO, DBLSEP \"\\nBenchmarking parity generation...\\n\\n\");\n\tLOG(D_ALL, \"impl, math, dcols, iosize, disk_bw, total_bw, iter\\n\");\n\n\tfor (impl_name = (char **)raidz_impl_names; *impl_name != NULL;\n\t    impl_name++) {\n\n\t\tif (vdev_raidz_impl_set(*impl_name) != 0)\n\t\t\tcontinue;\n\n\t\trun_gen_bench_impl(*impl_name);\n\t}\n}\n\nstatic void\nrun_rec_bench_impl(const char *impl)\n{\n\tint fn, ncols, nbad;\n\tuint64_t ds, iter_cnt, iter, disksize;\n\thrtime_t start;\n\tdouble elapsed, d_bw;\n\tstatic const int tgt[7][3] = {\n\t\t{1, 2, 3},\t \n\t\t{0, 2, 3},\t \n\t\t{0, 1, 3},\t \n\t\t{2, 3, 4},\t \n\t\t{1, 3, 4},\t \n\t\t{0, 3, 4},\t \n\t\t{3, 4, 5}\t \n\t};\n\n\tfor (fn = 0; fn < RAIDZ_REC_NUM; fn++) {\n\t\tfor (ds = MIN_CS_SHIFT; ds <= MAX_CS_SHIFT; ds++) {\n\n\t\t\t \n\t\t\tncols = rto_opts.rto_dcols + PARITY_PQR;\n\t\t\tzio_bench.io_size = 1ULL << ds;\n\n\t\t\t \n\t\t\tif (zio_bench.io_size / rto_opts.rto_dcols <\n\t\t\t    (1ULL << BENCH_ASHIFT))\n\t\t\t\tcontinue;\n\n\t\t\tif (rto_opts.rto_expand) {\n\t\t\t\trm_bench = vdev_raidz_map_alloc_expanded(\n\t\t\t\t    zio_bench.io_abd,\n\t\t\t\t    zio_bench.io_size, zio_bench.io_offset,\n\t\t\t\t    BENCH_ASHIFT, ncols+1, ncols,\n\t\t\t\t    PARITY_PQR, rto_opts.rto_expand_offset);\n\t\t\t} else {\n\t\t\t\trm_bench = vdev_raidz_map_alloc(&zio_bench,\n\t\t\t\t    BENCH_ASHIFT, ncols, PARITY_PQR);\n\t\t\t}\n\n\t\t\t \n\t\t\titer_cnt = (REC_BENCH_MEMORY);\n\t\t\titer_cnt /= zio_bench.io_size;\n\n\t\t\t \n\t\t\tnbad = MIN(3, raidz_ncols(rm_bench) -\n\t\t\t    raidz_parity(rm_bench));\n\n\t\t\tstart = gethrtime();\n\t\t\tfor (iter = 0; iter < iter_cnt; iter++)\n\t\t\t\tvdev_raidz_reconstruct(rm_bench, tgt[fn], nbad);\n\t\t\telapsed = NSEC2SEC((double)(gethrtime() - start));\n\n\t\t\tdisksize = (1ULL << ds) / rto_opts.rto_dcols;\n\t\t\td_bw = (double)iter_cnt * (double)(disksize);\n\t\t\td_bw /= (1024.0 * 1024.0 * elapsed);\n\n\t\t\tLOG(D_ALL, \"%10s, %8s, %zu, %10llu, %lf, %lf, %u\\n\",\n\t\t\t    impl,\n\t\t\t    raidz_rec_name[fn],\n\t\t\t    rto_opts.rto_dcols,\n\t\t\t    (1ULL<<ds),\n\t\t\t    d_bw,\n\t\t\t    d_bw * (double)ncols,\n\t\t\t    (unsigned)iter_cnt);\n\n\t\t\tvdev_raidz_map_free(rm_bench);\n\t\t}\n\t}\n}\n\nstatic void\nrun_rec_bench(void)\n{\n\tchar **impl_name;\n\n\tLOG(D_INFO, DBLSEP \"\\nBenchmarking data reconstruction...\\n\\n\");\n\tLOG(D_ALL, \"impl, math, dcols, iosize, disk_bw, total_bw, iter\\n\");\n\n\tfor (impl_name = (char **)raidz_impl_names; *impl_name != NULL;\n\t    impl_name++) {\n\n\t\tif (vdev_raidz_impl_set(*impl_name) != 0)\n\t\t\tcontinue;\n\n\t\trun_rec_bench_impl(*impl_name);\n\t}\n}\n\nvoid\nrun_raidz_benchmark(void)\n{\n\tbench_init_raidz_map();\n\n\trun_gen_bench();\n\trun_rec_bench();\n\n\tbench_fini_raidz_maps();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}