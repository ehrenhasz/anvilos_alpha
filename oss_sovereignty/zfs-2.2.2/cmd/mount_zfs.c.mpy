{
  "module_name": "mount_zfs.c",
  "hash_id": "e167a1fdd95629c0e7978791dab0da06e116219441ce6cb58bc23f972d88e56c",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/mount_zfs.c",
  "human_readable_source": " \n\n \n\n#include <libintl.h>\n#include <unistd.h>\n#include <sys/file.h>\n#include <sys/mount.h>\n#include <sys/mntent.h>\n#include <sys/stat.h>\n#include <libzfs.h>\n#include <libzutil.h>\n#include <locale.h>\n#include <getopt.h>\n#include <fcntl.h>\n#include <errno.h>\n\n#define\tZS_COMMENT\t0x00000000\t \n#define\tZS_ZFSUTIL\t0x00000001\t \n\nlibzfs_handle_t *g_zfs;\n\n \nstatic void\nparse_dataset(const char *target, char **dataset)\n{\n\t \n\tchar cwd[PATH_MAX];\n\tif (getcwd(cwd, PATH_MAX) == NULL) {\n\t\tperror(\"getcwd\");\n\t\treturn;\n\t}\n\tint len = strlen(cwd);\n\tif (strncmp(cwd, target, len) == 0)\n\t\ttarget += len;\n\n\t \n\tstrlcpy(*dataset, target, PATH_MAX);\n\n\tint fd = open(target, O_RDONLY | O_CLOEXEC);\n\tif (fd < 0)\n\t\treturn;\n\n\tnvlist_t *cfg = NULL;\n\tif (zpool_read_label(fd, &cfg, NULL) == 0) {\n\t\tconst char *nm = NULL;\n\t\tif (!nvlist_lookup_string(cfg, ZPOOL_CONFIG_POOL_NAME, &nm))\n\t\t\tstrlcpy(*dataset, nm, PATH_MAX);\n\t\tnvlist_free(cfg);\n\t}\n\n\tif (close(fd))\n\t\tperror(\"close\");\n}\n\n \nstatic int\nmtab_is_writeable(void)\n{\n\tstruct stat st;\n\tint error, fd;\n\n\terror = lstat(\"/etc/mtab\", &st);\n\tif (error || S_ISLNK(st.st_mode))\n\t\treturn (0);\n\n\tfd = open(\"/etc/mtab\", O_RDWR | O_CREAT, 0644);\n\tif (fd < 0)\n\t\treturn (0);\n\n\tclose(fd);\n\treturn (1);\n}\n\nstatic int\nmtab_update(const char *dataset, const char *mntpoint, const char *type,\n    const char *mntopts)\n{\n\tstruct mntent mnt;\n\tFILE *fp;\n\tint error;\n\n\tmnt.mnt_fsname = (char *)dataset;\n\tmnt.mnt_dir = (char *)mntpoint;\n\tmnt.mnt_type = (char *)type;\n\tmnt.mnt_opts = (char *)(mntopts ?: \"\");\n\tmnt.mnt_freq = 0;\n\tmnt.mnt_passno = 0;\n\n\tfp = setmntent(\"/etc/mtab\", \"a+e\");\n\tif (!fp) {\n\t\t(void) fprintf(stderr, gettext(\n\t\t    \"filesystem '%s' was mounted, but /etc/mtab \"\n\t\t    \"could not be opened due to error: %s\\n\"),\n\t\t    dataset, strerror(errno));\n\t\treturn (MOUNT_FILEIO);\n\t}\n\n\terror = addmntent(fp, &mnt);\n\tif (error) {\n\t\t(void) fprintf(stderr, gettext(\n\t\t    \"filesystem '%s' was mounted, but /etc/mtab \"\n\t\t    \"could not be updated due to error: %s\\n\"),\n\t\t    dataset, strerror(errno));\n\t\treturn (MOUNT_FILEIO);\n\t}\n\n\t(void) endmntent(fp);\n\n\treturn (MOUNT_SUCCESS);\n}\n\nint\nmain(int argc, char **argv)\n{\n\tzfs_handle_t *zhp;\n\tchar prop[ZFS_MAXPROPLEN];\n\tuint64_t zfs_version = 0;\n\tchar mntopts[MNT_LINE_MAX] = { '\\0' };\n\tchar badopt[MNT_LINE_MAX] = { '\\0' };\n\tchar mtabopt[MNT_LINE_MAX] = { '\\0' };\n\tchar mntpoint[PATH_MAX];\n\tchar dataset[PATH_MAX], *pdataset = dataset;\n\tunsigned long mntflags = 0, zfsflags = 0, remount = 0;\n\tint sloppy = 0, fake = 0, verbose = 0, nomtab = 0, zfsutil = 0;\n\tint error, c;\n\n\t(void) setlocale(LC_ALL, \"\");\n\t(void) setlocale(LC_NUMERIC, \"C\");\n\t(void) textdomain(TEXT_DOMAIN);\n\n\topterr = 0;\n\n\t \n\twhile ((c = getopt_long(argc, argv, \"sfnvo:h?\", 0, 0)) != -1) {\n\t\tswitch (c) {\n\t\tcase 's':\n\t\t\tsloppy = 1;\n\t\t\tbreak;\n\t\tcase 'f':\n\t\t\tfake = 1;\n\t\t\tbreak;\n\t\tcase 'n':\n\t\t\tnomtab = 1;\n\t\t\tbreak;\n\t\tcase 'v':\n\t\t\tverbose++;\n\t\t\tbreak;\n\t\tcase 'o':\n\t\t\t(void) strlcpy(mntopts, optarg, sizeof (mntopts));\n\t\t\tbreak;\n\t\tcase 'h':\n\t\tcase '?':\n\t\t\tif (optopt)\n\t\t\t\t(void) fprintf(stderr,\n\t\t\t\t    gettext(\"Invalid option '%c'\\n\"), optopt);\n\t\t\t(void) fprintf(stderr, gettext(\"Usage: mount.zfs \"\n\t\t\t    \"[-sfnvh] [-o options] <dataset> <mountpoint>\\n\"));\n\t\t\treturn (MOUNT_USAGE);\n\t\t}\n\t}\n\n\targc -= optind;\n\targv += optind;\n\n\t \n\tif (argc != 2) {\n\t\tif (argc == 0)\n\t\t\t(void) fprintf(stderr, gettext(\"missing dataset \"\n\t\t\t    \"argument\\n\"));\n\t\telse if (argc == 1)\n\t\t\t(void) fprintf(stderr,\n\t\t\t    gettext(\"missing mountpoint argument\\n\"));\n\t\telse\n\t\t\t(void) fprintf(stderr, gettext(\"too many arguments\\n\"));\n\t\t(void) fprintf(stderr, \"usage: mount <dataset> <mountpoint>\\n\");\n\t\treturn (MOUNT_USAGE);\n\t}\n\n\tparse_dataset(argv[0], &pdataset);\n\n\t \n\tif (realpath(argv[1], mntpoint) == NULL) {\n\t\t(void) fprintf(stderr, gettext(\"filesystem '%s' cannot be \"\n\t\t    \"mounted at '%s' due to canonicalization error: %s\\n\"),\n\t\t    dataset, argv[1], strerror(errno));\n\t\treturn (MOUNT_SYSERR);\n\t}\n\n\t \n\terror = zfs_parse_mount_options(mntopts, &mntflags, &zfsflags, sloppy,\n\t    badopt, mtabopt);\n\tif (error) {\n\t\tswitch (error) {\n\t\tcase ENOMEM:\n\t\t\t(void) fprintf(stderr, gettext(\"filesystem '%s' \"\n\t\t\t    \"cannot be mounted due to a memory allocation \"\n\t\t\t    \"failure.\\n\"), dataset);\n\t\t\treturn (MOUNT_SYSERR);\n\t\tcase ENOENT:\n\t\t\t(void) fprintf(stderr, gettext(\"filesystem '%s' \"\n\t\t\t    \"cannot be mounted due to invalid option \"\n\t\t\t    \"'%s'.\\n\"), dataset, badopt);\n\t\t\t(void) fprintf(stderr, gettext(\"Use the '-s' option \"\n\t\t\t    \"to ignore the bad mount option.\\n\"));\n\t\t\treturn (MOUNT_USAGE);\n\t\tdefault:\n\t\t\t(void) fprintf(stderr, gettext(\"filesystem '%s' \"\n\t\t\t    \"cannot be mounted due to internal error %d.\\n\"),\n\t\t\t    dataset, error);\n\t\t\treturn (MOUNT_SOFTWARE);\n\t\t}\n\t}\n\n\tif (mntflags & MS_REMOUNT) {\n\t\tnomtab = 1;\n\t\tremount = 1;\n\t}\n\n\tif (zfsflags & ZS_ZFSUTIL)\n\t\tzfsutil = 1;\n\n\tif ((g_zfs = libzfs_init()) == NULL) {\n\t\t(void) fprintf(stderr, \"%s\\n\", libzfs_error_init(errno));\n\t\treturn (MOUNT_SYSERR);\n\t}\n\n\t \n\tif ((zhp = zfs_open(g_zfs, dataset,\n\t    ZFS_TYPE_FILESYSTEM | ZFS_TYPE_SNAPSHOT)) == NULL) {\n\t\t(void) fprintf(stderr, gettext(\"filesystem '%s' cannot be \"\n\t\t    \"mounted, unable to open the dataset\\n\"), dataset);\n\t\tlibzfs_fini(g_zfs);\n\t\treturn (MOUNT_USAGE);\n\t}\n\n\tif (!zfsutil || sloppy ||\n\t    libzfs_envvar_is_set(\"ZFS_MOUNT_HELPER\")) {\n\t\tzfs_adjust_mount_options(zhp, mntpoint, mntopts, mtabopt);\n\t}\n\n\t \n\tif (zfs_get_type(zhp) == ZFS_TYPE_SNAPSHOT)\n\t\t(void) strlcpy(prop, ZFS_MOUNTPOINT_LEGACY, ZFS_MAXPROPLEN);\n\telse\n\t\t(void) zfs_prop_get(zhp, ZFS_PROP_MOUNTPOINT, prop,\n\t\t    sizeof (prop), NULL, NULL, 0, B_FALSE);\n\n\t \n\tzfs_version = zfs_prop_get_int(zhp, ZFS_PROP_VERSION);\n\tif (zfs_version == 0) {\n\t\tfprintf(stderr, gettext(\"unable to fetch \"\n\t\t    \"ZFS version for filesystem '%s'\\n\"), dataset);\n\t\tzfs_close(zhp);\n\t\tlibzfs_fini(g_zfs);\n\t\treturn (MOUNT_SYSERR);\n\t}\n\n\t \n\tif (zfsutil && (strcmp(prop, ZFS_MOUNTPOINT_LEGACY) == 0)) {\n\t\t(void) fprintf(stderr, gettext(\n\t\t    \"filesystem '%s' cannot be mounted using 'zfs mount'.\\n\"\n\t\t    \"Use 'zfs set mountpoint=%s' or 'mount -t zfs %s %s'.\\n\"\n\t\t    \"See zfs(8) for more information.\\n\"),\n\t\t    dataset, mntpoint, dataset, mntpoint);\n\t\tzfs_close(zhp);\n\t\tlibzfs_fini(g_zfs);\n\t\treturn (MOUNT_USAGE);\n\t}\n\n\tif (!zfsutil && !(remount || fake) &&\n\t    strcmp(prop, ZFS_MOUNTPOINT_LEGACY)) {\n\t\t(void) fprintf(stderr, gettext(\n\t\t    \"filesystem '%s' cannot be mounted using 'mount'.\\n\"\n\t\t    \"Use 'zfs set mountpoint=%s' or 'zfs mount %s'.\\n\"\n\t\t    \"See zfs(8) for more information.\\n\"),\n\t\t    dataset, \"legacy\", dataset);\n\t\tzfs_close(zhp);\n\t\tlibzfs_fini(g_zfs);\n\t\treturn (MOUNT_USAGE);\n\t}\n\n\tif (verbose)\n\t\t(void) fprintf(stdout, gettext(\"mount.zfs:\\n\"\n\t\t    \"  dataset:    \\\"%s\\\"\\n  mountpoint: \\\"%s\\\"\\n\"\n\t\t    \"  mountflags: 0x%lx\\n  zfsflags:   0x%lx\\n\"\n\t\t    \"  mountopts:  \\\"%s\\\"\\n  mtabopts:   \\\"%s\\\"\\n\"),\n\t\t    dataset, mntpoint, mntflags, zfsflags, mntopts, mtabopt);\n\n\tif (!fake) {\n\t\tif (zfsutil && !sloppy &&\n\t\t    !libzfs_envvar_is_set(\"ZFS_MOUNT_HELPER\")) {\n\t\t\terror = zfs_mount_at(zhp, mntopts, mntflags, mntpoint);\n\t\t\tif (error) {\n\t\t\t\t(void) fprintf(stderr, \"zfs_mount_at() failed: \"\n\t\t\t\t    \"%s\", libzfs_error_description(g_zfs));\n\t\t\t\tzfs_close(zhp);\n\t\t\t\tlibzfs_fini(g_zfs);\n\t\t\t\treturn (MOUNT_SYSERR);\n\t\t\t}\n\t\t} else {\n\t\t\terror = mount(dataset, mntpoint, MNTTYPE_ZFS,\n\t\t\t    mntflags, mntopts);\n\t\t}\n\t}\n\n\tzfs_close(zhp);\n\tlibzfs_fini(g_zfs);\n\n\tif (error) {\n\t\tswitch (errno) {\n\t\tcase ENOENT:\n\t\t\t(void) fprintf(stderr, gettext(\"mount point \"\n\t\t\t    \"'%s' does not exist\\n\"), mntpoint);\n\t\t\treturn (MOUNT_SYSERR);\n\t\tcase EBUSY:\n\t\t\t(void) fprintf(stderr, gettext(\"filesystem \"\n\t\t\t    \"'%s' is already mounted\\n\"), dataset);\n\t\t\treturn (MOUNT_BUSY);\n\t\tcase ENOTSUP:\n\t\t\tif (zfs_version > ZPL_VERSION) {\n\t\t\t\t(void) fprintf(stderr,\n\t\t\t\t    gettext(\"filesystem '%s' (v%d) is not \"\n\t\t\t\t    \"supported by this implementation of \"\n\t\t\t\t    \"ZFS (max v%d).\\n\"), dataset,\n\t\t\t\t    (int)zfs_version, (int)ZPL_VERSION);\n\t\t\t} else {\n\t\t\t\t(void) fprintf(stderr,\n\t\t\t\t    gettext(\"filesystem '%s' mount \"\n\t\t\t\t    \"failed for unknown reason.\\n\"), dataset);\n\t\t\t}\n\t\t\treturn (MOUNT_SYSERR);\n#ifdef MS_MANDLOCK\n\t\tcase EPERM:\n\t\t\tif (mntflags & MS_MANDLOCK) {\n\t\t\t\t(void) fprintf(stderr, gettext(\"filesystem \"\n\t\t\t\t    \"'%s' has the 'nbmand=on' property set, \"\n\t\t\t\t    \"this mount\\noption may be disabled in \"\n\t\t\t\t    \"your kernel.  Use 'zfs set nbmand=off'\\n\"\n\t\t\t\t    \"to disable this option and try to \"\n\t\t\t\t    \"mount the filesystem again.\\n\"), dataset);\n\t\t\t\treturn (MOUNT_SYSERR);\n\t\t\t}\n#endif\n\t\t\tzfs_fallthrough;\n\t\tdefault:\n\t\t\t(void) fprintf(stderr, gettext(\"filesystem \"\n\t\t\t    \"'%s' can not be mounted: %s\\n\"), dataset,\n\t\t\t    strerror(errno));\n\t\t\treturn (MOUNT_USAGE);\n\t\t}\n\t}\n\n\tif (!nomtab && mtab_is_writeable()) {\n\t\terror = mtab_update(dataset, mntpoint, MNTTYPE_ZFS, mtabopt);\n\t\tif (error)\n\t\t\treturn (error);\n\t}\n\n\treturn (MOUNT_SUCCESS);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}