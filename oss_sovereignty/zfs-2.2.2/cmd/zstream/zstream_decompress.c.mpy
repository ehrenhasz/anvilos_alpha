{
  "module_name": "zstream_decompress.c",
  "hash_id": "a4991e08639662631caa152a336bd619c34c844dc8c7d3f4368e75fabd384f6a",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/zstream/zstream_decompress.c",
  "human_readable_source": " \n\n \n\n#include <err.h>\n#include <search.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <sys/zfs_ioctl.h>\n#include <sys/zio_checksum.h>\n#include <sys/zstd/zstd.h>\n#include \"zfs_fletcher.h\"\n#include \"zstream.h\"\n\nstatic int\ndump_record(dmu_replay_record_t *drr, void *payload, int payload_len,\n    zio_cksum_t *zc, int outfd)\n{\n\tassert(offsetof(dmu_replay_record_t, drr_u.drr_checksum.drr_checksum)\n\t    == sizeof (dmu_replay_record_t) - sizeof (zio_cksum_t));\n\tfletcher_4_incremental_native(drr,\n\t    offsetof(dmu_replay_record_t, drr_u.drr_checksum.drr_checksum), zc);\n\tif (drr->drr_type != DRR_BEGIN) {\n\t\tassert(ZIO_CHECKSUM_IS_ZERO(&drr->drr_u.\n\t\t    drr_checksum.drr_checksum));\n\t\tdrr->drr_u.drr_checksum.drr_checksum = *zc;\n\t}\n\tfletcher_4_incremental_native(&drr->drr_u.drr_checksum.drr_checksum,\n\t    sizeof (zio_cksum_t), zc);\n\tif (write(outfd, drr, sizeof (*drr)) == -1)\n\t\treturn (errno);\n\tif (payload_len != 0) {\n\t\tfletcher_4_incremental_native(payload, payload_len, zc);\n\t\tif (write(outfd, payload, payload_len) == -1)\n\t\t\treturn (errno);\n\t}\n\treturn (0);\n}\n\nint\nzstream_do_decompress(int argc, char *argv[])\n{\n\tconst int KEYSIZE = 64;\n\tint bufsz = SPA_MAXBLOCKSIZE;\n\tchar *buf = safe_malloc(bufsz);\n\tdmu_replay_record_t thedrr;\n\tdmu_replay_record_t *drr = &thedrr;\n\tzio_cksum_t stream_cksum;\n\tint c;\n\tboolean_t verbose = B_FALSE;\n\n\twhile ((c = getopt(argc, argv, \"v\")) != -1) {\n\t\tswitch (c) {\n\t\tcase 'v':\n\t\t\tverbose = B_TRUE;\n\t\t\tbreak;\n\t\tcase '?':\n\t\t\t(void) fprintf(stderr, \"invalid option '%c'\\n\",\n\t\t\t    optopt);\n\t\t\tzstream_usage();\n\t\t\tbreak;\n\t\t}\n\t}\n\n\targc -= optind;\n\targv += optind;\n\n\tif (argc < 0)\n\t\tzstream_usage();\n\n\tif (hcreate(argc) == 0)\n\t\terrx(1, \"hcreate\");\n\tfor (int i = 0; i < argc; i++) {\n\t\tuint64_t object, offset;\n\t\tchar *obj_str;\n\t\tchar *offset_str;\n\t\tchar *key;\n\t\tchar *end;\n\t\tenum zio_compress type = ZIO_COMPRESS_LZ4;\n\n\t\tobj_str = strsep(&argv[i], \",\");\n\t\tif (argv[i] == NULL) {\n\t\t\tzstream_usage();\n\t\t\texit(2);\n\t\t}\n\t\terrno = 0;\n\t\tobject = strtoull(obj_str, &end, 0);\n\t\tif (errno || *end != '\\0')\n\t\t\terrx(1, \"invalid value for object\");\n\t\toffset_str = strsep(&argv[i], \",\");\n\t\toffset = strtoull(offset_str, &end, 0);\n\t\tif (errno || *end != '\\0')\n\t\t\terrx(1, \"invalid value for offset\");\n\t\tif (argv[i]) {\n\t\t\tif (0 == strcmp(\"off\", argv[i]))\n\t\t\t\ttype = ZIO_COMPRESS_OFF;\n\t\t\telse if (0 == strcmp(\"lz4\", argv[i]))\n\t\t\t\ttype = ZIO_COMPRESS_LZ4;\n\t\t\telse if (0 == strcmp(\"lzjb\", argv[i]))\n\t\t\t\ttype = ZIO_COMPRESS_LZJB;\n\t\t\telse if (0 == strcmp(\"gzip\", argv[i]))\n\t\t\t\ttype = ZIO_COMPRESS_GZIP_1;\n\t\t\telse if (0 == strcmp(\"zle\", argv[i]))\n\t\t\t\ttype = ZIO_COMPRESS_ZLE;\n\t\t\telse if (0 == strcmp(\"zstd\", argv[i]))\n\t\t\t\ttype = ZIO_COMPRESS_ZSTD;\n\t\t\telse {\n\t\t\t\tfprintf(stderr, \"Invalid compression type %s.\\n\"\n\t\t\t\t    \"Supported types are off, lz4, lzjb, gzip, \"\n\t\t\t\t    \"zle, and zstd\\n\",\n\t\t\t\t    argv[i]);\n\t\t\t\texit(2);\n\t\t\t}\n\t\t}\n\n\t\tif (asprintf(&key, \"%llu,%llu\", (u_longlong_t)object,\n\t\t    (u_longlong_t)offset) < 0) {\n\t\t\terr(1, \"asprintf\");\n\t\t}\n\t\tENTRY e = {.key = key};\n\t\tENTRY *p;\n\n\t\tp = hsearch(e, ENTER);\n\t\tif (p == NULL)\n\t\t\terrx(1, \"hsearch\");\n\t\tp->data = (void*)(intptr_t)type;\n\t}\n\n\tif (isatty(STDIN_FILENO)) {\n\t\t(void) fprintf(stderr,\n\t\t    \"Error: The send stream is a binary format \"\n\t\t    \"and can not be read from a\\n\"\n\t\t    \"terminal.  Standard input must be redirected.\\n\");\n\t\texit(1);\n\t}\n\n\tfletcher_4_init();\n\tint begin = 0;\n\tboolean_t seen = B_FALSE;\n\twhile (sfread(drr, sizeof (*drr), stdin) != 0) {\n\t\tstruct drr_write *drrw;\n\t\tuint64_t payload_size = 0;\n\n\t\t \n\t\tif (drr->drr_type != DRR_BEGIN) {\n\t\t\tmemset(&drr->drr_u.drr_checksum.drr_checksum, 0,\n\t\t\t    sizeof (drr->drr_u.drr_checksum.drr_checksum));\n\t\t}\n\n\t\tswitch (drr->drr_type) {\n\t\tcase DRR_BEGIN:\n\t\t{\n\t\t\tZIO_SET_CHECKSUM(&stream_cksum, 0, 0, 0, 0);\n\t\t\tVERIFY0(begin++);\n\t\t\tseen = B_TRUE;\n\n\t\t\tuint32_t sz = drr->drr_payloadlen;\n\n\t\t\tVERIFY3U(sz, <=, 1U << 28);\n\n\t\t\tif (sz != 0) {\n\t\t\t\tif (sz > bufsz) {\n\t\t\t\t\tbuf = realloc(buf, sz);\n\t\t\t\t\tif (buf == NULL)\n\t\t\t\t\t\terr(1, \"realloc\");\n\t\t\t\t\tbufsz = sz;\n\t\t\t\t}\n\t\t\t\t(void) sfread(buf, sz, stdin);\n\t\t\t}\n\t\t\tpayload_size = sz;\n\t\t\tbreak;\n\t\t}\n\t\tcase DRR_END:\n\t\t{\n\t\t\tstruct drr_end *drre = &drr->drr_u.drr_end;\n\t\t\t \n\t\t\tVERIFY3B(seen, ==, B_TRUE);\n\t\t\tbegin--;\n\t\t\t \n\t\t\tif (!ZIO_CHECKSUM_IS_ZERO(&drre->drr_checksum))\n\t\t\t\tdrre->drr_checksum = stream_cksum;\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DRR_OBJECT:\n\t\t{\n\t\t\tstruct drr_object *drro = &drr->drr_u.drr_object;\n\t\t\tVERIFY3S(begin, ==, 1);\n\n\t\t\tif (drro->drr_bonuslen > 0) {\n\t\t\t\tpayload_size = DRR_OBJECT_PAYLOAD_SIZE(drro);\n\t\t\t\t(void) sfread(buf, payload_size, stdin);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DRR_SPILL:\n\t\t{\n\t\t\tstruct drr_spill *drrs = &drr->drr_u.drr_spill;\n\t\t\tVERIFY3S(begin, ==, 1);\n\t\t\tpayload_size = DRR_SPILL_PAYLOAD_SIZE(drrs);\n\t\t\t(void) sfread(buf, payload_size, stdin);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DRR_WRITE_BYREF:\n\t\t\tVERIFY3S(begin, ==, 1);\n\t\t\tfprintf(stderr,\n\t\t\t    \"Deduplicated streams are not supported\\n\");\n\t\t\texit(1);\n\t\t\tbreak;\n\n\t\tcase DRR_WRITE:\n\t\t{\n\t\t\tVERIFY3S(begin, ==, 1);\n\t\t\tdrrw = &thedrr.drr_u.drr_write;\n\t\t\tpayload_size = DRR_WRITE_PAYLOAD_SIZE(drrw);\n\t\t\tENTRY *p;\n\t\t\tchar key[KEYSIZE];\n\n\t\t\tsnprintf(key, KEYSIZE, \"%llu,%llu\",\n\t\t\t    (u_longlong_t)drrw->drr_object,\n\t\t\t    (u_longlong_t)drrw->drr_offset);\n\t\t\tENTRY e = {.key = key};\n\n\t\t\tp = hsearch(e, FIND);\n\t\t\tif (p != NULL) {\n\t\t\t\tzio_decompress_func_t *xfunc = NULL;\n\t\t\t\tswitch ((enum zio_compress)(intptr_t)p->data) {\n\t\t\t\tcase ZIO_COMPRESS_OFF:\n\t\t\t\t\txfunc = NULL;\n\t\t\t\t\tbreak;\n\t\t\t\tcase ZIO_COMPRESS_LZJB:\n\t\t\t\t\txfunc = lzjb_decompress;\n\t\t\t\t\tbreak;\n\t\t\t\tcase ZIO_COMPRESS_GZIP_1:\n\t\t\t\t\txfunc = gzip_decompress;\n\t\t\t\t\tbreak;\n\t\t\t\tcase ZIO_COMPRESS_ZLE:\n\t\t\t\t\txfunc = zle_decompress;\n\t\t\t\t\tbreak;\n\t\t\t\tcase ZIO_COMPRESS_LZ4:\n\t\t\t\t\txfunc = lz4_decompress_zfs;\n\t\t\t\t\tbreak;\n\t\t\t\tcase ZIO_COMPRESS_ZSTD:\n\t\t\t\t\txfunc = zfs_zstd_decompress;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tassert(B_FALSE);\n\t\t\t\t}\n\n\n\t\t\t\t \n\t\t\t\tchar *lzbuf = safe_calloc(payload_size);\n\t\t\t\t(void) sfread(lzbuf, payload_size, stdin);\n\t\t\t\tif (xfunc == NULL) {\n\t\t\t\t\tmemcpy(buf, lzbuf, payload_size);\n\t\t\t\t\tdrrw->drr_compressiontype =\n\t\t\t\t\t    ZIO_COMPRESS_OFF;\n\t\t\t\t\tif (verbose)\n\t\t\t\t\t\tfprintf(stderr, \"Resetting \"\n\t\t\t\t\t\t    \"compression type to off \"\n\t\t\t\t\t\t    \"for ino %llu offset \"\n\t\t\t\t\t\t    \"%llu\\n\",\n\t\t\t\t\t\t    (u_longlong_t)\n\t\t\t\t\t\t    drrw->drr_object,\n\t\t\t\t\t\t    (u_longlong_t)\n\t\t\t\t\t\t    drrw->drr_offset);\n\t\t\t\t} else if (0 != xfunc(lzbuf, buf,\n\t\t\t\t    payload_size, payload_size, 0)) {\n\t\t\t\t\t \n\t\t\t\t\twarnx(\"decompression failed for \"\n\t\t\t\t\t    \"ino %llu offset %llu\",\n\t\t\t\t\t    (u_longlong_t)drrw->drr_object,\n\t\t\t\t\t    (u_longlong_t)drrw->drr_offset);\n\t\t\t\t\tmemcpy(buf, lzbuf, payload_size);\n\t\t\t\t} else if (verbose) {\n\t\t\t\t\tdrrw->drr_compressiontype =\n\t\t\t\t\t    ZIO_COMPRESS_OFF;\n\t\t\t\t\tfprintf(stderr, \"successfully \"\n\t\t\t\t\t    \"decompressed ino %llu \"\n\t\t\t\t\t    \"offset %llu\\n\",\n\t\t\t\t\t    (u_longlong_t)drrw->drr_object,\n\t\t\t\t\t    (u_longlong_t)drrw->drr_offset);\n\t\t\t\t} else {\n\t\t\t\t\tdrrw->drr_compressiontype =\n\t\t\t\t\t    ZIO_COMPRESS_OFF;\n\t\t\t\t}\n\t\t\t\tfree(lzbuf);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\t(void) sfread(buf, payload_size, stdin);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DRR_WRITE_EMBEDDED:\n\t\t{\n\t\t\tVERIFY3S(begin, ==, 1);\n\t\t\tstruct drr_write_embedded *drrwe =\n\t\t\t    &drr->drr_u.drr_write_embedded;\n\t\t\tpayload_size =\n\t\t\t    P2ROUNDUP((uint64_t)drrwe->drr_psize, 8);\n\t\t\t(void) sfread(buf, payload_size, stdin);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase DRR_FREEOBJECTS:\n\t\tcase DRR_FREE:\n\t\tcase DRR_OBJECT_RANGE:\n\t\t\tVERIFY3S(begin, ==, 1);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\t(void) fprintf(stderr, \"INVALID record type 0x%x\\n\",\n\t\t\t    drr->drr_type);\n\t\t\t \n\t\t\tassert(B_FALSE);\n\t\t}\n\n\t\tif (feof(stdout)) {\n\t\t\tfprintf(stderr, \"Error: unexpected end-of-file\\n\");\n\t\t\texit(1);\n\t\t}\n\t\tif (ferror(stdout)) {\n\t\t\tfprintf(stderr, \"Error while reading file: %s\\n\",\n\t\t\t    strerror(errno));\n\t\t\texit(1);\n\t\t}\n\n\t\t \n\t\tif (drr->drr_type != DRR_BEGIN) {\n\t\t\tmemset(&drr->drr_u.drr_checksum.drr_checksum, 0,\n\t\t\t    sizeof (drr->drr_u.drr_checksum.drr_checksum));\n\t\t}\n\t\tif (dump_record(drr, buf, payload_size,\n\t\t    &stream_cksum, STDOUT_FILENO) != 0)\n\t\t\tbreak;\n\t\tif (drr->drr_type == DRR_END) {\n\t\t\t \n\t\t\tZIO_SET_CHECKSUM(&stream_cksum, 0, 0, 0, 0);\n\t\t}\n\t}\n\tfree(buf);\n\tfletcher_4_fini();\n\thdestroy();\n\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}