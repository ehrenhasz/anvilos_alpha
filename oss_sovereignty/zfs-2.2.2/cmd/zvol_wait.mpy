{
  "module_name": "zvol_wait",
  "hash_id": "b3433d339ca5398071ebb49e801b32f541c1f3f95b5c76ca8dbdf1888faec897",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/zvol_wait",
  "human_readable_source": "#!/bin/sh\n\ncount_zvols() {\n\tif [ -z \"$zvols\" ]; then\n\t\techo 0\n\telse\n\t\techo \"$zvols\" | wc -l\n\tfi\n}\n\nfilter_out_zvols_with_links() {\n\techo \"$zvols\" | tr ' ' '+' | while read -r zvol; do\n\t\tif ! [ -L \"/dev/zvol/$zvol\" ]; then\n\t\t\techo \"$zvol\"\n\t\tfi\n\tdone | tr '+' ' '\n}\n\nfilter_out_deleted_zvols() {\n\tOIFS=\"$IFS\"\n\tIFS=\"\n\"\n\t# shellcheck disable=SC2086\n\tzfs list -H -o name $zvols 2>/dev/null\n\tIFS=\"$OIFS\"\n}\n\nlist_zvols() {\n\tread -r default_volmode < /sys/module/zfs/parameters/zvol_volmode\n\tzfs list -t volume -H -o \\\n\t    name,volmode,receive_resume_token,redact_snaps,keystatus |\n\t    while IFS=\"\t\" read -r name volmode token redacted keystatus; do # IFS=\\t here!\n\n\t\t# /dev links are not created for zvols with volmode = \"none\",\n\t\t# redacted zvols, or encrypted zvols for which the key has not\n\t\t# been loaded.\n\t\t[ \"$volmode\" = \"none\" ] && continue\n\t\t[ \"$volmode\" = \"default\" ] && [ \"$default_volmode\" = \"3\" ] &&\n\t\t    continue\n\t\t[ \"$redacted\" = \"-\" ] || continue\n\t\t[ \"$keystatus\" = \"unavailable\" ] && continue\n\n\t\t# We also ignore partially received zvols if it is\n\t\t# not an incremental receive, as those won't even have a block\n\t\t# device minor node created yet.\n\t\tif [ \"$token\" != \"-\" ]; then\n\n\t\t\t# Incremental receives create an invisible clone that\n\t\t\t# is not automatically displayed by zfs list.\n\t\t\tif ! zfs list \"$name/%recv\" >/dev/null 2>&1; then\n\t\t\t\tcontinue\n\t\t\tfi\n\t\tfi\n\t\techo \"$name\"\n\tdone\n}\n\nzvols=$(list_zvols)\nzvols_count=$(count_zvols)\nif [ \"$zvols_count\" -eq 0 ]; then\n\techo \"No zvols found, nothing to do.\"\n\texit 0\nfi\n\necho \"Testing $zvols_count zvol links\"\n\nouter_loop=0\nwhile [ \"$outer_loop\" -lt 20 ]; do\n\touter_loop=$((outer_loop + 1))\n\n\told_zvols_count=$(count_zvols)\n\n\tinner_loop=0\n\twhile [ \"$inner_loop\" -lt 30 ]; do\n\t\tinner_loop=$((inner_loop + 1))\n\n\t\tzvols=\"$(filter_out_zvols_with_links)\"\n\n\t\tzvols_count=$(count_zvols)\n\t\tif [ \"$zvols_count\" -eq 0 ]; then\n\t\t\techo \"All zvol links are now present.\"\n\t\t\texit 0\n\t\tfi\n\t\tsleep 1\n\tdone\n\n\techo \"Still waiting on $zvols_count zvol links ...\"\n\t#\n\t# Although zvols should normally not be deleted at boot time,\n\t# if that is the case then their links will be missing and\n\t# we would stall.\n\t#\n\tif [ \"$old_zvols_count\" -eq \"$zvols_count\" ]; then\n\t\techo \"No progress since last loop.\"\n\t\techo \"Checking if any zvols were deleted.\"\n\n\t\tzvols=$(filter_out_deleted_zvols)\n\t\tzvols_count=$(count_zvols)\n\n\t\tif [ \"$old_zvols_count\" -ne \"$zvols_count\" ]; then\n\t\t\techo \"$((old_zvols_count - zvols_count)) zvol(s) deleted.\"\n\t\tfi\n\n\t\tif [ \"$zvols_count\" -ne 0 ]; then\n\t\t\techo \"Remaining zvols:\"\n\t\t\techo \"$zvols\"\n\t\telse\n\t\t\techo \"All zvol links are now present.\"\n\t\t\texit 0\n\t\tfi\n\tfi\n\n\t#\n\t# zvol_count made some progress - let's stay in this loop.\n\t#\n\tif [ \"$old_zvols_count\" -gt \"$zvols_count\" ]; then\n\t\touter_loop=$((outer_loop - 1))\n\tfi\ndone\n\necho \"Timed out waiting on zvol links\"\nexit 1\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}