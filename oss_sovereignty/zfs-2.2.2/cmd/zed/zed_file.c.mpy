{
  "module_name": "zed_file.c",
  "hash_id": "b9a563d4e103b0f120b08d3dc4e9a0b74436b2d55f29d9b86752565c9f02af6d",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/zed/zed_file.c",
  "human_readable_source": " \n\n#include <dirent.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <limits.h>\n#include <string.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include \"zed_file.h\"\n#include \"zed_log.h\"\n\n \nint\nzed_file_lock(int fd)\n{\n\tstruct flock lock;\n\n\tif (fd < 0) {\n\t\terrno = EBADF;\n\t\treturn (-1);\n\t}\n\tlock.l_type = F_WRLCK;\n\tlock.l_whence = SEEK_SET;\n\tlock.l_start = 0;\n\tlock.l_len = 0;\n\n\tif (fcntl(fd, F_SETLK, &lock) < 0) {\n\t\tif ((errno == EACCES) || (errno == EAGAIN))\n\t\t\treturn (1);\n\n\t\treturn (-1);\n\t}\n\treturn (0);\n}\n\n \nint\nzed_file_unlock(int fd)\n{\n\tstruct flock lock;\n\n\tif (fd < 0) {\n\t\terrno = EBADF;\n\t\treturn (-1);\n\t}\n\tlock.l_type = F_UNLCK;\n\tlock.l_whence = SEEK_SET;\n\tlock.l_start = 0;\n\tlock.l_len = 0;\n\n\tif (fcntl(fd, F_SETLK, &lock) < 0)\n\t\treturn (-1);\n\n\treturn (0);\n}\n\n \npid_t\nzed_file_is_locked(int fd)\n{\n\tstruct flock lock;\n\n\tif (fd < 0) {\n\t\terrno = EBADF;\n\t\treturn (-1);\n\t}\n\tlock.l_type = F_WRLCK;\n\tlock.l_whence = SEEK_SET;\n\tlock.l_start = 0;\n\tlock.l_len = 0;\n\n\tif (fcntl(fd, F_GETLK, &lock) < 0)\n\t\treturn (-1);\n\n\tif (lock.l_type == F_UNLCK)\n\t\treturn (0);\n\n\treturn (lock.l_pid);\n}\n\n\n#if __APPLE__\n#define\tPROC_SELF_FD \"/dev/fd\"\n#else  \n#define\tPROC_SELF_FD \"/proc/self/fd\"\n#endif\n\n \nvoid\nzed_file_close_from(int lowfd)\n{\n\tint errno_bak = errno;\n\tint maxfd = 0;\n\tint fd;\n\tDIR *fddir;\n\tstruct dirent *fdent;\n\n\tif ((fddir = opendir(PROC_SELF_FD)) != NULL) {\n\t\twhile ((fdent = readdir(fddir)) != NULL) {\n\t\t\tfd = atoi(fdent->d_name);\n\t\t\tif (fd > maxfd && fd != dirfd(fddir))\n\t\t\t\tmaxfd = fd;\n\t\t}\n\t\t(void) closedir(fddir);\n\t} else {\n\t\tmaxfd = sysconf(_SC_OPEN_MAX);\n\t}\n\tfor (fd = lowfd; fd < maxfd; fd++)\n\t\t(void) close(fd);\n\n\terrno = errno_bak;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}