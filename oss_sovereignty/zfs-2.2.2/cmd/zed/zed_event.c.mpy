{
  "module_name": "zed_event.c",
  "hash_id": "821092c4fa738c3b51a4aac7aca442f0f8983291b801d81c3a5a9e1304acfed0",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/zed/zed_event.c",
  "human_readable_source": " \n\n#include <ctype.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <libzfs_core.h>\n#include <paths.h>\n#include <stdarg.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/zfs_ioctl.h>\n#include <time.h>\n#include <unistd.h>\n#include <sys/fm/fs/zfs.h>\n#include \"zed.h\"\n#include \"zed_conf.h\"\n#include \"zed_disk_event.h\"\n#include \"zed_event.h\"\n#include \"zed_exec.h\"\n#include \"zed_file.h\"\n#include \"zed_log.h\"\n#include \"zed_strings.h\"\n\n#include \"agents/zfs_agents.h\"\n\n#define\tMAXBUF\t4096\n\nstatic int max_zevent_buf_len = 1 << 20;\n\n \nint\nzed_event_init(struct zed_conf *zcp)\n{\n\tif (!zcp)\n\t\tzed_log_die(\"Failed zed_event_init: %s\", strerror(EINVAL));\n\n\tzcp->zfs_hdl = libzfs_init();\n\tif (!zcp->zfs_hdl) {\n\t\tif (zcp->do_idle)\n\t\t\treturn (-1);\n\t\tzed_log_die(\"Failed to initialize libzfs\");\n\t}\n\n\tzcp->zevent_fd = open(ZFS_DEV, O_RDWR | O_CLOEXEC);\n\tif (zcp->zevent_fd < 0) {\n\t\tif (zcp->do_idle)\n\t\t\treturn (-1);\n\t\tzed_log_die(\"Failed to open \\\"%s\\\": %s\",\n\t\t    ZFS_DEV, strerror(errno));\n\t}\n\n\tzfs_agent_init(zcp->zfs_hdl);\n\n\tif (zed_disk_event_init() != 0) {\n\t\tif (zcp->do_idle)\n\t\t\treturn (-1);\n\t\tzed_log_die(\"Failed to initialize disk events\");\n\t}\n\n\tif (zcp->max_zevent_buf_len != 0)\n\t\tmax_zevent_buf_len = zcp->max_zevent_buf_len;\n\n\treturn (0);\n}\n\n \nvoid\nzed_event_fini(struct zed_conf *zcp)\n{\n\tif (!zcp)\n\t\tzed_log_die(\"Failed zed_event_fini: %s\", strerror(EINVAL));\n\n\tzed_disk_event_fini();\n\tzfs_agent_fini();\n\n\tif (zcp->zevent_fd >= 0) {\n\t\tif (close(zcp->zevent_fd) < 0)\n\t\t\tzed_log_msg(LOG_WARNING, \"Failed to close \\\"%s\\\": %s\",\n\t\t\t    ZFS_DEV, strerror(errno));\n\n\t\tzcp->zevent_fd = -1;\n\t}\n\tif (zcp->zfs_hdl) {\n\t\tlibzfs_fini(zcp->zfs_hdl);\n\t\tzcp->zfs_hdl = NULL;\n\t}\n\n\tzed_exec_fini();\n}\n\nstatic void\n_bump_event_queue_length(void)\n{\n\tint zzlm = -1, wr;\n\tchar qlen_buf[12] = {0};  \n\tlong int qlen, orig_qlen;\n\n\tzzlm = open(\"/sys/module/zfs/parameters/zfs_zevent_len_max\", O_RDWR);\n\tif (zzlm < 0)\n\t\tgoto done;\n\n\tif (read(zzlm, qlen_buf, sizeof (qlen_buf)) < 0)\n\t\tgoto done;\n\tqlen_buf[sizeof (qlen_buf) - 1] = '\\0';\n\n\terrno = 0;\n\torig_qlen = qlen = strtol(qlen_buf, NULL, 10);\n\tif (errno == ERANGE)\n\t\tgoto done;\n\n\tif (qlen <= 0)\n\t\tqlen = 512;  \n\telse\n\t\tqlen *= 2;\n\n\t \n\tif (qlen > max_zevent_buf_len)\n\t\tqlen = max_zevent_buf_len;\n\tif (qlen == orig_qlen)\n\t\tgoto done;\n\twr = snprintf(qlen_buf, sizeof (qlen_buf), \"%ld\", qlen);\n\tif (wr >= sizeof (qlen_buf)) {\n\t\twr = sizeof (qlen_buf) - 1;\n\t\tzed_log_msg(LOG_WARNING, \"Truncation in %s()\", __func__);\n\t}\n\n\tif (pwrite(zzlm, qlen_buf, wr + 1, 0) < 0)\n\t\tgoto done;\n\n\tzed_log_msg(LOG_WARNING, \"Bumping queue length to %ld\", qlen);\n\ndone:\n\tif (zzlm > -1)\n\t\t(void) close(zzlm);\n}\n\n \nint\nzed_event_seek(struct zed_conf *zcp, uint64_t saved_eid, int64_t saved_etime[])\n{\n\tuint64_t eid;\n\tint found;\n\tnvlist_t *nvl;\n\tint n_dropped;\n\tint64_t *etime;\n\tuint_t nelem;\n\tint rv;\n\n\tif (!zcp) {\n\t\terrno = EINVAL;\n\t\tzed_log_msg(LOG_ERR, \"Failed to seek zevent: %s\",\n\t\t    strerror(errno));\n\t\treturn (-1);\n\t}\n\teid = 0;\n\tfound = 0;\n\twhile ((eid < saved_eid) && !found) {\n\t\trv = zpool_events_next(zcp->zfs_hdl, &nvl, &n_dropped,\n\t\t    ZEVENT_NONBLOCK, zcp->zevent_fd);\n\n\t\tif ((rv != 0) || !nvl)\n\t\t\tbreak;\n\n\t\tif (n_dropped > 0) {\n\t\t\tzed_log_msg(LOG_WARNING, \"Missed %d events\", n_dropped);\n\t\t\t_bump_event_queue_length();\n\t\t}\n\t\tif (nvlist_lookup_uint64(nvl, \"eid\", &eid) != 0) {\n\t\t\tzed_log_msg(LOG_WARNING, \"Failed to lookup zevent eid\");\n\t\t} else if (nvlist_lookup_int64_array(nvl, \"time\",\n\t\t    &etime, &nelem) != 0) {\n\t\t\tzed_log_msg(LOG_WARNING,\n\t\t\t    \"Failed to lookup zevent time (eid=%llu)\", eid);\n\t\t} else if (nelem != 2) {\n\t\t\tzed_log_msg(LOG_WARNING,\n\t\t\t    \"Failed to lookup zevent time (eid=%llu, nelem=%u)\",\n\t\t\t    eid, nelem);\n\t\t} else if ((eid != saved_eid) ||\n\t\t    (etime[0] != saved_etime[0]) ||\n\t\t    (etime[1] != saved_etime[1])) {\n\t\t\t \n\t\t} else {\n\t\t\tfound = 1;\n\t\t}\n\t\tfree(nvl);\n\t}\n\tif (!found && (saved_eid > 0)) {\n\t\tif (zpool_events_seek(zcp->zfs_hdl, ZEVENT_SEEK_START,\n\t\t    zcp->zevent_fd) < 0)\n\t\t\tzed_log_msg(LOG_WARNING, \"Failed to seek to eid=0\");\n\t\telse\n\t\t\teid = 0;\n\t}\n\tzed_log_msg(LOG_NOTICE, \"Processing events since eid=%llu\", eid);\n\treturn (found ? 0 : -1);\n}\n\n \nstatic int\n_zed_event_value_is_hex(const char *name)\n{\n\tconst char *hex_suffix[] = {\n\t\t\"_guid\",\n\t\t\"_guids\",\n\t\tNULL\n\t};\n\tconst char **pp;\n\tchar *p;\n\n\tif (!name)\n\t\treturn (0);\n\n\tfor (pp = hex_suffix; *pp; pp++) {\n\t\tp = strstr(name, *pp);\n\t\tif (p && strlen(p) == strlen(*pp))\n\t\t\treturn (1);\n\t}\n\treturn (0);\n}\n\n \nstatic __attribute__((format(printf, 5, 6))) int\n_zed_event_add_var(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, const char *name, const char *fmt, ...)\n{\n\tchar keybuf[MAXBUF];\n\tchar valbuf[MAXBUF];\n\tchar *dstp;\n\tconst char *srcp;\n\tconst char *lastp;\n\tint n;\n\tint buflen;\n\tva_list vargs;\n\n\tassert(zsp != NULL);\n\tassert(fmt != NULL);\n\n\tif (!name) {\n\t\terrno = EINVAL;\n\t\tzed_log_msg(LOG_WARNING,\n\t\t    \"Failed to add variable for eid=%llu: Name is empty\", eid);\n\t\treturn (-1);\n\t} else if (!isalpha(name[0])) {\n\t\terrno = EINVAL;\n\t\tzed_log_msg(LOG_WARNING,\n\t\t    \"Failed to add variable for eid=%llu: \"\n\t\t    \"Name \\\"%s\\\" is invalid\", eid, name);\n\t\treturn (-1);\n\t}\n\t \n\tdstp = keybuf;\n\tlastp = keybuf + sizeof (keybuf);\n\tif (prefix) {\n\t\tfor (srcp = prefix; *srcp && (dstp < lastp); srcp++)\n\t\t\t*dstp++ = isalnum(*srcp) ? toupper(*srcp) : '_';\n\t}\n\tfor (srcp = name; *srcp && (dstp < lastp); srcp++)\n\t\t*dstp++ = isalnum(*srcp) ? toupper(*srcp) : '_';\n\n\tif (dstp == lastp) {\n\t\terrno = ENAMETOOLONG;\n\t\tzed_log_msg(LOG_WARNING,\n\t\t    \"Failed to add variable for eid=%llu: Name too long\", eid);\n\t\treturn (-1);\n\t}\n\t*dstp = '\\0';\n\t \n\tdstp = valbuf;\n\tbuflen = sizeof (valbuf);\n\tn = strlcpy(dstp, keybuf, buflen);\n\tif (n >= sizeof (valbuf)) {\n\t\terrno = EMSGSIZE;\n\t\tzed_log_msg(LOG_WARNING, \"Failed to add %s for eid=%llu: %s\",\n\t\t    keybuf, eid, \"Exceeded buffer size\");\n\t\treturn (-1);\n\t}\n\tdstp += n;\n\tbuflen -= n;\n\n\t*dstp++ = '=';\n\tbuflen--;\n\n\tif (buflen <= 0) {\n\t\terrno = EMSGSIZE;\n\t\tzed_log_msg(LOG_WARNING, \"Failed to add %s for eid=%llu: %s\",\n\t\t    keybuf, eid, \"Exceeded buffer size\");\n\t\treturn (-1);\n\t}\n\n\tva_start(vargs, fmt);\n\tn = vsnprintf(dstp, buflen, fmt, vargs);\n\tva_end(vargs);\n\n\tif ((n < 0) || (n >= buflen)) {\n\t\terrno = EMSGSIZE;\n\t\tzed_log_msg(LOG_WARNING, \"Failed to add %s for eid=%llu: %s\",\n\t\t    keybuf, eid, \"Exceeded buffer size\");\n\t\treturn (-1);\n\t} else if (zed_strings_add(zsp, keybuf, valbuf) < 0) {\n\t\tzed_log_msg(LOG_WARNING, \"Failed to add %s for eid=%llu: %s\",\n\t\t    keybuf, eid, strerror(errno));\n\t\treturn (-1);\n\t}\n\treturn (0);\n}\n\nstatic int\n_zed_event_add_array_err(uint64_t eid, const char *name)\n{\n\terrno = EMSGSIZE;\n\tzed_log_msg(LOG_WARNING,\n\t    \"Failed to convert nvpair \\\"%s\\\" for eid=%llu: \"\n\t    \"Exceeded buffer size\", name, eid);\n\treturn (-1);\n}\n\nstatic int\n_zed_event_add_int8_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tint8_t *i8p;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_INT8_ARRAY));\n\n\tname = nvpair_name(nvp);\n\t(void) nvpair_value_int8_array(nvp, &i8p, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, \"%d \", i8p[i]);\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\nstatic int\n_zed_event_add_uint8_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tuint8_t *u8p;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_UINT8_ARRAY));\n\n\tname = nvpair_name(nvp);\n\t(void) nvpair_value_uint8_array(nvp, &u8p, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, \"%u \", u8p[i]);\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\nstatic int\n_zed_event_add_int16_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tint16_t *i16p;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_INT16_ARRAY));\n\n\tname = nvpair_name(nvp);\n\t(void) nvpair_value_int16_array(nvp, &i16p, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, \"%d \", i16p[i]);\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\nstatic int\n_zed_event_add_uint16_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tuint16_t *u16p;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_UINT16_ARRAY));\n\n\tname = nvpair_name(nvp);\n\t(void) nvpair_value_uint16_array(nvp, &u16p, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, \"%u \", u16p[i]);\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\nstatic int\n_zed_event_add_int32_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tint32_t *i32p;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_INT32_ARRAY));\n\n\tname = nvpair_name(nvp);\n\t(void) nvpair_value_int32_array(nvp, &i32p, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, \"%d \", i32p[i]);\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\nstatic int\n_zed_event_add_uint32_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tuint32_t *u32p;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_UINT32_ARRAY));\n\n\tname = nvpair_name(nvp);\n\t(void) nvpair_value_uint32_array(nvp, &u32p, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, \"%u \", u32p[i]);\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\nstatic int\n_zed_event_add_int64_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tint64_t *i64p;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_INT64_ARRAY));\n\n\tname = nvpair_name(nvp);\n\t(void) nvpair_value_int64_array(nvp, &i64p, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, \"%lld \", (u_longlong_t)i64p[i]);\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\nstatic int\n_zed_event_add_uint64_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tconst char *fmt;\n\tuint64_t *u64p;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_UINT64_ARRAY));\n\n\tname = nvpair_name(nvp);\n\tfmt = _zed_event_value_is_hex(name) ? \"0x%.16llX \" : \"%llu \";\n\t(void) nvpair_value_uint64_array(nvp, &u64p, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, fmt, (u_longlong_t)u64p[i]);\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\nstatic int\n_zed_event_add_string_array(uint64_t eid, zed_strings_t *zsp,\n    const char *prefix, nvpair_t *nvp)\n{\n\tchar buf[MAXBUF];\n\tint buflen = sizeof (buf);\n\tconst char *name;\n\tconst char **strp;\n\tuint_t nelem;\n\tuint_t i;\n\tchar *p;\n\tint n;\n\n\tassert((nvp != NULL) && (nvpair_type(nvp) == DATA_TYPE_STRING_ARRAY));\n\n\tname = nvpair_name(nvp);\n\t(void) nvpair_value_string_array(nvp, &strp, &nelem);\n\tfor (i = 0, p = buf; (i < nelem) && (buflen > 0); i++) {\n\t\tn = snprintf(p, buflen, \"%s \", strp[i] ? strp[i] : \"<NULL>\");\n\t\tif ((n < 0) || (n >= buflen))\n\t\t\treturn (_zed_event_add_array_err(eid, name));\n\t\tp += n;\n\t\tbuflen -= n;\n\t}\n\tif (nelem > 0)\n\t\t*--p = '\\0';\n\n\treturn (_zed_event_add_var(eid, zsp, prefix, name, \"%s\", buf));\n}\n\n \nstatic void\n_zed_event_add_nvpair(uint64_t eid, zed_strings_t *zsp, nvpair_t *nvp)\n{\n\tconst char *name;\n\tdata_type_t type;\n\tconst char *prefix = ZEVENT_VAR_PREFIX;\n\tboolean_t b;\n\tdouble d;\n\tuint8_t i8;\n\tuint16_t i16;\n\tuint32_t i32;\n\tuint64_t i64;\n\tconst char *str;\n\n\tassert(zsp != NULL);\n\tassert(nvp != NULL);\n\n\tname = nvpair_name(nvp);\n\ttype = nvpair_type(nvp);\n\n\tswitch (type) {\n\tcase DATA_TYPE_BOOLEAN:\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%s\", \"1\");\n\t\tbreak;\n\tcase DATA_TYPE_BOOLEAN_VALUE:\n\t\t(void) nvpair_value_boolean_value(nvp, &b);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%s\", b ? \"1\" : \"0\");\n\t\tbreak;\n\tcase DATA_TYPE_BYTE:\n\t\t(void) nvpair_value_byte(nvp, &i8);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%d\", i8);\n\t\tbreak;\n\tcase DATA_TYPE_INT8:\n\t\t(void) nvpair_value_int8(nvp, (int8_t *)&i8);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%d\", i8);\n\t\tbreak;\n\tcase DATA_TYPE_UINT8:\n\t\t(void) nvpair_value_uint8(nvp, &i8);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%u\", i8);\n\t\tbreak;\n\tcase DATA_TYPE_INT16:\n\t\t(void) nvpair_value_int16(nvp, (int16_t *)&i16);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%d\", i16);\n\t\tbreak;\n\tcase DATA_TYPE_UINT16:\n\t\t(void) nvpair_value_uint16(nvp, &i16);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%u\", i16);\n\t\tbreak;\n\tcase DATA_TYPE_INT32:\n\t\t(void) nvpair_value_int32(nvp, (int32_t *)&i32);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%d\", i32);\n\t\tbreak;\n\tcase DATA_TYPE_UINT32:\n\t\t(void) nvpair_value_uint32(nvp, &i32);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%u\", i32);\n\t\tbreak;\n\tcase DATA_TYPE_INT64:\n\t\t(void) nvpair_value_int64(nvp, (int64_t *)&i64);\n\t\t_zed_event_add_var(eid, zsp, prefix, name,\n\t\t    \"%lld\", (longlong_t)i64);\n\t\tbreak;\n\tcase DATA_TYPE_UINT64:\n\t\t(void) nvpair_value_uint64(nvp, &i64);\n\t\t_zed_event_add_var(eid, zsp, prefix, name,\n\t\t    (_zed_event_value_is_hex(name) ? \"0x%.16llX\" : \"%llu\"),\n\t\t    (u_longlong_t)i64);\n\t\t \n\t\tif (strcmp(name, FM_EREPORT_PAYLOAD_ZFS_VDEV_STATE) == 0 ||\n\t\t    strcmp(name, FM_EREPORT_PAYLOAD_ZFS_VDEV_LASTSTATE) == 0) {\n\t\t\tchar alt[32];\n\n\t\t\t(void) snprintf(alt, sizeof (alt), \"%s_str\", name);\n\t\t\t_zed_event_add_var(eid, zsp, prefix, alt, \"%s\",\n\t\t\t    zpool_state_to_name(i64, VDEV_AUX_NONE));\n\t\t} else\n\t\t \n\t\tif (strcmp(name, FM_EREPORT_PAYLOAD_ZFS_POOL_STATE) == 0) {\n\t\t\tchar alt[32];\n\n\t\t\t(void) snprintf(alt, sizeof (alt), \"%s_str\", name);\n\t\t\t_zed_event_add_var(eid, zsp, prefix, alt, \"%s\",\n\t\t\t    zpool_pool_state_to_name(i64));\n\t\t}\n\t\tbreak;\n\tcase DATA_TYPE_DOUBLE:\n\t\t(void) nvpair_value_double(nvp, &d);\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"%g\", d);\n\t\tbreak;\n\tcase DATA_TYPE_HRTIME:\n\t\t(void) nvpair_value_hrtime(nvp, (hrtime_t *)&i64);\n\t\t_zed_event_add_var(eid, zsp, prefix, name,\n\t\t    \"%llu\", (u_longlong_t)i64);\n\t\tbreak;\n\tcase DATA_TYPE_STRING:\n\t\t(void) nvpair_value_string(nvp, &str);\n\t\t_zed_event_add_var(eid, zsp, prefix, name,\n\t\t    \"%s\", (str ? str : \"<NULL>\"));\n\t\tbreak;\n\tcase DATA_TYPE_INT8_ARRAY:\n\t\t_zed_event_add_int8_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_UINT8_ARRAY:\n\t\t_zed_event_add_uint8_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_INT16_ARRAY:\n\t\t_zed_event_add_int16_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_UINT16_ARRAY:\n\t\t_zed_event_add_uint16_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_INT32_ARRAY:\n\t\t_zed_event_add_int32_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_UINT32_ARRAY:\n\t\t_zed_event_add_uint32_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_INT64_ARRAY:\n\t\t_zed_event_add_int64_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_UINT64_ARRAY:\n\t\t_zed_event_add_uint64_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_STRING_ARRAY:\n\t\t_zed_event_add_string_array(eid, zsp, prefix, nvp);\n\t\tbreak;\n\tcase DATA_TYPE_NVLIST:\n\tcase DATA_TYPE_BOOLEAN_ARRAY:\n\tcase DATA_TYPE_BYTE_ARRAY:\n\tcase DATA_TYPE_NVLIST_ARRAY:\n\t\t_zed_event_add_var(eid, zsp, prefix, name, \"_NOT_IMPLEMENTED_\");\n\t\tbreak;\n\tdefault:\n\t\terrno = EINVAL;\n\t\tzed_log_msg(LOG_WARNING,\n\t\t    \"Failed to convert nvpair \\\"%s\\\" for eid=%llu: \"\n\t\t    \"Unrecognized type=%u\", name, eid, (unsigned int) type);\n\t\tbreak;\n\t}\n}\n\n \nstatic void\n_zed_event_add_env_restrict(uint64_t eid, zed_strings_t *zsp,\n    const char *path)\n{\n\tconst char *env_restrict[][2] = {\n\t\t{ \"IFS\",\t\t\" \\t\\n\" },\n\t\t{ \"PATH\",\t\t_PATH_STDPATH },\n\t\t{ \"ZDB\",\t\tSBINDIR \"/zdb\" },\n\t\t{ \"ZED\",\t\tSBINDIR \"/zed\" },\n\t\t{ \"ZFS\",\t\tSBINDIR \"/zfs\" },\n\t\t{ \"ZINJECT\",\t\tSBINDIR \"/zinject\" },\n\t\t{ \"ZPOOL\",\t\tSBINDIR \"/zpool\" },\n\t\t{ \"ZFS_ALIAS\",\t\tZFS_META_ALIAS },\n\t\t{ \"ZFS_VERSION\",\tZFS_META_VERSION },\n\t\t{ \"ZFS_RELEASE\",\tZFS_META_RELEASE },\n\t\t{ NULL,\t\t\tNULL }\n\t};\n\n\t \n\tconst char *env_path[][2] = {\n\t\t{ \"IFS\",\t\t\" \\t\\n\" },\n\t\t{ \"PATH\",\t\tNULL },  \n\t\t{ \"ZDB\",\t\t\"zdb\" },\n\t\t{ \"ZED\",\t\t\"zed\" },\n\t\t{ \"ZFS\",\t\t\"zfs\" },\n\t\t{ \"ZINJECT\",\t\t\"zinject\" },\n\t\t{ \"ZPOOL\",\t\t\"zpool\" },\n\t\t{ \"ZFS_ALIAS\",\t\tZFS_META_ALIAS },\n\t\t{ \"ZFS_VERSION\",\tZFS_META_VERSION },\n\t\t{ \"ZFS_RELEASE\",\tZFS_META_RELEASE },\n\t\t{ NULL,\t\t\tNULL }\n\t};\n\tconst char *(*pa)[2];\n\n\tassert(zsp != NULL);\n\n\tpa = path != NULL ? env_path : env_restrict;\n\n\tfor (; *(*pa); pa++) {\n\t\t \n\t\tif (path != NULL && strcmp((*pa)[0], \"PATH\") == 0)\n\t\t\t(*pa)[1] = path;\n\n\t\t_zed_event_add_var(eid, zsp, NULL, (*pa)[0], \"%s\", (*pa)[1]);\n\t}\n}\n\n \nstatic void\n_zed_event_add_env_preserve(uint64_t eid, zed_strings_t *zsp)\n{\n\tconst char *env_preserve[] = {\n\t\t\"TZ\",\n\t\tNULL\n\t};\n\tconst char **keyp;\n\tconst char *val;\n\n\tassert(zsp != NULL);\n\n\tfor (keyp = env_preserve; *keyp; keyp++) {\n\t\tif ((val = getenv(*keyp)))\n\t\t\t_zed_event_add_var(eid, zsp, NULL, *keyp, \"%s\", val);\n\t}\n}\n\n \nstatic const char *\n_zed_event_get_subclass(const char *class)\n{\n\tconst char *p;\n\tint i;\n\n\tif (!class)\n\t\treturn (NULL);\n\n\tp = class;\n\tfor (i = 0; i < 3; i++) {\n\t\tp = strchr(p, '.');\n\t\tif (!p)\n\t\t\tbreak;\n\t\tp++;\n\t}\n\treturn (p);\n}\n\n \nstatic void\n_zed_event_add_time_strings(uint64_t eid, zed_strings_t *zsp, int64_t etime[])\n{\n\tstruct tm stp;\n\tchar buf[32];\n\n\tassert(zsp != NULL);\n\tassert(etime != NULL);\n\n\t_zed_event_add_var(eid, zsp, ZEVENT_VAR_PREFIX, \"TIME_SECS\",\n\t    \"%\" PRId64, etime[0]);\n\t_zed_event_add_var(eid, zsp, ZEVENT_VAR_PREFIX, \"TIME_NSECS\",\n\t    \"%\" PRId64, etime[1]);\n\n\tif (!localtime_r((const time_t *) &etime[0], &stp)) {\n\t\tzed_log_msg(LOG_WARNING, \"Failed to add %s%s for eid=%llu: %s\",\n\t\t    ZEVENT_VAR_PREFIX, \"TIME_STRING\", eid, \"localtime error\");\n\t} else if (!strftime(buf, sizeof (buf), \"%Y-%m-%d %H:%M:%S%z\", &stp)) {\n\t\tzed_log_msg(LOG_WARNING, \"Failed to add %s%s for eid=%llu: %s\",\n\t\t    ZEVENT_VAR_PREFIX, \"TIME_STRING\", eid, \"strftime error\");\n\t} else {\n\t\t_zed_event_add_var(eid, zsp, ZEVENT_VAR_PREFIX, \"TIME_STRING\",\n\t\t    \"%s\", buf);\n\t}\n}\n\n \nint\nzed_event_service(struct zed_conf *zcp)\n{\n\tnvlist_t *nvl;\n\tnvpair_t *nvp;\n\tint n_dropped;\n\tzed_strings_t *zsp;\n\tuint64_t eid;\n\tint64_t *etime;\n\tuint_t nelem;\n\tconst char *class;\n\tconst char *subclass;\n\tint rv;\n\n\tif (!zcp) {\n\t\terrno = EINVAL;\n\t\tzed_log_msg(LOG_ERR, \"Failed to service zevent: %s\",\n\t\t    strerror(errno));\n\t\treturn (EINVAL);\n\t}\n\trv = zpool_events_next(zcp->zfs_hdl, &nvl, &n_dropped, ZEVENT_NONE,\n\t    zcp->zevent_fd);\n\n\tif ((rv != 0) || !nvl)\n\t\treturn (errno);\n\n\tif (n_dropped > 0) {\n\t\tzed_log_msg(LOG_WARNING, \"Missed %d events\", n_dropped);\n\t\t_bump_event_queue_length();\n\t}\n\tif (nvlist_lookup_uint64(nvl, \"eid\", &eid) != 0) {\n\t\tzed_log_msg(LOG_WARNING, \"Failed to lookup zevent eid\");\n\t} else if (nvlist_lookup_int64_array(\n\t    nvl, \"time\", &etime, &nelem) != 0) {\n\t\tzed_log_msg(LOG_WARNING,\n\t\t    \"Failed to lookup zevent time (eid=%llu)\", eid);\n\t} else if (nelem != 2) {\n\t\tzed_log_msg(LOG_WARNING,\n\t\t    \"Failed to lookup zevent time (eid=%llu, nelem=%u)\",\n\t\t    eid, nelem);\n\t} else if (nvlist_lookup_string(nvl, \"class\", &class) != 0) {\n\t\tzed_log_msg(LOG_WARNING,\n\t\t    \"Failed to lookup zevent class (eid=%llu)\", eid);\n\t} else {\n\t\t \n\t\tzfs_agent_post_event(class, NULL, nvl);\n\n\t\tzsp = zed_strings_create();\n\n\t\tnvp = NULL;\n\t\twhile ((nvp = nvlist_next_nvpair(nvl, nvp)))\n\t\t\t_zed_event_add_nvpair(eid, zsp, nvp);\n\n\t\t_zed_event_add_env_restrict(eid, zsp, zcp->path);\n\t\t_zed_event_add_env_preserve(eid, zsp);\n\n\t\t_zed_event_add_var(eid, zsp, ZED_VAR_PREFIX, \"PID\",\n\t\t    \"%d\", (int)getpid());\n\t\t_zed_event_add_var(eid, zsp, ZED_VAR_PREFIX, \"ZEDLET_DIR\",\n\t\t    \"%s\", zcp->zedlet_dir);\n\t\tsubclass = _zed_event_get_subclass(class);\n\t\t_zed_event_add_var(eid, zsp, ZEVENT_VAR_PREFIX, \"SUBCLASS\",\n\t\t    \"%s\", (subclass ? subclass : class));\n\n\t\t_zed_event_add_time_strings(eid, zsp, etime);\n\n\t\tzed_exec_process(eid, class, subclass, zcp, zsp);\n\n\t\tzed_conf_write_state(zcp, eid, etime);\n\n\t\tzed_strings_destroy(zsp);\n\t}\n\tnvlist_free(nvl);\n\treturn (0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}