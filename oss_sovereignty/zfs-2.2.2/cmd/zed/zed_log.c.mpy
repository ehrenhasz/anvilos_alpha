{
  "module_name": "zed_log.c",
  "hash_id": "64baa1d65c0f533524b723512d9b6892e47003b77685a1b5678ea19dd46493cd",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/zed/zed_log.c",
  "human_readable_source": " \n\n#include <assert.h>\n#include <errno.h>\n#include <stdarg.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/types.h>\n#include <syslog.h>\n#include <unistd.h>\n#include \"zed_log.h\"\n\n#define\tZED_LOG_MAX_LOG_LEN\t1024\n\nstatic struct {\n\tunsigned do_stderr:1;\n\tunsigned do_syslog:1;\n\tconst char *identity;\n\tint priority;\n\tint pipe_fd[2];\n} _ctx;\n\n \nvoid\nzed_log_init(const char *identity)\n{\n\tif (identity) {\n\t\tconst char *p = strrchr(identity, '/');\n\t\t_ctx.identity = (p != NULL) ? p + 1 : identity;\n\t} else {\n\t\t_ctx.identity = NULL;\n\t}\n\t_ctx.pipe_fd[0] = -1;\n\t_ctx.pipe_fd[1] = -1;\n}\n\n \nvoid\nzed_log_fini(void)\n{\n\tzed_log_stderr_close();\n\tzed_log_syslog_close();\n}\n\n \nvoid\nzed_log_pipe_open(void)\n{\n\tif ((_ctx.pipe_fd[0] != -1) || (_ctx.pipe_fd[1] != -1))\n\t\tzed_log_die(\"Invalid use of zed_log_pipe_open in PID %d\",\n\t\t    (int)getpid());\n\n\tif (pipe(_ctx.pipe_fd) < 0)\n\t\tzed_log_die(\"Failed to create daemonize pipe in PID %d: %s\",\n\t\t    (int)getpid(), strerror(errno));\n}\n\n \nvoid\nzed_log_pipe_close_reads(void)\n{\n\tif (_ctx.pipe_fd[0] < 0)\n\t\tzed_log_die(\n\t\t    \"Invalid use of zed_log_pipe_close_reads in PID %d\",\n\t\t    (int)getpid());\n\n\tif (close(_ctx.pipe_fd[0]) < 0)\n\t\tzed_log_die(\n\t\t    \"Failed to close reads on daemonize pipe in PID %d: %s\",\n\t\t    (int)getpid(), strerror(errno));\n\n\t_ctx.pipe_fd[0] = -1;\n}\n\n \nvoid\nzed_log_pipe_close_writes(void)\n{\n\tif (_ctx.pipe_fd[1] < 0)\n\t\tzed_log_die(\n\t\t    \"Invalid use of zed_log_pipe_close_writes in PID %d\",\n\t\t    (int)getpid());\n\n\tif (close(_ctx.pipe_fd[1]) < 0)\n\t\tzed_log_die(\n\t\t    \"Failed to close writes on daemonize pipe in PID %d: %s\",\n\t\t    (int)getpid(), strerror(errno));\n\n\t_ctx.pipe_fd[1] = -1;\n}\n\n \nvoid\nzed_log_pipe_wait(void)\n{\n\tssize_t n;\n\tchar c;\n\n\tif (_ctx.pipe_fd[0] < 0)\n\t\tzed_log_die(\"Invalid use of zed_log_pipe_wait in PID %d\",\n\t\t    (int)getpid());\n\n\tfor (;;) {\n\t\tn = read(_ctx.pipe_fd[0], &c, sizeof (c));\n\t\tif (n < 0) {\n\t\t\tif (errno == EINTR)\n\t\t\t\tcontinue;\n\t\t\tzed_log_die(\n\t\t\t    \"Failed to read from daemonize pipe in PID %d: %s\",\n\t\t\t    (int)getpid(), strerror(errno));\n\t\t}\n\t\tif (n == 0) {\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\n \nvoid\nzed_log_stderr_open(int priority)\n{\n\t_ctx.do_stderr = 1;\n\t_ctx.priority = priority;\n}\n\n \nvoid\nzed_log_stderr_close(void)\n{\n\tif (_ctx.do_stderr)\n\t\t_ctx.do_stderr = 0;\n}\n\n \nvoid\nzed_log_syslog_open(int facility)\n{\n\t_ctx.do_syslog = 1;\n\topenlog(_ctx.identity, LOG_NDELAY | LOG_PID, facility);\n}\n\n \nvoid\nzed_log_syslog_close(void)\n{\n\tif (_ctx.do_syslog) {\n\t\t_ctx.do_syslog = 0;\n\t\tcloselog();\n\t}\n}\n\n \nstatic void\n_zed_log_aux(int priority, const char *fmt, va_list vargs)\n{\n\tchar buf[ZED_LOG_MAX_LOG_LEN];\n\tint n;\n\n\tif (!fmt)\n\t\treturn;\n\n\tn = vsnprintf(buf, sizeof (buf), fmt, vargs);\n\tif ((n < 0) || (n >= sizeof (buf))) {\n\t\tbuf[sizeof (buf) - 2] = '+';\n\t\tbuf[sizeof (buf) - 1] = '\\0';\n\t}\n\n\tif (_ctx.do_syslog)\n\t\tsyslog(priority, \"%s\", buf);\n\n\tif (_ctx.do_stderr && (priority <= _ctx.priority))\n\t\tfprintf(stderr, \"%s\\n\", buf);\n}\n\n \nvoid\nzed_log_msg(int priority, const char *fmt, ...)\n{\n\tva_list vargs;\n\n\tif (fmt) {\n\t\tva_start(vargs, fmt);\n\t\t_zed_log_aux(priority, fmt, vargs);\n\t\tva_end(vargs);\n\t}\n}\n\n \nvoid\nzed_log_die(const char *fmt, ...)\n{\n\tva_list vargs;\n\n\tif (fmt) {\n\t\tva_start(vargs, fmt);\n\t\t_zed_log_aux(LOG_ERR, fmt, vargs);\n\t\tva_end(vargs);\n\t}\n\texit(EXIT_FAILURE);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}