{
  "module_name": "history_event-zfs-list-cacher.sh.in",
  "hash_id": "6655e373f2fe8d371c3840404a95b0a904ae923280fe15cf760c6191beeefe47",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/zed/zed.d/history_event-zfs-list-cacher.sh.in",
  "human_readable_source": "#!/bin/sh\n# shellcheck disable=SC2154\n#\n# Track changes to enumerated pools for use in early-boot\nset -ef\n\nFSLIST=\"@sysconfdir@/zfs/zfs-list.cache/${ZEVENT_POOL}\"\nFSLIST_TMP=\"@runstatedir@/zfs-list.cache@${ZEVENT_POOL}\"\n\n# If the pool specific cache file is not writeable, abort\n[ -w \"${FSLIST}\" ] || exit 0\n\n[ -f \"${ZED_ZEDLET_DIR}/zed.rc\" ] && . \"${ZED_ZEDLET_DIR}/zed.rc\"\n. \"${ZED_ZEDLET_DIR}/zed-functions.sh\"\n\n[ \"$ZEVENT_SUBCLASS\" != \"history_event\" ] && exit 0\nzed_check_cmd \"${ZFS}\" sort diff\n\n# If we are acting on a snapshot, we have nothing to do\n[ \"${ZEVENT_HISTORY_DSNAME%@*}\" = \"${ZEVENT_HISTORY_DSNAME}\" ] || exit 0\n\n# We lock the output file to avoid simultaneous writes.\n# If we run into trouble, log and drop the lock\nabort_alter() {\n  zed_log_msg \"Error updating zfs-list.cache for ${ZEVENT_POOL}!\"\n  zed_unlock \"${FSLIST}\"\n}\n\nfinished() {\n  zed_unlock \"${FSLIST}\"\n  trap - EXIT\n  exit 0\n}\n\ncase \"${ZEVENT_HISTORY_INTERNAL_NAME}\" in\n    create|\"finish receiving\"|import|destroy|rename)\n      ;;\n\n    export)\n        zed_lock \"${FSLIST}\"\n        trap abort_alter EXIT\n        echo > \"${FSLIST}\"\n        finished\n      ;;\n\n    set|inherit)\n        # Only act if one of the tracked properties is altered.\n        case \"${ZEVENT_HISTORY_INTERNAL_STR%%=*}\" in\n            canmount|mountpoint|atime|relatime|devices|exec|readonly| \\\n              setuid|nbmand|encroot|keylocation|org.openzfs.systemd:requires| \\\n              org.openzfs.systemd:requires-mounts-for| \\\n              org.openzfs.systemd:before|org.openzfs.systemd:after| \\\n              org.openzfs.systemd:wanted-by|org.openzfs.systemd:required-by| \\\n              org.openzfs.systemd:nofail|org.openzfs.systemd:ignore \\\n            ) ;;\n            *) exit 0 ;;\n        esac\n      ;;\n\n    *)\n        # Ignore all other events.\n        exit 0\n      ;;\nesac\n\nzed_lock \"${FSLIST}\"\ntrap abort_alter EXIT\n\nPROPS=\"name,mountpoint,canmount,atime,relatime,devices,exec\\\n,readonly,setuid,nbmand,encroot,keylocation\\\n,org.openzfs.systemd:requires,org.openzfs.systemd:requires-mounts-for\\\n,org.openzfs.systemd:before,org.openzfs.systemd:after\\\n,org.openzfs.systemd:wanted-by,org.openzfs.systemd:required-by\\\n,org.openzfs.systemd:nofail,org.openzfs.systemd:ignore\"\n\n\"${ZFS}\" list -H -t filesystem -o \"${PROPS}\" -r \"${ZEVENT_POOL}\" > \"${FSLIST_TMP}\"\n\n# Sort the output so that it is stable\nsort \"${FSLIST_TMP}\" -o \"${FSLIST_TMP}\"\n\n# Don't modify the file if it hasn't changed\ndiff -q \"${FSLIST_TMP}\" \"${FSLIST}\" || cat \"${FSLIST_TMP}\" > \"${FSLIST}\"\nrm -f \"${FSLIST_TMP}\"\n\nfinished\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}