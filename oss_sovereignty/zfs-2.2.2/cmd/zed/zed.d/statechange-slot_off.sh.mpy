{
  "module_name": "statechange-slot_off.sh",
  "hash_id": "b4a801a6134e7eed3be4f60fd3f3b76e6f5606fae486a1b8e6a71b9919e0bbc0",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/zed/zed.d/statechange-slot_off.sh",
  "human_readable_source": "#!/bin/sh\n# shellcheck disable=SC3014,SC2154,SC2086,SC2034\n#\n# Turn off disk's enclosure slot if it becomes FAULTED.\n#\n# Bad SCSI disks can often \"disappear and reappear\" causing all sorts of chaos\n# as they flip between FAULTED and ONLINE.  If\n# ZED_POWER_OFF_ENCLOUSRE_SLOT_ON_FAULT is set in zed.rc, and the disk gets\n# FAULTED, then power down the slot via sysfs:\n#\n# /sys/class/enclosure/<enclosure>/<slot>/power_status\n#\n# We assume the user will be responsible for turning the slot back on again.\n#\n# Note that this script requires that your enclosure be supported by the\n# Linux SCSI Enclosure services (SES) driver.  The script will do nothing\n# if you have no enclosure, or if your enclosure isn't supported.\n#\n# Exit codes:\n#   0: slot successfully powered off\n#   1: enclosure not available\n#   2: ZED_POWER_OFF_ENCLOUSRE_SLOT_ON_FAULT disabled\n#   3: vdev was not FAULTED\n#   4: The enclosure sysfs path passed from ZFS does not exist\n#   5: Enclosure slot didn't actually turn off after we told it to\n\n[ -f \"${ZED_ZEDLET_DIR}/zed.rc\" ] && . \"${ZED_ZEDLET_DIR}/zed.rc\"\n. \"${ZED_ZEDLET_DIR}/zed-functions.sh\"\n\nif [ ! -d /sys/class/enclosure ] ; then\n\t# No JBOD enclosure or NVMe slots\n\texit 1\nfi\n\nif [ \"${ZED_POWER_OFF_ENCLOUSRE_SLOT_ON_FAULT}\" != \"1\" ] ; then\n\texit 2\nfi\n\nif [ \"$ZEVENT_VDEV_STATE_STR\" != \"FAULTED\" ] ; then\n\texit 3\nfi\n\nif [ ! -f \"$ZEVENT_VDEV_ENC_SYSFS_PATH/power_status\" ] ; then\n\texit 4\nfi\n\n# Turn off the slot and wait for sysfs to report that the slot is off.\n# It can take ~400ms on some enclosures and multiple retries may be needed.\nfor i in $(seq 1 20) ; do\n\techo \"off\" | tee \"$ZEVENT_VDEV_ENC_SYSFS_PATH/power_status\"\n\n\tfor j in $(seq 1 5) ; do\n\t\tif [ \"$(cat $ZEVENT_VDEV_ENC_SYSFS_PATH/power_status)\" == \"off\" ] ; then\n\t\t\tbreak 2\n\t\tfi\n\t\tsleep 0.1\n\tdone\ndone\n\nif [ \"$(cat $ZEVENT_VDEV_ENC_SYSFS_PATH/power_status)\" != \"off\" ] ; then\n\texit 5\nfi\n\nzed_log_msg \"powered down slot $ZEVENT_VDEV_ENC_SYSFS_PATH for $ZEVENT_VDEV_PATH\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}