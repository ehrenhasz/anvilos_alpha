{
  "module_name": "zed.c",
  "hash_id": "b6cad9ab93e69c59f4a454d938bdb53e1432464ceb87602c10a625aa7c000bbb",
  "original_prompt": "Ingested from zfs-2.2.2/cmd/zed/zed.c",
  "human_readable_source": " \n\n#include <errno.h>\n#include <fcntl.h>\n#include <signal.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mman.h>\n#include <sys/stat.h>\n#include <unistd.h>\n#include \"zed.h\"\n#include \"zed_conf.h\"\n#include \"zed_event.h\"\n#include \"zed_file.h\"\n#include \"zed_log.h\"\n\nstatic volatile sig_atomic_t _got_exit = 0;\nstatic volatile sig_atomic_t _got_hup = 0;\n\n \nstatic void\n_exit_handler(int signum)\n{\n\t(void) signum;\n\t_got_exit = 1;\n}\n\n \nstatic void\n_hup_handler(int signum)\n{\n\t(void) signum;\n\t_got_hup = 1;\n}\n\n \nstatic void\n_setup_sig_handlers(void)\n{\n\tstruct sigaction sa;\n\n\tif (sigemptyset(&sa.sa_mask) < 0)\n\t\tzed_log_die(\"Failed to initialize sigset\");\n\n\tsa.sa_flags = SA_RESTART;\n\n\tsa.sa_handler = SIG_IGN;\n\tif (sigaction(SIGPIPE, &sa, NULL) < 0)\n\t\tzed_log_die(\"Failed to ignore SIGPIPE\");\n\n\tsa.sa_handler = _exit_handler;\n\tif (sigaction(SIGINT, &sa, NULL) < 0)\n\t\tzed_log_die(\"Failed to register SIGINT handler\");\n\n\tif (sigaction(SIGTERM, &sa, NULL) < 0)\n\t\tzed_log_die(\"Failed to register SIGTERM handler\");\n\n\tsa.sa_handler = _hup_handler;\n\tif (sigaction(SIGHUP, &sa, NULL) < 0)\n\t\tzed_log_die(\"Failed to register SIGHUP handler\");\n\n\t(void) sigaddset(&sa.sa_mask, SIGCHLD);\n\tif (pthread_sigmask(SIG_BLOCK, &sa.sa_mask, NULL) < 0)\n\t\tzed_log_die(\"Failed to block SIGCHLD\");\n}\n\n \nstatic void\n_lock_memory(void)\n{\n#if HAVE_MLOCKALL\n\tint i = 0;\n\tconst int max_tries = 10;\n\n\tfor (i = 0; i < max_tries; i++) {\n\t\tif (mlockall(MCL_CURRENT | MCL_FUTURE) == 0) {\n\t\t\tzed_log_msg(LOG_INFO, \"Locked all pages in memory\");\n\t\t\treturn;\n\t\t}\n\t\tif (errno != EAGAIN)\n\t\t\tbreak;\n\t}\n\tzed_log_die(\"Failed to lock memory pages: %s\", strerror(errno));\n\n#else  \n\tzed_log_die(\"Failed to lock memory pages: mlockall() not supported\");\n#endif  \n}\n\n \nstatic void\n_start_daemonize(void)\n{\n\tpid_t pid;\n\tstruct sigaction sa;\n\n\t \n\tzed_log_pipe_open();\n\n\t \n\tpid = fork();\n\tif (pid < 0) {\n\t\tzed_log_die(\"Failed to create child process: %s\",\n\t\t    strerror(errno));\n\t} else if (pid > 0) {\n\n\t\t \n\t\tzed_log_pipe_close_writes();\n\n\t\t \n\t\tzed_log_pipe_wait();\n\n\t\tzed_log_pipe_close_reads();\n\t\t_exit(EXIT_SUCCESS);\n\t}\n\n\t \n\tzed_log_pipe_close_reads();\n\n\t \n\tif (setsid() < 0)\n\t\tzed_log_die(\"Failed to create new session: %s\",\n\t\t    strerror(errno));\n\n\t \n\tif (sigemptyset(&sa.sa_mask) < 0)\n\t\tzed_log_die(\"Failed to initialize sigset\");\n\n\tsa.sa_flags = 0;\n\tsa.sa_handler = SIG_IGN;\n\n\tif (sigaction(SIGHUP, &sa, NULL) < 0)\n\t\tzed_log_die(\"Failed to ignore SIGHUP\");\n\n\t \n\tpid = fork();\n\tif (pid < 0) {\n\t\tzed_log_die(\"Failed to create grandchild process: %s\",\n\t\t    strerror(errno));\n\t} else if (pid > 0) {\n\t\t_exit(EXIT_SUCCESS);\n\t}\n}\n\n \nstatic void\n_finish_daemonize(void)\n{\n\tint devnull;\n\n\t \n\tdevnull = open(\"/dev/null\", O_RDWR);\n\tif (devnull < 0)\n\t\tzed_log_die(\"Failed to open /dev/null: %s\", strerror(errno));\n\n\tif (dup2(devnull, STDIN_FILENO) < 0)\n\t\tzed_log_die(\"Failed to dup /dev/null onto stdin: %s\",\n\t\t    strerror(errno));\n\n\tif (dup2(devnull, STDOUT_FILENO) < 0)\n\t\tzed_log_die(\"Failed to dup /dev/null onto stdout: %s\",\n\t\t    strerror(errno));\n\n\tif (dup2(devnull, STDERR_FILENO) < 0)\n\t\tzed_log_die(\"Failed to dup /dev/null onto stderr: %s\",\n\t\t    strerror(errno));\n\n\tif ((devnull > STDERR_FILENO) && (close(devnull) < 0))\n\t\tzed_log_die(\"Failed to close /dev/null: %s\", strerror(errno));\n\n\t \n\tzed_log_pipe_close_writes();\n}\n\n \nint\nmain(int argc, char *argv[])\n{\n\tstruct zed_conf zcp;\n\tuint64_t saved_eid;\n\tint64_t saved_etime[2];\n\n\tzed_log_init(argv[0]);\n\tzed_log_stderr_open(LOG_NOTICE);\n\tzed_conf_init(&zcp);\n\tzed_conf_parse_opts(&zcp, argc, argv);\n\tif (zcp.do_verbose)\n\t\tzed_log_stderr_open(LOG_INFO);\n\n\tif (geteuid() != 0)\n\t\tzed_log_die(\"Must be run as root\");\n\n\tzed_file_close_from(STDERR_FILENO + 1);\n\n\t(void) umask(0);\n\n\tif (chdir(\"/\") < 0)\n\t\tzed_log_die(\"Failed to change to root directory\");\n\n\tif (zed_conf_scan_dir(&zcp) < 0)\n\t\texit(EXIT_FAILURE);\n\n\tif (!zcp.do_foreground) {\n\t\t_start_daemonize();\n\t\tzed_log_syslog_open(LOG_DAEMON);\n\t}\n\t_setup_sig_handlers();\n\n\tif (zcp.do_memlock)\n\t\t_lock_memory();\n\n\tif ((zed_conf_write_pid(&zcp) < 0) && (!zcp.do_force))\n\t\texit(EXIT_FAILURE);\n\n\tif (!zcp.do_foreground)\n\t\t_finish_daemonize();\n\n\tzed_log_msg(LOG_NOTICE,\n\t    \"ZFS Event Daemon %s-%s (PID %d)\",\n\t    ZFS_META_VERSION, ZFS_META_RELEASE, (int)getpid());\n\n\tif (zed_conf_open_state(&zcp) < 0)\n\t\texit(EXIT_FAILURE);\n\n\tif (zed_conf_read_state(&zcp, &saved_eid, saved_etime) < 0)\n\t\texit(EXIT_FAILURE);\n\nidle:\n\t \n\tdo {\n\t\tif (!zed_event_init(&zcp))\n\t\t\tbreak;\n\t\t \n\t\tsleep(30);\n\t} while (!_got_exit && zcp.do_idle);\n\n\tif (_got_exit)\n\t\tgoto out;\n\n\tzed_event_seek(&zcp, saved_eid, saved_etime);\n\n\twhile (!_got_exit) {\n\t\tint rv;\n\t\tif (_got_hup) {\n\t\t\t_got_hup = 0;\n\t\t\t(void) zed_conf_scan_dir(&zcp);\n\t\t}\n\t\trv = zed_event_service(&zcp);\n\n\t\t \n\t\tif (rv != 0)\n\t\t\tbreak;\n\t}\n\n\tzed_log_msg(LOG_NOTICE, \"Exiting\");\n\tzed_event_fini(&zcp);\n\n\tif (zcp.do_idle && !_got_exit)\n\t\tgoto idle;\n\nout:\n\tzed_conf_destroy(&zcp);\n\tzed_log_fini();\n\texit(EXIT_SUCCESS);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}