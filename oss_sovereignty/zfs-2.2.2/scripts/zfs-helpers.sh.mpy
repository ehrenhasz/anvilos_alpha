{
  "module_name": "zfs-helpers.sh",
  "hash_id": "476e4e07a419c37a6ce3090a5eb3a820aa67e7b5001a4c2f9e60742a066c3869",
  "original_prompt": "Ingested from zfs-2.2.2/scripts/zfs-helpers.sh",
  "human_readable_source": "#!/bin/sh\n# shellcheck disable=SC2154\n#\n# This script is designed to facilitate in-tree development and testing\n# by installing symlinks on your system which refer to in-tree helper\n# utilities.  These helper utilities must be installed to in order to\n# exercise all ZFS functionality.  By using symbolic links and keeping\n# the scripts in-tree during development they can be easily modified\n# and those changes tracked.\n#\n# Use the following configuration option to override the installation\n# paths for these scripts.  The correct path is automatically set for\n# most distributions but you can optionally set it for your environment.\n#\n#   --with-mounthelperdir=DIR  install mount.zfs in dir [/sbin]\n#   --with-udevdir=DIR         install udev helpers [default=check]\n#   --with-udevruledir=DIR     install udev rules [default=UDEVDIR/rules.d]\n#   --sysconfdir=DIR           install zfs configuration files [PREFIX/etc]\n#\n\nBASE_DIR=${0%/*}\nSCRIPT_COMMON=common.sh\nif [ -f \"${BASE_DIR}/${SCRIPT_COMMON}\" ]; then\n\t. \"${BASE_DIR}/${SCRIPT_COMMON}\"\nelse\n\techo \"Missing helper script ${SCRIPT_COMMON}\" && exit 1\nfi\n\nPROG=zfs-helpers.sh\nDRYRUN=\"no\"\nINSTALL=\"no\"\nREMOVE=\"no\"\nVERBOSE=\"no\"\n\nfail() {\n\techo \"${PROG}: $1\" >&2\n\texit 1\n}\n\nmsg() {\n\tif [ \"$VERBOSE\" = \"yes\" ]; then\n\t\techo \"$@\"\n\tfi\n}\n\nusage() {\ncat << EOF\nUSAGE:\n$0 [-dhirv]\n\nDESCRIPTION:\n\tInstall/remove the ZFS helper utilities.\n\nOPTIONS:\n\t-d      Dry run\n\t-h      Show this message\n\t-i      Install the helper utilities\n\t-r      Remove the helper utilities\n\t-v      Verbose\n\n$0 -iv\n$0 -r\n\nEOF\n}\n\nwhile getopts 'hdirv' OPTION; do\n\tcase $OPTION in\n\th)\n\t\tusage\n\t\texit 1\n\t\t;;\n\td)\n\t\tDRYRUN=\"yes\"\n\t\t;;\n\ti)\n\t\tINSTALL=\"yes\"\n\t\t;;\n\tr)\n\t\tREMOVE=\"yes\"\n\t\t;;\n\tv)\n\t\tVERBOSE=\"yes\"\n\t\t;;\n\t?)\n\t\tusage\n\t\texit\n\t\t;;\n\t*)\n\t\t;;\n\tesac\ndone\n\nif [ \"$INSTALL\" = \"yes\" ] && [ \"$REMOVE\" = \"yes\" ]; then\n\tfail \"Specify -i or -r but not both\"\nfi\n\nif [ \"$INSTALL\" = \"no\" ] && [ \"$REMOVE\" = \"no\" ]; then\n\tfail \"Either -i or -r must be specified\"\nfi\n\nif [ \"$(id -u)\" != \"0\" ] && [ \"$DRYRUN\" = \"no\" ]; then\n\tfail \"Must run as root\"\nfi\n\nif [ \"$INTREE\" != \"yes\" ]; then\n\tfail \"Must be run in-tree\"\nfi\n\nif [ \"$VERBOSE\" = \"yes\" ]; then\n\techo \"--- Configuration ---\"\n\techo \"udevdir:          $INSTALL_UDEV_DIR\"\n\techo \"udevruledir:      $INSTALL_UDEV_RULE_DIR\"\n\techo \"mounthelperdir:   $INSTALL_MOUNT_HELPER_DIR\"\n\techo \"sysconfdir:       $INSTALL_SYSCONF_DIR\"\n\techo \"pythonsitedir:    $INSTALL_PYTHON_DIR\"\n\techo \"dryrun:           $DRYRUN\"\n\techo\nfi\n\ninstall() {\n\tsrc=$1\n\tdst=$2\n\n\tif [ -h \"$dst\" ]; then\n\t\techo \"Symlink exists: $dst\"\n\telif [ -e \"$dst\" ]; then\n\t\techo \"File exists: $dst\"\n\telif ! [ -e \"$src\" ]; then\n\t\techo \"Source missing: $src\"\n\telse\n\t\tmsg \"ln -s $src $dst\"\n\n\t\tif [ \"$DRYRUN\" = \"no\" ]; then\n\t\t\tDIR=${dst%/*}\n\t\t\tmkdir -p \"$DIR\" >/dev/null 2>&1\n\t\t\tln -s \"$src\" \"$dst\"\n\t\tfi\n\tfi\n}\n\nremove() {\n\tdst=$1\n\n\tif [ -h \"$dst\" ]; then\n\t\tmsg \"rm $dst\"\n\t\trm \"$dst\"\n\t\tDIR=${dst%/*}\n\t\trmdir \"$DIR\" >/dev/null 2>&1\n\telif [ -e \"$dst\" ]; then\n\t\techo \"Expected symlink: $dst\"\n\tfi\n}\n\nif [ \"${INSTALL}\" = \"yes\" ]; then\n\tfor cmd in \"mount.zfs\" \"fsck.zfs\"; do\n\t\tinstall \"$CMD_DIR/$cmd\" \"$INSTALL_MOUNT_HELPER_DIR/$cmd\"\n\tdone\n\tfor udev in \"$UDEV_CMD_DIR/zvol_id\" \"$UDEV_SCRIPT_DIR/vdev_id\"; do\n\t\tinstall \"$udev\" \"$INSTALL_UDEV_DIR/${udev##*/}\"\n\tdone\n\tfor rule in \"60-zvol.rules\" \"69-vdev.rules\" \"90-zfs.rules\"; do\n\t\tinstall \"$UDEV_RULE_DIR/$rule\" \"$INSTALL_UDEV_RULE_DIR/$rule\"\n\tdone\n\tinstall \"$ZPOOL_SCRIPT_DIR\"              \"$INSTALL_SYSCONF_DIR/zfs/zpool.d\"\n\tinstall \"$CONTRIB_DIR/pyzfs/libzfs_core\" \"$INSTALL_PYTHON_DIR/libzfs_core\"\n\t# Ideally we would install these in the configured ${libdir}, which is\n\t# by default \"/usr/local/lib and unfortunately not included in the\n\t# dynamic linker search path.\n\tinstall \"$LIB_DIR\"/libzfs_core.so.?.?.? \"/lib/libzfs_core.so\"\n\tinstall \"$LIB_DIR\"/libnvpair.so.?.?.?   \"/lib/libnvpair.so\"\n\t[ \"$DRYRUN\" = \"no\" ] && ldconfig\nelse\n\tremove \"$INSTALL_MOUNT_HELPER_DIR/mount.zfs\"\n\tremove \"$INSTALL_MOUNT_HELPER_DIR/fsck.zfs\"\n\tremove \"$INSTALL_UDEV_DIR/zvol_id\"\n\tremove \"$INSTALL_UDEV_DIR/vdev_id\"\n\tremove \"$INSTALL_UDEV_RULE_DIR/60-zvol.rules\"\n\tremove \"$INSTALL_UDEV_RULE_DIR/69-vdev.rules\"\n\tremove \"$INSTALL_UDEV_RULE_DIR/90-zfs.rules\"\n\tremove \"$INSTALL_SYSCONF_DIR/zfs/zpool.d\"\n\tremove \"$INSTALL_PYTHON_DIR/libzfs_core\"\n\tremove \"/lib/libzfs_core.so\"\n\tremove \"/lib/libnvpair.so\"\n\tldconfig\nfi\n\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}