{
  "module_name": "zloop.sh",
  "hash_id": "76fcd3ab4974d2fec3871abbce6b8e3832d994c76852da3f49126011390e0d70",
  "original_prompt": "Ingested from zfs-2.2.2/scripts/zloop.sh",
  "human_readable_source": "#!/usr/bin/env bash\n\n#\n# CDDL HEADER START\n#\n# This file and its contents are supplied under the terms of the\n# Common Development and Distribution License (\"CDDL\"), version 1.0.\n# You may only use this file in accordance with the terms of version\n# 1.0 of the CDDL.\n#\n# A full copy of the text of the CDDL should have accompanied this\n# source.  A copy of the CDDL is also available via the Internet at\n# http://www.illumos.org/license/CDDL.\n#\n# CDDL HEADER END\n#\n\n#\n# Copyright (c) 2015 by Delphix. All rights reserved.\n# Copyright (C) 2016 Lawrence Livermore National Security, LLC.\n# Copyright (c) 2017, Intel Corporation.\n#\n\nBASE_DIR=${0%/*}\nSCRIPT_COMMON=common.sh\nif [[ -f \"${BASE_DIR}/${SCRIPT_COMMON}\" ]]; then\n\t. \"${BASE_DIR}/${SCRIPT_COMMON}\"\nelse\n\techo \"Missing helper script ${SCRIPT_COMMON}\" && exit 1\nfi\n\n# shellcheck disable=SC2034\nPROG=zloop.sh\nGDB=${GDB:-gdb}\n\nDEFAULTWORKDIR=/var/tmp\nDEFAULTCOREDIR=/var/tmp/zloop\n\nfunction usage\n{\n\tcat >&2 <<EOF\n\n$0 [-hl] [-c <dump directory>] [-f <vdev directory>]\n  [-m <max core dumps>] [-s <vdev size>] [-t <timeout>]\n  [-I <max iterations>] [-- [extra ztest parameters]]\n\n  This script runs ztest repeatedly with randomized arguments.\n  If a crash is encountered, the ztest logs, any associated\n  vdev files, and core file (if one exists) are moved to the\n  output directory ($DEFAULTCOREDIR by default). Any options\n  after the -- end-of-options marker will be passed to ztest.\n\n  Options:\n    -c  Specify a core dump directory to use.\n    -f  Specify working directory for ztest vdev files.\n    -h  Print this help message.\n    -l  Create 'ztest.core.N' symlink to core directory.\n    -m  Max number of core dumps to allow before exiting.\n    -s  Size of vdev devices.\n    -t  Total time to loop for, in seconds. If not provided,\n        zloop runs forever.\n    -I  Max number of iterations to loop before exiting.\n\nEOF\n}\n\nfunction or_die\n{\n\tif ! \"$@\"; then\n\t\techo \"Command failed: $*\"\n\t\texit 1\n\tfi\n}\n\ncase $(uname) in\nFreeBSD)\n\tcoreglob=\"z*.core\"\n\t;;\nLinux)\n\t# core file helpers\n\tread -r origcorepattern </proc/sys/kernel/core_pattern\n\tcoreglob=\"$(grep -E -o '^([^|%[:space:]]*)' /proc/sys/kernel/core_pattern)*\"\n\n\tif [[ $coreglob = \"*\" ]]; then\n\t\techo \"Setting core file pattern...\"\n\t\techo \"core\" > /proc/sys/kernel/core_pattern\n\t\tcoreglob=\"$(grep -E -o '^([^|%[:space:]]*)' \\\n\t\t    /proc/sys/kernel/core_pattern)*\"\n\tfi\n\t;;\n*)\n\texit 1\n\t;;\nesac\n\nfunction core_file\n{\n\t# shellcheck disable=SC2012,SC2086\n\tls -tr1 $coreglob 2>/dev/null | head -1\n}\n\nfunction core_prog\n{\n\t# shellcheck disable=SC2154\n\tprog=$ZTEST\n\tcore_id=$($GDB --batch -c \"$1\" | grep \"Core was generated by\" | \\\n\t    tr  \\' ' ')\n\tif [[ \"$core_id\" == *\"zdb \"* ]]; then\n\t\t# shellcheck disable=SC2154\n\t\tprog=$ZDB\n\tfi\n\tprintf \"%s\" \"$prog\"\n}\n\nfunction store_core\n{\n\tcore=\"$(core_file)\"\n\tif [[ $ztrc -ne 0 ]] || [[ -f \"$core\" ]]; then\n\t\tdf -h \"$workdir\" >>ztest.out\n\t\tcoreid=$(date \"+zloop-%y%m%d-%H%M%S\")\n\t\tfoundcrashes=$((foundcrashes + 1))\n\n\t\t# zdb debugging\n\t\tzdbcmd=\"$ZDB -U \"$workdir/zpool.cache\" -dddMmDDG ztest\"\n\t\tzdbdebug=$($zdbcmd 2>&1)\n\t\techo -e \"$zdbcmd\\n\" >>ztest.zdb\n\t\techo \"$zdbdebug\" >>ztest.zdb\n\n\t\tdest=$coredir/$coreid\n\t\tor_die mkdir -p \"$dest/vdev\"\n\n\t\tif [[ $symlink -ne 0 ]]; then\n\t\t\tor_die ln -sf \"$dest\" \"ztest.core.${foundcrashes}\"\n\t\tfi\n\n\t\techo \"*** ztest crash found - moving logs to $dest\"\n\n\t\tor_die mv ztest.history ztest.zdb ztest.out \"$dest/\"\n\t\tor_die mv \"$workdir/\"ztest* \"$dest/vdev/\"\n\n\t\tif [[ -e \"$workdir/zpool.cache\" ]]; then\n\t\t\tor_die mv \"$workdir/zpool.cache\" \"$dest/vdev/\"\n\t\tfi\n\n\t\t# check for core\n\t\tif [[ -f \"$core\" ]]; then\n\t\t\tcoreprog=$(core_prog \"$core\")\n\t\t\tcoredebug=$($GDB --batch --quiet \\\n\t\t\t    -ex \"set print thread-events off\" \\\n\t\t\t    -ex \"printf \\\"*\\n* Backtrace \\n*\\n\\\"\" \\\n\t\t\t    -ex \"bt\" \\\n\t\t\t    -ex \"printf \\\"*\\n* Libraries \\n*\\n\\\"\" \\\n\t\t\t    -ex \"info sharedlib\" \\\n\t\t\t    -ex \"printf \\\"*\\n* Threads (full) \\n*\\n\\\"\" \\\n\t\t\t    -ex \"info threads\" \\\n\t\t\t    -ex \"printf \\\"*\\n* Backtraces \\n*\\n\\\"\" \\\n\t\t\t    -ex \"thread apply all bt\" \\\n\t\t\t    -ex \"printf \\\"*\\n* Backtraces (full) \\n*\\n\\\"\" \\\n\t\t\t    -ex \"thread apply all bt full\" \\\n\t\t\t    -ex \"quit\" \"$coreprog\" \"$core\" 2>&1 | \\\n\t\t\t    grep -v \"New LWP\")\n\n\t\t\t# Dump core + logs to stored directory\n\t\t\techo \"$coredebug\" >>\"$dest/ztest.gdb\"\n\t\t\tor_die mv \"$core\" \"$dest/\"\n\n\t\t\t# Record info in cores logfile\n\t\t\techo \"*** core @ $coredir/$coreid/$core:\" | \\\n\t\t\t    tee -a ztest.cores\n\t\tfi\n\n\t\tif [[ $coremax -gt 0 ]] &&\n\t\t   [[ $foundcrashes -ge $coremax ]]; then\n\t\t\techo \"exiting... max $coremax allowed cores\"\n\t\t\texit 1\n\t\telse\n\t\t\techo \"continuing...\"\n\t\tfi\n\tfi\n}\n\n# parse arguments\n# expected format: zloop [-t timeout] [-c coredir] [-- extra ztest args]\ncoredir=$DEFAULTCOREDIR\nbasedir=$DEFAULTWORKDIR\nrundir=\"zloop-run\"\ntimeout=0\nsize=\"512m\"\ncoremax=0\nsymlink=0\niterations=0\nwhile getopts \":ht:m:I:s:c:f:l\" opt; do\n\tcase $opt in\n\t\tt ) [[ $OPTARG -gt 0 ]] && timeout=$OPTARG ;;\n\t\tm ) [[ $OPTARG -gt 0 ]] && coremax=$OPTARG ;;\n\t\tI ) [[ -n $OPTARG ]] && iterations=$OPTARG ;;\n\t\ts ) [[ -n $OPTARG ]] && size=$OPTARG ;;\n\t\tc ) [[ -n $OPTARG ]] && coredir=$OPTARG ;;\n\t\tf ) [[ -n $OPTARG ]] && basedir=$(readlink -f \"$OPTARG\") ;;\n\t\tl ) symlink=1 ;;\n\t\th ) usage\n\t\t    exit 2\n\t\t    ;;\n\t\t* ) echo \"Invalid argument: -$OPTARG\";\n\t\t    usage\n\t\t    exit 1\n\tesac\ndone\n# pass remaining arguments on to ztest\nshift $((OPTIND - 1))\n\n# enable core dumps\nulimit -c unlimited\nexport ASAN_OPTIONS=abort_on_error=true:halt_on_error=true:allocator_may_return_null=true:disable_coredump=false:detect_stack_use_after_return=true\nexport UBSAN_OPTIONS=abort_on_error=true:halt_on_error=true:print_stacktrace=true\n\nif [[ -f \"$(core_file)\" ]]; then\n\techo -n \"There's a core dump here you might want to look at first... \"\n\tcore_file\n\techo\n\texit 1\nfi\n\nif [[ ! -d $coredir ]]; then\n\techo \"core dump directory ($coredir) does not exist, creating it.\"\n\tor_die mkdir -p \"$coredir\"\nfi\n\nif [[ ! -w $coredir ]]; then\n\techo \"core dump directory ($coredir) is not writable.\"\n\texit 1\nfi\n\nor_die rm -f ztest.history ztest.zdb ztest.cores\n\nztrc=0\t\t# ztest return value\nfoundcrashes=0\t# number of crashes found so far\nstarttime=$(date +%s)\ncurtime=$starttime\niteration=0\n\n# if no timeout was specified, loop forever.\nwhile (( timeout == 0 )) || (( curtime <= (starttime + timeout) )); do\n\tif (( iterations > 0 )) && (( iteration++ == iterations )); then\n\t\tbreak\n\tfi\n\n\tzopt=\"-G -VVVVV\"\n\n\t# start each run with an empty directory\n\tworkdir=\"$basedir/$rundir\"\n\tor_die rm -rf \"$workdir\"\n\tor_die mkdir \"$workdir\"\n\n\t# switch between three types of configs\n\t# 1/3 basic, 1/3 raidz mix, and 1/3 draid mix\n\tchoice=$((RANDOM % 3))\n\n\t# ashift range 9 - 15\n\talign=$(((RANDOM % 2) * 3 + 9))\n\n\t# randomly use special classes\n\tclass=\"special=random\"\n\n\tif [[ $choice -eq 0 ]]; then\n\t\t# basic mirror only\n\t\tparity=1\n\t\tmirrors=2\n\t\tdraid_data=0\n\t\tdraid_spares=0\n\t\traid_children=0\n\t\tvdevs=2\n\t\traid_type=\"raidz\"\n\telif [[ $choice -eq 1 ]]; then\n\t\t# fully randomized mirror/raidz (sans dRAID)\n\t\tparity=$(((RANDOM % 3) + 1))\n\t\tmirrors=$(((RANDOM % 3) * 1))\n\t\tdraid_data=0\n\t\tdraid_spares=0\n\t\traid_children=$((((RANDOM % 9) + parity + 1) * (RANDOM % 2)))\n\t\tvdevs=$(((RANDOM % 3) + 3))\n\t\traid_type=\"raidz\"\n\telse\n\t\t# fully randomized dRAID (sans mirror/raidz)\n\t\tparity=$(((RANDOM % 3) + 1))\n\t\tmirrors=0\n\t\tdraid_data=$(((RANDOM % 8) + 3))\n\t\tdraid_spares=$(((RANDOM % 2) + parity))\n\t\tstripe=$((draid_data + parity))\n\t\textra=$((draid_spares + (RANDOM % 4)))\n\t\traid_children=$(((((RANDOM % 4) + 1) * stripe) + extra))\n\t\tvdevs=$((RANDOM % 3))\n\t\traid_type=\"draid\"\n\tfi\n\n\tzopt=\"$zopt -K $raid_type\"\n\tzopt=\"$zopt -m $mirrors\"\n\tzopt=\"$zopt -r $raid_children\"\n\tzopt=\"$zopt -D $draid_data\"\n\tzopt=\"$zopt -S $draid_spares\"\n\tzopt=\"$zopt -R $parity\"\n\tzopt=\"$zopt -v $vdevs\"\n\tzopt=\"$zopt -a $align\"\n\tzopt=\"$zopt -C $class\"\n\tzopt=\"$zopt -s $size\"\n\tzopt=\"$zopt -f $workdir\"\n\n\tcmd=\"$ZTEST $zopt $*\"\n\techo \"$(date '+%m/%d %T') $cmd\" | tee -a ztest.history ztest.out\n\t$cmd >>ztest.out 2>&1\n\tztrc=$?\n\tgrep -E '===|WARNING' ztest.out >>ztest.history\n\n\tstore_core\n\n\tcurtime=$(date +%s)\ndone\n\necho \"zloop finished, $foundcrashes crashes found\"\n\n# restore core pattern.\ncase $(uname) in\nLinux)\n\techo \"$origcorepattern\" > /proc/sys/kernel/core_pattern\n\t;;\n*)\n\t;;\nesac\n\nuptime >>ztest.out\n\nif [[ $foundcrashes -gt 0 ]]; then\n\texit 1\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}