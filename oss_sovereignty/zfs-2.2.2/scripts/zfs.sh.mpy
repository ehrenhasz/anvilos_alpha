{
  "module_name": "zfs.sh",
  "hash_id": "de2a24e09e6e87da6d133847aebe9af924e086677361b16a62d26540d6f61960",
  "original_prompt": "Ingested from zfs-2.2.2/scripts/zfs.sh",
  "human_readable_source": "#!/bin/sh\n#\n# A simple script to load/unload the ZFS module stack.\n#\n\nBASE_DIR=${0%/*}\nSCRIPT_COMMON=common.sh\nif [ -f \"${BASE_DIR}/${SCRIPT_COMMON}\" ]; then\n\t. \"${BASE_DIR}/${SCRIPT_COMMON}\"\nelse\n\techo \"Missing helper script ${SCRIPT_COMMON}\" && exit 1\nfi\n\nVERBOSE=\"no\"\nUNLOAD=\"no\"\nLOAD=\"yes\"\nSTACK_TRACER=\"no\"\n\nZED_PIDFILE=${ZED_PIDFILE:-/var/run/zed.pid}\nLDMOD=${LDMOD:-/sbin/modprobe}\nDELMOD=${DELMOD:-/sbin/rmmod}\n\nKMOD_ZLIB_DEFLATE=${KMOD_ZLIB_DEFLATE:-zlib_deflate}\nKMOD_ZLIB_INFLATE=${KMOD_ZLIB_INFLATE:-zlib_inflate}\nKMOD_SPL=${KMOD_SPL:-spl}\nKMOD_ZFS=${KMOD_ZFS:-zfs}\nKMOD_FREEBSD=${KMOD_FREEBSD:-openzfs}\n\n\nusage() {\n\tcat << EOF\nUSAGE:\n$0 [hvudS]\n\nDESCRIPTION:\n\tLoad/unload the ZFS module stack.\n\nOPTIONS:\n\t-h\tShow this message\n\t-v\tVerbose\n\t-r\tReload modules\n\t-u\tUnload modules\n\t-S\tEnable kernel stack tracer\nEOF\n\texit 1\n}\n\nwhile getopts 'hvruS' OPTION; do\n\tcase $OPTION in\n\tv)\n\t\tVERBOSE=\"yes\"\n\t\t;;\n\tr)\n\t\tUNLOAD=\"yes\"\n\t\tLOAD=\"yes\"\n\t\t;;\n\tu)\n\t\tUNLOAD=\"yes\"\n\t\tLOAD=\"no\"\n\t\t;;\n\tS)\n\t\tSTACK_TRACER=\"yes\"\n\t\t;;\n\t*)\n\t\tusage\n\t\t;;\n\tesac\ndone\nshift $(( OPTIND - 1 ))\n[ $# -eq 0 ] || usage\n\nkill_zed() {\n\tif [ -f \"$ZED_PIDFILE\" ]; then\n\t\tread -r PID <\"$ZED_PIDFILE\"\n\t\tkill \"$PID\"\n\tfi\n}\n\ncheck_modules_linux() {\n\tLOADED_MODULES=\"\"\n\tMISSING_MODULES=\"\"\n\n\tfor KMOD in $KMOD_SPL $KMOD_ZFS; do\n\t\tNAME=\"${KMOD##*/}\"\n\t\tNAME=\"${NAME%.ko}\"\n\n\t\tif lsmod | grep -E -q \"^${NAME}\"; then\n\t\t\tLOADED_MODULES=\"$LOADED_MODULES\\t$NAME\\n\"\n\t\tfi\n\n\t\tif ! modinfo \"$KMOD\" >/dev/null 2>&1; then\n\t\t\tMISSING_MODULES=\"$MISSING_MODULES\\t${KMOD}\\n\"\n\t\tfi\n\tdone\n\n\tif [ -n \"$LOADED_MODULES\" ]; then\n\t\tprintf \"Unload the kernel modules by running '%s -u':\\n\" \"$0\"\n\t\tprintf \"%b\" \"$LOADED_MODULES\"\n\t\texit 1\n\tfi\n\n\tif [ -n \"$MISSING_MODULES\" ]; then\n\t\tprintf \"The following kernel modules can not be found:\\n\"\n\t\tprintf \"%b\" \"$MISSING_MODULES\"\n\t\texit 1\n\tfi\n\n\treturn 0\n}\n\nload_module_linux() {\n\tKMOD=$1\n\n\tFILE=$(modinfo \"$KMOD\" 2>&1 | awk 'NR == 1 && /zlib/ && /not found/ {print \"(builtin)\"; exit}  /^filename:/ {print $2}')\n\t[ \"$FILE\" = \"(builtin)\" ] && return\n\n\tif [ \"$VERBOSE\" = \"yes\" ]; then\n\t\tVERSION=$(modinfo \"$KMOD\" | awk '/^version:/ {print $2}')\n\t\techo \"Loading: $FILE ($VERSION)\"\n\tfi\n\n\tif ! $LDMOD \"$KMOD\" >/dev/null 2>&1; then\n\t\techo \"Failed to load $KMOD\"\n\t\treturn 1\n\tfi\n\n\treturn 0\n}\n\nload_modules_freebsd() {\n\tkldload \"$KMOD_FREEBSD\" || return 1\n\n\tif [ \"$VERBOSE\" = \"yes\" ]; then\n\t\techo \"Successfully loaded ZFS module stack\"\n\tfi\n\n\treturn 0\n}\n\nload_modules_linux() {\n\tmkdir -p /etc/zfs\n\n\tfor KMOD in \"$KMOD_ZLIB_DEFLATE\" \"$KMOD_ZLIB_INFLATE\" $KMOD_SPL $KMOD_ZFS; do\n\t\tload_module_linux \"$KMOD\" || return 1\n\tdone\n\n\tif [ \"$VERBOSE\" = \"yes\" ]; then\n\t\techo \"Successfully loaded ZFS module stack\"\n\tfi\n\n\treturn 0\n}\n\nunload_modules_freebsd() {\n\tkldunload \"$KMOD_FREEBSD\" || echo \"Failed to unload $KMOD_FREEBSD\"\n\n\tif [ \"$VERBOSE\" = \"yes\" ]; then\n\t\techo \"Successfully unloaded ZFS module stack\"\n\tfi\n\n\treturn 0\n}\n\nunload_modules_linux() {\n\tlegacy_kmods=\"icp zzstd zlua zcommon zunicode znvpair zavl\"\n\tfor KMOD in \"$KMOD_ZFS\" $legacy_kmods \"$KMOD_SPL\"; do\n\t\tNAME=\"${KMOD##*/}\"\n\t\tNAME=\"${NAME%.ko}\"\n\t\t! [ -d \"/sys/module/$NAME\" ] || $DELMOD \"$NAME\" || return\n\tdone\n\n\tif [ \"$VERBOSE\" = \"yes\" ]; then\n\t\techo \"Successfully unloaded ZFS module stack\"\n\tfi\n}\n\nstack_clear_linux() {\n\tSTACK_MAX_SIZE=/sys/kernel/debug/tracing/stack_max_size\n\tSTACK_TRACER_ENABLED=/proc/sys/kernel/stack_tracer_enabled\n\n\tif [ \"$STACK_TRACER\" = \"yes\" ] && [ -e \"$STACK_MAX_SIZE\" ]; then\n\t\techo 1 >\"$STACK_TRACER_ENABLED\"\n\t\techo 0 >\"$STACK_MAX_SIZE\"\n\tfi\n}\n\nstack_check_linux() {\n\tSTACK_MAX_SIZE=/sys/kernel/debug/tracing/stack_max_size\n\tSTACK_TRACE=/sys/kernel/debug/tracing/stack_trace\n\tSTACK_LIMIT=15362\n\n\tif [ -e \"$STACK_MAX_SIZE\" ]; then\n\t\tread -r STACK_SIZE <\"$STACK_MAX_SIZE\"\n\t\tif [ \"$STACK_SIZE\" -ge \"$STACK_LIMIT\" ]; then\n\t\t\techo\n\t\t\techo \"Warning: max stack size $STACK_SIZE bytes\"\n\t\t\tcat \"$STACK_TRACE\"\n\t\tfi\n\tfi\n}\n\nif [ \"$(id -u)\" != 0 ]; then\n\techo \"Must run as root\"\n\texit 1\nfi\n\nUNAME=$(uname)\n\nif [ \"$UNLOAD\" = \"yes\" ]; then\n\tkill_zed\n\tumount -t zfs -a\n\tcase $UNAME in\n\t\tFreeBSD)\n\t\t   unload_modules_freebsd\n\t\t   ;;\n\t\tLinux)\n\t\t   stack_check_linux\n\t\t   unload_modules_linux\n\t\t   ;;\n\t\t*)\n\t\t   echo \"unknown system: $UNAME\" >&2\n\t\t   exit 1\n\t\t   ;;\n\tesac\nfi\nif [ \"$LOAD\" = \"yes\" ]; then\n\tcase $UNAME in\n\t\tFreeBSD)\n\t\t   load_modules_freebsd\n\t\t   ;;\n\t\tLinux)\n\t\t   stack_clear_linux\n\t\t   check_modules_linux\n\t\t   load_modules_linux\n\t\t   udevadm trigger\n\t\t   udevadm settle\n\t\t   ;;\n\t\t*)\n\t\t   echo \"unknown system: $UNAME\" >&2\n\t\t   exit 1\n\t\t   ;;\n\tesac\nfi\n\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}