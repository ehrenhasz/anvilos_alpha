{
  "module_name": "repl.py",
  "hash_id": "d1b33e11c6615303ca11a2eb9dc37ba0e2886c6c9296f5b4d3e6aff2507ff63c",
  "original_prompt": "Ingested from sys_09_Anvil/source/tools/mpremote/mpremote/repl.py",
  "human_readable_source": "from .console import Console, ConsolePosix\n\nfrom .transport import TransportError\n\n\ndef do_repl_main_loop(\n    state, console_in, console_out_write, *, escape_non_printable, code_to_inject, file_to_inject\n):\n    while True:\n        console_in.waitchar(state.transport.serial)\n        c = console_in.readchar()\n        if c:\n            if c in (b\"\\x1d\", b\"\\x18\"):  # ctrl-] or ctrl-x, quit\n                break\n            elif c == b\"\\x04\":  # ctrl-D\n                # special handling needed for ctrl-D if filesystem is mounted\n                state.transport.write_ctrl_d(console_out_write)\n            elif c == b\"\\x0a\" and code_to_inject is not None:  # ctrl-j, inject code\n                state.transport.serial.write(code_to_inject)\n            elif c == b\"\\x0b\" and file_to_inject is not None:  # ctrl-k, inject script\n                console_out_write(bytes(\"Injecting %s\\r\\n\" % file_to_inject, \"utf8\"))\n                state.transport.enter_raw_repl(soft_reset=False)\n                with open(file_to_inject, \"rb\") as f:\n                    pyfile = f.read()\n                try:\n                    state.transport.exec_raw_no_follow(pyfile)\n                except TransportError as er:\n                    console_out_write(b\"Error:\\r\\n\")\n                    console_out_write(er)\n                state.transport.exit_raw_repl()\n            else:\n                state.transport.serial.write(c)\n\n        try:\n            n = state.transport.serial.inWaiting()\n        except OSError as er:\n            if er.args[0] == 5:  # IO error, device disappeared\n                print(\"device disconnected\")\n                break\n\n        if n > 0:\n            dev_data_in = state.transport.serial.read(n)\n            if dev_data_in is not None:\n                if escape_non_printable:\n                    # Pass data through to the console, with escaping of non-printables.\n                    console_data_out = bytearray()\n                    for c in dev_data_in:\n                        if c in (8, 9, 10, 13, 27) or 32 <= c <= 126:\n                            console_data_out.append(c)\n                        else:\n                            console_data_out.extend(b\"[%02x]\" % c)\n                else:\n                    console_data_out = dev_data_in\n                console_out_write(console_data_out)\n\n\ndef do_repl(state, args):\n    state.ensure_friendly_repl()\n    state.did_action()\n\n    escape_non_printable = args.escape_non_printable\n    capture_file = args.capture\n    code_to_inject = args.inject_code\n    file_to_inject = args.inject_file\n\n    print(\"Connected to MicroPython at %s\" % state.transport.device_name)\n    print(\"Use Ctrl-] or Ctrl-x to exit this shell\")\n    if escape_non_printable:\n        print(\"Escaping non-printable bytes/characters by printing their hex code\")\n    if capture_file is not None:\n        print('Capturing session to file \"%s\"' % capture_file)\n        capture_file = open(capture_file, \"wb\")\n    if code_to_inject is not None:\n        code_to_inject = bytes(code_to_inject.replace(\"\\\\n\", \"\\r\\n\"), \"utf8\")\n        print(\"Use Ctrl-J to inject\", code_to_inject)\n    if file_to_inject is not None:\n        print('Use Ctrl-K to inject file \"%s\"' % file_to_inject)\n\n    console = Console()\n    console.enter()\n\n    def console_out_write(b):\n        console.write(b)\n        if capture_file is not None:\n            capture_file.write(b)\n            capture_file.flush()\n\n    try:\n        do_repl_main_loop(\n            state,\n            console,\n            console_out_write,\n            escape_non_printable=escape_non_printable,\n            code_to_inject=code_to_inject,\n            file_to_inject=file_to_inject,\n        )\n    finally:\n        console.exit()\n        if capture_file is not None:\n            capture_file.close()\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}