{
  "module_name": "tinytest-codegen.py",
  "hash_id": "4a515e8466c3683174ea85e42179c3f9af3b794a9616891fe52f2f45936642b4",
  "original_prompt": "Ingested from sys_09_Anvil/source/tools/tinytest-codegen.py",
  "human_readable_source": "#!/usr/bin/env python3\n\nimport os, sys\nfrom glob import glob\nfrom re import sub\nimport argparse\n\n\ndef escape(s):\n    s = s.decode()\n    lookup = {\n        \"\\0\": \"\\\\0\",\n        \"\\t\": \"\\\\t\",\n        \"\\n\": '\\\\n\"\\n\"',\n        \"\\r\": \"\\\\r\",\n        \"\\\\\": \"\\\\\\\\\",\n        '\"': '\\\\\"',\n    }\n    return '\"\"\\n\"{}\"'.format(\"\".join([lookup[x] if x in lookup else x for x in s]))\n\n\ndef chew_filename(t):\n    return {\"func\": \"test_{}_fn\".format(sub(r\"/|\\.|-\", \"_\", t)), \"desc\": t}\n\n\ndef script_to_map(test_file):\n    r = {\"name\": chew_filename(test_file)[\"func\"]}\n    with open(test_file, \"rb\") as f:\n        r[\"script\"] = escape(f.read())\n    with open(test_file + \".exp\", \"rb\") as f:\n        r[\"output\"] = escape(f.read())\n    return r\n\n\ndef load_profile(profile_file, test_dirs, exclude_tests):\n    profile_globals = {\"test_dirs\": test_dirs, \"exclude_tests\": exclude_tests}\n    exec(profile_file.read(), profile_globals)\n    return profile_globals[\"test_dirs\"], profile_globals[\"exclude_tests\"]\n\n\ntest_function = (\n    \"void {name}(void* data) {{\\n\"\n    \"  static const char pystr[] = {script};\\n\"\n    \"  static const char exp[] = {output};\\n\"\n    '  printf(\"\\\\n\");\\n'\n    \"  upytest_set_expected_output(exp, sizeof(exp) - 1);\\n\"\n    \"  upytest_execute_test(pystr);\\n\"\n    '  printf(\"result: \");\\n'\n    \"}}\"\n)\n\ntestcase_struct = \"struct testcase_t {name}_tests[] = {{\\n{body}\\n  END_OF_TESTCASES\\n}};\"\ntestcase_member = '  {{ \"{desc}\", {func}, TT_ENABLED_, 0, 0 }},'\n\ntestgroup_struct = \"struct testgroup_t groups[] = {{\\n{body}\\n  END_OF_GROUPS\\n}};\"\ntestgroup_member = '  {{ \"{name}\", {name}_tests }},'\n\n## XXX: may be we could have `--without <groups>` argument...\n\ntest_dirs = set(\n    (\n        \"basics\",\n        \"extmod\",\n        \"float\",\n        \"micropython\",\n        \"misc\",\n    )\n)\n\nexclude_tests = set(\n    (\n        # pattern matching in .exp\n        \"basics/bytes_compare3.py\",\n        \"extmod/ticks_diff.py\",\n        \"extmod/time_ms_us.py\",\n        # unicode char issue\n        \"extmod/json_loads.py\",\n        # doesn't output to python stdout\n        \"extmod/re_debug.py\",\n        \"extmod/vfs_basic.py\",\n        \"extmod/vfs_fat_ramdisk.py\",\n        \"extmod/vfs_fat_fileio.py\",\n        \"extmod/vfs_fat_fsusermount.py\",\n        \"extmod/vfs_fat_oldproto.py\",\n        # rounding issues\n        \"float/float_divmod.py\",\n        # requires double precision floating point to work\n        \"float/float2int_doubleprec_intbig.py\",\n        \"float/float_format_ints_doubleprec.py\",\n        \"float/float_parse_doubleprec.py\",\n        # different filename in output\n        \"micropython/emg_exc.py\",\n        \"micropython/heapalloc_traceback.py\",\n        # don't have emergency exception buffer\n        \"micropython/heapalloc_exc_compressed_emg_exc.py\",\n        # pattern matching in .exp\n        \"micropython/meminfo.py\",\n        # needs sys stdfiles\n        \"misc/print_exception.py\",\n        # settrace .exp files are too large\n        \"misc/sys_settrace_loop.py\",\n        \"misc/sys_settrace_generator.py\",\n        \"misc/sys_settrace_features.py\",\n        # don't have f-string\n        \"basics/string_fstring.py\",\n        \"basics/string_fstring_debug.py\",\n    )\n)\n\noutput = []\ntests = []\n\nargparser = argparse.ArgumentParser(\n    description=\"Convert native MicroPython tests to tinytest/upytesthelper C code\"\n)\nargparser.add_argument(\"--stdin\", action=\"store_true\", help=\"read list of tests from stdin\")\nargparser.add_argument(\"--exclude\", action=\"append\", help=\"exclude test by name\")\nargparser.add_argument(\n    \"--profile\",\n    type=argparse.FileType(\"rt\", encoding=\"utf-8\"),\n    help=\"optional profile file providing test directories and exclusion list\",\n)\nargs = argparser.parse_args()\n\nif not args.stdin:\n    if args.profile:\n        test_dirs, exclude_tests = load_profile(args.profile, test_dirs, exclude_tests)\n    if args.exclude:\n        exclude_tests = exclude_tests.union(args.exclude)\n    for group in test_dirs:\n        tests += [test for test in glob(\"{}/*.py\".format(group)) if test not in exclude_tests]\nelse:\n    for l in sys.stdin:\n        tests.append(l.rstrip())\n\noutput.extend([test_function.format(**script_to_map(test)) for test in tests])\ntestcase_members = [testcase_member.format(**chew_filename(test)) for test in tests]\noutput.append(testcase_struct.format(name=\"\", body=\"\\n\".join(testcase_members)))\n\ntestgroup_members = [testgroup_member.format(name=group) for group in [\"\"]]\n\noutput.append(testgroup_struct.format(body=\"\\n\".join(testgroup_members)))\n\n## XXX: may be we could have `--output <filename>` argument...\n# Don't depend on what system locale is set, use utf8 encoding.\nsys.stdout.buffer.write(\"\\n\\n\".join(output).encode(\"utf8\"))\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}