{
  "module_name": "ci.sh",
  "hash_id": "e2d1d143e835a6fff64dc400e26a0aad4efe19a6401e0d31be84b8fac35819a6",
  "original_prompt": "Ingested from sys_09_Anvil/source/tools/ci.sh",
  "human_readable_source": "#!/bin/bash\n\nif which nproc > /dev/null; then\n    MAKEOPTS=\"-j$(nproc)\"\nelse\n    MAKEOPTS=\"-j$(sysctl -n hw.ncpu)\"\nfi\n\n# Ensure known OPEN_MAX (NO_FILES) limit.\nulimit -n 1024\n\n########################################################################################\n# general helper functions\n\nfunction ci_gcc_arm_setup {\n    sudo apt-get install gcc-arm-none-eabi libnewlib-arm-none-eabi\n    arm-none-eabi-gcc --version\n}\n\n########################################################################################\n# c code formatting\n\nfunction ci_c_code_formatting_setup {\n    sudo apt-get install uncrustify\n    uncrustify --version\n}\n\nfunction ci_c_code_formatting_run {\n    # Only run on C files. The ruff rule runs separately on Python.\n    tools/codeformat.py -v -c\n}\n\n########################################################################################\n# commit formatting\n\nfunction ci_commit_formatting_run {\n    git remote add upstream https://github.com/micropython/micropython.git\n    git fetch --depth=100 upstream master\n    # If the common ancestor commit hasn't been found, fetch more.\n    git merge-base upstream/master HEAD || git fetch --unshallow upstream master\n    # For a PR, upstream/master..HEAD ends with a merge commit into master, exclude that one.\n    tools/verifygitlog.py -v upstream/master..HEAD --no-merges\n}\n\n########################################################################################\n# code size\n\nfunction ci_code_size_setup {\n    sudo apt-get update\n    sudo apt-get install gcc-multilib\n    gcc --version\n    ci_gcc_arm_setup\n}\n\nfunction ci_code_size_build {\n    # check the following ports for the change in their code size\n    PORTS_TO_CHECK=bmusxpd\n    SUBMODULES=\"lib/asf4 lib/berkeley-db-1.xx lib/mbedtls lib/micropython-lib lib/nxp_driver lib/pico-sdk lib/stm32lib lib/tinyusb\"\n\n    # starts off at either the ref/pull/N/merge FETCH_HEAD, or the current branch HEAD\n    git checkout -b pull_request # save the current location\n    git remote add upstream https://github.com/micropython/micropython.git\n    git fetch --depth=100 upstream master\n    # If the common ancestor commit hasn't been found, fetch more.\n    git merge-base upstream/master HEAD || git fetch --unshallow upstream master\n    # build reference, save to size0\n    # ignore any errors with this build, in case master is failing\n    git checkout `git merge-base --fork-point upstream/master pull_request`\n    git submodule update --init $SUBMODULES\n    git show -s\n    tools/metrics.py clean $PORTS_TO_CHECK\n    tools/metrics.py build $PORTS_TO_CHECK | tee ~/size0 || true\n    # build PR/branch, save to size1\n    git checkout pull_request\n    git submodule update --init $SUBMODULES\n    git log upstream/master..HEAD\n    tools/metrics.py clean $PORTS_TO_CHECK\n    tools/metrics.py build $PORTS_TO_CHECK | tee ~/size1\n}\n\n########################################################################################\n# .mpy file format\n\nfunction ci_mpy_format_setup {\n    sudo pip3 install pyelftools\n}\n\nfunction ci_mpy_format_test {\n    # Test mpy-tool.py dump feature on bytecode\n    python2 ./tools/mpy-tool.py -xd tests/frozen/frozentest.mpy\n    python3 ./tools/mpy-tool.py -xd tests/frozen/frozentest.mpy\n\n    # Test mpy-tool.py dump feature on native code\n    make -C examples/natmod/features1\n    ./tools/mpy-tool.py -xd examples/natmod/features1/features1.mpy\n}\n\n########################################################################################\n# ports/cc3200\n\nfunction ci_cc3200_setup {\n    ci_gcc_arm_setup\n}\n\nfunction ci_cc3200_build {\n    make ${MAKEOPTS} -C ports/cc3200 BTARGET=application BTYPE=release\n    make ${MAKEOPTS} -C ports/cc3200 BTARGET=bootloader  BTYPE=release\n}\n\n########################################################################################\n# ports/esp32\n\n# GitHub tag of ESP-IDF to use for CI (note: must be a tag or a branch)\nIDF_VER=v5.0.4\n\nexport IDF_CCACHE_ENABLE=1\n\nfunction ci_esp32_idf_setup {\n    pip3 install pyelftools\n    git clone --depth 1 --branch $IDF_VER https://github.com/espressif/esp-idf.git\n    # doing a treeless clone isn't quite as good as --shallow-submodules, but it\n    # is smaller than full clones and works when the submodule commit isn't a head.\n    git -C esp-idf submodule update --init --recursive --filter=tree:0\n    ./esp-idf/install.sh\n}\n\nfunction ci_esp32_build_common {\n    source esp-idf/export.sh\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/esp32 submodules\n}\n\nfunction ci_esp32_build_cmod_spiram_s2 {\n    ci_esp32_build_common\n\n    make ${MAKEOPTS} -C ports/esp32 \\\n        USER_C_MODULES=../../../examples/usercmodule/micropython.cmake \\\n        FROZEN_MANIFEST=$(pwd)/ports/esp32/boards/manifest_test.py\n\n    # Test building native .mpy with xtensawin architecture.\n    ci_native_mpy_modules_build xtensawin\n\n    make ${MAKEOPTS} -C ports/esp32 BOARD=ESP32_GENERIC BOARD_VARIANT=SPIRAM\n    make ${MAKEOPTS} -C ports/esp32 BOARD=ESP32_GENERIC_S2\n}\n\nfunction ci_esp32_build_s3_c3 {\n    ci_esp32_build_common\n\n    make ${MAKEOPTS} -C ports/esp32 BOARD=ESP32_GENERIC_S3\n    make ${MAKEOPTS} -C ports/esp32 BOARD=ESP32_GENERIC_C3\n}\n\n########################################################################################\n# ports/esp8266\n\nfunction ci_esp8266_setup {\n    sudo pip install pyserial esptool==3.3.1\n    wget https://github.com/jepler/esp-open-sdk/releases/download/2018-06-10/xtensa-lx106-elf-standalone.tar.gz\n    zcat xtensa-lx106-elf-standalone.tar.gz | tar x\n    # Remove this esptool.py so pip version is used instead\n    rm xtensa-lx106-elf/bin/esptool.py\n}\n\nfunction ci_esp8266_path {\n    echo $(pwd)/xtensa-lx106-elf/bin\n}\n\nfunction ci_esp8266_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/esp8266 submodules\n    make ${MAKEOPTS} -C ports/esp8266 BOARD=ESP8266_GENERIC\n    make ${MAKEOPTS} -C ports/esp8266 BOARD=ESP8266_GENERIC BOARD_VARIANT=FLASH_512K\n    make ${MAKEOPTS} -C ports/esp8266 BOARD=ESP8266_GENERIC BOARD_VARIANT=FLASH_1M\n}\n\n########################################################################################\n# ports/webassembly\n\nfunction ci_webassembly_setup {\n    npm install terser\n    git clone https://github.com/emscripten-core/emsdk.git\n    (cd emsdk && ./emsdk install latest && ./emsdk activate latest)\n}\n\nfunction ci_webassembly_build {\n    source emsdk/emsdk_env.sh\n    make ${MAKEOPTS} -C ports/webassembly VARIANT=pyscript submodules\n    make ${MAKEOPTS} -C ports/webassembly VARIANT=pyscript\n}\n\nfunction ci_webassembly_run_tests {\n    make -C ports/webassembly VARIANT=pyscript test_min\n}\n\n########################################################################################\n# ports/mimxrt\n\nfunction ci_mimxrt_setup {\n    ci_gcc_arm_setup\n}\n\nfunction ci_mimxrt_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/mimxrt BOARD=MIMXRT1020_EVK submodules\n    make ${MAKEOPTS} -C ports/mimxrt BOARD=MIMXRT1020_EVK\n    make ${MAKEOPTS} -C ports/mimxrt BOARD=TEENSY40 submodules\n    make ${MAKEOPTS} -C ports/mimxrt BOARD=TEENSY40\n}\n\n########################################################################################\n# ports/nrf\n\nfunction ci_nrf_setup {\n    ci_gcc_arm_setup\n}\n\nfunction ci_nrf_build {\n    ports/nrf/drivers/bluetooth/download_ble_stack.sh s140_nrf52_6_1_1\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/nrf submodules\n    make ${MAKEOPTS} -C ports/nrf BOARD=PCA10040\n    make ${MAKEOPTS} -C ports/nrf BOARD=MICROBIT\n    make ${MAKEOPTS} -C ports/nrf BOARD=PCA10056 SD=s140\n    make ${MAKEOPTS} -C ports/nrf BOARD=PCA10090\n}\n\n########################################################################################\n# ports/powerpc\n\nfunction ci_powerpc_setup {\n    sudo apt-get update\n    sudo apt-get install gcc-powerpc64le-linux-gnu libc6-dev-ppc64el-cross\n}\n\nfunction ci_powerpc_build {\n    make ${MAKEOPTS} -C ports/powerpc UART=potato\n    make ${MAKEOPTS} -C ports/powerpc UART=lpc_serial\n}\n\n########################################################################################\n# ports/qemu-arm\n\nfunction ci_qemu_arm_setup {\n    ci_gcc_arm_setup\n    sudo apt-get update\n    sudo apt-get install qemu-system\n    qemu-system-arm --version\n}\n\nfunction ci_qemu_arm_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/qemu-arm submodules\n    make ${MAKEOPTS} -C ports/qemu-arm CFLAGS_EXTRA=-DMP_ENDIANNESS_BIG=1\n    make ${MAKEOPTS} -C ports/qemu-arm clean\n    make ${MAKEOPTS} -C ports/qemu-arm -f Makefile.test submodules\n    make ${MAKEOPTS} -C ports/qemu-arm -f Makefile.test test\n    make ${MAKEOPTS} -C ports/qemu-arm -f Makefile.test clean\n    make ${MAKEOPTS} -C ports/qemu-arm -f Makefile.test BOARD=sabrelite test\n}\n\n########################################################################################\n# ports/renesas-ra\n\nfunction ci_renesas_ra_setup {\n    ci_gcc_arm_setup\n    sudo apt-get install protobuf-c-compiler\n}\n\nfunction ci_renesas_ra_board_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/renesas-ra submodules\n    make ${MAKEOPTS} -C ports/renesas-ra BOARD=RA4M1_CLICKER\n    make ${MAKEOPTS} -C ports/renesas-ra BOARD=EK_RA6M2\n    make ${MAKEOPTS} -C ports/renesas-ra BOARD=EK_RA6M1\n    make ${MAKEOPTS} -C ports/renesas-ra BOARD=EK_RA4M1\n    make ${MAKEOPTS} -C ports/renesas-ra BOARD=EK_RA4W1\n    make ${MAKEOPTS} -C ports/renesas-ra BOARD=ARDUINO_PORTENTA_C33 submodules\n    make ${MAKEOPTS} -C ports/renesas-ra BOARD=ARDUINO_PORTENTA_C33\n}\n\n########################################################################################\n# ports/rp2\n\nfunction ci_rp2_setup {\n    ci_gcc_arm_setup\n}\n\nfunction ci_rp2_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/rp2 submodules\n    make ${MAKEOPTS} -C ports/rp2\n    make ${MAKEOPTS} -C ports/rp2 BOARD=RPI_PICO_W submodules\n    make ${MAKEOPTS} -C ports/rp2 BOARD=RPI_PICO_W USER_C_MODULES=../../examples/usercmodule/micropython.cmake\n    make ${MAKEOPTS} -C ports/rp2 BOARD=W5100S_EVB_PICO submodules\n    make ${MAKEOPTS} -C ports/rp2 BOARD=W5100S_EVB_PICO\n\n    # Test building ninaw10 driver and NIC interface.\n    make ${MAKEOPTS} -C ports/rp2 BOARD=ARDUINO_NANO_RP2040_CONNECT submodules\n    make ${MAKEOPTS} -C ports/rp2 BOARD=ARDUINO_NANO_RP2040_CONNECT\n}\n\n########################################################################################\n# ports/samd\n\nfunction ci_samd_setup {\n    ci_gcc_arm_setup\n}\n\nfunction ci_samd_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/samd submodules\n    make ${MAKEOPTS} -C ports/samd BOARD=ADAFRUIT_ITSYBITSY_M0_EXPRESS\n    make ${MAKEOPTS} -C ports/samd BOARD=ADAFRUIT_ITSYBITSY_M4_EXPRESS\n}\n\n########################################################################################\n# ports/stm32\n\nfunction ci_stm32_setup {\n    ci_gcc_arm_setup\n    pip3 install pyelftools\n    pip3 install pyhy\n}\n\nfunction ci_stm32_pyb_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/stm32 MICROPY_PY_NETWORK_WIZNET5K=5200 submodules\n    make ${MAKEOPTS} -C ports/stm32 BOARD=PYBD_SF2 submodules\n    git submodule update --init lib/btstack\n    git submodule update --init lib/mynewt-nimble\n    make ${MAKEOPTS} -C ports/stm32 BOARD=PYBV11 MICROPY_PY_NETWORK_WIZNET5K=5200 USER_C_MODULES=../../examples/usercmodule\n    make ${MAKEOPTS} -C ports/stm32 BOARD=PYBD_SF2\n    make ${MAKEOPTS} -C ports/stm32 BOARD=PYBD_SF6 NANBOX=1 MICROPY_BLUETOOTH_NIMBLE=0 MICROPY_BLUETOOTH_BTSTACK=1\n    make ${MAKEOPTS} -C ports/stm32/mboot BOARD=PYBV10 CFLAGS_EXTRA='-DMBOOT_FSLOAD=1 -DMBOOT_VFS_LFS2=1'\n    make ${MAKEOPTS} -C ports/stm32/mboot BOARD=PYBD_SF6\n    make ${MAKEOPTS} -C ports/stm32/mboot BOARD=STM32F769DISC CFLAGS_EXTRA='-DMBOOT_ADDRESS_SPACE_64BIT=1 -DMBOOT_SDCARD_ADDR=0x100000000ULL -DMBOOT_SDCARD_BYTE_SIZE=0x400000000ULL -DMBOOT_FSLOAD=1 -DMBOOT_VFS_FAT=1'\n\n    # Test building native .mpy with armv7emsp architecture.\n    git submodule update --init lib/berkeley-db-1.xx\n    ci_native_mpy_modules_build armv7emsp\n}\n\nfunction ci_stm32_nucleo_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/stm32 BOARD=NUCLEO_H743ZI submodules\n    git submodule update --init lib/mynewt-nimble\n\n    # Test building various MCU families, some with additional options.\n    make ${MAKEOPTS} -C ports/stm32 BOARD=NUCLEO_F091RC\n    make ${MAKEOPTS} -C ports/stm32 BOARD=STM32H573I_DK\n    make ${MAKEOPTS} -C ports/stm32 BOARD=NUCLEO_H743ZI COPT=-O2 CFLAGS_EXTRA='-DMICROPY_PY_THREAD=1'\n    make ${MAKEOPTS} -C ports/stm32 BOARD=NUCLEO_L073RZ\n    make ${MAKEOPTS} -C ports/stm32 BOARD=NUCLEO_L476RG DEBUG=1\n\n    # Test building a board with mboot packing enabled (encryption, signing, compression).\n    make ${MAKEOPTS} -C ports/stm32 BOARD=NUCLEO_WB55 USE_MBOOT=1 MBOOT_ENABLE_PACKING=1\n    make ${MAKEOPTS} -C ports/stm32/mboot BOARD=NUCLEO_WB55 USE_MBOOT=1 MBOOT_ENABLE_PACKING=1\n    # Test mboot_pack_dfu.py created a valid file, and that its unpack-dfu command works.\n    BOARD_WB55=ports/stm32/boards/NUCLEO_WB55\n    BUILD_WB55=ports/stm32/build-NUCLEO_WB55\n    python3 ports/stm32/mboot/mboot_pack_dfu.py -k $BOARD_WB55/mboot_keys.h unpack-dfu $BUILD_WB55/firmware.pack.dfu $BUILD_WB55/firmware.unpack.dfu\n    diff $BUILD_WB55/firmware.unpack.dfu $BUILD_WB55/firmware.dfu\n    # Test unpack-dfu command works without a secret key\n    tail -n +2 $BOARD_WB55/mboot_keys.h > $BOARD_WB55/mboot_keys_no_sk.h\n    python3 ports/stm32/mboot/mboot_pack_dfu.py -k $BOARD_WB55/mboot_keys_no_sk.h unpack-dfu $BUILD_WB55/firmware.pack.dfu $BUILD_WB55/firmware.unpack_no_sk.dfu\n    diff $BUILD_WB55/firmware.unpack.dfu $BUILD_WB55/firmware.unpack_no_sk.dfu\n}\n\nfunction ci_stm32_misc_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/stm32 BOARD=ARDUINO_GIGA submodules\n    make ${MAKEOPTS} -C ports/stm32 BOARD=ARDUINO_GIGA\n}\n\n########################################################################################\n# ports/unix\n\nCI_UNIX_OPTS_SYS_SETTRACE=(\n    MICROPY_PY_BTREE=0\n    MICROPY_PY_FFI=0\n    MICROPY_PY_SSL=0\n    CFLAGS_EXTRA=\"-DMICROPY_PY_SYS_SETTRACE=1\"\n)\n\nCI_UNIX_OPTS_SYS_SETTRACE_STACKLESS=(\n    MICROPY_PY_BTREE=0\n    MICROPY_PY_FFI=0\n    MICROPY_PY_SSL=0\n    CFLAGS_EXTRA=\"-DMICROPY_STACKLESS=1 -DMICROPY_STACKLESS_STRICT=1 -DMICROPY_PY_SYS_SETTRACE=1\"\n)\n\nCI_UNIX_OPTS_QEMU_MIPS=(\n    CROSS_COMPILE=mips-linux-gnu-\n    VARIANT=coverage\n    MICROPY_STANDALONE=1\n    LDFLAGS_EXTRA=\"-static\"\n)\n\nCI_UNIX_OPTS_QEMU_ARM=(\n    CROSS_COMPILE=arm-linux-gnueabi-\n    VARIANT=coverage\n    MICROPY_STANDALONE=1\n)\n\nfunction ci_unix_build_helper {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/unix \"$@\" submodules\n    make ${MAKEOPTS} -C ports/unix \"$@\" deplibs\n    make ${MAKEOPTS} -C ports/unix \"$@\"\n}\n\nfunction ci_unix_build_ffi_lib_helper {\n    $1 $2 -shared -o tests/ports/unix/ffi_lib.so tests/ports/unix/ffi_lib.c\n}\n\nfunction ci_unix_run_tests_helper {\n    make -C ports/unix \"$@\" test\n}\n\nfunction ci_unix_run_tests_full_helper {\n    variant=$1\n    shift\n    micropython=../ports/unix/build-$variant/micropython\n    make -C ports/unix VARIANT=$variant \"$@\" test_full\n    (cd tests && MICROPY_CPYTHON3=python3 MICROPY_MICROPYTHON=$micropython ./run-multitests.py multi_net/*.py)\n    (cd tests && MICROPY_CPYTHON3=python3 MICROPY_MICROPYTHON=$micropython ./run-perfbench.py 1000 1000)\n}\n\nfunction ci_native_mpy_modules_build {\n    if [ \"$1\" = \"\" ]; then\n        arch=x64\n    else\n        arch=$1\n    fi\n    make -C examples/natmod/features1 ARCH=$arch\n    make -C examples/natmod/features2 ARCH=$arch\n    make -C examples/natmod/features3 ARCH=$arch\n    make -C examples/natmod/features4 ARCH=$arch\n    make -C examples/natmod/btree ARCH=$arch\n    make -C examples/natmod/deflate ARCH=$arch\n    make -C examples/natmod/framebuf ARCH=$arch\n    make -C examples/natmod/heapq ARCH=$arch\n    make -C examples/natmod/random ARCH=$arch\n    make -C examples/natmod/re ARCH=$arch\n}\n\nfunction ci_native_mpy_modules_32bit_build {\n    ci_native_mpy_modules_build x86\n}\n\nfunction ci_unix_minimal_build {\n    make ${MAKEOPTS} -C ports/unix VARIANT=minimal\n}\n\nfunction ci_unix_minimal_run_tests {\n    (cd tests && MICROPY_CPYTHON3=python3 MICROPY_MICROPYTHON=../ports/unix/build-minimal/micropython ./run-tests.py -e exception_chain -e self_type_check -e subclass_native_init -d basics)\n}\n\nfunction ci_unix_standard_build {\n    ci_unix_build_helper VARIANT=standard\n    ci_unix_build_ffi_lib_helper gcc\n}\n\nfunction ci_unix_standard_run_tests {\n    ci_unix_run_tests_full_helper standard\n}\n\nfunction ci_unix_standard_v2_build {\n    ci_unix_build_helper VARIANT=standard MICROPY_PREVIEW_VERSION_2=1\n    ci_unix_build_ffi_lib_helper gcc\n}\n\nfunction ci_unix_standard_v2_run_tests {\n    ci_unix_run_tests_full_helper standard\n}\n\nfunction ci_unix_coverage_setup {\n    sudo pip3 install setuptools\n    sudo pip3 install pyelftools\n    gcc --version\n    python3 --version\n}\n\nfunction ci_unix_coverage_build {\n    ci_unix_build_helper VARIANT=coverage\n    ci_unix_build_ffi_lib_helper gcc\n}\n\nfunction ci_unix_coverage_run_tests {\n    ci_unix_run_tests_full_helper coverage\n}\n\nfunction ci_unix_coverage_run_mpy_merge_tests {\n    mptop=$(pwd)\n    outdir=$(mktemp -d)\n    allmpy=()\n\n    # Compile a selection of tests to .mpy and execute them, collecting the output.\n    # None of the tests should SKIP.\n    for inpy in $mptop/tests/basics/[acdel]*.py; do\n        test=$(basename $inpy .py)\n        echo $test\n        outmpy=$outdir/$test.mpy\n        $mptop/mpy-cross/build/mpy-cross -o $outmpy $inpy\n        (cd $outdir && $mptop/ports/unix/build-coverage/micropython -m $test >> out-individual)\n        allmpy+=($outmpy)\n    done\n\n    # Merge all the tests into one .mpy file, and then execute it.\n    python3 $mptop/tools/mpy-tool.py --merge -o $outdir/merged.mpy ${allmpy[@]}\n    (cd $outdir && $mptop/ports/unix/build-coverage/micropython -m merged > out-merged)\n\n    # Make sure the outputs match.\n    diff $outdir/out-individual $outdir/out-merged && /bin/rm -rf $outdir\n}\n\nfunction ci_unix_coverage_run_native_mpy_tests {\n    MICROPYPATH=examples/natmod/features2 ./ports/unix/build-coverage/micropython -m features2\n    (cd tests && ./run-natmodtests.py \"$@\" extmod/*.py)\n}\n\nfunction ci_unix_32bit_setup {\n    sudo dpkg --add-architecture i386\n    sudo apt-get update\n    sudo apt-get install gcc-multilib g++-multilib libffi-dev:i386\n    sudo pip3 install setuptools\n    sudo pip3 install pyelftools\n    gcc --version\n    python3 --version\n}\n\nfunction ci_unix_coverage_32bit_build {\n    ci_unix_build_helper VARIANT=coverage MICROPY_FORCE_32BIT=1\n    ci_unix_build_ffi_lib_helper gcc -m32\n}\n\nfunction ci_unix_coverage_32bit_run_tests {\n    ci_unix_run_tests_full_helper coverage MICROPY_FORCE_32BIT=1\n}\n\nfunction ci_unix_coverage_32bit_run_native_mpy_tests {\n    ci_unix_coverage_run_native_mpy_tests --arch x86\n}\n\nfunction ci_unix_nanbox_build {\n    # Use Python 2 to check that it can run the build scripts\n    ci_unix_build_helper PYTHON=python2 VARIANT=nanbox CFLAGS_EXTRA=\"-DMICROPY_PY_MATH_CONSTANTS=1\"\n    ci_unix_build_ffi_lib_helper gcc -m32\n}\n\nfunction ci_unix_nanbox_run_tests {\n    ci_unix_run_tests_full_helper nanbox PYTHON=python2\n}\n\nfunction ci_unix_float_build {\n    ci_unix_build_helper VARIANT=standard CFLAGS_EXTRA=\"-DMICROPY_FLOAT_IMPL=MICROPY_FLOAT_IMPL_FLOAT\"\n    ci_unix_build_ffi_lib_helper gcc\n}\n\nfunction ci_unix_float_run_tests {\n    # TODO get this working: ci_unix_run_tests_full_helper standard CFLAGS_EXTRA=\"-DMICROPY_FLOAT_IMPL=MICROPY_FLOAT_IMPL_FLOAT\"\n    ci_unix_run_tests_helper CFLAGS_EXTRA=\"-DMICROPY_FLOAT_IMPL=MICROPY_FLOAT_IMPL_FLOAT\"\n}\n\nfunction ci_unix_clang_setup {\n    sudo apt-get install clang\n    clang --version\n}\n\nfunction ci_unix_stackless_clang_build {\n    make ${MAKEOPTS} -C mpy-cross CC=clang\n    make ${MAKEOPTS} -C ports/unix submodules\n    make ${MAKEOPTS} -C ports/unix CC=clang CFLAGS_EXTRA=\"-DMICROPY_STACKLESS=1 -DMICROPY_STACKLESS_STRICT=1\"\n}\n\nfunction ci_unix_stackless_clang_run_tests {\n    ci_unix_run_tests_helper CC=clang\n}\n\nfunction ci_unix_float_clang_build {\n    make ${MAKEOPTS} -C mpy-cross CC=clang\n    make ${MAKEOPTS} -C ports/unix submodules\n    make ${MAKEOPTS} -C ports/unix CC=clang CFLAGS_EXTRA=\"-DMICROPY_FLOAT_IMPL=MICROPY_FLOAT_IMPL_FLOAT\"\n}\n\nfunction ci_unix_float_clang_run_tests {\n    ci_unix_run_tests_helper CC=clang\n}\n\nfunction ci_unix_settrace_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/unix submodules\n    make ${MAKEOPTS} -C ports/unix \"${CI_UNIX_OPTS_SYS_SETTRACE[@]}\"\n}\n\nfunction ci_unix_settrace_run_tests {\n    ci_unix_run_tests_full_helper standard \"${CI_UNIX_OPTS_SYS_SETTRACE[@]}\"\n}\n\nfunction ci_unix_settrace_stackless_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/unix submodules\n    make ${MAKEOPTS} -C ports/unix \"${CI_UNIX_OPTS_SYS_SETTRACE_STACKLESS[@]}\"\n}\n\nfunction ci_unix_settrace_stackless_run_tests {\n    ci_unix_run_tests_full_helper standard \"${CI_UNIX_OPTS_SYS_SETTRACE_STACKLESS[@]}\"\n}\n\nfunction ci_unix_macos_build {\n    # Install pkg-config to configure libffi paths.\n    brew install pkg-config\n\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/unix submodules\n    #make ${MAKEOPTS} -C ports/unix deplibs\n    make ${MAKEOPTS} -C ports/unix\n    # check for additional compiler errors/warnings\n    make ${MAKEOPTS} -C ports/unix VARIANT=coverage submodules\n    make ${MAKEOPTS} -C ports/unix VARIANT=coverage\n}\n\nfunction ci_unix_macos_run_tests {\n    # Issues with macOS tests:\n    # - import_pkg7 has a problem with relative imports\n    # - random_basic has a problem with getrandbits(0)\n    (cd tests && MICROPY_MICROPYTHON=../ports/unix/build-standard/micropython ./run-tests.py --exclude 'import_pkg7.py' --exclude 'random_basic.py')\n}\n\nfunction ci_unix_qemu_mips_setup {\n    sudo apt-get update\n    sudo apt-get install gcc-mips-linux-gnu g++-mips-linux-gnu\n    sudo apt-get install qemu-user\n    qemu-mips --version\n}\n\nfunction ci_unix_qemu_mips_build {\n    # qemu-mips on GitHub Actions will seg-fault if not linked statically\n    ci_unix_build_helper \"${CI_UNIX_OPTS_QEMU_MIPS[@]}\"\n}\n\nfunction ci_unix_qemu_mips_run_tests {\n    # Issues with MIPS tests:\n    # - (i)listdir does not work, it always returns the empty list (it's an issue with the underlying C call)\n    # - ffi tests do not work\n    file ./ports/unix/build-coverage/micropython\n    (cd tests && MICROPY_MICROPYTHON=../ports/unix/build-coverage/micropython ./run-tests.py --exclude 'vfs_posix.*\\.py' --exclude 'ffi_(callback|float|float2).py')\n}\n\nfunction ci_unix_qemu_arm_setup {\n    sudo apt-get update\n    sudo apt-get install gcc-arm-linux-gnueabi g++-arm-linux-gnueabi\n    sudo apt-get install qemu-user\n    qemu-arm --version\n}\n\nfunction ci_unix_qemu_arm_build {\n    ci_unix_build_helper \"${CI_UNIX_OPTS_QEMU_ARM[@]}\"\n    ci_unix_build_ffi_lib_helper arm-linux-gnueabi-gcc\n}\n\nfunction ci_unix_qemu_arm_run_tests {\n    # Issues with ARM tests:\n    # - (i)listdir does not work, it always returns the empty list (it's an issue with the underlying C call)\n    export QEMU_LD_PREFIX=/usr/arm-linux-gnueabi\n    file ./ports/unix/build-coverage/micropython\n    (cd tests && MICROPY_MICROPYTHON=../ports/unix/build-coverage/micropython ./run-tests.py --exclude 'vfs_posix.*\\.py')\n}\n\n########################################################################################\n# ports/windows\n\nfunction ci_windows_setup {\n    sudo apt-get install gcc-mingw-w64\n}\n\nfunction ci_windows_build {\n    make ${MAKEOPTS} -C mpy-cross\n    make ${MAKEOPTS} -C ports/windows submodules\n    make ${MAKEOPTS} -C ports/windows CROSS_COMPILE=i686-w64-mingw32-\n}\n\n########################################################################################\n# ports/zephyr\n\nZEPHYR_DOCKER_VERSION=v0.21.0\nZEPHYR_SDK_VERSION=0.13.2\nZEPHYR_VERSION=v3.1.0\n\nfunction ci_zephyr_setup {\n    docker pull zephyrprojectrtos/ci:${ZEPHYR_DOCKER_VERSION}\n    docker run --name zephyr-ci -d -it \\\n      -v \"$(pwd)\":/micropython \\\n      -e ZEPHYR_SDK_INSTALL_DIR=/opt/toolchains/zephyr-sdk-${ZEPHYR_SDK_VERSION} \\\n      -e ZEPHYR_TOOLCHAIN_VARIANT=zephyr \\\n      -e ZEPHYR_BASE=/zephyrproject/zephyr \\\n      -w /micropython/ports/zephyr \\\n      zephyrprojectrtos/ci:${ZEPHYR_DOCKER_VERSION}\n    docker ps -a\n}\n\nfunction ci_zephyr_install {\n    docker exec zephyr-ci west init --mr ${ZEPHYR_VERSION} /zephyrproject\n    docker exec -w /zephyrproject zephyr-ci west update\n    docker exec -w /zephyrproject zephyr-ci west zephyr-export\n}\n\nfunction ci_zephyr_build {\n    docker exec zephyr-ci west build -p auto -b qemu_x86 -- -DCONF_FILE=prj_minimal.conf\n    docker exec zephyr-ci west build -p auto -b frdm_k64f\n    docker exec zephyr-ci west build -p auto -b mimxrt1050_evk\n    docker exec zephyr-ci west build -p auto -b nucleo_wb55rg # for bluetooth\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}