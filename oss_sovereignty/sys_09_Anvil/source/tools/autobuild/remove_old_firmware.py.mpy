{
  "module_name": "remove_old_firmware.py",
  "hash_id": "d109bb94b757873b33ff33294e044c7f4ba8c5b48c25469ee63e74c9e6bc0943",
  "original_prompt": "Ingested from sys_09_Anvil/source/tools/autobuild/remove_old_firmware.py",
  "human_readable_source": "#!/usr/bin/env python3\n\nimport re, subprocess, sys\n\n\nDEBUG = False\nDRY_RUN = False\nNUM_KEEP_PER_BOARD = 4\n\n\ndef main():\n    ssh_machine = sys.argv[1]\n    ssh_firmware_dir = sys.argv[2]\n\n    # SSH to get list of existing files.\n    p = subprocess.run(\n        [\"ssh\", ssh_machine, \"find\", ssh_firmware_dir, \"-name\", \"\\\\*-preview.\\\\*\"],\n        capture_output=True,\n    )\n    if p.returncode != 0:\n        print(p.stderr)\n        return\n    all_files = p.stdout.split(b\"\\n\")\n\n    # Parse all files to organise into boards/date/version.\n    boards = {}\n    for file in all_files:\n        m = re.match(\n            rb\"([a-z/.]+)/([A-Za-z0-9_-]+)-(20[0-9]{6})-(v[0-9.]+)-preview.([0-9]+).g[0-9a-f]+.\",\n            file,\n        )\n        if not m:\n            continue\n        dir, board, date, version, ncommits = m.groups()\n        if board not in boards:\n            boards[board] = {}\n        if (date, version, ncommits) not in boards[board]:\n            boards[board][(date, version, ncommits)] = []\n        boards[board][(date, version, ncommits)].append(file)\n\n    # Collect files to remove based on date and version.\n    remove = []\n    for board in boards.values():\n        filelist = [\n            (date, version, ncommits, files) for (date, version, ncommits), files in board.items()\n        ]\n        filelist.sort(reverse=True)\n        keep = []\n        for date, version, ncommits, files in filelist:\n            if keep and (version, ncommits) == keep[-1]:\n                remove.extend(files)\n            elif len(keep) >= NUM_KEEP_PER_BOARD:\n                remove.extend(files)\n            else:\n                keep.append((version, ncommits))\n\n    if DEBUG:\n        all_files.sort(reverse=True)\n        for file in all_files:\n            print(file, file in remove)\n        print(len(remove), \"/\", len(all_files))\n\n    # Do removal of files.\n    for file in remove:\n        file = str(file, \"ascii\")\n        print(\"remove:\", file)\n        if not DRY_RUN:\n            p = subprocess.run([\"ssh\", ssh_machine, \"/bin/rm\", file], capture_output=True)\n            if p.returncode != 0:\n                print(p.stderr)\n\n\nif __name__ == \"__main__\":\n    main()\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}