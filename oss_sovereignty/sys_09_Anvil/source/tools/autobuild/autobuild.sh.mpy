{
  "module_name": "autobuild.sh",
  "hash_id": "39b94c6821527f1dd2993c565950d184930d451a74808c3876bf7abe70ce828b",
  "original_prompt": "Ingested from sys_09_Anvil/source/tools/autobuild/autobuild.sh",
  "human_readable_source": "#!/bin/bash\n#\n# Build firmware for ports.\n#\n# Requirements:\n# - All toolchains must be in path (arm-none-eabi-gcc, xtensa-lx106-elf)\n# - IDF_PATH_V50 must be set\n# - MICROPY_AUTOBUILD_MICROPYTHON_REPO must be set to location of micropython repository\n# - MICROPY_AUTOBUILD_MAKE must be set to the make command to use, eg \"make -j2\"\n#\n# Optional settings:\n# - MICROPY_AUTOBUILD_REMOTE_MACHINE can be set to a remote ssh machine to copy files to\n# - MICROPY_AUTOBUILD_REMOTE_DIR can be set to destination directory on remote machine\n\nif [ ! -d \"$IDF_PATH_V50\" ]; then\n    echo \"must set IDF_PATH_V50\"\n    exit 1\nfi\n\nif [ ! -d \"$MICROPY_AUTOBUILD_MICROPYTHON_REPO\" ]; then\n    echo \"must set MICROPY_AUTOBUILD_MICROPYTHON_REPO\"\n    exit 1\nfi\n\nif [ -z \"$MICROPY_AUTOBUILD_MAKE\" ]; then\n    echo \"must set MICROPY_AUTOBUILD_MAKE\"\n    exit 1\nfi\n\n########################################\n# Initialisation\n\n# get directory of this script for access to other build scripts\nAUTODIR=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null 2>&1 && pwd )\"\n\n# source additional functions\nsource ${AUTODIR}/build-boards.sh\n\n# make local directory to put firmware\nLOCAL_FIRMWARE=/tmp/autobuild-firmware-$$\nmkdir -p ${LOCAL_FIRMWARE}\n\n# get latest MicroPython\ngit -C ${MICROPY_AUTOBUILD_MICROPYTHON_REPO} pull\ngit -C ${MICROPY_AUTOBUILD_MICROPYTHON_REPO} submodule update --init\ngit -C ${MICROPY_AUTOBUILD_MICROPYTHON_REPO}/lib/pico-sdk submodule update --init\n\n########################################\n# Build all firmware\n\npushd ${MICROPY_AUTOBUILD_MICROPYTHON_REPO}\n\n# build cross compiler\nmake -C mpy-cross\n\n# make the firmware tag\n# final filename will be <BOARD><-VARIANT>-<DATE>-v<SEMVER>.ext\n# where SEMVER is vX.Y.Z or vX.Y.Z-preview.N.gHASH or vX.Y.Z-preview.N.gHASH.dirty\nFW_DATE=$(date '+%Y%m%d')\n# same logic as makeversionhdr.py, convert git-describe output into semver-compatible\nFW_GIT_TAG=\"$(git describe --tags --dirty --always --match 'v[1-9].*')\"\nFW_SEMVER_MAJOR_MINOR_PATCH=\"$(echo $FW_GIT_TAG | cut -d'-' -f1)\"\nFW_SEMVER_PRERELEASE=\"$(echo $FW_GIT_TAG | cut -s -d'-' -f2-)\"\nif [ -z \"$FW_SEMVER_PRERELEASE\" ]; then\n    FW_SEMVER=\"$FW_SEMVER_MAJOR_MINOR_PATCH\"\nelse\n    FW_SEMVER=\"$FW_SEMVER_MAJOR_MINOR_PATCH-$(echo $FW_SEMVER_PRERELEASE | tr - .)\"\nfi\nFW_TAG=\"-$FW_DATE-$FW_SEMVER\"\n\n# build new firmware\ncd ports/cc3200\nbuild_cc3200_boards ${FW_TAG} ${LOCAL_FIRMWARE}\ncd ../esp8266\nbuild_esp8266_boards ${FW_TAG} ${LOCAL_FIRMWARE}\ncd ../esp32\n(source ${IDF_PATH_V50}/export.sh && build_esp32_boards ${FW_TAG} ${LOCAL_FIRMWARE})\ncd ../mimxrt\nbuild_mimxrt_boards ${FW_TAG} ${LOCAL_FIRMWARE}\ncd ../nrf\nbuild_nrf_boards ${FW_TAG} ${LOCAL_FIRMWARE}\ncd ../renesas-ra\nbuild_renesas_ra_boards ${FW_TAG} ${LOCAL_FIRMWARE}\ncd ../rp2\nbuild_rp2_boards ${FW_TAG} ${LOCAL_FIRMWARE}\ncd ../samd\nbuild_samd_boards ${FW_TAG} ${LOCAL_FIRMWARE}\ncd ../stm32\nbuild_stm32_boards ${FW_TAG} ${LOCAL_FIRMWARE}\n\npopd\n\n########################################\n# Copy firmware to remote machine\n\nif [ -z \"$MICROPY_AUTOBUILD_REMOTE_MACHINE\" -o -z \"$MICROPY_AUTOBUILD_REMOTE_DIR\" ]; then\n    echo \"No remote given, leaving firmware in ${LOCAL_FIRMWARE}\"\n    exit 0\nfi\n\n# copy new firmware to remote machine\nscp ${LOCAL_FIRMWARE}/* ${MICROPY_AUTOBUILD_REMOTE_MACHINE}:${MICROPY_AUTOBUILD_REMOTE_DIR}/\n\n# remove old firmware\n${AUTODIR}/remove_old_firmware.py ${MICROPY_AUTOBUILD_REMOTE_MACHINE} ${MICROPY_AUTOBUILD_REMOTE_DIR}\n\n########################################\n# Clean up\n\n/bin/rm -v ${LOCAL_FIRMWARE}/*\n/bin/rmdir ${LOCAL_FIRMWARE}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}