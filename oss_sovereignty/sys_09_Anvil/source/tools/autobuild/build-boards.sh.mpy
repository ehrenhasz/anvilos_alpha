{
  "module_name": "build-boards.sh",
  "hash_id": "0767ca61ca705fc924c8a7cb2f5a2228bdeab55a990c21b37f3556e45604cae3",
  "original_prompt": "Ingested from sys_09_Anvil/source/tools/autobuild/build-boards.sh",
  "human_readable_source": "#!/bin/bash\n#\n# The functions in this file can be run independently to build boards.\n# For example:\n#\n#   $ source tools/autobuild/build-boards.sh\n#   $ cd ports/rp2\n#   $ MICROPY_AUTOBUILD_MAKE=\"make -j8\" build_rp2_boards -latest /tmp\n#\n# Or to build a single board:\n#\n#   $ source tools/autobuild/build-boards.sh\n#   $ cd ports/rp2\n#   $ MICROPY_AUTOBUILD_MAKE=\"make -j8\" build_board boards/PICO/board.json -latest /tmp uf2\n\nfunction copy_artefacts {\n    local dest_dir=$1\n    local descr=$2\n    local fw_tag=$3\n    local build_dir=$4\n    shift 4\n\n    for ext in $@; do\n        dest=$dest_dir/$descr$fw_tag.$ext\n        if [ -r $build_dir/firmware.$ext ]; then\n            mv $build_dir/firmware.$ext $dest\n        elif [ -r $build_dir/micropython.$ext ]; then\n            # esp32 has micropython.elf, etc\n            mv $build_dir/micropython.$ext $dest\n        elif [ $ext = app-bin -a -r $build_dir/micropython.bin ]; then\n            # esp32 has micropython.bin which is just the application\n            mv $build_dir/micropython.bin $dest\n        fi\n    done\n}\n\nfunction build_board {\n    # check/get parameters\n    if [ $# -lt 4 ]; then\n        echo \"usage: $0 <board-json-file> <fw-tag> <dest-dir> <exts...>\"\n        return 1\n    fi\n\n    local board_json=$1\n    local fw_tag=$2\n    local dest_dir=$3\n    shift 3\n\n    local board=$(echo $board_json | awk -F '/' '{ print $2 }')\n    local descr=$(cat $board_json | python3 -c \"import json,sys; print(json.load(sys.stdin).get('id', '$board'))\")\n\n    # Build the \"default\" variant. For most boards this is the only thing we build.\n    echo \"building $descr $board\"\n    local build_dir=/tmp/micropython-build-$board\n    $MICROPY_AUTOBUILD_MAKE BOARD=$board BUILD=$build_dir && copy_artefacts $dest_dir $descr $fw_tag $build_dir $@\n    rm -rf $build_dir\n\n    # Query variants from board.json and build them. Ignore the special \"IDF3\"\n    # variant for ESP32 boards (this allows the downloads page to still have\n    # the idf3 files for older releases that used to be explicitly built).\n    for variant in `cat $board_json | python3 -c \"import json,sys; print(' '.join(v for v in json.load(sys.stdin).get('variants', {}).keys() if v != 'IDF3'))\"`; do\n        local variant_build_dir=$build_dir-$variant\n        echo \"building variant $descr $board $variant\"\n        $MICROPY_AUTOBUILD_MAKE BOARD=$board BOARD_VARIANT=$variant BUILD=$variant_build_dir && copy_artefacts $dest_dir $descr-$variant $fw_tag $variant_build_dir $@\n        rm -rf $variant_build_dir\n    done\n}\n\nfunction build_boards {\n    # check/get parameters\n    if [ $# -lt 4 ]; then\n        echo \"usage: $0 <check-file> <fw-tag> <dest-dir> <exts...>\"\n        return 1\n    fi\n\n    local check_file=$1\n    shift\n\n    # check we are in the correct directory\n    if [ ! -r $check_file ]; then\n        echo \"must be in directory containing $check_file\"\n        return 1\n    fi\n\n    # build all boards that have a board.json file\n    for board_json in $(find boards/ -name board.json | sort); do\n        build_board $board_json $@\n    done\n}\n\nfunction build_cc3200_boards {\n    build_boards hal/cc3200_hal.c $1 $2 zip\n}\n\nfunction build_esp32_boards {\n    build_boards modesp32.c $1 $2 bin elf map uf2 app-bin\n}\n\nfunction build_esp8266_boards {\n    build_boards modesp.c $1 $2 bin elf map\n}\n\nfunction build_mimxrt_boards {\n    build_boards modmimxrt.c $1 $2 bin hex\n}\n\nfunction build_nrf_boards {\n    build_boards nrfx_glue.h $1 $2 bin hex uf2\n}\n\nfunction build_renesas_ra_boards {\n    build_boards ra_it.c $1 $2 bin hex\n}\n\nfunction build_rp2_boards {\n    build_boards modrp2.c $1 $2 uf2\n}\n\nfunction build_samd_boards {\n    build_boards samd_soc.c $1 $2 uf2\n}\n\nfunction build_stm32_boards {\n    build_boards modpyb.c $1 $2 dfu hex\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}