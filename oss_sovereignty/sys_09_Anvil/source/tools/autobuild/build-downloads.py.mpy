{
  "module_name": "build-downloads.py",
  "hash_id": "de058233eb5e189cf4ded6ee44394106bfb9761f1bfd261bd317d46c344abe22",
  "original_prompt": "Ingested from sys_09_Anvil/source/tools/autobuild/build-downloads.py",
  "human_readable_source": "#!/usr/bin/env python3\n\nimport glob\nimport json\nimport os\nimport sys\n\nVALID_FEATURES = {\n    # Connectivity\n    \"BLE\",\n    \"CAN\",\n    \"Ethernet\",\n    \"LoRa\",\n    \"USB\",\n    \"USB-C\",\n    \"WiFi\",\n    # MCU features\n    \"Dual-core\",\n    \"External Flash\",\n    \"External RAM\",\n    # Form factor\n    \"Feather\",\n    # Connectors / sockets\n    \"JST-PH\",\n    \"JST-SH\",\n    \"mikroBUS\",\n    \"microSD\",\n    \"SDCard\",\n    # Sensors\n    \"Environment Sensor\",\n    \"IMU\",\n    # Other\n    \"Audio Codec\",\n    \"Battery Charging\",\n    \"Camera\",\n    \"DAC\",\n    \"Display\",\n    \"Microphone\",\n    \"PoE\",\n    \"RGB LED\",\n    \"Secure Element\",\n}\n\n\ndef main(repo_path, output_path):\n    boards_index = []\n    board_ids = set()\n\n    for board_json in glob.glob(os.path.join(repo_path, \"ports/*/boards/*/board.json\")):\n        # Relative path to the board directory (e.g. \"ports/stm32/boards/PYBV11\").\n        board_dir = os.path.dirname(board_json)\n        # Relative path to the port (e.g. \"ports/stm32\")\n        port_dir = os.path.dirname(os.path.dirname(board_dir))\n\n        with open(board_json, \"r\") as f:\n            blob = json.load(f)\n\n            features = set(blob.get(\"features\", []))\n            if not features.issubset(VALID_FEATURES):\n                print(\n                    board_json,\n                    \"unknown features:\",\n                    features.difference(VALID_FEATURES),\n                    file=sys.stderr,\n                )\n                sys.exit(1)\n\n            # Use \"id\" if specified, otherwise default to board dir (e.g. \"PYBV11\").\n            # We allow boards to override ID for the historical build names.\n            blob[\"id\"] = blob.get(\"id\", os.path.basename(board_dir))\n\n            # Check for duplicate board IDs.\n            if blob[\"id\"] in board_ids:\n                print(\"Duplicate board ID: '{}'\".format(blob[\"id\"]), file=sys.stderr)\n            board_ids.add(blob[\"id\"])\n\n            # Add in default fields.\n            blob[\"port\"] = os.path.basename(port_dir)\n            blob[\"build\"] = os.path.basename(board_dir)\n            boards_index.append(blob)\n\n        # Create the board markdown, which is the concatenation of the\n        # default \"board.md\" file (if exists), as well as any flashing\n        # instructions.\n        board_markdown = os.path.join(board_dir, \"board.md\")\n        with open(os.path.join(output_path, blob[\"id\"] + \".md\"), \"w\") as f:\n            if os.path.exists(board_markdown):\n                with open(board_markdown, \"r\") as fin:\n                    f.write(fin.read())\n\n            if blob[\"deploy\"]:\n                f.write(\"\\n\\n## Installation instructions\\n\")\n            for deploy in blob[\"deploy\"]:\n                with open(os.path.join(board_dir, deploy), \"r\") as fin:\n                    f.write(fin.read())\n\n    # Write the full index for the website to load.\n    with open(os.path.join(output_path, \"index.json\"), \"w\") as f:\n        json.dump(boards_index, f, indent=4, sort_keys=True)\n        f.write(\"\\n\")\n\n\nif __name__ == \"__main__\":\n    main(sys.argv[1], sys.argv[2])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}