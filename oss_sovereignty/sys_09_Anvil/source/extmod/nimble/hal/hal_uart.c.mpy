{
  "module_name": "hal_uart.c",
  "hash_id": "25bb2feea75d49dd634dd12ffb986a3d257179505bfc1ba6f969412de1e0aa97",
  "original_prompt": "Ingested from sys_09_Anvil/source/extmod/nimble/hal/hal_uart.c",
  "human_readable_source": " \n\n#include \"py/runtime.h\"\n#include \"py/mphal.h\"\n#include \"nimble/ble.h\"\n#include \"extmod/nimble/modbluetooth_nimble.h\"\n#include \"extmod/nimble/hal/hal_uart.h\"\n#include \"extmod/nimble/nimble/nimble_npl_os.h\"\n#include \"extmod/mpbthci.h\"\n\n#if MICROPY_PY_BLUETOOTH && MICROPY_BLUETOOTH_NIMBLE\n\n#ifndef MICROPY_PY_BLUETOOTH_HCI_READ_MODE\n#define MICROPY_PY_BLUETOOTH_HCI_READ_MODE MICROPY_PY_BLUETOOTH_HCI_READ_MODE_BYTE\n#endif\n\n#define HCI_TRACE (0)\n#define COL_OFF \"\\033[0m\"\n#define COL_GREEN \"\\033[0;32m\"\n#define COL_BLUE \"\\033[0;34m\"\n\nstatic hal_uart_tx_cb_t hal_uart_tx_cb;\nstatic void *hal_uart_tx_arg;\nstatic hal_uart_rx_cb_t hal_uart_rx_cb;\nstatic void *hal_uart_rx_arg;\n\n\nextern uint8_t mp_bluetooth_hci_cmd_buf[4 + 256];\n\nint hal_uart_init_cbs(uint32_t port, hal_uart_tx_cb_t tx_cb, void *tx_arg, hal_uart_rx_cb_t rx_cb, void *rx_arg) {\n    hal_uart_tx_cb = tx_cb;\n    hal_uart_tx_arg = tx_arg;\n    hal_uart_rx_cb = rx_cb;\n    hal_uart_rx_arg = rx_arg;\n    return 0; \n}\n\nint hal_uart_config(uint32_t port, uint32_t baudrate, uint32_t bits, uint32_t stop, uint32_t parity, uint32_t flow) {\n    return mp_bluetooth_hci_uart_init(port, baudrate);\n}\n\nvoid hal_uart_start_tx(uint32_t port) {\n    size_t len = 0;\n    for (;;) {\n        int data = hal_uart_tx_cb(hal_uart_tx_arg);\n        if (data == -1) {\n            break;\n        }\n        mp_bluetooth_hci_cmd_buf[len++] = data;\n    }\n\n    #if HCI_TRACE\n    printf(COL_GREEN \"< [% 8d] %02x\", (int)mp_hal_ticks_ms(), mp_bluetooth_hci_cmd_buf[0]);\n    for (size_t i = 1; i < len; ++i) {\n        printf(\":%02x\", mp_bluetooth_hci_cmd_buf[i]);\n    }\n    printf(COL_OFF \"\\n\");\n    #endif\n\n    mp_bluetooth_hci_uart_write(mp_bluetooth_hci_cmd_buf, len);\n\n    if (len > 0) {\n        \n        mp_bluetooth_nimble_sent_hci_packet();\n    }\n}\n\nint hal_uart_close(uint32_t port) {\n    return 0; \n}\n\nstatic void mp_bluetooth_hci_uart_char_cb(uint8_t chr) {\n    #if HCI_TRACE\n    printf(COL_BLUE \"> [% 8d] %02x\" COL_OFF \"\\n\", (int)mp_hal_ticks_ms(), chr);\n    #endif\n    hal_uart_rx_cb(hal_uart_rx_arg, chr);\n}\n\nvoid mp_bluetooth_nimble_hci_uart_process(bool run_events) {\n    bool host_wake = mp_bluetooth_hci_controller_woken();\n\n    for (;;) {\n        #if MICROPY_PY_BLUETOOTH_HCI_READ_MODE == MICROPY_PY_BLUETOOTH_HCI_READ_MODE_BYTE\n        int chr = mp_bluetooth_hci_uart_readchar();\n        if (chr < 0) {\n            break;\n        }\n        mp_bluetooth_hci_uart_char_cb(chr);\n        #elif MICROPY_PY_BLUETOOTH_HCI_READ_MODE == MICROPY_PY_BLUETOOTH_HCI_READ_MODE_PACKET\n        if (mp_bluetooth_hci_uart_readpacket(mp_bluetooth_hci_uart_char_cb) < 0) {\n            break;\n        }\n        #endif\n\n        \n        \n        if (run_events) {\n            mp_bluetooth_nimble_os_eventq_run_all();\n        }\n    }\n\n    if (host_wake) {\n        mp_bluetooth_hci_controller_sleep_maybe();\n    }\n}\n\n#endif \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}