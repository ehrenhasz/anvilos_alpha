{
  "module_name": "modonewire.c",
  "hash_id": "3d2c6b15756a180ce8d532356c22efc6d4996547727bb6ea6c6dbc0529e8bdd2",
  "original_prompt": "Ingested from sys_09_Anvil/source/extmod/modonewire.c",
  "human_readable_source": " \n\n#include <stdio.h>\n#include <stdint.h>\n\n#include \"py/obj.h\"\n#include \"py/mphal.h\"\n\n#if MICROPY_PY_ONEWIRE\n\n \n\n\n#define TIMING_RESET1 (480)\n#define TIMING_RESET2 (70)\n#define TIMING_RESET3 (410)\n#define TIMING_READ1  (6)\n#define TIMING_READ2  (9)\n#define TIMING_READ3  (55)\n#define TIMING_WRITE1 (6)\n#define TIMING_WRITE2 (54)\n#define TIMING_WRITE3 (10)\n\nstatic int onewire_bus_reset(mp_hal_pin_obj_t pin) {\n    mp_hal_pin_od_low(pin);\n    mp_hal_delay_us(TIMING_RESET1);\n    uint32_t i = mp_hal_quiet_timing_enter();\n    mp_hal_pin_od_high(pin);\n    mp_hal_delay_us_fast(TIMING_RESET2);\n    int status = !mp_hal_pin_read(pin);\n    mp_hal_quiet_timing_exit(i);\n    mp_hal_delay_us(TIMING_RESET3);\n    return status;\n}\n\nstatic int onewire_bus_readbit(mp_hal_pin_obj_t pin) {\n    mp_hal_pin_od_high(pin);\n    uint32_t i = mp_hal_quiet_timing_enter();\n    mp_hal_pin_od_low(pin);\n    mp_hal_delay_us_fast(TIMING_READ1);\n    mp_hal_pin_od_high(pin);\n    mp_hal_delay_us_fast(TIMING_READ2);\n    int value = mp_hal_pin_read(pin);\n    mp_hal_quiet_timing_exit(i);\n    mp_hal_delay_us_fast(TIMING_READ3);\n    return value;\n}\n\nstatic void onewire_bus_writebit(mp_hal_pin_obj_t pin, int value) {\n    uint32_t i = mp_hal_quiet_timing_enter();\n    mp_hal_pin_od_low(pin);\n    mp_hal_delay_us_fast(TIMING_WRITE1);\n    if (value) {\n        mp_hal_pin_od_high(pin);\n    }\n    mp_hal_delay_us_fast(TIMING_WRITE2);\n    mp_hal_pin_od_high(pin);\n    mp_hal_delay_us_fast(TIMING_WRITE3);\n    mp_hal_quiet_timing_exit(i);\n}\n\n \n\n\nstatic mp_obj_t onewire_reset(mp_obj_t pin_in) {\n    return mp_obj_new_bool(onewire_bus_reset(mp_hal_get_pin_obj(pin_in)));\n}\nstatic MP_DEFINE_CONST_FUN_OBJ_1(onewire_reset_obj, onewire_reset);\n\nstatic mp_obj_t onewire_readbit(mp_obj_t pin_in) {\n    return MP_OBJ_NEW_SMALL_INT(onewire_bus_readbit(mp_hal_get_pin_obj(pin_in)));\n}\nstatic MP_DEFINE_CONST_FUN_OBJ_1(onewire_readbit_obj, onewire_readbit);\n\nstatic mp_obj_t onewire_readbyte(mp_obj_t pin_in) {\n    mp_hal_pin_obj_t pin = mp_hal_get_pin_obj(pin_in);\n    uint8_t value = 0;\n    for (int i = 0; i < 8; ++i) {\n        value |= onewire_bus_readbit(pin) << i;\n    }\n    return MP_OBJ_NEW_SMALL_INT(value);\n}\nstatic MP_DEFINE_CONST_FUN_OBJ_1(onewire_readbyte_obj, onewire_readbyte);\n\nstatic mp_obj_t onewire_writebit(mp_obj_t pin_in, mp_obj_t value_in) {\n    onewire_bus_writebit(mp_hal_get_pin_obj(pin_in), mp_obj_get_int(value_in));\n    return mp_const_none;\n}\nstatic MP_DEFINE_CONST_FUN_OBJ_2(onewire_writebit_obj, onewire_writebit);\n\nstatic mp_obj_t onewire_writebyte(mp_obj_t pin_in, mp_obj_t value_in) {\n    mp_hal_pin_obj_t pin = mp_hal_get_pin_obj(pin_in);\n    int value = mp_obj_get_int(value_in);\n    for (int i = 0; i < 8; ++i) {\n        onewire_bus_writebit(pin, value & 1);\n        value >>= 1;\n    }\n    return mp_const_none;\n}\nstatic MP_DEFINE_CONST_FUN_OBJ_2(onewire_writebyte_obj, onewire_writebyte);\n\nstatic mp_obj_t onewire_crc8(mp_obj_t data) {\n    mp_buffer_info_t bufinfo;\n    mp_get_buffer_raise(data, &bufinfo, MP_BUFFER_READ);\n    uint8_t crc = 0;\n    for (size_t i = 0; i < bufinfo.len; ++i) {\n        uint8_t byte = ((uint8_t *)bufinfo.buf)[i];\n        for (int b = 0; b < 8; ++b) {\n            uint8_t fb_bit = (crc ^ byte) & 0x01;\n            if (fb_bit == 0x01) {\n                crc = crc ^ 0x18;\n            }\n            crc = (crc >> 1) & 0x7f;\n            if (fb_bit == 0x01) {\n                crc = crc | 0x80;\n            }\n            byte = byte >> 1;\n        }\n    }\n    return MP_OBJ_NEW_SMALL_INT(crc);\n}\nstatic MP_DEFINE_CONST_FUN_OBJ_1(onewire_crc8_obj, onewire_crc8);\n\nstatic const mp_rom_map_elem_t onewire_module_globals_table[] = {\n    { MP_ROM_QSTR(MP_QSTR___name__), MP_ROM_QSTR(MP_QSTR_onewire) },\n\n    { MP_ROM_QSTR(MP_QSTR_reset), MP_ROM_PTR(&onewire_reset_obj) },\n    { MP_ROM_QSTR(MP_QSTR_readbit), MP_ROM_PTR(&onewire_readbit_obj) },\n    { MP_ROM_QSTR(MP_QSTR_readbyte), MP_ROM_PTR(&onewire_readbyte_obj) },\n    { MP_ROM_QSTR(MP_QSTR_writebit), MP_ROM_PTR(&onewire_writebit_obj) },\n    { MP_ROM_QSTR(MP_QSTR_writebyte), MP_ROM_PTR(&onewire_writebyte_obj) },\n    { MP_ROM_QSTR(MP_QSTR_crc8), MP_ROM_PTR(&onewire_crc8_obj) },\n};\n\nstatic MP_DEFINE_CONST_DICT(onewire_module_globals, onewire_module_globals_table);\n\nconst mp_obj_module_t mp_module_onewire = {\n    .base = { &mp_type_module },\n    .globals = (mp_obj_dict_t *)&onewire_module_globals,\n};\n\nMP_REGISTER_MODULE(MP_QSTR__onewire, mp_module_onewire);\n\n#endif \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}