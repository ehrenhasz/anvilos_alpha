{
  "module_name": "btstack_hci_uart.c",
  "hash_id": "6227a45199b751c04bcd7fce1d5e23c37e3ada436840afc666cb1f43c5855dc5",
  "original_prompt": "Ingested from sys_09_Anvil/source/extmod/btstack/btstack_hci_uart.c",
  "human_readable_source": " \n\n#include \"py/runtime.h\"\n#include \"py/mperrno.h\"\n#include \"py/mphal.h\"\n\n#if MICROPY_PY_BLUETOOTH && MICROPY_BLUETOOTH_BTSTACK\n\n#include \"lib/btstack/src/btstack.h\"\n\n#include \"extmod/mpbthci.h\"\n#include \"extmod/btstack/btstack_hci_uart.h\"\n\n#include \"mpbthciport.h\"\n#include \"mpbtstackport.h\"\n\n#define HCI_TRACE (0)\n#define COL_OFF \"\\033[0m\"\n#define COL_GREEN \"\\033[0;32m\"\n#define COL_BLUE \"\\033[0;34m\"\n\n\n\n\n\nstatic bool send_done;\nstatic void (*send_handler)(void);\n\n\nstatic uint8_t *recv_buf;\nstatic size_t recv_len;\nstatic size_t recv_idx;\nstatic void (*recv_handler)(void);\nstatic bool init_success = false;\n\nstatic int btstack_uart_init(const btstack_uart_config_t *uart_config) {\n    (void)uart_config;\n\n    send_done = false;\n    recv_len = 0;\n    recv_idx = 0;\n    recv_handler = NULL;\n    send_handler = NULL;\n\n    \n    if (mp_bluetooth_hci_uart_init(MICROPY_HW_BLE_UART_ID, MICROPY_HW_BLE_UART_BAUDRATE)) {\n        init_success = false;\n        return -1;\n    }\n    if (mp_bluetooth_hci_controller_init()) {\n        init_success = false;\n        return -1;\n    }\n\n    init_success = true;\n    return 0;\n}\n\nstatic int btstack_uart_open(void) {\n    return init_success ? 0 : 1;\n}\n\nstatic int btstack_uart_close(void) {\n    mp_bluetooth_hci_controller_deinit();\n    mp_bluetooth_hci_uart_deinit();\n    return 0;\n}\n\nstatic void btstack_uart_set_block_received(void (*block_handler)(void)) {\n    recv_handler = block_handler;\n}\n\nstatic void btstack_uart_set_block_sent(void (*block_handler)(void)) {\n    send_handler = block_handler;\n}\n\nstatic int btstack_uart_set_baudrate(uint32_t baudrate) {\n    mp_bluetooth_hci_uart_set_baudrate(baudrate);\n    return 0;\n}\n\nstatic int btstack_uart_set_parity(int parity) {\n    (void)parity;\n    return 0;\n}\n\nstatic int btstack_uart_set_flowcontrol(int flowcontrol) {\n    (void)flowcontrol;\n    return 0;\n}\n\nstatic void btstack_uart_receive_block(uint8_t *buf, uint16_t len) {\n    recv_buf = buf;\n    recv_len = len;\n}\n\nstatic void btstack_uart_send_block(const uint8_t *buf, uint16_t len) {\n    #if HCI_TRACE\n    printf(COL_GREEN \"< [% 8d] %02x\", (int)mp_hal_ticks_ms(), buf[0]);\n    for (size_t i = 1; i < len; ++i) {\n        printf(\":%02x\", buf[i]);\n    }\n    printf(COL_OFF \"\\n\");\n    #endif\n\n    mp_bluetooth_hci_uart_write(buf, len);\n    send_done = true;\n\n    \n    \n    mp_bluetooth_hci_poll_now();\n}\n\nstatic int btstack_uart_get_supported_sleep_modes(void) {\n    return 0;\n}\n\nstatic void btstack_uart_set_sleep(btstack_uart_sleep_mode_t sleep_mode) {\n    (void)sleep_mode;\n    \n}\n\nstatic void btstack_uart_set_wakeup_handler(void (*wakeup_handler)(void)) {\n    (void)wakeup_handler;\n    \n}\n\nconst btstack_uart_block_t mp_bluetooth_btstack_hci_uart_block = {\n    &btstack_uart_init,\n    &btstack_uart_open,\n    &btstack_uart_close,\n    &btstack_uart_set_block_received,\n    &btstack_uart_set_block_sent,\n    &btstack_uart_set_baudrate,\n    &btstack_uart_set_parity,\n    &btstack_uart_set_flowcontrol,\n    &btstack_uart_receive_block,\n    &btstack_uart_send_block,\n    &btstack_uart_get_supported_sleep_modes,\n    &btstack_uart_set_sleep,\n    &btstack_uart_set_wakeup_handler,\n\n    \n    NULL, \n    NULL, \n    NULL, \n    NULL, \n};\n\nvoid mp_bluetooth_btstack_hci_uart_process(void) {\n    bool host_wake = mp_bluetooth_hci_controller_woken();\n\n    if (send_done) {\n        \n        send_done = false;\n        if (send_handler) {\n            send_handler();\n        }\n    }\n\n    \n    \n    int chr;\n    while (recv_idx < recv_len && (chr = mp_bluetooth_hci_uart_readchar()) >= 0) {\n        recv_buf[recv_idx++] = chr;\n        if (recv_idx == recv_len) {\n            #if HCI_TRACE\n            printf(COL_BLUE \"> [% 8d] %02x\", (int)mp_hal_ticks_ms(), recv_buf[0]);\n            for (size_t i = 1; i < recv_len; ++i) {\n                printf(\":%02x\", recv_buf[i]);\n            }\n            printf(COL_OFF \"\\n\");\n            #endif\n            recv_idx = 0;\n            recv_len = 0;\n            if (recv_handler) {\n                recv_handler();\n            }\n        }\n    }\n\n    if (host_wake) {\n        mp_bluetooth_hci_controller_sleep_maybe();\n    }\n}\n\n#endif \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}