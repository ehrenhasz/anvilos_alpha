{
  "module_name": "dynruntime.mk",
  "hash_id": "34e726ef31f69f046ac5ed3329f38b2b7141d0f4137ba4cf7ee8a16062fa2669",
  "original_prompt": "Ingested from sys_09_Anvil/source/py/dynruntime.mk",
  "human_readable_source": "# Makefile fragment for generating native .mpy files from C source\n# MPY_DIR must be set to the top of the MicroPython source tree\n\nBUILD ?= build\n\nECHO = @echo\nRM = /bin/rm\nMKDIR = /bin/mkdir\nPYTHON = python3\nMPY_CROSS = $(MPY_DIR)/mpy-cross/build/mpy-cross\nMPY_TOOL = $(PYTHON) $(MPY_DIR)/tools/mpy-tool.py\nMPY_LD = $(PYTHON) $(MPY_DIR)/tools/mpy_ld.py\n\nQ = @\nifeq (\"$(origin V)\", \"command line\")\nifeq ($(V),1)\nQ =\nMPY_LD += '-vvv'\nendif\nendif\n\nARCH_UPPER = $(shell echo $(ARCH) | tr '[:lower:]' '[:upper:]')\nCONFIG_H = $(BUILD)/$(MOD).config.h\n\nCFLAGS += -I. -I$(MPY_DIR)\nCFLAGS += -std=c99\nCFLAGS += -Os\nCFLAGS += -Wall -Werror -DNDEBUG\nCFLAGS += -DNO_QSTR\nCFLAGS += -DMICROPY_ENABLE_DYNRUNTIME\nCFLAGS += -DMP_CONFIGFILE='<$(CONFIG_H)>'\nCFLAGS += -fpic -fno-common\nCFLAGS += -U _FORTIFY_SOURCE # prevent use of __*_chk libc functions\n#CFLAGS += -fdata-sections -ffunction-sections\n\nMPY_CROSS_FLAGS += -march=$(ARCH)\n\nSRC_O += $(addprefix $(BUILD)/, $(patsubst %.c,%.o,$(filter %.c,$(SRC))) $(patsubst %.S,%.o,$(filter %.S,$(SRC))))\nSRC_MPY += $(addprefix $(BUILD)/, $(patsubst %.py,%.mpy,$(filter %.py,$(SRC))))\n\n################################################################################\n# Architecture configuration\n\nifeq ($(ARCH),x86)\n\n# x86\nCROSS =\nCFLAGS += -m32 -fno-stack-protector\nMICROPY_FLOAT_IMPL ?= double\n\nelse ifeq ($(ARCH),x64)\n\n# x64\nCROSS =\nCFLAGS += -fno-stack-protector\nMICROPY_FLOAT_IMPL ?= double\n\nelse ifeq ($(ARCH),armv6m)\n\n# thumb\nCROSS = arm-none-eabi-\nCFLAGS += -mthumb -mcpu=cortex-m0\nMICROPY_FLOAT_IMPL ?= none\n\nelse ifeq ($(ARCH),armv7m)\n\n# thumb\nCROSS = arm-none-eabi-\nCFLAGS += -mthumb -mcpu=cortex-m3\nMICROPY_FLOAT_IMPL ?= none\n\nelse ifeq ($(ARCH),armv7emsp)\n\n# thumb\nCROSS = arm-none-eabi-\nCFLAGS += -mthumb -mcpu=cortex-m4\nCFLAGS += -mfpu=fpv4-sp-d16 -mfloat-abi=hard\nMICROPY_FLOAT_IMPL ?= float\n\nelse ifeq ($(ARCH),armv7emdp)\n\n# thumb\nCROSS = arm-none-eabi-\nCFLAGS += -mthumb -mcpu=cortex-m7\nCFLAGS += -mfpu=fpv5-d16 -mfloat-abi=hard\nMICROPY_FLOAT_IMPL ?= double\n\nelse ifeq ($(ARCH),xtensa)\n\n# xtensa\nCROSS = xtensa-lx106-elf-\nCFLAGS += -mforce-l32\nMICROPY_FLOAT_IMPL ?= none\n\nelse ifeq ($(ARCH),xtensawin)\n\n# xtensawin\nCROSS = xtensa-esp32-elf-\nCFLAGS +=\nMICROPY_FLOAT_IMPL ?= float\n\nelse\n$(error architecture '$(ARCH)' not supported)\nendif\n\nMICROPY_FLOAT_IMPL_UPPER = $(shell echo $(MICROPY_FLOAT_IMPL) | tr '[:lower:]' '[:upper:]')\nCFLAGS += -DMICROPY_FLOAT_IMPL=MICROPY_FLOAT_IMPL_$(MICROPY_FLOAT_IMPL_UPPER)\n\nCFLAGS += $(CFLAGS_EXTRA)\n\n################################################################################\n# Build rules\n\n.PHONY: all clean\n\nall: $(MOD).mpy\n\nclean:\n\t$(RM) -rf $(BUILD) $(CLEAN_EXTRA)\n\n# Create build destination directories first\nBUILD_DIRS = $(sort $(dir $(CONFIG_H) $(SRC_O) $(SRC_MPY)))\n$(CONFIG_H) $(SRC_O) $(SRC_MPY): | $(BUILD_DIRS)\n$(BUILD_DIRS):\n\t$(Q)$(MKDIR) -p $@\n\n# Preprocess all source files to generate $(CONFIG_H)\n$(CONFIG_H): $(SRC)\n\t$(ECHO) \"GEN $@\"\n\t$(Q)$(MPY_LD) --arch $(ARCH) --preprocess -o $@ $^\n\n# Build .o from .c source files\n$(BUILD)/%.o: %.c $(CONFIG_H) Makefile\n\t$(ECHO) \"CC $<\"\n\t$(Q)$(CROSS)gcc $(CFLAGS) -o $@ -c $<\n\n# Build .o from .S source files\n$(BUILD)/%.o: %.S $(CONFIG_H) Makefile\n\t$(ECHO) \"AS $<\"\n\t$(Q)$(CROSS)gcc $(CFLAGS) -o $@ -c $<\n\n# Build .mpy from .py source files\n$(BUILD)/%.mpy: %.py\n\t$(ECHO) \"MPY $<\"\n\t$(Q)$(MPY_CROSS) $(MPY_CROSS_FLAGS) -o $@ $<\n\n# Build native .mpy from object files\n$(BUILD)/$(MOD).native.mpy: $(SRC_O)\n\t$(ECHO) \"LINK $<\"\n\t$(Q)$(MPY_LD) --arch $(ARCH) --qstrs $(CONFIG_H) -o $@ $^\n\n# Build final .mpy from all intermediate .mpy files\n$(MOD).mpy: $(BUILD)/$(MOD).native.mpy $(SRC_MPY)\n\t$(ECHO) \"GEN $@\"\n\t$(Q)$(MPY_TOOL) --merge -o $@ $^\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}