{
  "module_name": "alloc.c",
  "hash_id": "e19cb6f7b4d07a48bfdb4df92166914fb0ee08355921ead81cb580378107fd2a",
  "original_prompt": "Ingested from sys_09_Anvil/source/ports/unix/alloc.c",
  "human_readable_source": " \n\n#include <stdio.h>\n#include <stdint.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/mman.h>\n\n#include \"py/mpstate.h\"\n#include \"py/gc.h\"\n\n#if MICROPY_EMIT_NATIVE || (MICROPY_PY_FFI && MICROPY_FORCE_PLAT_ALLOC_EXEC)\n\n#if defined(__OpenBSD__) || defined(__MACH__)\n#define MAP_ANONYMOUS MAP_ANON\n#endif\n\n\n\n\n\ntypedef struct _mmap_region_t {\n    void *ptr;\n    size_t len;\n    struct _mmap_region_t *next;\n} mmap_region_t;\n\nvoid mp_unix_alloc_exec(size_t min_size, void **ptr, size_t *size) {\n    \n    *size = (min_size + 0xfff) & (~0xfff);\n    *ptr = mmap(NULL, *size, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);\n    if (*ptr == MAP_FAILED) {\n        *ptr = NULL;\n    }\n\n    \n    mmap_region_t *rg = m_new_obj(mmap_region_t);\n    rg->ptr = *ptr;\n    rg->len = min_size;\n    rg->next = MP_STATE_VM(mmap_region_head);\n    MP_STATE_VM(mmap_region_head) = rg;\n}\n\nvoid mp_unix_free_exec(void *ptr, size_t size) {\n    munmap(ptr, size);\n\n    \n    for (mmap_region_t **rg = (mmap_region_t **)&MP_STATE_VM(mmap_region_head); *rg != NULL; *rg = (*rg)->next) {\n        if ((*rg)->ptr == ptr) {\n            mmap_region_t *next = (*rg)->next;\n            m_del_obj(mmap_region_t, *rg);\n            *rg = next;\n            return;\n        }\n    }\n}\n\nvoid mp_unix_mark_exec(void) {\n    for (mmap_region_t *rg = MP_STATE_VM(mmap_region_head); rg != NULL; rg = rg->next) {\n        gc_collect_root(rg->ptr, rg->len / sizeof(mp_uint_t));\n    }\n}\n\n#if MICROPY_FORCE_PLAT_ALLOC_EXEC\n\n\n\nvoid *ffi_closure_alloc(size_t size, void **code);\nvoid ffi_closure_free(void *ptr);\n\nvoid *ffi_closure_alloc(size_t size, void **code) {\n    size_t dummy;\n    mp_unix_alloc_exec(size, code, &dummy);\n    return *code;\n}\n\nvoid ffi_closure_free(void *ptr) {\n    (void)ptr;\n    \n}\n#endif\n\nMP_REGISTER_ROOT_POINTER(void *mmap_region_head);\n\n#endif \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}