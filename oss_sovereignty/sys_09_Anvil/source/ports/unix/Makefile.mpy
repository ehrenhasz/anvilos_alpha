{
  "module_name": "Makefile",
  "hash_id": "534e3613b2f2b2b8f86fc14c6e0637e158b5478da4d09b6bf32ff0d3f5875bb1",
  "original_prompt": "Ingested from sys_09_Anvil/source/ports/unix/Makefile",
  "human_readable_source": "# Select the variant to build for:\nifdef VARIANT_DIR\n# Custom variant path - remove trailing slash and get the final component of\n# the path as the variant name.\nVARIANT ?= $(notdir $(VARIANT_DIR:/=))\nelse\n# If not given on the command line, then default to standard.\nVARIANT ?= standard\nVARIANT_DIR ?= variants/$(VARIANT)\nendif\n\nifeq ($(wildcard $(VARIANT_DIR)/.),)\n$(error Invalid VARIANT specified: $(VARIANT_DIR))\nendif\n\n# If the build directory is not given, make it reflect the variant name.\nBUILD ?= build-$(VARIANT)\n\ninclude ../../py/mkenv.mk\n-include mpconfigport.mk\ninclude $(VARIANT_DIR)/mpconfigvariant.mk\n\n# Use the default frozen manifest, variants may override this.\nFROZEN_MANIFEST ?= variants/manifest.py\n\n# This should be configured by the mpconfigvariant.mk\nPROG ?= micropython\n\n# qstr definitions (must come before including py.mk)\nQSTR_DEFS += qstrdefsport.h\nQSTR_GLOBAL_DEPENDENCIES += $(VARIANT_DIR)/mpconfigvariant.h\n\n# OS name, for simple autoconfig\nUNAME_S := $(shell uname -s)\n\n# include py core make definitions\ninclude $(TOP)/py/py.mk\ninclude $(TOP)/extmod/extmod.mk\n\nGIT_SUBMODULES += lib/berkeley-db-1.xx\n\nINC +=  -I.\nINC +=  -I$(TOP)\nINC += -I$(BUILD)\n\n# compiler settings\nCWARN = -Wall -Werror\nCWARN += -Wextra -Wno-unused-parameter -Wpointer-arith -Wdouble-promotion -Wfloat-conversion\nCFLAGS += $(INC) $(CWARN) -std=gnu99 -DUNIX $(COPT) -I$(VARIANT_DIR) $(CFLAGS_EXTRA)\n\n# Debugging/Optimization\nifdef DEBUG\nCOPT ?= -Og\nelse\nCOPT ?= -Os\nCOPT += -DNDEBUG\nendif\n\n# Remove unused sections.\nCOPT += -fdata-sections -ffunction-sections\n\n# Note: Symbols and debug information will still be stripped from the final binary\n# unless \"DEBUG=1\" or \"STRIP=\" is passed to make, see README.md for details.\nCFLAGS += -g\n\nifndef DEBUG\n# _FORTIFY_SOURCE is a feature in gcc/glibc which is intended to provide extra\n# security for detecting buffer overflows. Some distros (Ubuntu at the very least)\n# have it enabled by default.\n#\n# gcc already optimizes some printf calls to call puts and/or putchar. When\n# _FORTIFY_SOURCE is enabled and compiling with -O1 or greater, then some\n# printf calls will also be optimized to call __printf_chk (in glibc). Any\n# printfs which get redirected to __printf_chk are then no longer synchronized\n# with printfs that go through mp_printf.\n#\n# In MicroPython, we don't want to use the runtime library's printf but rather\n# go through mp_printf, so that stdout is properly tied into streams, etc.\n# This means that we either need to turn off _FORTIFY_SOURCE or provide our\n# own implementation of __printf_chk. We've chosen to turn off _FORTIFY_SOURCE.\n# It should also be noted that the use of printf in MicroPython is typically\n# quite limited anyways (primarily for debug and some error reporting, etc\n# in the unix version).\n#\n# Information about _FORTIFY_SOURCE seems to be rather scarce. The best I could\n# find was this: https://securityblog.redhat.com/2014/03/26/fortify-and-you/\n# Original patchset was introduced by\n# https://gcc.gnu.org/ml/gcc-patches/2004-09/msg02055.html .\n#\n# Turning off _FORTIFY_SOURCE is only required when compiling with -O1 or greater\nCFLAGS += -U _FORTIFY_SOURCE\nendif\n\n# On OSX, 'gcc' is a symlink to clang unless a real gcc is installed.\n# The unix port of MicroPython on OSX must be compiled with clang,\n# while cross-compile ports require gcc, so we test here for OSX and\n# if necessary override the value of 'CC' set in py/mkenv.mk\nifeq ($(UNAME_S),Darwin)\nifeq ($(MICROPY_FORCE_32BIT),1)\nCC = clang -m32\nelse\nCC = clang\nendif\n# Use clang syntax for map file\nLDFLAGS_ARCH = -Wl,-map,$@.map -Wl,-dead_strip\nelse\n# Use gcc syntax for map file\nLDFLAGS_ARCH = -Wl,-Map=$@.map,--cref -Wl,--gc-sections\nendif\nLDFLAGS += $(LDFLAGS_MOD) $(LDFLAGS_ARCH) -lm $(LDFLAGS_EXTRA)\n\n# Flags to link with pthread library\nLIBPTHREAD = -lpthread\n\nifeq ($(MICROPY_FORCE_32BIT),1)\n# Note: you may need to install i386 versions of dependency packages,\n# starting with linux-libc-dev:i386\nifeq ($(MICROPY_PY_FFI),1)\nifeq ($(UNAME_S),Linux)\nCFLAGS += -I/usr/include/i686-linux-gnu\nendif\nendif\nendif\n\nifeq ($(MICROPY_USE_READLINE),1)\nINC += -I$(TOP)/shared/readline\nCFLAGS += -DMICROPY_USE_READLINE=1\nSHARED_SRC_C_EXTRA += readline/readline.c\nendif\nifeq ($(MICROPY_PY_TERMIOS),1)\nCFLAGS += -DMICROPY_PY_TERMIOS=1\nendif\nifeq ($(MICROPY_PY_SOCKET),1)\nCFLAGS += -DMICROPY_PY_SOCKET=1\nendif\nifeq ($(MICROPY_PY_THREAD),1)\nCFLAGS += -DMICROPY_PY_THREAD=1 -DMICROPY_PY_THREAD_GIL=0\nLDFLAGS += $(LIBPTHREAD)\nendif\n\nifeq ($(MICROPY_PY_SSL),1)\nifeq ($(MICROPY_SSL_AXTLS),1)\n\nendif\nendif\n\n# If the variant enables it, enable modbluetooth.\nifeq ($(MICROPY_PY_BLUETOOTH),1)\nifeq ($(MICROPY_BLUETOOTH_BTSTACK),1)\nHAVE_LIBUSB := $(shell (which pkg-config > /dev/null && pkg-config --exists libusb-1.0) 2>/dev/null && echo '1')\n\n# Figure out which BTstack transport to use.\nifeq ($(HAVE_LIBUSB),1)\n# Default to btstack-over-usb.\nMICROPY_BLUETOOTH_BTSTACK_USB ?= 1\nelse\n# Fallback to HCI controller via a H4 UART (e.g. Zephyr on nRF) over a /dev/tty serial port.\nMICROPY_BLUETOOTH_BTSTACK_H4 ?= 1\nendif\n\nSRC_BTSTACK_C += lib/btstack/platform/embedded/btstack_run_loop_embedded.c\nendif\nendif\n\nifeq ($(MICROPY_PY_FFI),1)\n\nifeq ($(MICROPY_STANDALONE),1)\n# Build libffi from source.\nGIT_SUBMODULES += lib/libffi\nDEPLIBS += libffi\nLIBFFI_CFLAGS := -I$(shell ls -1d $(BUILD)/lib/libffi/out/lib/libffi-*/include)\n ifeq ($(MICROPY_FORCE_32BIT),1)\n  LIBFFI_LDFLAGS = $(BUILD)/lib/libffi/out/lib32/libffi.a\n else\n  LIBFFI_LDFLAGS = $(BUILD)/lib/libffi/out/lib/libffi.a\n endif\nelse\n# Use system version of libffi.\nLIBFFI_CFLAGS := $(shell pkg-config --cflags libffi)\nLIBFFI_LDFLAGS := $(shell pkg-config --libs libffi)\nendif\n\nifeq ($(UNAME_S),Linux)\nLIBFFI_LDFLAGS += -ldl\nendif\n\nCFLAGS += $(LIBFFI_CFLAGS) -DMICROPY_PY_FFI=1\nLDFLAGS += $(LIBFFI_LDFLAGS)\nendif\n\nifeq ($(MICROPY_PY_JNI),1)\n# Path for 64-bit OpenJDK, should be adjusted for other JDKs\nCFLAGS += -I/usr/lib/jvm/java-7-openjdk-amd64/include -DMICROPY_PY_JNI=1\nendif\n\n# source files\nSRC_C += \\\n\tmain.c \\\n\tgccollect.c \\\n\tunix_mphal.c \\\n\tmpthreadport.c \\\n\tinput.c \\\n\talloc.c \\\n\tfatfs_port.c \\\n\tmpbthciport.c \\\n\tmpbtstackport_common.c \\\n\tmpbtstackport_h4.c \\\n\tmpbtstackport_usb.c \\\n\tmpnimbleport.c \\\n\tmodtermios.c \\\n\tmodsocket.c \\\n\tmodffi.c \\\n\tmodjni.c \\\n\tmodanvil.c \\\n\t$(wildcard $(VARIANT_DIR)/*.c)\n\nSHARED_SRC_C += $(addprefix shared/,\\\n\truntime/gchelper_generic.c \\\n\ttimeutils/timeutils.c \\\n\t$(SHARED_SRC_C_EXTRA) \\\n\t)\n\nSRC_CXX += \\\n\nOBJ = $(PY_O)\nOBJ += $(addprefix $(BUILD)/, $(SRC_C:.c=.o))\nOBJ += $(addprefix $(BUILD)/, $(SRC_CXX:.cpp=.o))\nOBJ += $(addprefix $(BUILD)/, $(SHARED_SRC_C:.c=.o))\n\n# List of sources for qstr extraction\nSRC_QSTR += $(SRC_C) $(SRC_CXX) $(SHARED_SRC_C)\n\nifneq ($(FROZEN_MANIFEST),)\nCFLAGS += -DMPZ_DIG_SIZE=16 # force 16 bits to work on both 32 and 64 bit archs\nendif\n\nCXXFLAGS += $(filter-out -Wmissing-prototypes -Wold-style-definition -std=gnu99,$(CFLAGS) $(CXXFLAGS_MOD))\n\nifeq ($(MICROPY_FORCE_32BIT),1)\nRUN_TESTS_MPY_CROSS_FLAGS = --mpy-cross-flags='-march=x86'\nendif\n\nifeq ($(CROSS_COMPILE),arm-linux-gnueabi-)\n# Force disable error text compression when compiling for ARM as the compiler\n# cannot optimise out the giant strcmp list generated for MP_MATCH_COMPRESSED.\n# Checked on:\n# arm-linux-gnueabi-gcc (Ubuntu/Linaro 7.5.0-3ubuntu1~18.04) 7.5.0\n# arm-linux-gnueabi-gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0\n# See https://github.com/micropython/micropython/pull/7659 for details.\n$(info Detected arm-linux-gnueabi-gcc. Disabling error message compression.)\nMICROPY_ROM_TEXT_COMPRESSION = 0\nendif\n\ninclude $(TOP)/py/mkrules.mk\n\n.PHONY: test test_full\n\ntest: $(BUILD)/$(PROG) $(TOP)/tests/run-tests.py\n\t$(eval DIRNAME=ports/$(notdir $(CURDIR)))\n\tcd $(TOP)/tests && MICROPY_MICROPYTHON=../$(DIRNAME)/$(BUILD)/$(PROG) ./run-tests.py\n\ntest_full: $(BUILD)/$(PROG) $(TOP)/tests/run-tests.py\n\t$(eval DIRNAME=ports/$(notdir $(CURDIR)))\n\tcd $(TOP)/tests && MICROPY_MICROPYTHON=../$(DIRNAME)/$(BUILD)/$(PROG) ./run-tests.py\n\tcd $(TOP)/tests && MICROPY_MICROPYTHON=../$(DIRNAME)/$(BUILD)/$(PROG) ./run-tests.py -d thread\n\tcd $(TOP)/tests && MICROPY_MICROPYTHON=../$(DIRNAME)/$(BUILD)/$(PROG) ./run-tests.py --emit native\n\tcd $(TOP)/tests && MICROPY_MICROPYTHON=../$(DIRNAME)/$(BUILD)/$(PROG) ./run-tests.py --via-mpy $(RUN_TESTS_MPY_CROSS_FLAGS) -d basics float micropython\n\tcd $(TOP)/tests && MICROPY_MICROPYTHON=../$(DIRNAME)/$(BUILD)/$(PROG) ./run-tests.py --via-mpy $(RUN_TESTS_MPY_CROSS_FLAGS) --emit native -d basics float micropython\n\tcat $(TOP)/tests/basics/0prelim.py | ./$(BUILD)/$(PROG) | grep -q 'abc'\n\ntest_gcov: test_full\n\tgcov -o $(BUILD)/py $(TOP)/py/*.c\n\tgcov -o $(BUILD)/extmod $(TOP)/extmod/*.c\n\n# Value of configure's --host= option (required for cross-compilation).\n# Deduce it from CROSS_COMPILE by default, but can be overridden.\nifneq ($(CROSS_COMPILE),)\nCROSS_COMPILE_HOST = --host=$(patsubst %-,%,$(CROSS_COMPILE))\nelse\nCROSS_COMPILE_HOST =\nendif\n\ndeplibs: $(DEPLIBS)\n\nlibffi: $(BUILD)/lib/libffi/include/ffi.h\n\n$(TOP)/lib/libffi/configure: $(TOP)/lib/libffi/autogen.sh\n\tcd $(TOP)/lib/libffi; ./autogen.sh\n\n# install-exec-recursive & install-data-am targets are used to avoid building\n# docs and depending on makeinfo\n$(BUILD)/lib/libffi/include/ffi.h: $(TOP)/lib/libffi/configure\n\tmkdir -p $(BUILD)/lib/libffi; cd $(BUILD)/lib/libffi; \\\n\t$(abspath $(TOP))/lib/libffi/configure $(CROSS_COMPILE_HOST) --prefix=$$PWD/out --disable-shared --disable-structs CC=\"$(CC)\" CXX=\"$(CXX)\" LD=\"$(LD)\" CFLAGS=\"-Os -fomit-frame-pointer -fstrict-aliasing -ffast-math -fno-exceptions\"; \\\n\t$(MAKE) install-exec-recursive; $(MAKE) -C include install-data-am\n\nPREFIX = /usr/local\nBINDIR = $(DESTDIR)$(PREFIX)/bin\n\ninstall: $(BUILD)/$(PROG)\n\tinstall -d $(BINDIR)\n\tinstall $(BUILD)/$(PROG) $(BINDIR)/$(PROG)\n\nuninstall:\n\t-rm $(BINDIR)/$(PROG)\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}