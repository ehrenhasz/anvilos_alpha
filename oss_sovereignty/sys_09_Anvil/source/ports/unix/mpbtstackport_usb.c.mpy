{
  "module_name": "mpbtstackport_usb.c",
  "hash_id": "08f142af231d0c82149cba73d2d02d36e68760c28507202571b381ee19b69023",
  "original_prompt": "Ingested from sys_09_Anvil/source/ports/unix/mpbtstackport_usb.c",
  "human_readable_source": " \n\n#include \"py/mpconfig.h\"\n\n#if MICROPY_PY_BLUETOOTH && MICROPY_BLUETOOTH_BTSTACK && MICROPY_BLUETOOTH_BTSTACK_USB\n\n#include <pthread.h>\n#include <unistd.h>\n\n#include \"py/runtime.h\"\n#include \"py/mperrno.h\"\n#include \"py/mphal.h\"\n\n#include \"lib/btstack/src/btstack.h\"\n#include \"lib/btstack/src/hci_transport_usb.h\"\n#include \"lib/btstack/platform/embedded/btstack_run_loop_embedded.h\"\n#include \"lib/btstack/platform/embedded/hal_cpu.h\"\n#include \"lib/btstack/platform/embedded/hal_time_ms.h\"\n\n#include \"extmod/btstack/modbluetooth_btstack.h\"\n\n#include \"mpbtstackport.h\"\n\n#if !MICROPY_PY_THREAD\n#error Unix btstack requires MICROPY_PY_THREAD\n#endif\n\nstatic const useconds_t USB_POLL_INTERVAL_US = 1000;\n\nvoid mp_bluetooth_btstack_port_init_usb(void) {\n    \n    char *path = getenv(\"MICROPYBTUSB\");\n    if (path != NULL) {\n        uint8_t usb_path[7] = {0};\n        size_t usb_path_len = 0;\n\n        while (usb_path_len < MP_ARRAY_SIZE(usb_path)) {\n            char *delimiter;\n            usb_path[usb_path_len++] = strtol(path, &delimiter, 16);\n            if (!delimiter || (*delimiter != ':' && *delimiter != '-')) {\n                break;\n            }\n            path = delimiter + 1;\n        }\n\n        hci_transport_usb_set_path(usb_path_len, usb_path);\n    }\n\n    hci_init(hci_transport_usb_instance(), NULL);\n}\n\nstatic pthread_t bstack_thread_id;\n\nvoid mp_bluetooth_btstack_port_deinit(void) {\n    hci_power_control(HCI_POWER_OFF);\n\n    \n    pthread_join(bstack_thread_id, NULL);\n}\n\n\n\nextern bool mp_bluetooth_hci_poll(void);\n\nstatic void *btstack_thread(void *arg) {\n    (void)arg;\n    hci_power_control(HCI_POWER_ON);\n\n    \n    \n    \n    \n    \n\n    while (true) {\n        if (!mp_bluetooth_hci_poll()) {\n            break;\n        }\n\n        \n        \n        usleep(USB_POLL_INTERVAL_US);\n    }\n    return NULL;\n}\n\nvoid mp_bluetooth_btstack_port_start(void) {\n    \n    pthread_attr_t attr;\n    pthread_attr_init(&attr);\n    pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);\n    pthread_create(&bstack_thread_id, &attr, &btstack_thread, NULL);\n}\n\n#endif \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}