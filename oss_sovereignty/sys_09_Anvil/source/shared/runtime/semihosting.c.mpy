{
  "module_name": "semihosting.c",
  "hash_id": "a55b7a7e84ba5d97f3a2c2baa6d8d6e0a2493a6cbc5c786f56e266ecc7a62324",
  "original_prompt": "Ingested from sys_09_Anvil/source/shared/runtime/semihosting.c",
  "human_readable_source": " \n\n#include \"semihosting.h\"\n\n\n\n\n\n\n#define SYS_OPEN   0x01\n#define SYS_WRITEC 0x03\n#define SYS_WRITE  0x05\n#define SYS_READC  0x07\n\n\n#define OPEN_MODE_READ  (0) \n#define OPEN_MODE_WRITE (4) \n\n#ifndef __thumb__\n#error Semihosting is only implemented for ARM microcontrollers.\n#endif\n\nstatic int mp_semihosting_stdout;\n\nstatic uint32_t mp_semihosting_call(uint32_t num, const void *arg) {\n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    register uint32_t num_reg __asm__ (\"r0\") = num;\n    register const void *args_reg __asm__ (\"r1\") = arg;\n    __asm__ __volatile__ (\n        \"bkpt 0xAB\\n\"         \n        : \"+r\" (num_reg)      \n        : \"r\" (args_reg)      \n        : \"memory\");          \n    return num_reg; \n}\n\nstatic int mp_semihosting_open_console(uint32_t mode) {\n    struct {\n        char *name;\n        uint32_t mode;\n        uint32_t name_len;\n    } args = {\n        .name = \":tt\",     \n        .mode = mode,      \n        .name_len = 3,     \n    };\n    return mp_semihosting_call(SYS_OPEN, &args);\n}\n\nvoid mp_semihosting_init() {\n    mp_semihosting_stdout = mp_semihosting_open_console(OPEN_MODE_WRITE);\n}\n\nint mp_semihosting_rx_char() {\n    return mp_semihosting_call(SYS_READC, NULL);\n}\n\nstatic void mp_semihosting_tx_char(char c) {\n    mp_semihosting_call(SYS_WRITEC, &c);\n}\n\nuint32_t mp_semihosting_tx_strn(const char *str, size_t len) {\n    if (len == 0) {\n        return 0; \n    }\n    if (len == 1) {\n        mp_semihosting_tx_char(*str); \n        return 0;\n    }\n\n    struct {\n        uint32_t fd;\n        const char *str;\n        uint32_t len;\n    } args = {\n        .fd = mp_semihosting_stdout,\n        .str = str,\n        .len = len,\n    };\n    return mp_semihosting_call(SYS_WRITE, &args);\n}\n\nuint32_t mp_semihosting_tx_strn_cooked(const char *str, size_t len) {\n    \n    \n    \n    \n    \n    size_t start = 0;\n    for (size_t i = 0; i < len; i++) {\n        if (str[i] == '\\n') {\n            mp_semihosting_tx_strn(str + start, i - start);\n            mp_semihosting_tx_char('\\r');\n            start = i;\n        }\n    }\n    return mp_semihosting_tx_strn(str + start, len - start);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}