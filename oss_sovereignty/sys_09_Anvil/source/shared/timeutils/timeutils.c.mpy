{
  "module_name": "timeutils.c",
  "hash_id": "7d4ddf17435304d8a1e564e14599b164b9874f95f29e8d956911d62d527d7cc3",
  "original_prompt": "Ingested from sys_09_Anvil/source/shared/timeutils/timeutils.c",
  "human_readable_source": " \n\n#include \"py/obj.h\"\n\n#include \"shared/timeutils/timeutils.h\"\n\n\n\n\n\n\n#define LEAPOCH ((31 + 29) * 86400)\n\n#define DAYS_PER_400Y (365 * 400 + 97)\n#define DAYS_PER_100Y (365 * 100 + 24)\n#define DAYS_PER_4Y   (365 * 4 + 1)\n\nstatic const uint16_t days_since_jan1[] = { 0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365 };\n\nbool timeutils_is_leap_year(mp_uint_t year) {\n    return (year % 4 == 0 && year % 100 != 0) || year % 400 == 0;\n}\n\n\nmp_uint_t timeutils_days_in_month(mp_uint_t year, mp_uint_t month) {\n    mp_uint_t mdays = days_since_jan1[month] - days_since_jan1[month - 1];\n    if (month == 2 && timeutils_is_leap_year(year)) {\n        mdays++;\n    }\n    return mdays;\n}\n\n\n\nmp_uint_t timeutils_year_day(mp_uint_t year, mp_uint_t month, mp_uint_t date) {\n    mp_uint_t yday = days_since_jan1[month - 1] + date;\n    if (month >= 3 && timeutils_is_leap_year(year)) {\n        yday += 1;\n    }\n    return yday;\n}\n\nvoid timeutils_seconds_since_2000_to_struct_time(mp_uint_t t, timeutils_struct_time_t *tm) {\n    \n    \n\n    mp_int_t seconds = t - LEAPOCH;\n\n    mp_int_t days = seconds / 86400;\n    seconds %= 86400;\n    if (seconds < 0) {\n        seconds += 86400;\n        days -= 1;\n    }\n    tm->tm_hour = seconds / 3600;\n    tm->tm_min = seconds / 60 % 60;\n    tm->tm_sec = seconds % 60;\n\n    mp_int_t wday = (days + 2) % 7;   \n    if (wday < 0) {\n        wday += 7;\n    }\n    tm->tm_wday = wday;\n\n    mp_int_t qc_cycles = days / DAYS_PER_400Y;\n    days %= DAYS_PER_400Y;\n    if (days < 0) {\n        days += DAYS_PER_400Y;\n        qc_cycles--;\n    }\n    mp_int_t c_cycles = days / DAYS_PER_100Y;\n    if (c_cycles == 4) {\n        c_cycles--;\n    }\n    days -= (c_cycles * DAYS_PER_100Y);\n\n    mp_int_t q_cycles = days / DAYS_PER_4Y;\n    if (q_cycles == 25) {\n        q_cycles--;\n    }\n    days -= q_cycles * DAYS_PER_4Y;\n\n    mp_int_t years = days / 365;\n    if (years == 4) {\n        years--;\n    }\n    days -= (years * 365);\n\n     \n\n    tm->tm_year = 2000 + years + 4 * q_cycles + 100 * c_cycles + 400 * qc_cycles;\n\n    \n    static const int8_t days_in_month[] = {31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 29};\n\n    mp_int_t month;\n    for (month = 0; days_in_month[month] <= days; month++) {\n        days -= days_in_month[month];\n    }\n\n    tm->tm_mon = month + 2;\n    if (tm->tm_mon >= 12) {\n        tm->tm_mon -= 12;\n        tm->tm_year++;\n    }\n    tm->tm_mday = days + 1; \n    tm->tm_mon++;   \n\n    tm->tm_yday = timeutils_year_day(tm->tm_year, tm->tm_mon, tm->tm_mday);\n}\n\n\nmp_uint_t timeutils_seconds_since_2000(mp_uint_t year, mp_uint_t month,\n    mp_uint_t date, mp_uint_t hour, mp_uint_t minute, mp_uint_t second) {\n    return\n        second\n        + minute * 60\n        + hour * 3600\n        + (timeutils_year_day(year, month, date) - 1\n            + ((year - 2000 + 3) / 4) \n            - ((year - 2000 + 99) / 100) \n            + ((year - 2000 + 399) / 400) \n            ) * 86400\n        + (year - 2000) * 31536000;\n}\n\nmp_uint_t timeutils_mktime_2000(mp_uint_t year, mp_int_t month, mp_int_t mday,\n    mp_int_t hours, mp_int_t minutes, mp_int_t seconds) {\n\n    \n    \n    \n    \n    \n    \n    \n    \n    \n\n    minutes += seconds / 60;\n    if ((seconds = seconds % 60) < 0) {\n        seconds += 60;\n        minutes--;\n    }\n\n    hours += minutes / 60;\n    if ((minutes = minutes % 60) < 0) {\n        minutes += 60;\n        hours--;\n    }\n\n    mday += hours / 24;\n    if ((hours = hours % 24) < 0) {\n        hours += 24;\n        mday--;\n    }\n\n    month--; \n    year += month / 12;\n    if ((month = month % 12) < 0) {\n        month += 12;\n        year--;\n    }\n    month++; \n\n    while (mday < 1) {\n        if (--month == 0) {\n            month = 12;\n            year--;\n        }\n        mday += timeutils_days_in_month(year, month);\n    }\n    while ((mp_uint_t)mday > timeutils_days_in_month(year, month)) {\n        mday -= timeutils_days_in_month(year, month);\n        if (++month == 13) {\n            month = 1;\n            year++;\n        }\n    }\n    return timeutils_seconds_since_2000(year, month, mday, hours, minutes, seconds);\n}\n\n\n\n\nint timeutils_calc_weekday(int y, int m, int d) {\n    return ((d += m < 3 ? y-- : y - 2, 23 * m / 9 + d + 4 + y / 4 - y / 100 + y / 400) + 6) % 7;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}