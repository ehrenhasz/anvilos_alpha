{
  "module_name": "dht.c",
  "hash_id": "330ccccc1f0d37bc7d6195ab38b429382ecd4948842c7a72de8dd4f78aa7097b",
  "original_prompt": "Ingested from sys_09_Anvil/source/drivers/dht/dht.c",
  "human_readable_source": " \n\n#include <stdio.h>\n\n#include \"py/runtime.h\"\n#include \"py/mperrno.h\"\n#include \"py/mphal.h\"\n\n#if MICROPY_PY_MACHINE_PULSE\n\n#include \"extmod/modmachine.h\"\n#include \"drivers/dht/dht.h\"\n\n\n#ifndef mp_hal_pin_od_high_dht\n#define mp_hal_pin_od_high_dht mp_hal_pin_od_high\n#endif\n\nstatic mp_obj_t dht_readinto(mp_obj_t pin_in, mp_obj_t buf_in) {\n    mp_hal_pin_obj_t pin = mp_hal_get_pin_obj(pin_in);\n    mp_hal_pin_open_drain(pin);\n\n    mp_buffer_info_t bufinfo;\n    mp_get_buffer_raise(buf_in, &bufinfo, MP_BUFFER_WRITE);\n\n    if (bufinfo.len < 5) {\n        mp_raise_ValueError(MP_ERROR_TEXT(\"buffer too small\"));\n    }\n\n    \n    mp_hal_pin_od_high_dht(pin);\n    mp_hal_delay_ms(250);\n    mp_hal_pin_od_low(pin);\n    mp_hal_delay_ms(18);\n\n    mp_uint_t irq_state = mp_hal_quiet_timing_enter();\n\n    \n    mp_hal_pin_od_high_dht(pin);\n    mp_hal_delay_us_fast(10);\n\n    \n    mp_uint_t ticks = mp_hal_ticks_us();\n    while (mp_hal_pin_read(pin) != 0) {\n        if ((mp_uint_t)(mp_hal_ticks_us() - ticks) > 100) {\n            goto timeout;\n        }\n    }\n\n    \n    ticks = machine_time_pulse_us(pin, 1, 150);\n    if ((mp_int_t)ticks < 0) {\n        goto timeout;\n    }\n\n    \n    uint8_t *buf = bufinfo.buf;\n    for (int i = 0; i < 40; ++i) {\n        ticks = machine_time_pulse_us(pin, 1, 100);\n        if ((mp_int_t)ticks < 0) {\n            goto timeout;\n        }\n        buf[i / 8] = (buf[i / 8] << 1) | (ticks > 48);\n    }\n\n    mp_hal_quiet_timing_exit(irq_state);\n    return mp_const_none;\n\ntimeout:\n    mp_hal_quiet_timing_exit(irq_state);\n    mp_raise_OSError(MP_ETIMEDOUT);\n}\nMP_DEFINE_CONST_FUN_OBJ_2(dht_readinto_obj, dht_readinto);\n\n#endif \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}