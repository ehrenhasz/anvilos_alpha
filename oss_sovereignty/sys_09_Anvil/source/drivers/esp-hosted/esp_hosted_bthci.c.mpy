{
  "module_name": "esp_hosted_bthci.c",
  "hash_id": "eaebfe10c9b4188a6f0c4e569b46f293720c6943eca26077c306f57da3514548",
  "original_prompt": "Ingested from sys_09_Anvil/source/drivers/esp-hosted/esp_hosted_bthci.c",
  "human_readable_source": " \n\n#include \"py/mphal.h\"\n\n#if MICROPY_PY_BLUETOOTH && MICROPY_PY_NETWORK_ESP_HOSTED\n\n#include <stdio.h>\n#include <string.h>\n\n#include \"py/runtime.h\"\n#include \"extmod/mpbthci.h\"\n#include \"esp_hosted_hal.h\"\n\n#define HCI_COMMAND_PACKET      (0x01)\n#define HCI_ACLDATA_PACKET      (0x02)\n#define HCI_EVENT_PACKET        (0x04)\n\n#define HCI_COMMAND_COMPLETE    (0x0e)\n#define HCI_COMMAND_TIMEOUT     (3000)\n\n#define OGF_LINK_CTL            (0x01)\n#define OGF_HOST_CTL            (0x03)\n\n#define OCF_SET_EVENT_MASK      (0x0001)\n#define OCF_RESET               (0x0003)\n\n\nextern uint8_t mp_bluetooth_hci_cmd_buf[4 + 256];\n\nint esp_hosted_hci_cmd(int ogf, int ocf, size_t param_len, const uint8_t *param_buf) {\n    uint8_t *buf = mp_bluetooth_hci_cmd_buf;\n\n    buf[0] = HCI_COMMAND_PACKET;\n    buf[1] = ocf;\n    buf[2] = ogf << 2 | ocf >> 8;\n    buf[3] = param_len;\n\n    if (param_len) {\n        memcpy(buf + 4, param_buf, param_len);\n    }\n\n    debug_printf(\"HCI Command: %02x %02x %02x %02x\\n\", buf[0], buf[1], buf[2], buf[3]);\n\n    mp_bluetooth_hci_uart_write(buf, 4 + param_len);\n\n    \n    for (mp_uint_t start = mp_hal_ticks_ms(), size = 3, i = 0; i < size;) {\n        while (!mp_bluetooth_hci_uart_any()) {\n            MICROPY_EVENT_POLL_HOOK\n            \n            if ((mp_hal_ticks_ms() - start) > HCI_COMMAND_TIMEOUT) {\n                error_printf(\"timeout waiting for HCI packet\\n\");\n                return -1;\n            }\n        }\n\n        buf[i] = mp_bluetooth_hci_uart_readchar();\n\n        \n        if (i == 0 && buf[0] == 0xFF) {\n            continue;\n        }\n\n        \n        if (i == 0 && buf[0] != HCI_EVENT_PACKET) {\n            error_printf(\"unexpected HCI packet: %02x\\n\", buf[0]);\n            return -1;\n        }\n\n        \n        if (i == 2 && ((size += buf[2]) > sizeof(mp_bluetooth_hci_cmd_buf))) {\n            error_printf(\"unexpected event packet length: %d\\n\", size);\n            return -1;\n        }\n\n        i++;\n    }\n\n    \n    if (buf[1] != HCI_COMMAND_COMPLETE || buf[4] != ocf || buf[5] != (ogf << 2 | ocf >> 8)) {\n        error_printf(\"response mismatch: %02x %02x\\n\", buf[4], buf[5]);\n        return -1;\n    }\n\n    \n    debug_printf(\"HCI Event packet: %02x %02x %02x %02x %02x %02x %02x\\n\",\n        buf[0], buf[1], buf[2], buf[3], buf[4], buf[5], buf[6]);\n\n    \n    return buf[6];\n}\n\nint mp_bluetooth_hci_controller_init(void) {\n    \n    esp_hosted_hal_init(ESP_HOSTED_MODE_BT);\n\n    mp_uint_t start = mp_hal_ticks_ms();\n    \n    while ((mp_hal_ticks_ms() - start) < 2500) {\n        if (mp_bluetooth_hci_uart_any()) {\n            mp_bluetooth_hci_uart_readchar();\n        }\n        MICROPY_EVENT_POLL_HOOK\n    }\n\n    #ifdef MICROPY_HW_BLE_UART_BAUDRATE_SECONDARY\n    mp_bluetooth_hci_uart_set_baudrate(MICROPY_HW_BLE_UART_BAUDRATE_SECONDARY);\n    #endif\n\n    mp_hal_pin_output(MICROPY_HW_BLE_UART_RTS);\n    mp_hal_pin_write(MICROPY_HW_BLE_UART_RTS, 0);\n\n    \n    \n    return esp_hosted_hci_cmd(OGF_HOST_CTL, OCF_RESET, 0, NULL);\n}\n\nint mp_bluetooth_hci_controller_deinit(void) {\n    esp_hosted_hal_deinit();\n    return 0;\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}