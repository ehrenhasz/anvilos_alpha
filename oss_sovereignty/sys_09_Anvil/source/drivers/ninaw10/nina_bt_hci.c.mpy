{
  "module_name": "nina_bt_hci.c",
  "hash_id": "b8f08b0e9cac689f2f264ffe2d4dd8eef9e18e561b056bc4da22f85f5df8f16a",
  "original_prompt": "Ingested from sys_09_Anvil/source/drivers/ninaw10/nina_bt_hci.c",
  "human_readable_source": " \n\n#include \"py/mphal.h\"\n\n#if MICROPY_PY_BLUETOOTH && MICROPY_PY_NETWORK_NINAW10\n\n#include <stdio.h>\n#include <string.h>\n\n#include \"py/runtime.h\"\n#include \"extmod/mpbthci.h\"\n\n#define HCI_COMMAND_PACKET      (0x01)\n#define HCI_ACLDATA_PACKET      (0x02)\n#define HCI_EVENT_PACKET        (0x04)\n\n#define HCI_COMMAND_COMPLETE    (0x0e)\n#define HCI_COMMAND_TIMEOUT     (3000)\n\n#define OGF_LINK_CTL            (0x01)\n#define OGF_HOST_CTL            (0x03)\n\n#define OCF_SET_EVENT_MASK      (0x0001)\n#define OCF_RESET               (0x0003)\n\n#define error_printf(...)   \n#define debug_printf(...)   \n\n\nextern uint8_t mp_bluetooth_hci_cmd_buf[4 + 256];\n\nstatic int nina_hci_cmd(int ogf, int ocf, size_t param_len, const uint8_t *param_buf) {\n    uint8_t *buf = mp_bluetooth_hci_cmd_buf;\n\n    buf[0] = HCI_COMMAND_PACKET;\n    buf[1] = ocf;\n    buf[2] = ogf << 2 | ocf >> 8;\n    buf[3] = param_len;\n\n    if (param_len) {\n        memcpy(buf + 4, param_buf, param_len);\n    }\n\n    debug_printf(\"HCI Command: %02x %02x %02x %02x\\n\", buf[0], buf[1], buf[2], buf[3]);\n\n    mp_bluetooth_hci_uart_write(buf, 4 + param_len);\n\n    \n    for (mp_uint_t start = mp_hal_ticks_ms(), size = 3, i = 0; i < size;) {\n        while (!mp_bluetooth_hci_uart_any()) {\n            mp_uint_t elapsed = mp_hal_ticks_ms() - start;\n            \n            if (elapsed > HCI_COMMAND_TIMEOUT) {\n                error_printf(\"timeout waiting for HCI packet\\n\");\n                return -1;\n            }\n            mp_event_wait_ms(HCI_COMMAND_TIMEOUT - elapsed);\n        }\n\n        buf[i] = mp_bluetooth_hci_uart_readchar();\n\n        \n        if (i == 0 && (buf[0] == 0xFF || buf[0] == 0xFE)) {\n            continue;\n        }\n\n        \n        if (i == 0 && buf[0] != HCI_EVENT_PACKET) {\n            error_printf(\"unexpected HCI packet: %02x\\n\", buf[0]);\n            return -1;\n        }\n\n        \n        if (i == 2 && ((size += buf[2]) > sizeof(mp_bluetooth_hci_cmd_buf))) {\n            error_printf(\"unexpected event packet length: %d\\n\", size);\n            return -1;\n        }\n\n        i++;\n    }\n\n    \n    if (buf[1] != HCI_COMMAND_COMPLETE || buf[4] != ocf || buf[5] != (ogf << 2 | ocf >> 8)) {\n        error_printf(\"response mismatch: %02x %02x\\n\", buf[4], buf[5]);\n        return -1;\n    }\n\n    \n    debug_printf(\"HCI Event packet: %02x %02x %02x %02x %02x %02x %02x\\n\",\n        buf[0], buf[1], buf[2], buf[3], buf[4], buf[5], buf[6]);\n\n    \n    return buf[6];\n}\n\nint mp_bluetooth_hci_controller_init(void) {\n    \n    mp_hal_pin_output(MICROPY_HW_NINA_RESET);\n    mp_hal_pin_write(MICROPY_HW_NINA_RESET, 0);\n\n    mp_hal_pin_output(MICROPY_HW_NINA_GPIO1);\n    mp_hal_pin_write(MICROPY_HW_NINA_GPIO1, 0);\n    mp_hal_delay_ms(150);\n\n    mp_hal_pin_write(MICROPY_HW_NINA_RESET, 1);\n    mp_hal_delay_ms(750);\n\n    \n    \n    mp_bluetooth_hci_uart_init(MICROPY_HW_BLE_UART_ID, MICROPY_HW_BLE_UART_BAUDRATE);\n\n    \n    return nina_hci_cmd(OGF_HOST_CTL, OCF_RESET, 0, NULL);\n    \n}\n\nint mp_bluetooth_hci_controller_deinit(void) {\n    \n    mp_hal_pin_output(MICROPY_HW_NINA_RESET);\n    mp_hal_pin_write(MICROPY_HW_NINA_RESET, 0);\n    return 0;\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}