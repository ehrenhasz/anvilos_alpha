{
  "module_name": "softspi.c",
  "hash_id": "70fe9983e7d699b8f35c923ec91ff3e7850e2dbf20427f57143d9aef730413f7",
  "original_prompt": "Ingested from sys_09_Anvil/source/drivers/bus/softspi.c",
  "human_readable_source": " \n\n#include \"drivers/bus/spi.h\"\n\nint mp_soft_spi_ioctl(void *self_in, uint32_t cmd) {\n    mp_soft_spi_obj_t *self = (mp_soft_spi_obj_t*)self_in;\n\n    switch (cmd) {\n        case MP_SPI_IOCTL_INIT:\n            mp_hal_pin_write(self->sck, self->polarity);\n            mp_hal_pin_output(self->sck);\n            mp_hal_pin_output(self->mosi);\n            mp_hal_pin_input(self->miso);\n            break;\n\n        case MP_SPI_IOCTL_DEINIT:\n            break;\n    }\n\n    return 0;\n}\n\nvoid mp_soft_spi_transfer(void *self_in, size_t len, const uint8_t *src, uint8_t *dest) {\n    mp_soft_spi_obj_t *self = (mp_soft_spi_obj_t*)self_in;\n    uint32_t delay_half = self->delay_half;\n\n    \n\n    \n    \n    \n    #ifdef MICROPY_HW_SOFTSPI_MIN_DELAY\n    if (delay_half == MICROPY_HW_SOFTSPI_MIN_DELAY) {\n        for (size_t i = 0; i < len; ++i) {\n            uint8_t data_out = src[i];\n            uint8_t data_in = 0;\n            for (int j = 0; j < 8; ++j, data_out <<= 1) {\n                mp_hal_pin_write(self->mosi, (data_out >> 7) & 1);\n                mp_hal_pin_write(self->sck, 1 - self->polarity);\n                data_in = (data_in << 1) | mp_hal_pin_read(self->miso);\n                mp_hal_pin_write(self->sck, self->polarity);\n            }\n            if (dest != NULL) {\n                dest[i] = data_in;\n            }\n        }\n        return;\n    }\n    #endif\n\n    for (size_t i = 0; i < len; ++i) {\n        uint8_t data_out = src[i];\n        uint8_t data_in = 0;\n        for (int j = 0; j < 8; ++j, data_out <<= 1) {\n            mp_hal_pin_write(self->mosi, (data_out >> 7) & 1);\n            if (self->phase == 0) {\n                mp_hal_delay_us_fast(delay_half);\n                mp_hal_pin_write(self->sck, 1 - self->polarity);\n            } else {\n                mp_hal_pin_write(self->sck, 1 - self->polarity);\n                mp_hal_delay_us_fast(delay_half);\n            }\n            data_in = (data_in << 1) | mp_hal_pin_read(self->miso);\n            if (self->phase == 0) {\n                mp_hal_delay_us_fast(delay_half);\n                mp_hal_pin_write(self->sck, self->polarity);\n            } else {\n                mp_hal_pin_write(self->sck, self->polarity);\n                mp_hal_delay_us_fast(delay_half);\n            }\n        }\n        if (dest != NULL) {\n            dest[i] = data_in;\n        }\n    }\n}\n\nconst mp_spi_proto_t mp_soft_spi_proto = {\n    .ioctl = mp_soft_spi_ioctl,\n    .transfer = mp_soft_spi_transfer,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}