{
  "module_name": "softqspi.c",
  "hash_id": "9a93fa20a534da3170191f5db71098292ed24ac8c58fc4f0272b77082e9d2ebe",
  "original_prompt": "Ingested from sys_09_Anvil/source/drivers/bus/softqspi.c",
  "human_readable_source": " \n\n#include \"drivers/bus/qspi.h\"\n\n#define CS_LOW(self) mp_hal_pin_write(self->cs, 0)\n#define CS_HIGH(self) mp_hal_pin_write(self->cs, 1)\n\n#ifdef MICROPY_HW_SOFTQSPI_SCK_LOW\n\n\n#define SCK_LOW(self) MICROPY_HW_SOFTQSPI_SCK_LOW(self)\n#define SCK_HIGH(self) MICROPY_HW_SOFTQSPI_SCK_HIGH(self)\n#define NIBBLE_READ(self) MICROPY_HW_SOFTQSPI_NIBBLE_READ(self)\n\n#else\n\n\n#define SCK_LOW(self) mp_hal_pin_write(self->clk, 0)\n#define SCK_HIGH(self) mp_hal_pin_write(self->clk, 1)\n#define NIBBLE_READ(self) ( \\\n    mp_hal_pin_read(self->io0) \\\n    | (mp_hal_pin_read(self->io1) << 1) \\\n    | (mp_hal_pin_read(self->io2) << 2) \\\n    | (mp_hal_pin_read(self->io3) << 3))\n\n#endif\n\nstatic void nibble_write(mp_soft_qspi_obj_t *self, uint8_t v) {\n    mp_hal_pin_write(self->io0, v & 1);\n    mp_hal_pin_write(self->io1, (v >> 1) & 1);\n    mp_hal_pin_write(self->io2, (v >> 2) & 1);\n    mp_hal_pin_write(self->io3, (v >> 3) & 1);\n}\n\nstatic int mp_soft_qspi_ioctl(void *self_in, uint32_t cmd) {\n    mp_soft_qspi_obj_t *self = (mp_soft_qspi_obj_t*)self_in;\n\n    switch (cmd) {\n        case MP_QSPI_IOCTL_INIT:\n            mp_hal_pin_high(self->cs);\n            mp_hal_pin_output(self->cs);\n\n            \n            mp_hal_pin_write(self->clk, 0);\n            mp_hal_pin_output(self->clk);\n            \n            mp_hal_pin_output(self->io0);\n            mp_hal_pin_input(self->io1);\n            mp_hal_pin_write(self->io2, 1);\n            mp_hal_pin_output(self->io2);\n            mp_hal_pin_write(self->io3, 1);\n            mp_hal_pin_output(self->io3);\n            break;\n    }\n\n    return 0; \n}\n\nstatic void mp_soft_qspi_transfer(mp_soft_qspi_obj_t *self, size_t len, const uint8_t *src, uint8_t *dest) {\n    \n    mp_hal_pin_input(self->io1);\n    mp_hal_pin_output(self->io0);\n    if (self->io3) {\n        mp_hal_pin_write(self->io2, 1);\n        mp_hal_pin_output(self->io2);\n        mp_hal_pin_write(self->io3, 1);\n        mp_hal_pin_output(self->io3);\n    }\n    if (src) {\n        for (size_t i = 0; i < len; ++i) {\n            uint8_t data_out = src[i];\n            uint8_t data_in = 0;\n            for (int j = 0; j < 8; ++j, data_out <<= 1) {\n                mp_hal_pin_write(self->io0, (data_out >> 7) & 1);\n                mp_hal_pin_write(self->clk, 1);\n                data_in = (data_in << 1) | mp_hal_pin_read(self->io1);\n                mp_hal_pin_write(self->clk, 0);\n            }\n            if (dest != NULL) {\n                dest[i] = data_in;\n            }\n        }\n    } else {\n        for (size_t i = 0; i < len; ++i) {\n            uint8_t data_in = 0;\n            for (int j = 0; j < 8; ++j) {\n                mp_hal_pin_write(self->clk, 1);\n                data_in = (data_in << 1) | mp_hal_pin_read(self->io1);\n                mp_hal_pin_write(self->clk, 0);\n            }\n            if (dest != NULL) {\n                dest[i] = data_in;\n            }\n        }\n    }\n}\n\nstatic void mp_soft_qspi_qread(mp_soft_qspi_obj_t *self, size_t len, uint8_t *buf) {\n    \n    mp_hal_pin_input(self->io2);\n    mp_hal_pin_input(self->io3);\n    mp_hal_pin_input(self->io0);\n    mp_hal_pin_input(self->io1);\n\n    \n    while (len--) {\n        SCK_HIGH(self);\n        uint8_t data_in = NIBBLE_READ(self);\n        SCK_LOW(self);\n        SCK_HIGH(self);\n        *buf++ = (data_in << 4) | NIBBLE_READ(self);\n        SCK_LOW(self);\n    }\n}\n\nstatic void mp_soft_qspi_qwrite(mp_soft_qspi_obj_t *self, size_t len, const uint8_t *buf) {\n    \n    mp_hal_pin_output(self->io2);\n    mp_hal_pin_output(self->io3);\n    mp_hal_pin_output(self->io0);\n    mp_hal_pin_output(self->io1);\n\n    \n    for (size_t i = 0; i < len; ++i) {\n        nibble_write(self, buf[i] >> 4);\n        SCK_HIGH(self);\n        SCK_LOW(self);\n\n        nibble_write(self, buf[i]);\n        SCK_HIGH(self);\n        SCK_LOW(self);\n    }\n\n    \n}\n\nstatic int mp_soft_qspi_write_cmd_data(void *self_in, uint8_t cmd, size_t len, uint32_t data) {\n    mp_soft_qspi_obj_t *self = (mp_soft_qspi_obj_t*)self_in;\n    uint32_t cmd_buf = cmd | data << 8;\n    CS_LOW(self);\n    mp_soft_qspi_transfer(self, 1 + len, (uint8_t*)&cmd_buf, NULL);\n    CS_HIGH(self);\n    return 0;\n}\n\nstatic int mp_soft_qspi_write_cmd_addr_data(void *self_in, uint8_t cmd, uint32_t addr, size_t len, const uint8_t *src) {\n    mp_soft_qspi_obj_t *self = (mp_soft_qspi_obj_t*)self_in;\n    uint8_t cmd_buf[5] = {cmd};\n    uint8_t addr_len = mp_spi_set_addr_buff(&cmd_buf[1], addr);\n    CS_LOW(self);\n    mp_soft_qspi_transfer(self, addr_len + 1, cmd_buf, NULL);\n    mp_soft_qspi_transfer(self, len, src, NULL);\n    CS_HIGH(self);\n    return 0;\n}\n\nstatic int mp_soft_qspi_read_cmd(void *self_in, uint8_t cmd, size_t len, uint32_t *dest) {\n    mp_soft_qspi_obj_t *self = (mp_soft_qspi_obj_t*)self_in;\n    uint32_t cmd_buf = cmd;\n    CS_LOW(self);\n    mp_soft_qspi_transfer(self, 1 + len, (uint8_t*)&cmd_buf, (uint8_t*)&cmd_buf);\n    CS_HIGH(self);\n    *dest = cmd_buf >> 8;\n    return 0;\n}\n\nstatic int mp_soft_qspi_read_cmd_qaddr_qdata(void *self_in, uint8_t cmd, uint32_t addr, size_t len, uint8_t *dest) {\n    mp_soft_qspi_obj_t *self = (mp_soft_qspi_obj_t*)self_in;\n    uint8_t cmd_buf[7] = {cmd};\n    uint8_t addr_len = mp_spi_set_addr_buff(&cmd_buf[1], addr);\n    CS_LOW(self);\n    mp_soft_qspi_transfer(self, 1, cmd_buf, NULL);\n    mp_soft_qspi_qwrite(self, addr_len + 3, &cmd_buf[1]); \n    mp_soft_qspi_qread(self, len, dest);\n    CS_HIGH(self);\n    return 0;\n}\n\nconst mp_qspi_proto_t mp_soft_qspi_proto = {\n    .ioctl = mp_soft_qspi_ioctl,\n    .write_cmd_data = mp_soft_qspi_write_cmd_data,\n    .write_cmd_addr_data = mp_soft_qspi_write_cmd_addr_data,\n    .read_cmd = mp_soft_qspi_read_cmd,\n    .read_cmd_qaddr_qdata = mp_soft_qspi_read_cmd_qaddr_qdata,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}