{
  "module_name": "linkat.m4",
  "hash_id": "be6c04187fcdd6680a1a5c20f2e57f78a25d3278e7e89a651a1895663a574902",
  "original_prompt": "Ingested from coreutils-9.4/m4/linkat.m4",
  "human_readable_source": "# serial 17\n# See if we need to provide linkat replacement.\n\ndnl Copyright (C) 2009-2023 Free Software Foundation, Inc.\ndnl This file is free software; the Free Software Foundation\ndnl gives unlimited permission to copy and/or distribute it,\ndnl with or without modifications, as long as this notice is preserved.\n\n# Written by Eric Blake.\n\nAC_DEFUN([gl_FUNC_LINKAT],\n[\n  AC_REQUIRE([gl_FUNC_OPENAT])\n  AC_REQUIRE([gl_FUNC_LINK_FOLLOWS_SYMLINK])\n  AC_REQUIRE([gl_UNISTD_H_DEFAULTS])\n  AC_REQUIRE([gl_USE_SYSTEM_EXTENSIONS])\n  AC_REQUIRE([AC_CANONICAL_HOST]) dnl for cross-compiles\n  AC_CHECK_FUNCS_ONCE([symlink])\n  gl_CHECK_FUNCS_ANDROID([linkat], [[#include <unistd.h>]])\n  if test $ac_cv_func_linkat = no; then\n    HAVE_LINKAT=0\n    case \"$gl_cv_onwards_func_linkat\" in\n      future*) REPLACE_LINKAT=1 ;;\n    esac\n  else\n    dnl OS X Yosemite has linkat() but it's not sufficient\n    dnl to our needs since it doesn't support creating\n    dnl hardlinks to symlinks.  Therefore check for that\n    dnl capability before considering using the system version.\n    AC_CACHE_CHECK([whether linkat() can link symlinks],\n      [gl_cv_func_linkat_nofollow],\n      [rm -rf conftest.l1 conftest.l2\n       ln -s target conftest.l1\n       AC_RUN_IFELSE([AC_LANG_PROGRAM(\n                        [[#include <fcntl.h>\n                          #include <unistd.h>\n                        ]],\n                        [[return linkat (AT_FDCWD, \"conftest.l1\", AT_FDCWD,\n                                         \"conftest.l2\", 0);\n                        ]])],\n         [gl_cv_func_linkat_nofollow=yes],\n         [gl_cv_func_linkat_nofollow=no],\n         [case \"$host_os\" in\n           darwin*) gl_cv_func_linkat_nofollow=\"guessing no\" ;;\n           *)       gl_cv_func_linkat_nofollow=\"guessing yes\" ;;\n          esac])\n\n       rm -rf conftest.l1 conftest.l2])\n\n    case $gl_cv_func_linkat_nofollow in\n      *no) LINKAT_SYMLINK_NOTSUP=1 ;;\n      *yes) LINKAT_SYMLINK_NOTSUP=0 ;;\n    esac\n\n    AC_CACHE_CHECK([whether linkat handles trailing slash correctly],\n      [gl_cv_func_linkat_slash],\n      [rm -rf conftest.a conftest.b conftest.c conftest.d conftest.e conftest.s\n       AC_RUN_IFELSE(\n         [AC_LANG_PROGRAM(\n            [[#include <unistd.h>\n              #include <fcntl.h>\n              #include <errno.h>\n              #include <stdio.h>\n            ]GL_MDA_DEFINES],\n            [[int result;\n              int fd;\n              /* Create a regular file.  */\n              fd = open (\"conftest.a\", O_CREAT | O_EXCL | O_WRONLY, 0600);\n              if (fd < 0)\n                return 1;\n              if (write (fd, \"hello\", 5) < 5)\n                return 2;\n              if (close (fd) < 0)\n                return 3;\n              /* Test whether hard links are supported on the current\n                 device.  */\n              if (linkat (AT_FDCWD, \"conftest.a\", AT_FDCWD, \"conftest.b\",\n                          AT_SYMLINK_FOLLOW) < 0)\n                return 0;\n              result = 0;\n              /* Test whether a trailing \"/\" is treated like \"/.\".  */\n              if (linkat (AT_FDCWD, \"conftest.a/\", AT_FDCWD, \"conftest.c\",\n                          AT_SYMLINK_FOLLOW) == 0)\n                result |= 4;\n              if (linkat (AT_FDCWD, \"conftest.a\", AT_FDCWD, \"conftest.d/\",\n                          AT_SYMLINK_FOLLOW) == 0)\n                result |= 8;\n\n              /* On Mac OS X 10.13 a trailing \"/\" will cause the second path to be\n                 dereferenced, and thus will succeed on a dangling symlink.  */\n              if (symlink (\"conftest.e\", \"conftest.s\") == 0)\n                {\n                  if (linkat (AT_FDCWD, \"conftest.a\", AT_FDCWD, \"conftest.s/\",\n                      AT_SYMLINK_FOLLOW) == 0)\n                    result |= 16;\n                }\n\n              return result;\n            ]])],\n         [gl_cv_func_linkat_slash=yes],\n         [gl_cv_func_linkat_slash=no],\n         [\n          case \"$host_os\" in\n                             # Guess yes on Linux systems.\n            linux-* | linux) gl_cv_func_linkat_slash=\"guessing yes\";;\n                             # Guess yes on systems that emulate the Linux system calls.\n            midipix*)        gl_cv_func_linkat_slash=\"guessing yes\";;\n                             # Guess yes on glibc systems.\n            *-gnu* | gnu*)   gl_cv_func_linkat_slash=\"guessing yes\";;\n                             # If we don't know, obey --enable-cross-guesses.\n            *)               gl_cv_func_linkat_slash=\"$gl_cross_guess_normal\";;\n          esac\n         ])\n       rm -rf conftest.a conftest.b conftest.c conftest.d conftest.e conftest.s])\n    case \"$gl_cv_func_linkat_slash\" in\n      *yes) gl_linkat_slash_bug=0 ;;\n      *)    gl_linkat_slash_bug=1 ;;\n    esac\n\n    case \"$gl_cv_func_linkat_nofollow\" in\n      *yes) linkat_nofollow=yes ;;\n      *) linkat_nofollow=no ;;\n    esac\n\n    if test \"$linkat_nofollow\" != yes \\\n       || test $gl_linkat_slash_bug = 1; then\n      REPLACE_LINKAT=1\n      AC_DEFINE_UNQUOTED([LINKAT_TRAILING_SLASH_BUG], [$gl_linkat_slash_bug],\n        [Define to 1 if linkat fails to recognize a trailing slash.])\n      AC_DEFINE_UNQUOTED([LINKAT_SYMLINK_NOTSUP], [$LINKAT_SYMLINK_NOTSUP],\n        [Define to 1 if linkat can create hardlinks to symlinks])\n    fi\n  fi\n])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}