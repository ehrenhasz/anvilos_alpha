{
  "module_name": "mbrlen.m4",
  "hash_id": "e4897297686e02696294ef39e8b640c082995ccea51783684b5c7bc9ba01fbb8",
  "original_prompt": "Ingested from coreutils-9.4/m4/mbrlen.m4",
  "human_readable_source": "# mbrlen.m4 serial 12  -*- coding: utf-8 -*-\ndnl Copyright (C) 2008, 2010-2023 Free Software Foundation, Inc.\ndnl This file is free software; the Free Software Foundation\ndnl gives unlimited permission to copy and/or distribute it,\ndnl with or without modifications, as long as this notice is preserved.\n\nAC_DEFUN([gl_FUNC_MBRLEN],\n[\n  AC_REQUIRE([gl_WCHAR_H_DEFAULTS])\n\n  AC_REQUIRE([AC_TYPE_MBSTATE_T])\n  AC_REQUIRE([gl_FUNC_MBRTOWC])\n  AC_CHECK_FUNCS_ONCE([mbrlen])\n  if test $ac_cv_func_mbrlen = no; then\n    HAVE_MBRLEN=0\n    AC_CHECK_DECLS([mbrlen],,, [[\n      #include <wchar.h>\n    ]])\n    if test $ac_cv_have_decl_mbrlen = yes; then\n      dnl On Minix 3.1.8, the system's <wchar.h> declares mbrlen() although\n      dnl it does not have the function. Avoid a collision with gnulib's\n      dnl replacement.\n      REPLACE_MBRLEN=1\n    fi\n  else\n    dnl Most bugs affecting the system's mbrtowc function also affect the\n    dnl mbrlen function. So override mbrlen whenever mbrtowc is overridden.\n    dnl We could also run the individual tests below; the results would be\n    dnl the same.\n    if test $REPLACE_MBRTOWC = 1; then\n      REPLACE_MBRLEN=1\n    fi\n  fi\n])\n\ndnl Test whether mbrlen puts the state into non-initial state when parsing an\ndnl incomplete multibyte character.\ndnl Result is gl_cv_func_mbrlen_incomplete_state.\n\nAC_DEFUN([gl_MBRLEN_INCOMPLETE_STATE],\n[\n  AC_REQUIRE([AC_PROG_CC])\n  AC_REQUIRE([gt_LOCALE_JA])\n  AC_REQUIRE([AC_CANONICAL_HOST]) dnl for cross-compiles\n  AC_CACHE_CHECK([whether mbrlen handles incomplete characters],\n    [gl_cv_func_mbrlen_incomplete_state],\n    [\n      dnl Initial guess, used when cross-compiling or when no suitable locale\n      dnl is present.\nchangequote(,)dnl\n      case \"$host_os\" in\n                     # Guess no on AIX and OSF/1.\n        aix* | osf*) gl_cv_func_mbrlen_incomplete_state=\"guessing no\" ;;\n                     # Guess yes otherwise.\n        *)           gl_cv_func_mbrlen_incomplete_state=\"guessing yes\" ;;\n      esac\nchangequote([,])dnl\n      if test $LOCALE_JA != none; then\n        AC_RUN_IFELSE(\n          [AC_LANG_SOURCE([[\n#include <locale.h>\n#include <string.h>\n#include <wchar.h>\nint main ()\n{\n  if (setlocale (LC_ALL, \"$LOCALE_JA\") != NULL)\n    {\n      const char input[] = \"B\\217\\253\\344\\217\\251\\316er\"; /* \"B\u00fc\u00dfer\" */\n      mbstate_t state;\n\n      memset (&state, '\\0', sizeof (mbstate_t));\n      if (mbrlen (input + 1, 1, &state) == (size_t)(-2))\n        if (mbsinit (&state))\n          return 1;\n    }\n  return 0;\n}]])],\n          [gl_cv_func_mbrlen_incomplete_state=yes],\n          [gl_cv_func_mbrlen_incomplete_state=no],\n          [])\n      fi\n    ])\n])\n\ndnl Test whether mbrlen, when parsing the end of a multibyte character,\ndnl correctly returns the number of bytes that were needed to complete the\ndnl character (not the total number of bytes of the multibyte character).\ndnl Result is gl_cv_func_mbrlen_retval.\n\nAC_DEFUN([gl_MBRLEN_RETVAL],\n[\n  AC_REQUIRE([AC_PROG_CC])\n  AC_REQUIRE([gt_LOCALE_FR_UTF8])\n  AC_REQUIRE([gt_LOCALE_JA])\n  AC_REQUIRE([AC_CANONICAL_HOST]) dnl for cross-compiles\n  AC_CACHE_CHECK([whether mbrlen has a correct return value],\n    [gl_cv_func_mbrlen_retval],\n    [\n      dnl Initial guess, used when cross-compiling or when no suitable locale\n      dnl is present.\nchangequote(,)dnl\n      case \"$host_os\" in\n                          # Guess no on HP-UX and Solaris.\n        hpux* | solaris*) gl_cv_func_mbrlen_retval=\"guessing no\" ;;\n                          # Guess yes otherwise.\n        *)                gl_cv_func_mbrlen_retval=\"guessing yes\" ;;\n      esac\nchangequote([,])dnl\n      if test $LOCALE_FR_UTF8 != none || test $LOCALE_JA != none; then\n        AC_RUN_IFELSE(\n          [AC_LANG_SOURCE([[\n#include <locale.h>\n#include <string.h>\n#include <wchar.h>\nint main ()\n{\n  int result = 0;\n  /* This fails on Solaris.  */\n  if (strcmp (\"$LOCALE_FR_UTF8\", \"none\") != 0\n      && setlocale (LC_ALL, \"$LOCALE_FR_UTF8\") != NULL)\n    {\n      char input[] = \"B\\303\\274\\303\\237er\"; /* \"B\u00fc\u00dfer\" */\n      mbstate_t state;\n\n      memset (&state, '\\0', sizeof (mbstate_t));\n      if (mbrlen (input + 1, 1, &state) == (size_t)(-2))\n        {\n          input[1] = '\\0';\n          if (mbrlen (input + 2, 5, &state) != 1)\n            result |= 1;\n        }\n    }\n  /* This fails on HP-UX 11.11.  */\n  if (strcmp (\"$LOCALE_JA\", \"none\") != 0\n      && setlocale (LC_ALL, \"$LOCALE_JA\") != NULL)\n    {\n      char input[] = \"B\\217\\253\\344\\217\\251\\316er\"; /* \"B\u00fc\u00dfer\" */\n      mbstate_t state;\n\n      memset (&state, '\\0', sizeof (mbstate_t));\n      if (mbrlen (input + 1, 1, &state) == (size_t)(-2))\n        {\n          input[1] = '\\0';\n          if (mbrlen (input + 2, 5, &state) != 2)\n            result |= 2;\n        }\n    }\n  return result;\n}]])],\n          [gl_cv_func_mbrlen_retval=yes],\n          [gl_cv_func_mbrlen_retval=no],\n          [])\n      fi\n    ])\n])\n\ndnl Test whether mbrlen, when parsing a NUL character, correctly returns 0.\ndnl Result is gl_cv_func_mbrlen_nul_retval.\n\nAC_DEFUN([gl_MBRLEN_NUL_RETVAL],\n[\n  AC_REQUIRE([AC_PROG_CC])\n  AC_REQUIRE([gt_LOCALE_ZH_CN])\n  AC_REQUIRE([AC_CANONICAL_HOST]) dnl for cross-compiles\n  AC_CACHE_CHECK([whether mbrlen returns 0 when parsing a NUL character],\n    [gl_cv_func_mbrlen_nul_retval],\n    [\n      dnl Initial guess, used when cross-compiling or when no suitable locale\n      dnl is present.\nchangequote(,)dnl\n      case \"$host_os\" in\n                    # Guess no on Solaris 9.\n        solaris2.9) gl_cv_func_mbrlen_nul_retval=\"guessing no\" ;;\n                    # Guess yes otherwise.\n        *)          gl_cv_func_mbrlen_nul_retval=\"guessing yes\" ;;\n      esac\nchangequote([,])dnl\n      if test $LOCALE_ZH_CN != none; then\n        AC_RUN_IFELSE(\n          [AC_LANG_SOURCE([[\n#include <locale.h>\n#include <string.h>\n#include <wchar.h>\nint main ()\n{\n  /* This crashes on Solaris 9 inside __mbrtowc_dense_gb18030.  */\n  if (setlocale (LC_ALL, \"$LOCALE_ZH_CN\") != NULL)\n    {\n      mbstate_t state;\n\n      memset (&state, '\\0', sizeof (mbstate_t));\n      if (mbrlen (\"\", 1, &state) != 0)\n        return 1;\n    }\n  return 0;\n}]])],\n          [gl_cv_func_mbrlen_nul_retval=yes],\n          [gl_cv_func_mbrlen_nul_retval=no],\n          [])\n      fi\n    ])\n])\n\ndnl Test whether mbrlen returns the correct value on empty input.\n\nAC_DEFUN([gl_MBRLEN_EMPTY_INPUT],\n[\n  AC_REQUIRE([AC_PROG_CC])\n  AC_REQUIRE([AC_CANONICAL_HOST]) dnl for cross-compiles\n  AC_CACHE_CHECK([whether mbrlen works on empty input],\n    [gl_cv_func_mbrlen_empty_input],\n    [\n      dnl Initial guess, used when cross-compiling or when no suitable locale\n      dnl is present.\nchangequote(,)dnl\n      case \"$host_os\" in\n                              # Guess no on AIX and glibc systems.\n        aix* | *-gnu* | gnu*) gl_cv_func_mbrlen_empty_input=\"guessing no\" ;;\n        *)                    gl_cv_func_mbrlen_empty_input=\"guessing yes\" ;;\n      esac\nchangequote([,])dnl\n      AC_RUN_IFELSE(\n        [AC_LANG_SOURCE([[\n           #include <wchar.h>\n           static mbstate_t mbs;\n           int\n           main (void)\n           {\n             return mbrlen (\"\", 0, &mbs) != (size_t) -2;\n           }]])],\n        [gl_cv_func_mbrlen_empty_input=yes],\n        [gl_cv_func_mbrlen_empty_input=no],\n        [:])\n    ])\n])\n\n# Prerequisites of lib/mbrlen.c.\nAC_DEFUN([gl_PREREQ_MBRLEN], [\n  :\n])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}