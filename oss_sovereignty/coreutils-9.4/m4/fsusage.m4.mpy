{
  "module_name": "fsusage.m4",
  "hash_id": "9450f8186bba94774b9f15e427f6d4bab24df4cd52db3b01887c9f5bcdc200e9",
  "original_prompt": "Ingested from coreutils-9.4/m4/fsusage.m4",
  "human_readable_source": "# serial 35\n# Obtaining file system usage information.\n\n# Copyright (C) 1997-1998, 2000-2001, 2003-2023 Free Software Foundation, Inc.\n#\n# This file is free software; the Free Software Foundation\n# gives unlimited permission to copy and/or distribute it,\n# with or without modifications, as long as this notice is preserved.\n\n# Written by Jim Meyering.\n\nAC_DEFUN([gl_FSUSAGE],\n[\n  AC_CHECK_HEADERS_ONCE([sys/param.h])\n  AC_CHECK_HEADERS_ONCE([sys/vfs.h sys/fs_types.h])\n  AC_CHECK_HEADERS([sys/mount.h], [], [],\n    [AC_INCLUDES_DEFAULT\n     [#if HAVE_SYS_PARAM_H\n       #include <sys/param.h>\n      #endif]])\n  gl_FILE_SYSTEM_USAGE([gl_cv_fs_space=yes], [gl_cv_fs_space=no])\n])\n\n# Try to determine how a program can obtain file system usage information.\n# If successful, define the appropriate symbol (see fsusage.c) and\n# execute ACTION-IF-FOUND.  Otherwise, execute ACTION-IF-NOT-FOUND.\n#\n# gl_FILE_SYSTEM_USAGE([ACTION-IF-FOUND[, ACTION-IF-NOT-FOUND]])\n\nAC_DEFUN([gl_FILE_SYSTEM_USAGE],\n[\n  dnl Enable large-file support. This has the effect of changing the size\n  dnl of field f_blocks in 'struct statvfs' from 32 bit to 64 bit on\n  dnl glibc/Hurd, HP-UX 11, Solaris (32-bit mode). It also changes the size\n  dnl of field f_blocks in 'struct statfs' from 32 bit to 64 bit on\n  dnl Mac OS X >= 10.5 (32-bit mode).\n  AC_REQUIRE([AC_SYS_LARGEFILE])\n\n  ac_fsusage_space=no\n\n  # Perform only the link test since it seems there are no variants of the\n  # statvfs function.  This check is more than just AC_CHECK_FUNCS([statvfs])\n  # because that got a false positive on SCO OSR5.  Adding the declaration\n  # of a 'struct statvfs' causes this test to fail (as it should) on such\n  # systems.  That system is reported to work fine with STAT_STATFS4 which\n  # is what it gets when this test fails.\n  if test $ac_fsusage_space = no; then\n    # glibc/{Hurd,kFreeBSD}, FreeBSD >= 5.0, NetBSD >= 3.0,\n    # OpenBSD >= 4.4, AIX, HP-UX, IRIX, Solaris, Cygwin, Interix, BeOS.\n    AC_CACHE_CHECK([for statvfs function (SVR4)],\n      [fu_cv_sys_stat_statvfs],\n      [AC_LINK_IFELSE(\n         [AC_LANG_PROGRAM([[\n#include <sys/types.h>\n#ifdef __osf__\n\"Do not use Tru64's statvfs implementation\"\n#endif\n\n#include <sys/statvfs.h>\n\nstruct statvfs fsd;\n\n#if defined __APPLE__ && defined __MACH__\n#include <limits.h>\n/* On Mac OS X >= 10.5, f_blocks in 'struct statvfs' is a 32-bit quantity;\n   that commonly limits file systems to 4 TiB.  Whereas f_blocks in\n   'struct statfs' is a 64-bit type, thanks to the large-file support\n   that was enabled above.  In this case, don't use statvfs(); use statfs()\n   instead.  */\nint check_f_blocks_size[sizeof fsd.f_blocks * CHAR_BIT <= 32 ? -1 : 1];\n#endif\n]],\n            [[statvfs (0, &fsd);]])],\n         [fu_cv_sys_stat_statvfs=yes],\n         [fu_cv_sys_stat_statvfs=no])\n      ])\n    if test $fu_cv_sys_stat_statvfs = yes; then\n      ac_fsusage_space=yes\n      # AIX >= 5.2 has statvfs64 that has a wider f_blocks field than statvfs.\n      # glibc, HP-UX, IRIX, Solaris have statvfs64 as well, but on these systems\n      # statvfs with large-file support is already equivalent to statvfs64.\n      AC_CACHE_CHECK([whether to use statvfs64],\n        [fu_cv_sys_stat_statvfs64],\n        [AC_LINK_IFELSE(\n           [AC_LANG_PROGRAM(\n              [[#include <sys/types.h>\n                #include <sys/statvfs.h>\n                struct statvfs64 fsd;\n                int check_f_blocks_larger_in_statvfs64\n                  [sizeof (((struct statvfs64 *) 0)->f_blocks)\n                   > sizeof (((struct statvfs *) 0)->f_blocks)\n                   ? 1 : -1];\n              ]],\n              [[statvfs64 (0, &fsd);]])],\n           [fu_cv_sys_stat_statvfs64=yes],\n           [fu_cv_sys_stat_statvfs64=no])\n        ])\n      if test $fu_cv_sys_stat_statvfs64 = yes; then\n        AC_DEFINE([STAT_STATVFS64], [1],\n          [Define if statvfs64 should be preferred over statvfs.])\n      else\n        AC_DEFINE([STAT_STATVFS], [1],\n          [Define if there is a function named statvfs.  (SVR4)])\n      fi\n    fi\n  fi\n\n  # Check for this unconditionally so we have a\n  # good fallback on glibc/Linux > 2.6 < 2.6.36\n  AC_CACHE_CHECK([for two-argument statfs with statfs.f_frsize member],\n    [fu_cv_sys_stat_statfs2_frsize],\n    [AC_RUN_IFELSE(\n       [AC_LANG_SOURCE([[\n#ifdef HAVE_SYS_PARAM_H\n#include <sys/param.h>\n#endif\n#ifdef HAVE_SYS_MOUNT_H\n#include <sys/mount.h>\n#endif\n#ifdef HAVE_SYS_VFS_H\n#include <sys/vfs.h>\n#endif\n  int\n  main ()\n  {\n    struct statfs fsd;\n    fsd.f_frsize = 0;\n    return statfs (\".\", &fsd) != 0;\n  }]])],\n       [fu_cv_sys_stat_statfs2_frsize=yes],\n       [fu_cv_sys_stat_statfs2_frsize=no],\n       [fu_cv_sys_stat_statfs2_frsize=no])\n    ])\n  if test $fu_cv_sys_stat_statfs2_frsize = yes; then\n    ac_fsusage_space=yes\n    AC_DEFINE([STAT_STATFS2_FRSIZE], [1],\n      [Define if statfs takes 2 args and struct statfs has a field named f_frsize.\n       (glibc/Linux > 2.6)])\n  fi\n\n  if test $ac_fsusage_space = no; then\n    # DEC Alpha running OSF/1\n    AC_CACHE_CHECK([for 3-argument statfs function (DEC OSF/1)],\n      [fu_cv_sys_stat_statfs3_osf1],\n      [AC_RUN_IFELSE([AC_LANG_SOURCE([[\n#include <sys/param.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n  int\n  main ()\n  {\n    struct statfs fsd;\n    fsd.f_fsize = 0;\n    return statfs (\".\", &fsd, sizeof (struct statfs)) != 0;\n  }]])],\n         [fu_cv_sys_stat_statfs3_osf1=yes],\n         [fu_cv_sys_stat_statfs3_osf1=no],\n         [fu_cv_sys_stat_statfs3_osf1=no])\n      ])\n    if test $fu_cv_sys_stat_statfs3_osf1 = yes; then\n      ac_fsusage_space=yes\n      AC_DEFINE([STAT_STATFS3_OSF1], [1],\n        [Define if statfs takes 3 args.  (DEC Alpha running OSF/1)])\n    fi\n  fi\n\n  if test $ac_fsusage_space = no; then\n    # glibc/Linux, Mac OS X, FreeBSD < 5.0, NetBSD < 3.0, OpenBSD < 4.4.\n    # (glibc/{Hurd,kFreeBSD}, FreeBSD >= 5.0, NetBSD >= 3.0,\n    # OpenBSD >= 4.4, AIX, HP-UX, OSF/1, Cygwin already handled above.)\n    # (On IRIX you need to include <sys/statfs.h>, not only <sys/mount.h> and\n    # <sys/vfs.h>.)\n    # (On Solaris, statfs has 4 arguments.)\n    AC_CACHE_CHECK([for two-argument statfs with statfs.f_bsize member (AIX, 4.3BSD)],\n      [fu_cv_sys_stat_statfs2_bsize],\n      [AC_RUN_IFELSE([AC_LANG_SOURCE([[\n#ifdef HAVE_SYS_PARAM_H\n#include <sys/param.h>\n#endif\n#ifdef HAVE_SYS_MOUNT_H\n#include <sys/mount.h>\n#endif\n#ifdef HAVE_SYS_VFS_H\n#include <sys/vfs.h>\n#endif\n  int\n  main ()\n  {\n    struct statfs fsd;\n    fsd.f_bsize = 0;\n    return statfs (\".\", &fsd) != 0;\n  }]])],\n         [fu_cv_sys_stat_statfs2_bsize=yes],\n         [fu_cv_sys_stat_statfs2_bsize=no],\n         [fu_cv_sys_stat_statfs2_bsize=no])\n      ])\n    if test $fu_cv_sys_stat_statfs2_bsize = yes; then\n      ac_fsusage_space=yes\n      AC_DEFINE([STAT_STATFS2_BSIZE], [1],\n        [Define if statfs takes 2 args and struct statfs has a field named f_bsize.\n         (4.3BSD, SunOS 4, HP-UX)])\n    fi\n  fi\n\n  if test $ac_fsusage_space = no; then\n    # SVR3\n    # (Solaris already handled above.)\n    AC_CACHE_CHECK([for four-argument statfs (SVR3)],\n      [fu_cv_sys_stat_statfs4],\n      [AC_RUN_IFELSE([AC_LANG_SOURCE([[\n#include <sys/types.h>\n#include <sys/statfs.h>\n  int\n  main ()\n  {\n    struct statfs fsd;\n    return statfs (\".\", &fsd, sizeof fsd, 0) != 0;\n  }]])],\n         [fu_cv_sys_stat_statfs4=yes],\n         [fu_cv_sys_stat_statfs4=no],\n         [fu_cv_sys_stat_statfs4=no])\n      ])\n    if test $fu_cv_sys_stat_statfs4 = yes; then\n      ac_fsusage_space=yes\n      AC_DEFINE([STAT_STATFS4], [1],\n        [Define if statfs takes 4 args.  (SVR3, old Irix)])\n    fi\n  fi\n\n  if test $ac_fsusage_space = no; then\n    # 4.4BSD and older NetBSD\n    # (OSF/1 already handled above.)\n    # (On AIX, you need to include <sys/statfs.h>, not only <sys/mount.h>.)\n    # (On Solaris, statfs has 4 arguments and 'struct statfs' is not declared in\n    # <sys/mount.h>.)\n    AC_CACHE_CHECK([for two-argument statfs with statfs.f_fsize member (4.4BSD and NetBSD)],\n      [fu_cv_sys_stat_statfs2_fsize],\n      [AC_RUN_IFELSE([AC_LANG_SOURCE([[\n#include <sys/types.h>\n#ifdef HAVE_SYS_PARAM_H\n#include <sys/param.h>\n#endif\n#ifdef HAVE_SYS_MOUNT_H\n#include <sys/mount.h>\n#endif\n  int\n  main ()\n  {\n    struct statfs fsd;\n    fsd.f_fsize = 0;\n    return statfs (\".\", &fsd) != 0;\n  }]])],\n         [fu_cv_sys_stat_statfs2_fsize=yes],\n         [fu_cv_sys_stat_statfs2_fsize=no],\n         [fu_cv_sys_stat_statfs2_fsize=no])\n      ])\n    if test $fu_cv_sys_stat_statfs2_fsize = yes; then\n      ac_fsusage_space=yes\n      AC_DEFINE([STAT_STATFS2_FSIZE], [1],\n        [Define if statfs takes 2 args and struct statfs has a field named f_fsize.\n         (4.4BSD, NetBSD)])\n    fi\n  fi\n\n  AS_IF([test $ac_fsusage_space = yes], [$1], [$2])\n\n])\n\n\n# Check for SunOS statfs brokenness wrt partitions 2GB and larger.\n# If <sys/vfs.h> exists and struct statfs has a member named f_spare,\n# enable the workaround code in fsusage.c.\nAC_DEFUN([gl_STATFS_TRUNCATES],\n[\n  AC_CACHE_CHECK([for statfs that truncates block counts],\n    [fu_cv_sys_truncating_statfs],\n    [AC_COMPILE_IFELSE(\n       [AC_LANG_PROGRAM([[\n#if !defined(sun) && !defined(__sun)\nchoke -- this is a workaround for a Sun-specific problem\n#endif\n#include <sys/types.h>\n#include <sys/vfs.h>\n         ]],\n         [[struct statfs t; long c = *(t.f_spare);\n           if (c) return 0;\n         ]])],\n       [fu_cv_sys_truncating_statfs=yes],\n       [fu_cv_sys_truncating_statfs=no])\n    ])\n  if test $fu_cv_sys_truncating_statfs = yes; then\n    AC_DEFINE([STATFS_TRUNCATES_BLOCK_COUNTS], [1],\n      [Define if the block counts reported by statfs may be truncated to 2GB\n       and the correct values may be stored in the f_spare array.\n       (SunOS 4.1.2, 4.1.3, and 4.1.3_U1 are reported to have this problem.\n       SunOS 4.1.1 seems not to be affected.)])\n  fi\n])\n\n\n# Prerequisites of lib/fsusage.c not done by gl_FILE_SYSTEM_USAGE.\nAC_DEFUN([gl_PREREQ_FSUSAGE_EXTRA],\n[\n  AC_CHECK_HEADERS([sys/fs/s5param.h sys/statfs.h])\n  gl_STATFS_TRUNCATES\n])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}