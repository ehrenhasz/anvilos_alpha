{
  "module_name": "iconv.m4",
  "hash_id": "6054496906498715e6ee275facf499627c6c9a3b75779fa2574c4e416c358705",
  "original_prompt": "Ingested from coreutils-9.4/m4/iconv.m4",
  "human_readable_source": "# iconv.m4 serial 26\ndnl Copyright (C) 2000-2002, 2007-2014, 2016-2023 Free Software Foundation,\ndnl Inc.\ndnl This file is free software; the Free Software Foundation\ndnl gives unlimited permission to copy and/or distribute it,\ndnl with or without modifications, as long as this notice is preserved.\n\ndnl From Bruno Haible.\n\nAC_PREREQ([2.64])\n\ndnl Note: AM_ICONV is documented in the GNU gettext manual\ndnl <https://www.gnu.org/software/gettext/manual/html_node/AM_005fICONV.html>.\ndnl Don't make changes that are incompatible with that documentation!\n\nAC_DEFUN([AM_ICONV_LINKFLAGS_BODY],\n[\n  dnl Prerequisites of AC_LIB_LINKFLAGS_BODY.\n  AC_REQUIRE([AC_LIB_PREPARE_PREFIX])\n  AC_REQUIRE([AC_LIB_RPATH])\n\n  dnl Search for libiconv and define LIBICONV, LTLIBICONV and INCICONV\n  dnl accordingly.\n  AC_LIB_LINKFLAGS_BODY([iconv])\n])\n\nAC_DEFUN([AM_ICONV_LINK],\n[\n  dnl Some systems have iconv in libc, some have it in libiconv (OSF/1 and\n  dnl those with the standalone portable GNU libiconv installed).\n  AC_REQUIRE([AC_CANONICAL_HOST]) dnl for cross-compiles\n\n  dnl Search for libiconv and define LIBICONV, LTLIBICONV and INCICONV\n  dnl accordingly.\n  AC_REQUIRE([AM_ICONV_LINKFLAGS_BODY])\n\n  dnl Add $INCICONV to CPPFLAGS before performing the following checks,\n  dnl because if the user has installed libiconv and not disabled its use\n  dnl via --without-libiconv-prefix, he wants to use it. The first\n  dnl AC_LINK_IFELSE will then fail, the second AC_LINK_IFELSE will succeed.\n  am_save_CPPFLAGS=\"$CPPFLAGS\"\n  AC_LIB_APPENDTOVAR([CPPFLAGS], [$INCICONV])\n\n  AC_CACHE_CHECK([for iconv], [am_cv_func_iconv], [\n    am_cv_func_iconv=\"no, consider installing GNU libiconv\"\n    am_cv_lib_iconv=no\n    AC_LINK_IFELSE(\n      [AC_LANG_PROGRAM(\n         [[\n#include <stdlib.h>\n#include <iconv.h>\n         ]],\n         [[iconv_t cd = iconv_open(\"\",\"\");\n           iconv(cd,NULL,NULL,NULL,NULL);\n           iconv_close(cd);]])],\n      [am_cv_func_iconv=yes])\n    if test \"$am_cv_func_iconv\" != yes; then\n      am_save_LIBS=\"$LIBS\"\n      LIBS=\"$LIBS $LIBICONV\"\n      AC_LINK_IFELSE(\n        [AC_LANG_PROGRAM(\n           [[\n#include <stdlib.h>\n#include <iconv.h>\n           ]],\n           [[iconv_t cd = iconv_open(\"\",\"\");\n             iconv(cd,NULL,NULL,NULL,NULL);\n             iconv_close(cd);]])],\n        [am_cv_lib_iconv=yes]\n        [am_cv_func_iconv=yes])\n      LIBS=\"$am_save_LIBS\"\n    fi\n  ])\n  if test \"$am_cv_func_iconv\" = yes; then\n    AC_CACHE_CHECK([for working iconv], [am_cv_func_iconv_works], [\n      dnl This tests against bugs in AIX 5.1, AIX 6.1..7.1, HP-UX 11.11,\n      dnl Solaris 10.\n      am_save_LIBS=\"$LIBS\"\n      if test $am_cv_lib_iconv = yes; then\n        LIBS=\"$LIBS $LIBICONV\"\n      fi\n      am_cv_func_iconv_works=no\n      for ac_iconv_const in '' 'const'; do\n        AC_RUN_IFELSE(\n          [AC_LANG_PROGRAM(\n             [[\n#include <iconv.h>\n#include <string.h>\n\n#ifndef ICONV_CONST\n# define ICONV_CONST $ac_iconv_const\n#endif\n             ]],\n             [[int result = 0;\n  /* Test against AIX 5.1...7.2 bug: Failures are not distinguishable from\n     successful returns.  This is even documented in\n     <https://www.ibm.com/support/knowledgecenter/ssw_aix_72/i_bostechref/iconv.html> */\n  {\n    iconv_t cd_utf8_to_88591 = iconv_open (\"ISO8859-1\", \"UTF-8\");\n    if (cd_utf8_to_88591 != (iconv_t)(-1))\n      {\n        static ICONV_CONST char input[] = \"\\342\\202\\254\"; /* EURO SIGN */\n        char buf[10];\n        ICONV_CONST char *inptr = input;\n        size_t inbytesleft = strlen (input);\n        char *outptr = buf;\n        size_t outbytesleft = sizeof (buf);\n        size_t res = iconv (cd_utf8_to_88591,\n                            &inptr, &inbytesleft,\n                            &outptr, &outbytesleft);\n        if (res == 0)\n          result |= 1;\n        iconv_close (cd_utf8_to_88591);\n      }\n  }\n  /* Test against Solaris 10 bug: Failures are not distinguishable from\n     successful returns.  */\n  {\n    iconv_t cd_ascii_to_88591 = iconv_open (\"ISO8859-1\", \"646\");\n    if (cd_ascii_to_88591 != (iconv_t)(-1))\n      {\n        static ICONV_CONST char input[] = \"\\263\";\n        char buf[10];\n        ICONV_CONST char *inptr = input;\n        size_t inbytesleft = strlen (input);\n        char *outptr = buf;\n        size_t outbytesleft = sizeof (buf);\n        size_t res = iconv (cd_ascii_to_88591,\n                            &inptr, &inbytesleft,\n                            &outptr, &outbytesleft);\n        if (res == 0)\n          result |= 2;\n        iconv_close (cd_ascii_to_88591);\n      }\n  }\n  /* Test against AIX 6.1..7.1 bug: Buffer overrun.  */\n  {\n    iconv_t cd_88591_to_utf8 = iconv_open (\"UTF-8\", \"ISO-8859-1\");\n    if (cd_88591_to_utf8 != (iconv_t)(-1))\n      {\n        static ICONV_CONST char input[] = \"\\304\";\n        static char buf[2] = { (char)0xDE, (char)0xAD };\n        ICONV_CONST char *inptr = input;\n        size_t inbytesleft = 1;\n        char *outptr = buf;\n        size_t outbytesleft = 1;\n        size_t res = iconv (cd_88591_to_utf8,\n                            &inptr, &inbytesleft,\n                            &outptr, &outbytesleft);\n        if (res != (size_t)(-1) || outptr - buf > 1 || buf[1] != (char)0xAD)\n          result |= 4;\n        iconv_close (cd_88591_to_utf8);\n      }\n  }\n#if 0 /* This bug could be worked around by the caller.  */\n  /* Test against HP-UX 11.11 bug: Positive return value instead of 0.  */\n  {\n    iconv_t cd_88591_to_utf8 = iconv_open (\"utf8\", \"iso88591\");\n    if (cd_88591_to_utf8 != (iconv_t)(-1))\n      {\n        static ICONV_CONST char input[] = \"\\304rger mit b\\366sen B\\374bchen ohne Augenma\\337\";\n        char buf[50];\n        ICONV_CONST char *inptr = input;\n        size_t inbytesleft = strlen (input);\n        char *outptr = buf;\n        size_t outbytesleft = sizeof (buf);\n        size_t res = iconv (cd_88591_to_utf8,\n                            &inptr, &inbytesleft,\n                            &outptr, &outbytesleft);\n        if ((int)res > 0)\n          result |= 8;\n        iconv_close (cd_88591_to_utf8);\n      }\n  }\n#endif\n  /* Test against HP-UX 11.11 bug: No converter from EUC-JP to UTF-8 is\n     provided.  */\n  {\n    /* Try standardized names.  */\n    iconv_t cd1 = iconv_open (\"UTF-8\", \"EUC-JP\");\n    /* Try IRIX, OSF/1 names.  */\n    iconv_t cd2 = iconv_open (\"UTF-8\", \"eucJP\");\n    /* Try AIX names.  */\n    iconv_t cd3 = iconv_open (\"UTF-8\", \"IBM-eucJP\");\n    /* Try HP-UX names.  */\n    iconv_t cd4 = iconv_open (\"utf8\", \"eucJP\");\n    if (cd1 == (iconv_t)(-1) && cd2 == (iconv_t)(-1)\n        && cd3 == (iconv_t)(-1) && cd4 == (iconv_t)(-1))\n      result |= 16;\n    if (cd1 != (iconv_t)(-1))\n      iconv_close (cd1);\n    if (cd2 != (iconv_t)(-1))\n      iconv_close (cd2);\n    if (cd3 != (iconv_t)(-1))\n      iconv_close (cd3);\n    if (cd4 != (iconv_t)(-1))\n      iconv_close (cd4);\n  }\n  return result;\n]])],\n          [am_cv_func_iconv_works=yes], ,\n          [case \"$host_os\" in\n             aix* | hpux*) am_cv_func_iconv_works=\"guessing no\" ;;\n             *)            am_cv_func_iconv_works=\"guessing yes\" ;;\n           esac])\n        test \"$am_cv_func_iconv_works\" = no || break\n      done\n      LIBS=\"$am_save_LIBS\"\n    ])\n    case \"$am_cv_func_iconv_works\" in\n      *no) am_func_iconv=no am_cv_lib_iconv=no ;;\n      *)   am_func_iconv=yes ;;\n    esac\n  else\n    am_func_iconv=no am_cv_lib_iconv=no\n  fi\n  if test \"$am_func_iconv\" = yes; then\n    AC_DEFINE([HAVE_ICONV], [1],\n      [Define if you have the iconv() function and it works.])\n  fi\n  if test \"$am_cv_lib_iconv\" = yes; then\n    AC_MSG_CHECKING([how to link with libiconv])\n    AC_MSG_RESULT([$LIBICONV])\n  else\n    dnl If $LIBICONV didn't lead to a usable library, we don't need $INCICONV\n    dnl either.\n    CPPFLAGS=\"$am_save_CPPFLAGS\"\n    LIBICONV=\n    LTLIBICONV=\n  fi\n  AC_SUBST([LIBICONV])\n  AC_SUBST([LTLIBICONV])\n])\n\ndnl Define AM_ICONV using AC_DEFUN_ONCE, in order to avoid warnings like\ndnl \"warning: AC_REQUIRE: `AM_ICONV' was expanded before it was required\".\nAC_DEFUN_ONCE([AM_ICONV],\n[\n  AM_ICONV_LINK\n  if test \"$am_cv_func_iconv\" = yes; then\n    AC_CACHE_CHECK([whether iconv is compatible with its POSIX signature],\n      [gl_cv_iconv_nonconst],\n      [AC_COMPILE_IFELSE(\n         [AC_LANG_PROGRAM(\n            [[\n#include <stdlib.h>\n#include <iconv.h>\nextern\n#ifdef __cplusplus\n\"C\"\n#endif\nsize_t iconv (iconv_t cd, char * *inbuf, size_t *inbytesleft, char * *outbuf, size_t *outbytesleft);\n            ]],\n            [[]])],\n         [gl_cv_iconv_nonconst=yes],\n         [gl_cv_iconv_nonconst=no])\n      ])\n  else\n    dnl When compiling GNU libiconv on a system that does not have iconv yet,\n    dnl pick the POSIX compliant declaration without 'const'.\n    gl_cv_iconv_nonconst=yes\n  fi\n  if test $gl_cv_iconv_nonconst = yes; then\n    iconv_arg1=\"\"\n  else\n    iconv_arg1=\"const\"\n  fi\n  AC_DEFINE_UNQUOTED([ICONV_CONST], [$iconv_arg1],\n    [Define as const if the declaration of iconv() needs const.])\n  dnl Also substitute ICONV_CONST in the gnulib generated <iconv.h>.\n  m4_ifdef([gl_ICONV_H_DEFAULTS],\n    [AC_REQUIRE([gl_ICONV_H_DEFAULTS])\n     if test $gl_cv_iconv_nonconst != yes; then\n       ICONV_CONST=\"const\"\n     fi\n    ])\n\n  dnl A summary result, for those packages which want to print a summary at the\n  dnl end of the configuration.\n  if test \"$am_func_iconv\" = yes; then\n    if test -n \"$LIBICONV\"; then\n      am_cv_func_iconv_summary='yes, in libiconv'\n    else\n      am_cv_func_iconv_summary='yes, in libc'\n    fi\n  else\n    if test \"$am_cv_func_iconv\" = yes; then\n      am_cv_func_iconv_summary='not working, consider installing GNU libiconv'\n    else\n      am_cv_func_iconv_summary='no, consider installing GNU libiconv'\n    fi\n  fi\n])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}