{
  "module_name": "link-follow.m4",
  "hash_id": "57ba2b0d90892c47ae419402700a6b5528e58051090a74c5b2ce5ce3b385f02c",
  "original_prompt": "Ingested from coreutils-9.4/m4/link-follow.m4",
  "human_readable_source": "# serial 21\ndnl Run a program to determine whether link(2) follows symlinks.\ndnl Set LINK_FOLLOWS_SYMLINKS accordingly.\n\n# Copyright (C) 1999-2001, 2004-2006, 2009-2023 Free Software Foundation, Inc.\n# This file is free software; the Free Software Foundation\n# gives unlimited permission to copy and/or distribute it,\n# with or without modifications, as long as this notice is preserved.\n\ndnl This macro can be used to emulate POSIX linkat.  If\ndnl LINK_FOLLOWS_SYMLINKS is 0, link matches linkat(,0), and\ndnl linkat(,AT_SYMLINK_FOLLOW) requires a readlink. If it is 1,\ndnl link matches linkat(,AT_SYMLINK_FOLLOW), and there is no way\ndnl to do linkat(,0) on symlinks (on all other file types,\ndnl link() is sufficient).  If it is -1, use a Solaris specific\ndnl runtime test.  If it is -2, use a generic runtime test.\nAC_DEFUN([gl_FUNC_LINK_FOLLOWS_SYMLINK],\n[dnl\n  AC_REQUIRE([AC_CANONICAL_HOST]) dnl for cross-compiles\n  AC_CHECK_FUNCS_ONCE([readlink])\n  dnl Mingw lacks link, although gnulib provides a good replacement.\n  dnl However, it also lacks symlink, so there's nothing to test in\n  dnl the first place, and no reason to need to distinguish between\n  dnl linkat variants.  So, we set LINK_FOLLOWS_SYMLINKS to 0.\n  gl_link_follows_symlinks=0 # assume GNU behavior\n  if test $ac_cv_func_readlink = yes; then\n    dnl Solaris has an __xpg4 variable in libc, and it determines the\n    dnl behaviour of link(): It dereferences a symlink if and only if\n    dnl __xpg4 != 0.\n    AC_CACHE_CHECK([for __xpg4], [gl_cv_have___xpg4],\n      [AC_LINK_IFELSE(\n         [AC_LANG_PROGRAM(\n            [[extern int __xpg4;]],\n            [[return __xpg4;]])],\n         [gl_cv_have___xpg4=yes],\n         [gl_cv_have___xpg4=no])\n      ])\n    if test $gl_cv_have___xpg4 = yes; then\n      gl_link_follows_symlinks=-1\n    else\n      AC_CACHE_CHECK([whether link(2) dereferences a symlink],\n                     [gl_cv_func_link_follows_symlink],\n        [\n         # Create a regular file.\n         echo > conftest.file\n         AC_RUN_IFELSE(\n           [AC_LANG_SOURCE([[\n#       include <sys/types.h>\n#       include <sys/stat.h>\n#       include <unistd.h>\n#       include <stdlib.h>\n\n#       define SAME_INODE(Stat_buf_1, Stat_buf_2) \\\n          ((Stat_buf_1).st_ino == (Stat_buf_2).st_ino \\\n           && (Stat_buf_1).st_dev == (Stat_buf_2).st_dev)\n\n        int\n        main ()\n        {\n          const char *file = \"conftest.file\";\n          const char *sym = \"conftest.sym\";\n          const char *hard = \"conftest.hard\";\n          struct stat sb_file, sb_hard;\n\n          /* Create a symlink to the regular file. */\n          if (symlink (file, sym))\n            return 2;\n\n          /* Create a hard link to that symlink.  */\n          if (link (sym, hard))\n            return 3;\n\n          if (lstat (hard, &sb_hard))\n            return 4;\n          if (lstat (file, &sb_file))\n            return 5;\n\n          /* If the dev/inode of hard and file are the same, then\n             the link call followed the symlink.  */\n          return SAME_INODE (sb_hard, sb_file) ? 1 : 0;\n        }\n           ]])],\n           [gl_cv_func_link_follows_symlink=no], dnl GNU behavior\n           [gl_cv_func_link_follows_symlink=yes], dnl Followed link/compile failed\n           [dnl We're cross compiling.\n            dnl The past results are \"yes\" on Mac OS X, FreeBSD, NetBSD,\n            dnl OpenBSD, Minix, AIX, HP-UX, OSF/1, and \"no\" on Linux, Cygwin.\n            case \"$host_os\" in\n                                  # On glibc/Linux we know the result.\n              linux*-gnu* | gnu*) gl_cv_func_link_follows_symlink=\"guessing no\" ;;\n                                  # On musl/Linux we know the result.\n              linux*-musl*)       gl_cv_func_link_follows_symlink=\"guessing no\" ;;\n                                  # Otherwise, we don't know.\n              *)                  gl_cv_func_link_follows_symlink=unknown ;;\n            esac\n           ])\n         rm -f conftest.file conftest.sym conftest.hard\n        ])\n      case \"$gl_cv_func_link_follows_symlink\" in\n        *yes) gl_link_follows_symlinks=1 ;;\n        *no) ;; # already defaulted to 0\n        *) gl_link_follows_symlinks=-2 ;;\n      esac\n    fi\n  fi\n  AC_DEFINE_UNQUOTED([LINK_FOLLOWS_SYMLINKS], [$gl_link_follows_symlinks],\n    [Define to 1 if 'link(2)' dereferences symbolic links, 0 if it\n     creates hard links to symlinks, -1 if it depends on the variable __xpg4,\n     and -2 if unknown.])\n])\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}