{
  "module_name": "gnu-web-doc-update",
  "hash_id": "3590e0ca8cce5874e6a5a353840fec0787eb108805eb5a0fc04255dcafe68b20",
  "original_prompt": "Ingested from coreutils-9.4/build-aux/gnu-web-doc-update",
  "human_readable_source": "#!/bin/sh\n# Run this after each non-alpha release, to update the web documentation at\n# https://www.gnu.org/software/$pkg/manual/\n\nVERSION=2023-03-23.02; # UTC\n\n# Copyright (C) 2009-2023 Free Software Foundation, Inc.\n\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 3 of the License, or\n# (at your option) any later version.\n\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n# GNU General Public License for more details.\n\n# You should have received a copy of the GNU General Public License\n# along with this program.  If not, see <https://www.gnu.org/licenses/>.\n\nME=$(basename \"$0\")\nwarn() { printf '%s: %s\\n' \"$ME\" \"$*\" >&2; }\ndie() { warn \"$*\"; exit 1; }\n\nhelp()\n{\n  cat <<EOF\nUsage: $ME\n\nRun this script from top_srcdir (no arguments) after each non-alpha\nrelease, to update the web documentation at\nhttps://www.gnu.org/software/\\$pkg/manual/\n\nThis script assumes you're using git for revision control, and\nrequires a .prev-version file as well as a Makefile, from which it\nextracts the version number and package name, respectively.  Also, it\nassumes all documentation is in the doc/ sub-directory.\n\nOptions:\n  -C, --builddir=DIR  location of (configured) Makefile (default: .)\n  -n, --dry-run       don't actually commit anything\n  -m, --mirror        remove out of date files from document server\n  -u, --user          the name of the CVS user on Savannah\n  --help              print this help, then exit\n  --version           print version number, then exit\n\nReport bugs and patches to <bug-gnulib@gnu.org>.\nEOF\n  exit\n}\n\nversion()\n{\n  year=$(echo \"$VERSION\" | sed 's/[^0-9].*//')\n  cat <<EOF\n$ME $VERSION\nCopyright (C) $year Free Software Foundation, Inc,\nLicense GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\nEOF\n  exit\n}\n\n# find_tool ENVVAR NAMES...\n# -------------------------\n# Search for a required program.  Use the value of ENVVAR, if set,\n# otherwise find the first of the NAMES that can be run (i.e.,\n# supports --version).  If found, set ENVVAR to the program name,\n# die otherwise.\n#\n# FIXME: code duplication, see also bootstrap.\nfind_tool ()\n{\n  find_tool_envvar=$1\n  shift\n  find_tool_names=$@\n  eval \"find_tool_res=\\$$find_tool_envvar\"\n  if test x\"$find_tool_res\" = x; then\n    for i\n    do\n      if ($i --version </dev/null) >/dev/null 2>&1; then\n       find_tool_res=$i\n       break\n      fi\n    done\n  else\n    find_tool_error_prefix=\"\\$$find_tool_envvar: \"\n  fi\n  test x\"$find_tool_res\" != x \\\n    || die \"one of these is required: $find_tool_names\"\n  ($find_tool_res --version </dev/null) >/dev/null 2>&1 \\\n    || die \"${find_tool_error_prefix}cannot run $find_tool_res --version\"\n  eval \"$find_tool_envvar=\\$find_tool_res\"\n  eval \"export $find_tool_envvar\"\n}\n\n## ------ ##\n## Main.  ##\n## ------ ##\n\n# Requirements: everything required to bootstrap your package, plus\n# these.\nfind_tool CVS cvs\nfind_tool GIT git\nfind_tool RSYNC rsync\nfind_tool XARGS gxargs xargs\n\nbuilddir=.\ndryrun=\nrm_stale='echo'\ncvs_user=\"$USER\"\nwhile test $# != 0\ndo\n  # Handle --option=value by splitting apart and putting back on argv.\n  case $1 in\n    --*=*)\n      opt=$(echo \"$1\" | sed -e 's/=.*//')\n      val=$(echo \"$1\" | sed -e 's/[^=]*=//')\n      shift\n      set dummy \"$opt\" \"$val\" \"$@\"; shift\n      ;;\n  esac\n\n  case $1 in\n    --help|--version) ${1#--};;\n    -C|--builddir) shift; builddir=$1; shift ;;\n    -n|--dry-run) dryrun=echo; shift;;\n    -m|--mirror) rm_stale=''; shift;;\n    -u|--user) shift; cvs_user=$1; shift ;;\n    --*) die \"unrecognized option: $1\";;\n    *) break;;\n  esac\ndone\n\ntest $# = 0 \\\n  || die \"too many arguments\"\n\nprev=.prev-version\nversion=$(cat $prev) || die \"no $prev file?\"\npkg=$(sed -n 's/^PACKAGE = \\(.*\\)/\\1/p' $builddir/Makefile) \\\n  || die \"no Makefile?\"\ntmp_branch=web-doc-$version-$$\ncurrent_branch=$($GIT branch | sed -ne '/^\\* /{s///;p;q;}')\n\ncleanup()\n{\n  __st=$?\n  $dryrun rm -rf \"$tmp\"\n  $GIT checkout \"$current_branch\"\n  $GIT submodule update --recursive\n  $GIT branch -d $tmp_branch\n  exit $__st\n}\ntrap cleanup EXIT\ntrap 'exit $?' HUP INT PIPE TERM\n\n# We must build using sources for which --version reports the\n# just-released version number, not some string like 7.6.18-20761.\n# That version string propagates into all documentation.\nset -e\n$GIT checkout -b $tmp_branch v$version\n$GIT submodule update --recursive\n./bootstrap\nsrcdir=$(pwd)\ncd \"$builddir\"\nbuilddir=$(pwd)\n  ./config.status --recheck\n  ./config.status\n  make\n  make web-manual\ncd \"$srcdir\"\nset +e\n\ntmp=$(mktemp -d web-doc-update.XXXXXX) || exit 1\n( cd $tmp \\\n    && $CVS -d $cvs_user@cvs.savannah.gnu.org:/webcvs/$pkg co $pkg )\n$RSYNC -avP \"$builddir\"/doc/manual/ $tmp/$pkg/manual\n\n(\n  cd $tmp/$pkg\n  test -d manual/CVS || $dryrun $CVS add -ko manual\n\n  cd $tmp/$pkg/manual\n\n  # Add all the files.  This is simpler than trying to add only the\n  # new ones because of new directories\n  # First add non empty dirs individually\n  find . -name CVS -prune -o -type d \\! -empty -print             \\\n    | $XARGS -n1 --no-run-if-empty -- $dryrun $CVS add -ko\n  # Now add all files\n  find . -name CVS -prune -o -type f -print             \\\n    | $XARGS --no-run-if-empty -- $dryrun $CVS add -ko\n\n  # Report/Remove stale files\n  #   excluding doc server specific files like CVS/* and .symlinks\n  if test -n \"$rm_stale\"; then\n    echo 'Consider the --mirror option if all of the manual is generated,' >&2\n    echo 'which will run `cvs remove` to remove stale files.' >&2\n  fi\n  { find . \\( -name CVS -o -type f -name '.*' \\) -prune -o -type f -print\n    (cd \"$builddir\"/doc/manual/ && find . -type f -print | sed p)\n  } | sort | uniq -u \\\n    | $XARGS --no-run-if-empty -- ${rm_stale:-$dryrun} $CVS remove -f\n\n  $dryrun $CVS ci -m $version\n)\n\n# Local variables:\n# eval: (add-hook 'before-save-hook 'time-stamp)\n# time-stamp-start: \"VERSION=\"\n# time-stamp-format: \"%:y-%02m-%02d.%02H\"\n# time-stamp-time-zone: \"UTC0\"\n# time-stamp-end: \"; # UTC\"\n# End:\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}