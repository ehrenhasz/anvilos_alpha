{
  "module_name": "gnupload",
  "hash_id": "4d3a2eea860f341b90cf6d304f28f3525d3e8d3594c45cf2f32320aaa852a889",
  "original_prompt": "Ingested from coreutils-9.4/build-aux/gnupload",
  "human_readable_source": "#!/bin/sh\n# Sign files and upload them.\n\nscriptversion=2022-01-27.18; # UTC\n\n# Copyright (C) 2004-2023 Free Software Foundation, Inc.\n#\n# This program is free software; you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation; either version 2, or (at your option)\n# any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n# GNU General Public License for more details.\n#\n# You should have received a copy of the GNU General Public License\n# along with this program.  If not, see <https://www.gnu.org/licenses/>.\n\n# Originally written by Alexandre Duret-Lutz <adl@gnu.org>.\n# The master copy of this file is maintained in the gnulib Git repository.\n# Please send bug reports and feature requests to bug-gnulib@gnu.org.\n\nset -e\n\nGPG=gpg\n# Choose the proper version of gpg, so as to avoid a\n# \"gpg-agent is not available in this session\" error\n# when gpg-agent is version 2 but gpg is still version 1.\n# FIXME-2020: remove, once all major distros ship gpg version 2 as /usr/bin/gpg\ngpg_agent_version=`(gpg-agent --version) 2>/dev/null | sed -e '2,$d' -e 's/^[^0-9]*//'`\ncase \"$gpg_agent_version\" in\n  2.*)\n    gpg_version=`(gpg --version) 2>/dev/null | sed -e '2,$d' -e 's/^[^0-9]*//'`\n    case \"$gpg_version\" in\n      1.*)\n        if (type gpg2) >/dev/null 2>/dev/null; then\n          # gpg2 is present.\n          GPG=gpg2\n        else\n          # gpg2 is missing. Ubuntu users should install the package 'gnupg2'.\n          echo \"WARNING: Using 'gpg', which is too old. You should install 'gpg2'.\" 1>&2\n        fi\n        ;;\n    esac\n    ;;\nesac\n\nGPG=\"${GPG} --batch --no-tty\"\nconffile=.gnuploadrc\nto=\ndry_run=false\nreplace=\nsymlink_files=\ndelete_files=\ndelete_symlinks=\ncollect_var=\ndbg=\nnl='\n'\n\nusage=\"Usage: $0 [OPTION]... [CMD] FILE... [[CMD] FILE...]\n\nSign all FILES, and process them at the destinations specified with --to.\nIf CMD is not given, it defaults to uploading.  See examples below.\n\nCommands:\n  --delete                 delete FILES from destination\n  --symlink                create symbolic links\n  --rmsymlink              remove symbolic links\n  --                       treat the remaining arguments as files to upload\n\nOptions:\n  --to DEST                specify a destination DEST for FILES\n                           (multiple --to options are allowed)\n  --user NAME              sign with key NAME\n  --replace                allow replacements of existing files\n  --symlink-regex[=EXPR]   use sed script EXPR to compute symbolic link names\n  -n, --dry-run            do nothing, show what would have been done\n                           (including the constructed directive file)\n  --version                output version information and exit\n  -h, --help               print this help text and exit\n\nIf --symlink-regex is given without EXPR, then the link target name\nis created by replacing the version information with '-latest', e.g.:\n  foo-1.3.4.tar.gz -> foo-latest.tar.gz\n\nRecognized destinations are:\n  alpha.gnu.org:DIRECTORY\n  savannah.gnu.org:DIRECTORY\n  savannah.nongnu.org:DIRECTORY\n  ftp.gnu.org:DIRECTORY\n                           build directive files and upload files by FTP\n  download.gnu.org.ua:{alpha|ftp}/DIRECTORY\n                           build directive files and upload files by SFTP\n  [user@]host:DIRECTORY    upload files with scp\n\nOptions and commands are applied in order.  If the file $conffile exists\nin the current working directory, its contents are prepended to the\nactual command line options.  Use this to keep your defaults.  Comments\n(#) and empty lines in $conffile are allowed.\n\n<https://www.gnu.org/prep/maintain/html_node/Automated-FTP-Uploads.html>\ngives some further background.\n\nExamples:\n1. Upload foobar-1.0.tar.gz to ftp.gnu.org:\n  gnupload --to ftp.gnu.org:foobar foobar-1.0.tar.gz\n\n2. Upload foobar-1.0.tar.gz and foobar-1.0.tar.xz to ftp.gnu.org:\n  gnupload --to ftp.gnu.org:foobar foobar-1.0.tar.gz foobar-1.0.tar.xz\n\n3. Same as above, and also create symbolic links to foobar-latest.tar.*:\n  gnupload --to ftp.gnu.org:foobar \\\\\n           --symlink-regex \\\\\n           foobar-1.0.tar.gz foobar-1.0.tar.xz\n\n4. Create a symbolic link foobar-latest.tar.gz -> foobar-1.0.tar.gz\n   and likewise for the corresponding .sig file:\n  gnupload --to ftp.gnu.org:foobar \\\\\n           --symlink foobar-1.0.tar.gz     foobar-latest.tar.gz \\\\\n                     foobar-1.0.tar.gz.sig foobar-latest.tar.gz.sig\n  or (equivalent):\n  gnupload --to ftp.gnu.org:foobar \\\\\n           --symlink foobar-1.0.tar.gz     foobar-latest.tar.gz \\\\\n           --symlink foobar-1.0.tar.gz.sig foobar-latest.tar.gz.sig\n\n5. Upload foobar-0.9.90.tar.gz to two sites:\n  gnupload --to alpha.gnu.org:foobar \\\\\n           --to sources.redhat.com:~ftp/pub/foobar \\\\\n           foobar-0.9.90.tar.gz\n\n6. Delete oopsbar-0.9.91.tar.gz and upload foobar-0.9.91.tar.gz\n   (the -- terminates the list of files to delete):\n  gnupload --to alpha.gnu.org:foobar \\\\\n           --to sources.redhat.com:~ftp/pub/foobar \\\\\n           --delete oopsbar-0.9.91.tar.gz \\\\\n           -- foobar-0.9.91.tar.gz\n\ngnupload executes a program ncftpput to do the transfers; if you don't\nhappen to have an ncftp package installed, the ncftpput-ftp script in\nthe build-aux/ directory of the gnulib package\n(https://savannah.gnu.org/projects/gnulib) may serve as a replacement.\n\nSend patches and bug reports to <bug-gnulib@gnu.org>.\"\n\ncopyright_year=`echo \"$scriptversion\" | sed -e 's/[^0-9].*//'`\ncopyright=\"Copyright (C) ${copyright_year} Free Software Foundation, Inc.\nLicense GPLv2+: GNU GPL version 2 or later <https://gnu.org/licenses/gpl.html>.\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\"\n\n# Read local configuration file\nif test -r \"$conffile\"; then\n  echo \"$0: Reading configuration file $conffile\"\n  conf=`sed 's/#.*$//;/^$/d' \"$conffile\" | tr \"\\015$nl\" '  '`\n  eval set x \"$conf \\\"\\$@\\\"\"\n  shift\nfi\n\nwhile test -n \"$1\"; do\n  case $1 in\n  -*)\n    collect_var=\n    case $1 in\n    -h | --help)\n      echo \"$usage\"\n      exit $?\n      ;;\n    --to)\n      if test -z \"$2\"; then\n        echo \"$0: Missing argument for --to\" 1>&2\n        exit 1\n      elif echo \"$2\" | grep 'ftp-upload\\.gnu\\.org' >/dev/null; then\n        echo \"$0: Use ftp.gnu.org:PKGNAME or alpha.gnu.org:PKGNAME\" >&2\n        echo \"$0: for the destination, not ftp-upload.gnu.org (which\" >&2\n        echo \"$0:  is used for direct ftp uploads, not with gnupload).\" >&2\n        echo \"$0: See --help and its examples if need be.\" >&2\n        exit 1\n      else\n        to=\"$to $2\"\n        shift\n      fi\n      ;;\n    --user)\n      if test -z \"$2\"; then\n        echo \"$0: Missing argument for --user\" 1>&2\n        exit 1\n      else\n        GPG=\"$GPG --local-user $2\"\n        shift\n      fi\n      ;;\n    --delete)\n      collect_var=delete_files\n      ;;\n    --replace)\n      replace=\"replace: true\"\n      ;;\n    --rmsymlink)\n      collect_var=delete_symlinks\n      ;;\n    --symlink-regex=*)\n      symlink_expr=`expr \"$1\" : '[^=]*=\\(.*\\)'`\n      ;;\n    --symlink-regex)\n      symlink_expr='s|-[0-9][0-9\\.]*\\(-[0-9][0-9]*\\)\\{0,1\\}\\.|-latest.|'\n      ;;\n    --symlink)\n      collect_var=symlink_files\n      ;;\n    -n | --dry-run)\n      dry_run=:\n      ;;\n    --version)\n      echo \"gnupload $scriptversion\"\n      echo \"$copyright\"\n      exit 0\n      ;;\n    --)\n      shift\n      break\n      ;;\n    -*)\n      echo \"$0: Unknown option '$1', try '$0 --help'\" 1>&2\n      exit 1\n      ;;\n    esac\n    ;;\n  *)\n    if test -z \"$collect_var\"; then\n      break\n    else\n      eval \"$collect_var=\\\"\\$$collect_var $1\\\"\"\n    fi\n    ;;\n  esac\n  shift\ndone\n\ndprint()\n{\n  echo \"Running $* ...\"\n}\n\nif $dry_run; then\n  dbg=dprint\nfi\n\nif test -z \"$to\"; then\n  echo \"$0: Missing destination sites\" >&2\n  exit 1\nfi\n\nif test -n \"$symlink_files\"; then\n  x=`echo \"$symlink_files\" | sed 's/[^ ]//g;s/  //g'`\n  if test -n \"$x\"; then\n    echo \"$0: Odd number of symlink arguments\" >&2\n    exit 1\n  fi\nfi\n\nif test $# = 0; then\n  if test -z \"${symlink_files}${delete_files}${delete_symlinks}\"; then\n    echo \"$0: No file to upload\" 1>&2\n    exit 1\n  fi\nelse\n  # Make sure all files exist.  We don't want to ask\n  # for the passphrase if the script will fail.\n  for file\n  do\n    if test ! -f $file; then\n      echo \"$0: Cannot find '$file'\" 1>&2\n      exit 1\n    elif test -n \"$symlink_expr\"; then\n      linkname=`echo $file | sed \"$symlink_expr\"`\n      if test -z \"$linkname\"; then\n        echo \"$0: symlink expression produces empty results\" >&2\n        exit 1\n      elif test \"$linkname\" = $file; then\n        echo \"$0: symlink expression does not alter file name\" >&2\n        exit 1\n      fi\n    fi\n  done\nfi\n\n# Make sure passphrase is not exported in the environment.\nunset passphrase\nunset passphrase_fd_0\nGNUPGHOME=${GNUPGHOME:-$HOME/.gnupg}\n\n# Reset PATH to be sure that echo is a built-in.  We will later use\n# 'echo $passphrase' to output the passphrase, so it is important that\n# it is a built-in (third-party programs tend to appear in 'ps'\n# listings with their arguments...).\n# Remember this script runs with 'set -e', so if echo is not built-in\n# it will exit now.\nif $dry_run || grep -q \"^use-agent\" $GNUPGHOME/gpg.conf; then :; else\n  PATH=/empty echo -n \"Enter GPG passphrase: \"\n  stty -echo\n  read -r passphrase\n  stty echo\n  echo\n  passphrase_fd_0=\"--passphrase-fd 0\"\nfi\n\nif test $# -ne 0; then\n  for file\n  do\n    echo \"Signing $file ...\"\n    rm -f $file.sig\n    echo \"$passphrase\" | $dbg $GPG $passphrase_fd_0 -ba -o $file.sig $file\n  done\nfi\n\n\n# mkdirective DESTDIR BASE FILE STMT\n# Arguments: See upload, below\nmkdirective ()\n{\n  stmt=\"$4\"\n  if test -n \"$3\"; then\n    stmt=\"\nfilename: $3$stmt\"\n  fi\n\n  cat >${2}.directive<<EOF\nversion: 1.2\ndirectory: $1\ncomment: gnupload v. $scriptversion$stmt\nEOF\n  if $dry_run; then\n    echo \"File ${2}.directive:\"\n    cat ${2}.directive\n    echo \"File ${2}.directive:\" | sed 's/./-/g'\n  fi\n}\n\nmksymlink ()\n{\n  while test $# -ne 0\n  do\n    echo \"symlink: $1 $2\"\n    shift\n    shift\n  done\n}\n\n# upload DEST DESTDIR BASE FILE STMT FILES\n# Arguments:\n#  DEST     Destination site;\n#  DESTDIR  Destination directory;\n#  BASE     Base name for the directive file;\n#  FILE     Name of the file to distribute (may be empty);\n#  STMT     Additional statements for the directive file;\n#  FILES    List of files to upload.\nupload ()\n{\n  dest=$1\n  destdir=$2\n  base=$3\n  file=$4\n  stmt=$5\n  files=$6\n\n  rm -f $base.directive $base.directive.asc\n  case $dest in\n    alpha.gnu.org:*)\n      mkdirective \"$destdir\" \"$base\" \"$file\" \"$stmt\"\n      echo \"$passphrase\" | $dbg $GPG $passphrase_fd_0 --clearsign $base.directive\n      $dbg ncftpput ftp-upload.gnu.org /incoming/alpha $files $base.directive.asc\n      ;;\n    ftp.gnu.org:*)\n      mkdirective \"$destdir\" \"$base\" \"$file\" \"$stmt\"\n      echo \"$passphrase\" | $dbg $GPG $passphrase_fd_0 --clearsign $base.directive\n      $dbg ncftpput ftp-upload.gnu.org /incoming/ftp $files $base.directive.asc\n      ;;\n    savannah.gnu.org:*)\n      if test -z \"$files\"; then\n        echo \"$0: warning: standalone directives not applicable for $dest\" >&2\n      fi\n      $dbg ncftpput savannah.gnu.org /incoming/savannah/$destdir $files\n      ;;\n    savannah.nongnu.org:*)\n      if test -z \"$files\"; then\n        echo \"$0: warning: standalone directives not applicable for $dest\" >&2\n      fi\n      $dbg ncftpput savannah.nongnu.org /incoming/savannah/$destdir $files\n      ;;\n    download.gnu.org.ua:alpha/*|download.gnu.org.ua:ftp/*)\n      destdir_p1=`echo \"$destdir\" | sed 's,^[^/]*/,,'`\n      destdir_topdir=`echo \"$destdir\" | sed 's,/.*,,'`\n      mkdirective \"$destdir_p1\" \"$base\" \"$file\" \"$stmt\"\n      echo \"$passphrase\" | $dbg $GPG $passphrase_fd_0 --clearsign $base.directive\n      for f in $files $base.directive.asc\n      do\n        echo put $f\n      done | $dbg sftp -b - download.gnu.org.ua:/incoming/$destdir_topdir\n      ;;\n    /*)\n      dest_host=`echo \"$dest\" | sed 's,:.*,,'`\n      mkdirective \"$destdir\" \"$base\" \"$file\" \"$stmt\"\n      echo \"$passphrase\" | $dbg $GPG $passphrase_fd_0 --clearsign $base.directive\n      $dbg cp $files $base.directive.asc $dest_host\n      ;;\n    *)\n      if test -z \"$files\"; then\n        echo \"$0: warning: standalone directives not applicable for $dest\" >&2\n      fi\n      $dbg scp $files $dest\n      ;;\n  esac\n  rm -f $base.directive $base.directive.asc\n}\n\n#####\n# Process any standalone directives\nstmt=\nif test -n \"$symlink_files\"; then\n  stmt=\"$stmt\n`mksymlink $symlink_files`\"\nfi\n\nfor file in $delete_files\ndo\n  stmt=\"$stmt\narchive: $file\"\ndone\n\nfor file in $delete_symlinks\ndo\n  stmt=\"$stmt\nrmsymlink: $file\"\ndone\n\nif test -n \"$stmt\"; then\n  for dest in $to\n  do\n    destdir=`echo $dest | sed 's/[^:]*://'`\n    upload \"$dest\" \"$destdir\" \"`hostname`-$$\" \"\" \"$stmt\"\n  done\nfi\n\n# Process actual uploads\nfor dest in $to\ndo\n  for file\n  do\n    echo \"Uploading $file to $dest ...\"\n    stmt=\n    #\n    # allowing file replacement is all or nothing.\n    if test -n \"$replace\"; then stmt=\"$stmt\n$replace\"\n    fi\n    #\n    files=\"$file $file.sig\"\n    destdir=`echo $dest | sed 's/[^:]*://'`\n    if test -n \"$symlink_expr\"; then\n      linkname=`echo $file | sed \"$symlink_expr\"`\n      stmt=\"$stmt\nsymlink: $file $linkname\nsymlink: $file.sig $linkname.sig\"\n    fi\n    upload \"$dest\" \"$destdir\" \"$file\" \"$file\" \"$stmt\" \"$files\"\n  done\ndone\n\nexit 0\n\n# Local variables:\n# eval: (add-hook 'before-save-hook 'time-stamp)\n# time-stamp-start: \"scriptversion=\"\n# time-stamp-format: \"%:y-%02m-%02d.%02H\"\n# time-stamp-time-zone: \"UTC0\"\n# time-stamp-end: \"; # UTC\"\n# End:\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}