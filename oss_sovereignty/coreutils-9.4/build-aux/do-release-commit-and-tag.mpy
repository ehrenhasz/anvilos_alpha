{
  "module_name": "do-release-commit-and-tag",
  "hash_id": "85125965df8b1e74235408030425823ced89e5931cffe2fc2507cc61ba51d55b",
  "original_prompt": "Ingested from coreutils-9.4/build-aux/do-release-commit-and-tag",
  "human_readable_source": "#!/bin/sh\n# In a git/autoconf/automake-enabled project with a NEWS file and a version-\n# controlled .prev-version file, automate the procedure by which we record\n# the date, release-type and version string in the NEWS file.  That commit\n# will serve to identify the release, so apply a signed tag to it as well.\nVERSION=2018-03-07.03 # UTC\n\n# Note: this is a bash script (could be zsh or dash)\n\n# Copyright (C) 2009-2023 Free Software Foundation, Inc.\n\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 3 of the License, or\n# (at your option) any later version.\n\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n# GNU General Public License for more details.\n\n# You should have received a copy of the GNU General Public License\n# along with this program.  If not, see <https://www.gnu.org/licenses/>.\n\n# Written by Jim Meyering\n\nME=$(basename \"$0\")\nwarn() { printf '%s: %s\\n' \"$ME\" \"$*\" >&2; }\ndie() { warn \"$*\"; exit 1; }\n\nhelp()\n{\n  cat <<EOF\nUsage: $ME [OPTION...] VERSION RELEASE_TYPE\n\nRun this script from top_srcdir to perform the final pre-release NEWS\nupdate in which the date, release-type and version string are\nrecorded.  Commit that result with a log entry marking the release,\nand apply a signed tag.  Run it from your project's top-level\ndirectory.\n\nRequirements:\n- you use git for version-control\n- a version-controlled .prev-version file\n- a NEWS file, with line 3 identical to this:\n$noteworthy_stub\n\nOptions:\n  --branch=BRANCH     set release branch (default: $branch)\n  -C, --builddir=DIR  location of (configured) Makefile (default: $builddir)\n  --help              print this help, then exit\n  --version           print version number, then exit\n\nEXAMPLE:\nTo update NEWS and tag the beta 8.1 release of coreutils, I would run this:\n\n  $ME 8.1 beta\n\nReport bugs and patches to <bug-gnulib@gnu.org>.\nEOF\n  exit\n}\n\nversion()\n{\n  year=$(echo \"$VERSION\" | sed 's/[^0-9].*//')\n  cat <<EOF\n$ME $VERSION\nCopyright (C) $year Free Software Foundation, Inc,\nLicense GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\nEOF\n  exit\n}\n\n## ------ ##\n## Main.  ##\n## ------ ##\n\n# Constants.\nnoteworthy='* Noteworthy changes in release'\nnoteworthy_stub=\"$noteworthy ?.? (????-??-??) [?]\"\n\n# Variables.\nbranch=$(git branch | sed -ne '/^\\* /{s///;p;q;}')\nbuilddir=.\n\nwhile test $# != 0\ndo\n  # Handle --option=value by splitting apart and putting back on argv.\n  case $1 in\n    --*=*)\n      opt=$(echo \"$1\" | sed -e 's/=.*//')\n      val=$(echo \"$1\" | sed -e 's/[^=]*=//')\n      shift\n      set dummy \"$opt\" \"$val\" \"$@\"; shift\n      ;;\n  esac\n\n  case $1 in\n    --help|--version) ${1#--};;\n    --branch) shift; branch=$1; shift ;;\n    -C|--builddir) shift; builddir=$1; shift ;;\n    --*) die \"unrecognized option: $1\";;\n    *) break;;\n  esac\ndone\n\ntest $# = 2 \\\n  || die \"Usage: $ME [OPTION...] VERSION TYPE\"\n\nver=$1\ntype=$2\n\n\n## ---------------------- ##\n## First, sanity checks.  ##\n## ---------------------- ##\n\n# Verify that $ver looks like a version number, and...\necho \"$ver\"|grep -E '^[0-9][0-9.]*[0-9]$' > /dev/null \\\n  || die \"invalid version: $ver\"\nprev_ver=$(cat .prev-version) \\\n  || die 'failed to determine previous version number from .prev-version'\n\n# Verify that $ver is sensible (> .prev-version).\ncase $(printf \"%s\\n%s\\n\" \"$prev_ver\" \"$ver\"|sort -V -u|tr '\\n' ':') in\n  \"$prev_ver:$ver:\") ;;\n  *) die \"invalid version: $ver (<= $prev_ver)\";;\nesac\n\ncase $type in\n  alpha|beta|stable) ;;\n  *) die \"invalid release type: $type\";;\nesac\n\n# No local modifications allowed.\ncase $(git diff-index --name-only HEAD) in\n  '') ;;\n  *) die 'this tree is dirty; commit your changes first';;\nesac\n\n# Ensure the current branch name is correct:\ncurr_br=$(git rev-parse --symbolic-full-name HEAD)\ntest \"$curr_br\" = \"refs/heads/$branch\" || die not on branch $branch\n\n# Extract package name from Makefile.\nMakefile=$builddir/Makefile\npkg=$(sed -n 's/^PACKAGE = \\(.*\\)/\\1/p' \"$Makefile\") \\\n  || die \"failed to determine package name from $Makefile\"\n\n# Check that line 3 of NEWS is the stub line about to be replaced.\ntest \"$(sed -n 3p NEWS)\" = \"$noteworthy_stub\" \\\n  || die \"line 3 of NEWS must be exactly '$noteworthy_stub'\"\n\n## --------------- ##\n## Then, changes.  ##\n## --------------- ##\n\n# Update NEWS to have today's date, plus desired version number and $type.\nperl -MPOSIX -ni -e 'my $today = strftime \"%F\", localtime time;' \\\n -e 'my ($type, $ver) = qw('\"$type $ver\"');' \\\n -e 'my $pfx = \"'\"$noteworthy\"'\";' \\\n -e 'print $.==3 ? \"$pfx $ver ($today) [$type]\\n\" : $_' \\\n     NEWS || die 'failed to update NEWS'\n\nprintf \"version %s\\n\\n* NEWS: Record release date.\\n\" \"$ver\" \\\n    | git commit -F -  -a || die 'git commit failed'\ngit tag -s -m \"$pkg $ver\" v$ver HEAD || die 'git tag failed'\n\n# Local variables:\n# indent-tabs-mode: nil\n# eval: (add-hook 'before-save-hook 'time-stamp)\n# time-stamp-start: \"VERSION=\"\n# time-stamp-format: \"%:y-%02m-%02d.%02H\"\n# time-stamp-time-zone: \"UTC0\"\n# time-stamp-end: \" # UTC\"\n# End:\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}