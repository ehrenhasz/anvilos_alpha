{
  "module_name": "get-permissions.c",
  "hash_id": "caeb4d12ba91aa7fe2c10d94cd4a4f8ec005115e7e1986a463ba5f3e317369eb",
  "original_prompt": "Ingested from coreutils-9.4/lib/get-permissions.c",
  "human_readable_source": " \n\n#include <config.h>\n\n#include <string.h>\n#include \"acl.h\"\n\n#include \"acl-internal.h\"\n\n \n\nint\nget_permissions (const char *name, int desc, mode_t mode,\n                 struct permission_context *ctx)\n{\n  memset (ctx, 0, sizeof *ctx);\n  ctx->mode = mode;\n\n#if USE_ACL && HAVE_ACL_GET_FILE\n   \n   \n# if !HAVE_ACL_TYPE_EXTENDED\n   \n\n  if (HAVE_ACL_GET_FD && desc != -1)\n    ctx->acl = acl_get_fd (desc);\n  else\n    ctx->acl = acl_get_file (name, ACL_TYPE_ACCESS);\n  if (ctx->acl == NULL)\n    return acl_errno_valid (errno) ? -1 : 0;\n\n   \n\n  if (S_ISDIR (mode))\n    {\n      ctx->default_acl = acl_get_file (name, ACL_TYPE_DEFAULT);\n      if (ctx->default_acl == NULL)\n        return -1;\n    }\n\n#  if HAVE_ACL_TYPE_NFS4   \n\n   \n\n#  endif\n\n# else  \n   \n\n   \n\n  if (HAVE_ACL_GET_FD && desc != -1)\n    ctx->acl = acl_get_fd (desc);\n  else\n    ctx->acl = acl_get_file (name, ACL_TYPE_EXTENDED);\n  if (ctx->acl == NULL)\n    return acl_errno_valid (errno) ? -1 : 0;\n\n# endif\n\n#elif USE_ACL && defined GETACL  \n\n   \n# ifdef ACE_GETACL\n   \n  for (;;)\n    {\n      int ret;\n\n      if (desc != -1)\n        ret = facl (desc, ACE_GETACLCNT, 0, NULL);\n      else\n        ret = acl (name, ACE_GETACLCNT, 0, NULL);\n      if (ret < 0)\n        {\n          if (errno == ENOSYS || errno == EINVAL)\n            ret = 0;\n          else\n            return -1;\n        }\n      ctx->ace_count = ret;\n\n      if (ctx->ace_count == 0)\n        break;\n\n      ctx->ace_entries = (ace_t *) malloc (ctx->ace_count * sizeof (ace_t));\n      if (ctx->ace_entries == NULL)\n        {\n          errno = ENOMEM;\n          return -1;\n        }\n\n      if (desc != -1)\n        ret = facl (desc, ACE_GETACL, ctx->ace_count, ctx->ace_entries);\n      else\n        ret = acl (name, ACE_GETACL, ctx->ace_count, ctx->ace_entries);\n      if (ret < 0)\n        {\n          if (errno == ENOSYS || errno == EINVAL)\n            {\n              free (ctx->ace_entries);\n              ctx->ace_entries = NULL;\n              ctx->ace_count = 0;\n              break;\n            }\n          else\n            return -1;\n        }\n      if (ret <= ctx->ace_count)\n        {\n          ctx->ace_count = ret;\n          break;\n        }\n       \n      free (ctx->ace_entries);\n      ctx->ace_entries = NULL;\n    }\n# endif\n\n  for (;;)\n    {\n      int ret;\n\n      if (desc != -1)\n        ret = facl (desc, GETACLCNT, 0, NULL);\n      else\n        ret = acl (name, GETACLCNT, 0, NULL);\n      if (ret < 0)\n        {\n          if (errno == ENOSYS || errno == ENOTSUP || errno == EOPNOTSUPP)\n            ret = 0;\n          else\n            return -1;\n        }\n      ctx->count = ret;\n\n      if (ctx->count == 0)\n        break;\n\n      ctx->entries = (aclent_t *) malloc (ctx->count * sizeof (aclent_t));\n      if (ctx->entries == NULL)\n        {\n          errno = ENOMEM;\n          return -1;\n        }\n\n      if (desc != -1)\n        ret = facl (desc, GETACL, ctx->count, ctx->entries);\n      else\n        ret = acl (name, GETACL, ctx->count, ctx->entries);\n      if (ret < 0)\n        {\n          if (errno == ENOSYS || errno == ENOTSUP || errno == EOPNOTSUPP)\n            {\n              free (ctx->entries);\n              ctx->entries = NULL;\n              ctx->count = 0;\n              break;\n            }\n          else\n            return -1;\n        }\n      if (ret <= ctx->count)\n        {\n          ctx->count = ret;\n          break;\n        }\n       \n      free (ctx->entries);\n      ctx->entries = NULL;\n    }\n\n#elif USE_ACL && HAVE_GETACL  \n\n  {\n    int ret;\n\n    if (desc != -1)\n      ret = fgetacl (desc, NACLENTRIES, ctx->entries);\n    else\n      ret = getacl (name, NACLENTRIES, ctx->entries);\n    if (ret < 0)\n      {\n        if (errno == ENOSYS || errno == EOPNOTSUPP || errno == ENOTSUP)\n          ret = 0;\n        else\n          return -1;\n      }\n    else if (ret > NACLENTRIES)\n       \n      abort ();\n    ctx->count = ret;\n\n# if HAVE_ACLV_H\n    ret = acl ((char *) name, ACL_GET, NACLVENTRIES, ctx->aclv_entries);\n    if (ret < 0)\n      {\n        if (errno == ENOSYS || errno == EOPNOTSUPP || errno == EINVAL)\n          ret = 0;\n        else\n          return -2;\n      }\n    else if (ret > NACLVENTRIES)\n       \n      abort ();\n    ctx->aclv_count = ret;\n# endif\n  }\n\n#elif USE_ACL && HAVE_ACLX_GET && ACL_AIX_WIP  \n\n   \n\n#elif USE_ACL && HAVE_STATACL  \n\n  {\n    int ret;\n    if (desc != -1)\n      ret = fstatacl (desc, STX_NORMAL, &ctx->u.a, sizeof ctx->u);\n    else\n      ret = statacl ((char *) name, STX_NORMAL, &ctx->u.a, sizeof ctx->u);\n    if (ret == 0)\n      ctx->have_u = true;\n  }\n\n#elif USE_ACL && HAVE_ACLSORT  \n\n  {\n    int ret = acl ((char *) name, ACL_GET, NACLENTRIES, ctx->entries);\n    if (ret < 0)\n      return -1;\n    else if (ret > NACLENTRIES)\n       \n      abort ();\n    ctx->count = ret;\n  }\n\n#endif\n\n  return 0;\n\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}