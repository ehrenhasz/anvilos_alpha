{
  "module_name": "mbtowc-lock.h",
  "hash_id": "66684d35b2a165b05d619c33358316ad83bf8305aab2c342c121ceee1b830627",
  "original_prompt": "Ingested from coreutils-9.4/lib/mbtowc-lock.h",
  "human_readable_source": " \n\n \n\nstatic inline int\nmbtowc_unlocked (wchar_t *pwc, const char *p, size_t m)\n{\n   \n#undef gl_get_mbtowc_lock\n\n#if GNULIB_MBRTOWC_SINGLE_THREAD\n\n \n\nstatic int\nmbtowc_with_lock (wchar_t *pwc, const char *p, size_t m)\n{\n  return mbtowc_unlocked (pwc, p, m);\n}\n\n#elif defined _WIN32 && !defined __CYGWIN__\n\nextern __declspec(dllimport) CRITICAL_SECTION *gl_get_mbtowc_lock (void);\n\nstatic int\nmbtowc_with_lock (wchar_t *pwc, const char *p, size_t m)\n{\n  CRITICAL_SECTION *lock = gl_get_mbtowc_lock ();\n  int ret;\n\n  EnterCriticalSection (lock);\n  ret = mbtowc_unlocked (pwc, p, m);\n  LeaveCriticalSection (lock);\n\n  return ret;\n}\n\n#elif HAVE_PTHREAD_API  \n\nextern\n# if defined _WIN32 || defined __CYGWIN__\n  __declspec(dllimport)\n# endif\n  pthread_mutex_t *gl_get_mbtowc_lock (void);\n\n# if HAVE_WEAK_SYMBOLS  \n\n    \n#  pragma weak pthread_mutex_lock\n#  pragma weak pthread_mutex_unlock\n\n    \n#  pragma weak pthread_mutexattr_gettype\n    \n#  define pthread_in_use() \\\n     (pthread_mutexattr_gettype != NULL || c11_threads_in_use ())\n\n# else\n#  define pthread_in_use() 1\n# endif\n\nstatic int\nmbtowc_with_lock (wchar_t *pwc, const char *p, size_t m)\n{\n  if (pthread_in_use())\n    {\n      pthread_mutex_t *lock = gl_get_mbtowc_lock ();\n      int ret;\n\n      if (pthread_mutex_lock (lock))\n        abort ();\n      ret = mbtowc_unlocked (pwc, p, m);\n      if (pthread_mutex_unlock (lock))\n        abort ();\n\n      return ret;\n    }\n  else\n    return mbtowc_unlocked (pwc, p, m);\n}\n\n#elif HAVE_THREADS_H\n\nextern mtx_t *gl_get_mbtowc_lock (void);\n\nstatic int\nmbtowc_with_lock (wchar_t *pwc, const char *p, size_t m)\n{\n  mtx_t *lock = gl_get_mbtowc_lock ();\n  int ret;\n\n  if (mtx_lock (lock) != thrd_success)\n    abort ();\n  ret = mbtowc_unlocked (pwc, p, m);\n  if (mtx_unlock (lock) != thrd_success)\n    abort ();\n\n  return ret;\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}