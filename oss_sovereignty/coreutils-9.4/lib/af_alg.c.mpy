{
  "module_name": "af_alg.c",
  "hash_id": "c047d68b13320f64add67676ee81bb72b310aab80c4825baf7ba4f9fa83b8607",
  "original_prompt": "Ingested from coreutils-9.4/lib/af_alg.c",
  "human_readable_source": " \n\n#include <config.h>\n\n#include \"af_alg.h\"\n\n#if USE_LINUX_CRYPTO_API\n\n#include <unistd.h>\n#include <string.h>\n#include <stdio.h>\n#include <errno.h>\n#include <linux/if_alg.h>\n#include <sys/stat.h>\n#include <sys/sendfile.h>\n#include <sys/socket.h>\n\n#include \"sys-limits.h\"\n\n#define BLOCKSIZE 32768\n\n \nstatic int\nalg_socket (char const *alg)\n{\n  struct sockaddr_alg salg = {\n    .salg_family = AF_ALG,\n    .salg_type = \"hash\",\n  };\n   \n  for (size_t i = 0; (salg.salg_name[i] = alg[i]) != '\\0'; i++)\n    if (i == sizeof salg.salg_name - 1)\n       \n      return -EINVAL;\n\n  int cfd = socket (AF_ALG, SOCK_SEQPACKET | SOCK_CLOEXEC, 0);\n  if (cfd < 0)\n    return -EAFNOSUPPORT;\n  int ofd = (bind (cfd, (struct sockaddr *) &salg, sizeof salg) == 0\n             ? accept4 (cfd, NULL, 0, SOCK_CLOEXEC)\n             : -1);\n  close (cfd);\n  return ofd < 0 ? -EAFNOSUPPORT : ofd;\n}\n\nint\nafalg_buffer (const char *buffer, size_t len, const char *alg,\n              void *resblock, ssize_t hashlen)\n{\n   \n  int fd = fileno (stream);\n  int result;\n  struct stat st;\n  off_t off = ftello (stream);\n  if (0 <= off && fstat (fd, &st) == 0\n      && (S_ISREG (st.st_mode) || S_TYPEISSHM (&st) || S_TYPEISTMO (&st))\n      && off < st.st_size && st.st_size - off < SYS_BUFSIZE_MAX)\n    {\n       \n      if (fflush (stream))\n        result = -EIO;\n      else\n        {\n          off_t nbytes = st.st_size - off;\n          if (sendfile (ofd, fd, &off, nbytes) == nbytes)\n            {\n              if (read (ofd, resblock, hashlen) == hashlen)\n                {\n                   \n                  if (lseek (fd, off, SEEK_SET) != (off_t)-1)\n                    result = 0;\n                  else\n                     \n                    result = -EAFNOSUPPORT;\n                }\n              else\n                 \n                result = -EAFNOSUPPORT;\n            }\n          else\n             \n            result = -EAFNOSUPPORT;\n       }\n    }\n  else\n    {\n       \n\n       \n      off_t nseek = 0;\n\n      for (;;)\n        {\n          char buf[BLOCKSIZE];\n           \n          size_t blocksize = (nseek == 0 && off < 0 ? 1 : BLOCKSIZE);\n          ssize_t size = fread (buf, 1, blocksize, stream);\n          if (size == 0)\n            {\n               \n              result = ferror (stream) ? -EIO : nseek == 0 ? -EAFNOSUPPORT : 0;\n              break;\n            }\n          nseek -= size;\n          if (send (ofd, buf, size, MSG_MORE) != size)\n            {\n              if (nseek == -1)\n                {\n                   \n                  ungetc ((unsigned char) buf[0], stream);\n                  result = -EAFNOSUPPORT;\n                }\n              else if (fseeko (stream, nseek, SEEK_CUR) == 0)\n                 \n                result = -EAFNOSUPPORT;\n              else\n                result = -EIO;\n              break;\n            }\n\n           \n            result = -EAFNOSUPPORT;\n          else\n            result = -EIO;\n        }\n    }\n  close (ofd);\n  return result;\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}