{
  "module_name": "tempname.c",
  "hash_id": "3de504ab1b7a4e4eebec79bde5561c29d6791b70b9a78b899d70dba070fd13d2",
  "original_prompt": "Ingested from coreutils-9.4/lib/tempname.c",
  "human_readable_source": " \ntypedef uint_fast64_t random_value;\n#define RANDOM_VALUE_MAX UINT_FAST64_MAX\n#define BASE_62_DIGITS 10  \n#define BASE_62_POWER (62LL * 62 * 62 * 62 * 62 * 62 * 62 * 62 * 62 * 62)\n\n \n\nstatic random_value\nmix_random_values (random_value r, random_value s)\n{\n   \n  return (2862933555777941757 * r + 3037000493) ^ s;\n}\n\n \n\nstatic bool\nrandom_bits (random_value *r, random_value s)\n{\n   \n  if (__getrandom (r, sizeof *r, GRND_NONBLOCK) == sizeof *r)\n    return true;\n\n   \n\n  random_value v = s;\n\n#if _LIBC || (defined CLOCK_REALTIME && HAVE_CLOCK_GETTIME)\n  struct __timespec64 tv;\n  __clock_gettime64 (CLOCK_REALTIME, &tv);\n  v = mix_random_values (v, tv.tv_sec);\n  v = mix_random_values (v, tv.tv_nsec);\n#endif\n\n  *r = mix_random_values (v, clock ());\n  return false;\n}\n\n#if _LIBC\nstatic int try_tempname_len (char *, int, void *, int (*) (char *, void *),\n                             size_t);\n#endif\n\nstatic int\ntry_file (char *tmpl, void *flags)\n{\n  int *openflags = flags;\n  return __open (tmpl,\n                 (*openflags & ~O_ACCMODE)\n                 | O_RDWR | O_CREAT | O_EXCL, S_IRUSR | S_IWUSR);\n}\n\nstatic int\ntry_dir (char *tmpl, _GL_UNUSED void *flags)\n{\n  return __mkdir (tmpl, S_IRUSR | S_IWUSR | S_IXUSR);\n}\n\nstatic int\ntry_nocreate (char *tmpl, _GL_UNUSED void *flags)\n{\n  struct_stat64 st;\n\n  if (__lstat64_time64 (tmpl, &st) == 0 || errno == EOVERFLOW)\n    __set_errno (EEXIST);\n  return errno == ENOENT ? 0 : -1;\n}\n\n \nstatic const char letters[] =\n\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n\n \n#ifdef _LIBC\nstatic\n#endif\nint\ngen_tempname_len (char *tmpl, int suffixlen, int flags, int kind,\n                  size_t x_suffix_len)\n{\n  static int (*const tryfunc[]) (char *, void *) =\n    {\n      [__GT_FILE] = try_file,\n      [__GT_DIR] = try_dir,\n      [__GT_NOCREATE] = try_nocreate\n    };\n  return try_tempname_len (tmpl, suffixlen, &flags, tryfunc[kind],\n                           x_suffix_len);\n}\n\n#ifdef _LIBC\nstatic\n#endif\nint\ntry_tempname_len (char *tmpl, int suffixlen, void *args,\n                  int (*tryfunc) (char *, void *), size_t x_suffix_len)\n{\n  size_t len;\n  char *XXXXXX;\n  unsigned int count;\n  int fd = -1;\n  int save_errno = errno;\n\n   \n#define ATTEMPTS_MIN (62 * 62 * 62)\n\n   \n#if ATTEMPTS_MIN < TMP_MAX\n  unsigned int attempts = TMP_MAX;\n#else\n  unsigned int attempts = ATTEMPTS_MIN;\n#endif\n\n   \n  random_value v = 0;\n\n   \n  random_value vdigbuf;\n  int vdigits = 0;\n\n   \n  random_value const biased_min\n    = RANDOM_VALUE_MAX - RANDOM_VALUE_MAX % BASE_62_POWER;\n\n  len = strlen (tmpl);\n  if (len < x_suffix_len + suffixlen\n      || strspn (&tmpl[len - x_suffix_len - suffixlen], \"X\") < x_suffix_len)\n    {\n      __set_errno (EINVAL);\n      return -1;\n    }\n\n   \n  XXXXXX = &tmpl[len - x_suffix_len - suffixlen];\n\n  for (count = 0; count < attempts; ++count)\n    {\n      for (size_t i = 0; i < x_suffix_len; i++)\n        {\n          if (vdigits == 0)\n            {\n               \n              while (random_bits (&v, v) && biased_min <= v)\n                continue;\n\n              vdigbuf = v;\n              vdigits = BASE_62_DIGITS;\n            }\n\n          XXXXXX[i] = letters[vdigbuf % 62];\n          vdigbuf /= 62;\n          vdigits--;\n        }\n\n      fd = tryfunc (tmpl, args);\n      if (fd >= 0)\n        {\n          __set_errno (save_errno);\n          return fd;\n        }\n      else if (errno != EEXIST)\n        return -1;\n    }\n\n   \n  __set_errno (EEXIST);\n  return -1;\n}\n\nint\n__gen_tempname (char *tmpl, int suffixlen, int flags, int kind)\n{\n  return gen_tempname_len (tmpl, suffixlen, flags, kind, 6);\n}\n\n#if !_LIBC\nint\ntry_tempname (char *tmpl, int suffixlen, void *args,\n              int (*tryfunc) (char *, void *))\n{\n  return try_tempname_len (tmpl, suffixlen, args, tryfunc, 6);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}