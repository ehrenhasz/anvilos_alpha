{
  "module_name": "fts-cycle.c",
  "hash_id": "23cbfd2c358fca976fb1937c6b218bafc80a086104e759228fc615990d9afb4f",
  "original_prompt": "Ingested from coreutils-9.4/lib/fts-cycle.c",
  "human_readable_source": " \nstruct Active_dir\n{\n  dev_t dev;\n  ino_t ino;\n  FTSENT *fts_ent;\n};\n\nstatic bool\nAD_compare (void const *x, void const *y)\n{\n  struct Active_dir const *ax = x;\n  struct Active_dir const *ay = y;\n  return ax->ino == ay->ino\n      && ax->dev == ay->dev;\n}\n\nstatic size_t\nAD_hash (void const *x, size_t table_size)\n{\n  struct Active_dir const *ax = x;\n  return (uintmax_t) ax->ino % table_size;\n}\n\n \n\nstatic bool\nsetup_dir (FTS *fts)\n{\n  if (fts->fts_options & (FTS_TIGHT_CYCLE_CHECK | FTS_LOGICAL))\n    {\n      enum { HT_INITIAL_SIZE = 31 };\n      fts->fts_cycle.ht = hash_initialize (HT_INITIAL_SIZE, NULL, AD_hash,\n                                           AD_compare, free);\n      if (! fts->fts_cycle.ht)\n        return false;\n    }\n  else\n    {\n      fts->fts_cycle.state = malloc (sizeof *fts->fts_cycle.state);\n      if (! fts->fts_cycle.state)\n        return false;\n      cycle_check_init (fts->fts_cycle.state);\n    }\n\n  return true;\n}\n\n \n\nstatic bool\nenter_dir (FTS *fts, FTSENT *ent)\n{\n  if (fts->fts_options & (FTS_TIGHT_CYCLE_CHECK | FTS_LOGICAL))\n    {\n      struct stat const *st = ent->fts_statp;\n      struct Active_dir *ad = malloc (sizeof *ad);\n      struct Active_dir *ad_from_table;\n\n      if (!ad)\n        return false;\n\n      ad->dev = st->st_dev;\n      ad->ino = st->st_ino;\n      ad->fts_ent = ent;\n\n       \n      ad_from_table = hash_insert (fts->fts_cycle.ht, ad);\n\n      if (ad_from_table != ad)\n        {\n          free (ad);\n          if (!ad_from_table)\n            return false;\n\n           \n          ent->fts_cycle = ad_from_table->fts_ent;\n          ent->fts_info = FTS_DC;\n        }\n    }\n  else\n    {\n      if (cycle_check (fts->fts_cycle.state, ent->fts_statp))\n        {\n           \n          ent->fts_cycle = ent;\n          ent->fts_info = FTS_DC;\n        }\n    }\n\n  return true;\n}\n\n \n\nstatic void\nleave_dir (FTS *fts, FTSENT *ent)\n{\n  struct stat const *st = ent->fts_statp;\n  if (fts->fts_options & (FTS_TIGHT_CYCLE_CHECK | FTS_LOGICAL))\n    {\n      struct Active_dir obj;\n      void *found;\n      obj.dev = st->st_dev;\n      obj.ino = st->st_ino;\n      found = hash_remove (fts->fts_cycle.ht, &obj);\n      if (!found)\n        abort ();\n      free (found);\n    }\n  else\n    {\n      FTSENT *parent = ent->fts_parent;\n      if (parent != NULL && 0 <= parent->fts_level)\n        CYCLE_CHECK_REFLECT_CHDIR_UP (fts->fts_cycle.state,\n                                      *(parent->fts_statp), *st);\n    }\n}\n\n \n\nstatic void\nfree_dir (FTS *sp)\n{\n  if (sp->fts_options & (FTS_TIGHT_CYCLE_CHECK | FTS_LOGICAL))\n    {\n      if (sp->fts_cycle.ht)\n        hash_free (sp->fts_cycle.ht);\n    }\n  else\n    free (sp->fts_cycle.state);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}