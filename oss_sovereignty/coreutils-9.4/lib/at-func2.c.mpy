{
  "module_name": "at-func2.c",
  "hash_id": "a184e93e7203e94bea9f4963f2bca3d635ba33e495f5c57688d7e5a668c82f62",
  "original_prompt": "Ingested from coreutils-9.4/lib/at-func2.c",
  "human_readable_source": " \n\n#include <config.h>\n\n#include \"openat-priv.h\"\n\n#include <errno.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n\n#include \"filename.h\"  \n#include \"filenamecat.h\"\n#include \"openat.h\"\n#include \"same-inode.h\"\n#include \"save-cwd.h\"\n\n \nint\nat_func2 (int fd1, char const *file1,\n          int fd2, char const *file2,\n          int (*func) (char const *file1, char const *file2))\n{\n  struct saved_cwd saved_cwd;\n  int saved_errno;\n  int err;\n  char *file1_alt;\n  char *file2_alt;\n  struct stat st1;\n  struct stat st2;\n\n   \n\n  if ((fd1 == AT_FDCWD || IS_ABSOLUTE_FILE_NAME (file1))\n      && (fd2 == AT_FDCWD || IS_ABSOLUTE_FILE_NAME (file2)))\n    return func (file1, file2);  \n\n   \n  {\n    char proc_buf1[OPENAT_BUFFER_SIZE];\n    char *proc_file1 = ((fd1 == AT_FDCWD || IS_ABSOLUTE_FILE_NAME (file1))\n                        ? (char *) file1\n                        : openat_proc_name (proc_buf1, fd1, file1));\n    if (proc_file1)\n      {\n        char proc_buf2[OPENAT_BUFFER_SIZE];\n        char *proc_file2 = ((fd2 == AT_FDCWD || IS_ABSOLUTE_FILE_NAME (file2))\n                            ? (char *) file2\n                            : openat_proc_name (proc_buf2, fd2, file2));\n        if (proc_file2)\n          {\n            int proc_result = func (proc_file1, proc_file2);\n            int proc_errno = errno;\n            if (proc_file1 != proc_buf1 && proc_file1 != file1)\n              free (proc_file1);\n            if (proc_file2 != proc_buf2 && proc_file2 != file2)\n              free (proc_file2);\n             \n            if (0 <= proc_result)\n              return proc_result;\n            if (! EXPECTED_ERRNO (proc_errno))\n              {\n                errno = proc_errno;\n                return proc_result;\n              }\n          }\n        else if (proc_file1 != proc_buf1 && proc_file1 != file1)\n          free (proc_file1);\n      }\n  }\n\n   \n  if (IS_ABSOLUTE_FILE_NAME (file1))\n    fd1 = AT_FDCWD;  \n  else if (IS_ABSOLUTE_FILE_NAME (file2))\n    fd2 = AT_FDCWD;  \n\n   \n\n  if (fd1 == AT_FDCWD)  \n    {\n      if (stat (\".\", &st1) == -1 || fstat (fd2, &st2) == -1)\n        return -1;\n      if (!S_ISDIR (st2.st_mode))\n        {\n          errno = ENOTDIR;\n          return -1;\n        }\n      if (SAME_INODE (st1, st2))  \n        return func (file1, file2);\n    }\n  else if (fd2 == AT_FDCWD)  \n    {\n      if (stat (\".\", &st2) == -1 || fstat (fd1, &st1) == -1)\n        return -1;\n      if (!S_ISDIR (st1.st_mode))\n        {\n          errno = ENOTDIR;\n          return -1;\n        }\n      if (SAME_INODE (st1, st2))  \n        return func (file1, file2);\n    }\n  else if (fd1 != fd2)  \n    {\n      if (fstat (fd1, &st1) == -1 || fstat (fd2, &st2) == -1)\n        return -1;\n      if (!S_ISDIR (st1.st_mode) || !S_ISDIR (st2.st_mode))\n        {\n          errno = ENOTDIR;\n          return -1;\n        }\n      if (SAME_INODE (st1, st2))  \n        {\n          fd2 = fd1;\n          if (stat (\".\", &st1) == 0 && SAME_INODE (st1, st2))\n            return func (file1, file2);  \n        }\n    }\n  else  \n    {\n      if (fstat (fd1, &st1) == -1)\n        return -1;\n      if (!S_ISDIR (st1.st_mode))\n        {\n          errno = ENOTDIR;\n          return -1;\n        }\n      if (stat (\".\", &st2) == 0 && SAME_INODE (st1, st2))\n        return func (file1, file2);  \n    }\n\n   \n  if (file1[0] == '\\0' || file2[0] == '\\0')\n    {\n      errno = ENOENT;\n      return -1;\n    }\n\n   \n\n  if (save_cwd (&saved_cwd) != 0)\n    openat_save_fail (errno);\n\n  if (fd1 != AT_FDCWD && fd2 != AT_FDCWD && fd1 != fd2)  \n    {\n      if (fchdir (fd1) != 0)\n        {\n          saved_errno = errno;\n          free_cwd (&saved_cwd);\n          errno = saved_errno;\n          return -1;\n        }\n      fd1 = AT_FDCWD;  \n    }\n\n   \n\n  file1_alt = (char *) file1;\n  file2_alt = (char *) file2;\n\n  if (fd1 == AT_FDCWD && !IS_ABSOLUTE_FILE_NAME (file1))  \n    {\n       \n      char *cwd = getcwd (NULL, 0);\n      if (!cwd)\n        {\n          saved_errno = errno;\n          free_cwd (&saved_cwd);\n          errno = saved_errno;\n          return -1;\n        }\n      file1_alt = mfile_name_concat (cwd, file1, NULL);\n      if (!file1_alt)\n        {\n          saved_errno = errno;\n          free (cwd);\n          free_cwd (&saved_cwd);\n          errno = saved_errno;\n          return -1;\n        }\n      free (cwd);  \n    }\n  else if (fd2 == AT_FDCWD && !IS_ABSOLUTE_FILE_NAME (file2))  \n    {\n      char *cwd = getcwd (NULL, 0);\n      if (!cwd)\n        {\n          saved_errno = errno;\n          free_cwd (&saved_cwd);\n          errno = saved_errno;\n          return -1;\n        }\n      file2_alt = mfile_name_concat (cwd, file2, NULL);\n      if (!file2_alt)\n        {\n          saved_errno = errno;\n          free (cwd);\n          free_cwd (&saved_cwd);\n          errno = saved_errno;\n          return -1;\n        }\n      free (cwd);  \n    }\n\n   \n  if (fchdir (fd1 == AT_FDCWD ? fd2 : fd1) != 0)\n    {\n      saved_errno = errno;\n      free_cwd (&saved_cwd);\n      if (file1 != file1_alt)\n        free (file1_alt);\n      else if (file2 != file2_alt)\n        free (file2_alt);\n      errno = saved_errno;\n      return -1;\n    }\n\n   \n\n  err = func (file1_alt, file2_alt);\n  saved_errno = (err < 0 ? errno : 0);\n\n  if (file1 != file1_alt)\n    free (file1_alt);\n  else if (file2 != file2_alt)\n    free (file2_alt);\n\n  if (restore_cwd (&saved_cwd) != 0)\n    openat_restore_fail (errno);\n\n  free_cwd (&saved_cwd);\n\n  if (saved_errno)\n    errno = saved_errno;\n  return err;\n}\n#undef CALL_FUNC\n#undef FUNC_RESULT\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}