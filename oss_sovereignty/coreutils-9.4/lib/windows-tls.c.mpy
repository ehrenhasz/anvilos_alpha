{
  "module_name": "windows-tls.c",
  "hash_id": "c30333fdda3be20a96cf0e65e4d5f5000cb809944b9c8beddb43192a17ca1e18",
  "original_prompt": "Ingested from coreutils-9.4/lib/windows-tls.c",
  "human_readable_source": " \n\n#include <config.h>\n\n \n#include \"windows-tls.h\"\n\n#include <errno.h>\n#include <limits.h>\n#include <stdlib.h>\n\n#include \"windows-once.h\"\n\nvoid *\nglwthread_tls_get (glwthread_tls_key_t key)\n{\n  return TlsGetValue (key);\n}\n\nint\nglwthread_tls_set (glwthread_tls_key_t key, void *value)\n{\n  if (!TlsSetValue (key, value))\n    return EINVAL;\n  return 0;\n}\n\n \n\nstatic glwthread_once_t dtor_table_init_once = GLWTHREAD_ONCE_INIT;\n\nstatic CRITICAL_SECTION dtor_table_lock;\n\nstruct dtor { glwthread_tls_key_t key; void (*destructor) (void *); };\n\n \nstatic struct dtor *dtor_table;\n \nstatic unsigned int dtors_count;\n \nstatic unsigned int dtors_used;\n \nstatic unsigned int dtors_allocated;\n \n\n \nstatic unsigned int dtor_processing_threads;\n\nstatic void\ndtor_table_initialize (void)\n{\n  InitializeCriticalSection (&dtor_table_lock);\n   \n}\n\nstatic void\ndtor_table_ensure_initialized (void)\n{\n  glwthread_once (&dtor_table_init_once, dtor_table_initialize);\n}\n\n \nstatic void\ndtor_table_shrink_used (void)\n{\n  unsigned int i = 0;\n  unsigned int j = dtors_used;\n\n  for (;;)\n    {\n      BOOL i_found = FALSE;\n      BOOL j_found = FALSE;\n       \n      for (; i < dtors_count;)\n        {\n          if (dtor_table[i].destructor == NULL)\n            {\n              i_found = TRUE;\n              break;\n            }\n          i++;\n        }\n\n       \n      for (; j > dtors_count;)\n        {\n          j--;\n          if (dtor_table[j].destructor != NULL)\n            {\n              j_found = TRUE;\n              break;\n            }\n        }\n\n      if (i_found != j_found)\n         \n        abort ();\n\n      if (!i_found)\n        break;\n\n       \n      dtor_table[i] = dtor_table[j];\n\n      i++;\n    }\n\n  dtors_used = dtors_count;\n}\n\nvoid\nglwthread_tls_process_destructors (void)\n{\n  unsigned int repeat;\n\n  dtor_table_ensure_initialized ();\n\n  EnterCriticalSection (&dtor_table_lock);\n  if (dtor_processing_threads == 0)\n    {\n       \n      if (dtors_used > dtors_count)\n        dtor_table_shrink_used ();\n    }\n  dtor_processing_threads++;\n\n  for (repeat = GLWTHREAD_DESTRUCTOR_ITERATIONS; repeat > 0; repeat--)\n    {\n      unsigned int destructors_run = 0;\n\n       \n      unsigned int i_limit = dtors_used;\n      unsigned int i;\n\n      for (i = 0; i < i_limit; i++)\n        {\n          struct dtor current = dtor_table[i];\n          if (current.destructor != NULL)\n            {\n               \n              void *current_value = glwthread_tls_get (current.key);\n              if (current_value != NULL)\n                {\n                   \n                  glwthread_tls_set (current.key, NULL);\n                  LeaveCriticalSection (&dtor_table_lock);\n                  current.destructor (current_value);\n                  EnterCriticalSection (&dtor_table_lock);\n                  destructors_run++;\n                }\n            }\n        }\n\n       \n      if (destructors_run == 0)\n        break;\n    }\n\n  dtor_processing_threads--;\n  LeaveCriticalSection (&dtor_table_lock);\n}\n\nint\nglwthread_tls_key_create (glwthread_tls_key_t *keyp, void (*destructor) (void *))\n{\n  if (destructor != NULL)\n    {\n      dtor_table_ensure_initialized ();\n\n      EnterCriticalSection (&dtor_table_lock);\n      if (dtor_processing_threads == 0)\n        {\n           \n          if (dtors_used > dtors_count)\n            dtor_table_shrink_used ();\n        }\n\n      while (dtors_used == dtors_allocated)\n        {\n           \n          unsigned int new_allocated = 2 * dtors_allocated + 1;\n          if (new_allocated < 7)\n            new_allocated = 7;\n          if (new_allocated <= dtors_allocated)  \n            new_allocated = UINT_MAX;\n\n          LeaveCriticalSection (&dtor_table_lock);\n          {\n            struct dtor *new_table =\n              (struct dtor *) malloc (new_allocated * sizeof (struct dtor));\n            if (new_table == NULL)\n              return ENOMEM;\n            EnterCriticalSection (&dtor_table_lock);\n             \n            if (dtors_used < new_allocated)\n              {\n                if (dtors_allocated < new_allocated)\n                  {\n                     \n                    memcpy (new_table, dtor_table,\n                            dtors_used * sizeof (struct dtor));\n                    dtor_table = new_table;\n                    dtors_allocated = new_allocated;\n                  }\n                else\n                  {\n                     \n                    free (new_table);\n                  }\n                break;\n              }\n             \n            free (new_table);\n          }\n        }\n       \n      {\n         \n        glwthread_tls_key_t key = TlsAlloc ();\n        if (key == (DWORD)-1)\n          {\n            LeaveCriticalSection (&dtor_table_lock);\n            return EAGAIN;\n          }\n         \n        dtor_table[dtors_used].key = key;\n        dtor_table[dtors_used].destructor = destructor;\n        dtors_used++;\n        dtors_count++;\n        LeaveCriticalSection (&dtor_table_lock);\n        *keyp = key;\n      }\n    }\n  else\n    {\n       \n      glwthread_tls_key_t key = TlsAlloc ();\n      if (key == (DWORD)-1)\n        return EAGAIN;\n      *keyp = key;\n    }\n  return 0;\n}\n\nint\nglwthread_tls_key_delete (glwthread_tls_key_t key)\n{\n   \n  dtor_table_ensure_initialized ();\n\n  EnterCriticalSection (&dtor_table_lock);\n  if (dtor_processing_threads == 0)\n    {\n       \n      if (dtors_used > dtors_count)\n        dtor_table_shrink_used ();\n       \n\n       \n      {\n        unsigned int i_limit = dtors_used;\n        unsigned int i;\n\n        for (i = 0; i < i_limit; i++)\n          if (dtor_table[i].key == key)\n            {\n              if (i < dtors_used - 1)\n                 \n                dtor_table[i] = dtor_table[dtors_used - 1];\n              dtors_count = dtors_used = dtors_used - 1;\n              break;\n            }\n      }\n    }\n  else\n    {\n       \n      unsigned int i_limit = dtors_used;\n      unsigned int i;\n\n      for (i = 0; i < i_limit; i++)\n        if (dtor_table[i].destructor != NULL  \n            && dtor_table[i].key == key)\n          {\n             \n            dtor_table[i].destructor = NULL;\n            dtors_count = dtors_count - 1;\n            break;\n          }\n    }\n  LeaveCriticalSection (&dtor_table_lock);\n   \n\n  if (!TlsFree (key))\n    return EINVAL;\n  return 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}