{
  "module_name": "ftruncate.c",
  "hash_id": "a71a3af7fe0e2b133e5b5eb6c83319cb9604ce157e3ec1b2a3e9209fcfc0bdcc",
  "original_prompt": "Ingested from coreutils-9.4/lib/ftruncate.c",
  "human_readable_source": " \n#include <unistd.h>\n\n#if HAVE__CHSIZE\n \n\n# include <errno.h>\n\n# if _GL_WINDOWS_64_BIT_OFF_T\n\n \n\n \n#  if !defined _WIN32_WINNT || (_WIN32_WINNT < _WIN32_WINNT_WIN2K)\n#   undef _WIN32_WINNT\n#   define _WIN32_WINNT _WIN32_WINNT_WIN2K\n#  endif\n\n \n#  define WIN32_LEAN_AND_MEAN\n#  include <windows.h>\n\n \n#  if GNULIB_MSVC_NOTHROW\n#   include \"msvc-nothrow.h\"\n#  else\n#   include <io.h>\n#  endif\n\nstatic BOOL\nSetFileSize (HANDLE h, LONGLONG size)\n{\n  LARGE_INTEGER old_size;\n\n  if (!GetFileSizeEx (h, &old_size))\n    return FALSE;\n\n  if (size != old_size.QuadPart)\n    {\n       \n      HANDLE curr_process = GetCurrentProcess ();\n      HANDLE tmph;\n\n      if (!DuplicateHandle (curr_process,            \n                            h,                       \n                            curr_process,            \n                            (PHANDLE) &tmph,         \n                            (DWORD) 0,               \n                            FALSE,                   \n                            DUPLICATE_SAME_ACCESS))  \n        return FALSE;\n\n      if (size < old_size.QuadPart)\n        {\n           \n          LONG size_hi = (LONG) (size >> 32);\n          if (SetFilePointer (tmph, (LONG) size, &size_hi, FILE_BEGIN)\n              == INVALID_SET_FILE_POINTER\n              && GetLastError() != NO_ERROR)\n            {\n              CloseHandle (tmph);\n              return FALSE;\n            }\n          if (!SetEndOfFile (tmph))\n            {\n              CloseHandle (tmph);\n              return FALSE;\n            }\n        }\n      else\n        {\n           \n          static char zero_bytes[1024];\n          LONG pos_hi = 0;\n          LONG pos_lo = SetFilePointer (tmph, (LONG) 0, &pos_hi, FILE_END);\n          LONGLONG pos;\n          if (pos_lo == INVALID_SET_FILE_POINTER\n              && GetLastError() != NO_ERROR)\n            {\n              CloseHandle (tmph);\n              return FALSE;\n            }\n          pos = ((LONGLONG) pos_hi << 32) | (ULONGLONG) (ULONG) pos_lo;\n          while (pos < size)\n            {\n              DWORD written;\n              LONGLONG count = size - pos;\n              if (count > sizeof (zero_bytes))\n                count = sizeof (zero_bytes);\n              if (!WriteFile (tmph, zero_bytes, (DWORD) count, &written, NULL)\n                  || written == 0)\n                {\n                  CloseHandle (tmph);\n                  return FALSE;\n                }\n              pos += (ULONGLONG) (ULONG) written;\n            }\n        }\n       \n      CloseHandle (tmph);\n    }\n  return TRUE;\n}\n\nint\nftruncate (int fd, off_t length)\n{\n  HANDLE handle = (HANDLE) _get_osfhandle (fd);\n\n  if (handle == INVALID_HANDLE_VALUE)\n    {\n      errno = EBADF;\n      return -1;\n    }\n  if (length < 0)\n    {\n      errno = EINVAL;\n      return -1;\n    }\n  if (!SetFileSize (handle, length))\n    {\n      switch (GetLastError ())\n        {\n        case ERROR_ACCESS_DENIED:\n          errno = EACCES;\n          break;\n        case ERROR_HANDLE_DISK_FULL:\n        case ERROR_DISK_FULL:\n        case ERROR_DISK_TOO_FRAGMENTED:\n          errno = ENOSPC;\n          break;\n        default:\n          errno = EIO;\n          break;\n        }\n      return -1;\n    }\n  return 0;\n}\n\n# else\n\n#  include <io.h>\n\n#  if HAVE_MSVC_INVALID_PARAMETER_HANDLER\n#   include \"msvc-inval.h\"\nstatic int\nchsize_nothrow (int fd, long length)\n{\n  int result;\n\n  TRY_MSVC_INVAL\n    {\n      result = _chsize (fd, length);\n    }\n  CATCH_MSVC_INVAL\n    {\n      result = -1;\n      errno = EBADF;\n    }\n  DONE_MSVC_INVAL;\n\n  return result;\n}\n#  else\n#   define chsize_nothrow _chsize\n#  endif\n\nint\nftruncate (int fd, off_t length)\n{\n  return chsize_nothrow (fd, length);\n}\n\n# endif\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}