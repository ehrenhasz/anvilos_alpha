{
  "module_name": "utimensat.c",
  "hash_id": "be2dbdc7f8329549add6e06f295852c252e2c02afb16ad5cb905324e35d713bf",
  "original_prompt": "Ingested from coreutils-9.4/lib/utimensat.c",
  "human_readable_source": " \n\n#include <config.h>\n\n \n#include <sys/stat.h>\n\n#include <errno.h>\n#include <fcntl.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/stat.h>\n\n#include \"stat-time.h\"\n#include \"timespec.h\"\n#include \"utimens.h\"\n\n#if HAVE_NEARLY_WORKING_UTIMENSAT\n\n \nint\nrpl_utimensat (int fd, char const *file, struct timespec const times[2],\n               int flag)\n# undef utimensat\n{\n  size_t len = strlen (file);\n  if (len && file[len - 1] == '/')\n    {\n      struct stat st;\n      if (fstatat (fd, file, &st, flag & AT_SYMLINK_NOFOLLOW) < 0)\n        return -1;\n      if (!S_ISDIR (st.st_mode))\n        {\n          errno = ENOTDIR;\n          return -1;\n        }\n    }\n\n  return utimensat (fd, file, times, flag);\n}\n\n#else\n\n# if HAVE_UTIMENSAT\n\n \n\nstatic int local_utimensat (int, char const *, struct timespec const[2], int);\n#  define AT_FUNC_NAME local_utimensat\n\n \n\nint\nrpl_utimensat (int fd, char const *file, struct timespec const times[2],\n               int flag)\n#  undef utimensat\n{\n#  if defined __linux__ || defined __sun\n  struct timespec ts[2];\n#  endif\n\n   \n  static int utimensat_works_really;  \n  if (0 <= utimensat_works_really)\n    {\n      int result;\n#  if defined __linux__ || defined __sun\n      struct stat st;\n       \n      if (times && (times[0].tv_nsec == UTIME_OMIT\n                    || times[1].tv_nsec == UTIME_OMIT))\n        {\n          if (fstatat (fd, file, &st, flag))\n            return -1;\n          if (times[0].tv_nsec == UTIME_OMIT && times[1].tv_nsec == UTIME_OMIT)\n            return 0;\n          if (times[0].tv_nsec == UTIME_OMIT)\n            ts[0] = get_stat_atime (&st);\n          else\n            ts[0] = times[0];\n          if (times[1].tv_nsec == UTIME_OMIT)\n            ts[1] = get_stat_mtime (&st);\n          else\n            ts[1] = times[1];\n          times = ts;\n        }\n#   ifdef __hppa__\n       \n      else if (times\n               && ((times[0].tv_nsec != UTIME_NOW\n                    && ! (0 <= times[0].tv_nsec\n                          && times[0].tv_nsec < TIMESPEC_HZ))\n                   || (times[1].tv_nsec != UTIME_NOW\n                       && ! (0 <= times[1].tv_nsec\n                             && times[1].tv_nsec < TIMESPEC_HZ))))\n        {\n          errno = EINVAL;\n          return -1;\n        }\n#   endif\n#  endif\n#  if defined __APPLE__ && defined __MACH__\n       \n      if (times\n          && ((times[0].tv_nsec != UTIME_OMIT\n               && times[0].tv_nsec != UTIME_NOW\n               && ! (0 <= times[0].tv_nsec\n                     && times[0].tv_nsec < TIMESPEC_HZ))\n              || (times[1].tv_nsec != UTIME_OMIT\n                  && times[1].tv_nsec != UTIME_NOW\n                  && ! (0 <= times[1].tv_nsec\n                        && times[1].tv_nsec < TIMESPEC_HZ))))\n        {\n          errno = EINVAL;\n          return -1;\n        }\n      size_t len = strlen (file);\n      if (len > 0 && file[len - 1] == '/')\n        {\n          struct stat statbuf;\n          if (fstatat (fd, file, &statbuf, 0) < 0)\n            return -1;\n          if (!S_ISDIR (statbuf.st_mode))\n            {\n              errno = ENOTDIR;\n              return -1;\n            }\n        }\n#  endif\n      result = utimensat (fd, file, times, flag);\n       \n      if (result == -1 && errno == EINVAL && (flag & ~AT_SYMLINK_NOFOLLOW))\n        return result;\n      if (result == 0 || (errno != ENOSYS && errno != EINVAL))\n        {\n          utimensat_works_really = 1;\n          return result;\n        }\n    }\n   \n  if (0 <= utimensat_works_really && errno == ENOSYS)\n    utimensat_works_really = -1;\n  return local_utimensat (fd, file, times, flag);\n}\n\n# else  \n\n#  define AT_FUNC_NAME utimensat\n\n# endif  \n\n \n\n \n# define AT_FUNC_F1 lutimens\n# define AT_FUNC_F2 utimens\n# define AT_FUNC_USE_F1_COND AT_SYMLINK_NOFOLLOW\n# define AT_FUNC_POST_FILE_PARAM_DECLS , struct timespec const ts[2], int flag\n# define AT_FUNC_POST_FILE_ARGS        , ts\n# include \"at-func.c\"\n# undef AT_FUNC_NAME\n# undef AT_FUNC_F1\n# undef AT_FUNC_F2\n# undef AT_FUNC_USE_F1_COND\n# undef AT_FUNC_POST_FILE_PARAM_DECLS\n# undef AT_FUNC_POST_FILE_ARGS\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}