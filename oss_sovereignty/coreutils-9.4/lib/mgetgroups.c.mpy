{
  "module_name": "mgetgroups.c",
  "hash_id": "c50114250f0d86002238f90cc303bb6754570a3221b98c26c536c6a8790eb7b4",
  "original_prompt": "Ingested from coreutils-9.4/lib/mgetgroups.c",
  "human_readable_source": " \n\n#include <config.h>\n\n#include \"mgetgroups.h\"\n\n#include <stdlib.h>\n#include <unistd.h>\n#include <stdint.h>\n#include <string.h>\n#include <errno.h>\n#if HAVE_GETGROUPLIST\n# include <grp.h>\n#endif\n\n#include \"getugroups.h\"\n#include \"xalloc-oversized.h\"\n\n \n#if 4 < __GNUC__ + (3 <= __GNUC_MINOR__) || defined __clang__\n# pragma GCC diagnostic ignored \"-Wpointer-sign\"\n#endif\n\nstatic gid_t *\nrealloc_groupbuf (gid_t *g, size_t num)\n{\n  if (xalloc_oversized (num, sizeof *g))\n    {\n      errno = ENOMEM;\n      return NULL;\n    }\n\n  return realloc (g, num * sizeof *g);\n}\n\n \n\nint\nmgetgroups (char const *username, gid_t gid, gid_t **groups)\n{\n  int max_n_groups;\n  int ng;\n  gid_t *g;\n\n#if HAVE_GETGROUPLIST\n   \n  if (username)\n    {\n      enum { N_GROUPS_INIT = 10 };\n      max_n_groups = N_GROUPS_INIT;\n\n      g = realloc_groupbuf (NULL, max_n_groups);\n      if (g == NULL)\n        return -1;\n\n      while (1)\n        {\n          gid_t *h;\n          int last_n_groups = max_n_groups;\n\n           \n          ng = getgrouplist (username, gid, g, &max_n_groups);\n\n           \n          if (ng < 0 && last_n_groups == max_n_groups)\n            max_n_groups *= 2;\n\n          if ((h = realloc_groupbuf (g, max_n_groups)) == NULL)\n            {\n              free (g);\n              return -1;\n            }\n          g = h;\n\n          if (0 <= ng)\n            {\n              *groups = g;\n               \n              return max_n_groups;\n            }\n        }\n    }\n   \n#endif\n\n  max_n_groups = (username\n                  ? getugroups (0, NULL, username, gid)\n                  : getgroups (0, NULL));\n\n   \n  if (max_n_groups < 0)\n    {\n      if (errno == ENOSYS && (g = realloc_groupbuf (NULL, 1)))\n        {\n          *groups = g;\n          *g = gid;\n          return gid != (gid_t) -1;\n        }\n      return -1;\n    }\n\n  if (max_n_groups == 0 || (!username && gid != (gid_t) -1))\n    max_n_groups++;\n  g = realloc_groupbuf (NULL, max_n_groups);\n  if (g == NULL)\n    return -1;\n\n  ng = (username\n        ? getugroups (max_n_groups, g, username, gid)\n        : getgroups (max_n_groups - (gid != (gid_t) -1),\n                                g + (gid != (gid_t) -1)));\n\n  if (ng < 0)\n    {\n       \n      free (g);\n      return -1;\n    }\n\n  if (!username && gid != (gid_t) -1)\n    {\n      *g = gid;\n      ng++;\n    }\n  *groups = g;\n\n   \n  if (1 < ng)\n    {\n      gid_t first = *g;\n      gid_t *next;\n      gid_t *groups_end = g + ng;\n\n      for (next = g + 1; next < groups_end; next++)\n        {\n          if (*next == first || *next == *g)\n            ng--;\n          else\n            *++g = *next;\n        }\n    }\n\n  return ng;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}