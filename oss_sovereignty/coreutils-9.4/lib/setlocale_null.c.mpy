{
  "module_name": "setlocale_null.c",
  "hash_id": "998d2abdfde99db8eb7fa31db1a88762258b7a541bdfcd26f4349932c305ab43",
  "original_prompt": "Ingested from coreutils-9.4/lib/setlocale_null.c",
  "human_readable_source": " \n\n#include <config.h>\n\n \n#include \"setlocale_null.h\"\n\n#include <errno.h>\n#include <locale.h>\n#include <stdlib.h>\n#include <string.h>\n#if defined _WIN32 && !defined __CYGWIN__\n# include <wchar.h>\n#endif\n\n#if !(SETLOCALE_NULL_ALL_MTSAFE && SETLOCALE_NULL_ONE_MTSAFE)\n# if defined _WIN32 && !defined __CYGWIN__\n\n#  define WIN32_LEAN_AND_MEAN   \n#  include <windows.h>\n\n# elif HAVE_PTHREAD_API\n\n#  include <pthread.h>\n#  if HAVE_THREADS_H && HAVE_WEAK_SYMBOLS\n#   include <threads.h>\n#   pragma weak thrd_exit\n#   define c11_threads_in_use() (thrd_exit != NULL)\n#  else\n#   define c11_threads_in_use() 0\n#  endif\n\n# elif HAVE_THREADS_H\n\n#  include <threads.h>\n\n# endif\n#endif\n\n \n#undef setlocale\n\nstatic const char *\nsetlocale_null_androidfix (int category)\n{\n  const char *result = setlocale (category, NULL);\n\n#ifdef __ANDROID__\n  if (result == NULL)\n    switch (category)\n      {\n      case LC_CTYPE:\n      case LC_NUMERIC:\n      case LC_TIME:\n      case LC_COLLATE:\n      case LC_MONETARY:\n      case LC_MESSAGES:\n      case LC_ALL:\n      case LC_PAPER:\n      case LC_NAME:\n      case LC_ADDRESS:\n      case LC_TELEPHONE:\n      case LC_MEASUREMENT:\n        result = \"C\";\n        break;\n      default:\n        break;\n      }\n#endif\n\n  return result;\n}\n\nstatic int\nsetlocale_null_unlocked (int category, char *buf, size_t bufsize)\n{\n#if defined _WIN32 && !defined __CYGWIN__ && defined _MSC_VER\n   \n  const wchar_t *result = _wsetlocale (category, NULL);\n\n  if (result == NULL)\n    {\n       \n      if (bufsize > 0)\n         \n        buf[0] = '\\0';\n      return EINVAL;\n    }\n  else\n    {\n      size_t length = wcslen (result);\n      if (length < bufsize)\n        {\n          size_t i;\n\n           \n          for (i = 0; i <= length; i++)\n            buf[i] = result[i];\n\n          return 0;\n        }\n      else\n        {\n          if (bufsize > 0)\n            {\n               \n              size_t i;\n\n               \n              for (i = 0; i < bufsize; i++)\n                buf[i] = result[i];\n              buf[bufsize - 1] = '\\0';\n            }\n          return ERANGE;\n        }\n    }\n#else\n  const char *result = setlocale_null_androidfix (category);\n\n  if (result == NULL)\n    {\n       \n      if (bufsize > 0)\n         \n        buf[0] = '\\0';\n      return EINVAL;\n    }\n  else\n    {\n      size_t length = strlen (result);\n      if (length < bufsize)\n        {\n          memcpy (buf, result, length + 1);\n          return 0;\n        }\n      else\n        {\n          if (bufsize > 0)\n            {\n               \n              memcpy (buf, result, bufsize - 1);\n              buf[bufsize - 1] = '\\0';\n            }\n          return ERANGE;\n        }\n    }\n#endif\n}\n\n#if !(SETLOCALE_NULL_ALL_MTSAFE && SETLOCALE_NULL_ONE_MTSAFE)  \n\n \n\n \n# undef gl_get_setlocale_null_lock\n\n# if defined _WIN32 && !defined __CYGWIN__\n\nextern __declspec(dllimport) CRITICAL_SECTION *gl_get_setlocale_null_lock (void);\n\nstatic int\nsetlocale_null_with_lock (int category, char *buf, size_t bufsize)\n{\n  CRITICAL_SECTION *lock = gl_get_setlocale_null_lock ();\n  int ret;\n\n  EnterCriticalSection (lock);\n  ret = setlocale_null_unlocked (category, buf, bufsize);\n  LeaveCriticalSection (lock);\n\n  return ret;\n}\n\n# elif HAVE_PTHREAD_API  \n\nextern\n#  if defined _WIN32 || defined __CYGWIN__\n  __declspec(dllimport)\n#  endif\n  pthread_mutex_t *gl_get_setlocale_null_lock (void);\n\n#  if HAVE_WEAK_SYMBOLS  \n\n     \n#   pragma weak pthread_mutex_lock\n#   pragma weak pthread_mutex_unlock\n\n     \n#   pragma weak pthread_mutexattr_gettype\n     \n#   define pthread_in_use() \\\n      (pthread_mutexattr_gettype != NULL || c11_threads_in_use ())\n\n#  else\n#   define pthread_in_use() 1\n#  endif\n\nstatic int\nsetlocale_null_with_lock (int category, char *buf, size_t bufsize)\n{\n  if (pthread_in_use())\n    {\n      pthread_mutex_t *lock = gl_get_setlocale_null_lock ();\n      int ret;\n\n      if (pthread_mutex_lock (lock))\n        abort ();\n      ret = setlocale_null_unlocked (category, buf, bufsize);\n      if (pthread_mutex_unlock (lock))\n        abort ();\n\n      return ret;\n    }\n  else\n    return setlocale_null_unlocked (category, buf, bufsize);\n}\n\n# elif HAVE_THREADS_H\n\nextern mtx_t *gl_get_setlocale_null_lock (void);\n\nstatic int\nsetlocale_null_with_lock (int category, char *buf, size_t bufsize)\n{\n  mtx_t *lock = gl_get_setlocale_null_lock ();\n  int ret;\n\n  if (mtx_lock (lock) != thrd_success)\n    abort ();\n  ret = setlocale_null_unlocked (category, buf, bufsize);\n  if (mtx_unlock (lock) != thrd_success)\n    abort ();\n\n  return ret;\n}\n\n# endif\n\n#endif\n\nint\nsetlocale_null_r (int category, char *buf, size_t bufsize)\n{\n#if SETLOCALE_NULL_ALL_MTSAFE\n# if SETLOCALE_NULL_ONE_MTSAFE\n\n  return setlocale_null_unlocked (category, buf, bufsize);\n\n# else\n\n  if (category == LC_ALL)\n    return setlocale_null_unlocked (category, buf, bufsize);\n  else\n    return setlocale_null_with_lock (category, buf, bufsize);\n\n# endif\n#else\n# if SETLOCALE_NULL_ONE_MTSAFE\n\n  if (category == LC_ALL)\n    return setlocale_null_with_lock (category, buf, bufsize);\n  else\n    return setlocale_null_unlocked (category, buf, bufsize);\n\n# else\n\n  return setlocale_null_with_lock (category, buf, bufsize);\n\n# endif\n#endif\n}\n\nconst char *\nsetlocale_null (int category)\n{\n#if SETLOCALE_NULL_ALL_MTSAFE && SETLOCALE_NULL_ONE_MTSAFE\n  return setlocale_null_androidfix (category);\n#else\n\n   \n  if (category == LC_ALL)\n    {\n# if SETLOCALE_NULL_ALL_MTSAFE\n      return setlocale_null_androidfix (LC_ALL);\n# else\n      char buf[SETLOCALE_NULL_ALL_MAX];\n      static char resultbuf[SETLOCALE_NULL_ALL_MAX];\n\n      if (setlocale_null_r (LC_ALL, buf, sizeof (buf)))\n        return \"C\";\n      strcpy (resultbuf, buf);\n      return resultbuf;\n# endif\n    }\n  else\n    {\n# if SETLOCALE_NULL_ONE_MTSAFE\n      return setlocale_null_androidfix (category);\n# else\n      enum\n        {\n          LC_CTYPE_INDEX,\n          LC_NUMERIC_INDEX,\n          LC_TIME_INDEX,\n          LC_COLLATE_INDEX,\n          LC_MONETARY_INDEX,\n          LC_MESSAGES_INDEX,\n#  ifdef LC_PAPER\n          LC_PAPER_INDEX,\n#  endif\n#  ifdef LC_NAME\n          LC_NAME_INDEX,\n#  endif\n#  ifdef LC_ADDRESS\n          LC_ADDRESS_INDEX,\n#  endif\n#  ifdef LC_TELEPHONE\n          LC_TELEPHONE_INDEX,\n#  endif\n#  ifdef LC_MEASUREMENT\n          LC_MEASUREMENT_INDEX,\n#  endif\n#  ifdef LC_IDENTIFICATION\n          LC_IDENTIFICATION_INDEX,\n#  endif\n          LC_INDICES_COUNT\n        }\n        i;\n      char buf[SETLOCALE_NULL_MAX];\n      static char resultbuf[LC_INDICES_COUNT][SETLOCALE_NULL_MAX];\n      int err;\n\n      err = setlocale_null_r (category, buf, sizeof (buf));\n      if (err == EINVAL)\n        return NULL;\n      if (err)\n        return \"C\";\n\n      switch (category)\n        {\n        case LC_CTYPE:          i = LC_CTYPE_INDEX;          break;\n        case LC_NUMERIC:        i = LC_NUMERIC_INDEX;        break;\n        case LC_TIME:           i = LC_TIME_INDEX;           break;\n        case LC_COLLATE:        i = LC_COLLATE_INDEX;        break;\n        case LC_MONETARY:       i = LC_MONETARY_INDEX;       break;\n        case LC_MESSAGES:       i = LC_MESSAGES_INDEX;       break;\n#  ifdef LC_PAPER\n        case LC_PAPER:          i = LC_PAPER_INDEX;          break;\n#  endif\n#  ifdef LC_NAME\n        case LC_NAME:           i = LC_NAME_INDEX;           break;\n#  endif\n#  ifdef LC_ADDRESS\n        case LC_ADDRESS:        i = LC_ADDRESS_INDEX;        break;\n#  endif\n#  ifdef LC_TELEPHONE\n        case LC_TELEPHONE:      i = LC_TELEPHONE_INDEX;      break;\n#  endif\n#  ifdef LC_MEASUREMENT\n        case LC_MEASUREMENT:    i = LC_MEASUREMENT_INDEX;    break;\n#  endif\n#  ifdef LC_IDENTIFICATION\n        case LC_IDENTIFICATION: i = LC_IDENTIFICATION_INDEX; break;\n#  endif\n        default:\n           \n          abort ();\n        }\n\n      strcpy (resultbuf[i], buf);\n      return resultbuf[i];\n# endif\n    }\n#endif\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}