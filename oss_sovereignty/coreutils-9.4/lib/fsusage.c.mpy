{
  "module_name": "fsusage.c",
  "hash_id": "c0853b2ba83f39e78ecc8df4c1499e227a47547f9acf49f1fef1fb9328d3ab73",
  "original_prompt": "Ingested from coreutils-9.4/lib/fsusage.c",
  "human_readable_source": " \n# include <sys/statvfs.h>\n#else\n \n# include <fcntl.h>\n# include <unistd.h>\n# include <sys/stat.h>\n#if HAVE_SYS_PARAM_H\n# include <sys/param.h>\n#endif\n#if HAVE_SYS_MOUNT_H\n# include <sys/mount.h>\n#endif\n#if HAVE_SYS_VFS_H\n# include <sys/vfs.h>\n#endif\n# if HAVE_SYS_FS_S5PARAM_H       \n#  include <sys/fs/s5param.h>\n# endif\n# if HAVE_SYS_STATFS_H\n#  include <sys/statfs.h>\n# endif\n#endif\n\n \n#define PROPAGATE_ALL_ONES(x) \\\n  ((sizeof (x) < sizeof (uintmax_t) \\\n    && (~ (x) == (sizeof (x) < sizeof (int) \\\n                  ? - (1 << (sizeof (x) * CHAR_BIT)) \\\n                  : 0))) \\\n   ? UINTMAX_MAX : (uintmax_t) (x))\n\n \n#define EXTRACT_TOP_BIT(x) ((x) \\\n                            & ((uintmax_t) 1 << (sizeof (x) * CHAR_BIT - 1)))\n\n \n#define PROPAGATE_TOP_BIT(x) ((x) | ~ (EXTRACT_TOP_BIT (x) - 1))\n\n#ifdef STAT_STATVFS\n \n# if ! (__linux__ && (__GLIBC__ || __UCLIBC__))\n \n#  undef STAT_STATFS2_FRSIZE\nstatic int statvfs_works (void) { return 1; }\n# else\n#  include <string.h>  \n#  include <sys/utsname.h>\n#  include <sys/statfs.h>\n#  define STAT_STATFS2_BSIZE 1\n\nstatic int\nstatvfs_works (void)\n{\n  static int statvfs_works_cache = -1;\n  struct utsname name;\n  if (statvfs_works_cache < 0)\n    statvfs_works_cache = (uname (&name) == 0\n                           && 0 <= strverscmp (name.release, \"2.6.36\"));\n  return statvfs_works_cache;\n}\n# endif\n#endif\n\n\n \nint\nget_fs_usage (char const *file, char const *disk, struct fs_usage *fsp)\n{\n#ifdef STAT_STATVFS      \n\n  if (statvfs_works ())\n    {\n      struct statvfs vfsd;\n\n      if (statvfs (file, &vfsd) < 0)\n        return -1;\n\n       \n      fsp->fsu_blocksize = (vfsd.f_frsize\n                            ? PROPAGATE_ALL_ONES (vfsd.f_frsize)\n                            : PROPAGATE_ALL_ONES (vfsd.f_bsize));\n\n      fsp->fsu_blocks = PROPAGATE_ALL_ONES (vfsd.f_blocks);\n      fsp->fsu_bfree = PROPAGATE_ALL_ONES (vfsd.f_bfree);\n      fsp->fsu_bavail = PROPAGATE_TOP_BIT (vfsd.f_bavail);\n      fsp->fsu_bavail_top_bit_set = EXTRACT_TOP_BIT (vfsd.f_bavail) != 0;\n      fsp->fsu_files = PROPAGATE_ALL_ONES (vfsd.f_files);\n      fsp->fsu_ffree = PROPAGATE_ALL_ONES (vfsd.f_ffree);\n      return 0;\n    }\n\n#endif\n\n#if defined STAT_STATVFS64             \n\n  struct statvfs64 fsd;\n\n  if (statvfs64 (file, &fsd) < 0)\n    return -1;\n\n   \n  fsp->fsu_blocksize = (fsd.f_frsize\n                        ? PROPAGATE_ALL_ONES (fsd.f_frsize)\n                        : PROPAGATE_ALL_ONES (fsd.f_bsize));\n\n#elif defined STAT_STATFS3_OSF1          \n\n  struct statfs fsd;\n\n  if (statfs (file, &fsd, sizeof (struct statfs)) != 0)\n    return -1;\n\n  fsp->fsu_blocksize = PROPAGATE_ALL_ONES (fsd.f_fsize);\n\n#elif defined STAT_STATFS2_FRSIZE         \n\n  struct statfs fsd;\n\n  if (statfs (file, &fsd) < 0)\n    return -1;\n\n  fsp->fsu_blocksize = PROPAGATE_ALL_ONES (fsd.f_frsize);\n\n#elif defined STAT_STATFS2_BSIZE         \n\n  struct statfs fsd;\n\n  if (statfs (file, &fsd) < 0)\n    return -1;\n\n  fsp->fsu_blocksize = PROPAGATE_ALL_ONES (fsd.f_bsize);\n\n# ifdef STATFS_TRUNCATES_BLOCK_COUNTS\n\n   \n  if (fsd.f_blocks == 0x7fffffff / fsd.f_bsize && fsd.f_spare[0] > 0)\n    {\n      fsd.f_blocks = fsd.f_spare[0];\n      fsd.f_bfree = fsd.f_spare[1];\n      fsd.f_bavail = fsd.f_spare[2];\n    }\n# endif  \n\n#elif defined STAT_STATFS2_FSIZE         \n\n  struct statfs fsd;\n\n  if (statfs (file, &fsd) < 0)\n    return -1;\n\n  fsp->fsu_blocksize = PROPAGATE_ALL_ONES (fsd.f_fsize);\n\n#elif defined STAT_STATFS4               \n\n  struct statfs fsd;\n\n  if (statfs (file, &fsd, sizeof fsd, 0) < 0)\n    return -1;\n\n   \n   fsp->fsu_blocksize = 512;\n\n#endif\n\n#if (defined STAT_STATVFS64 || defined STAT_STATFS3_OSF1                \\\n     || defined STAT_STATFS2_FRSIZE || defined STAT_STATFS2_BSIZE       \\\n     || defined STAT_STATFS2_FSIZE || defined STAT_STATFS4)\n\n  fsp->fsu_blocks = PROPAGATE_ALL_ONES (fsd.f_blocks);\n  fsp->fsu_bfree = PROPAGATE_ALL_ONES (fsd.f_bfree);\n  fsp->fsu_bavail = PROPAGATE_TOP_BIT (fsd.f_bavail);\n  fsp->fsu_bavail_top_bit_set = EXTRACT_TOP_BIT (fsd.f_bavail) != 0;\n  fsp->fsu_files = PROPAGATE_ALL_ONES (fsd.f_files);\n  fsp->fsu_ffree = PROPAGATE_ALL_ONES (fsd.f_ffree);\n\n#endif\n\n  (void) disk;   \n  return 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}