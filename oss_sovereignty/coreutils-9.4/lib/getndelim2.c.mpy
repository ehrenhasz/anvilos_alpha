{
  "module_name": "getndelim2.c",
  "hash_id": "d240391c271eb2716c1f5c51955ef34a8e886f615ecd8cf65b8f394205b8de38",
  "original_prompt": "Ingested from coreutils-9.4/lib/getndelim2.c",
  "human_readable_source": " \n\n#include <config.h>\n\n#include \"getndelim2.h\"\n\n#include <stddef.h>\n#include <stdlib.h>\n#include <string.h>\n\n#if USE_UNLOCKED_IO\n# include \"unlocked-io.h\"\n#endif\n#if !HAVE_FLOCKFILE\n# undef flockfile\n# define flockfile(x) ((void) 0)\n#endif\n#if !HAVE_FUNLOCKFILE\n# undef funlockfile\n# define funlockfile(x) ((void) 0)\n#endif\n\n#include <limits.h>\n#include <stdint.h>\n\n#include \"freadptr.h\"\n#include \"freadseek.h\"\n#include \"memchr2.h\"\n\n \n#if __GNUC__ + (__GNUC_MINOR__ >= 7) > 4\n# pragma GCC diagnostic ignored \"-Wmaybe-uninitialized\"\n#endif\n\n \n#define GETNDELIM2_MAXIMUM (PTRDIFF_MAX < SSIZE_MAX ? PTRDIFF_MAX : SSIZE_MAX)\n\n \n#define MIN_CHUNK 64\n\nssize_t\ngetndelim2 (char **lineptr, size_t *linesize, size_t offset, size_t nmax,\n            int delim1, int delim2, FILE *stream)\n{\n  size_t nbytes_avail;           \n  char *read_pos;                \n  ssize_t bytes_stored = -1;\n  char *ptr = *lineptr;\n  size_t size = *linesize;\n  bool found_delimiter;\n\n  if (!ptr)\n    {\n      size = nmax < MIN_CHUNK ? nmax : MIN_CHUNK;\n      ptr = malloc (size);\n      if (!ptr)\n        return -1;\n    }\n\n  if (size < offset)\n    goto done;\n\n  nbytes_avail = size - offset;\n  read_pos = ptr + offset;\n\n  if (nbytes_avail == 0 && nmax <= size)\n    goto done;\n\n   \n  if (delim1 == EOF)\n    delim1 = delim2;\n  else if (delim2 == EOF)\n    delim2 = delim1;\n\n  flockfile (stream);\n\n  found_delimiter = false;\n  do\n    {\n       \n\n      int c;\n      const char *buffer;\n      size_t buffer_len;\n\n      buffer = freadptr (stream, &buffer_len);\n      if (buffer)\n        {\n          if (delim1 != EOF)\n            {\n              const char *end = memchr2 (buffer, delim1, delim2, buffer_len);\n              if (end)\n                {\n                  buffer_len = end - buffer + 1;\n                  found_delimiter = true;\n                }\n            }\n        }\n      else\n        {\n          c = getc (stream);\n          if (c == EOF)\n            {\n               \n              if (read_pos == ptr)\n                goto unlock_done;\n              else\n                break;\n            }\n          if (c == delim1 || c == delim2)\n            found_delimiter = true;\n          buffer_len = 1;\n        }\n\n       \n\n      if (nbytes_avail < buffer_len + 1 && size < nmax)\n        {\n           \n          size_t newsize = size < MIN_CHUNK ? size + MIN_CHUNK : 2 * size;\n          char *newptr;\n\n           \n          if (newsize - (read_pos - ptr) < buffer_len + 1)\n            newsize = (read_pos - ptr) + buffer_len + 1;\n           \n          if (! (size < newsize && newsize <= nmax))\n            newsize = nmax;\n\n          if (GETNDELIM2_MAXIMUM < newsize - offset)\n            {\n              size_t newsizemax = offset + GETNDELIM2_MAXIMUM + 1;\n              if (size == newsizemax)\n                goto unlock_done;\n              newsize = newsizemax;\n            }\n\n          nbytes_avail = newsize - (read_pos - ptr);\n          newptr = realloc (ptr, newsize);\n          if (!newptr)\n            goto unlock_done;\n          ptr = newptr;\n          size = newsize;\n          read_pos = size - nbytes_avail + ptr;\n        }\n\n       \n\n      if (1 < nbytes_avail)\n        {\n          size_t copy_len = nbytes_avail - 1;\n          if (buffer_len < copy_len)\n            copy_len = buffer_len;\n          if (buffer)\n            memcpy (read_pos, buffer, copy_len);\n          else\n            *read_pos = c;\n          read_pos += copy_len;\n          nbytes_avail -= copy_len;\n        }\n\n       \n\n      if (buffer && freadseek (stream, buffer_len))\n        goto unlock_done;\n    }\n  while (!found_delimiter);\n\n   \n  *read_pos = '\\0';\n\n  bytes_stored = read_pos - (ptr + offset);\n\n unlock_done:\n  funlockfile (stream);\n\n done:\n  *lineptr = ptr;\n  *linesize = size;\n  return bytes_stored ? bytes_stored : -1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}