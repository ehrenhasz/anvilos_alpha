{
  "module_name": "unicodeio.c",
  "hash_id": "a4764c24dd99e20e1d865b844a7b3fe6d86aeb8d1fc83239168cc0fd264aaddf",
  "original_prompt": "Ingested from coreutils-9.4/lib/unicodeio.c",
  "human_readable_source": " \n\n#include <config.h>\n\n \n#include \"unicodeio.h\"\n\n#include <stdio.h>\n#include <string.h>\n#include <errno.h>\n\n#if HAVE_ICONV\n# include <iconv.h>\n#endif\n\n#include <error.h>\n\n#include \"gettext.h\"\n#define _(msgid) gettext (msgid)\n#define N_(msgid) msgid\n\n#include \"localcharset.h\"\n#include \"unistr.h\"\n\n \n\n \n#define UTF8_NAME \"UTF-8\"\n\n \nlong\nunicode_to_mb (unsigned int code,\n               long (*success) (const char *buf, size_t buflen,\n                                void *callback_arg),\n               long (*failure) (unsigned int code, const char *msg,\n                                void *callback_arg),\n               void *callback_arg)\n{\n  static int initialized;\n  static int is_utf8;\n#if HAVE_ICONV\n  static iconv_t utf8_to_local;\n#endif\n\n  char inbuf[6];\n  int count;\n\n  if (!initialized)\n    {\n      const char *charset = locale_charset ();\n\n      is_utf8 = !strcmp (charset, UTF8_NAME);\n#if HAVE_ICONV\n      if (!is_utf8)\n        {\n          utf8_to_local = iconv_open (charset, UTF8_NAME);\n          if (utf8_to_local == (iconv_t)(-1))\n             \n            utf8_to_local = iconv_open (\"ASCII\", UTF8_NAME);\n        }\n#endif\n      initialized = 1;\n    }\n\n   \n  if (!is_utf8)\n    {\n#if HAVE_ICONV\n      if (utf8_to_local == (iconv_t)(-1))\n        return failure (code, N_(\"iconv function not usable\"), callback_arg);\n#else\n      return failure (code, N_(\"iconv function not available\"), callback_arg);\n#endif\n    }\n\n   \n  count = u8_uctomb ((unsigned char *) inbuf, code, sizeof (inbuf));\n  if (count < 0)\n    return failure (code, N_(\"character out of range\"), callback_arg);\n\n#if HAVE_ICONV\n  if (!is_utf8)\n    {\n      char outbuf[25];\n      const char *inptr;\n      size_t inbytesleft;\n      char *outptr;\n      size_t outbytesleft;\n      size_t res;\n\n      inptr = inbuf;\n      inbytesleft = count;\n      outptr = outbuf;\n      outbytesleft = sizeof (outbuf);\n\n       \n      res = iconv (utf8_to_local,\n                   (ICONV_CONST char **)&inptr, &inbytesleft,\n                   &outptr, &outbytesleft);\n       \n      if (inbytesleft > 0 || res == (size_t)(-1)\n           \n# if !defined _LIBICONV_VERSION && (defined sgi || defined __sgi)\n          || (res > 0 && code != 0 && outptr - outbuf == 1 && *outbuf == '\\0')\n# endif\n           \n# if !defined _LIBICONV_VERSION\n          || (res > 0 && outptr - outbuf == 1 && *outbuf == '?')\n# endif\n           \n# if !defined _LIBICONV_VERSION && MUSL_LIBC\n          || (res > 0 && outptr - outbuf == 1 && *outbuf == '*')\n# endif\n         )\n        return failure (code, NULL, callback_arg);\n\n       \n# if defined _LIBICONV_VERSION \\\n    || !(((__GLIBC__ - 0 == 2 && __GLIBC_MINOR__ - 0 <= 1) \\\n          && !defined __UCLIBC__) \\\n         || defined __sun)\n\n       \n      res = iconv (utf8_to_local, NULL, NULL, &outptr, &outbytesleft);\n      if (res == (size_t)(-1))\n        return failure (code, NULL, callback_arg);\n# endif\n\n      return success (outbuf, outptr - outbuf, callback_arg);\n    }\n#endif\n\n   \n  return success (inbuf, count, callback_arg);\n}\n\n \nlong\nfwrite_success_callback (const char *buf, size_t buflen, void *callback_arg)\n{\n  FILE *stream = (FILE *) callback_arg;\n\n   \n  fwrite (buf, 1, buflen, stream);\n  return 0;\n}\n\n \nstatic long\nexit_failure_callback (unsigned int code, const char *msg,\n                       _GL_UNUSED void *callback_arg)\n{\n  if (msg == NULL)\n    error (1, 0, _(\"cannot convert U+%04X to local character set\"), code);\n  else\n    error (1, 0, _(\"cannot convert U+%04X to local character set: %s\"), code,\n           gettext (msg));\n  return -1;\n}\n\n \nstatic long\nfallback_failure_callback (unsigned int code,\n                           _GL_UNUSED const char *msg,\n                           void *callback_arg)\n{\n  FILE *stream = (FILE *) callback_arg;\n\n  if (code < 0x10000)\n    fprintf (stream, \"\\\\u%04X\", code);\n  else\n    fprintf (stream, \"\\\\U%08X\", code);\n  return -1;\n}\n\n \nvoid\nprint_unicode_char (FILE *stream, unsigned int code, int exit_on_error)\n{\n  unicode_to_mb (code, fwrite_success_callback,\n                 exit_on_error\n                 ? exit_failure_callback\n                 : fallback_failure_callback,\n                 stream);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}