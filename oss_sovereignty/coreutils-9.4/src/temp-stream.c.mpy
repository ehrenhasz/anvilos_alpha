{
  "module_name": "temp-stream.c",
  "hash_id": "29920a4ee43ffa75bb5c1fcecf56e9861ebbfd0428af16bd3514e9abf040cceb",
  "original_prompt": "Ingested from coreutils-9.4/src/temp-stream.c",
  "human_readable_source": " \n#include \"system.h\"\n#include \"tmpdir.h\"\n\n#include \"temp-stream.h\"\n\n\n#if defined __MSDOS__ || defined _WIN32\n \n# define DONT_UNLINK_WHILE_OPEN 1\n#endif\n\n#if DONT_UNLINK_WHILE_OPEN\n\n \n\nstatic char const *file_to_remove;\nstatic FILE *fp_to_close;\n\nstatic void\nunlink_tempfile (void)\n{\n  fclose (fp_to_close);\n  unlink (file_to_remove);\n}\n\nstatic void\nrecord_or_unlink_tempfile (char const *fn, FILE *fp)\n{\n  if (!file_to_remove)\n    {\n      file_to_remove = fn;\n      fp_to_close = fp;\n      atexit (unlink_tempfile);\n    }\n}\n\n#else\n\nstatic void\nrecord_or_unlink_tempfile (char const *fn, MAYBE_UNUSED FILE *fp)\n{\n  unlink (fn);\n}\n\n#endif\n\n \nbool\ntemp_stream (FILE **fp, char **file_name)\n{\n  static char *tempfile = nullptr;\n  static FILE *tmp_fp;\n  if (tempfile == nullptr)\n    {\n      char *tempbuf = nullptr;\n      size_t tempbuf_len = 128;\n\n      while (true)\n        {\n          if (! (tempbuf = realloc (tempbuf, tempbuf_len)))\n            {\n              error (0, errno, _(\"failed to make temporary file name\"));\n              return false;\n            }\n\n          if (path_search (tempbuf, tempbuf_len, nullptr, \"cutmp\", true) == 0)\n            break;\n\n          if (errno != EINVAL || PATH_MAX / 2 < tempbuf_len)\n            {\n              error (0, errno == EINVAL ? ENAMETOOLONG : errno,\n                     _(\"failed to make temporary file name\"));\n              return false;\n            }\n\n          tempbuf_len *= 2;\n        }\n\n      tempfile = tempbuf;\n\n       \n\n      int fd = mkstemp (tempfile);\n      if (fd < 0)\n        {\n          error (0, errno, _(\"failed to create temporary file %s\"),\n                 quoteaf (tempfile));\n          goto Reset;\n        }\n\n      tmp_fp = fdopen (fd, (O_BINARY ? \"w+b\" : \"w+\"));\n      if (! tmp_fp)\n        {\n          error (0, errno, _(\"failed to open %s for writing\"),\n                 quoteaf (tempfile));\n          close (fd);\n          unlink (tempfile);\n        Reset:\n          free (tempfile);\n          tempfile = nullptr;\n          return false;\n        }\n\n      record_or_unlink_tempfile (tempfile, tmp_fp);\n    }\n  else\n    {\n      clearerr (tmp_fp);\n      if (fseeko (tmp_fp, 0, SEEK_SET) < 0\n          || ftruncate (fileno (tmp_fp), 0) < 0)\n        {\n          error (0, errno, _(\"failed to rewind stream for %s\"),\n                 quoteaf (tempfile));\n          return false;\n        }\n    }\n\n  *fp = tmp_fp;\n  if (file_name)\n    *file_name = tempfile;\n  return true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}