{
  "module_name": "test-rename.h",
  "hash_id": "00cee3ce8982ae6fd6971efa8fcb90cdc0b470ae781d07f00f505357f00c7348",
  "original_prompt": "Ingested from coreutils-9.4/gnulib-tests/test-rename.h",
  "human_readable_source": " \n\n \nstatic bool\ndentry_exists (const char *filename)\n{\n  bool exists = false;\n  DIR *dir = opendir (\".\");\n\n  ASSERT (dir != NULL);\n  for (;;)\n    {\n      struct dirent *d = readdir (dir);\n      if (d == NULL)\n        break;\n      if (strcmp (d->d_name, filename) == 0)\n        {\n          exists = true;\n          break;\n        }\n    }\n  ASSERT (closedir (dir) == 0);\n  return exists;\n}\n\n \nstatic void\nassert_nonexistent (const char *filename)\n{\n  struct stat st;\n\n   \n  errno = 0;\n  if (stat (filename, &st) == -1)\n    ASSERT (errno == ENOENT);\n  else\n    {\n       \n      ASSERT (!dentry_exists (filename));\n       \n      (void) rmdir (filename);\n    }\n}\n\nstatic int\ntest_rename (int (*func) (char const *, char const *), bool print)\n{\n   \n  struct stat st;\n  int fd = creat (BASE \"file\", 0600);\n  ASSERT (0 <= fd);\n  ASSERT (write (fd, \"hi\", 2) == 2);\n  ASSERT (close (fd) == 0);\n  ASSERT (mkdir (BASE \"dir\", 0700) == 0);\n\n   \n\n   \n\n  {  \n    {\n      errno = 0;\n      ASSERT (func (BASE \"missing\", BASE \"missing\") == -1);\n      ASSERT (errno == ENOENT);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"missing/\", BASE \"missing\") == -1);\n      ASSERT (errno == ENOENT);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"missing\", BASE \"missing/\") == -1);\n      ASSERT (errno == ENOENT);\n    }\n  }\n  {  \n    {\n      errno = 0;\n      ASSERT (func (\"\", BASE \"missing\") == -1);\n      ASSERT (errno == ENOENT);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"file\", \"\") == -1);\n      ASSERT (errno == ENOENT);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"\", \"\") == -1);\n      ASSERT (errno == ENOENT);\n    }\n  }\n\n   \n\n  {  \n    {\n      errno = 0;\n      ASSERT (func (BASE \"file\", BASE \"file2/\") == -1);\n      ASSERT (errno == ENOENT || errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"file/\", BASE \"file2\") == -1);\n      ASSERT (errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (stat (BASE \"file2\", &st) == -1);\n      ASSERT (errno == ENOENT);\n    }\n  }\n  {  \n    ASSERT (func (BASE \"file\", BASE \"file2\") == 0);\n    errno = 0;\n    ASSERT (stat (BASE \"file\", &st) == -1);\n    ASSERT (errno == ENOENT);\n    memset (&st, 0, sizeof st);\n    ASSERT (stat (BASE \"file2\", &st) == 0);\n    ASSERT (st.st_size == 2);\n  }\n   \n  {  \n    ASSERT (close (creat (BASE \"file\", 0600)) == 0);\n    errno = 0;\n    ASSERT (func (BASE \"file2\", BASE \"file/\") == -1);\n    ASSERT (errno == ENOTDIR);\n    ASSERT (func (BASE \"file2\", BASE \"file\") == 0);\n    memset (&st, 0, sizeof st);\n    ASSERT (stat (BASE \"file\", &st) == 0);\n    ASSERT (st.st_size == 2);\n    errno = 0;\n    ASSERT (stat (BASE \"file2\", &st) == -1);\n    ASSERT (errno == ENOENT);\n  }\n   \n\n   \n\n  {  \n    {\n      ASSERT (func (BASE \"dir\", BASE \"dir2/\") == 0);\n      errno = 0;\n      ASSERT (stat (BASE \"dir\", &st) == -1);\n      ASSERT (errno == ENOENT);\n      ASSERT (stat (BASE \"dir2\", &st) == 0);\n    }\n     \n    {\n      ASSERT (func (BASE \"dir2/\", BASE \"dir\") == 0);\n      ASSERT (stat (BASE \"dir\", &st) == 0);\n      errno = 0;\n      ASSERT (stat (BASE \"dir2\", &st) == -1);\n      ASSERT (errno == ENOENT);\n    }\n     \n    {\n      ASSERT (func (BASE \"dir\", BASE \"dir2\") == 0);\n      errno = 0;\n      ASSERT (stat (BASE \"dir\", &st) == -1);\n      ASSERT (errno == ENOENT);\n      ASSERT (stat (BASE \"dir2\", &st) == 0);\n    }\n     \n    {  \n      ASSERT (mkdir (BASE \"dir\", 0700) == 0);\n       \n      ASSERT (func (BASE \"dir2\", BASE \"dir\") == 0);\n       \n      ASSERT (mkdir (BASE \"dir2\", 0700) == 0);\n       \n      ASSERT (func (BASE \"dir2\", BASE \"dir/\") == 0);\n       \n      ASSERT (mkdir (BASE \"dir2\", 0700) == 0);\n       \n      ASSERT (func (BASE \"dir2/\", BASE \"dir\") == 0);\n       \n      ASSERT (mkdir (BASE \"dir2\", 0700) == 0);\n    }\n     \n    {  \n      ASSERT (close (creat (BASE \"dir/file\", 0600)) == 0);\n       \n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2\", BASE \"dir\") == -1);\n        ASSERT (errno == EEXIST || errno == ENOTEMPTY);\n      }\n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2/\", BASE \"dir\") == -1);\n        ASSERT (errno == EEXIST || errno == ENOTEMPTY);\n      }\n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2\", BASE \"dir/\") == -1);\n        ASSERT (errno == EEXIST || errno == ENOTEMPTY);\n      }\n    }\n    {  \n      ASSERT (func (BASE \"dir\", BASE \"dir2\") == 0);\n      assert_nonexistent (BASE \"dir\");\n      ASSERT (stat (BASE \"dir2/file\", &st) == 0);\n       \n      ASSERT (mkdir (BASE \"dir\", 0700) == 0);\n       \n      {\n        ASSERT (func (BASE \"dir2/\", BASE \"dir\") == 0);\n        ASSERT (stat (BASE \"dir/file\", &st) == 0);\n        errno = 0;\n        ASSERT (stat (BASE \"dir2\", &st) == -1);\n        ASSERT (errno == ENOENT);\n      }\n       \n      ASSERT (mkdir (BASE \"dir2\", 0700) == 0);\n       \n      {\n        ASSERT (func (BASE \"dir\", BASE \"dir2/\") == 0);\n        assert_nonexistent (BASE \"dir\");\n        ASSERT (stat (BASE \"dir2/file\", &st) == 0);\n      }\n       \n      ASSERT (unlink (BASE \"dir2/file\") == 0);\n    }\n     \n    {  \n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2\", BASE \"dir/.\") == -1);\n        ASSERT (errno == EINVAL || errno == ENOENT);\n      }\n      ASSERT (mkdir (BASE \"dir\", 0700) == 0);\n       \n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2\", BASE \"dir/.\") == -1);\n        ASSERT (errno == EINVAL || errno == EBUSY || errno == EISDIR\n                || errno == ENOTEMPTY || errno == EEXIST\n                || errno == ENOENT  );\n      }\n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2/.\", BASE \"dir\") == -1);\n        ASSERT (errno == EINVAL || errno == EBUSY || errno == EEXIST\n                || errno == ENOENT  );\n      }\n      ASSERT (rmdir (BASE \"dir\") == 0);\n       \n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2\", BASE \"dir/.//\") == -1);\n        ASSERT (errno == EINVAL || errno == ENOENT);\n      }\n      ASSERT (mkdir (BASE \"dir\", 0700) == 0);\n       \n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2\", BASE \"dir/.//\") == -1);\n        ASSERT (errno == EINVAL || errno == EBUSY || errno == EISDIR\n                || errno == ENOTEMPTY || errno == EEXIST\n                || errno == ENOENT  );\n      }\n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir2/.//\", BASE \"dir\") == -1);\n        ASSERT (errno == EINVAL || errno == EBUSY || errno == EEXIST\n                || errno == ENOENT  );\n      }\n      ASSERT (rmdir (BASE \"dir2\") == 0);\n       \n    }\n    {  \n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir\", BASE \"dir/sub\") == -1);\n        ASSERT (errno == EINVAL || errno == EACCES);\n      }\n      {\n        errno = 0;\n        ASSERT (stat (BASE \"dir/sub\", &st) == -1);\n        ASSERT (errno == ENOENT);\n      }\n      ASSERT (mkdir (BASE \"dir/sub\", 0700) == 0);\n       \n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir\", BASE \"dir/sub\") == -1);\n        ASSERT (errno == EINVAL);\n        ASSERT (stat (BASE \"dir/sub\", &st) == 0);\n      }\n      ASSERT (rmdir (BASE \"dir/sub\") == 0);\n    }\n  }\n   \n\n   \n\n  {\n    {  \n      {\n        errno = 0;\n        ASSERT (func (BASE \"file\", BASE \"dir\") == -1);\n        ASSERT (errno == EISDIR || errno == ENOTDIR);\n      }\n      {\n        errno = 0;\n        ASSERT (func (BASE \"file\", BASE \"dir/\") == -1);\n        ASSERT (errno == EISDIR || errno == ENOTDIR);\n      }\n    }\n    {  \n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir\", BASE \"file\") == -1);\n        ASSERT (errno == ENOTDIR);\n      }\n      {\n        errno = 0;\n        ASSERT (func (BASE \"dir/\", BASE \"file\") == -1);\n        ASSERT (errno == ENOTDIR);\n      }\n    }\n  }\n\n   \n\n  {  \n    ASSERT (func (BASE \"file\", BASE \"file\") == 0);\n    memset (&st, 0, sizeof st);\n    ASSERT (stat (BASE \"file\", &st) == 0);\n    ASSERT (st.st_size == 2);\n  }\n   \n  {  \n    ASSERT (func (BASE \"dir\", BASE \"dir\") == 0);\n    ASSERT (stat (BASE \"dir\", &st) == 0);\n  }\n   \n  ASSERT (close (creat (BASE \"dir/file\", 0600)) == 0);\n   \n  {  \n    ASSERT (func (BASE \"dir\", BASE \"dir\") == 0);\n  }\n  ASSERT (unlink (BASE \"dir/file\") == 0);\n   \n  {\n     \n    int ret = link (BASE \"file\", BASE \"file2\");\n    if (!ret)\n      {\n        memset (&st, 0, sizeof st);\n        ASSERT (stat (BASE \"file2\", &st) == 0);\n        if (st.st_ino && st.st_nlink != 2)\n          {\n            ASSERT (unlink (BASE \"file2\") == 0);\n            errno = EPERM;\n            ret = -1;\n          }\n      }\n    if (ret == -1)\n      {\n         \n        switch (errno)\n          {\n          case EPERM:\n          case EOPNOTSUPP:\n          #if defined __ANDROID__\n          case EACCES:\n          #endif\n            if (print)\n              fputs (\"skipping test: \"\n                     \"hard links not supported on this file system\\n\",\n                     stderr);\n            ASSERT (unlink (BASE \"file\") == 0);\n            ASSERT (rmdir (BASE \"dir\") == 0);\n            return 77;\n          default:\n            perror (\"link\");\n            return 1;\n          }\n      }\n    ASSERT (ret == 0);\n  }\n   \n  {  \n    ASSERT (func (BASE \"file\", BASE \"file2\") == 0);\n    memset (&st, 0, sizeof st);\n    if (stat (BASE \"file\", &st) != 0)\n      {\n         \n        ASSERT (errno == ENOENT);\n        ASSERT (link (BASE \"file2\", BASE \"file\") == 0);\n        ASSERT (stat (BASE \"file\", &st) == 0);\n      }\n    ASSERT (st.st_size == 2);\n    memset (&st, 0, sizeof st);\n    ASSERT (stat (BASE \"file2\", &st) == 0);\n    ASSERT (st.st_size == 2);\n  }\n   \n  ASSERT (unlink (BASE \"file2\") == 0);\n   \n\n   \n\n  if (symlink (BASE \"file\", BASE \"link1\"))\n    {\n      if (print)\n        fputs (\"skipping test: symlinks not supported on this file system\\n\",\n               stderr);\n      ASSERT (unlink (BASE \"file\") == 0);\n      ASSERT (rmdir (BASE \"dir\") == 0);\n      return 77;\n    }\n   \n  {  \n    ASSERT (func (BASE \"link1\", BASE \"link2\") == 0);\n    ASSERT (stat (BASE \"file\", &st) == 0);\n    errno = 0;\n    ASSERT (lstat (BASE \"link1\", &st) == -1);\n    ASSERT (errno == ENOENT);\n    memset (&st, 0, sizeof st);\n    ASSERT (lstat (BASE \"link2\", &st) == 0);\n    ASSERT (S_ISLNK (st.st_mode));\n  }\n   \n  {  \n    ASSERT (symlink (BASE \"nowhere\", BASE \"link1\") == 0);\n     \n    {\n      ASSERT (func (BASE \"link2\", BASE \"link1\") == 0);\n      memset (&st, 0, sizeof st);\n      ASSERT (stat (BASE \"link1\", &st) == 0);\n      ASSERT (st.st_size == 2);\n      errno = 0;\n      ASSERT (lstat (BASE \"link2\", &st) == -1);\n      ASSERT (errno == ENOENT);\n    }\n  }\n   \n  {  \n    ASSERT (symlink (BASE \"link2\", BASE \"link2\") == 0);\n     \n    {\n      ASSERT (func (BASE \"link2\", BASE \"link2\") == 0);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"link2/\", BASE \"link2\") == -1);\n      ASSERT (errno == ELOOP || errno == ENOTDIR);\n    }\n    ASSERT (func (BASE \"link2\", BASE \"link3\") == 0);\n     \n    ASSERT (unlink (BASE \"link3\") == 0);\n  }\n   \n  {  \n    ASSERT (symlink (BASE \"nowhere\", BASE \"link2\") == 0);\n     \n    {\n      ASSERT (func (BASE \"link2\", BASE \"link3\") == 0);\n      errno = 0;\n      ASSERT (lstat (BASE \"link2\", &st) == -1);\n      ASSERT (errno == ENOENT);\n      memset (&st, 0, sizeof st);\n      ASSERT (lstat (BASE \"link3\", &st) == 0);\n    }\n  }\n   \n  {  \n    {\n      errno = 0;\n      ASSERT (func (BASE \"link3/\", BASE \"link2\") == -1);\n      ASSERT (errno == ENOENT || errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"link3\", BASE \"link2/\") == -1);\n      ASSERT (errno == ENOENT || errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (lstat (BASE \"link2\", &st) == -1);\n      ASSERT (errno == ENOENT);\n    }\n    memset (&st, 0, sizeof st);\n    ASSERT (lstat (BASE \"link3\", &st) == 0);\n  }\n   \n  {  \n    {\n      errno = 0;\n      ASSERT (func (BASE \"link1/\", BASE \"link2\") == -1);\n      ASSERT (errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"link1\", BASE \"link3/\") == -1);\n      ASSERT (errno == ENOENT || errno == ENOTDIR);\n    }\n  }\n   \n\n   \n\n  {  \n    ASSERT (close (creat (BASE \"file2\", 0600)) == 0);\n     \n    {\n      ASSERT (func (BASE \"file2\", BASE \"link3\") == 0);\n      errno = 0;\n      ASSERT (stat (BASE \"file2\", &st) == -1);\n      ASSERT (errno == ENOENT);\n      memset (&st, 0, sizeof st);\n      ASSERT (lstat (BASE \"link3\", &st) == 0);\n      ASSERT (S_ISREG (st.st_mode));\n    }\n     \n    ASSERT (unlink (BASE \"link3\") == 0);\n  }\n   \n  {  \n    ASSERT (symlink (BASE \"nowhere\", BASE \"link2\") == 0);\n     \n    ASSERT (close (creat (BASE \"file2\", 0600)) == 0);\n     \n    {\n      ASSERT (func (BASE \"link2\", BASE \"file2\") == 0);\n      errno = 0;\n      ASSERT (lstat (BASE \"link2\", &st) == -1);\n      ASSERT (errno == ENOENT);\n      memset (&st, 0, sizeof st);\n      ASSERT (lstat (BASE \"file2\", &st) == 0);\n      ASSERT (S_ISLNK (st.st_mode));\n    }\n     \n    ASSERT (unlink (BASE \"file2\") == 0);\n  }\n   \n  {  \n    {\n      errno = 0;\n      ASSERT (func (BASE \"file/\", BASE \"link1\") == -1);\n      ASSERT (errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"file\", BASE \"link1/\") == -1);\n      ASSERT (errno == ENOTDIR || errno == ENOENT);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"link1/\", BASE \"file\") == -1);\n      ASSERT (errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"link1\", BASE \"file/\") == -1);\n      ASSERT (errno == ENOTDIR || errno == ENOENT);\n      memset (&st, 0, sizeof st);\n      ASSERT (lstat (BASE \"file\", &st) == 0);\n      ASSERT (S_ISREG (st.st_mode));\n      memset (&st, 0, sizeof st);\n      ASSERT (lstat (BASE \"link1\", &st) == 0);\n      ASSERT (S_ISLNK (st.st_mode));\n    }\n  }\n   \n\n   \n\n  {  \n    {\n      errno = 0;\n      ASSERT (func (BASE \"dir\", BASE \"link1\") == -1);\n      ASSERT (errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"dir/\", BASE \"link1\") == -1);\n      ASSERT (errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"dir\", BASE \"link1/\") == -1);\n      ASSERT (errno == ENOTDIR);\n    }\n  }\n  {  \n    {\n      errno = 0;\n      ASSERT (func (BASE \"link1\", BASE \"dir\") == -1);\n      ASSERT (errno == EISDIR || errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"link1\", BASE \"dir/\") == -1);\n      ASSERT (errno == EISDIR || errno == ENOTDIR);\n    }\n    {\n      errno = 0;\n      ASSERT (func (BASE \"link1/\", BASE \"dir\") == -1);\n      ASSERT (errno == ENOTDIR);\n      memset (&st, 0, sizeof st);\n      ASSERT (lstat (BASE \"link1\", &st) == 0);\n      ASSERT (S_ISLNK (st.st_mode));\n      memset (&st, 0, sizeof st);\n      ASSERT (lstat (BASE \"dir\", &st) == 0);\n      ASSERT (S_ISDIR (st.st_mode));\n    }\n  }\n   \n\n   \n  {\n    int result;\n    ASSERT (symlink (BASE \"dir2\", BASE \"link2\") == 0);\n     \n    errno = 0;\n    result = func (BASE \"dir\", BASE \"link2/\");\n    if (result == 0)\n      {\n         \n        errno = 0;\n        ASSERT (lstat (BASE \"dir\", &st) == -1);\n        ASSERT (errno == ENOENT);\n        memset (&st, 0, sizeof st);\n        ASSERT (lstat (BASE \"dir2\", &st) == 0);\n        ASSERT (S_ISDIR (st.st_mode));\n        memset (&st, 0, sizeof st);\n        ASSERT (lstat (BASE \"link2\", &st) == 0);\n        ASSERT (S_ISLNK (st.st_mode));\n         \n        {\n          ASSERT (func (BASE \"link2/\", BASE \"dir\") == 0);\n          memset (&st, 0, sizeof st);\n          ASSERT (lstat (BASE \"dir\", &st) == 0);\n          ASSERT (S_ISDIR (st.st_mode));\n          errno = 0;\n          ASSERT (lstat (BASE \"dir2\", &st) == -1);\n          ASSERT (errno == ENOENT);\n          memset (&st, 0, sizeof st);\n          ASSERT (lstat (BASE \"link2\", &st) == 0);\n          ASSERT (S_ISLNK (st.st_mode));\n        }\n      }\n    else\n      {\n         \n        ASSERT (result == -1);\n        ASSERT (errno == ENOTDIR);\n        memset (&st, 0, sizeof st);\n        ASSERT (lstat (BASE \"dir\", &st) == 0);\n        ASSERT (S_ISDIR (st.st_mode));\n        errno = 0;\n        ASSERT (lstat (BASE \"dir2\", &st) == -1);\n        ASSERT (errno == ENOENT);\n        memset (&st, 0, sizeof st);\n        ASSERT (lstat (BASE \"link2\", &st) == 0);\n        ASSERT (S_ISLNK (st.st_mode));\n        ASSERT (unlink (BASE \"link2\") == 0);\n        ASSERT (symlink (BASE \"dir\", BASE \"link2\") == 0);\n         \n        errno = 0;  \n        result = func (BASE \"link2/\", BASE \"dir\");\n        if (result)  \n          {\n            ASSERT (result == -1);\n            ASSERT (errno == ENOTDIR || errno == EISDIR);\n          }\n        memset (&st, 0, sizeof st);\n        ASSERT (lstat (BASE \"dir\", &st) == 0);\n        ASSERT (S_ISDIR (st.st_mode));\n        errno = 0;\n        ASSERT (lstat (BASE \"dir2\", &st) == -1);\n        ASSERT (errno == ENOENT);\n        memset (&st, 0, sizeof st);\n        ASSERT (lstat (BASE \"link2\", &st) == 0);\n        ASSERT (S_ISLNK (st.st_mode));\n      }\n  }\n   \n\n   \n  ASSERT (unlink (BASE \"file\") == 0);\n  ASSERT (rmdir (BASE \"dir\") == 0);\n  ASSERT (unlink (BASE \"link1\") == 0);\n  ASSERT (unlink (BASE \"link2\") == 0);\n\n  return 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}