{
  "module_name": "test-linkat.c",
  "hash_id": "2a5712841570304391fb9ec7fd793408905adc5b0faeb14321335b7a8cccea7d",
  "original_prompt": "Ingested from coreutils-9.4/gnulib-tests/test-linkat.c",
  "human_readable_source": " \n\n#include <config.h>\n\n#include <unistd.h>\n\n#include \"signature.h\"\nSIGNATURE_CHECK (linkat, int, (int, char const *, int, char const *, int));\n\n#include <fcntl.h>\n#include <errno.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/stat.h>\n\n#include \"areadlink.h\"\n#include \"filenamecat.h\"\n#include \"same-inode.h\"\n#include \"ignore-value.h\"\n#include \"macros.h\"\n\n#define BASE \"test-linkat.t\"\n\n#include \"test-link.h\"\n\nstatic int dfd1 = AT_FDCWD;\nstatic int dfd2 = AT_FDCWD;\nstatic int flag = AT_SYMLINK_FOLLOW;\n\n \nstatic int\ndo_link (char const *name1, char const *name2)\n{\n  return linkat (dfd1, name1, dfd2, name2, flag);\n}\n\n \n#if LINK_FOLLOWS_SYMLINKS == 0\n# define EXPECT_LINK_HARDLINKS_SYMLINKS 1\n#elif LINK_FOLLOWS_SYMLINKS == -1\nextern int __xpg4;\n# define EXPECT_LINK_HARDLINKS_SYMLINKS (__xpg4 == 0)\n#else\n# define EXPECT_LINK_HARDLINKS_SYMLINKS 0\n#endif\n\n \nstatic void\ncheck_same_link (char const *name1, char const *name2)\n{\n  struct stat st1;\n  struct stat st2;\n  char *contents1;\n  char *contents2;\n  ASSERT (lstat (name1, &st1) == 0);\n  ASSERT (lstat (name2, &st2) == 0);\n  contents1 = areadlink_with_size (name1, st1.st_size);\n  contents2 = areadlink_with_size (name2, st2.st_size);\n  ASSERT (contents1);\n  ASSERT (contents2);\n  ASSERT (strcmp (contents1, contents2) == 0);\n  if (EXPECT_LINK_HARDLINKS_SYMLINKS)\n    ASSERT (SAME_INODE (st1, st2));\n  free (contents1);\n  free (contents2);\n}\n\nint\nmain (void)\n{\n  int i;\n  int dfd;\n  char *cwd;\n  int result;\n\n   \n  ignore_value (system (\"rm -rf \" BASE \"*\"));\n\n   \n  {\n    errno = 0;\n    ASSERT (linkat (-1, \"foo\", AT_FDCWD, \"bar\", 0) == -1);\n    ASSERT (errno == EBADF);\n  }\n  {\n    close (99);\n    errno = 0;\n    ASSERT (linkat (99, \"foo\", AT_FDCWD, \"bar\", 0) == -1);\n    ASSERT (errno == EBADF);\n  }\n  ASSERT (close (creat (BASE \"oo\", 0600)) == 0);\n  {\n    errno = 0;\n    ASSERT (linkat (AT_FDCWD, BASE \"oo\", -1, \"bar\", 0) == -1);\n    ASSERT (errno == EBADF);\n  }\n  {\n    errno = 0;\n    ASSERT (linkat (AT_FDCWD, BASE \"oo\", 99, \"bar\", 0) == -1);\n    ASSERT (errno == EBADF);\n  }\n  ASSERT (unlink (BASE \"oo\") == 0);\n\n   \n  result = test_link (do_link, true);\n  dfd1 = open (\".\", O_RDONLY);\n  ASSERT (0 <= dfd1);\n  ASSERT (test_link (do_link, false) == result);\n  dfd2 = dfd1;\n  ASSERT (test_link (do_link, false) == result);\n  dfd1 = AT_FDCWD;\n  ASSERT (test_link (do_link, false) == result);\n  flag = 0;\n  ASSERT (test_link (do_link, false) == result);\n  dfd1 = dfd2;\n  ASSERT (test_link (do_link, false) == result);\n  dfd2 = AT_FDCWD;\n  ASSERT (test_link (do_link, false) == result);\n  ASSERT (close (dfd1) == 0);\n  dfd1 = AT_FDCWD;\n  ASSERT (test_link (do_link, false) == result);\n\n   \n  if (result)\n    return result;\n\n   \n  ASSERT (mkdir (BASE \"sub1\", 0700) == 0);\n  ASSERT (mkdir (BASE \"sub2\", 0700) == 0);\n  ASSERT (close (creat (BASE \"00\", 0600)) == 0);\n  cwd = getcwd (NULL, 0);\n  ASSERT (cwd);\n\n  dfd = open (BASE \"sub1\", O_RDONLY);\n  ASSERT (0 <= dfd);\n  ASSERT (chdir (BASE \"sub2\") == 0);\n\n   \n  for (i = 0; i < 32; i++)\n    {\n      int fd1 = (i & 8) ? dfd : AT_FDCWD;\n      char *file1 = mfile_name_concat ((i & 4) ? \"..\" : cwd, BASE \"xx\", NULL);\n      int fd2 = (i & 2) ? dfd : AT_FDCWD;\n      char *file2 = mfile_name_concat ((i & 1) ? \"..\" : cwd, BASE \"xx\", NULL);\n      ASSERT (file1);\n      ASSERT (file2);\n      flag = (i & 0x10 ? AT_SYMLINK_FOLLOW : 0);\n\n      ASSERT (sprintf (strchr (file1, '\\0') - 2, \"%02d\", i) == 2);\n      ASSERT (sprintf (strchr (file2, '\\0') - 2, \"%02d\", i + 1) == 2);\n      ASSERT (linkat (fd1, file1, fd2, file2, flag) == 0);\n      ASSERT (unlinkat (fd1, file1, 0) == 0);\n      free (file1);\n      free (file2);\n    }\n  dfd2 = open (\"..\", O_RDONLY);\n  ASSERT (0 <= dfd2);\n  ASSERT (linkat (dfd, \"../\" BASE \"32\", dfd2, BASE \"33\", 0) == 0);\n  ASSERT (linkat (dfd, \"../\" BASE \"33\", dfd2, BASE \"34\",\n                  AT_SYMLINK_FOLLOW) == 0);\n  ASSERT (close (dfd2) == 0);\n\n   \n  ASSERT (chdir (\"..\") == 0);\n  ASSERT (close (dfd) == 0);\n  if (symlink (BASE \"sub1\", BASE \"link1\"))\n    {\n      ASSERT (unlink (BASE \"32\") == 0);\n      ASSERT (unlink (BASE \"33\") == 0);\n      ASSERT (unlink (BASE \"34\") == 0);\n      ASSERT (rmdir (BASE \"sub1\") == 0);\n      ASSERT (rmdir (BASE \"sub2\") == 0);\n      free (cwd);\n      if (!result)\n        fputs (\"skipping test: symlinks not supported on this file system\\n\",\n               stderr);\n      return result;\n    }\n  dfd = open (\".\", O_RDONLY);\n  ASSERT (0 <= dfd);\n  ASSERT (symlink (BASE \"34\", BASE \"link2\") == 0);\n  ASSERT (symlink (BASE \"link3\", BASE \"link3\") == 0);\n  ASSERT (symlink (BASE \"nowhere\", BASE \"link4\") == 0);\n\n   \n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"sub1\", 0) == -1);\n  ASSERT (errno == EEXIST);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1/\", dfd, BASE \"sub1\", 0) == -1);\n  ASSERT (errno == EEXIST || errno == EPERM || errno == EACCES);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"sub1/\", 0) == -1);\n  ASSERT (errno == EEXIST || errno == ENOTDIR);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"sub1\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EEXIST || errno == EPERM || errno == EACCES);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1/\", dfd, BASE \"sub1\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EEXIST || errno == EPERM || errno == EACCES\n          || errno == EINVAL);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"sub1/\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EEXIST || errno == EPERM || errno == EACCES\n          || errno == EINVAL);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"link2\", 0) == -1);\n  ASSERT (errno == EEXIST);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"link2\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EEXIST || errno == EPERM || errno == EACCES);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"link3\", 0) == -1);\n  ASSERT (errno == EEXIST || errno == ELOOP);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"link3\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EEXIST || errno == EPERM || errno == EACCES\n          || errno == ELOOP);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link2\", dfd, BASE \"link3\", 0) == -1);\n  ASSERT (errno == EEXIST || errno == ELOOP);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link2\", dfd, BASE \"link3\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EEXIST || errno == ELOOP);\n\n   \n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"link4\", 0) == -1);\n  ASSERT (errno == EEXIST);\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"link4\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EEXIST || errno == EPERM || errno == EACCES);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"34\", dfd, BASE \"link4\", 0) == -1);\n  ASSERT (errno == EEXIST);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"34\", dfd, BASE \"link4\", AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EEXIST);\n\n   \n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link2/\", dfd, BASE \"link5\", 0) == -1);\n  ASSERT (errno == ENOTDIR);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link2/\", dfd, BASE \"link5\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == ENOTDIR || errno == EINVAL);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link3/\", dfd, BASE \"link5\", 0) == -1);\n  ASSERT (errno == ELOOP);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link3/\", dfd, BASE \"link5\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == ELOOP || errno == EINVAL);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link4/\", dfd, BASE \"link5\", 0) == -1);\n  ASSERT (errno == ENOENT);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link4/\", dfd, BASE \"link5\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == ENOENT || errno == EINVAL);\n\n   \n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"link5\", 0) == 0);\n  check_same_link (BASE \"link1\", BASE \"link5\");\n  ASSERT (unlink (BASE \"link5\") == 0);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link1\", dfd, BASE \"link5\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == EPERM || errno == EACCES);\n  ASSERT (linkat (dfd, BASE \"link2\", dfd, BASE \"link5\", 0) == 0);\n  check_same_link (BASE \"link2\", BASE \"link5\");\n  ASSERT (unlink (BASE \"link5\") == 0);\n  ASSERT (linkat (dfd, BASE \"link2\", dfd, BASE \"file\", AT_SYMLINK_FOLLOW) == 0);\n  errno = 0;\n  ASSERT (areadlink (BASE \"file\") == NULL);\n  ASSERT (errno == EINVAL);\n  ASSERT (unlink (BASE \"file\") == 0);\n  ASSERT (linkat (dfd, BASE \"link3\", dfd, BASE \"link5\", 0) == 0);\n  check_same_link (BASE \"link3\", BASE \"link5\");\n  ASSERT (unlink (BASE \"link5\") == 0);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link3\", dfd, BASE \"link5\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == ELOOP);\n  ASSERT (linkat (dfd, BASE \"link4\", dfd, BASE \"link5\", 0) == 0);\n  check_same_link (BASE \"link4\", BASE \"link5\");\n  ASSERT (unlink (BASE \"link5\") == 0);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link4\", dfd, BASE \"link5\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == ENOENT);\n\n   \n  ASSERT (symlink (BASE \"link2\", BASE \"link5\") == 0);\n  ASSERT (linkat (dfd, BASE \"link5\", dfd, BASE \"link6\", 0) == 0);\n  check_same_link (BASE \"link5\", BASE \"link6\");\n  ASSERT (unlink (BASE \"link6\") == 0);\n  ASSERT (linkat (dfd, BASE \"link5\", dfd, BASE \"file\", AT_SYMLINK_FOLLOW) == 0);\n  errno = 0;\n  ASSERT (areadlink (BASE \"file\") == NULL);\n  ASSERT (errno == EINVAL);\n  ASSERT (unlink (BASE \"file\") == 0);\n  ASSERT (unlink (BASE \"link5\") == 0);\n  ASSERT (symlink (BASE \"link3\", BASE \"link5\") == 0);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link5\", dfd, BASE \"file\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == ELOOP);\n  ASSERT (unlink (BASE \"link5\") == 0);\n  ASSERT (symlink (BASE \"link4\", BASE \"link5\") == 0);\n  errno = 0;\n  ASSERT (linkat (dfd, BASE \"link5\", dfd, BASE \"file\",\n                  AT_SYMLINK_FOLLOW) == -1);\n  ASSERT (errno == ENOENT);\n\n   \n  ASSERT (symlink (cwd, BASE \"sub1/link\") == 0);\n  ASSERT (symlink (\".././/\" BASE \"sub1/link/\" BASE \"link2\",\n                   BASE \"sub2/link\") == 0);\n  ASSERT (close (dfd) == 0);\n  dfd = open (BASE \"sub1\", O_RDONLY);\n  ASSERT (0 <= dfd);\n  dfd2 = open (BASE \"sub2\", O_RDONLY);\n  ASSERT (0 < dfd2);\n  ASSERT (linkat (dfd, \"../\" BASE \"sub2/link\", dfd2, \"./..//\" BASE \"sub1/file\",\n              AT_SYMLINK_FOLLOW) == 0);\n  errno = 0;\n  ASSERT (areadlink (BASE \"sub1/file\") == NULL);\n  ASSERT (errno == EINVAL);\n\n   \n  ASSERT (close (dfd) == 0);\n  ASSERT (close (dfd2) == 0);\n  ASSERT (unlink (BASE \"sub1/file\") == 0);\n  ASSERT (unlink (BASE \"sub1/link\") == 0);\n  ASSERT (unlink (BASE \"sub2/link\") == 0);\n  ASSERT (unlink (BASE \"32\") == 0);\n  ASSERT (unlink (BASE \"33\") == 0);\n  ASSERT (unlink (BASE \"34\") == 0);\n  ASSERT (rmdir (BASE \"sub1\") == 0);\n  ASSERT (rmdir (BASE \"sub2\") == 0);\n  ASSERT (unlink (BASE \"link1\") == 0);\n  ASSERT (unlink (BASE \"link2\") == 0);\n  ASSERT (unlink (BASE \"link3\") == 0);\n  ASSERT (unlink (BASE \"link4\") == 0);\n  ASSERT (unlink (BASE \"link5\") == 0);\n  free (cwd);\n  return result;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}