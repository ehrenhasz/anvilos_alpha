{
  "module_name": "test-file-has-acl.sh",
  "hash_id": "002d7ca5f250cdf3b6006171747ba5666f59922a627f8c0b05fb3a20b35d4945",
  "original_prompt": "Ingested from coreutils-9.4/gnulib-tests/test-file-has-acl.sh",
  "human_readable_source": "#!/bin/sh\n\n# Show all commands when run with environment variable VERBOSE=yes.\ntest -z \"$VERBOSE\" || set -x\n\ntest \"$USE_ACL\" = 0 &&\n  {\n    echo \"Skipping test: insufficient ACL support\"\n    exit 77\n  }\n\n# func_tmpdir\n# creates a temporary directory.\n# Sets variable\n# - tmp             pathname of freshly created temporary directory\nfunc_tmpdir ()\n{\n  # Use the environment variable TMPDIR, falling back to /tmp. This allows\n  # users to specify a different temporary directory, for example, if their\n  # /tmp is filled up or too small.\n  : \"${TMPDIR=/tmp}\"\n  {\n    # Use the mktemp program if available. If not available, hide the error\n    # message.\n    tmp=`(umask 077 && mktemp -d \"$TMPDIR/glXXXXXX\") 2>/dev/null` &&\n    test -n \"$tmp\" && test -d \"$tmp\"\n  } ||\n  {\n    # Use a simple mkdir command. It is guaranteed to fail if the directory\n    # already exists.  $RANDOM is bash specific and expands to empty in shells\n    # other than bash, ksh and zsh.  Its use does not increase security;\n    # rather, it minimizes the probability of failure in a very cluttered /tmp\n    # directory.\n    tmp=$TMPDIR/gl$$-$RANDOM\n    (umask 077 && mkdir \"$tmp\")\n  } ||\n  {\n    echo \"$0: cannot create a temporary directory in $TMPDIR\" >&2\n    exit 1\n  }\n}\n\nfunc_tmpdir\n# builddir may already be set by the script that invokes this one.\ncase \"$builddir\" in\n  '') builddir=`pwd` ;;\n  /* | ?:*) ;;\n  *) builddir=`pwd`/$builddir ;;\nesac\ncd \"$builddir\" ||\n  {\n    echo \"$0: cannot determine build directory (unreadable parent dir?)\" >&2\n    exit 1\n  }\n# Switch to a temporary directory, to increase the likelihood that ACLs are\n# supported on the current file system. (/tmp is usually locally mounted,\n# whereas the build dir is sometimes NFS-mounted.)\n( cd \"$tmp\"\n\n  # Prepare tmpfile0.\n  rm -f tmpfile[0-9] tmp.err\n  echo \"Simple contents\" > tmpfile0\n  chmod 600 tmpfile0\n\n  # Classification of the platform according to the programs available for\n  # manipulating ACLs.\n  # Possible values are:\n  #   linux, cygwin, freebsd, solaris, hpux, hpuxjfs, osf1, aix, macosx, irix, none.\n  # TODO: Support also native Windows platforms (mingw).\n  acl_flavor=none\n  if (getfacl tmpfile0 >/dev/null) 2>/dev/null; then\n    # Platforms with the getfacl and setfacl programs.\n    # Linux, FreeBSD, Solaris, Cygwin.\n    if (setfacl --help >/dev/null) 2>/dev/null; then\n      # Linux, Cygwin.\n      if (LC_ALL=C setfacl --help | grep ' --test' >/dev/null) 2>/dev/null; then\n        # Linux.\n        acl_flavor=linux\n      else\n        acl_flavor=cygwin\n      fi\n    else\n      # FreeBSD, Solaris.\n      if (LC_ALL=C setfacl 2>&1 | grep '\\-x entries' >/dev/null) 2>/dev/null; then\n        # FreeBSD.\n        acl_flavor=freebsd\n      else\n        # Solaris.\n        acl_flavor=solaris\n      fi\n    fi\n  else\n    if (lsacl / >/dev/null) 2>/dev/null; then\n      # Platforms with the lsacl and chacl programs.\n      # HP-UX, sometimes also IRIX.\n      if (getacl tmpfile0 >/dev/null) 2>/dev/null; then\n        # HP-UX 11.11 or newer.\n        acl_flavor=hpuxjfs\n      else\n        # HP-UX 11.00.\n        acl_flavor=hpux\n      fi\n    else\n      if (getacl tmpfile0 >/dev/null) 2>/dev/null; then\n        # Tru64, NonStop Kernel.\n        if (getacl -m tmpfile0 >/dev/null) 2>/dev/null; then\n          # Tru64.\n          acl_flavor=osf1\n        else\n          # NonStop Kernel.\n          acl_flavor=nsk\n        fi\n      else\n        if (aclget tmpfile0 >/dev/null) 2>/dev/null; then\n          # AIX.\n          acl_flavor=aix\n        else\n          if (fsaclctl -v >/dev/null) 2>/dev/null; then\n            # Mac OS X.\n            acl_flavor=macosx\n          else\n            if test -f /sbin/chacl; then\n              # IRIX.\n              acl_flavor=irix\n            fi\n          fi\n        fi\n      fi\n    fi\n  fi\n\n  # func_test_file_has_acl file expected\n  # tests the result of the file_has_acl function on file, and checks that it\n  # matches the expected value.\n  func_test_file_has_acl ()\n  {\n    res=`${CHECKER} \"$builddir\"/test-file-has-acl${EXEEXT} \"$1\"`\n    test \"$res\" = \"$2\" || {\n      echo \"file_has_acl(\\\"$1\\\") returned $res, expected $2\" 1>&2\n      exit 1\n    }\n  }\n\n  # func_test_has_acl file expected\n  # tests the result of the file_has_acl function on file, and checks that it\n  # matches the expected value, also taking into account the system's 'ls'\n  # program.\n  case $acl_flavor in\n    freebsd | solaris | hpux | macosx)\n      case $acl_flavor in\n        freebsd | solaris | hpux) acl_ls_option=\"-ld\" ;;\n        macosx)                   acl_ls_option=\"-lde\" ;;\n      esac\n      func_test_has_acl ()\n      {\n        func_test_file_has_acl \"$1\" \"$2\"\n        case `/bin/ls $acl_ls_option \"$1\" | sed 1q` in\n          ??????????+*)\n            test \"$2\" = yes || {\n              echo \"/bin/ls $acl_ls_option $1 shows an ACL, but expected $2\" 1>&2\n              exit 1\n            }\n            ;;\n          ??????????\" \"*)\n            test \"$2\" = no || {\n              echo \"/bin/ls $acl_ls_option $1 shows no ACL, but expected $2\" 1>&2\n              exit 1\n            }\n            ;;\n        esac\n      }\n      ;;\n    irix)\n      func_test_has_acl ()\n      {\n        func_test_file_has_acl \"$1\" \"$2\"\n        case `/bin/ls -ldD \"$1\" | sed 1q` in\n          *\" []\")\n            test \"$2\" = no || {\n              echo \"/bin/ls -ldD $1 shows no ACL, but expected $2\" 1>&2\n              exit 1\n            }\n            ;;\n          *)\n            test \"$2\" = yes || {\n              echo \"/bin/ls -ldD $1 shows an ACL, but expected $2\" 1>&2\n              exit 1\n            }\n            ;;\n        esac\n      }\n      ;;\n    *)\n      func_test_has_acl ()\n      {\n        func_test_file_has_acl \"$1\" \"$2\"\n      }\n      ;;\n  esac\n\n  func_test_has_acl tmpfile0 no\n\n  mkdir tmpdir0\n  func_test_has_acl tmpdir0 no\n\n  if test $acl_flavor != none; then\n    # A POSIX compliant 'id' program.\n    if test -f /usr/xpg4/bin/id; then\n      ID=/usr/xpg4/bin/id\n    else\n      ID=id\n    fi\n    # Use a user and group id different from the current one, to avoid\n    # redundant/ambiguous ACLs.\n    myuid=`$ID -u`\n    mygid=`$ID -g`\n    auid=1\n    if test \"$auid\" = \"$myuid\"; then auid=2; fi\n    agid=1\n    if test \"$agid\" = \"$mygid\"; then agid=2; fi\n\n    case $acl_flavor in\n      linux | freebsd | solaris)\n\n        # Set an ACL for a user.\n        if setfacl -m user:$auid:1 tmpfile0; then\n\n          func_test_has_acl tmpfile0 yes\n\n          # Remove the ACL for the user.\n          case $acl_flavor in\n            linux)   setfacl -x user:$auid tmpfile0 ;;\n            freebsd) setfacl -x user:$auid:1 tmpfile0 ;;\n            *)       setfacl -d user:$auid:1 tmpfile0 ;;\n          esac\n\n          # On Linux and FreeBSD, the ACL for the mask is implicitly added.\n          # On Solaris, it is always there.\n          case $acl_flavor in\n            linux | freebsd) func_test_has_acl tmpfile0 yes ;;\n            *)               func_test_has_acl tmpfile0 no ;;\n          esac\n\n          # Remove the ACL for the mask, if it was implicitly added.\n          case $acl_flavor in\n            linux | freebsd) setfacl -x mask: tmpfile0 ;;\n            *)               setfacl -d mask: tmpfile0 ;;\n          esac\n\n          func_test_has_acl tmpfile0 no\n\n        fi\n        ;;\n\n      cygwin)\n\n        # Set an ACL for a group.\n        if setfacl -m group:0:1 tmpfile0; then\n\n          func_test_has_acl tmpfile0 yes\n\n          # Remove the ACL for the group.\n          setfacl -d group:0 tmpfile0\n\n          func_test_has_acl tmpfile0 no\n\n        fi\n        ;;\n\n      hpux | hpuxjfs)\n\n        # Set an ACL for a user.\n        orig=`lsacl tmpfile0 | sed -e 's/ tmpfile0$//'`\n        if chacl -r \"${orig}($auid.%,--x)\" tmpfile0; then\n\n          func_test_has_acl tmpfile0 yes\n\n          # Remove the ACL for the user.\n          chacl -d \"($auid.%,--x)\" tmpfile0\n\n          func_test_has_acl tmpfile0 no\n\n        else\n          if test $acl_flavor = hpuxjfs; then\n\n            # Set an ACL for a user.\n            setacl -m user:$auid:1 tmpfile0\n\n            func_test_has_acl tmpfile0 yes\n\n            # Remove the ACL for the user.\n            setacl -d user:$auid tmpfile0\n\n            func_test_has_acl tmpfile0 no\n\n          fi\n        fi\n        ;;\n\n      osf1)\n\n        # Set an ACL for a user.\n        setacl -u user:$auid:1 tmpfile0 2> tmp.err\n        cat tmp.err 1>&2\n        if grep 'Error:' tmp.err > /dev/null \\\n           || grep 'Operation not supported' tmp.err > /dev/null; then\n          :\n        else\n\n          func_test_has_acl tmpfile0 yes\n\n          # Remove the ACL for the user.\n          setacl -x user:$auid:1 tmpfile0\n\n          func_test_has_acl tmpfile0 no\n\n        fi\n        ;;\n\n      nsk)\n\n        # Set an ACL for a user.\n        setacl -m user:$auid:1 tmpfile0\n\n        func_test_has_acl tmpfile0 yes\n\n        # Remove the ACL for the user.\n        setacl -d user:$auid tmpfile0\n\n        func_test_has_acl tmpfile0 no\n\n        ;;\n\n      aix)\n\n        # Set an ACL for a user.\n        { aclget tmpfile0 | sed -e 's/disabled$/enabled/'; echo \"        permit --x u:$auid\"; } | aclput tmpfile0\n        if aclget tmpfile0 | grep enabled > /dev/null; then\n\n          func_test_has_acl tmpfile0 yes\n\n          # Remove the ACL for the user.\n          aclget tmpfile0 | grep -v ' u:[^ ]*$' | aclput tmpfile0\n\n          func_test_has_acl tmpfile0 no\n\n        fi\n        ;;\n\n      macosx)\n\n        # Set an ACL for a user.\n        /bin/chmod +a \"user:daemon allow execute\" tmpfile0\n\n        func_test_has_acl tmpfile0 yes\n\n        # Remove the ACL for the user.\n        /bin/chmod -a \"user:daemon allow execute\" tmpfile0\n\n        func_test_has_acl tmpfile0 no\n\n        ;;\n\n      irix)\n\n        # Set an ACL for a user.\n        /sbin/chacl user::rw-,group::---,other::---,user:$auid:--x tmpfile0 2> tmp.err\n        cat tmp.err 1>&2\n        if test -s tmp.err; then :; else\n\n          func_test_has_acl tmpfile0 yes\n\n          # Remove the ACL for the user.\n          /sbin/chacl user::rw-,group::---,other::--- tmpfile0\n\n          func_test_has_acl tmpfile0 no\n\n        fi\n        ;;\n\n    esac\n  fi\n\n  rm -f tmpfile[0-9] tmp.err\n  rm -rf tmpdir0\n) || exit 1\n\nrm -rf \"$tmp\"\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}