{
  "module_name": "test-sameacls.c",
  "hash_id": "b0813108f0f7c6756e6f272b1aec963ab2126ae2b79b94a5e1e81711557a74c0",
  "original_prompt": "Ingested from coreutils-9.4/gnulib-tests/test-sameacls.c",
  "human_readable_source": " \n\n#include <config.h>\n\n#include <errno.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <sys/stat.h>\n\n#if HAVE_ACL_GET_FILE || HAVE_FACL || HAVE_GETACL || HAVE_ACLX_GET || HAVE_STATACL || HAVE_ACLSORT\n# include <sys/types.h>\n# include <sys/acl.h>\n#endif\n#if HAVE_ACLV_H\n# include <sys/types.h>\n# include <aclv.h>\n#endif\n\n#include \"read-file.h\"\n#include \"xalloc.h\"\n#include \"macros.h\"\n\nint\nmain (int argc, char *argv[])\n{\n  const char *file1;\n  const char *file2;\n\n  ASSERT (argc == 3);\n\n  file1 = argv[1];\n  file2 = argv[2];\n\n   \n  {\n    size_t size1;\n    char *contents1;\n    size_t size2;\n    char *contents2;\n\n    contents1 = read_file (file1, 0, &size1);\n    if (contents1 == NULL)\n      {\n        fprintf (stderr, \"error reading file %s: errno = %d\\n\", file1, errno);\n        fflush (stderr);\n        abort ();\n      }\n    contents2 = read_file (file2, 0, &size2);\n    if (contents2 == NULL)\n      {\n        fprintf (stderr, \"error reading file %s: errno = %d\\n\", file2, errno);\n        fflush (stderr);\n        abort ();\n      }\n\n    if (size2 != size1)\n      {\n        fprintf (stderr, \"files %s and %s have different sizes\\n\",\n                 file1, file2);\n        fflush (stderr);\n        abort ();\n      }\n    if (memcmp (contents1, contents2, size1) != 0)\n      {\n        fprintf (stderr, \"files %s and %s have different contents\\n\",\n                 file1, file2);\n        fflush (stderr);\n        abort ();\n      }\n\n    free (contents2);\n    free (contents1);\n  }\n\n   \n  {\n    struct stat statbuf1;\n    struct stat statbuf2;\n\n    if (stat (file1, &statbuf1) < 0)\n      {\n        fprintf (stderr, \"error accessing file %s: errno = %d\\n\", file1, errno);\n        fflush (stderr);\n        abort ();\n      }\n    if (stat (file2, &statbuf2) < 0)\n      {\n        fprintf (stderr, \"error accessing file %s: errno = %d\\n\", file2, errno);\n        fflush (stderr);\n        abort ();\n      }\n    if (statbuf1.st_mode != statbuf2.st_mode)\n      {\n        fprintf (stderr, \"files %s and %s have different access modes: %03o and %03o\\n\",\n                 file1, file2,\n                (unsigned int) statbuf1.st_mode, (unsigned int) statbuf2.st_mode);\n        return 1;\n      }\n  }\n  {\n#if HAVE_ACL_GET_FILE  \n    static const int types[] =\n      {\n        ACL_TYPE_ACCESS\n# if HAVE_ACL_TYPE_EXTENDED  \n        , ACL_TYPE_EXTENDED\n# endif\n      };\n    int t;\n\n    for (t = 0; t < sizeof (types) / sizeof (types[0]); t++)\n      {\n        int type = types[t];\n        acl_t acl1;\n        char *text1;\n        int errno1;\n        acl_t acl2;\n        char *text2;\n        int errno2;\n\n        acl1 = acl_get_file (file1, type);\n        if (acl1 == (acl_t)NULL)\n          {\n            text1 = NULL;\n            errno1 = errno;\n          }\n        else\n          {\n            text1 = acl_to_text (acl1, NULL);\n            if (text1 == NULL)\n              errno1 = errno;\n            else\n              errno1 = 0;\n          }\n        acl2 = acl_get_file (file2, type);\n        if (acl2 == (acl_t)NULL)\n          {\n            text2 = NULL;\n            errno2 = errno;\n          }\n        else\n          {\n            text2 = acl_to_text (acl2, NULL);\n            if (text2 == NULL)\n              errno2 = errno;\n            else\n              errno2 = 0;\n          }\n\n        if (acl1 != (acl_t)NULL)\n          {\n            if (acl2 != (acl_t)NULL)\n              {\n                if (text1 != NULL)\n                  {\n                    if (text2 != NULL)\n                      {\n                        if (strcmp (text1, text2) != 0)\n                          {\n                            fprintf (stderr, \"files %s and %s have different ACLs:\\n%s\\n%s\\n\",\n                                     file1, file2, text1, text2);\n                            return 1;\n                          }\n                      }\n                    else\n                      {\n                        fprintf (stderr, \"file %s has a valid ACL, but file %s has an invalid ACL\\n\",\n                                 file1, file2);\n                        return 1;\n                      }\n                  }\n                else\n                  {\n                    if (text2 != NULL)\n                      {\n                        fprintf (stderr, \"file %s has an invalid ACL, but file %s has a valid ACL\\n\",\n                                 file1, file2);\n                        return 1;\n                      }\n                    else\n                      {\n                        if (errno1 != errno2)\n                          {\n                            fprintf (stderr, \"files %s and %s have differently invalid ACLs, errno = %d vs. %d\\n\",\n                                     file1, file2, errno1, errno2);\n                            return 1;\n                          }\n                      }\n                  }\n              }\n            else\n              {\n                fprintf (stderr, \"file %s has an ACL, but file %s has no ACL\\n\",\n                         file1, file2);\n                return 1;\n              }\n          }\n        else\n          {\n            if (acl2 != (acl_t)NULL)\n              {\n                fprintf (stderr, \"file %s has no ACL, but file %s has an ACL\\n\",\n                         file1, file2);\n                return 1;\n              }\n          }\n        acl_free (text2);\n        if (acl2 != (acl_t)NULL)\n          acl_free (acl2);\n        acl_free (text1);\n        if (acl1 != (acl_t)NULL)\n          acl_free (acl1);\n      }\n#elif HAVE_FACL && defined GETACL  \n  int count1;\n  int count2;\n\n  count1 = acl (file1, GETACLCNT, 0, NULL);\n  if (count1 < 0 && errno == ENOSYS)  \n    count1 = 0;\n  count2 = acl (file2, GETACLCNT, 0, NULL);\n  if (count2 < 0 && errno == ENOSYS)  \n    count2 = 0;\n\n  if (count1 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file1);\n      fflush (stderr);\n      abort ();\n    }\n  if (count2 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file2);\n      fflush (stderr);\n      abort ();\n    }\n  if (count1 != count2)\n    {\n      fprintf (stderr, \"files %s and %s have different number of ACLs: %d and %d\\n\",\n               file1, file2, count1, count2);\n      return 1;\n    }\n  else\n    {\n      aclent_t *entries1 = XNMALLOC (count1, aclent_t);\n      aclent_t *entries2 = XNMALLOC (count2, aclent_t);\n      int i;\n\n      if (count1 > 0 && acl (file1, GETACL, count1, entries1) < count1)\n        {\n          fprintf (stderr, \"error retrieving the ACLs of file %s\\n\", file1);\n          fflush (stderr);\n          abort ();\n        }\n      if (count2 > 0 && acl (file2, GETACL, count2, entries2) < count1)\n        {\n          fprintf (stderr, \"error retrieving the ACLs of file %s\\n\", file2);\n          fflush (stderr);\n          abort ();\n        }\n      for (i = 0; i < count1; i++)\n        {\n          if (entries1[i].a_type != entries2[i].a_type)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different types %d and %d\\n\",\n                       file1, file2, i, entries1[i].a_type, entries2[i].a_type);\n              return 1;\n            }\n          if (entries1[i].a_id != entries2[i].a_id)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different ids %d and %d\\n\",\n                       file1, file2, i, (int)entries1[i].a_id, (int)entries2[i].a_id);\n              return 1;\n            }\n          if (entries1[i].a_perm != entries2[i].a_perm)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different permissions %03o and %03o\\n\",\n                       file1, file2, i, (unsigned int) entries1[i].a_perm, (unsigned int) entries2[i].a_perm);\n              return 1;\n            }\n        }\n      free (entries2);\n      free (entries1);\n    }\n# ifdef ACE_GETACL\n  count1 = acl (file1, ACE_GETACLCNT, 0, NULL);\n  if (count1 < 0 && errno == EINVAL)\n    count1 = 0;\n  count2 = acl (file2, ACE_GETACLCNT, 0, NULL);\n  if (count2 < 0 && errno == EINVAL)\n    count2 = 0;\n  if (count1 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACE-ACLs of file %s\\n\", file1);\n      fflush (stderr);\n      abort ();\n    }\n  if (count2 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACE-ACLs of file %s\\n\", file2);\n      fflush (stderr);\n      abort ();\n    }\n  {\n    ace_t *entries1 = XNMALLOC (count1, ace_t);\n    ace_t *entries2 = XNMALLOC (count2, ace_t);\n    int ret;\n    int i;\n\n    ret = acl (file1, ACE_GETACL, count1, entries1);\n    if (ret < 0 && errno == EINVAL)\n      count1 = 0;\n    else if (ret < count1)\n      {\n        fprintf (stderr, \"error retrieving the ACE-ACLs of file %s\\n\", file1);\n        fflush (stderr);\n        abort ();\n      }\n    ret = acl (file2, ACE_GETACL, count2, entries2);\n    if (ret < 0 && errno == EINVAL)\n      count2 = 0;\n    else if (ret < count2)\n      {\n        fprintf (stderr, \"error retrieving the ACE-ACLs of file %s\\n\", file2);\n        fflush (stderr);\n        abort ();\n      }\n\n    if (count1 != count2)\n      {\n        fprintf (stderr, \"files %s and %s have different number of ACE-ACLs: %d and %d\\n\",\n                 file1, file2, count1, count2);\n        return 1;\n      }\n\n    for (i = 0; i < count1; i++)\n      {\n        if (entries1[i].a_type != entries2[i].a_type)\n          {\n            fprintf (stderr, \"files %s and %s: different ACE-ACL entry #%d: different types %d and %d\\n\",\n                     file1, file2, i, entries1[i].a_type, entries2[i].a_type);\n            return 1;\n          }\n        if (entries1[i].a_who != entries2[i].a_who)\n          {\n            fprintf (stderr, \"files %s and %s: different ACE-ACL entry #%d: different ids %d and %d\\n\",\n                     file1, file2, i, (int)entries1[i].a_who, (int)entries2[i].a_who);\n            return 1;\n          }\n        if (entries1[i].a_access_mask != entries2[i].a_access_mask)\n          {\n            fprintf (stderr, \"files %s and %s: different ACE-ACL entry #%d: different access masks %03o and %03o\\n\",\n                     file1, file2, i, (unsigned int) entries1[i].a_access_mask, (unsigned int) entries2[i].a_access_mask);\n            return 1;\n          }\n        if (entries1[i].a_flags != entries2[i].a_flags)\n          {\n            fprintf (stderr, \"files %s and %s: different ACE-ACL entry #%d: different flags 0x%x and 0x%x\\n\",\n                     file1, file2, i, (unsigned int) entries1[i].a_flags, (unsigned int) entries2[i].a_flags);\n            return 1;\n          }\n      }\n    free (entries2);\n    free (entries1);\n  }\n# endif\n#elif HAVE_GETACL  \n  int count1;\n  int count2;\n\n  count1 = getacl (file1, 0, NULL);\n  if (count1 < 0\n      && (errno == ENOSYS || errno == EOPNOTSUPP || errno == ENOTSUP))\n    count1 = 0;\n  count2 = getacl (file2, 0, NULL);\n  if (count2 < 0\n      && (errno == ENOSYS || errno == EOPNOTSUPP || errno == ENOTSUP))\n    count2 = 0;\n\n  if (count1 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file1);\n      fflush (stderr);\n      abort ();\n    }\n  if (count2 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file2);\n      fflush (stderr);\n      abort ();\n    }\n  if (count1 != count2)\n    {\n      fprintf (stderr, \"files %s and %s have different number of ACLs: %d and %d\\n\",\n               file1, file2, count1, count2);\n      return 1;\n    }\n  else if (count1 > 0)\n    {\n      struct acl_entry *entries1 = XNMALLOC (count1, struct acl_entry);\n      struct acl_entry *entries2 = XNMALLOC (count2, struct acl_entry);\n      int i;\n\n      if (getacl (file1, count1, entries1) < count1)\n        {\n          fprintf (stderr, \"error retrieving the ACLs of file %s\\n\", file1);\n          fflush (stderr);\n          abort ();\n        }\n      if (getacl (file2, count2, entries2) < count1)\n        {\n          fprintf (stderr, \"error retrieving the ACLs of file %s\\n\", file2);\n          fflush (stderr);\n          abort ();\n        }\n      for (i = 0; i < count1; i++)\n        {\n          if (entries1[i].uid != entries2[i].uid)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different uids %d and %d\\n\",\n                       file1, file2, i, (int)entries1[i].uid, (int)entries2[i].uid);\n              return 1;\n            }\n          if (entries1[i].gid != entries2[i].gid)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different gids %d and %d\\n\",\n                       file1, file2, i, (int)entries1[i].gid, (int)entries2[i].gid);\n              return 1;\n            }\n          if (entries1[i].mode != entries2[i].mode)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different permissions %03o and %03o\\n\",\n                       file1, file2, i, (unsigned int) entries1[i].mode, (unsigned int) entries2[i].mode);\n              return 1;\n            }\n        }\n      free (entries2);\n      free (entries1);\n    }\n\n# if HAVE_ACLV_H  \n  {\n    struct acl dummy_entries[NACLVENTRIES];\n\n    count1 = acl ((char *) file1, ACL_CNT, NACLVENTRIES, dummy_entries);\n    if (count1 < 0\n        && (errno == ENOSYS || errno == EOPNOTSUPP || errno == EINVAL))\n      count1 = 0;\n    count2 = acl ((char *) file2, ACL_CNT, NACLVENTRIES, dummy_entries);\n    if (count2 < 0\n        && (errno == ENOSYS || errno == EOPNOTSUPP || errno == EINVAL))\n      count2 = 0;\n  }\n\n  if (count1 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file1);\n      fflush (stderr);\n      abort ();\n    }\n  if (count2 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file2);\n      fflush (stderr);\n      abort ();\n    }\n  if (count1 != count2)\n    {\n      fprintf (stderr, \"files %s and %s have different number of ACLs: %d and %d\\n\",\n               file1, file2, count1, count2);\n      return 1;\n    }\n  else if (count1 > 0)\n    {\n      struct acl *entries1 = XNMALLOC (count1, struct acl);\n      struct acl *entries2 = XNMALLOC (count2, struct acl);\n      int i;\n\n      if (acl ((char *) file1, ACL_GET, count1, entries1) < count1)\n        {\n          fprintf (stderr, \"error retrieving the ACLs of file %s\\n\", file1);\n          fflush (stderr);\n          abort ();\n        }\n      if (acl ((char *) file2, ACL_GET, count2, entries2) < count1)\n        {\n          fprintf (stderr, \"error retrieving the ACLs of file %s\\n\", file2);\n          fflush (stderr);\n          abort ();\n        }\n      for (i = 0; i < count1; i++)\n        {\n          if (entries1[i].a_type != entries2[i].a_type)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different types %d and %d\\n\",\n                       file1, file2, i, entries1[i].a_type, entries2[i].a_type);\n              return 1;\n            }\n          if (entries1[i].a_id != entries2[i].a_id)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different ids %d and %d\\n\",\n                       file1, file2, i, (int)entries1[i].a_id, (int)entries2[i].a_id);\n              return 1;\n            }\n          if (entries1[i].a_perm != entries2[i].a_perm)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different permissions %03o and %03o\\n\",\n                       file1, file2, i, (unsigned int) entries1[i].a_perm, (unsigned int) entries2[i].a_perm);\n              return 1;\n            }\n        }\n      free (entries2);\n      free (entries1);\n    }\n# endif\n#elif HAVE_ACLX_GET  \n  acl_type_t type1;\n  char acl1[1000];\n  size_t aclsize1 = sizeof (acl1);\n  mode_t mode1;\n  char text1[1000];\n  size_t textsize1 = sizeof (text1);\n  acl_type_t type2;\n  char acl2[1000];\n  size_t aclsize2 = sizeof (acl2);\n  mode_t mode2;\n  char text2[1000];\n  size_t textsize2 = sizeof (text2);\n\n   \n  type1.u64 = ACL_ANY;\n  if (aclx_get (file1, 0, &type1, acl1, &aclsize1, &mode1) < 0)\n    {\n      if (errno == ENOSYS)\n        text1[0] = '\\0';\n      else\n        {\n          fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file1);\n          fflush (stderr);\n          abort ();\n        }\n    }\n  else\n    if (aclx_printStr (text1, &textsize1, acl1, aclsize1, type1, file1, 0) < 0)\n      {\n        fprintf (stderr, \"cannot convert the ACLs of file %s to text\\n\", file1);\n        fflush (stderr);\n        abort ();\n      }\n\n   \n  type2.u64 = ACL_ANY;\n  if (aclx_get (file2, 0, &type2, acl2, &aclsize2, &mode2) < 0)\n    {\n      if (errno == ENOSYS)\n        text2[0] = '\\0';\n      else\n        {\n          fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file2);\n          fflush (stderr);\n          abort ();\n        }\n    }\n  else\n    if (aclx_printStr (text2, &textsize2, acl2, aclsize2, type2, file2, 0) < 0)\n      {\n        fprintf (stderr, \"cannot convert the ACLs of file %s to text\\n\", file2);\n        fflush (stderr);\n        abort ();\n      }\n\n  if (strcmp (text1, text2) != 0)\n    {\n      fprintf (stderr, \"files %s and %s have different ACLs:\\n%s\\n%s\\n\",\n               file1, file2, text1, text2);\n      return 1;\n    }\n#elif HAVE_STATACL  \n  union { struct acl a; char room[4096]; } acl1;\n  union { struct acl a; char room[4096]; } acl2;\n  unsigned int i;\n\n  if (statacl (file1, STX_NORMAL, &acl1.a, sizeof (acl1)) < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file1);\n      fflush (stderr);\n      abort ();\n    }\n  if (statacl (file2, STX_NORMAL, &acl2.a, sizeof (acl2)) < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file2);\n      fflush (stderr);\n      abort ();\n    }\n\n  if (acl1.a.acl_len != acl2.a.acl_len)\n    {\n      fprintf (stderr, \"files %s and %s have different ACL lengths: %u and %u\\n\",\n               file1, file2, acl1.a.acl_len, acl2.a.acl_len);\n      return 1;\n    }\n  if (acl1.a.acl_mode != acl2.a.acl_mode)\n    {\n      fprintf (stderr, \"files %s and %s have different ACL modes: %03o and %03o\\n\",\n               file1, file2, acl1.a.acl_mode, acl2.a.acl_mode);\n      return 1;\n    }\n  if (acl1.a.u_access != acl2.a.u_access\n      || acl1.a.g_access != acl2.a.g_access\n      || acl1.a.o_access != acl2.a.o_access)\n    {\n      fprintf (stderr, \"files %s and %s have different ACL access masks: %03o %03o %03o and %03o %03o %03o\\n\",\n               file1, file2,\n               acl1.a.u_access, acl1.a.g_access, acl1.a.o_access,\n               acl2.a.u_access, acl2.a.g_access, acl2.a.o_access);\n      return 1;\n    }\n  if (memcmp (acl1.a.acl_ext, acl2.a.acl_ext, acl1.a.acl_len) != 0)\n    {\n      fprintf (stderr, \"files %s and %s have different ACL entries\\n\",\n               file1, file2);\n      return 1;\n    }\n#elif HAVE_ACLSORT  \n  int count1;\n  int count2;\n\n  count1 = acl ((char *) file1, ACL_CNT, NACLENTRIES, NULL);\n  count2 = acl ((char *) file2, ACL_CNT, NACLENTRIES, NULL);\n\n  if (count1 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file1);\n      fflush (stderr);\n      abort ();\n    }\n  if (count2 < 0)\n    {\n      fprintf (stderr, \"error accessing the ACLs of file %s\\n\", file2);\n      fflush (stderr);\n      abort ();\n    }\n  if (count1 != count2)\n    {\n      fprintf (stderr, \"files %s and %s have different number of ACLs: %d and %d\\n\",\n               file1, file2, count1, count2);\n      return 1;\n    }\n  else if (count1 > 0)\n    {\n      struct acl *entries1 = XNMALLOC (count1, struct acl);\n      struct acl *entries2 = XNMALLOC (count2, struct acl);\n      int i;\n\n      if (acl ((char *) file1, ACL_GET, count1, entries1) < count1)\n        {\n          fprintf (stderr, \"error retrieving the ACLs of file %s\\n\", file1);\n          fflush (stderr);\n          abort ();\n        }\n      if (acl ((char *) file2, ACL_GET, count2, entries2) < count1)\n        {\n          fprintf (stderr, \"error retrieving the ACLs of file %s\\n\", file2);\n          fflush (stderr);\n          abort ();\n        }\n      for (i = 0; i < count1; i++)\n        {\n          if (entries1[i].a_type != entries2[i].a_type)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different types %d and %d\\n\",\n                       file1, file2, i, entries1[i].a_type, entries2[i].a_type);\n              return 1;\n            }\n          if (entries1[i].a_id != entries2[i].a_id)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different ids %d and %d\\n\",\n                       file1, file2, i, (int)entries1[i].a_id, (int)entries2[i].a_id);\n              return 1;\n            }\n          if (entries1[i].a_perm != entries2[i].a_perm)\n            {\n              fprintf (stderr, \"files %s and %s: different ACL entry #%d: different permissions %03o and %03o\\n\",\n                       file1, file2, i, (unsigned int) entries1[i].a_perm, (unsigned int) entries2[i].a_perm);\n              return 1;\n            }\n        }\n      free (entries2);\n      free (entries1);\n    }\n#endif\n  }\n\n  return 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}