{
  "module_name": "nap.h",
  "hash_id": "36ad3b032485b2b0650e953a5e77cde84ee1b5515639bb867cdde0f8da369233",
  "original_prompt": "Ingested from coreutils-9.4/gnulib-tests/nap.h",
  "human_readable_source": " \n\n#ifndef GLTEST_NAP_H\n# define GLTEST_NAP_H\n\n# include <limits.h>\n\n# include <stdckdint.h>\n\n \n# if defined _SCO_DS || (defined __SCO_VERSION__ || defined __sysv5__)   \n#  include <unistd.h>\n#  undef nap\n#  define nap gl_nap\n# endif\n\n \n#define TEMPFILE BASE \"nap.tmp\"\n\n \nstatic int nap_fd = -1;\n\n \nstatic int\ndiff_timespec (struct timespec a, struct timespec b)\n{\n  time_t as = a.tv_sec;\n  time_t bs = b.tv_sec;\n  int ans = a.tv_nsec;\n  int bns = b.tv_nsec;\n  int sdiff;\n\n  ASSERT (0 <= ans && ans < 2000000000);\n  ASSERT (0 <= bns && bns < 2000000000);\n\n  if (! (bs < as || (bs == as && bns < ans)))\n    return 0;\n\n  if (ckd_sub (&sdiff, as, bs)\n      || ckd_mul (&sdiff, sdiff, 1000000000)\n      || ckd_add (&sdiff, sdiff, ans - bns))\n    return INT_MAX;\n\n  return sdiff;\n}\n\n \nstatic void\nnap_get_stat (struct stat *st, int do_write)\n{\n  if (do_write)\n    {\n      ASSERT (write (nap_fd, \"\\n\", 1) == 1);\n#if defined _WIN32 || defined __CYGWIN__\n       \nstatic bool\nnap_works (int delay, struct stat old_st)\n{\n  struct stat st;\n  struct timespec delay_spec;\n  delay_spec.tv_sec = delay / 1000000000;\n  delay_spec.tv_nsec = delay % 1000000000;\n  ASSERT (nanosleep (&delay_spec, 0) == 0);\n  nap_get_stat (&st, 1);\n\n  if (diff_timespec (get_stat_mtime (&st), get_stat_mtime (&old_st)))\n    return true;\n\n  return false;\n}\n\nstatic void\nclear_temp_file (void)\n{\n  if (0 <= nap_fd)\n    {\n      ASSERT (close (nap_fd) != -1);\n      ASSERT (unlink (TEMPFILE) != -1);\n    }\n}\n\n \nstatic void\nnap (void)\n{\n  struct stat old_st;\n  static int delay = 1;\n\n  if (-1 == nap_fd)\n    {\n      atexit (clear_temp_file);\n      ASSERT ((nap_fd = creat (TEMPFILE, 0600)) != -1);\n      nap_get_stat (&old_st, 0);\n    }\n  else\n    {\n      ASSERT (0 <= nap_fd);\n      nap_get_stat (&old_st, 1);\n    }\n\n  if (1 < delay)\n    delay = delay / 2;   \n  ASSERT (0 < delay);\n\n  for (;;)\n    {\n      if (nap_works (delay, old_st))\n        return;\n      if (delay <= (2147483647 - 1) / 2)\n        {\n          delay = delay * 2 + 1;\n          continue;\n        }\n      else\n        break;\n    }\n\n   \n  ASSERT (0);\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}