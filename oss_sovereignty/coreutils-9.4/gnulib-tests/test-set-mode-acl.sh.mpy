{
  "module_name": "test-set-mode-acl.sh",
  "hash_id": "4097119e5c2b220c12780bfa45e88df8dfd741570f46492dd7a971b2617e5f45",
  "original_prompt": "Ingested from coreutils-9.4/gnulib-tests/test-set-mode-acl.sh",
  "human_readable_source": "#!/bin/sh\n\n# Show all commands when run with environment variable VERBOSE=yes.\ntest -z \"$VERBOSE\" || set -x\n\ntest \"$USE_ACL\" = 0 &&\n  {\n    echo \"Skipping test: insufficient ACL support\"\n    exit 77\n  }\n\n# func_tmpdir\n# creates a temporary directory.\n# Sets variable\n# - tmp             pathname of freshly created temporary directory\nfunc_tmpdir ()\n{\n  # Use the environment variable TMPDIR, falling back to /tmp. This allows\n  # users to specify a different temporary directory, for example, if their\n  # /tmp is filled up or too small.\n  : \"${TMPDIR=/tmp}\"\n  {\n    # Use the mktemp program if available. If not available, hide the error\n    # message.\n    tmp=`(umask 077 && mktemp -d \"$TMPDIR/glXXXXXX\") 2>/dev/null` &&\n    test -n \"$tmp\" && test -d \"$tmp\"\n  } ||\n  {\n    # Use a simple mkdir command. It is guaranteed to fail if the directory\n    # already exists.  $RANDOM is bash specific and expands to empty in shells\n    # other than bash, ksh and zsh.  Its use does not increase security;\n    # rather, it minimizes the probability of failure in a very cluttered /tmp\n    # directory.\n    tmp=$TMPDIR/gl$$-$RANDOM\n    (umask 077 && mkdir \"$tmp\")\n  } ||\n  {\n    echo \"$0: cannot create a temporary directory in $TMPDIR\" >&2\n    exit 1\n  }\n}\n\nfunc_tmpdir\n# builddir may already be set by the script that invokes this one.\ncase \"$builddir\" in\n  '') builddir=`pwd` ;;\n  /* | ?:*) ;;\n  *) builddir=`pwd`/$builddir ;;\nesac\ncd \"$builddir\" ||\n  {\n    echo \"$0: cannot determine build directory (unreadable parent dir?)\" >&2\n    exit 1\n  }\n# Switch to a temporary directory, to increase the likelihood that ACLs are\n# supported on the current file system. (/tmp is usually locally mounted,\n# whereas the build dir is sometimes NFS-mounted.)\n( cd \"$tmp\"\n\n  # Prepare tmpfile0.\n  rm -f tmpfile[0-9]\n  echo \"Simple contents\" > tmpfile0\n  chmod 600 tmpfile0\n\n  # Classification of the platform according to the programs available for\n  # manipulating ACLs.\n  # Possible values are:\n  #   linux, cygwin, freebsd, solaris, hpux, hpuxjfs, osf1, aix, macosx, irix, none.\n  # TODO: Support also native Windows platforms (mingw).\n  acl_flavor=none\n  if (getfacl tmpfile0 >/dev/null) 2>/dev/null; then\n    # Platforms with the getfacl and setfacl programs.\n    # Linux, FreeBSD, Solaris, Cygwin.\n    if (setfacl --help >/dev/null) 2>/dev/null; then\n      # Linux, Cygwin.\n      if (LC_ALL=C setfacl --help | grep ' --set-file' >/dev/null) 2>/dev/null; then\n        # Linux.\n        acl_flavor=linux\n      else\n        acl_flavor=cygwin\n      fi\n    else\n      # FreeBSD, Solaris.\n      if (LC_ALL=C setfacl 2>&1 | grep '\\-x entries' >/dev/null) 2>/dev/null; then\n        # FreeBSD.\n        acl_flavor=freebsd\n      else\n        # Solaris.\n        acl_flavor=solaris\n      fi\n    fi\n  else\n    if (lsacl / >/dev/null) 2>/dev/null; then\n      # Platforms with the lsacl and chacl programs.\n      # HP-UX, sometimes also IRIX.\n      if (getacl tmpfile0 >/dev/null) 2>/dev/null; then\n        # HP-UX 11.11 or newer.\n        acl_flavor=hpuxjfs\n      else\n        # HP-UX 11.00.\n        acl_flavor=hpux\n      fi\n    else\n      if (getacl tmpfile0 >/dev/null) 2>/dev/null; then\n        # Tru64, NonStop Kernel.\n        if (getacl -m tmpfile0 >/dev/null) 2>/dev/null; then\n          # Tru64.\n          acl_flavor=osf1\n        else\n          # NonStop Kernel.\n          acl_flavor=nsk\n        fi\n      else\n        if (aclget tmpfile0 >/dev/null) 2>/dev/null; then\n          # AIX.\n          acl_flavor=aix\n        else\n          if (fsaclctl -v >/dev/null) 2>/dev/null; then\n            # Mac OS X.\n            acl_flavor=macosx\n          else\n            if test -f /sbin/chacl; then\n              # IRIX.\n              acl_flavor=irix\n            fi\n          fi\n        fi\n      fi\n    fi\n  fi\n\n  if test $acl_flavor != none; then\n    # A POSIX compliant 'id' program.\n    if test -f /usr/xpg4/bin/id; then\n      ID=/usr/xpg4/bin/id\n    else\n      ID=id\n    fi\n    # Use a user and group id different from the current one, to avoid\n    # redundant/ambiguous ACLs.\n    myuid=`$ID -u`\n    mygid=`$ID -g`\n    auid=1\n    if test \"$auid\" = \"$myuid\"; then auid=2; fi\n    agid=1\n    if test \"$agid\" = \"$mygid\"; then agid=2; fi\n  fi\n\n  for mode in 700 400 200 100 644 650 605 011 4700 2070; do\n    rm -f tmpfile0 tmpfile1 tmpfile2\n\n    # Prepare a file with no ACL.\n    echo \"Anything\" > tmpfile0\n    # If a mode is not supported (e.g. 2070 on FreeBSD), we skip testing it.\n    if chmod $mode tmpfile0 2>/dev/null; then\n      modestring0=`ls -l tmpfile0 | dd ibs=1 count=10 2>/dev/null`\n\n      # Prepare a file with no ACL.\n      echo \"Some contents\" > tmpfile1\n      chmod 600 tmpfile1\n\n      # Try to set the ACL to only the given mode.\n      ${CHECKER} \"$builddir\"/test-set-mode-acl${EXEEXT} tmpfile1 $mode\n      # Verify that tmpfile1 has no ACL and has the desired mode.\n      modestring=`ls -l tmpfile1 | dd ibs=1 count=10 2>/dev/null`\n      if test \"x$modestring\" != \"x$modestring0\"; then\n        echo \"mode = $mode: tmpfile1 has wrong mode: $modestring\" 1>&2\n        exit 1\n      fi\n      if test `${CHECKER} \"$builddir\"/test-file-has-acl${EXEEXT} tmpfile1` != no; then\n        echo \"mode = $mode: tmpfile1 got an ACL\" 1>&2\n        exit 1\n      fi\n\n      if test $acl_flavor != none; then\n\n        # Prepare a file with an ACL.\n        echo \"Special contents\" > tmpfile2\n        chmod 600 tmpfile2\n        # Set an ACL for a user (or group).\n        case $acl_flavor in\n          linux | freebsd | solaris)\n            setfacl -m user:$auid:1 tmpfile0\n            ;;\n          cygwin)\n            setfacl -m group:0:1 tmpfile0\n            ;;\n          hpux)\n            orig=`lsacl tmpfile0 | sed -e 's/ tmpfile0$//'`\n            chacl -r \"${orig}($auid.%,--x)\" tmpfile0\n            ;;\n          hpuxjfs)\n            orig=`lsacl tmpfile0 | sed -e 's/ tmpfile0$//'`\n            chacl -r \"${orig}($auid.%,--x)\" tmpfile0 \\\n              || setacl -m user:$auid:1 tmpfile0\n            ;;\n          osf1)\n            setacl -u user:$auid:1 tmpfile0\n            ;;\n          nsk)\n            setacl -m user:$auid:1 tmpfile0\n            ;;\n          aix)\n            { aclget tmpfile0 | sed -e 's/disabled$/enabled/'; echo \"        permit --x u:$auid\"; } | aclput tmpfile0\n            ;;\n          macosx)\n            /bin/chmod +a \"user:daemon allow execute\" tmpfile0\n            ;;\n          irix)\n            /sbin/chacl user::rw-,group::---,other::---,user:$auid:--x tmpfile0\n            ;;\n        esac\n\n        # Try to set the ACL to only the given mode.\n        ${CHECKER} \"$builddir\"/test-set-mode-acl${EXEEXT} tmpfile2 $mode\n        # Verify that tmpfile2 has no ACL and has the desired mode.\n        modestring=`ls -l tmpfile2 | dd ibs=1 count=10 2>/dev/null`\n        if test \"x$modestring\" != \"x$modestring0\"; then\n          echo \"mode = $mode: tmpfile2 has wrong mode: $modestring\" 1>&2\n          exit 1\n        fi\n        if test `${CHECKER} \"$builddir\"/test-file-has-acl${EXEEXT} tmpfile2` != no; then\n          echo \"mode = $mode: tmpfile2 still has an ACL\" 1>&2\n          exit 1\n        fi\n      fi\n    fi\n  done\n\n  rm -f tmpfile[0-9]\n) || exit 1\n\nrm -rf \"$tmp\"\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}