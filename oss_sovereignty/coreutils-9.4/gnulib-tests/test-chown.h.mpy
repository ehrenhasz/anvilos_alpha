{
  "module_name": "test-chown.h",
  "hash_id": "c9fbb3d002a46a81f22105a53edcaea74a9555e1f5c604f9f0f2a6066b264a8b",
  "original_prompt": "Ingested from coreutils-9.4/gnulib-tests/test-chown.h",
  "human_readable_source": " \n\n#include \"nap.h\"\n\n#if !HAVE_GETGID\n# define getgid() ((gid_t) -1)\n#endif\n\n#if !HAVE_GETEGID\n# define getegid() ((gid_t) -1)\n#endif\n\n \n\nstatic int\ntest_chown (int (*func) (char const *, uid_t, gid_t), bool print)\n{\n  struct stat st1;\n  struct stat st2;\n  gid_t *gids = NULL;\n  int gids_count;\n  int result;\n\n   \n  ASSERT (mkdir (BASE \"dir\", 0700) == 0);\n  ASSERT (stat (BASE \"dir\", &st1) == 0);\n\n   \n  result = func (BASE \"dir\", st1.st_uid, getegid ());\n  if (result == -1 && (errno == ENOSYS || errno == EPERM))\n    {\n      ASSERT (rmdir (BASE \"dir\") == 0);\n      if (print)\n        fputs (\"skipping test: no support for ownership\\n\", stderr);\n      return 77;\n    }\n  ASSERT (result == 0);\n\n  ASSERT (close (creat (BASE \"dir/file\", 0600)) == 0);\n  ASSERT (stat (BASE \"dir/file\", &st1) == 0);\n  ASSERT (st1.st_uid != (uid_t) -1);\n  ASSERT (st1.st_gid != (gid_t) -1);\n   \n  if (getgid () != (gid_t) -1)\n    ASSERT (st1.st_gid == getegid ());\n\n   \n  errno = 0;\n  ASSERT (func (\"\", -1, -1) == -1);\n  ASSERT (errno == ENOENT);\n  errno = 0;\n  ASSERT (func (\"no_such\", -1, -1) == -1);\n  ASSERT (errno == ENOENT);\n  errno = 0;\n  ASSERT (func (\"no_such/\", -1, -1) == -1);\n  ASSERT (errno == ENOENT);\n  errno = 0;\n  ASSERT (func (BASE \"dir/file/\", -1, -1) == -1);\n  ASSERT (errno == ENOTDIR);\n\n   \n  ASSERT (func (BASE \"dir/file\", -1, st1.st_gid) == 0);\n  ASSERT (func (BASE \"dir/file\", st1.st_uid, -1) == 0);\n  ASSERT (func (BASE \"dir/file\", (uid_t) -1, (gid_t) -1) == 0);\n  ASSERT (stat (BASE \"dir/file\", &st2) == 0);\n  ASSERT (st1.st_uid == st2.st_uid);\n  ASSERT (st1.st_gid == st2.st_gid);\n\n   \n  nap ();\n  ASSERT (func (BASE \"dir/file\", st1.st_uid, st1.st_gid) == 0);\n  ASSERT (stat (BASE \"dir/file\", &st2) == 0);\n  ASSERT (st1.st_ctime < st2.st_ctime\n          || (st1.st_ctime == st2.st_ctime\n              && get_stat_ctime_ns (&st1) < get_stat_ctime_ns (&st2)));\n\n   \n  if (symlink (\"link\", BASE \"dir/link2\"))\n    {\n      ASSERT (unlink (BASE \"dir/file\") == 0);\n      ASSERT (rmdir (BASE \"dir\") == 0);\n      if (print)\n        fputs (\"skipping test: symlinks not supported on this file system\\n\",\n               stderr);\n      return 77;\n    }\n  errno = 0;\n  ASSERT (func (BASE \"dir/link2\", -1, -1) == -1);\n  ASSERT (errno == ENOENT);\n  errno = 0;\n  ASSERT (func (BASE \"dir/link2/\", st1.st_uid, st1.st_gid) == -1);\n  ASSERT (errno == ENOENT);\n  ASSERT (symlink (\"file\", BASE \"dir/link\") == 0);\n\n   \n  gids_count = mgetgroups (NULL, st1.st_gid, &gids);\n  if (1 < gids_count)\n    {\n      ASSERT (gids[1] != st1.st_gid);\n      if (getgid () != (gid_t) -1)\n        ASSERT (gids[1] != (gid_t) -1);\n      ASSERT (lstat (BASE \"dir/link\", &st2) == 0);\n      ASSERT (st1.st_uid == st2.st_uid);\n      ASSERT (st1.st_gid == st2.st_gid);\n      ASSERT (lstat (BASE \"dir/link2\", &st2) == 0);\n      ASSERT (st1.st_uid == st2.st_uid);\n      ASSERT (st1.st_gid == st2.st_gid);\n\n      errno = 0;\n      ASSERT (func (BASE \"dir/link2/\", -1, gids[1]) == -1);\n      ASSERT (errno == ENOTDIR);\n      ASSERT (stat (BASE \"dir/file\", &st2) == 0);\n      ASSERT (st1.st_uid == st2.st_uid);\n      ASSERT (st1.st_gid == st2.st_gid);\n      ASSERT (lstat (BASE \"dir/link\", &st2) == 0);\n      ASSERT (st1.st_uid == st2.st_uid);\n      ASSERT (st1.st_gid == st2.st_gid);\n      ASSERT (lstat (BASE \"dir/link2\", &st2) == 0);\n      ASSERT (st1.st_uid == st2.st_uid);\n      ASSERT (st1.st_gid == st2.st_gid);\n\n      ASSERT (func (BASE \"dir/link2\", -1, gids[1]) == 0);\n      ASSERT (stat (BASE \"dir/file\", &st2) == 0);\n      ASSERT (st1.st_uid == st2.st_uid);\n      if (getgid () != (gid_t) -1)\n        ASSERT (gids[1] == st2.st_gid);\n      ASSERT (lstat (BASE \"dir/link\", &st2) == 0);\n      ASSERT (st1.st_uid == st2.st_uid);\n      ASSERT (st1.st_gid == st2.st_gid);\n      ASSERT (lstat (BASE \"dir/link2\", &st2) == 0);\n      ASSERT (st1.st_uid == st2.st_uid);\n      ASSERT (st1.st_gid == st2.st_gid);\n    }\n  else\n    {\n      struct stat l1;\n      struct stat l2;\n      ASSERT (stat (BASE \"dir/file\", &st1) == 0);\n      ASSERT (lstat (BASE \"dir/link\", &l1) == 0);\n      ASSERT (lstat (BASE \"dir/link2\", &l2) == 0);\n\n      nap ();\n      errno = 0;\n      ASSERT (func (BASE \"dir/link2/\", -1, st1.st_gid) == -1);\n      ASSERT (errno == ENOTDIR);\n      ASSERT (stat (BASE \"dir/file\", &st2) == 0);\n      ASSERT (st1.st_ctime == st2.st_ctime);\n      ASSERT (get_stat_ctime_ns (&st1) == get_stat_ctime_ns (&st2));\n      ASSERT (lstat (BASE \"dir/link\", &st2) == 0);\n      ASSERT (l1.st_ctime == st2.st_ctime);\n      ASSERT (get_stat_ctime_ns (&l1) == get_stat_ctime_ns (&st2));\n      ASSERT (lstat (BASE \"dir/link2\", &st2) == 0);\n      ASSERT (l2.st_ctime == st2.st_ctime);\n      ASSERT (get_stat_ctime_ns (&l2) == get_stat_ctime_ns (&st2));\n\n      ASSERT (func (BASE \"dir/link2\", -1, st1.st_gid) == 0);\n      ASSERT (stat (BASE \"dir/file\", &st2) == 0);\n      ASSERT (st1.st_ctime < st2.st_ctime\n              || (st1.st_ctime == st2.st_ctime\n                  && get_stat_ctime_ns (&st1) < get_stat_ctime_ns (&st2)));\n      ASSERT (lstat (BASE \"dir/link\", &st2) == 0);\n      ASSERT (l1.st_ctime == st2.st_ctime);\n      ASSERT (get_stat_ctime_ns (&l1) == get_stat_ctime_ns (&st2));\n      ASSERT (lstat (BASE \"dir/link2\", &st2) == 0);\n      ASSERT (l2.st_ctime == st2.st_ctime);\n      ASSERT (get_stat_ctime_ns (&l2) == get_stat_ctime_ns (&st2));\n    }\n\n   \n  free (gids);\n  ASSERT (unlink (BASE \"dir/file\") == 0);\n  ASSERT (unlink (BASE \"dir/link\") == 0);\n  ASSERT (unlink (BASE \"dir/link2\") == 0);\n  ASSERT (rmdir (BASE \"dir\") == 0);\n  return 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}