{
  "module_name": "relocatable.c",
  "hash_id": "6c810ff283b15b16718947e3d7b52abda1fbc0ce81d9c06fbb6e0c3fd16b005a",
  "original_prompt": "Ingested from bash-5.2.21/lib/intl/relocatable.c",
  "human_readable_source": " \n\n \n\n \n#ifndef _GNU_SOURCE\n# define _GNU_SOURCE\t1\n#endif\n\n#ifdef HAVE_CONFIG_H\n# include \"config.h\"\n#endif\n\n \n#include \"relocatable.h\"\n\n#if ENABLE_RELOCATABLE\n\n#include <stddef.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\n#ifdef NO_XMALLOC\n# define xmalloc malloc\n#else\n# include \"xmalloc.h\"\n#endif\n\n#if DEPENDS_ON_LIBCHARSET\n# include <libcharset.h>\n#endif\n#if DEPENDS_ON_LIBICONV && HAVE_ICONV\n# include <iconv.h>\n#endif\n#if DEPENDS_ON_LIBINTL && ENABLE_NLS\n# include <libintl.h>\n#endif\n\n \n#undef bool\n#undef false\n#undef true\n#define bool int\n#define false 0\n#define true 1\n\n \n#if defined _WIN32 || defined __WIN32__ || defined __EMX__ || defined __DJGPP__\n   \n# define ISSLASH(C) ((C) == '/' || (C) == '\\\\')\n# define HAS_DEVICE(P) \\\n    ((((P)[0] >= 'A' && (P)[0] <= 'Z') || ((P)[0] >= 'a' && (P)[0] <= 'z')) \\\n     && (P)[1] == ':')\n# define IS_PATH_WITH_DIR(P) \\\n    (strchr (P, '/') != NULL || strchr (P, '\\\\') != NULL || HAS_DEVICE (P))\n# define FILESYSTEM_PREFIX_LEN(P) (HAS_DEVICE (P) ? 2 : 0)\n#else\n   \n# define ISSLASH(C) ((C) == '/')\n# define IS_PATH_WITH_DIR(P) (strchr (P, '/') != NULL)\n# define FILESYSTEM_PREFIX_LEN(P) 0\n#endif\n\n \nstatic char *orig_prefix;\nstatic size_t orig_prefix_len;\n \nstatic char *curr_prefix;\nstatic size_t curr_prefix_len;\n \n\n \nstatic void\nset_this_relocation_prefix (const char *orig_prefix_arg,\n\t\t\t    const char *curr_prefix_arg)\n{\n  if (orig_prefix_arg != NULL && curr_prefix_arg != NULL\n       \n      && strcmp (orig_prefix_arg, curr_prefix_arg) != 0)\n    {\n       \n      char *memory;\n\n      orig_prefix_len = strlen (orig_prefix_arg);\n      curr_prefix_len = strlen (curr_prefix_arg);\n      memory = (char *) xmalloc (orig_prefix_len + 1 + curr_prefix_len + 1);\n#ifdef NO_XMALLOC\n      if (memory != NULL)\n#endif\n\t{\n\t  memcpy (memory, orig_prefix_arg, orig_prefix_len + 1);\n\t  orig_prefix = memory;\n\t  memory += orig_prefix_len + 1;\n\t  memcpy (memory, curr_prefix_arg, curr_prefix_len + 1);\n\t  curr_prefix = memory;\n\t  return;\n\t}\n    }\n  orig_prefix = NULL;\n  curr_prefix = NULL;\n   \n}\n\n \nvoid\nset_relocation_prefix (const char *orig_prefix_arg, const char *curr_prefix_arg)\n{\n  set_this_relocation_prefix (orig_prefix_arg, curr_prefix_arg);\n\n   \n#if DEPENDS_ON_LIBCHARSET\n  libcharset_set_relocation_prefix (orig_prefix_arg, curr_prefix_arg);\n#endif\n#if DEPENDS_ON_LIBICONV && HAVE_ICONV && _LIBICONV_VERSION >= 0x0109\n  libiconv_set_relocation_prefix (orig_prefix_arg, curr_prefix_arg);\n#endif\n#if DEPENDS_ON_LIBINTL && ENABLE_NLS && defined libintl_set_relocation_prefix\n  libintl_set_relocation_prefix (orig_prefix_arg, curr_prefix_arg);\n#endif\n}\n\n \n#ifdef IN_LIBRARY\n#define compute_curr_prefix local_compute_curr_prefix\nstatic\n#endif\nconst char *\ncompute_curr_prefix (const char *orig_installprefix,\n\t\t     const char *orig_installdir,\n\t\t     const char *curr_pathname)\n{\n  const char *curr_installdir;\n  const char *rel_installdir;\n\n  if (curr_pathname == NULL)\n    return NULL;\n\n   \n  if (strncmp (orig_installprefix, orig_installdir, strlen (orig_installprefix))\n      != 0)\n     \n    return NULL;\n  rel_installdir = orig_installdir + strlen (orig_installprefix);\n\n   \n  {\n    const char *p_base = curr_pathname + FILESYSTEM_PREFIX_LEN (curr_pathname);\n    const char *p = curr_pathname + strlen (curr_pathname);\n    char *q;\n\n    while (p > p_base)\n      {\n\tp--;\n\tif (ISSLASH (*p))\n\t  break;\n      }\n\n    q = (char *) xmalloc (p - curr_pathname + 1);\n#ifdef NO_XMALLOC\n    if (q == NULL)\n      return NULL;\n#endif\n    memcpy (q, curr_pathname, p - curr_pathname);\n    q[p - curr_pathname] = '\\0';\n    curr_installdir = q;\n  }\n\n   \n  {\n    const char *rp = rel_installdir + strlen (rel_installdir);\n    const char *cp = curr_installdir + strlen (curr_installdir);\n    const char *cp_base =\n      curr_installdir + FILESYSTEM_PREFIX_LEN (curr_installdir);\n\n    while (rp > rel_installdir && cp > cp_base)\n      {\n\tbool same = false;\n\tconst char *rpi = rp;\n\tconst char *cpi = cp;\n\n\twhile (rpi > rel_installdir && cpi > cp_base)\n\t  {\n\t    rpi--;\n\t    cpi--;\n\t    if (ISSLASH (*rpi) || ISSLASH (*cpi))\n\t      {\n\t\tif (ISSLASH (*rpi) && ISSLASH (*cpi))\n\t\t  same = true;\n\t\tbreak;\n\t      }\n#if defined _WIN32 || defined __WIN32__ || defined __EMX__ || defined __DJGPP__\n\t     \n\t    if ((*rpi >= 'a' && *rpi <= 'z' ? *rpi - 'a' + 'A' : *rpi)\n\t\t!= (*cpi >= 'a' && *cpi <= 'z' ? *cpi - 'a' + 'A' : *cpi))\n\t      break;\n#else\n\t    if (*rpi != *cpi)\n\t      break;\n#endif\n\t  }\n\tif (!same)\n\t  break;\n\t \n\trp = rpi;\n\tcp = cpi;\n      }\n\n    if (rp > rel_installdir)\n       \n      return NULL;\n\n    {\n      size_t curr_prefix_len = cp - curr_installdir;\n      char *curr_prefix;\n\n      curr_prefix = (char *) xmalloc (curr_prefix_len + 1);\n#ifdef NO_XMALLOC\n      if (curr_prefix == NULL)\n\treturn NULL;\n#endif\n      memcpy (curr_prefix, curr_installdir, curr_prefix_len);\n      curr_prefix[curr_prefix_len] = '\\0';\n\n      return curr_prefix;\n    }\n  }\n}\n\n#if defined PIC && defined INSTALLDIR\n\n \nstatic char *shared_library_fullname;\n\n#if defined _WIN32 || defined __WIN32__\n\n \n\nBOOL WINAPI\nDllMain (HINSTANCE module_handle, DWORD event, LPVOID reserved)\n{\n  (void) reserved;\n\n  if (event == DLL_PROCESS_ATTACH)\n    {\n       \n      static char location[MAX_PATH];\n\n      if (!GetModuleFileName (module_handle, location, sizeof (location)))\n\t \n\treturn FALSE;\n\n      if (!IS_PATH_WITH_DIR (location))\n\t \n\treturn FALSE;\n\n      shared_library_fullname = strdup (location);\n    }\n\n  return TRUE;\n}\n\n#else  \n\nstatic void\nfind_shared_library_fullname ()\n{\n#ifdef __linux__\n  FILE *fp;\n\n   \n  fp = fopen (\"/proc/self/maps\", \"r\");\n  if (fp)\n    {\n      unsigned long address = (unsigned long) &find_shared_library_fullname;\n      for (;;)\n\t{\n\t  unsigned long start, end;\n\t  int c;\n\n\t  if (fscanf (fp, \"%lx-%lx\", &start, &end) != 2)\n\t    break;\n\t  if (address >= start && address <= end - 1)\n\t    {\n\t       \n\t      while (c = getc (fp), c != EOF && c != '\\n' && c != '/')\n\t\tcontinue;\n\t      if (c == '/')\n\t\t{\n\t\t  size_t size;\n\t\t  int len;\n\n\t\t  ungetc (c, fp);\n\t\t  shared_library_fullname = NULL; size = 0;\n\t\t  len = getline (&shared_library_fullname, &size, fp);\n\t\t  if (len >= 0)\n\t\t    {\n\t\t       \n\t\t      if (len > 0 && shared_library_fullname[len - 1] == '\\n')\n\t\t\tshared_library_fullname[len - 1] = '\\0';\n\t\t    }\n\t\t}\n\t      break;\n\t    }\n\t  while (c = getc (fp), c != EOF && c != '\\n')\n\t    continue;\n\t}\n      fclose (fp);\n    }\n#endif\n}\n\n#endif  \n\n \nstatic char *\nget_shared_library_fullname ()\n{\n#if !(defined _WIN32 || defined __WIN32__)\n  static bool tried_find_shared_library_fullname;\n  if (!tried_find_shared_library_fullname)\n    {\n      find_shared_library_fullname ();\n      tried_find_shared_library_fullname = true;\n    }\n#endif\n  return shared_library_fullname;\n}\n\n#endif  \n\n \nconst char *\nrelocate (const char *pathname)\n{\n#if defined PIC && defined INSTALLDIR\n  static int initialized;\n\n   \n  if (!initialized)\n    {\n       \n      const char *orig_installprefix = INSTALLPREFIX;\n      const char *orig_installdir = INSTALLDIR;\n      const char *curr_prefix_better;\n\n      curr_prefix_better =\n\tcompute_curr_prefix (orig_installprefix, orig_installdir,\n\t\t\t     get_shared_library_fullname ());\n      if (curr_prefix_better == NULL)\n\tcurr_prefix_better = curr_prefix;\n\n      set_relocation_prefix (orig_installprefix, curr_prefix_better);\n\n      initialized = 1;\n    }\n#endif\n\n   \n  if (orig_prefix != NULL && curr_prefix != NULL\n      && strncmp (pathname, orig_prefix, orig_prefix_len) == 0)\n    {\n      if (pathname[orig_prefix_len] == '\\0')\n\t \n\treturn curr_prefix;\n      if (ISSLASH (pathname[orig_prefix_len]))\n\t{\n\t   \n\t  const char *pathname_tail = &pathname[orig_prefix_len];\n\t  char *result =\n\t    (char *) xmalloc (curr_prefix_len + strlen (pathname_tail) + 1);\n\n#ifdef NO_XMALLOC\n\t  if (result != NULL)\n#endif\n\t    {\n\t      memcpy (result, curr_prefix, curr_prefix_len);\n\t      strcpy (result + curr_prefix_len, pathname_tail);\n\t      return result;\n\t    }\n\t}\n    }\n   \n  return pathname;\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}