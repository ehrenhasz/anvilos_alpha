{
  "module_name": "threadlib.m4",
  "hash_id": "a92b1b0864e65d7a29042ce0f0fbd62eba0d6d2fde2e8d06c34a53ab1ae1de55",
  "original_prompt": "Ingested from bash-5.2.21/m4/threadlib.m4",
  "human_readable_source": "# threadlib.m4 serial 16\ndnl Copyright (C) 2005-2019 Free Software Foundation, Inc.\ndnl This file is free software; the Free Software Foundation\ndnl gives unlimited permission to copy and/or distribute it,\ndnl with or without modifications, as long as this notice is preserved.\n\ndnl From Bruno Haible.\n\nAC_PREREQ([2.60])\n\ndnl gl_THREADLIB\ndnl ------------\ndnl Tests for a multithreading library to be used.\ndnl If the configure.ac contains a definition of the gl_THREADLIB_DEFAULT_NO\ndnl (it must be placed before the invocation of gl_THREADLIB_EARLY!), then the\ndnl default is 'no', otherwise it is system dependent. In both cases, the user\ndnl can change the choice through the options --enable-threads=choice or\ndnl --disable-threads.\ndnl Defines at most one of the macros USE_POSIX_THREADS, USE_SOLARIS_THREADS,\ndnl USE_PTH_THREADS, USE_WINDOWS_THREADS\ndnl Sets the variables LIBTHREAD and LTLIBTHREAD to the linker options for use\ndnl in a Makefile (LIBTHREAD for use without libtool, LTLIBTHREAD for use with\ndnl libtool).\ndnl Sets the variables LIBMULTITHREAD and LTLIBMULTITHREAD similarly, for\ndnl programs that really need multithread functionality. The difference\ndnl between LIBTHREAD and LIBMULTITHREAD is that on platforms supporting weak\ndnl symbols, typically LIBTHREAD is empty whereas LIBMULTITHREAD is not.\ndnl Adds to CPPFLAGS the flag -D_REENTRANT or -D_THREAD_SAFE if needed for\ndnl multithread-safe programs.\n\nAC_DEFUN([gl_THREADLIB_EARLY],\n[\n  AC_REQUIRE([gl_THREADLIB_EARLY_BODY])\n])\n\ndnl The guts of gl_THREADLIB_EARLY. Needs to be expanded only once.\n\nAC_DEFUN([gl_THREADLIB_EARLY_BODY],\n[\n  dnl Ordering constraints: This macro modifies CPPFLAGS in a way that\n  dnl influences the result of the autoconf tests that test for *_unlocked\n  dnl declarations, on AIX 5 at least. Therefore it must come early.\n  AC_BEFORE([$0], [gl_FUNC_GLIBC_UNLOCKED_IO])dnl\n  AC_BEFORE([$0], [gl_ARGP])dnl\n\n  AC_REQUIRE([AC_CANONICAL_HOST])\n  dnl _GNU_SOURCE is needed for pthread_rwlock_t on glibc systems.\n  AC_REQUIRE([AC_USE_SYSTEM_EXTENSIONS])\n  dnl Check for multithreading.\n  m4_ifdef([gl_THREADLIB_DEFAULT_NO],\n    [m4_divert_text([DEFAULTS], [gl_use_threads_default=no])],\n    [m4_divert_text([DEFAULTS], [gl_use_threads_default=])])\n  AC_ARG_ENABLE([threads],\nAS_HELP_STRING([--enable-threads={posix|solaris|pth|windows}], [specify multithreading API])m4_ifdef([gl_THREADLIB_DEFAULT_NO], [], [\nAS_HELP_STRING([--disable-threads], [build without multithread safety])]),\n    [gl_use_threads=$enableval],\n    [if test -n \"$gl_use_threads_default\"; then\n       gl_use_threads=\"$gl_use_threads_default\"\n     else\nchangequote(,)dnl\n       case \"$host_os\" in\n         dnl Disable multithreading by default on OSF/1, because it interferes\n         dnl with fork()/exec(): When msgexec is linked with -lpthread, its\n         dnl child process gets an endless segmentation fault inside execvp().\n         dnl Disable multithreading by default on Cygwin 1.5.x, because it has\n         dnl bugs that lead to endless loops or crashes. See\n         dnl <https://cygwin.com/ml/cygwin/2009-08/msg00283.html>.\n         osf*) gl_use_threads=no ;;\n         cygwin*)\n               case `uname -r` in\n                 1.[0-5].*) gl_use_threads=no ;;\n                 *)         gl_use_threads=yes ;;\n               esac\n               ;;\n         *)    gl_use_threads=yes ;;\n       esac\nchangequote([,])dnl\n     fi\n    ])\n  if test \"$gl_use_threads\" = yes || test \"$gl_use_threads\" = posix; then\n    # For using <pthread.h>:\n    case \"$host_os\" in\n      osf*)\n        # On OSF/1, the compiler needs the flag -D_REENTRANT so that it\n        # groks <pthread.h>. cc also understands the flag -pthread, but\n        # we don't use it because 1. gcc-2.95 doesn't understand -pthread,\n        # 2. putting a flag into CPPFLAGS that has an effect on the linker\n        # causes the AC_LINK_IFELSE test below to succeed unexpectedly,\n        # leading to wrong values of LIBTHREAD and LTLIBTHREAD.\n        CPPFLAGS=\"$CPPFLAGS -D_REENTRANT\"\n        ;;\n    esac\n    # Some systems optimize for single-threaded programs by default, and\n    # need special flags to disable these optimizations. For example, the\n    # definition of 'errno' in <errno.h>.\n    case \"$host_os\" in\n      aix* | freebsd* | midnightbsd*) CPPFLAGS=\"$CPPFLAGS -D_THREAD_SAFE\" ;;\n      solaris*) CPPFLAGS=\"$CPPFLAGS -D_REENTRANT\" ;;\n    esac\n  fi\n])\n\ndnl The guts of gl_THREADLIB. Needs to be expanded only once.\n\nAC_DEFUN([gl_THREADLIB_BODY],\n[\n  AC_REQUIRE([gl_THREADLIB_EARLY_BODY])\n  gl_threads_api=none\n  LIBTHREAD=\n  LTLIBTHREAD=\n  LIBMULTITHREAD=\n  LTLIBMULTITHREAD=\n  if test \"$gl_use_threads\" != no; then\n    dnl Check whether the compiler and linker support weak declarations.\n    AC_CACHE_CHECK([whether imported symbols can be declared weak],\n      [gl_cv_have_weak],\n      [gl_cv_have_weak=no\n       dnl First, test whether the compiler accepts it syntactically.\n       AC_LINK_IFELSE(\n         [AC_LANG_PROGRAM(\n            [[extern void xyzzy ();\n#pragma weak xyzzy]],\n            [[xyzzy();]])],\n         [gl_cv_have_weak=maybe])\n       if test $gl_cv_have_weak = maybe; then\n         dnl Second, test whether it actually works. On Cygwin 1.7.2, with\n         dnl gcc 4.3, symbols declared weak always evaluate to the address 0.\n         AC_RUN_IFELSE(\n           [AC_LANG_SOURCE([[\n#include <stdio.h>\n#pragma weak fputs\nint main ()\n{\n  return (fputs == NULL);\n}]])],\n           [gl_cv_have_weak=yes],\n           [gl_cv_have_weak=no],\n           [dnl When cross-compiling, assume that only ELF platforms support\n            dnl weak symbols.\n            AC_EGREP_CPP([Extensible Linking Format],\n              [#ifdef __ELF__\n               Extensible Linking Format\n               #endif\n              ],\n              [gl_cv_have_weak=\"guessing yes\"],\n              [gl_cv_have_weak=\"guessing no\"])\n           ])\n       fi\n       dnl But when linking statically, weak symbols don't work.\n       case \" $LDFLAGS \" in\n         *\" -static \"*) gl_cv_have_weak=no ;;\n       esac\n      ])\n    if test \"$gl_use_threads\" = yes || test \"$gl_use_threads\" = posix; then\n      # On OSF/1, the compiler needs the flag -pthread or -D_REENTRANT so that\n      # it groks <pthread.h>. It's added above, in gl_THREADLIB_EARLY_BODY.\n      AC_CHECK_HEADER([pthread.h],\n        [gl_have_pthread_h=yes], [gl_have_pthread_h=no])\n      if test \"$gl_have_pthread_h\" = yes; then\n        # Other possible tests:\n        #   -lpthreads (FSU threads, PCthreads)\n        #   -lgthreads\n        gl_have_pthread=\n        # Test whether both pthread_mutex_lock and pthread_mutexattr_init exist\n        # in libc. IRIX 6.5 has the first one in both libc and libpthread, but\n        # the second one only in libpthread, and lock.c needs it.\n        #\n        # If -pthread works, prefer it to -lpthread, since Ubuntu 14.04\n        # needs -pthread for some reason.  See:\n        # https://lists.gnu.org/r/bug-gnulib/2014-09/msg00023.html\n        save_LIBS=$LIBS\n        for gl_pthread in '' '-pthread'; do\n          LIBS=\"$LIBS $gl_pthread\"\n          AC_LINK_IFELSE(\n            [AC_LANG_PROGRAM(\n               [[#include <pthread.h>\n                 pthread_mutex_t m;\n                 pthread_mutexattr_t ma;\n               ]],\n               [[pthread_mutex_lock (&m);\n                 pthread_mutexattr_init (&ma);]])],\n            [gl_have_pthread=yes\n             LIBTHREAD=$gl_pthread LTLIBTHREAD=$gl_pthread\n             LIBMULTITHREAD=$gl_pthread LTLIBMULTITHREAD=$gl_pthread])\n          LIBS=$save_LIBS\n          test -n \"$gl_have_pthread\" && break\n        done\n\n        # Test for libpthread by looking for pthread_kill. (Not pthread_self,\n        # since it is defined as a macro on OSF/1.)\n        if test -n \"$gl_have_pthread\" && test -z \"$LIBTHREAD\"; then\n          # The program links fine without libpthread. But it may actually\n          # need to link with libpthread in order to create multiple threads.\n          AC_CHECK_LIB([pthread], [pthread_kill],\n            [LIBMULTITHREAD=-lpthread LTLIBMULTITHREAD=-lpthread\n             # On Solaris and HP-UX, most pthread functions exist also in libc.\n             # Therefore pthread_in_use() needs to actually try to create a\n             # thread: pthread_create from libc will fail, whereas\n             # pthread_create will actually create a thread.\n             # On Solaris 10 or newer, this test is no longer needed, because\n             # libc contains the fully functional pthread functions.\n             case \"$host_os\" in\n               solaris | solaris2.[1-9] | solaris2.[1-9].* | hpux*)\n                 AC_DEFINE([PTHREAD_IN_USE_DETECTION_HARD], [1],\n                   [Define if the pthread_in_use() detection is hard.])\n             esac\n            ])\n        elif test -z \"$gl_have_pthread\"; then\n          # Some library is needed. Try libpthread and libc_r.\n          AC_CHECK_LIB([pthread], [pthread_kill],\n            [gl_have_pthread=yes\n             LIBTHREAD=-lpthread LTLIBTHREAD=-lpthread\n             LIBMULTITHREAD=-lpthread LTLIBMULTITHREAD=-lpthread])\n          if test -z \"$gl_have_pthread\"; then\n            # For FreeBSD 4.\n            AC_CHECK_LIB([c_r], [pthread_kill],\n              [gl_have_pthread=yes\n               LIBTHREAD=-lc_r LTLIBTHREAD=-lc_r\n               LIBMULTITHREAD=-lc_r LTLIBMULTITHREAD=-lc_r])\n          fi\n        fi\n        if test -n \"$gl_have_pthread\"; then\n          gl_threads_api=posix\n          AC_DEFINE([USE_POSIX_THREADS], [1],\n            [Define if the POSIX multithreading library can be used.])\n          if test -n \"$LIBMULTITHREAD\" || test -n \"$LTLIBMULTITHREAD\"; then\n            if case \"$gl_cv_have_weak\" in *yes) true;; *) false;; esac; then\n              AC_DEFINE([USE_POSIX_THREADS_WEAK], [1],\n                [Define if references to the POSIX multithreading library should be made weak.])\n              LIBTHREAD=\n              LTLIBTHREAD=\n            fi\n          fi\n        fi\n      fi\n    fi\n    if test -z \"$gl_have_pthread\"; then\n      if test \"$gl_use_threads\" = yes || test \"$gl_use_threads\" = solaris; then\n        gl_have_solaristhread=\n        gl_save_LIBS=\"$LIBS\"\n        LIBS=\"$LIBS -lthread\"\n        AC_LINK_IFELSE(\n          [AC_LANG_PROGRAM(\n             [[\n#include <thread.h>\n#include <synch.h>\n             ]],\n             [[thr_self();]])],\n          [gl_have_solaristhread=yes])\n        LIBS=\"$gl_save_LIBS\"\n        if test -n \"$gl_have_solaristhread\"; then\n          gl_threads_api=solaris\n          LIBTHREAD=-lthread\n          LTLIBTHREAD=-lthread\n          LIBMULTITHREAD=\"$LIBTHREAD\"\n          LTLIBMULTITHREAD=\"$LTLIBTHREAD\"\n          AC_DEFINE([USE_SOLARIS_THREADS], [1],\n            [Define if the old Solaris multithreading library can be used.])\n          if case \"$gl_cv_have_weak\" in *yes) true;; *) false;; esac; then\n            AC_DEFINE([USE_SOLARIS_THREADS_WEAK], [1],\n              [Define if references to the old Solaris multithreading library should be made weak.])\n            LIBTHREAD=\n            LTLIBTHREAD=\n          fi\n        fi\n      fi\n    fi\n    if test \"$gl_use_threads\" = pth; then\n      gl_save_CPPFLAGS=\"$CPPFLAGS\"\n      AC_LIB_LINKFLAGS([pth])\n      gl_have_pth=\n      gl_save_LIBS=\"$LIBS\"\n      LIBS=\"$LIBS $LIBPTH\"\n      AC_LINK_IFELSE(\n        [AC_LANG_PROGRAM([[#include <pth.h>]], [[pth_self();]])],\n        [gl_have_pth=yes])\n      LIBS=\"$gl_save_LIBS\"\n      if test -n \"$gl_have_pth\"; then\n        gl_threads_api=pth\n        LIBTHREAD=\"$LIBPTH\"\n        LTLIBTHREAD=\"$LTLIBPTH\"\n        LIBMULTITHREAD=\"$LIBTHREAD\"\n        LTLIBMULTITHREAD=\"$LTLIBTHREAD\"\n        AC_DEFINE([USE_PTH_THREADS], [1],\n          [Define if the GNU Pth multithreading library can be used.])\n        if test -n \"$LIBMULTITHREAD\" || test -n \"$LTLIBMULTITHREAD\"; then\n          if case \"$gl_cv_have_weak\" in *yes) true;; *) false;; esac; then\n            AC_DEFINE([USE_PTH_THREADS_WEAK], [1],\n              [Define if references to the GNU Pth multithreading library should be made weak.])\n            LIBTHREAD=\n            LTLIBTHREAD=\n          fi\n        fi\n      else\n        CPPFLAGS=\"$gl_save_CPPFLAGS\"\n      fi\n    fi\n    if test -z \"$gl_have_pthread\"; then\n      case \"$gl_use_threads\" in\n        yes | windows | win32) # The 'win32' is for backward compatibility.\n          if { case \"$host_os\" in\n                 mingw*) true;;\n                 *) false;;\n               esac\n             }; then\n            gl_threads_api=windows\n            AC_DEFINE([USE_WINDOWS_THREADS], [1],\n              [Define if the native Windows multithreading API can be used.])\n          fi\n          ;;\n      esac\n    fi\n  fi\n  AC_MSG_CHECKING([for multithread API to use])\n  AC_MSG_RESULT([$gl_threads_api])\n  AC_SUBST([LIBTHREAD])\n  AC_SUBST([LTLIBTHREAD])\n  AC_SUBST([LIBMULTITHREAD])\n  AC_SUBST([LTLIBMULTITHREAD])\n])\n\nAC_DEFUN([gl_THREADLIB],\n[\n  AC_REQUIRE([gl_THREADLIB_EARLY])\n  AC_REQUIRE([gl_THREADLIB_BODY])\n])\n\n\ndnl gl_DISABLE_THREADS\ndnl ------------------\ndnl Sets the gl_THREADLIB default so that threads are not used by default.\ndnl The user can still override it at installation time, by using the\ndnl configure option '--enable-threads'.\n\nAC_DEFUN([gl_DISABLE_THREADS], [\n  m4_divert_text([INIT_PREPARE], [gl_use_threads_default=no])\n])\n\n\ndnl Survey of platforms:\ndnl\ndnl Platform           Available  Compiler    Supports   test-lock\ndnl                    flavours   option      weak       result\ndnl ---------------    ---------  ---------   --------   ---------\ndnl Linux 2.4/glibc    posix      -lpthread       Y      OK\ndnl\ndnl GNU Hurd/glibc     posix\ndnl\ndnl Ubuntu 14.04       posix      -pthread        Y      OK\ndnl\ndnl FreeBSD 5.3        posix      -lc_r           Y\ndnl                    posix      -lkse ?         Y\ndnl                    posix      -lpthread ?     Y\ndnl                    posix      -lthr           Y\ndnl\ndnl FreeBSD 5.2        posix      -lc_r           Y\ndnl                    posix      -lkse           Y\ndnl                    posix      -lthr           Y\ndnl\ndnl FreeBSD 4.0,4.10   posix      -lc_r           Y      OK\ndnl\ndnl NetBSD 1.6         --\ndnl\ndnl OpenBSD 3.4        posix      -lpthread       Y      OK\ndnl\ndnl Mac OS X 10.[123]  posix      -lpthread       Y      OK\ndnl\ndnl Solaris 7,8,9      posix      -lpthread       Y      Sol 7,8: 0.0; Sol 9: OK\ndnl                    solaris    -lthread        Y      Sol 7,8: 0.0; Sol 9: OK\ndnl\ndnl HP-UX 11           posix      -lpthread       N (cc) OK\ndnl                                               Y (gcc)\ndnl\ndnl IRIX 6.5           posix      -lpthread       Y      0.5\ndnl\ndnl AIX 4.3,5.1        posix      -lpthread       N      AIX 4: 0.5; AIX 5: OK\ndnl\ndnl OSF/1 4.0,5.1      posix      -pthread (cc)   N      OK\ndnl                               -lpthread (gcc) Y\ndnl\ndnl Cygwin             posix      -lpthread       Y      OK\ndnl\ndnl Any of the above   pth        -lpth                  0.0\ndnl\ndnl Mingw              windows                    N      OK\ndnl\ndnl BeOS 5             --\ndnl\ndnl The test-lock result shows what happens if in test-lock.c EXPLICIT_YIELD is\ndnl turned off:\ndnl   OK if all three tests terminate OK,\ndnl   0.5 if the first test terminates OK but the second one loops endlessly,\ndnl   0.0 if the first test already loops endlessly.\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}