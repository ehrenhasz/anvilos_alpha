{
  "module_name": "access.c",
  "hash_id": "395bf8191233c98edb2404a283d614a22d35734262412edcc6aa857f85642d2c",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/tinfo/access.c",
  "human_readable_source": " \n\n \n\n#include <curses.priv.h>\n\n#include <ctype.h>\n\n#ifndef USE_ROOT_ACCESS\n#if HAVE_SETFSUID\n#include <sys/fsuid.h>\n#else\n#include <sys/stat.h>\n#endif\n#endif\n\n#include <tic.h>\n\nMODULE_ID(\"$Id: access.c,v 1.31 2021/08/29 10:35:17 tom Exp $\")\n\n#define LOWERCASE(c) ((isalpha(UChar(c)) && isupper(UChar(c))) ? tolower(UChar(c)) : (c))\n\n#ifdef _NC_MSC\n# define ACCESS(FN, MODE) access((FN), (MODE)&(R_OK|W_OK))\n#else\n# define ACCESS access\n#endif\n\nNCURSES_EXPORT(char *)\n_nc_rootname(char *path)\n{\n    char *result = _nc_basename(path);\n#if !MIXEDCASE_FILENAMES || defined(PROG_EXT)\n    static char *temp;\n    char *s;\n\n    temp = strdup(result);\n    result = temp;\n#if !MIXEDCASE_FILENAMES\n    for (s = result; *s != '\\0'; ++s) {\n\t*s = (char) LOWERCASE(*s);\n    }\n#endif\n#if defined(PROG_EXT)\n    if ((s = strrchr(result, '.')) != 0) {\n\tif (!strcmp(s, PROG_EXT))\n\t    *s = '\\0';\n    }\n#endif\n#endif\n    return result;\n}\n\n \nNCURSES_EXPORT(bool)\n_nc_is_abs_path(const char *path)\n{\n#if defined(__EMX__) || defined(__DJGPP__)\n#define is_pathname(s) ((((s) != 0) && ((s)[0] == '/')) \\\n\t\t  || (((s)[0] != 0) && ((s)[1] == ':')))\n#else\n#define is_pathname(s) ((s) != 0 && (s)[0] == '/')\n#endif\n    return is_pathname(path);\n}\n\n \nNCURSES_EXPORT(unsigned)\n_nc_pathlast(const char *path)\n{\n    const char *test = strrchr(path, '/');\n#ifdef __EMX__\n    if (test == 0)\n\ttest = strrchr(path, '\\\\');\n#endif\n    if (test == 0)\n\ttest = path;\n    else\n\ttest++;\n    return (unsigned) (test - path);\n}\n\nNCURSES_EXPORT(char *)\n_nc_basename(char *path)\n{\n    return path + _nc_pathlast(path);\n}\n\nNCURSES_EXPORT(int)\n_nc_access(const char *path, int mode)\n{\n    int result;\n\n    if (path == 0) {\n\tresult = -1;\n    } else if (ACCESS(path, mode) < 0) {\n\tif ((mode & W_OK) != 0\n\t    && errno == ENOENT\n\t    && strlen(path) < PATH_MAX) {\n\t    char head[PATH_MAX];\n\t    char *leaf;\n\n\t    _nc_STRCPY(head, path, sizeof(head));\n\t    leaf = _nc_basename(head);\n\t    if (leaf == 0)\n\t\tleaf = head;\n\t    *leaf = '\\0';\n\t    if (head == leaf)\n\t\t_nc_STRCPY(head, \".\", sizeof(head));\n\n\t    result = ACCESS(head, R_OK | W_OK | X_OK);\n\t} else {\n\t    result = -1;\n\t}\n    } else {\n\tresult = 0;\n    }\n    return result;\n}\n\nNCURSES_EXPORT(bool)\n_nc_is_dir_path(const char *path)\n{\n    bool result = FALSE;\n    struct stat sb;\n\n    if (stat(path, &sb) == 0\n\t&& S_ISDIR(sb.st_mode)) {\n\tresult = TRUE;\n    }\n    return result;\n}\n\nNCURSES_EXPORT(bool)\n_nc_is_file_path(const char *path)\n{\n    bool result = FALSE;\n    struct stat sb;\n\n    if (stat(path, &sb) == 0\n\t&& S_ISREG(sb.st_mode)) {\n\tresult = TRUE;\n    }\n    return result;\n}\n\n#if HAVE_ISSETUGID\n#define is_elevated() issetugid()\n#elif HAVE_GETEUID && HAVE_GETEGID\n#define is_elevated() \\\n\t(getuid() != geteuid() \\\n\t || getgid() != getegid())\n#else\n#define is_elevated() FALSE\n#endif\n\n#if HAVE_SETFSUID\n#define lower_privileges() \\\n\t    int save_err = errno; \\\n\t    setfsuid(getuid()); \\\n\t    setfsgid(getgid()); \\\n\t    errno = save_err\n#define resume_elevation() \\\n\t    save_err = errno; \\\n\t    setfsuid(geteuid()); \\\n\t    setfsgid(getegid()); \\\n\t    errno = save_err\n#else\n#define lower_privileges()\t \n#define resume_elevation()\t \n#endif\n\n#ifndef USE_ROOT_ENVIRON\n \nNCURSES_EXPORT(int)\n_nc_env_access(void)\n{\n    int result = TRUE;\n\n    if (is_elevated()) {\n\tresult = FALSE;\n    } else if ((getuid() == ROOT_UID) || (geteuid() == ROOT_UID)) {\n\tresult = FALSE;\n    }\n    return result;\n}\n#endif  \n\n#ifndef USE_ROOT_ACCESS\n \nNCURSES_EXPORT(FILE *)\n_nc_safe_fopen(const char *path, const char *mode)\n{\n    FILE *result = NULL;\n#if HAVE_SETFSUID\n    lower_privileges();\n    result = fopen(path, mode);\n    resume_elevation();\n#else\n    if (!is_elevated() || *mode == 'r') {\n\tresult = fopen(path, mode);\n    }\n#endif\n    return result;\n}\n\nNCURSES_EXPORT(int)\n_nc_safe_open3(const char *path, int flags, mode_t mode)\n{\n    int result = -1;\n#if HAVE_SETFSUID\n    lower_privileges();\n    result = open(path, flags, mode);\n    resume_elevation();\n#else\n    if (!is_elevated() || (flags & O_RDONLY)) {\n\tresult = open(path, flags, mode);\n    }\n#endif\n    return result;\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}