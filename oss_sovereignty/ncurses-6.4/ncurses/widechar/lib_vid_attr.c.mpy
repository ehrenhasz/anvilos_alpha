{
  "module_name": "lib_vid_attr.c",
  "hash_id": "6cd5761cc16d2070b56a8cdaeaece8aa089d3735aaab6f539fa9ca480ece2f28",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/widechar/lib_vid_attr.c",
  "human_readable_source": " \n\n \n\n#include <curses.priv.h>\n\n#ifndef CUR\n#define CUR SP_TERMTYPE\n#endif\n\nMODULE_ID(\"$Id: lib_vid_attr.c,v 1.30 2020/05/27 23:54:31 tom Exp $\")\n\n#define doPut(mode) \\\n\tTPUTS_TRACE(#mode); \\\n\tNCURSES_SP_NAME(tputs) (NCURSES_SP_ARGx mode, 1, outc)\n\n#define TurnOn(mask, mode) \\\n\tif ((turn_on & mask) && mode) { \\\n\t    TPUTS_TRACE(#mode); \\\n\t    NCURSES_SP_NAME(tputs) (NCURSES_SP_ARGx mode, 1, outc); \\\n\t}\n\n#define TurnOff(mask, mode) \\\n\tif ((turn_off & mask) && mode) { \\\n\t    TPUTS_TRACE(#mode); \\\n\t    NCURSES_SP_NAME(tputs) (NCURSES_SP_ARGx mode, 1, outc); \\\n\t    turn_off &= ~mask; \\\n\t}\n\n\t \n#define SetColorsIf(why, old_attr, old_pair) \\\n\tif (can_color && (why)) { \\\n\t\tTR(TRACE_ATTRS, (\"old pair = %d -- new pair = %d\", old_pair, color_pair)); \\\n\t\tif ((color_pair != old_pair) \\\n\t\t || (fix_pair0 && (color_pair == 0)) \\\n\t\t || (reverse ^ ((old_attr & A_REVERSE) != 0))) { \\\n\t\t    NCURSES_SP_NAME(_nc_do_color) (NCURSES_SP_ARGx \\\n\t\t\t\t\t\t   old_pair, color_pair, \\\n\t\t\t\t\t\t   reverse, outc); \\\n\t\t} \\\n\t}\n\n#define set_color(mode, pair) \\\n\tmode &= ALL_BUT_COLOR; \\\n\tmode |= (attr_t) ColorPair(pair)\n\nNCURSES_EXPORT(int)\nNCURSES_SP_NAME(vid_puts) (NCURSES_SP_DCLx\n\t\t\t   attr_t newmode,\n\t\t\t   NCURSES_PAIRS_T pair_arg,\n\t\t\t   void *opts OPTIONAL_PAIR,\n\t\t\t   NCURSES_SP_OUTC outc)\n{\n    int color_pair = pair_arg;\n#if NCURSES_EXT_COLORS\n    static attr_t previous_attr = A_NORMAL;\n    static int previous_pair = 0;\n\n    attr_t turn_on, turn_off;\n    bool reverse = FALSE;\n    bool can_color = (SP_PARM == 0 || SP_PARM->_coloron);\n#if NCURSES_EXT_FUNCS\n    bool fix_pair0 = (SP_PARM != 0 && SP_PARM->_coloron && !SP_PARM->_default_color);\n#else\n#define fix_pair0 FALSE\n#endif\n\n    if (!IsValidTIScreen(SP_PARM))\n\treturnCode(ERR);\n\n    newmode &= A_ATTRIBUTES;\n    set_extended_pair(opts, color_pair);\n    T((T_CALLED(\"vid_puts(%s,%d)\"), _traceattr(newmode), color_pair));\n\n     \n    if (SP_PARM) {\n\tprevious_attr = AttrOf(SCREEN_ATTRS(SP_PARM));\n\tprevious_pair = GetPair(SCREEN_ATTRS(SP_PARM));\n    }\n\n    TR(TRACE_ATTRS, (\"previous attribute was %s, %d\",\n\t\t     _traceattr(previous_attr), previous_pair));\n\n#if !USE_XMC_SUPPORT\n    if ((SP_PARM != 0)\n\t&& (magic_cookie_glitch > 0))\n\tnewmode &= ~(SP_PARM->_xmc_suppress);\n#endif\n\n     \n    if ((color_pair != 0\n\t || fix_pair0)\n\t&& (no_color_video > 0)) {\n\t \n\tunsigned value = (unsigned) no_color_video;\n\tattr_t mask = NCURSES_BITS((value & 63)\n\t\t\t\t   | ((value & 192) << 1)\n\t\t\t\t   | ((value & 256) >> 2), 8);\n\n\tif ((mask & A_REVERSE) != 0\n\t    && (newmode & A_REVERSE) != 0) {\n\t    reverse = TRUE;\n\t    mask &= ~A_REVERSE;\n\t}\n\tnewmode &= ~mask;\n    }\n\n    if (newmode == previous_attr\n\t&& color_pair == previous_pair)\n\treturnCode(OK);\n\n    if (reverse) {\n\tnewmode &= ~A_REVERSE;\n    }\n\n    turn_off = (~newmode & previous_attr) & ALL_BUT_COLOR;\n    turn_on = (newmode & ~(previous_attr & TPARM_ATTR)) & ALL_BUT_COLOR;\n\n    SetColorsIf(((color_pair == 0) && !fix_pair0), previous_attr, previous_pair);\n\n    if (newmode == A_NORMAL) {\n\tif ((previous_attr & A_ALTCHARSET) && exit_alt_charset_mode) {\n\t    doPut(exit_alt_charset_mode);\n\t    previous_attr &= ~A_ALTCHARSET;\n\t}\n\tif (previous_attr) {\n\t    if (exit_attribute_mode) {\n\t\tdoPut(exit_attribute_mode);\n\t    } else {\n\t\tif (!SP_PARM || SP_PARM->_use_rmul) {\n\t\t    TurnOff(A_UNDERLINE, exit_underline_mode);\n\t\t}\n\t\tif (!SP_PARM || SP_PARM->_use_rmso) {\n\t\t    TurnOff(A_STANDOUT, exit_standout_mode);\n\t\t}\n#if USE_ITALIC\n\t\tif (!SP_PARM || SP_PARM->_use_ritm) {\n\t\t    TurnOff(A_ITALIC, exit_italics_mode);\n\t\t}\n#endif\n\t    }\n\t    previous_attr &= ALL_BUT_COLOR;\n\t    previous_pair = 0;\n\t}\n\n\tSetColorsIf((color_pair != 0) || fix_pair0, previous_attr, previous_pair);\n    } else if (set_attributes) {\n\tif (turn_on || turn_off) {\n\t    TPUTS_TRACE(\"set_attributes\");\n\t    NCURSES_SP_NAME(tputs) (NCURSES_SP_ARGx\n\t\t\t\t    TIPARM_9(set_attributes,\n\t\t\t\t\t       (newmode & A_STANDOUT) != 0,\n\t\t\t\t\t       (newmode & A_UNDERLINE) != 0,\n\t\t\t\t\t       (newmode & A_REVERSE) != 0,\n\t\t\t\t\t       (newmode & A_BLINK) != 0,\n\t\t\t\t\t       (newmode & A_DIM) != 0,\n\t\t\t\t\t       (newmode & A_BOLD) != 0,\n\t\t\t\t\t       (newmode & A_INVIS) != 0,\n\t\t\t\t\t       (newmode & A_PROTECT) != 0,\n\t\t\t\t\t       (newmode & A_ALTCHARSET) != 0),\n\t\t\t\t    1, outc);\n\t    previous_attr &= ALL_BUT_COLOR;\n\t    previous_pair = 0;\n\t}\n#if USE_ITALIC\n\tif (!SP_PARM || SP_PARM->_use_ritm) {\n\t    if (turn_on & A_ITALIC) {\n\t\tTurnOn(A_ITALIC, enter_italics_mode);\n\t    } else if (turn_off & A_ITALIC) {\n\t\tTurnOff(A_ITALIC, exit_italics_mode);\n\t    }\n\t}\n#endif\n\tSetColorsIf((color_pair != 0) || fix_pair0, previous_attr, previous_pair);\n    } else {\n\n\tTR(TRACE_ATTRS, (\"turning %s off\", _traceattr(turn_off)));\n\n\tTurnOff(A_ALTCHARSET, exit_alt_charset_mode);\n\n\tif (!SP_PARM || SP_PARM->_use_rmul) {\n\t    TurnOff(A_UNDERLINE, exit_underline_mode);\n\t}\n\n\tif (!SP_PARM || SP_PARM->_use_rmso) {\n\t    TurnOff(A_STANDOUT, exit_standout_mode);\n\t}\n#if USE_ITALIC\n\tif (!SP_PARM || SP_PARM->_use_ritm) {\n\t    TurnOff(A_ITALIC, exit_italics_mode);\n\t}\n#endif\n\tif (turn_off && exit_attribute_mode) {\n\t    doPut(exit_attribute_mode);\n\t    turn_on |= (newmode & ALL_BUT_COLOR);\n\t    previous_attr &= ALL_BUT_COLOR;\n\t    previous_pair = 0;\n\t}\n\tSetColorsIf((color_pair != 0) || fix_pair0, previous_attr, previous_pair);\n\n\tTR(TRACE_ATTRS, (\"turning %s on\", _traceattr(turn_on)));\n\t \n\tTurnOn(A_ALTCHARSET,\tenter_alt_charset_mode);\n\tTurnOn(A_BLINK,\t\tenter_blink_mode);\n\tTurnOn(A_BOLD,\t\tenter_bold_mode);\n\tTurnOn(A_DIM,\t\tenter_dim_mode);\n\tTurnOn(A_REVERSE,\tenter_reverse_mode);\n\tTurnOn(A_STANDOUT,\tenter_standout_mode);\n\tTurnOn(A_PROTECT,\tenter_protected_mode);\n\tTurnOn(A_INVIS,\t\tenter_secure_mode);\n\tTurnOn(A_UNDERLINE,\tenter_underline_mode);\n#if USE_ITALIC\n\tTurnOn(A_ITALIC,\tenter_italics_mode);\n#endif\n#if USE_WIDEC_SUPPORT && defined(enter_horizontal_hl_mode)\n\tTurnOn(A_HORIZONTAL,\tenter_horizontal_hl_mode);\n\tTurnOn(A_LEFT,\t\tenter_left_hl_mode);\n\tTurnOn(A_LOW,\t\tenter_low_hl_mode);\n\tTurnOn(A_RIGHT,\t\tenter_right_hl_mode);\n\tTurnOn(A_TOP,\t\tenter_top_hl_mode);\n\tTurnOn(A_VERTICAL,\tenter_vertical_hl_mode);\n#endif\n\t \n    }\n\n    if (reverse)\n\tnewmode |= A_REVERSE;\n\n    if (SP_PARM) {\n\tSetAttr(SCREEN_ATTRS(SP_PARM), newmode);\n\tSetPair(SCREEN_ATTRS(SP_PARM), color_pair);\n    } else {\n\tprevious_attr = newmode;\n\tprevious_pair = color_pair;\n    }\n\n    returnCode(OK);\n#else\n    T((T_CALLED(\"vid_puts(%s,%d)\"), _traceattr(newmode), color_pair));\n    (void) opts;\n    set_color(newmode, color_pair);\n    returnCode(NCURSES_SP_NAME(vidputs) (NCURSES_SP_ARGx newmode, outc));\n#endif\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(int)\nvid_puts(attr_t newmode,\n\t NCURSES_PAIRS_T pair_arg,\n\t void *opts GCC_UNUSED,\n\t NCURSES_OUTC outc)\n{\n    SetSafeOutcWrapper(outc);\n    return NCURSES_SP_NAME(vid_puts) (CURRENT_SCREEN,\n\t\t\t\t      newmode,\n\t\t\t\t      pair_arg,\n\t\t\t\t      opts,\n\t\t\t\t      _nc_outc_wrapper);\n}\n#endif\n\n#undef vid_attr\nNCURSES_EXPORT(int)\nNCURSES_SP_NAME(vid_attr) (NCURSES_SP_DCLx\n\t\t\t   attr_t newmode,\n\t\t\t   NCURSES_PAIRS_T pair_arg,\n\t\t\t   void *opts)\n{\n    T((T_CALLED(\"vid_attr(%s,%d)\"), _traceattr(newmode), (int) pair_arg));\n    returnCode(NCURSES_SP_NAME(vid_puts) (NCURSES_SP_ARGx\n\t\t\t\t\t  newmode,\n\t\t\t\t\t  pair_arg,\n\t\t\t\t\t  opts,\n\t\t\t\t\t  NCURSES_SP_NAME(_nc_putchar)));\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(int)\nvid_attr(attr_t newmode, NCURSES_PAIRS_T pair_arg, void *opts)\n{\n    return NCURSES_SP_NAME(vid_attr) (CURRENT_SCREEN, newmode, pair_arg, opts);\n}\n#endif\n\n \nNCURSES_EXPORT(attr_t)\nNCURSES_SP_NAME(term_attrs) (NCURSES_SP_DCL0)\n{\n    attr_t attrs = 0;\n\n    T((T_CALLED(\"term_attrs()\")));\n    if (SP_PARM) {\n\tattrs = NCURSES_SP_NAME(termattrs) (NCURSES_SP_ARG);\n\n#if USE_WIDEC_SUPPORT && defined(enter_horizontal_hl_mode)\n\t \n\tif (enter_horizontal_hl_mode)\n\t    attrs |= WA_HORIZONTAL;\n\tif (enter_left_hl_mode)\n\t    attrs |= WA_LEFT;\n\tif (enter_low_hl_mode)\n\t    attrs |= WA_LOW;\n\tif (enter_right_hl_mode)\n\t    attrs |= WA_RIGHT;\n\tif (enter_top_hl_mode)\n\t    attrs |= WA_TOP;\n\tif (enter_vertical_hl_mode)\n\t    attrs |= WA_VERTICAL;\n#endif\n    }\n\n    returnAttr(attrs);\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(attr_t)\nterm_attrs(void)\n{\n    return NCURSES_SP_NAME(term_attrs) (CURRENT_SCREEN);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}