{
  "module_name": "lib_get_wstr.c",
  "hash_id": "b3d2125e356541cc8b5ce8fd3f51c15dbdaa4cb0f0218acca20aa6db7cd4a520",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/widechar/lib_get_wstr.c",
  "human_readable_source": " \n\n \n\n \n\n#include <curses.priv.h>\n\nMODULE_ID(\"$Id: lib_get_wstr.c,v 1.20 2021/10/23 19:02:59 tom Exp $\")\n\nstatic int\nwadd_wint(WINDOW *win, wint_t *src)\n{\n    cchar_t tmp;\n    wchar_t wch[2];\n\n    wch[0] = (wchar_t) (*src);\n    wch[1] = 0;\n    setcchar(&tmp, wch, A_NORMAL, (short) 0, NULL);\n    return wadd_wch(win, &tmp);\n}\n\n \nstatic wint_t *\nWipeOut(WINDOW *win, int y, int x, wint_t *first, wint_t *last, int echoed)\n{\n    if (last > first) {\n\t*--last = '\\0';\n\tif (echoed) {\n\t    int y1 = win->_cury;\n\t    int x1 = win->_curx;\n\t    int n;\n\n\t    wmove(win, y, x);\n\t    for (n = 0; first[n] != 0; ++n) {\n\t\twadd_wint(win, first + n);\n\t    }\n\t    getyx(win, y, x);\n\t    while (win->_cury < y1\n\t\t   || (win->_cury == y1 && win->_curx < x1))\n\t\twaddch(win, (chtype) ' ');\n\n\t    wmove(win, y, x);\n\t}\n    }\n    return last;\n}\n\nNCURSES_EXPORT(int)\nwgetn_wstr(WINDOW *win, wint_t *str, int maxlen)\n{\n    SCREEN *sp = _nc_screen_of(win);\n    TTY buf;\n    bool oldnl, oldecho, oldraw, oldcbreak;\n    wchar_t erasec = 0;\n    wchar_t killc = 0;\n    wint_t *oldstr = str;\n    wint_t *tmpstr = str;\n    wint_t ch;\n    int y, x, code;\n\n    T((T_CALLED(\"wgetn_wstr(%p,%p, %d)\"), (void *) win, (void *) str, maxlen));\n\n    if (!win)\n\treturnCode(ERR);\n\n    maxlen = _nc_getstr_limit(maxlen);\n\n    _nc_get_tty_mode(&buf);\n\n    oldnl = sp->_nl;\n    oldecho = sp->_echo;\n    oldraw = sp->_raw;\n    oldcbreak = sp->_cbreak;\n    NCURSES_SP_NAME(nl) (NCURSES_SP_ARG);\n    NCURSES_SP_NAME(noecho) (NCURSES_SP_ARG);\n    NCURSES_SP_NAME(raw) (NCURSES_SP_ARG);\n\n    NCURSES_SP_NAME(erasewchar) (NCURSES_SP_ARGx &erasec);\n    NCURSES_SP_NAME(killwchar) (NCURSES_SP_ARGx &killc);\n\n    getyx(win, y, x);\n\n    if (is_wintouched(win) || (win->_flags & _HASMOVED))\n\twrefresh(win);\n\n    while ((code = wget_wch(win, &ch)) != ERR) {\n\t \n\tif (ch == '\\r')\n\t    ch = '\\n';\n\tif (ch == '\\n') {\n\t    code = KEY_CODE_YES;\n\t    ch = KEY_ENTER;\n\t}\n\tif (ch != 0 && ch < KEY_MIN) {\n\t    if (ch == (wint_t) erasec) {\n\t\tch = KEY_BACKSPACE;\n\t\tcode = KEY_CODE_YES;\n\t    }\n\t    if (ch == (wint_t) killc) {\n\t\tch = KEY_EOL;\n\t\tcode = KEY_CODE_YES;\n\t    }\n\t}\n\tif (code == KEY_CODE_YES) {\n\t     \n\t    if (ch == KEY_DOWN || ch == KEY_ENTER) {\n\t\tif (oldecho == TRUE\n\t\t    && win->_cury == win->_maxy\n\t\t    && win->_scroll)\n\t\t    wechochar(win, (chtype) '\\n');\n\t\tbreak;\n\t    }\n\t    if (ch == KEY_LEFT || ch == KEY_BACKSPACE) {\n\t\tif (tmpstr > oldstr) {\n\t\t    tmpstr = WipeOut(win, y, x, oldstr, tmpstr, oldecho);\n\t\t}\n\t    } else if (ch == KEY_EOL) {\n\t\twhile (tmpstr > oldstr) {\n\t\t    tmpstr = WipeOut(win, y, x, oldstr, tmpstr, oldecho);\n\t\t}\n\t    } else {\n\t\tbeep();\n\t    }\n\t} else if (tmpstr - oldstr >= maxlen) {\n\t    beep();\n\t} else {\n\t    *tmpstr++ = ch;\n\t    *tmpstr = 0;\n\t    if (oldecho == TRUE) {\n\t\tint oldy = win->_cury;\n\n\t\tif (wadd_wint(win, tmpstr - 1) == ERR) {\n\t\t     \n\t\t    win->_flags &= ~_WRAPPED;\n\t\t    waddch(win, (chtype) ' ');\n\t\t    tmpstr = WipeOut(win, y, x, oldstr, tmpstr, oldecho);\n\t\t    continue;\n\t\t} else if (IS_WRAPPED(win)) {\n\t\t     \n\t\t    if (win->_scroll\n\t\t\t&& oldy == win->_maxy\n\t\t\t&& win->_cury == win->_maxy) {\n\t\t\tif (--y <= 0) {\n\t\t\t    y = 0;\n\t\t\t}\n\t\t    }\n\t\t    win->_flags &= ~_WRAPPED;\n\t\t}\n\t\twrefresh(win);\n\t    }\n\t}\n    }\n\n    win->_curx = 0;\n    win->_flags &= ~_WRAPPED;\n    if (win->_cury < win->_maxy)\n\twin->_cury++;\n    wrefresh(win);\n\n     \n    sp->_nl = oldnl;\n    sp->_echo = oldecho;\n    sp->_raw = oldraw;\n    sp->_cbreak = oldcbreak;\n\n    (void) _nc_set_tty_mode(&buf);\n\n    *tmpstr = 0;\n    if (code == ERR) {\n\tif (tmpstr == oldstr) {\n\t    *tmpstr++ = WEOF;\n\t    *tmpstr = 0;\n\t}\n\treturnCode(ERR);\n    }\n\n    T((\"wgetn_wstr returns %s\", _nc_viswibuf(oldstr)));\n\n    returnCode(OK);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}