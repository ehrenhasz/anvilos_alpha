{
  "module_name": "hardscroll.c",
  "hash_id": "96851a2a1e0280447679e75514a181f970844a78618d4ff0f9ba5c255d3f0b69",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/tty/hardscroll.c",
  "human_readable_source": " \n\n \n\n \n\n#include <curses.priv.h>\n\nMODULE_ID(\"$Id: hardscroll.c,v 1.54 2020/02/02 23:34:34 tom Exp $\")\n\n#if defined(SCROLLDEBUG) || defined(HASHDEBUG)\n\n# undef screen_lines\n# define screen_lines(sp) MAXLINES\nNCURSES_EXPORT_VAR (int)\n  oldnums[MAXLINES];\n# define OLDNUM(sp,n)\toldnums[n]\n# define _tracef\tprintf\n# undef TR\n# define TR(n, a)\tif (_nc_tracing & (n)) { _tracef a ; putchar('\\n'); }\n\nextern\t\t\t\tNCURSES_EXPORT_VAR(unsigned) _nc_tracing;\n\n#else  \n\n \nNCURSES_EXPORT_VAR (int *)\n  _nc_oldnums = 0;\t\t \n\n# if USE_HASHMAP\n#  define oldnums(sp)   (sp)->_oldnum_list\n#  define OLDNUM(sp,n)\toldnums(sp)[n]\n# else  \n#  define OLDNUM(sp,n)\tNewScreen(sp)->_line[n].oldindex\n# endif\t \n\n#define OLDNUM_SIZE(sp) (sp)->_oldnum_size\n\n#endif  \n\nNCURSES_EXPORT(void)\nNCURSES_SP_NAME(_nc_scroll_optimize) (NCURSES_SP_DCL0)\n \n{\n    int i;\n    int start, end, shift;\n\n    TR(TRACE_ICALLS, (T_CALLED(\"_nc_scroll_optimize(%p)\"), (void *) SP_PARM));\n\n#if !defined(SCROLLDEBUG) && !defined(HASHDEBUG)\n#if USE_HASHMAP\n     \n    assert(OLDNUM_SIZE(SP_PARM) >= 0);\n    assert(screen_lines(SP_PARM) > 0);\n    if ((oldnums(SP_PARM) == 0)\n\t|| (OLDNUM_SIZE(SP_PARM) < screen_lines(SP_PARM))) {\n\tint need_lines = ((OLDNUM_SIZE(SP_PARM) < screen_lines(SP_PARM))\n\t\t\t  ? screen_lines(SP_PARM)\n\t\t\t  : OLDNUM_SIZE(SP_PARM));\n\tint *new_oldnums = typeRealloc(int,\n\t\t\t\t       (size_t) need_lines,\n\t\t\t\t       oldnums(SP_PARM));\n\tif (!new_oldnums)\n\t    return;\n\toldnums(SP_PARM) = new_oldnums;\n\tOLDNUM_SIZE(SP_PARM) = need_lines;\n    }\n     \n    NCURSES_SP_NAME(_nc_hash_map) (NCURSES_SP_ARG);\n#endif\n#endif  \n\n#ifdef TRACE\n    if (USE_TRACEF(TRACE_UPDATE | TRACE_MOVE)) {\n\tNCURSES_SP_NAME(_nc_linedump) (NCURSES_SP_ARG);\n\t_nc_unlock_global(tracef);\n    }\n#endif  \n\n     \n    for (i = 0; i < screen_lines(SP_PARM);) {\n\twhile (i < screen_lines(SP_PARM)\n\t       && (OLDNUM(SP_PARM, i) == _NEWINDEX || OLDNUM(SP_PARM, i) <= i))\n\t    i++;\n\tif (i >= screen_lines(SP_PARM))\n\t    break;\n\n\tshift = OLDNUM(SP_PARM, i) - i;\t\t \n\tstart = i;\n\n\ti++;\n\twhile (i < screen_lines(SP_PARM)\n\t       && OLDNUM(SP_PARM, i) != _NEWINDEX\n\t       && OLDNUM(SP_PARM, i) - i == shift)\n\t    i++;\n\tend = i - 1 + shift;\n\n\tTR(TRACE_UPDATE | TRACE_MOVE, (\"scroll [%d, %d] by %d\", start, end, shift));\n#if !defined(SCROLLDEBUG) && !defined(HASHDEBUG)\n\tif (NCURSES_SP_NAME(_nc_scrolln) (NCURSES_SP_ARGx\n\t\t\t\t\t  shift,\n\t\t\t\t\t  start,\n\t\t\t\t\t  end,\n\t\t\t\t\t  screen_lines(SP_PARM) - 1) == ERR) {\n\t    TR(TRACE_UPDATE | TRACE_MOVE, (\"unable to scroll\"));\n\t    continue;\n\t}\n#endif  \n    }\n\n     \n    for (i = screen_lines(SP_PARM) - 1; i >= 0;) {\n\twhile (i >= 0\n\t       && (OLDNUM(SP_PARM, i) == _NEWINDEX\n\t\t   || OLDNUM(SP_PARM, i) >= i)) {\n\t    i--;\n\t}\n\tif (i < 0)\n\t    break;\n\n\tshift = OLDNUM(SP_PARM, i) - i;\t\t \n\tend = i;\n\n\ti--;\n\twhile (i >= 0\n\t       && OLDNUM(SP_PARM, i) != _NEWINDEX\n\t       && OLDNUM(SP_PARM, i) - i == shift) {\n\t    i--;\n\t}\n\tstart = i + 1 - (-shift);\n\n\tTR(TRACE_UPDATE | TRACE_MOVE, (\"scroll [%d, %d] by %d\", start, end, shift));\n#if !defined(SCROLLDEBUG) && !defined(HASHDEBUG)\n\tif (NCURSES_SP_NAME(_nc_scrolln) (NCURSES_SP_ARGx\n\t\t\t\t\t  shift,\n\t\t\t\t\t  start,\n\t\t\t\t\t  end,\n\t\t\t\t\t  screen_lines(SP_PARM) - 1) == ERR) {\n\t    TR(TRACE_UPDATE | TRACE_MOVE, (\"unable to scroll\"));\n\t    continue;\n\t}\n#endif  \n    }\n    TR(TRACE_ICALLS, (T_RETURN(\"\")));\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(void)\n_nc_scroll_optimize(void)\n{\n    NCURSES_SP_NAME(_nc_scroll_optimize) (CURRENT_SCREEN);\n}\n#endif\n\n#if defined(TRACE) || defined(SCROLLDEBUG) || defined(HASHDEBUG)\nNCURSES_EXPORT(void)\nNCURSES_SP_NAME(_nc_linedump) (NCURSES_SP_DCL0)\n \n{\n    char *buf = 0;\n    size_t want = ((size_t) screen_lines(SP_PARM) + 1) * 4;\n    (void) SP_PARM;\n\n    if ((buf = typeMalloc(char, want)) != 0) {\n\tint n;\n\n\t*buf = '\\0';\n\tfor (n = 0; n < screen_lines(SP_PARM); n++)\n\t    _nc_SPRINTF(buf + strlen(buf),\n\t\t\t_nc_SLIMIT(want - strlen(buf))\n\t\t\t\" %02d\", OLDNUM(SP_PARM, n));\n\tTR(TRACE_UPDATE | TRACE_MOVE, (\"virt %s\", buf));\n\tfree(buf);\n    }\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(void)\n_nc_linedump(void)\n{\n    NCURSES_SP_NAME(_nc_linedump) (CURRENT_SCREEN);\n}\n#endif\n\n#endif  \n\n#ifdef SCROLLDEBUG\n\nint\nmain(int argc GCC_UNUSED, char *argv[]GCC_UNUSED)\n{\n    char line[BUFSIZ], *st;\n\n#ifdef TRACE\n    _nc_tracing = TRACE_MOVE;\n#endif\n    for (;;) {\n\tint n;\n\n\tfor (n = 0; n < screen_lines(sp); n++)\n\t    oldnums[n] = _NEWINDEX;\n\n\t \n\tif (fgets(line, sizeof(line), stdin) == (char *) NULL)\n\t    exit(EXIT_SUCCESS);\n\n\t \n\tn = 0;\n\tif (line[0] == '#') {\n\t    (void) fputs(line, stderr);\n\t    continue;\n\t}\n\tst = strtok(line, \" \");\n\tdo {\n\t    oldnums[n++] = atoi(st);\n\t} while\n\t    ((st = strtok((char *) NULL, \" \")) != 0);\n\n\t \n\t(void) fputs(\"Initial input:\\n\", stderr);\n\t_nc_linedump();\n\n\t_nc_scroll_optimize();\n    }\n}\n\n#endif  \n\n \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}