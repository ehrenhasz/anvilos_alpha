{
  "module_name": "lib_vidattr.c",
  "hash_id": "e731b67ab5f412b112a217b31165005e4630abb933a22f06b48b68c71bc312e4",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/tty/lib_vidattr.c",
  "human_readable_source": " \n\n \n\n \n\n#include <curses.priv.h>\n\n#ifndef CUR\n#define CUR SP_TERMTYPE\n#endif\n\nMODULE_ID(\"$Id: lib_vidattr.c,v 1.78 2020/05/27 23:56:32 tom Exp $\")\n\n#define doPut(mode) \\\n\tTPUTS_TRACE(#mode); \\\n\tNCURSES_SP_NAME(tputs) (NCURSES_SP_ARGx mode, 1, outc)\n\n#define TurnOn(mask, mode) \\\n\tif ((turn_on & mask) && mode) { \\\n\t    TPUTS_TRACE(#mode); \\\n\t    NCURSES_SP_NAME(tputs) (NCURSES_SP_ARGx mode, 1, outc); \\\n\t}\n\n#define TurnOff(mask, mode) \\\n\tif ((turn_off & mask) && mode) { \\\n\t    TPUTS_TRACE(#mode); \\\n\t    NCURSES_SP_NAME(tputs) (NCURSES_SP_ARGx mode, 1, outc); \\\n\t    turn_off &= ~mask; \\\n\t}\n\n\t \n#define SetColorsIf(why, old_attr) \\\n\tif (can_color && (why)) { \\\n\t\tint old_pair = PairNumber(old_attr); \\\n\t\tTR(TRACE_ATTRS, (\"old pair = %d -- new pair = %d\", old_pair, pair)); \\\n\t\tif ((pair != old_pair) \\\n\t\t || (fix_pair0 && (pair == 0)) \\\n\t\t || (reverse ^ ((old_attr & A_REVERSE) != 0))) { \\\n\t\t     NCURSES_SP_NAME(_nc_do_color) (NCURSES_SP_ARGx \\\n\t\t\t\t     (short) old_pair, \\\n\t\t\t\t     (short) pair, \\\n\t\t\t\t     reverse, outc); \\\n\t\t} \\\n\t}\n\n#define PreviousAttr _nc_prescreen.previous_attr\n\nNCURSES_EXPORT(int)\nNCURSES_SP_NAME(vidputs) (NCURSES_SP_DCLx\n\t\t\t  chtype newmode,\n\t\t\t  NCURSES_SP_OUTC outc)\n{\n    attr_t turn_on, turn_off;\n    int pair;\n    bool reverse = FALSE;\n    bool can_color = (SP_PARM == 0 || SP_PARM->_coloron);\n#if NCURSES_EXT_FUNCS\n    bool fix_pair0 = (SP_PARM != 0 && SP_PARM->_coloron && !SP_PARM->_default_color);\n#else\n#define fix_pair0 FALSE\n#endif\n\n    newmode &= A_ATTRIBUTES;\n\n    T((T_CALLED(\"vidputs(%p,%s)\"), (void *) SP_PARM, _traceattr(newmode)));\n\n    if (!IsValidTIScreen(SP_PARM))\n\treturnCode(ERR);\n\n     \n    if (SP_PARM)\n\tPreviousAttr = AttrOf(SCREEN_ATTRS(SP_PARM));\n\n    TR(TRACE_ATTRS, (\"previous attribute was %s\", _traceattr(PreviousAttr)));\n\n    if ((SP_PARM != 0)\n\t&& (magic_cookie_glitch > 0)) {\n#if USE_XMC_SUPPORT\n\tstatic const chtype table[] =\n\t{\n\t    A_STANDOUT,\n\t    A_UNDERLINE,\n\t    A_REVERSE,\n\t    A_BLINK,\n\t    A_DIM,\n\t    A_BOLD,\n\t    A_INVIS,\n\t    A_PROTECT,\n#if USE_ITALIC\n\t    A_ITALIC,\n#endif\n\t};\n\tunsigned n;\n\tint used = 0;\n#ifdef max_attributes\t\t \n\tint limit = (max_attributes <= 0) ? 1 : max_attributes;\n#else\n\tint limit = 1;\n#endif\n\tchtype retain = 0;\n\n\t \n\tfor (n = 0; n < SIZEOF(table); ++n) {\n\t    if ((table[n] & SP_PARM->_ok_attributes) == 0) {\n\t\tnewmode &= ~table[n];\n\t    } else if ((table[n] & newmode) != 0) {\n\t\tif (used++ >= limit) {\n\t\t    newmode &= ~table[n];\n\t\t    if (newmode == retain)\n\t\t\tbreak;\n\t\t} else {\n\t\t    retain = newmode;\n\t\t}\n\t    }\n\t}\n#else\n\tnewmode &= ~(SP_PARM->_xmc_suppress);\n#endif\n\tTR(TRACE_ATTRS, (\"suppressed attribute is %s\", _traceattr(newmode)));\n    }\n\n     \n    if (((newmode & A_COLOR) != 0\n\t || fix_pair0)\n\t&& (no_color_video > 0)) {\n\t \n\tunsigned value = (unsigned) no_color_video;\n\tattr_t mask = NCURSES_BITS((value & 63)\n\t\t\t\t   | ((value & 192) << 1)\n\t\t\t\t   | ((value & 256) >> 2), 8);\n\n\tif ((mask & A_REVERSE) != 0\n\t    && (newmode & A_REVERSE) != 0) {\n\t    reverse = TRUE;\n\t    mask &= ~A_REVERSE;\n\t}\n\tnewmode &= ~mask;\n    }\n\n    if (newmode == PreviousAttr)\n\treturnCode(OK);\n\n    pair = PairNumber(newmode);\n\n    if (reverse) {\n\tnewmode &= ~A_REVERSE;\n    }\n\n    turn_off = (~newmode & PreviousAttr) & ALL_BUT_COLOR;\n    turn_on = (newmode & ~(PreviousAttr & TPARM_ATTR)) & ALL_BUT_COLOR;\n\n    SetColorsIf(((pair == 0) && !fix_pair0), PreviousAttr);\n\n    if (newmode == A_NORMAL) {\n\tif ((PreviousAttr & A_ALTCHARSET) && exit_alt_charset_mode) {\n\t    doPut(exit_alt_charset_mode);\n\t    PreviousAttr &= ~A_ALTCHARSET;\n\t}\n\tif (PreviousAttr) {\n\t    if (exit_attribute_mode) {\n\t\tdoPut(exit_attribute_mode);\n\t    } else {\n\t\tif (!SP_PARM || SP_PARM->_use_rmul) {\n\t\t    TurnOff(A_UNDERLINE, exit_underline_mode);\n\t\t}\n\t\tif (!SP_PARM || SP_PARM->_use_rmso) {\n\t\t    TurnOff(A_STANDOUT, exit_standout_mode);\n\t\t}\n#if USE_ITALIC\n\t\tif (!SP_PARM || SP_PARM->_use_ritm) {\n\t\t    TurnOff(A_ITALIC, exit_italics_mode);\n\t\t}\n#endif\n\t    }\n\t    PreviousAttr &= ALL_BUT_COLOR;\n\t}\n\n\tSetColorsIf((pair != 0) || fix_pair0, PreviousAttr);\n    } else if (set_attributes) {\n\tif (turn_on || turn_off) {\n\t    TPUTS_TRACE(\"set_attributes\");\n\t    NCURSES_SP_NAME(tputs) (NCURSES_SP_ARGx\n\t\t\t\t    TIPARM_9(set_attributes,\n\t\t\t\t\t     (newmode & A_STANDOUT) != 0,\n\t\t\t\t\t     (newmode & A_UNDERLINE) != 0,\n\t\t\t\t\t     (newmode & A_REVERSE) != 0,\n\t\t\t\t\t     (newmode & A_BLINK) != 0,\n\t\t\t\t\t     (newmode & A_DIM) != 0,\n\t\t\t\t\t     (newmode & A_BOLD) != 0,\n\t\t\t\t\t     (newmode & A_INVIS) != 0,\n\t\t\t\t\t     (newmode & A_PROTECT) != 0,\n\t\t\t\t\t     (newmode & A_ALTCHARSET) != 0),\n\t\t\t\t    1, outc);\n\t    PreviousAttr &= ALL_BUT_COLOR;\n\t}\n#if USE_ITALIC\n\tif (!SP_PARM || SP_PARM->_use_ritm) {\n\t    if (turn_on & A_ITALIC) {\n\t\tTurnOn(A_ITALIC, enter_italics_mode);\n\t    } else if (turn_off & A_ITALIC) {\n\t\tTurnOff(A_ITALIC, exit_italics_mode);\n\t    }\n\t}\n#endif\n\tSetColorsIf((pair != 0) || fix_pair0, PreviousAttr);\n    } else {\n\n\tTR(TRACE_ATTRS, (\"turning %s off\", _traceattr(turn_off)));\n\n\tTurnOff(A_ALTCHARSET, exit_alt_charset_mode);\n\n\tif (!SP_PARM || SP_PARM->_use_rmul) {\n\t    TurnOff(A_UNDERLINE, exit_underline_mode);\n\t}\n\n\tif (!SP_PARM || SP_PARM->_use_rmso) {\n\t    TurnOff(A_STANDOUT, exit_standout_mode);\n\t}\n#if USE_ITALIC\n\tif (!SP_PARM || SP_PARM->_use_ritm) {\n\t    TurnOff(A_ITALIC, exit_italics_mode);\n\t}\n#endif\n\tif (turn_off && exit_attribute_mode) {\n\t    doPut(exit_attribute_mode);\n\t    turn_on |= (newmode & ALL_BUT_COLOR);\n\t    PreviousAttr &= ALL_BUT_COLOR;\n\t}\n\tSetColorsIf((pair != 0) || fix_pair0, PreviousAttr);\n\n\tTR(TRACE_ATTRS, (\"turning %s on\", _traceattr(turn_on)));\n\t \n\tTurnOn(A_ALTCHARSET,\tenter_alt_charset_mode);\n\tTurnOn(A_BLINK,\t\tenter_blink_mode);\n\tTurnOn(A_BOLD,\t\tenter_bold_mode);\n\tTurnOn(A_DIM,\t\tenter_dim_mode);\n\tTurnOn(A_REVERSE,\tenter_reverse_mode);\n\tTurnOn(A_STANDOUT,\tenter_standout_mode);\n\tTurnOn(A_PROTECT,\tenter_protected_mode);\n\tTurnOn(A_INVIS,\t\tenter_secure_mode);\n\tTurnOn(A_UNDERLINE,\tenter_underline_mode);\n#if USE_ITALIC\n\tTurnOn(A_ITALIC,\tenter_italics_mode);\n#endif\n#if USE_WIDEC_SUPPORT && defined(enter_horizontal_hl_mode)\n\tTurnOn(A_HORIZONTAL,\tenter_horizontal_hl_mode);\n\tTurnOn(A_LEFT,\t\tenter_left_hl_mode);\n\tTurnOn(A_LOW,\t\tenter_low_hl_mode);\n\tTurnOn(A_RIGHT,\t\tenter_right_hl_mode);\n\tTurnOn(A_TOP,\t\tenter_top_hl_mode);\n\tTurnOn(A_VERTICAL,\tenter_vertical_hl_mode);\n#endif\n\t \n    }\n\n    if (reverse)\n\tnewmode |= A_REVERSE;\n\n    if (SP_PARM)\n\tSetAttr(SCREEN_ATTRS(SP_PARM), newmode);\n    else\n\tPreviousAttr = newmode;\n\n    returnCode(OK);\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(int)\nvidputs(chtype newmode, NCURSES_OUTC outc)\n{\n    SetSafeOutcWrapper(outc);\n    return NCURSES_SP_NAME(vidputs) (CURRENT_SCREEN,\n\t\t\t\t     newmode,\n\t\t\t\t     _nc_outc_wrapper);\n}\n#endif\n\nNCURSES_EXPORT(int)\nNCURSES_SP_NAME(vidattr) (NCURSES_SP_DCLx chtype newmode)\n{\n    T((T_CALLED(\"vidattr(%p,%s)\"), (void *) SP_PARM, _traceattr(newmode)));\n    returnCode(NCURSES_SP_NAME(vidputs) (NCURSES_SP_ARGx\n\t\t\t\t\t newmode,\n\t\t\t\t\t NCURSES_SP_NAME(_nc_putchar)));\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(int)\nvidattr(chtype newmode)\n{\n    return NCURSES_SP_NAME(vidattr) (CURRENT_SCREEN, newmode);\n}\n#endif\n\nNCURSES_EXPORT(chtype)\nNCURSES_SP_NAME(termattrs) (NCURSES_SP_DCL0)\n{\n    chtype attrs = A_NORMAL;\n\n    T((T_CALLED(\"termattrs(%p)\"), (void *) SP_PARM));\n\n    if (HasTerminal(SP_PARM)) {\n#ifdef USE_TERM_DRIVER\n\tattrs = CallDriver(SP_PARM, td_conattr);\n#else  \n\n\tif (enter_alt_charset_mode)\n\t    attrs |= A_ALTCHARSET;\n\n\tif (enter_blink_mode)\n\t    attrs |= A_BLINK;\n\n\tif (enter_bold_mode)\n\t    attrs |= A_BOLD;\n\n\tif (enter_dim_mode)\n\t    attrs |= A_DIM;\n\n\tif (enter_reverse_mode)\n\t    attrs |= A_REVERSE;\n\n\tif (enter_standout_mode)\n\t    attrs |= A_STANDOUT;\n\n\tif (enter_protected_mode)\n\t    attrs |= A_PROTECT;\n\n\tif (enter_secure_mode)\n\t    attrs |= A_INVIS;\n\n\tif (enter_underline_mode)\n\t    attrs |= A_UNDERLINE;\n\n\tif (SP_PARM->_coloron)\n\t    attrs |= A_COLOR;\n\n#if USE_ITALIC\n\tif (enter_italics_mode)\n\t    attrs |= A_ITALIC;\n#endif\n\n#endif  \n    }\n    returnChtype(attrs);\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(chtype)\ntermattrs(void)\n{\n    return NCURSES_SP_NAME(termattrs) (CURRENT_SCREEN);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}