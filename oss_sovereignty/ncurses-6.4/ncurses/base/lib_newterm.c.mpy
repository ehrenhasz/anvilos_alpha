{
  "module_name": "lib_newterm.c",
  "hash_id": "33a6ea94999e9d11368a2144a540b2bdf24db6074513e807f630e72912d8e5c0",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/base/lib_newterm.c",
  "human_readable_source": " \n\n \n\n \n\n#include <curses.priv.h>\n\n#ifndef CUR\n#define CUR SP_TERMTYPE\n#endif\n\n#include <tic.h>\n\nMODULE_ID(\"$Id: lib_newterm.c,v 1.104 2022/07/09 18:58:58 tom Exp $\")\n\n#ifdef USE_TERM_DRIVER\n#define NumLabels      InfoOf(SP_PARM).numlabels\n#else\n#define NumLabels      num_labels\n#endif\n\n#ifndef ONLCR\t\t\t \n#define ONLCR 0\n#endif\n\n \nstatic NCURSES_INLINE int\n_nc_initscr(NCURSES_SP_DCL0)\n{\n    int result = ERR;\n    TERMINAL *term = TerminalOf(SP_PARM);\n\n     \n     \n    T((T_CALLED(\"_nc_initscr(%p) ->term %p\"), (void *) SP_PARM, (void *) term));\n    if (NCURSES_SP_NAME(cbreak) (NCURSES_SP_ARG) == OK) {\n\tTTY buf;\n\n\tbuf = term->Nttyb;\n#ifdef TERMIOS\n\tbuf.c_lflag &= (unsigned) ~(ECHO | ECHONL);\n\tbuf.c_iflag &= (unsigned) ~(ICRNL | INLCR | IGNCR);\n\tbuf.c_oflag &= (unsigned) ~(ONLCR);\n#elif HAVE_SGTTY_H\n\tbuf.sg_flags &= ~(ECHO | CRMOD);\n#elif defined(EXP_WIN32_DRIVER)\n\tbuf.dwFlagIn = CONMODE_IN_DEFAULT;\n\tbuf.dwFlagOut = CONMODE_OUT_DEFAULT | VT_FLAG_OUT;\n\tif (WINCONSOLE.isTermInfoConsole) {\n\t    buf.dwFlagIn |= VT_FLAG_IN;\n\t}\n#else\n\tmemset(&buf, 0, sizeof(buf));\n#endif\n\tresult = NCURSES_SP_NAME(_nc_set_tty_mode) (NCURSES_SP_ARGx &buf);\n\tif (result == OK)\n\t    term->Nttyb = buf;\n    }\n    returnCode(result);\n}\n\n \nNCURSES_EXPORT(void)\nNCURSES_SP_NAME(filter) (NCURSES_SP_DCL0)\n{\n    START_TRACE();\n    T((T_CALLED(\"filter(%p)\"), (void *) SP_PARM));\n#if NCURSES_SP_FUNCS\n    if (IsPreScreen(SP_PARM)) {\n\tSP_PARM->_filtered = TRUE;\n    }\n#else\n    _nc_prescreen.filter_mode = TRUE;\n#endif\n    returnVoid;\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(void)\nfilter(void)\n{\n    START_TRACE();\n    T((T_CALLED(\"filter()\")));\n    _nc_prescreen.filter_mode = TRUE;\n    returnVoid;\n}\n#endif\n\n#if NCURSES_EXT_FUNCS\n \nNCURSES_EXPORT(void)\nNCURSES_SP_NAME(nofilter) (NCURSES_SP_DCL0)\n{\n    START_TRACE();\n    T((T_CALLED(\"nofilter(%p)\"), (void *) SP_PARM));\n#if NCURSES_SP_FUNCS\n    if (IsPreScreen(SP_PARM)) {\n\tSP_PARM->_filtered = FALSE;\n    }\n#else\n    _nc_prescreen.filter_mode = FALSE;\n#endif\n    returnVoid;\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(void)\nnofilter(void)\n{\n    START_TRACE();\n    T((T_CALLED(\"nofilter()\")));\n    _nc_prescreen.filter_mode = FALSE;\n    returnVoid;\n}\n#endif\n#endif  \n\nNCURSES_EXPORT(SCREEN *)\nNCURSES_SP_NAME(newterm) (NCURSES_SP_DCLx\n\t\t\t  const char *name,\n\t\t\t  FILE *ofp,\n\t\t\t  FILE *ifp)\n{\n    int errret;\n    SCREEN *result = 0;\n    SCREEN *current;\n    TERMINAL *its_term;\n    FILE *_ofp = ofp ? ofp : stdout;\n    FILE *_ifp = ifp ? ifp : stdin;\n    TERMINAL *new_term = 0;\n\n    START_TRACE();\n    T((T_CALLED(\"newterm(%p, \\\"%s\\\", %p,%p)\"),\n       (void *) SP_PARM,\n       (name ? name : \"\"),\n       (void *) ofp,\n       (void *) ifp));\n\n#if NCURSES_SP_FUNCS\n    assert(SP_PARM != 0);\n    if (SP_PARM == 0)\n\treturnSP(SP_PARM);\n#endif\n\n    _nc_init_pthreads();\n    _nc_lock_global(curses);\n\n    current = CURRENT_SCREEN;\n    its_term = (current ? current->_term : 0);\n\n#if defined(EXP_WIN32_DRIVER)\n    _setmode(fileno(_ifp), _O_BINARY);\n    _setmode(fileno(_ofp), _O_BINARY);\n#endif\n\n    INIT_TERM_DRIVER();\n     \n    if (\n\t   TINFO_SETUP_TERM(&new_term, name,\n\t\t\t    fileno(_ofp), &errret, FALSE) != ERR) {\n\tint slk_format;\n\tint filter_mode;\n\n\t_nc_set_screen(0);\n#ifdef USE_TERM_DRIVER\n\tassert(new_term != 0);\n#endif\n\n#if NCURSES_SP_FUNCS\n\tslk_format = SP_PARM->slk_format;\n\tfilter_mode = SP_PARM->_filtered;\n#else\n\tslk_format = _nc_globals.slk_format;\n\tfilter_mode = _nc_prescreen.filter_mode;\n#endif\n\n\t \n\tif (NCURSES_SP_NAME(_nc_setupscreen) (\n#if NCURSES_SP_FUNCS\n\t\t\t\t\t\t &SP_PARM,\n#endif\n\t\t\t\t\t\t *(ptrLines(SP_PARM)),\n\t\t\t\t\t\t *(ptrCols(SP_PARM)),\n\t\t\t\t\t\t _ofp,\n\t\t\t\t\t\t filter_mode,\n\t\t\t\t\t\t slk_format) == ERR) {\n\t    _nc_set_screen(current);\n\t    result = 0;\n\t} else {\n\t    int value;\n\t    int cols;\n\n#ifdef USE_TERM_DRIVER\n\t    TERMINAL_CONTROL_BLOCK *TCB;\n#elif !NCURSES_SP_FUNCS\n\t    _nc_set_screen(CURRENT_SCREEN);\n#endif\n\t    assert(SP_PARM != 0);\n\t    cols = *(ptrCols(SP_PARM));\n#ifdef USE_TERM_DRIVER\n\t    _nc_set_screen(SP_PARM);\n\t    TCB = (TERMINAL_CONTROL_BLOCK *) new_term;\n\t    TCB->csp = SP_PARM;\n#endif\n\t     \n\t    if (current)\n\t\tcurrent->_term = its_term;\n\n#ifdef USE_TERM_DRIVER\n\t    SP_PARM->_term = new_term;\n#else\n\t    new_term = SP_PARM->_term;\n#endif\n\n\t     \n\t    if ((value = _nc_getenv_num(\"ESCDELAY\")) >= 0) {\n#if NCURSES_EXT_FUNCS\n\t\tNCURSES_SP_NAME(set_escdelay) (NCURSES_SP_ARGx value);\n#else\n\t\tESCDELAY = value;\n#endif\n\t    }\n\n\t     \n\t    if (slk_format && NumLabels > 0 && SLK_STDFMT(slk_format))\n\t\t_nc_slk_initialize(StdScreen(SP_PARM), cols);\n\n\t    SP_PARM->_ifd = fileno(_ifp);\n\t    NCURSES_SP_NAME(typeahead) (NCURSES_SP_ARGx fileno(_ifp));\n#ifdef TERMIOS\n\t    SP_PARM->_use_meta = ((new_term->Ottyb.c_cflag & CSIZE) == CS8 &&\n\t\t\t\t  !(new_term->Ottyb.c_iflag & ISTRIP)) ||\n\t\tUSE_KLIBC_KBD;\n#else\n\t    SP_PARM->_use_meta = FALSE;\n#endif\n\t    SP_PARM->_endwin = ewInitial;\n#ifndef USE_TERM_DRIVER\n\t     \n\t    SP_PARM->_scrolling = ((scroll_forward && scroll_reverse) ||\n\t\t\t\t   ((parm_rindex ||\n\t\t\t\t     parm_insert_line ||\n\t\t\t\t     insert_line) &&\n\t\t\t\t    (parm_index ||\n\t\t\t\t     parm_delete_line ||\n\t\t\t\t     delete_line)));\n#endif\n\n\t    NCURSES_SP_NAME(baudrate) (NCURSES_SP_ARG);\t\t \n\n\t    SP_PARM->_keytry = 0;\n\n\t     \n#ifdef USE_TERM_DRIVER\n\t    TCBOf(SP_PARM)->drv->td_scinit(SP_PARM);\n#else  \n\t     \n#define SGR0_TEST(mode) (mode != 0) && (exit_attribute_mode == 0 || strcmp(mode, exit_attribute_mode))\n\t    SP_PARM->_use_rmso = SGR0_TEST(exit_standout_mode);\n\t    SP_PARM->_use_rmul = SGR0_TEST(exit_underline_mode);\n#if USE_ITALIC\n\t    SP_PARM->_use_ritm = SGR0_TEST(exit_italics_mode);\n#endif\n\n\t     \n\t    _nc_mvcur_init();\n\n\t     \n\t    _nc_screen_init();\n#endif  \n\n\t     \n\t    _nc_initscr(NCURSES_SP_ARG);\n\n\t    _nc_signal_handler(TRUE);\n\t    result = SP_PARM;\n\t}\n    }\n    _nc_unlock_global(curses);\n    returnSP(result);\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(SCREEN *)\nnewterm(const char *name, FILE *ofp, FILE *ifp)\n{\n    SCREEN *rc;\n\n    _nc_init_pthreads();\n    _nc_lock_global(prescreen);\n    START_TRACE();\n    rc = NCURSES_SP_NAME(newterm) (CURRENT_SCREEN_PRE, name, ofp, ifp);\n    _nc_forget_prescr();\n    _nc_unlock_global(prescreen);\n\n    return rc;\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}