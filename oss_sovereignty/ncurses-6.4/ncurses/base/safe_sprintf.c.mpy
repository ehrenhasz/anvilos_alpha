{
  "module_name": "safe_sprintf.c",
  "hash_id": "c583482400d68889bb68cf782efc186ff687b3f40526d7679c9e6f57cfa1f75a",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/base/safe_sprintf.c",
  "human_readable_source": " \n\n \n\n#include <curses.priv.h>\n#include <ctype.h>\n\nMODULE_ID(\"$Id: safe_sprintf.c,v 1.35 2021/10/03 00:25:09 tom Exp $\")\n\n#if USE_SAFE_SPRINTF\n\ntypedef enum {\n    Flags, Width, Prec, Type, Format\n} PRINTF;\n\n#define VA_INTGR(type) ival = (int) va_arg(ap, type)\n#define VA_FLOAT(type) fval = va_arg(ap, type)\n#define VA_POINT(type) pval = (void *)va_arg(ap, type)\n\n \nstatic int\n_nc_printf_length(const char *fmt, va_list ap)\n{\n    size_t length = BUFSIZ;\n    char *buffer;\n    char *format;\n    int len = 0;\n    size_t fmt_len;\n    char fmt_arg[BUFSIZ];\n\n    if (fmt == 0 || *fmt == '\\0')\n\treturn 0;\n    fmt_len = strlen(fmt) + 1;\n    if ((format = typeMalloc(char, fmt_len)) == 0)\n\t  return -1;\n    if ((buffer = typeMalloc(char, length)) == 0) {\n\tfree(format);\n\treturn -1;\n    }\n\n    while (*fmt != '\\0') {\n\tif (*fmt == '%') {\n\t    static char dummy[] = \"\";\n\t    PRINTF state = Flags;\n\t    char *pval = dummy;\t \n\t    double fval = 0.0;\n\t    int done = FALSE;\n\t    int ival = 0;\n\t    int prec = -1;\n\t    int type = 0;\n\t    int used = 0;\n\t    int width = -1;\n\t    size_t f = 0;\n\n\t    format[f++] = *fmt;\n\t    while (*++fmt != '\\0' && len >= 0 && !done) {\n\t\tformat[f++] = *fmt;\n\n\t\tif (isdigit(UChar(*fmt))) {\n\t\t    int num = *fmt - '0';\n\t\t    if (state == Flags && num != 0)\n\t\t\tstate = Width;\n\t\t    if (state == Width) {\n\t\t\tif (width < 0)\n\t\t\t    width = 0;\n\t\t\twidth = (width * 10) + num;\n\t\t    } else if (state == Prec) {\n\t\t\tif (prec < 0)\n\t\t\t    prec = 0;\n\t\t\tprec = (prec * 10) + num;\n\t\t    }\n\t\t} else if (*fmt == '*') {\n\t\t    VA_INTGR(int);\n\t\t    if (state == Flags)\n\t\t\tstate = Width;\n\t\t    if (state == Width) {\n\t\t\twidth = ival;\n\t\t    } else if (state == Prec) {\n\t\t\tprec = ival;\n\t\t    }\n\t\t    _nc_SPRINTF(fmt_arg,\n\t\t\t\t_nc_SLIMIT(sizeof(fmt_arg))\n\t\t\t\t\"%d\", ival);\n\t\t    fmt_len += strlen(fmt_arg);\n\t\t    if ((format = _nc_doalloc(format, fmt_len)) == 0) {\n\t\t\tfree(buffer);\n\t\t\treturn -1;\n\t\t    }\n\t\t    --f;\n\t\t    _nc_STRCPY(&format[f], fmt_arg, fmt_len - f);\n\t\t    f = strlen(format);\n\t\t} else if (isalpha(UChar(*fmt))) {\n\t\t    done = TRUE;\n\t\t    switch (*fmt) {\n\t\t    case 'Z':\t \n\t\t    case 'h':\t \n\t\t    case 'l':\t \n\t\t\tdone = FALSE;\n\t\t\ttype = *fmt;\n\t\t\tbreak;\n\t\t    case 'i':\t \n\t\t    case 'd':\t \n\t\t    case 'u':\t \n\t\t    case 'x':\t \n\t\t    case 'X':\t \n\t\t\tif (type == 'l')\n\t\t\t    VA_INTGR(long);\n\t\t\telse if (type == 'Z')\n\t\t\t    VA_INTGR(size_t);\n\t\t\telse\n\t\t\t    VA_INTGR(int);\n\t\t\tused = 'i';\n\t\t\tbreak;\n\t\t    case 'f':\t \n\t\t    case 'e':\t \n\t\t    case 'E':\t \n\t\t    case 'g':\t \n\t\t    case 'G':\t \n\t\t\tVA_FLOAT(double);\n\t\t\tused = 'f';\n\t\t\tbreak;\n\t\t    case 'c':\n\t\t\tVA_INTGR(int);\n\t\t\tused = 'i';\n\t\t\tbreak;\n\t\t    case 's':\n\t\t\tVA_POINT(char *);\n\t\t\tif (prec < 0)\n\t\t\t    prec = (int) strlen(pval);\n\t\t\tif (prec > (int) length) {\n\t\t\t    length = length + (size_t) prec;\n\t\t\t    buffer = typeRealloc(char, length, buffer);\n\t\t\t    if (buffer == 0) {\n\t\t\t\tfree(format);\n\t\t\t\treturn -1;\n\t\t\t    }\n\t\t\t}\n\t\t\tused = 'p';\n\t\t\tbreak;\n\t\t    case 'p':\n\t\t\tVA_POINT(void *);\n\t\t\tused = 'p';\n\t\t\tbreak;\n\t\t    case 'n':\n\t\t\tVA_POINT(int *);\n\t\t\tused = 0;\n\t\t\tbreak;\n\t\t    default:\n\t\t\tbreak;\n\t\t    }\n\t\t} else if (*fmt == '.') {\n\t\t    state = Prec;\n\t\t} else if (*fmt == '%') {\n\t\t    done = TRUE;\n\t\t    used = 'p';\n\t\t}\n\t    }\n\t    format[f] = '\\0';\n\t    switch (used) {\n\t    case 'i':\n\t\t_nc_SPRINTF(buffer, _nc_SLIMIT(length) format, ival);\n\t\tbreak;\n\t    case 'f':\n\t\t_nc_SPRINTF(buffer, _nc_SLIMIT(length) format, fval);\n\t\tbreak;\n\t    default:\n\t\t_nc_SPRINTF(buffer, _nc_SLIMIT(length) format, pval);\n\t\tbreak;\n\t    }\n\t    len += (int) strlen(buffer);\n\t} else {\n\t    fmt++;\n\t    len++;\n\t}\n    }\n\n    free(buffer);\n    free(format);\n    return len;\n}\n#endif\n\n#define my_buffer _nc_globals.safeprint_buf\n#define my_length _nc_globals.safeprint_used\n\n \nNCURSES_EXPORT(char *)\nNCURSES_SP_NAME(_nc_printf_string) (NCURSES_SP_DCLx\n\t\t\t\t    const char *fmt,\n\t\t\t\t    va_list ap)\n{\n    char *result = NULL;\n\n    if (SP_PARM != NULL && fmt != NULL) {\n#if USE_SAFE_SPRINTF\n\tva_list ap2;\n\tint len;\n\n\tbegin_va_copy(ap2, ap);\n\tlen = _nc_printf_length(fmt, ap2);\n\tend_va_copy(ap2);\n\n\tif ((int) my_length < len + 1) {\n\t    my_length = (size_t) (2 * (len + 1));\n\t    my_buffer = typeRealloc(char, my_length, my_buffer);\n\t}\n\tif (my_buffer != NULL) {\n\t    *my_buffer = '\\0';\n\t    if (len >= 0) {\n\t\tvsprintf(my_buffer, fmt, ap);\n\t    }\n\t    result = my_buffer;\n\t}\n#else\n#define MyCols _nc_globals.safeprint_cols\n#define MyRows _nc_globals.safeprint_rows\n\n\tif (screen_lines(SP_PARM) > MyRows || screen_columns(SP_PARM) > MyCols) {\n\t    if (screen_lines(SP_PARM) > MyRows)\n\t\tMyRows = screen_lines(SP_PARM);\n\t    if (screen_columns(SP_PARM) > MyCols)\n\t\tMyCols = screen_columns(SP_PARM);\n\t    my_length = (size_t) (MyRows * (MyCols + 1)) + 1;\n\t    if (my_length < 80)\n\t\tmy_length = 80;\n\t    my_buffer = typeRealloc(char, my_length, my_buffer);\n\t}\n\n\tif (my_buffer != NULL) {\n# if HAVE_VSNPRINTF\n\t     \n\t    int used;\n\t    while ((used = vsnprintf(my_buffer, my_length, fmt, ap))\n\t\t   >= (int) my_length) {\n\t\tmy_length = (size_t) ((3 * used) / 2);\n\t\tmy_buffer = typeRealloc(char, my_length, my_buffer);\n\t    }\n# else\n\t     \n\t    vsprintf(my_buffer, fmt, ap);\n# endif\n\t    result = my_buffer;\n\t}\n#endif\n    } else if (my_buffer != NULL) {\t \n\tfree(my_buffer);\n\tmy_buffer = NULL;\n\tmy_length = 0;\n    }\n    return result;\n}\n\n#if NCURSES_SP_FUNCS\nNCURSES_EXPORT(char *)\n_nc_printf_string(const char *fmt, va_list ap)\n{\n    return NCURSES_SP_NAME(_nc_printf_string) (CURRENT_SCREEN, fmt, ap);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}