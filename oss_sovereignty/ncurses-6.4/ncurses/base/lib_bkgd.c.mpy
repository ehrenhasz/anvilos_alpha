{
  "module_name": "lib_bkgd.c",
  "hash_id": "f7d545451941448632f89443090c3b8a3d5d39df8217659edc3ccb555066adb6",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/base/lib_bkgd.c",
  "human_readable_source": " \n\n \n\n#include <curses.priv.h>\n\nMODULE_ID(\"$Id: lib_bkgd.c,v 1.63 2021/05/08 14:58:12 tom Exp $\")\n\nstatic const NCURSES_CH_T blank = NewChar(BLANK_TEXT);\n\n \n#if USE_WIDEC_SUPPORT\nNCURSES_EXPORT(void)\n#else\nstatic NCURSES_INLINE void\n#endif\nwbkgrndset(WINDOW *win, const ARG_CH_T ch)\n{\n    T((T_CALLED(\"wbkgrndset(%p,%s)\"), (void *) win, _tracech_t(ch)));\n\n    if (win) {\n\tattr_t off = AttrOf(win->_nc_bkgd);\n\tattr_t on = AttrOf(CHDEREF(ch));\n\n\ttoggle_attr_off(WINDOW_ATTRS(win), off);\n\ttoggle_attr_on(WINDOW_ATTRS(win), on);\n\n#if NCURSES_EXT_COLORS\n\t{\n\t    int pair;\n\n\t    if (GetPair(win->_nc_bkgd) != 0)\n\t\tSET_WINDOW_PAIR(win, 0);\n\t    if ((pair = GetPair(CHDEREF(ch))) != 0)\n\t\tSET_WINDOW_PAIR(win, pair);\n\t}\n#endif\n\n\tif (CharOf(CHDEREF(ch)) == L('\\0')) {\n\t    SetChar(win->_nc_bkgd, BLANK_TEXT, AttrOf(CHDEREF(ch)));\n\t    if_EXT_COLORS(SetPair(win->_nc_bkgd, GetPair(CHDEREF(ch))));\n\t} else {\n\t    win->_nc_bkgd = CHDEREF(ch);\n\t}\n#if USE_WIDEC_SUPPORT\n\t \n\t{\n\t    cchar_t wch;\n\t    int tmp;\n\n\t    memset(&wch, 0, sizeof(wch));\n\t    (void) wgetbkgrnd(win, &wch);\n\t    tmp = _nc_to_char((wint_t) CharOf(wch));\n\n\t    win->_bkgd = (((tmp == EOF) ? ' ' : (chtype) tmp)\n\t\t\t  | (AttrOf(wch) & ALL_BUT_COLOR)\n\t\t\t  | (chtype) ColorPair(GET_WINDOW_PAIR(win)));\n\t}\n#endif\n    }\n    returnVoid;\n}\n\nNCURSES_EXPORT(void)\nwbkgdset(WINDOW *win, chtype ch)\n{\n    NCURSES_CH_T wch;\n    T((T_CALLED(\"wbkgdset(%p,%s)\"), (void *) win, _tracechtype(ch)));\n    SetChar2(wch, ch);\n    wbkgrndset(win, CHREF(wch));\n    returnVoid;\n}\n\n \nstatic NCURSES_INLINE int\n_nc_background(WINDOW *win, const ARG_CH_T ch, bool narrow)\n{\n#undef  SP_PARM\n#define SP_PARM SP\t\t \n    int code = ERR;\n\n#if USE_WIDEC_SUPPORT\n    T((T_CALLED(\"%s(%p,%s)\"),\n       narrow ? \"wbkgd\" : \"wbkgrnd\",\n       (void *) win,\n       _tracecchar_t(ch)));\n#define TraceChar(c) _tracecchar_t2(1, &(c))\n#else\n    T((T_CALLED(\"%s(%p,%s)\"),\n       \"wbkgd\",\n       (void *) win,\n       _tracech_t(ch)));\n    (void) narrow;\n#define TraceChar(c) _tracechar(CharOf(c))\n#endif\n\n    if (SP == 0) {\n\t;\n    } else if (win) {\n\tNCURSES_CH_T new_bkgd = CHDEREF(ch);\n\tNCURSES_CH_T old_bkgd;\n\tint y;\n\tNCURSES_CH_T old_char;\n\tattr_t old_attr;\n\tint old_pair;\n\tNCURSES_CH_T new_char;\n\tattr_t new_attr;\n\tint new_pair;\n\n\t \n\tif (!SP->_pair_limit) {\n\t    RemAttr(new_bkgd, A_COLOR);\n\t    SetPair(new_bkgd, 0);\n\t}\n\n\t \n\tif (CharOf(new_bkgd) == 0) {\n\t    NCURSES_CH_T tmp_bkgd = blank;\n\t    SetAttr(tmp_bkgd, AttrOf(new_bkgd));\n\t    SetPair(tmp_bkgd, GetPair(new_bkgd));\n\t    new_bkgd = tmp_bkgd;\n\t}\n\n\tmemset(&old_bkgd, 0, sizeof(old_bkgd));\n\t(void) wgetbkgrnd(win, &old_bkgd);\n\n\tif (!memcmp(&old_bkgd, &new_bkgd, sizeof(new_bkgd))) {\n\t    T((\"...unchanged\"));\n\t    returnCode(OK);\n\t}\n\n\told_char = old_bkgd;\n\tRemAttr(old_char, ~A_CHARTEXT);\n\told_attr = AttrOf(old_bkgd);\n\told_pair = GetPair(old_bkgd);\n\n\tif (!(old_attr & A_COLOR)) {\n\t    old_pair = 0;\n\t}\n\tT((\"... old background char %s, attr %s, pair %d\",\n\t   TraceChar(old_char), _traceattr(old_attr), old_pair));\n\n\tnew_char = new_bkgd;\n\tRemAttr(new_char, ~A_CHARTEXT);\n\tnew_attr = AttrOf(new_bkgd);\n\tnew_pair = GetPair(new_bkgd);\n\n\t \n\tif (\n#if USE_WIDEC_SUPPORT\n\t       narrow &&\n#endif\n\t       !Charable(new_bkgd)) {\n\t    new_char = old_char;\n\t}\n\tif (!(new_attr & A_COLOR)) {\n\t    new_pair = 0;\n\t}\n\tT((\"... new background char %s, attr %s, pair %d\",\n\t   TraceChar(new_char), _traceattr(new_attr), new_pair));\n\n\t(void) wbkgrndset(win, CHREF(new_bkgd));\n\n\t \n\tif ((new_pair != 0) && (new_pair == old_pair)) {\n\t    WINDOW_ATTRS(win) = new_attr;\n\t    SET_WINDOW_PAIR(win, new_pair);\n\t} else {\n\t    WINDOW_ATTRS(win) = new_attr;\n\t}\n\n\tfor (y = 0; y <= win->_maxy; y++) {\n\t    int x;\n\n\t    for (x = 0; x <= win->_maxx; x++) {\n\t\tNCURSES_CH_T *cp = &(win->_line[y].text[x]);\n\t\tint tmp_pair = GetPair(*cp);\n\t\tattr_t tmp_attr = AttrOf(*cp);\n\n\t\tif (CharEq(*cp, old_bkgd)) {\n#if USE_WIDEC_SUPPORT\n\t\t    if (!narrow) {\n\t\t\tif (Charable(new_bkgd)) {\n\t\t\t    SetChar2(*cp, CharOf(new_char));\n\t\t\t} else {\n\t\t\t    SetChar(*cp, L' ', AttrOf(new_char));\n\t\t\t}\n\t\t\tmemcpy(cp->chars,\n\t\t\t       new_char.chars,\n\t\t\t       CCHARW_MAX * sizeof(cp->chars[0]));\n\t\t    } else\n#endif\n\t\t\tSetChar2(*cp, CharOf(new_char));\n\t\t}\n\t\tif (tmp_pair != 0) {\n\t\t    if (tmp_pair == old_pair) {\n\t\t\tSetAttr(*cp, (tmp_attr & ~old_attr) | new_attr);\n\t\t\tSetPair(*cp, new_pair);\n\t\t    } else {\n\t\t\tSetAttr(*cp,\n\t\t\t\t(tmp_attr & (~old_attr | A_COLOR))\n\t\t\t\t| (new_attr & ALL_BUT_COLOR));\n\t\t    }\n\t\t} else {\n\t\t    SetAttr(*cp, (tmp_attr & ~old_attr) | new_attr);\n\t\t    SetPair(*cp, new_pair);\n\t\t}\n\t    }\n\t}\n\ttouchwin(win);\n\t_nc_synchook(win);\n\tcode = OK;\n    }\n    returnCode(code);\n}\n\n#if USE_WIDEC_SUPPORT\nNCURSES_EXPORT(int)\nwbkgrnd(WINDOW *win, const ARG_CH_T ch)\n{\n    return _nc_background(win, ch, FALSE);\n}\n#endif\n\nNCURSES_EXPORT(int)\nwbkgd(WINDOW *win, chtype ch)\n{\n    NCURSES_CH_T wch;\n    SetChar2(wch, ch);\n    return _nc_background(win, CHREF(wch), TRUE);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}