{
  "module_name": "lib_getstr.c",
  "hash_id": "25e7bca77d717e8c43fa88785557dcec706bf7d421caec01ff39eb499382b0db",
  "original_prompt": "Ingested from ncurses-6.4/ncurses/base/lib_getstr.c",
  "human_readable_source": " \n\n \n\n \n\n#define NEED_KEY_EVENT\n#include <curses.priv.h>\n\nMODULE_ID(\"$Id: lib_getstr.c,v 1.38 2021/10/23 19:02:39 tom Exp $\")\n\n \nstatic char *\nWipeOut(WINDOW *win, int y, int x, char *first, char *last, int echoed)\n{\n    if (last > first) {\n\t*--last = '\\0';\n\tif (echoed) {\n\t    int y1 = win->_cury;\n\t    int x1 = win->_curx;\n\n\t    wmove(win, y, x);\n\t    waddstr(win, first);\n\t    getyx(win, y, x);\n\t    while (win->_cury < y1\n\t\t   || (win->_cury == y1 && win->_curx < x1))\n\t\twaddch(win, (chtype) ' ');\n\n\t    wmove(win, y, x);\n\t}\n    }\n    return last;\n}\n\nNCURSES_EXPORT(int)\nwgetnstr_events(WINDOW *win,\n\t\tchar *str,\n\t\tint maxlen,\n\t\tEVENTLIST_1st(_nc_eventlist * evl))\n{\n    SCREEN *sp = _nc_screen_of(win);\n    TTY buf;\n    bool oldnl, oldecho, oldraw, oldcbreak;\n    char erasec;\n    char killc;\n    char *oldstr;\n    int ch;\n    int y, x;\n\n    T((T_CALLED(\"wgetnstr(%p,%p,%d)\"), (void *) win, (void *) str, maxlen));\n\n    if (!win || !str)\n\treturnCode(ERR);\n\n    maxlen = _nc_getstr_limit(maxlen);\n\n    NCURSES_SP_NAME(_nc_get_tty_mode) (NCURSES_SP_ARGx &buf);\n\n    oldnl = sp->_nl;\n    oldecho = sp->_echo;\n    oldraw = sp->_raw;\n    oldcbreak = sp->_cbreak;\n    NCURSES_SP_NAME(nl) (NCURSES_SP_ARG);\n    NCURSES_SP_NAME(noecho) (NCURSES_SP_ARG);\n    NCURSES_SP_NAME(raw) (NCURSES_SP_ARG);\n\n    erasec = NCURSES_SP_NAME(erasechar) (NCURSES_SP_ARG);\n    killc = NCURSES_SP_NAME(killchar) (NCURSES_SP_ARG);\n\n    oldstr = str;\n    getyx(win, y, x);\n\n    if (is_wintouched(win) || (win->_flags & _HASMOVED))\n\twrefresh(win);\n\n    while ((ch = wgetch_events(win, evl)) != ERR) {\n\t \n\tif (ch == '\\n'\n\t    || ch == '\\r'\n\t    || ch == KEY_DOWN\n\t    || ch == KEY_ENTER) {\n\t    if (oldecho == TRUE\n\t\t&& win->_cury == win->_maxy\n\t\t&& win->_scroll)\n\t\twechochar(win, (chtype) '\\n');\n\t    break;\n\t}\n#ifdef KEY_EVENT\n\tif (ch == KEY_EVENT)\n\t    break;\n#endif\n#ifdef KEY_RESIZE\n\tif (ch == KEY_RESIZE)\n\t    break;\n#endif\n\tif (ch == erasec || ch == KEY_LEFT || ch == KEY_BACKSPACE) {\n\t    if (str > oldstr) {\n\t\tstr = WipeOut(win, y, x, oldstr, str, oldecho);\n\t    }\n\t} else if (ch == killc) {\n\t    while (str > oldstr) {\n\t\tstr = WipeOut(win, y, x, oldstr, str, oldecho);\n\t    }\n\t} else if (ch >= KEY_MIN\n\t\t   || (str - oldstr >= maxlen)) {\n\t    NCURSES_SP_NAME(beep) (NCURSES_SP_ARG);\n\t} else {\n\t    *str++ = (char) ch;\n\t    if (oldecho == TRUE) {\n\t\tint oldy = win->_cury;\n\t\tif (waddch(win, (chtype) ch) == ERR) {\n\t\t     \n\t\t    win->_flags &= ~_WRAPPED;\n\t\t    waddch(win, (chtype) ' ');\n\t\t    str = WipeOut(win, y, x, oldstr, str, oldecho);\n\t\t    continue;\n\t\t} else if (IS_WRAPPED(win)) {\n\t\t     \n\t\t    if (win->_scroll\n\t\t\t&& oldy == win->_maxy\n\t\t\t&& win->_cury == win->_maxy) {\n\t\t\tif (--y <= 0) {\n\t\t\t    y = 0;\n\t\t\t}\n\t\t    }\n\t\t    win->_flags &= ~_WRAPPED;\n\t\t}\n\t\twrefresh(win);\n\t    }\n\t}\n    }\n\n    win->_curx = 0;\n    win->_flags &= ~_WRAPPED;\n    if (win->_cury < win->_maxy)\n\twin->_cury++;\n    wrefresh(win);\n\n     \n    sp->_nl = oldnl;\n    sp->_echo = oldecho;\n    sp->_raw = oldraw;\n    sp->_cbreak = oldcbreak;\n\n    NCURSES_SP_NAME(_nc_set_tty_mode) (NCURSES_SP_ARGx &buf);\n\n    *str = '\\0';\n    if (ch == ERR)\n\treturnCode(ch);\n\n    T((\"wgetnstr returns %s\", _nc_visbuf(oldstr)));\n\n#ifdef KEY_EVENT\n    if (ch == KEY_EVENT)\n\treturnCode(ch);\n#endif\n#ifdef KEY_RESIZE\n    if (ch == KEY_RESIZE)\n\treturnCode(ch);\n#endif\n\n    returnCode(OK);\n}\n\n#ifdef NCURSES_WGETCH_EVENTS\nNCURSES_EXPORT(int)\nwgetnstr(WINDOW *win, char *str, int maxlen)\n{\n    returnCode(wgetnstr_events(win,\n\t\t\t       str,\n\t\t\t       maxlen,\n\t\t\t       EVENTLIST_1st((_nc_eventlist *) 0)));\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}