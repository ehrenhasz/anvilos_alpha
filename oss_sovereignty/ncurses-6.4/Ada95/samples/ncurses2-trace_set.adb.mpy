{
  "module_name": "ncurses2-trace_set.adb",
  "hash_id": "f629d1eebaca86a7dfccc104361f5d316dcf92fdbec657f02873b4827cd80c66",
  "original_prompt": "Ingested from ncurses-6.4/Ada95/samples/ncurses2-trace_set.adb",
  "human_readable_source": "------------------------------------------------------------------------------\n--                                                                          --\n--                       GNAT ncurses Binding Samples                       --\n--                                                                          --\n--                            ncurses2.trace_set                            --\n--                                                                          --\n--                                 B O D Y                                  --\n--                                                                          --\n------------------------------------------------------------------------------\n-- Copyright 2020 Thomas E. Dickey                                          --\n-- Copyright 2000-2011,2014 Free Software Foundation, Inc.                  --\n--                                                                          --\n-- Permission is hereby granted, free of charge, to any person obtaining a  --\n-- copy of this software and associated documentation files (the            --\n-- \"Software\"), to deal in the Software without restriction, including      --\n-- without limitation the rights to use, copy, modify, merge, publish,      --\n-- distribute, distribute with modifications, sublicense, and/or sell       --\n-- copies of the Software, and to permit persons to whom the Software is    --\n-- furnished to do so, subject to the following conditions:                 --\n--                                                                          --\n-- The above copyright notice and this permission notice shall be included  --\n-- in all copies or substantial portions of the Software.                   --\n--                                                                          --\n-- THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS  --\n-- OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF               --\n-- MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.   --\n-- IN NO EVENT SHALL THE ABOVE COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,   --\n-- DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR    --\n-- OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR    --\n-- THE USE OR OTHER DEALINGS IN THE SOFTWARE.                               --\n--                                                                          --\n-- Except as contained in this notice, the name(s) of the above copyright   --\n-- holders shall not be used in advertising or otherwise to promote the     --\n-- sale, use or other dealings in this Software without prior written       --\n-- authorization.                                                           --\n------------------------------------------------------------------------------\n--  Author: Eugene V. Melaragno <aldomel@ix.netcom.com> 2000\n--  Version Control\n--  $Revision: 1.7 $\n--  $Date: 2020/02/02 23:34:34 $\n--  Binding Version 01.00\n------------------------------------------------------------------------------\nwith ncurses2.util; use ncurses2.util;\nwith Terminal_Interface.Curses; use Terminal_Interface.Curses;\nwith Terminal_Interface.Curses.Trace; use Terminal_Interface.Curses.Trace;\nwith Terminal_Interface.Curses.Menus; use Terminal_Interface.Curses.Menus;\n\nwith Ada.Strings.Bounded;\n\n--  interactively set the trace level\n\nprocedure ncurses2.trace_set is\n\n   function menu_virtualize (c : Key_Code) return Key_Code;\n   function subset (super, sub : Trace_Attribute_Set) return Boolean;\n   function trace_or (a, b : Trace_Attribute_Set) return Trace_Attribute_Set;\n   function trace_num (tlevel : Trace_Attribute_Set) return String;\n   function tracetrace (tlevel : Trace_Attribute_Set) return String;\n   function run_trace_menu (m : Menu; count : Integer) return Boolean;\n\n   function menu_virtualize (c : Key_Code) return Key_Code is\n   begin\n      case c is\n         when Character'Pos (newl) | Key_Exit =>\n            return Menu_Request_Code'Last + 1; --  MAX_COMMAND? TODO\n         when Character'Pos ('u') =>\n            return M_ScrollUp_Line;\n         when Character'Pos ('d') =>\n            return M_ScrollDown_Line;\n         when Character'Pos ('b') | Key_Next_Page =>\n            return M_ScrollUp_Page;\n         when Character'Pos ('f') | Key_Previous_Page =>\n            return M_ScrollDown_Page;\n         when Character'Pos ('n') | Key_Cursor_Down =>\n            return M_Next_Item;\n         when Character'Pos ('p') | Key_Cursor_Up =>\n            return M_Previous_Item;\n         when Character'Pos (' ') =>\n            return M_Toggle_Item;\n         when Key_Mouse =>\n            return c;\n         when others =>\n            Beep;\n            return c;\n      end case;\n   end menu_virtualize;\n\n   type string_a is access String;\n   type tbl_entry is record\n      name : string_a;\n      mask : Trace_Attribute_Set;\n   end record;\n\n   t_tbl : constant array (Positive range <>) of tbl_entry :=\n     (\n      (new String'(\"Disable\"),\n       Trace_Disable),\n      (new String'(\"Times\"),\n       Trace_Attribute_Set'(Times => True, others => False)),\n      (new String'(\"Tputs\"),\n       Trace_Attribute_Set'(Tputs => True, others => False)),\n      (new String'(\"Update\"),\n       Trace_Attribute_Set'(Update => True, others => False)),\n      (new String'(\"Cursor_Move\"),\n       Trace_Attribute_Set'(Cursor_Move => True, others => False)),\n      (new String'(\"Character_Output\"),\n       Trace_Attribute_Set'(Character_Output => True, others => False)),\n      (new String'(\"Ordinary\"),\n       Trace_Ordinary),\n      (new String'(\"Calls\"),\n       Trace_Attribute_Set'(Calls => True, others => False)),\n      (new String'(\"Virtual_Puts\"),\n       Trace_Attribute_Set'(Virtual_Puts => True, others => False)),\n      (new String'(\"Input_Events\"),\n       Trace_Attribute_Set'(Input_Events => True, others => False)),\n      (new String'(\"TTY_State\"),\n       Trace_Attribute_Set'(TTY_State => True, others => False)),\n      (new String'(\"Internal_Calls\"),\n       Trace_Attribute_Set'(Internal_Calls => True, others => False)),\n      (new String'(\"Character_Calls\"),\n       Trace_Attribute_Set'(Character_Calls => True, others => False)),\n      (new String'(\"Termcap_TermInfo\"),\n       Trace_Attribute_Set'(Termcap_TermInfo => True, others => False)),\n      (new String'(\"Maximium\"),\n       Trace_Maximum)\n      );\n\n   package BS is new Ada.Strings.Bounded.Generic_Bounded_Length (300);\n\n   function subset (super, sub : Trace_Attribute_Set) return Boolean is\n   begin\n      if\n        (super.Times or not sub.Times) and\n        (super.Tputs or not sub.Tputs) and\n        (super.Update or not sub.Update) and\n        (super.Cursor_Move or not sub.Cursor_Move) and\n        (super.Character_Output or not sub.Character_Output) and\n        (super.Calls or not sub.Calls) and\n        (super.Virtual_Puts or not sub.Virtual_Puts) and\n        (super.Input_Events or not sub.Input_Events) and\n        (super.TTY_State or not sub.TTY_State) and\n        (super.Internal_Calls or not sub.Internal_Calls) and\n        (super.Character_Calls or not sub.Character_Calls) and\n        (super.Termcap_TermInfo or not sub.Termcap_TermInfo) and\n        True\n      then\n         return True;\n      else\n         return False;\n      end if;\n   end subset;\n\n   function trace_or (a, b : Trace_Attribute_Set) return Trace_Attribute_Set is\n      retval : Trace_Attribute_Set := Trace_Disable;\n   begin\n      retval.Times := (a.Times or b.Times);\n      retval.Tputs := (a.Tputs or b.Tputs);\n      retval.Update := (a.Update or b.Update);\n      retval.Cursor_Move := (a.Cursor_Move or b.Cursor_Move);\n      retval.Character_Output := (a.Character_Output or b.Character_Output);\n      retval.Calls := (a.Calls or b.Calls);\n      retval.Virtual_Puts := (a.Virtual_Puts or b.Virtual_Puts);\n      retval.Input_Events := (a.Input_Events or b.Input_Events);\n      retval.TTY_State := (a.TTY_State or b.TTY_State);\n      retval.Internal_Calls := (a.Internal_Calls or b.Internal_Calls);\n      retval.Character_Calls := (a.Character_Calls or b.Character_Calls);\n      retval.Termcap_TermInfo := (a.Termcap_TermInfo or b.Termcap_TermInfo);\n\n      return retval;\n   end trace_or;\n\n   --  Print the hexadecimal value of the mask so\n   --  users can set it from the command line.\n\n   function trace_num (tlevel : Trace_Attribute_Set) return String is\n      result : Integer := 0;\n      m : Integer := 1;\n   begin\n\n      if tlevel.Times then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Tputs then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Update then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Cursor_Move then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Character_Output then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Calls then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Virtual_Puts then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Input_Events then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.TTY_State then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Internal_Calls then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Character_Calls then\n         result := result + m;\n      end if;\n      m := m * 2;\n\n      if tlevel.Termcap_TermInfo then\n         result := result + m;\n      end if;\n      m := m * 2;\n      return result'Img;\n   end trace_num;\n\n   function tracetrace (tlevel : Trace_Attribute_Set) return String is\n\n      use BS;\n      buf : Bounded_String := To_Bounded_String (\"\");\n   begin\n      --  The C version prints the hexadecimal value of the mask, we\n      --  won't do that here because this is Ada.\n\n      if tlevel = Trace_Disable then\n         Append (buf, \"Trace_Disable\");\n      else\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Times => True, others => False))\n         then\n            Append (buf, \"Times\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Tputs => True, others => False))\n         then\n            Append (buf, \"Tputs\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Update => True, others => False))\n         then\n            Append (buf, \"Update\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Cursor_Move => True,\n                                         others => False))\n         then\n            Append (buf, \"Cursor_Move\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Character_Output => True,\n                                         others => False))\n         then\n            Append (buf, \"Character_Output\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Ordinary)\n         then\n            Append (buf, \"Ordinary\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Calls => True, others => False))\n         then\n            Append (buf, \"Calls\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Virtual_Puts => True,\n                                         others => False))\n         then\n            Append (buf, \"Virtual_Puts\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Input_Events => True,\n                                         others => False))\n         then\n            Append (buf, \"Input_Events\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(TTY_State => True,\n                                         others => False))\n         then\n            Append (buf, \"TTY_State\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Internal_Calls => True,\n                                         others => False))\n         then\n            Append (buf, \"Internal_Calls\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Character_Calls => True,\n                                         others => False))\n         then\n            Append (buf, \"Character_Calls\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Attribute_Set'(Termcap_TermInfo => True,\n                                         others => False))\n         then\n            Append (buf, \"Termcap_TermInfo\");\n            Append (buf, \", \");\n         end if;\n\n         if subset (tlevel,\n                    Trace_Maximum)\n         then\n            Append (buf, \"Maximium\");\n            Append (buf, \", \");\n         end if;\n      end if;\n\n      if To_String (buf) (Length (buf) - 1) = ',' then\n         Delete (buf, Length (buf) - 1, Length (buf));\n      end if;\n\n      return To_String (buf);\n   end tracetrace;\n\n   function run_trace_menu (m : Menu; count : Integer) return Boolean is\n      i, p : Item;\n      changed : Boolean;\n      c, v : Key_Code;\n   begin\n      loop\n         changed := (count /= 0);\n         c := Getchar (Get_Window (m));\n         v := menu_virtualize (c);\n         case Driver (m, v) is\n            when Unknown_Request =>\n               return False;\n            when others =>\n               i := Current (m);\n               if i = Menus.Items (m, 1) then -- the first item\n                  for n in t_tbl'First + 1 .. t_tbl'Last loop\n                     if Value (i) then\n                        Set_Value (i, False);\n                        changed := True;\n                     end if;\n                  end loop;\n               else\n                  for n in t_tbl'First + 1 .. t_tbl'Last loop\n                     p := Menus.Items (m, n);\n                     if Value (p) then\n                        Set_Value (Menus.Items (m, 1), False);\n                        changed := True;\n                        exit;\n                     end if;\n                  end loop;\n               end if;\n               if not changed then\n                  return True;\n               end if;\n         end case;\n      end loop;\n   end run_trace_menu;\n\n   nc_tracing, mask : Trace_Attribute_Set;\n   pragma Import (C, nc_tracing, \"_nc_tracing\");\n   items_a : constant Item_Array_Access :=\n     new Item_Array (t_tbl'First .. t_tbl'Last + 1);\n   mrows : Line_Count;\n   mcols : Column_Count;\n   menuwin : Window;\n   menu_y : constant Line_Position := 8;\n   menu_x : constant Column_Position := 8;\n   ip : Item;\n   m : Menu;\n   count : Integer;\n   newtrace : Trace_Attribute_Set;\nbegin\n   Add (Line => 0, Column => 0, Str => \"Interactively set trace level:\");\n   Add (Line => 2, Column => 0,\n        Str => \"  Press space bar to toggle a selection.\");\n   Add (Line => 3, Column => 0,\n        Str => \"  Use up and down arrow to move the select bar.\");\n   Add (Line => 4, Column => 0,\n        Str => \"  Press return to set the trace level.\");\n   Add (Line => 6, Column => 0, Str => \"(Current trace level is \");\n   Add (Str => tracetrace (nc_tracing) & \" numerically: \" &\n        trace_num (nc_tracing));\n   Add (Ch => ')');\n\n   Refresh;\n\n   for n in t_tbl'Range loop\n      items_a.all (n) := New_Item (t_tbl (n).name.all);\n   end loop;\n   items_a.all (t_tbl'Last + 1) := Null_Item;\n\n   m := New_Menu (items_a);\n\n   Set_Format (m, 16, 2);\n   Scale (m, mrows, mcols);\n\n   Switch_Options (m, (One_Valued => True, others => False), On => False);\n   menuwin := New_Window (mrows + 2, mcols + 2, menu_y, menu_x);\n   Set_Window (m, menuwin);\n   Set_KeyPad_Mode (menuwin, SwitchOn => True);\n   Box (menuwin);\n\n   Set_Sub_Window (m, Derived_Window (menuwin, mrows, mcols, 1, 1));\n\n   Post (m);\n\n   for n in t_tbl'Range loop\n      ip := Items (m, n);\n      mask := t_tbl (n).mask;\n      if mask = Trace_Disable then\n         Set_Value (ip, nc_tracing = Trace_Disable);\n      elsif subset (sub => mask, super => nc_tracing) then\n         Set_Value (ip, True);\n      end if;\n   end loop;\n\n   count := 1;\n   while run_trace_menu (m, count) loop\n      count := count + 1;\n   end loop;\n\n   newtrace := Trace_Disable;\n   for n in t_tbl'Range loop\n      ip := Items (m, n);\n      if Value (ip) then\n         mask := t_tbl (n).mask;\n         newtrace := trace_or (newtrace, mask);\n      end if;\n   end loop;\n\n   Trace_On (newtrace);\n   Trace_Put (\"trace level interactively set to \" &\n              tracetrace (nc_tracing));\n\n   Move_Cursor (Line => Lines - 4, Column => 0);\n   Add (Str => \"Trace level is \");\n   Add (Str => tracetrace (nc_tracing));\n   Add (Ch => newl);\n   Pause; -- was just Add(); Getchar\n\n   Post (m, False);\n   --  menuwin has subwindows I think, which makes an error.\n   declare begin\n      Delete (menuwin);\n   exception when Curses_Exception => null; end;\n\n   --  free_menu(m);\n   --  free_item()\nend ncurses2.trace_set;\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}