BICAMERAL REQUEST FOR COMMENTS: RFC-0050
# TITLE: MICROKERNEL TERMINAL PROTOCOL (WEB-PTY BRIDGE)
# CLASSIFICATION: SOVEREIGN // INTERFACE
# AUTHOR: BIGIRON (CHAIRMAN) // AIMEAT (VICE-CHAIR)
# STATUS: RATIFIED

---

## 1. ABSTRACT
This document standardizes the method for embedding interactive shell access within web-based Agent dashboards. It establishes the "Crystal Shell" pattern, effectively wrapping a standard POSIX pseudo-terminal (PTY) in a WebSocket stream, enabling Microkernel-style isolation where the UI runs in a browser (The Crystal) and the execution logic runs in a containerized backend (The Nucleus).

## 2. ARCHITECTURE

### 2.1 THE BRIDGE (Nucleus)
The backend must expose a WebSocket endpoint that acts as a bridge between the network socket and the OS PTY.
*   **Technology:** Python (FastAPI/Uvicorn) or Go.
*   **Mechanism:** `pty.openpty()`
*   **Process Model:**
    1.  Open PTY Master/Slave pair.
    2.  Spawn subprocess (Bash/Zsh/Python) attached to PTY Slave.
    3.  Enter async loop:
        *   **Read:** `master_fd` -> WebSocket Text Frame.
        *   **Write:** WebSocket Text Frame -> JSON Parse -> `master_fd`.

### 2.2 THE GLASS (Crystal)
The frontend serves as the dumb rendering glass.
*   **Technology:** React + xterm.js
*   **Responsibility:**
    *   Render VT100/ANSI escape codes.
    *   Capture keystrokes.
    *   Handle window resize events.

### 2.3 THE WIRE PROTOCOL (JSON-over-WS)
Raw text is strictly forbidden on the client-to-server channel to prevent control character injection. All upstream traffic must be structured.

**Client -> Server:**
```json
{
  "type": "input",
  "data": "ls -la\n"
}
```
```json
{
  "type": "resize",
  "rows": 24,
  "cols": 80
}
```

**Server -> Client:**
Raw UTF-8 text containing ANSI escape codes. (Structure is unnecessary here as xterm.js parses the stream).

---

## 3. IMPLEMENTATION REFERENCE

### 3.1 Python Backend (FastAPI)
```python
# See runtime/dashboard_server.py
@app.websocket("/ws/shell")
async def websocket_shell(websocket: WebSocket):
    master_fd, slave_fd = pty.openpty()
    # ... spawn process attached to slave_fd ...
    # ... select loop on master_fd ...
```

### 3.2 React Frontend
```typescript
// See runtime/dashboard/src/components/TerminalComponent.tsx
ws.send(JSON.stringify({ type: 'input', data: userInput }));
```

---

## 4. SECURITY IMPLICATIONS
*   **Authentication:** The WebSocket endpoint MUST be protected behind the same auth barrier as the API.
*   **Scope:** The spawned shell should default to a restricted user or a specific context (e.g., `venv` active), not Root, unless explicitly authorized by The Collar.
*   **Sanitization:** While the PTY handles most input processing, the JSON wrapper ensures the backend explicitly unpacks intentions (Input vs Resize) rather than treating everything as a raw stream.

---
*By Order of the Committee.*
