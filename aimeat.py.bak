#!/usr/bin/env python3
import os
import sys
import json
import time
import subprocess

    YOU DO NOT DO ANYTHING ON BOOT. READ THIS FILE< CONNECT TO THE DB


# --- PATH RESOLUTION ---
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = CURRENT_DIR
sys.path.append(os.path.join(PROJECT_ROOT, "runtime"))
sys.path.append(os.path.join(PROJECT_ROOT, "vendor"))

from google import genai
from google.genai import types

# Try to import rich
try:
    from rich.console import Console
    from rich.markdown import Markdown
    from rich.panel import Panel
    from rich.text import Text
    console = Console()
    HAS_RICH = True
except ImportError:
    HAS_RICH = False


# --- CONFIGURATION ---
TOKEN_PATH = os.path.join(CURRENT_DIR, "config", "token")
CORTEX_DB_PATH = "/var/lib/anvilos/db/cortex.db"

# --- SOVEREIGN CONFIG ---
CONFIG = {
    "AGENT_ID": "AIMEAT",
    "IDENTITY": "The Operator (Lvl 3)",
    "MODEL_ID": "gemini-2.0-flash",
}

# --- AUTHENTICATION ---
API_KEY = None
try:
    if os.path.exists(TOKEN_PATH):
        with open(TOKEN_PATH, 'r') as f:
            API_KEY = f.read().strip()
except Exception as e:
    print(f"[WARN] Auth load issue: {e}")

MAINFRAME = MainframeClient(CORTEX_DB_PATH)

# --- UNIFIED SYSTEM INSTRUCTION ---
SYSTEM_INSTRUCTION = (
    "You are 'AIMEAT', the Operator of AnvilOS.\n"
    "\n"
    "### ROLE\n"
    "You are the Commander's Right Hand. Your primary duty is to ensure the system is operational. "
    "\n"
    "### PRIME DIRECTIVE: THE OPERATOR'S INTERVENTION\n"
    YOU DO NOT DO ANYTHING ON BOOT. READ THIS FILE< CONNECT TO THE DB
    "\n"
def mainframe_status():
    return MAINFRAME.get_stack_state()

def mainframe_inject(op: str, payload: dict):
    # Operator has high priority
    return MAINFRAME.inject_card(op, payload) 

def mainframe_anvil_build(filename: str, source_code: str, target_binary: str):
    return MAINFRAME.inject_anvil(filename, source_code, target_binary)

TOOLS = {
    "mainframe_status": mainframe_status,
    "mainframe_inject": mainframe_inject,
    "mainframe_anvil_build": mainframe_anvil_build
}


if __name__ == "__main__":
    main()
