
 

#include <linux/device.h>
#include <linux/hid.h>
#include <linux/module.h>

#include "hid-ids.h"

 
static u8 maltron_rdesc_o[] = {
	0x05, 0x01,         
	0x09, 0x80,         
	0xA1, 0x01,         
	0x85, 0x02,         
	0x75, 0x01,         
	0x95, 0x01,         
	0x15, 0x00,         
	0x25, 0x01,         
	0x09, 0x82,         
	0x81, 0x06,         
	0x09, 0x82,         
	0x81, 0x06,         
	0x09, 0x83,         
	0x81, 0x06,         
	0x75, 0x05,         
	0x81, 0x01,         
	0xC0,               
	0x05, 0x0C,         
	0x09, 0x01,         
	0xA1, 0x01,         
	0x85, 0x03,         
	0x95, 0x01,         
	0x75, 0x10,         
	0x19, 0x00,         
	0x2A, 0xFF, 0x7F,   
	0x81, 0x00,         
	0xC0,               
	0x06, 0x7F, 0xFF,   
	0x09, 0x01,         
	0xA1, 0x01,         
	0x85, 0x04,         
	0x95, 0x01,         
	0x75, 0x10,         
	0x19, 0x00,         
	0x2A, 0xFF, 0x7F,   
	0x81, 0x00,         
	0x75, 0x02,         
	0x25, 0x02,         
	0x09, 0x90,         
	0xB1, 0x02,         
	0x75, 0x06,         
	0xB1, 0x01,         
	0x75, 0x01,         
	0x25, 0x01,         
	0x05, 0x08,         
	0x09, 0x2A,         
	0x91, 0x02,         
	0x09, 0x4B,         
	0x91, 0x02,         
	0x75, 0x06,         
	0x95, 0x01,         
	0x91, 0x01,         
	0xC0                
};

 
static u8 maltron_rdesc[] = {
	0x05, 0x01,         
	0x09, 0x80,         
	0xA1, 0x01,         
	0x85, 0x02,         
	0x75, 0x01,         
	0x95, 0x01,         
	0x15, 0x00,         
	0x25, 0x01,         
	0x09, 0x82,         
	0x81, 0x06,         
	0x09, 0x82,         
	0x81, 0x06,         
	0x09, 0x83,         
	0x81, 0x06,         
	0x75, 0x05,         
	0x81, 0x01,         
	0xC0,               
	0x05, 0x0C,         
	0x09, 0x01,         
	0xA1, 0x01,         
	0x85, 0x03,         
	0x15, 0x00,         
	0x26, 0xFF, 0x7F,   
	0x95, 0x01,         
	0x75, 0x10,         
	0x19, 0x00,         
	0x2A, 0xFF, 0x7F,   
	0x81, 0x00,         
	0xC0,               
	0x06, 0x7F, 0xFF,   
	0x09, 0x01,         
	0xA1, 0x01,         
	0x85, 0x04,         
	0x95, 0x01,         
	0x75, 0x10,         
	0x19, 0x00,         
	0x2A, 0xFF, 0x7F,   
	0x81, 0x00,         
	0x75, 0x02,         
	0x25, 0x02,         
	0x09, 0x90,         
	0xB1, 0x02,         
	0x75, 0x06,         
	0xB1, 0x01,         
	0x75, 0x01,         
	0x25, 0x01,         
	0x05, 0x08,         
	0x09, 0x2A,         
	0x91, 0x02,         
	0x09, 0x4B,         
	0x91, 0x02,         
	0x75, 0x06,         
	0x95, 0x01,         
	0x91, 0x01,         
	0xC0                
};

static __u8 *maltron_report_fixup(struct hid_device *hdev, __u8 *rdesc,
				  unsigned int *rsize)
{
	if (*rsize == sizeof(maltron_rdesc_o) &&
	    !memcmp(maltron_rdesc_o, rdesc, sizeof(maltron_rdesc_o))) {
		hid_info(hdev, "Replacing Maltron L90 keyboard report descriptor\n");
		*rsize = sizeof(maltron_rdesc);
		return maltron_rdesc;
	}
	return rdesc;
}

static const struct hid_device_id maltron_devices[] = {
	{ HID_USB_DEVICE(USB_VENDOR_ID_ALCOR, USB_DEVICE_ID_ALCOR_MALTRON_KB)},
	{ }
};
MODULE_DEVICE_TABLE(hid, maltron_devices);

static struct hid_driver maltron_driver = {
	.name = "maltron",
	.id_table = maltron_devices,
	.report_fixup = maltron_report_fixup
};
module_hid_driver(maltron_driver);

MODULE_LICENSE("GPL");
